import { MatDialog } from '@angular/material/dialog';
import { EventEmitter, Injectable, Output } from '@angular/core';
import { ContentService, ThumbnailService, SitesService, TranslationService, AllowableOperationsEnum } from '@alfresco/adf-core';
import { Subject, throwError } from 'rxjs';
import { DocumentListService } from '../document-list/services/document-list.service';
import { ContentNodeSelectorComponent } from './content-node-selector.component';
import { NodeAction } from '../document-list/models/node-action.enum';
import { NodeLockDialogComponent } from '../dialogs/node-lock.dialog';
import { switchMap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/material/dialog";
import * as i2 from "@alfresco/adf-core";
import * as i3 from "../document-list/services/document-list.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/material/dialog';
import * as ɵngcc2 from '@alfresco/adf-core';
import * as ɵngcc3 from '../document-list/services/document-list.service';
export class ContentNodeDialogService {
    constructor(dialog, contentService, documentListService, siteService, translation, thumbnailService) {
        this.dialog = dialog;
        this.contentService = contentService;
        this.documentListService = documentListService;
        this.siteService = siteService;
        this.translation = translation;
        this.thumbnailService = thumbnailService;
        this.error = new EventEmitter();
    }
    openFileBrowseDialogByFolderId(folderNodeId) {
        return this.documentListService.getFolderNode(folderNodeId).pipe(switchMap((nodeEntry) => {
            return this.openUploadFileDialog(NodeAction.CHOOSE, nodeEntry.entry, true);
        }));
    }
    openLockNodeDialog(contentEntry) {
        const observable = new Subject();
        if (this.contentService.hasAllowableOperations(contentEntry, AllowableOperationsEnum.LOCK)) {
            this.dialog.open(NodeLockDialogComponent, {
                data: {
                    node: contentEntry,
                    onError: (error) => {
                        this.error.emit(error);
                        observable.error(error);
                    }
                },
                width: '400px'
            });
        }
        else {
            observable.error('OPERATION.FAIL.NODE.NO_PERMISSION');
        }
        return observable;
    }
    openFileBrowseDialogBySite() {
        return this.siteService.getSites().pipe(switchMap((response) => {
            return this.openFileBrowseDialogByFolderId(response.list.entries[0].entry.guid);
        }));
    }
    openFileBrowseDialogByDefaultLocation() {
        return this.openFileBrowseDialogByFolderId('-my-');
    }
    openFolderBrowseDialogBySite() {
        return this.openFolderBrowseDialogByFolderId('-my-');
    }
    openFolderBrowseDialogByFolderId(folderNodeId) {
        return this.documentListService.getFolderNode(folderNodeId).pipe(switchMap((node) => {
            return this.openUploadFolderDialog(NodeAction.CHOOSE, node.entry);
        }));
    }
    openCopyMoveDialog(action, contentEntry, permission, excludeSiteContent) {
        if (this.contentService.hasAllowableOperations(contentEntry, permission)) {
            const select = new Subject();
            const data = {
                title: this.getTitleTranslation(action, contentEntry.name),
                actionName: action,
                selectionMode: 'single',
                currentFolderId: contentEntry.parentId,
                imageResolver: this.imageResolver.bind(this),
                where: '(isFolder=true)',
                isSelectionValid: this.isCopyMoveSelectionValid.bind(this),
                excludeSiteContent: excludeSiteContent || ContentNodeDialogService.nonDocumentSiteContent,
                select: select
            };
            const dialogRef = this.openContentNodeDialog(data, 'adf-content-node-selector-dialog', '630px');
            dialogRef.afterClosed().subscribe({ next: () => select.complete() });
            return select;
        }
        else {
            const errors = new Error(JSON.stringify({ error: { statusCode: 403 } }));
            return throwError(errors);
        }
    }
    getTitleTranslation(action, name) {
        return this.translation.instant(`NODE_SELECTOR.${action.toUpperCase()}_ITEM`, { name });
    }
    openUploadFolderDialog(action, contentEntry) {
        const select = new Subject();
        const data = {
            title: this.getTitleTranslation(action, this.translation.instant('DROPDOWN.MY_FILES_OPTION')),
            actionName: action,
            selectionMode: 'single',
            currentFolderId: contentEntry.id,
            imageResolver: this.imageResolver.bind(this),
            isSelectionValid: this.hasAllowableOperationsOnNodeFolder.bind(this),
            where: '(isFolder=true)',
            select: select
        };
        const dialogRef = this.openContentNodeDialog(data, 'adf-content-node-selector-dialog', '630px');
        dialogRef.afterClosed().subscribe({ next: () => select.complete() });
        return select;
    }
    openUploadFileDialog(action, contentEntry, showFilesInResult = false) {
        const select = new Subject();
        const data = {
            title: this.getTitleTranslation(action, this.translation.instant('DROPDOWN.MY_FILES_OPTION')),
            actionName: action,
            selectionMode: 'single',
            currentFolderId: contentEntry.id,
            imageResolver: this.imageResolver.bind(this),
            isSelectionValid: (entry) => entry.isFile,
            select: select,
            showFilesInResult
        };
        const dialogRef = this.openContentNodeDialog(data, 'adf-content-node-selector-dialog', '630px');
        dialogRef.afterClosed().subscribe({ next: () => select.complete() });
        return select;
    }
    openContentNodeDialog(data, panelClass, width) {
        return this.dialog.open(ContentNodeSelectorComponent, {
            data,
            panelClass,
            width,
            disableClose: true
        });
    }
    imageResolver(row) {
        const entry = row.node.entry;
        if (!this.contentService.hasAllowableOperations(entry, 'create')) {
            if (this.isNodeFolder(entry)) {
                return this.thumbnailService.getMimeTypeIcon('disable/folder');
            }
        }
        return null;
    }
    hasAllowableOperationsOnNodeFolder(entry) {
        return this.isNodeFolder(entry) && this.contentService.hasAllowableOperations(entry, 'create');
    }
    isNodeFolder(entry) {
        return entry.isFolder;
    }
    isCopyMoveSelectionValid(entry) {
        return this.hasEntityCreatePermission(entry) && !this.isSite(entry);
    }
    hasEntityCreatePermission(entry) {
        return this.contentService.hasAllowableOperations(entry, 'create');
    }
    isSite(entry) {
        return !!entry.guid || entry.nodeType === 'st:site' || entry.nodeType === 'st:sites';
    }
}
ContentNodeDialogService.ɵfac = function ContentNodeDialogService_Factory(t) { return new (t || ContentNodeDialogService)(ɵngcc0.ɵɵinject(ɵngcc1.MatDialog), ɵngcc0.ɵɵinject(ɵngcc2.ContentService), ɵngcc0.ɵɵinject(ɵngcc3.DocumentListService), ɵngcc0.ɵɵinject(ɵngcc2.SitesService), ɵngcc0.ɵɵinject(ɵngcc2.TranslationService), ɵngcc0.ɵɵinject(ɵngcc2.ThumbnailService)); };
ContentNodeDialogService.nonDocumentSiteContent = [
    'blog',
    'calendar',
    'dataLists',
    'discussions',
    'links',
    'wiki'
];
ContentNodeDialogService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ContentNodeDialogService_Factory() { return new ContentNodeDialogService(i0.ɵɵinject(i1.MatDialog), i0.ɵɵinject(i2.ContentService), i0.ɵɵinject(i3.DocumentListService), i0.ɵɵinject(i2.SitesService), i0.ɵɵinject(i2.TranslationService), i0.ɵɵinject(i2.ThumbnailService)); }, token: ContentNodeDialogService, providedIn: "root" });
ContentNodeDialogService.ctorParameters = () => [
    { type: MatDialog },
    { type: ContentService },
    { type: DocumentListService },
    { type: SitesService },
    { type: TranslationService },
    { type: ThumbnailService }
];
ContentNodeDialogService.propDecorators = {
    error: [{ type: Output }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ContentNodeDialogService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.MatDialog }, { type: ɵngcc2.ContentService }, { type: ɵngcc3.DocumentListService }, { type: ɵngcc2.SitesService }, { type: ɵngcc2.TranslationService }, { type: ɵngcc2.ThumbnailService }]; }, { error: [{
            type: Output
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC1ub2RlLWRpYWxvZy5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvY29udGVudC1zZXJ2aWNlcy9zcmMvbGliL2NvbnRlbnQtbm9kZS1zZWxlY3Rvci9jb250ZW50LW5vZGUtZGlhbG9nLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBaUJBLE9BQU8sRUFBRSxTQUFTLEVBQWdCLE1BQU0sMEJBQTBCLENBQUM7QUFDbkUsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxjQUFjLEVBQUUsZ0JBQWdCLEVBQUUsWUFBWSxFQUFFLGtCQUFrQixFQUFFLHVCQUF1QixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDakksT0FBTyxFQUFFLE9BQU8sRUFBYyxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFHdkQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0saURBQWlELENBQUM7QUFDdEYsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFFakYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBQ3RFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ3RFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQztBQUVzQjtBQUVzQjtBQUNWOzs7OztBQUFsQyxNQUFNLE9BQU8sd0JBQXdCO0FBQ3JDLElBYUksWUFBb0IsTUFBaUIsRUFDakIsY0FBOEIsRUFDOUIsbUJBQXdDLEVBQ3hDLFdBQXlCLEVBQ3pCLFdBQStCLEVBQy9CLGdCQUFrQztBQUMxRCxRQU53QixXQUFNLEdBQU4sTUFBTSxDQUFXO0FBQUMsUUFD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QUMsQ0FBQztBQUM1RSxJQUFJLENBQUM7QUFDTCxJQUNZLHlCQUF5QixDQUFDLEtBQVc7QUFBSSxRQUM3QyxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsc0JBQXNCLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQzNFLElBQUksQ0FBQztBQUNMLElBQ1ksTUFBTSxDQUFDLEtBQUs7QUFDeEIsUUFBUSxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLEtBQUssQ0FBQyxRQUFRLEtBQUssU0FBUyxJQUFJLEtBQUssQ0FBQyxRQUFRLEtBQUssVUFBVSxDQUFDO0FBQzdGLElBQUksQ0FBQztBQUNMO2lYQUNBO0FBNU9XLCtDQUFzQixHQUFHO0FBQ3BDLElBQVEsTUFBTTtBQUNkLElBQVEsVUFBVTtBQUNsQixJQUFRLFdBQVc7QUFDbkIsSUFBUSxhQUFhO0FBQ3JCLElBQVEsT0FBTztBQUNmLElBQVEsTUFBTTtBQUNkLENBQUssQ0FBQztBQUNOLG1aQVZLO0FBQUM7RUFITCxVQUFVLFNBQUMsckJBSVIsWUFqQkssU0FBUztjQWNkLFVBQVUsRUFBRSwxQkFkTSxZQUViLGNBQWM7RUFZRCxjQUNyQixoQkFiMEIsWUFJbEIsbUJBQW1CO0FBQUksWUFKVyxZQUFZO0FBQUksWUFBRixrQkFBa0I7QUFBSSxZQUF0RCxnQkFBZ0I7QUFBRztBQUFHO0FBQTRDLG9CQTBCdEYsTUFBTTtBQUNWOzs7Ozs7OztvQkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgTWF0RGlhbG9nLCBNYXREaWFsb2dSZWYgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9kaWFsb2cnO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCBJbmplY3RhYmxlLCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbnRlbnRTZXJ2aWNlLCBUaHVtYm5haWxTZXJ2aWNlLCBTaXRlc1NlcnZpY2UsIFRyYW5zbGF0aW9uU2VydmljZSwgQWxsb3dhYmxlT3BlcmF0aW9uc0VudW0gfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCwgT2JzZXJ2YWJsZSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgU2hhcmVEYXRhUm93IH0gZnJvbSAnLi4vZG9jdW1lbnQtbGlzdC9kYXRhL3NoYXJlLWRhdGEtcm93Lm1vZGVsJztcbmltcG9ydCB7IE5vZGUsIE5vZGVFbnRyeSwgU2l0ZVBhZ2luZyB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgRG9jdW1lbnRMaXN0U2VydmljZSB9IGZyb20gJy4uL2RvY3VtZW50LWxpc3Qvc2VydmljZXMvZG9jdW1lbnQtbGlzdC5zZXJ2aWNlJztcbmltcG9ydCB7IENvbnRlbnROb2RlU2VsZWN0b3JDb21wb25lbnQgfSBmcm9tICcuL2NvbnRlbnQtbm9kZS1zZWxlY3Rvci5jb21wb25lbnQnO1xuaW1wb3J0IHsgQ29udGVudE5vZGVTZWxlY3RvckNvbXBvbmVudERhdGEgfSBmcm9tICcuL2NvbnRlbnQtbm9kZS1zZWxlY3Rvci5jb21wb25lbnQtZGF0YS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgTm9kZUFjdGlvbiB9IGZyb20gJy4uL2RvY3VtZW50LWxpc3QvbW9kZWxzL25vZGUtYWN0aW9uLmVudW0nO1xuaW1wb3J0IHsgTm9kZUxvY2tEaWFsb2dDb21wb25lbnQgfSBmcm9tICcuLi9kaWFsb2dzL25vZGUtbG9jay5kaWFsb2cnO1xuaW1wb3J0IHsgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBkaXJlY3RpdmUtY2xhc3Mtc3VmZml4XG5leHBvcnQgY2xhc3MgQ29udGVudE5vZGVEaWFsb2dTZXJ2aWNlIHtcbiAgICBzdGF0aWMgbm9uRG9jdW1lbnRTaXRlQ29udGVudCA9IFtcbiAgICAgICAgJ2Jsb2cnLFxuICAgICAgICAnY2FsZW5kYXInLFxuICAgICAgICAnZGF0YUxpc3RzJyxcbiAgICAgICAgJ2Rpc2N1c3Npb25zJyxcbiAgICAgICAgJ2xpbmtzJyxcbiAgICAgICAgJ3dpa2knXG4gICAgXTtcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gYW4gZXJyb3Igb2NjdXJzLiAqL1xuICAgIEBPdXRwdXQoKVxuICAgIGVycm9yOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBkaWFsb2c6IE1hdERpYWxvZyxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGNvbnRlbnRTZXJ2aWNlOiBDb250ZW50U2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGRvY3VtZW50TGlzdFNlcnZpY2U6IERvY3VtZW50TGlzdFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBzaXRlU2VydmljZTogU2l0ZXNTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdHJhbnNsYXRpb246IFRyYW5zbGF0aW9uU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRodW1ibmFpbFNlcnZpY2U6IFRodW1ibmFpbFNlcnZpY2UpIHtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPcGVucyBhIGZpbGUgYnJvd3NlciBhdCBhIGNob3NlbiBmb2xkZXIgbG9jYXRpb24uXG4gICAgICogc2hvd3MgZmlsZXMgYW5kIGZvbGRlcnMgaW4gdGhlIGRpYWxvZyBzZWFyY2ggcmVzdWx0LlxuICAgICAqIEBwYXJhbSBmb2xkZXJOb2RlSWQgSUQgb2YgdGhlIGZvbGRlciB0byB1c2VcbiAgICAgKiBAcmV0dXJucyBJbmZvcm1hdGlvbiBhYm91dCB0aGUgc2VsZWN0ZWQgZmlsZShzKVxuICAgICAqL1xuICAgIG9wZW5GaWxlQnJvd3NlRGlhbG9nQnlGb2xkZXJJZChmb2xkZXJOb2RlSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8Tm9kZVtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50TGlzdFNlcnZpY2UuZ2V0Rm9sZGVyTm9kZShmb2xkZXJOb2RlSWQpLnBpcGUoc3dpdGNoTWFwKChub2RlRW50cnk6IE5vZGVFbnRyeSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMub3BlblVwbG9hZEZpbGVEaWFsb2coTm9kZUFjdGlvbi5DSE9PU0UsIG5vZGVFbnRyeS5lbnRyeSwgdHJ1ZSk7XG4gICAgICAgIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPcGVucyBhIGxvY2sgbm9kZSBkaWFsb2cuXG4gICAgICogQHBhcmFtIGNvbnRlbnRFbnRyeSBOb2RlIHRvIGxvY2tcbiAgICAgKiBAcmV0dXJucyBFcnJvci9zdGF0dXMgbWVzc2FnZSAoaWYgYW55KVxuICAgICAqL1xuICAgIHB1YmxpYyBvcGVuTG9ja05vZGVEaWFsb2coY29udGVudEVudHJ5OiBOb2RlKTogU3ViamVjdDxzdHJpbmc+IHtcbiAgICAgICAgY29uc3Qgb2JzZXJ2YWJsZTogU3ViamVjdDxzdHJpbmc+ID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbnRlbnRTZXJ2aWNlLmhhc0FsbG93YWJsZU9wZXJhdGlvbnMoY29udGVudEVudHJ5LCBBbGxvd2FibGVPcGVyYXRpb25zRW51bS5MT0NLKSkge1xuICAgICAgICAgICAgdGhpcy5kaWFsb2cub3BlbihOb2RlTG9ja0RpYWxvZ0NvbXBvbmVudCwge1xuICAgICAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICAgICAgbm9kZTogY29udGVudEVudHJ5LFxuICAgICAgICAgICAgICAgICAgICBvbkVycm9yOiAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXJyb3IuZW1pdChlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZhYmxlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgd2lkdGg6ICc0MDBweCdcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb2JzZXJ2YWJsZS5lcnJvcignT1BFUkFUSU9OLkZBSUwuTk9ERS5OT19QRVJNSVNTSU9OJyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPcGVucyBhIGZpbGUgYnJvd3NlciBhdCBhIGNob3NlbiBzaXRlIGxvY2F0aW9uLlxuICAgICAqIHNob3dzIGZpbGVzIGFuZCBmb2xkZXJzIGluIHRoZSBkaWFsb2cgc2VhcmNoIHJlc3VsdC5cbiAgICAgKiBAcmV0dXJucyBJbmZvcm1hdGlvbiBhYm91dCB0aGUgc2VsZWN0ZWQgZmlsZShzKVxuICAgICAqL1xuICAgIG9wZW5GaWxlQnJvd3NlRGlhbG9nQnlTaXRlKCk6IE9ic2VydmFibGU8Tm9kZVtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnNpdGVTZXJ2aWNlLmdldFNpdGVzKCkucGlwZShzd2l0Y2hNYXAoKHJlc3BvbnNlOiBTaXRlUGFnaW5nKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vcGVuRmlsZUJyb3dzZURpYWxvZ0J5Rm9sZGVySWQocmVzcG9uc2UubGlzdC5lbnRyaWVzWzBdLmVudHJ5Lmd1aWQpO1xuICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogT3BlbnMgYSBmaWxlIGJyb3dzZXIgYXQgYSBkZWZhdWx0IG15RmlsZSBsb2NhdGlvbi5cbiAgICAgKiBzaG93cyBmaWxlcyBhbmQgZm9sZGVycyBpbiB0aGUgZGlhbG9nIHNlYXJjaCByZXN1bHQuXG4gICAgICogQHJldHVybnMgSW5mb3JtYXRpb24gYWJvdXQgdGhlIHNlbGVjdGVkIGZpbGUocylcbiAgICAgKi9cbiAgICBvcGVuRmlsZUJyb3dzZURpYWxvZ0J5RGVmYXVsdExvY2F0aW9uKCk6IE9ic2VydmFibGU8Tm9kZVtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLm9wZW5GaWxlQnJvd3NlRGlhbG9nQnlGb2xkZXJJZCgnLW15LScpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9wZW5zIGEgZm9sZGVyIGJyb3dzZXIgYXQgYSBjaG9zZW4gc2l0ZSBsb2NhdGlvbi5cbiAgICAgKiBAcmV0dXJucyBJbmZvcm1hdGlvbiBhYm91dCB0aGUgc2VsZWN0ZWQgZm9sZGVyKHMpXG4gICAgICovXG4gICAgb3BlbkZvbGRlckJyb3dzZURpYWxvZ0J5U2l0ZSgpOiBPYnNlcnZhYmxlPE5vZGVbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5vcGVuRm9sZGVyQnJvd3NlRGlhbG9nQnlGb2xkZXJJZCgnLW15LScpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9wZW5zIGEgZm9sZGVyIGJyb3dzZXIgYXQgYSBjaG9zZW4gZm9sZGVyIGxvY2F0aW9uLlxuICAgICAqIEBwYXJhbSBmb2xkZXJOb2RlSWQgSUQgb2YgdGhlIGZvbGRlciB0byB1c2VcbiAgICAgKiBAcmV0dXJucyBJbmZvcm1hdGlvbiBhYm91dCB0aGUgc2VsZWN0ZWQgZm9sZGVyKHMpXG4gICAgICovXG4gICAgb3BlbkZvbGRlckJyb3dzZURpYWxvZ0J5Rm9sZGVySWQoZm9sZGVyTm9kZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPE5vZGVbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kb2N1bWVudExpc3RTZXJ2aWNlLmdldEZvbGRlck5vZGUoZm9sZGVyTm9kZUlkKS5waXBlKHN3aXRjaE1hcCgobm9kZTogTm9kZUVudHJ5KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vcGVuVXBsb2FkRm9sZGVyRGlhbG9nKE5vZGVBY3Rpb24uQ0hPT1NFLCBub2RlLmVudHJ5KTtcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9wZW5zIGEgZGlhbG9nIHRvIGNvcHkgb3IgbW92ZSBhbiBpdGVtIHRvIGEgbmV3IGxvY2F0aW9uLlxuICAgICAqIEBwYXJhbSBhY3Rpb24gTmFtZSBvZiB0aGUgYWN0aW9uIChlZywgXCJDb3B5XCIgb3IgXCJNb3ZlXCIpIHRvIHNob3cgaW4gdGhlIHRpdGxlXG4gICAgICogQHBhcmFtIGNvbnRlbnRFbnRyeSBJdGVtIHRvIGJlIGNvcGllZCBvciBtb3ZlZFxuICAgICAqIEBwYXJhbSBwZXJtaXNzaW9uIFBlcm1pc3Npb24gZm9yIHRoZSBvcGVyYXRpb25cbiAgICAgKiBAcGFyYW0gZXhjbHVkZVNpdGVDb250ZW50IFRoZSBzaXRlIGNvbnRlbnQgdGhhdCBzaG91bGQgYmUgZmlsdGVyZWQgb3V0XG4gICAgICogQHJldHVybnMgSW5mb3JtYXRpb24gYWJvdXQgZmlsZXMgdGhhdCB3ZXJlIGNvcGllZC9tb3ZlZFxuICAgICAqL1xuICAgIG9wZW5Db3B5TW92ZURpYWxvZyhhY3Rpb246IE5vZGVBY3Rpb24sIGNvbnRlbnRFbnRyeTogTm9kZSwgcGVybWlzc2lvbj86IHN0cmluZywgZXhjbHVkZVNpdGVDb250ZW50Pzogc3RyaW5nW10pOiBPYnNlcnZhYmxlPE5vZGVbXT4ge1xuICAgICAgICBpZiAodGhpcy5jb250ZW50U2VydmljZS5oYXNBbGxvd2FibGVPcGVyYXRpb25zKGNvbnRlbnRFbnRyeSwgcGVybWlzc2lvbikpIHtcblxuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ID0gbmV3IFN1YmplY3Q8Tm9kZVtdPigpO1xuXG4gICAgICAgICAgICBjb25zdCBkYXRhOiBDb250ZW50Tm9kZVNlbGVjdG9yQ29tcG9uZW50RGF0YSA9IHtcbiAgICAgICAgICAgICAgICB0aXRsZTogdGhpcy5nZXRUaXRsZVRyYW5zbGF0aW9uKGFjdGlvbiwgY29udGVudEVudHJ5Lm5hbWUpLFxuICAgICAgICAgICAgICAgIGFjdGlvbk5hbWU6IGFjdGlvbixcbiAgICAgICAgICAgICAgICBzZWxlY3Rpb25Nb2RlOiAnc2luZ2xlJyxcbiAgICAgICAgICAgICAgICBjdXJyZW50Rm9sZGVySWQ6IGNvbnRlbnRFbnRyeS5wYXJlbnRJZCxcbiAgICAgICAgICAgICAgICBpbWFnZVJlc29sdmVyOiB0aGlzLmltYWdlUmVzb2x2ZXIuYmluZCh0aGlzKSxcbiAgICAgICAgICAgICAgICB3aGVyZTogJyhpc0ZvbGRlcj10cnVlKScsXG4gICAgICAgICAgICAgICAgaXNTZWxlY3Rpb25WYWxpZDogdGhpcy5pc0NvcHlNb3ZlU2VsZWN0aW9uVmFsaWQuYmluZCh0aGlzKSxcbiAgICAgICAgICAgICAgICBleGNsdWRlU2l0ZUNvbnRlbnQ6IGV4Y2x1ZGVTaXRlQ29udGVudCB8fCBDb250ZW50Tm9kZURpYWxvZ1NlcnZpY2Uubm9uRG9jdW1lbnRTaXRlQ29udGVudCxcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IHNlbGVjdFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgY29uc3QgZGlhbG9nUmVmID0gdGhpcy5vcGVuQ29udGVudE5vZGVEaWFsb2coZGF0YSwgJ2FkZi1jb250ZW50LW5vZGUtc2VsZWN0b3ItZGlhbG9nJywgJzYzMHB4Jyk7XG4gICAgICAgICAgICBkaWFsb2dSZWYuYWZ0ZXJDbG9zZWQoKS5zdWJzY3JpYmUoeyBuZXh0OiAoKSA9PiBzZWxlY3QuY29tcGxldGUoKSB9KTtcblxuICAgICAgICAgICAgcmV0dXJuIHNlbGVjdDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGVycm9ycyA9IG5ldyBFcnJvcihKU09OLnN0cmluZ2lmeSh7IGVycm9yOiB7IHN0YXR1c0NvZGU6IDQwMyB9IH0pKTtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9ycyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSB0cmFuc2xhdGlvbiBvZiB0aGUgZGlhbG9nIHRpdGxlLlxuICAgICAqIEBwYXJhbSBhY3Rpb24gTmFtZSBvZiB0aGUgYWN0aW9uIHRvIGRpc3BsYXkgaW4gdGhlIGRpYWxvZyB0aXRsZVxuICAgICAqIEBwYXJhbSBuYW1lIE5hbWUgb2YgdGhlIGl0ZW0gb24gd2hpY2ggdGhlIGFjdGlvbiBpcyBiZWluZyBwZXJmb3JtZWRcbiAgICAgKiBAcmV0dXJucyBUcmFuc2xhdGVkIHZlcnNpb24gb2YgdGhlIHRpdGxlXG4gICAgICovXG4gICAgZ2V0VGl0bGVUcmFuc2xhdGlvbihhY3Rpb246IHN0cmluZywgbmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNsYXRpb24uaW5zdGFudChgTk9ERV9TRUxFQ1RPUi4ke2FjdGlvbi50b1VwcGVyQ2FzZSgpfV9JVEVNYCwgeyBuYW1lIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9wZW5zIGEgZGlhbG9nIHRvIGNob29zZSBmb2xkZXJzIHRvIHVwbG9hZC5cbiAgICAgKiBAcGFyYW0gYWN0aW9uIE5hbWUgb2YgdGhlIGFjdGlvbiB0byBzaG93IGluIHRoZSB0aXRsZVxuICAgICAqIEBwYXJhbSBjb250ZW50RW50cnkgIEl0ZW0gdG8gdXBsb2FkXG4gICAgICogQHJldHVybnMgSW5mb3JtYXRpb24gYWJvdXQgdGhlIGNob3NlbiBmb2xkZXIocylcbiAgICAgKi9cbiAgICBvcGVuVXBsb2FkRm9sZGVyRGlhbG9nKGFjdGlvbjogTm9kZUFjdGlvbiwgY29udGVudEVudHJ5OiBOb2RlKTogT2JzZXJ2YWJsZTxOb2RlW10+IHtcbiAgICAgICAgY29uc3Qgc2VsZWN0ID0gbmV3IFN1YmplY3Q8Tm9kZVtdPigpO1xuXG4gICAgICAgIGNvbnN0IGRhdGE6IENvbnRlbnROb2RlU2VsZWN0b3JDb21wb25lbnREYXRhID0ge1xuICAgICAgICAgICAgdGl0bGU6IHRoaXMuZ2V0VGl0bGVUcmFuc2xhdGlvbihhY3Rpb24sIHRoaXMudHJhbnNsYXRpb24uaW5zdGFudCgnRFJPUERPV04uTVlfRklMRVNfT1BUSU9OJykpLFxuICAgICAgICAgICAgYWN0aW9uTmFtZTogYWN0aW9uLFxuICAgICAgICAgICAgc2VsZWN0aW9uTW9kZTogJ3NpbmdsZScsXG4gICAgICAgICAgICBjdXJyZW50Rm9sZGVySWQ6IGNvbnRlbnRFbnRyeS5pZCxcbiAgICAgICAgICAgIGltYWdlUmVzb2x2ZXI6IHRoaXMuaW1hZ2VSZXNvbHZlci5iaW5kKHRoaXMpLFxuICAgICAgICAgICAgaXNTZWxlY3Rpb25WYWxpZDogdGhpcy5oYXNBbGxvd2FibGVPcGVyYXRpb25zT25Ob2RlRm9sZGVyLmJpbmQodGhpcyksXG4gICAgICAgICAgICB3aGVyZTogJyhpc0ZvbGRlcj10cnVlKScsXG4gICAgICAgICAgICBzZWxlY3Q6IHNlbGVjdFxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGRpYWxvZ1JlZiA9IHRoaXMub3BlbkNvbnRlbnROb2RlRGlhbG9nKGRhdGEsICdhZGYtY29udGVudC1ub2RlLXNlbGVjdG9yLWRpYWxvZycsICc2MzBweCcpO1xuICAgICAgICBkaWFsb2dSZWYuYWZ0ZXJDbG9zZWQoKS5zdWJzY3JpYmUoeyBuZXh0OiAoKSA9PiBzZWxlY3QuY29tcGxldGUoKSB9KTtcblxuICAgICAgICByZXR1cm4gc2VsZWN0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9wZW5zIGEgZGlhbG9nIHRvIGNob29zZSBhIGZpbGUgdG8gdXBsb2FkLlxuICAgICAqIEBwYXJhbSBhY3Rpb24gTmFtZSBvZiB0aGUgYWN0aW9uIHRvIHNob3cgaW4gdGhlIHRpdGxlXG4gICAgICogQHBhcmFtIGNvbnRlbnRFbnRyeSBJdGVtIHRvIHVwbG9hZFxuICAgICAqIEBwYXJhbSBzaG93RmlsZXNJblJlc3VsdCBTaG93IGZpbGVzIGluIGRpYWxvZyBzZWFyY2ggcmVzdWx0XG4gICAgICogQHJldHVybnMgSW5mb3JtYXRpb24gYWJvdXQgdGhlIGNob3NlbiBmaWxlKHMpXG4gICAgICovXG4gICAgb3BlblVwbG9hZEZpbGVEaWFsb2coYWN0aW9uOiBOb2RlQWN0aW9uLCBjb250ZW50RW50cnk6IE5vZGUsIHNob3dGaWxlc0luUmVzdWx0ID0gZmFsc2UpOiBPYnNlcnZhYmxlPE5vZGVbXT4ge1xuICAgICAgICBjb25zdCBzZWxlY3QgPSBuZXcgU3ViamVjdDxOb2RlW10+KCk7XG5cbiAgICAgICAgY29uc3QgZGF0YTogQ29udGVudE5vZGVTZWxlY3RvckNvbXBvbmVudERhdGEgPSB7XG4gICAgICAgICAgICB0aXRsZTogdGhpcy5nZXRUaXRsZVRyYW5zbGF0aW9uKGFjdGlvbiwgdGhpcy50cmFuc2xhdGlvbi5pbnN0YW50KCdEUk9QRE9XTi5NWV9GSUxFU19PUFRJT04nKSksXG4gICAgICAgICAgICBhY3Rpb25OYW1lOiBhY3Rpb24sXG4gICAgICAgICAgICBzZWxlY3Rpb25Nb2RlOiAnc2luZ2xlJyxcbiAgICAgICAgICAgIGN1cnJlbnRGb2xkZXJJZDogY29udGVudEVudHJ5LmlkLFxuICAgICAgICAgICAgaW1hZ2VSZXNvbHZlcjogdGhpcy5pbWFnZVJlc29sdmVyLmJpbmQodGhpcyksXG4gICAgICAgICAgICBpc1NlbGVjdGlvblZhbGlkOiAoZW50cnk6IE5vZGUpID0+IGVudHJ5LmlzRmlsZSxcbiAgICAgICAgICAgIHNlbGVjdDogc2VsZWN0LFxuICAgICAgICAgICAgc2hvd0ZpbGVzSW5SZXN1bHRcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBkaWFsb2dSZWYgPSB0aGlzLm9wZW5Db250ZW50Tm9kZURpYWxvZyhkYXRhLCAnYWRmLWNvbnRlbnQtbm9kZS1zZWxlY3Rvci1kaWFsb2cnLCAnNjMwcHgnKTtcbiAgICAgICAgZGlhbG9nUmVmLmFmdGVyQ2xvc2VkKCkuc3Vic2NyaWJlKHsgbmV4dDogKCkgPT4gc2VsZWN0LmNvbXBsZXRlKCkgfSk7XG5cbiAgICAgICAgcmV0dXJuIHNlbGVjdDtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9wZW5Db250ZW50Tm9kZURpYWxvZyhkYXRhOiBDb250ZW50Tm9kZVNlbGVjdG9yQ29tcG9uZW50RGF0YSwgcGFuZWxDbGFzczogc3RyaW5nLCB3aWR0aDogc3RyaW5nKTogTWF0RGlhbG9nUmVmPENvbnRlbnROb2RlU2VsZWN0b3JDb21wb25lbnQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGlhbG9nLm9wZW4oQ29udGVudE5vZGVTZWxlY3RvckNvbXBvbmVudCwge1xuICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgIHBhbmVsQ2xhc3MsXG4gICAgICAgICAgICB3aWR0aCxcbiAgICAgICAgICAgIGRpc2FibGVDbG9zZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGltYWdlUmVzb2x2ZXIocm93OiBTaGFyZURhdGFSb3cpOiBzdHJpbmcgfCBudWxsIHtcbiAgICAgICAgY29uc3QgZW50cnk6IE5vZGUgPSByb3cubm9kZS5lbnRyeTtcbiAgICAgICAgaWYgKCF0aGlzLmNvbnRlbnRTZXJ2aWNlLmhhc0FsbG93YWJsZU9wZXJhdGlvbnMoZW50cnksICdjcmVhdGUnKSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuaXNOb2RlRm9sZGVyKGVudHJ5KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnRodW1ibmFpbFNlcnZpY2UuZ2V0TWltZVR5cGVJY29uKCdkaXNhYmxlL2ZvbGRlcicpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYXNBbGxvd2FibGVPcGVyYXRpb25zT25Ob2RlRm9sZGVyKGVudHJ5OiBOb2RlKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmlzTm9kZUZvbGRlcihlbnRyeSkgJiYgdGhpcy5jb250ZW50U2VydmljZS5oYXNBbGxvd2FibGVPcGVyYXRpb25zKGVudHJ5LCAnY3JlYXRlJyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc05vZGVGb2xkZXIoZW50cnk6IE5vZGUpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGVudHJ5LmlzRm9sZGVyO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNDb3B5TW92ZVNlbGVjdGlvblZhbGlkKGVudHJ5OiBOb2RlKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc0VudGl0eUNyZWF0ZVBlcm1pc3Npb24oZW50cnkpICYmICF0aGlzLmlzU2l0ZShlbnRyeSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYXNFbnRpdHlDcmVhdGVQZXJtaXNzaW9uKGVudHJ5OiBOb2RlKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbnRlbnRTZXJ2aWNlLmhhc0FsbG93YWJsZU9wZXJhdGlvbnMoZW50cnksICdjcmVhdGUnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzU2l0ZShlbnRyeSkge1xuICAgICAgICByZXR1cm4gISFlbnRyeS5ndWlkIHx8IGVudHJ5Lm5vZGVUeXBlID09PSAnc3Q6c2l0ZScgfHwgZW50cnkubm9kZVR5cGUgPT09ICdzdDpzaXRlcyc7XG4gICAgfVxuXG59XG4iXX0=