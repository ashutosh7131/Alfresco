/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Component, Input, ViewEncapsulation } from '@angular/core';
import { Node } from '@alfresco/js-api';
import { Subject, of, zip } from 'rxjs';
import { NodesApiService, LogService, CardViewUpdateService, AlfrescoApiService, TranslationService, AppConfigService } from '@alfresco/adf-core';
import { ContentMetadataService } from '../../services/content-metadata.service';
import { takeUntil, debounceTime, catchError, map } from 'rxjs/operators';
export class ContentMetadataComponent {
    constructor(contentMetadataService, cardViewUpdateService, nodesApiService, logService, alfrescoApiService, translationService, appConfig) {
        this.contentMetadataService = contentMetadataService;
        this.cardViewUpdateService = cardViewUpdateService;
        this.nodesApiService = nodesApiService;
        this.logService = logService;
        this.alfrescoApiService = alfrescoApiService;
        this.translationService = translationService;
        this.appConfig = appConfig;
        this.onDestroy$ = new Subject();
        this.editable = false;
        this.displayEmpty = false;
        this.expanded = false;
        this.multi = false;
        this.displayDefaultProperties = true;
        this.displayAspect = null;
        this.copyToClipboardAction = true;
        this.useChipsForMultiValueProperty = true;
        this.changedProperties = {};
        this.hasMetadataChanged = false;
        this.copyToClipboardAction = this.appConfig.get('content-metadata.copy-to-clipboard-action');
        this.multiValueSeparator = this.appConfig.get('content-metadata.multi-value-pipe-separator') || ContentMetadataComponent.DEFAULT_SEPARATOR;
        this.useChipsForMultiValueProperty = this.appConfig.get('content-metadata.multi-value-chips');
    }
    ngOnInit() {
        this.cardViewUpdateService.itemUpdated$
            .pipe(debounceTime(500), takeUntil(this.onDestroy$))
            .subscribe((updatedNode) => {
            this.hasMetadataChanged = true;
            this.targetProperty = updatedNode.target;
            this.updateChanges(updatedNode.changed);
        });
        this.cardViewUpdateService.updatedAspect$.pipe(debounceTime(500), takeUntil(this.onDestroy$))
            .subscribe((node) => this.loadProperties(node));
        this.loadProperties(this.node);
    }
    handleUpdateError(error) {
        this.logService.error(error);
        let statusCode = 0;
        try {
            statusCode = JSON.parse(error.message).error.statusCode;
        }
        catch (_a) {
        }
        let message = `METADATA.ERRORS.${statusCode}`;
        if (this.translationService.instant(message) === message) {
            message = 'METADATA.ERRORS.GENERIC';
        }
        this.contentMetadataService.error.next({
            statusCode,
            message
        });
    }
    ngOnChanges(changes) {
        if (changes.node && !changes.node.firstChange) {
            this.loadProperties(changes.node.currentValue);
        }
    }
    loadProperties(node) {
        if (node) {
            this.basicProperties$ = this.getProperties(node);
            this.groupedProperties$ = this.contentMetadataService.getGroupedProperties(node, this.preset);
        }
    }
    getProperties(node) {
        const properties$ = this.contentMetadataService.getBasicProperties(node);
        const contentTypeProperty$ = this.contentMetadataService.getContentTypeProperty(node);
        return zip(properties$, contentTypeProperty$)
            .pipe(map(([properties, contentTypeProperty]) => {
            const filteredProperties = contentTypeProperty.filter((property) => properties.findIndex((baseProperty) => baseProperty.key === property.key) === -1);
            return [...properties, ...filteredProperties];
        }));
    }
    updateChanges(updatedNodeChanges) {
        Object.keys(updatedNodeChanges).map((propertyGroup) => {
            if (typeof updatedNodeChanges[propertyGroup] === 'object') {
                this.changedProperties[propertyGroup] = Object.assign(Object.assign({}, this.changedProperties[propertyGroup]), updatedNodeChanges[propertyGroup]);
            }
            else {
                this.changedProperties[propertyGroup] = updatedNodeChanges[propertyGroup];
            }
        });
    }
    saveChanges() {
        if (this.hasContentTypeChanged(this.changedProperties)) {
            this.contentMetadataService.openConfirmDialog(this.changedProperties).subscribe(() => {
                this.updateNode();
            });
        }
        else {
            this.updateNode();
        }
    }
    updateNode() {
        this.nodesApiService.updateNode(this.node.id, this.changedProperties).pipe(catchError((err) => {
            this.cardViewUpdateService.updateElement(this.targetProperty);
            this.handleUpdateError(err);
            return of(null);
        }))
            .subscribe((updatedNode) => {
            if (updatedNode) {
                if (this.hasContentTypeChanged(this.changedProperties)) {
                    this.cardViewUpdateService.updateNodeAspect(this.node);
                }
                this.revertChanges();
                Object.assign(this.node, updatedNode);
                this.alfrescoApiService.nodeUpdated.next(this.node);
            }
        });
    }
    hasContentTypeChanged(changedProperties) {
        return !!(changedProperties === null || changedProperties === void 0 ? void 0 : changedProperties.nodeType);
    }
    revertChanges() {
        this.changedProperties = {};
        this.hasMetadataChanged = false;
    }
    cancelChanges() {
        this.revertChanges();
        this.loadProperties(this.node);
    }
    showGroup(group) {
        const properties = group.properties.filter((property) => {
            return !this.isEmpty(property.displayValue);
        });
        return properties.length > 0;
    }
    ngOnDestroy() {
        this.onDestroy$.next(true);
        this.onDestroy$.complete();
    }
    canExpandTheCard(group) {
        return group.title === this.displayAspect;
    }
    canExpandProperties() {
        return !this.expanded || this.displayAspect === 'Properties';
    }
    keyDown(event) {
        if (event.keyCode === 37 || event.keyCode === 39) {
            event.stopPropagation();
        }
    }
    isEmpty(value) {
        return value === undefined || value === null || value === '';
    }
}
ContentMetadataComponent.DEFAULT_SEPARATOR = ', ';
ContentMetadataComponent.decorators = [
    { type: Component, args: [{
                selector: 'adf-content-metadata',
                template: "<div class=\"adf-metadata-properties\">\n    <mat-accordion displayMode=\"flat\"\n                   [multi]=\"multi\">\n        <mat-expansion-panel *ngIf=\"displayDefaultProperties\"\n                             [expanded]=\"canExpandProperties()\"\n                             [attr.data-automation-id]=\"'adf-metadata-group-properties'\">\n            <mat-expansion-panel-header>\n                <mat-panel-title role=\"heading\">\n                    {{ 'CORE.METADATA.BASIC.HEADER' | translate }}\n                </mat-panel-title>\n            </mat-expansion-panel-header>\n            <adf-card-view\n                (keydown)=\"keyDown($event)\"\n                [properties]=\"basicProperties$ | async\"\n                [editable]=\"editable\"\n                [displayEmpty]=\"displayEmpty\"\n                [copyToClipboardAction]=\"copyToClipboardAction\"\n                [useChipsForMultiValueProperty]=\"useChipsForMultiValueProperty\"\n                [multiValueSeparator]=\"multiValueSeparator\">\n            </adf-card-view>\n        </mat-expansion-panel>\n\n        <ng-container *ngIf=\"expanded\">\n            <ng-container *ngIf=\"groupedProperties$ | async; else loading; let groupedProperties\">\n                <div *ngFor=\"let group of groupedProperties; let first = first;\"\n                     class=\"adf-metadata-grouped-properties-container\">\n                    <mat-expansion-panel *ngIf=\"showGroup(group) || editable\"\n                                         [attr.data-automation-id]=\"'adf-metadata-group-' + group.title\"\n                                         [expanded]=\"canExpandTheCard(group) || !displayDefaultProperties && first\">\n                        <mat-expansion-panel-header>\n                            <mat-panel-title>\n                                {{ group.title | translate }}\n                            </mat-panel-title>\n                        </mat-expansion-panel-header>\n\n                        <adf-card-view\n                            (keydown)=\"keyDown($event)\"\n                            [properties]=\"group.properties\"\n                            [editable]=\"editable\"\n                            [displayEmpty]=\"displayEmpty\"\n                            [copyToClipboardAction]=\"copyToClipboardAction\"\n                            [useChipsForMultiValueProperty]=\"useChipsForMultiValueProperty\"\n                            [multiValueSeparator]=\"multiValueSeparator\">\n                        </adf-card-view>\n                    </mat-expansion-panel>\n\n                </div>\n            </ng-container>\n            <ng-template #loading>\n                <mat-progress-bar mode=\"indeterminate\"></mat-progress-bar>\n            </ng-template>\n        </ng-container>\n    </mat-accordion>\n\n    <div class=\"adf-metadata-action-buttons\"\n         *ngIf=\"editable\">\n        <button mat-button\n                (click)=\"cancelChanges()\"\n                data-automation-id=\"reset-metadata\"\n                [disabled]=\"!hasMetadataChanged\">\n                {{ 'CORE.METADATA.ACTIONS.CANCEL' | translate }}\n        </button>\n        <button mat-raised-button\n                (click)=\"saveChanges()\"\n                color=\"primary\"\n                data-automation-id=\"save-metadata\"\n                [disabled]=\"!hasMetadataChanged\">\n                {{ 'CORE.METADATA.ACTIONS.SAVE' | translate }}\n            </button>\n    </div>\n\n</div>\n",
                host: { 'class': 'adf-content-metadata' },
                encapsulation: ViewEncapsulation.None,
                styles: [".adf-metadata-properties .mat-expansion-panel-header.mat-expanded:focus,.adf-metadata-properties .mat-expansion-panel-header.mat-expanded:hover{background:var(--theme-bg-hover-color)}.adf-metadata-properties mat-expansion-panel-header{height:64px}.adf-metadata-properties .mat-expansion-panel:not([class*=mat-elevation-z]){box-shadow:none}.adf-metadata-action-buttons{display:flex;justify-content:space-evenly;margin:10px}"]
            },] }
];
ContentMetadataComponent.ctorParameters = () => [
    { type: ContentMetadataService },
    { type: CardViewUpdateService },
    { type: NodesApiService },
    { type: LogService },
    { type: AlfrescoApiService },
    { type: TranslationService },
    { type: AppConfigService }
];
ContentMetadataComponent.propDecorators = {
    node: [{ type: Input }],
    editable: [{ type: Input }],
    displayEmpty: [{ type: Input }],
    expanded: [{ type: Input }],
    multi: [{ type: Input }],
    preset: [{ type: Input }],
    displayDefaultProperties: [{ type: Input }],
    displayAspect: [{ type: Input }],
    copyToClipboardAction: [{ type: Input }],
    useChipsForMultiValueProperty: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC1tZXRhZGF0YS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb250ZW50LXNlcnZpY2VzL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9jb250ZW50LW1ldGFkYXRhL2NvbXBvbmVudHMvY29udGVudC1tZXRhZGF0YS9jb250ZW50LW1ldGFkYXRhLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFFSCxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBK0MsaUJBQWlCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDakgsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hDLE9BQU8sRUFBYyxPQUFPLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwRCxPQUFPLEVBRUgsZUFBZSxFQUNmLFVBQVUsRUFDVixxQkFBcUIsRUFDckIsa0JBQWtCLEVBQ2xCLGtCQUFrQixFQUNsQixnQkFBZ0IsRUFHbkIsTUFBTSxvQkFBb0IsQ0FBQztBQUM1QixPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQUVqRixPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFTMUUsTUFBTSxPQUFPLHdCQUF3QjtJQXdEakMsWUFDWSxzQkFBOEMsRUFDOUMscUJBQTRDLEVBQzVDLGVBQWdDLEVBQ2hDLFVBQXNCLEVBQ3RCLGtCQUFzQyxFQUN0QyxrQkFBc0MsRUFDdEMsU0FBMkI7UUFOM0IsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUF3QjtRQUM5QywwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO1FBQzVDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNoQyxlQUFVLEdBQVYs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Ii8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE9uQ2hhbmdlcywgT25EZXN0cm95LCBPbkluaXQsIFNpbXBsZUNoYW5nZXMsIFZpZXdFbmNhcHN1bGF0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOb2RlIH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBvZiwgemlwIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICAgIENhcmRWaWV3SXRlbSxcbiAgICBOb2Rlc0FwaVNlcnZpY2UsXG4gICAgTG9nU2VydmljZSxcbiAgICBDYXJkVmlld1VwZGF0ZVNlcnZpY2UsXG4gICAgQWxmcmVzY29BcGlTZXJ2aWNlLFxuICAgIFRyYW5zbGF0aW9uU2VydmljZSxcbiAgICBBcHBDb25maWdTZXJ2aWNlLFxuICAgIENhcmRWaWV3QmFzZUl0ZW1Nb2RlbCxcbiAgICBVcGRhdGVOb3RpZmljYXRpb25cbn0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IENvbnRlbnRNZXRhZGF0YVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9jb250ZW50LW1ldGFkYXRhLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ2FyZFZpZXdHcm91cCwgUHJlc2V0Q29uZmlnIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9jb250ZW50LW1ldGFkYXRhLmludGVyZmFjZXMnO1xuaW1wb3J0IHsgdGFrZVVudGlsLCBkZWJvdW5jZVRpbWUsIGNhdGNoRXJyb3IsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdhZGYtY29udGVudC1tZXRhZGF0YScsXG4gICAgdGVtcGxhdGVVcmw6ICcuL2NvbnRlbnQtbWV0YWRhdGEuY29tcG9uZW50Lmh0bWwnLFxuICAgIHN0eWxlVXJsczogWycuL2NvbnRlbnQtbWV0YWRhdGEuY29tcG9uZW50LnNjc3MnXSxcbiAgICBob3N0OiB7ICdjbGFzcyc6ICdhZGYtY29udGVudC1tZXRhZGF0YScgfSxcbiAgICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lXG59KVxuZXhwb3J0IGNsYXNzIENvbnRlbnRNZXRhZGF0YUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgT25Jbml0LCBPbkRlc3Ryb3kge1xuXG4gICAgc3RhdGljIERFRkFVTFRfU0VQQVJBVE9SID0gJywgJztcblxuICAgIHByb3RlY3RlZCBvbkRlc3Ryb3kkID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcblxuICAgIC8qKiAocmVxdWlyZWQpIFRoZSBub2RlIGVudGl0eSB0byBmZXRjaCBtZXRhZGF0YSBhYm91dCAqL1xuICAgIEBJbnB1dCgpXG4gICAgbm9kZTogTm9kZTtcblxuICAgIC8qKiBUb2dnbGVzIHdoZXRoZXIgdGhlIGVkaXQgYnV0dG9uIHNob3VsZCBiZSBzaG93biAqL1xuICAgIEBJbnB1dCgpXG4gICAgZWRpdGFibGU6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIC8qKiBUb2dnbGVzIHdoZXRoZXIgdG8gZGlzcGxheSBlbXB0eSB2YWx1ZXMgaW4gdGhlIGNhcmQgdmlldyAqL1xuICAgIEBJbnB1dCgpXG4gICAgZGlzcGxheUVtcHR5OiBib29sZWFuID0gZmFsc2U7XG5cbiAgICAvKiogVG9nZ2xlcyBiZXR3ZWVuIGV4cGFuZGVkIChpZSwgZnVsbCBpbmZvcm1hdGlvbikgYW5kIGNvbGxhcHNlZFxuICAgICAqIChpZSwgcmVkdWNlZCBpbmZvcm1hdGlvbikgaW4gdGhlIGRpc3BsYXlcbiAgICAgKi9cbiAgICBASW5wdXQoKVxuICAgIGV4cGFuZGVkOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICAvKiogVGhlIG11bHRpIHBhcmFtZXRlciBvZiB0aGUgdW5kZXJseWluZyBtYXRlcmlhbCBleHBhbnNpb24gcGFuZWwsIHNldCB0byB0cnVlIHRvIGFsbG93IG11bHRpIGFjY29yZGlvbiB0byBiZSBleHBhbmRlZCBhdCB0aGUgc2FtZSB0aW1lICovXG4gICAgQElucHV0KClcbiAgICBtdWx0aSA9IGZhbHNlO1xuXG4gICAgLyoqIE5hbWUgb3IgY29uZmlndXJhdGlvbiBvZiB0aGUgbWV0YWRhdGEgcHJlc2V0LCB3aGljaCBkZWZpbmVzIGFzcGVjdHMgYW5kIHRoZWlyIHByb3BlcnRpZXMgKi9cbiAgICBASW5wdXQoKVxuICAgIHByZXNldDogc3RyaW5nIHwgUHJlc2V0Q29uZmlnO1xuXG4gICAgLyoqIFRvZ2dsZXMgd2hldGhlciB0aGUgbWV0YWRhdGEgcHJvcGVydGllcyBzaG91bGQgYmUgc2hvd24gKi9cbiAgICBASW5wdXQoKVxuICAgIGRpc3BsYXlEZWZhdWx0UHJvcGVydGllczogYm9vbGVhbiA9IHRydWU7XG5cbiAgICAvKiogKG9wdGlvbmFsKSBzaG93cyB0aGUgZ2l2ZW4gYXNwZWN0IGluIHRoZSBleHBhbmRlZCAgY2FyZCAqL1xuICAgIEBJbnB1dCgpXG4gICAgZGlzcGxheUFzcGVjdDogc3RyaW5nID0gbnVsbDtcblxuICAgIC8qKiBUb2dnbGVzIHdoZXRoZXIgb3Igbm90IHRvIGVuYWJsZSBjb3B5IHRvIGNsaXBib2FyZCBhY3Rpb24uICovXG4gICAgQElucHV0KClcbiAgICBjb3B5VG9DbGlwYm9hcmRBY3Rpb246IGJvb2xlYW4gPSB0cnVlO1xuXG4gICAgLyoqIFRvZ2dsZXMgd2hldGhlciBvciBub3QgdG8gZW5hYmxlIGNoaXBzIGZvciBtdWx0aXZhbHVlZCBwcm9wZXJ0aWVzLiAqL1xuICAgIEBJbnB1dCgpXG4gICAgdXNlQ2hpcHNGb3JNdWx0aVZhbHVlUHJvcGVydHk6IGJvb2xlYW4gPSB0cnVlO1xuXG4gICAgbXVsdGlWYWx1ZVNlcGFyYXRvcjogc3RyaW5nO1xuICAgIGJhc2ljUHJvcGVydGllcyQ6IE9ic2VydmFibGU8Q2FyZFZpZXdJdGVtW10+O1xuICAgIGdyb3VwZWRQcm9wZXJ0aWVzJDogT2JzZXJ2YWJsZTxDYXJkVmlld0dyb3VwW10+O1xuXG4gICAgY2hhbmdlZFByb3BlcnRpZXMgPSB7fTtcbiAgICBoYXNNZXRhZGF0YUNoYW5nZWQgPSBmYWxzZTtcbiAgICBwcml2YXRlIHRhcmdldFByb3BlcnR5OiBDYXJkVmlld0Jhc2VJdGVtTW9kZWw7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBjb250ZW50TWV0YWRhdGFTZXJ2aWNlOiBDb250ZW50TWV0YWRhdGFTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGNhcmRWaWV3VXBkYXRlU2VydmljZTogQ2FyZFZpZXdVcGRhdGVTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIG5vZGVzQXBpU2VydmljZTogTm9kZXNBcGlTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgYWxmcmVzY29BcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgdHJhbnNsYXRpb25TZXJ2aWNlOiBUcmFuc2xhdGlvblNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgYXBwQ29uZmlnOiBBcHBDb25maWdTZXJ2aWNlXG4gICAgKSB7XG4gICAgICAgIHRoaXMuY29weVRvQ2xpcGJvYXJkQWN0aW9uID0gdGhpcy5hcHBDb25maWcuZ2V0PGJvb2xlYW4+KCdjb250ZW50LW1ldGFkYXRhLmNvcHktdG8tY2xpcGJvYXJkLWFjdGlvbicpO1xuICAgICAgICB0aGlzLm11bHRpVmFsdWVTZXBhcmF0b3IgPSB0aGlzLmFwcENvbmZpZy5nZXQ8c3RyaW5nPignY29udGVudC1tZXRhZGF0YS5tdWx0aS12YWx1ZS1waXBlLXNlcGFyYXRvcicpIHx8IENvbnRlbnRNZXRhZGF0YUNvbXBvbmVudC5ERUZBVUxUX1NFUEFSQVRPUjtcbiAgICAgICAgdGhpcy51c2VDaGlwc0Zvck11bHRpVmFsdWVQcm9wZXJ0eSA9IHRoaXMuYXBwQ29uZmlnLmdldDxib29sZWFuPignY29udGVudC1tZXRhZGF0YS5tdWx0aS12YWx1ZS1jaGlwcycpO1xuICAgIH1cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICB0aGlzLmNhcmRWaWV3VXBkYXRlU2VydmljZS5pdGVtVXBkYXRlZCRcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGRlYm91bmNlVGltZSg1MDApLFxuICAgICAgICAgICAgICAgIHRha2VVbnRpbCh0aGlzLm9uRGVzdHJveSQpKVxuICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAodXBkYXRlZE5vZGU6IFVwZGF0ZU5vdGlmaWNhdGlvbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhc01ldGFkYXRhQ2hhbmdlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UHJvcGVydHkgPSB1cGRhdGVkTm9kZS50YXJnZXQ7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQ2hhbmdlcyh1cGRhdGVkTm9kZS5jaGFuZ2VkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuXG4gICAgICAgIHRoaXMuY2FyZFZpZXdVcGRhdGVTZXJ2aWNlLnVwZGF0ZWRBc3BlY3QkLnBpcGUoXG4gICAgICAgICAgICBkZWJvdW5jZVRpbWUoNTAwKSxcbiAgICAgICAgICAgIHRha2VVbnRpbCh0aGlzLm9uRGVzdHJveSQpKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgobm9kZSkgPT4gdGhpcy5sb2FkUHJvcGVydGllcyhub2RlKSk7XG5cbiAgICAgICAgdGhpcy5sb2FkUHJvcGVydGllcyh0aGlzLm5vZGUpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBoYW5kbGVVcGRhdGVFcnJvcihlcnJvcjogRXJyb3IpIHtcbiAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGVycm9yKTtcblxuICAgICAgICBsZXQgc3RhdHVzQ29kZSA9IDA7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHN0YXR1c0NvZGUgPSBKU09OLnBhcnNlKGVycm9yLm1lc3NhZ2UpLmVycm9yLnN0YXR1c0NvZGU7XG4gICAgICAgIH0gY2F0Y2gge1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG1lc3NhZ2UgPSBgTUVUQURBVEEuRVJST1JTLiR7c3RhdHVzQ29kZX1gO1xuXG4gICAgICAgIGlmICh0aGlzLnRyYW5zbGF0aW9uU2VydmljZS5pbnN0YW50KG1lc3NhZ2UpID09PSBtZXNzYWdlKSB7XG4gICAgICAgICAgICBtZXNzYWdlID0gJ01FVEFEQVRBLkVSUk9SUy5HRU5FUklDJztcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY29udGVudE1ldGFkYXRhU2VydmljZS5lcnJvci5uZXh0KHtcbiAgICAgICAgICAgIHN0YXR1c0NvZGUsXG4gICAgICAgICAgICBtZXNzYWdlXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICAgICAgaWYgKGNoYW5nZXMubm9kZSAmJiAhY2hhbmdlcy5ub2RlLmZpcnN0Q2hhbmdlKSB7XG4gICAgICAgICAgICB0aGlzLmxvYWRQcm9wZXJ0aWVzKGNoYW5nZXMubm9kZS5jdXJyZW50VmFsdWUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBsb2FkUHJvcGVydGllcyhub2RlOiBOb2RlKSB7XG4gICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgICB0aGlzLmJhc2ljUHJvcGVydGllcyQgPSB0aGlzLmdldFByb3BlcnRpZXMobm9kZSk7XG4gICAgICAgICAgICB0aGlzLmdyb3VwZWRQcm9wZXJ0aWVzJCA9IHRoaXMuY29udGVudE1ldGFkYXRhU2VydmljZS5nZXRHcm91cGVkUHJvcGVydGllcyhub2RlLCB0aGlzLnByZXNldCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFByb3BlcnRpZXMobm9kZTogTm9kZSkge1xuICAgICAgICBjb25zdCBwcm9wZXJ0aWVzJCA9IHRoaXMuY29udGVudE1ldGFkYXRhU2VydmljZS5nZXRCYXNpY1Byb3BlcnRpZXMobm9kZSk7XG4gICAgICAgIGNvbnN0IGNvbnRlbnRUeXBlUHJvcGVydHkkID0gdGhpcy5jb250ZW50TWV0YWRhdGFTZXJ2aWNlLmdldENvbnRlbnRUeXBlUHJvcGVydHkobm9kZSk7XG4gICAgICAgIHJldHVybiB6aXAocHJvcGVydGllcyQsIGNvbnRlbnRUeXBlUHJvcGVydHkkKVxuICAgICAgICAgICAgLnBpcGUobWFwKChbcHJvcGVydGllcywgY29udGVudFR5cGVQcm9wZXJ0eV0pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXJlZFByb3BlcnRpZXMgPSBjb250ZW50VHlwZVByb3BlcnR5LmZpbHRlcigocHJvcGVydHkpID0+IHByb3BlcnRpZXMuZmluZEluZGV4KChiYXNlUHJvcGVydHkpID0+IGJhc2VQcm9wZXJ0eS5rZXkgPT09IHByb3BlcnR5LmtleSkgPT09IC0xKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gWy4uLnByb3BlcnRpZXMsIC4uLmZpbHRlcmVkUHJvcGVydGllc107XG4gICAgICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgdXBkYXRlQ2hhbmdlcyh1cGRhdGVkTm9kZUNoYW5nZXMpIHtcbiAgICAgICAgT2JqZWN0LmtleXModXBkYXRlZE5vZGVDaGFuZ2VzKS5tYXAoKHByb3BlcnR5R3JvdXA6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB1cGRhdGVkTm9kZUNoYW5nZXNbcHJvcGVydHlHcm91cF0gPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jaGFuZ2VkUHJvcGVydGllc1twcm9wZXJ0eUdyb3VwXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5jaGFuZ2VkUHJvcGVydGllc1twcm9wZXJ0eUdyb3VwXSxcbiAgICAgICAgICAgICAgICAgICAgLi4udXBkYXRlZE5vZGVDaGFuZ2VzW3Byb3BlcnR5R3JvdXBdXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jaGFuZ2VkUHJvcGVydGllc1twcm9wZXJ0eUdyb3VwXSA9IHVwZGF0ZWROb2RlQ2hhbmdlc1twcm9wZXJ0eUdyb3VwXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc2F2ZUNoYW5nZXMoKSB7XG4gICAgICAgIGlmICh0aGlzLmhhc0NvbnRlbnRUeXBlQ2hhbmdlZCh0aGlzLmNoYW5nZWRQcm9wZXJ0aWVzKSkge1xuICAgICAgICAgICAgdGhpcy5jb250ZW50TWV0YWRhdGFTZXJ2aWNlLm9wZW5Db25maXJtRGlhbG9nKHRoaXMuY2hhbmdlZFByb3BlcnRpZXMpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVOb2RlKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlTm9kZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVOb2RlKCkge1xuICAgICAgICB0aGlzLm5vZGVzQXBpU2VydmljZS51cGRhdGVOb2RlKHRoaXMubm9kZS5pZCwgdGhpcy5jaGFuZ2VkUHJvcGVydGllcykucGlwZShcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuY2FyZFZpZXdVcGRhdGVTZXJ2aWNlLnVwZGF0ZUVsZW1lbnQodGhpcy50YXJnZXRQcm9wZXJ0eSk7XG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVVcGRhdGVFcnJvcihlcnIpO1xuICAgICAgICAgICAgICAgIHJldHVybiBvZihudWxsKTtcbiAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgodXBkYXRlZE5vZGUpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodXBkYXRlZE5vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzQ29udGVudFR5cGVDaGFuZ2VkKHRoaXMuY2hhbmdlZFByb3BlcnRpZXMpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhcmRWaWV3VXBkYXRlU2VydmljZS51cGRhdGVOb2RlQXNwZWN0KHRoaXMubm9kZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXZlcnRDaGFuZ2VzKCk7XG4gICAgICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5ub2RlLCB1cGRhdGVkTm9kZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLm5vZGVVcGRhdGVkLm5leHQodGhpcy5ub2RlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhc0NvbnRlbnRUeXBlQ2hhbmdlZChjaGFuZ2VkUHJvcGVydGllcyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gISFjaGFuZ2VkUHJvcGVydGllcz8ubm9kZVR5cGU7XG4gICAgfVxuXG4gICAgcmV2ZXJ0Q2hhbmdlcygpIHtcbiAgICAgICAgdGhpcy5jaGFuZ2VkUHJvcGVydGllcyA9IHt9O1xuICAgICAgICB0aGlzLmhhc01ldGFkYXRhQ2hhbmdlZCA9IGZhbHNlO1xuICAgIH1cblxuICAgIGNhbmNlbENoYW5nZXMoKSB7XG4gICAgICAgIHRoaXMucmV2ZXJ0Q2hhbmdlcygpO1xuICAgICAgICB0aGlzLmxvYWRQcm9wZXJ0aWVzKHRoaXMubm9kZSk7XG4gICAgfVxuXG4gICAgc2hvd0dyb3VwKGdyb3VwOiBDYXJkVmlld0dyb3VwKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSBncm91cC5wcm9wZXJ0aWVzLmZpbHRlcigocHJvcGVydHkpID0+IHtcbiAgICAgICAgICAgIHJldHVybiAhdGhpcy5pc0VtcHR5KHByb3BlcnR5LmRpc3BsYXlWYWx1ZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBwcm9wZXJ0aWVzLmxlbmd0aCA+IDA7XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMub25EZXN0cm95JC5uZXh0KHRydWUpO1xuICAgICAgICB0aGlzLm9uRGVzdHJveSQuY29tcGxldGUoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2FuRXhwYW5kVGhlQ2FyZChncm91cDogQ2FyZFZpZXdHcm91cCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gZ3JvdXAudGl0bGUgPT09IHRoaXMuZGlzcGxheUFzcGVjdDtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2FuRXhwYW5kUHJvcGVydGllcygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICF0aGlzLmV4cGFuZGVkIHx8IHRoaXMuZGlzcGxheUFzcGVjdCA9PT0gJ1Byb3BlcnRpZXMnO1xuICAgIH1cblxuICAgIGtleURvd24oZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICAgICAgaWYgKGV2ZW50LmtleUNvZGUgPT09IDM3IHx8IGV2ZW50LmtleUNvZGUgPT09IDM5KSB7IC8vIEFycm93TGVmdCAmJiBBcnJvd1JpZ2h0XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaXNFbXB0eSh2YWx1ZTogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSAnJztcbiAgICB9XG59XG4iXX0=