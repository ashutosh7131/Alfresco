import { Injectable } from '@angular/core';
import { MatDialog } from '@angular/material/dialog';
import { CardViewSelectItemModel, CardViewTextItemModel, VersionCompatibilityService } from '@alfresco/adf-core';
import { of, Subject, zip } from 'rxjs';
import { distinctUntilChanged, map } from 'rxjs/operators';
import { ContentTypeDialogComponent } from '../../content-type/content-type-dialog.component';
import { ContentTypeService } from '../../content-type/content-type.service';
import { PropertyGroupTranslatorService } from './property-groups-translator.service';
import * as i0 from "@angular/core";
import * as i1 from "../../content-type/content-type.service";
import * as i2 from "@angular/material/dialog";
import * as i3 from "@alfresco/adf-core";
import * as i4 from "./property-groups-translator.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../../content-type/content-type.service';
import * as ɵngcc2 from '@angular/material/dialog';
import * as ɵngcc3 from '@alfresco/adf-core';
import * as ɵngcc4 from './property-groups-translator.service';
export class ContentTypePropertiesService {
    constructor(contentTypeService, dialog, versionCompatibilityService, propertyGroupTranslatorService) {
        this.contentTypeService = contentTypeService;
        this.dialog = dialog;
        this.versionCompatibilityService = versionCompatibilityService;
        this.propertyGroupTranslatorService = propertyGroupTranslatorService;
    }
    getContentTypeCardItem(node) {
        if (this.versionCompatibilityService.isVersionSupported('7')) {
            return this.contentTypeService.getContentTypeByPrefix(node.nodeType).
                pipe(map((contentType) => {
                const contentTypesOptions$ = this.getContentTypesAsSelectOption(contentType);
                const contentTypeCard = this.buildContentTypeSelectCardModel(contentType.entry.id, contentTypesOptions$);
                const filteredProperties = this.getContentTypeSpecificProperties(contentType);
                const propertiesCard = this.buildCardItemsFromPropertyList(filteredProperties, node.properties);
                return [contentTypeCard, ...propertiesCard];
            }));
        }
        else {
            return of([this.buildContentTypeTextCardModel(node.nodeType)]);
        }
    }
    buildCardItemsFromPropertyList(properties, currentProperties) {
        return properties.map((property) => {
            const propertyValue = currentProperties ? currentProperties[property.id] : null;
            return this.buildCardItemFromProperty(property, propertyValue);
        });
    }
    buildCardItemFromProperty(property, propertyValue) {
        return this.propertyGroupTranslatorService.translateProperty(property, propertyValue, true);
    }
    getContentTypeSpecificProperties(contentType) {
        return contentType.entry.properties.filter((property) => property.id.startsWith(contentType.entry.model.namespacePrefix));
    }
    buildContentTypeTextCardModel(currentValue) {
        const contentTypeCard = new CardViewTextItemModel({
            label: 'CORE.METADATA.BASIC.CONTENT_TYPE',
            value: currentValue,
            key: 'nodeType',
            editable: false
        });
        return contentTypeCard;
    }
    buildContentTypeSelectCardModel(currentValue, options$) {
        const contentTypeCard = new CardViewSelectItemModel({
            label: 'CORE.METADATA.BASIC.CONTENT_TYPE',
            value: currentValue,
            key: 'nodeType',
            editable: true,
            options$: options$,
            displayNoneOption: false
        });
        return contentTypeCard;
    }
    getContentTypesAsSelectOption(currentType) {
        const childrenTypes$ = this.contentTypeService.getContentTypeChildren(currentType.entry.id);
        return zip(childrenTypes$, of(currentType)).pipe(distinctUntilChanged(), map(([contentTypesEntries, currentContentType]) => {
            const updatedTypes = this.appendCurrentType(currentContentType, contentTypesEntries);
            return updatedTypes.map((contentType) => { var _a; return ({ key: contentType.entry.id, label: (_a = contentType.entry.title) !== null && _a !== void 0 ? _a : contentType.entry.id }); });
        }));
    }
    appendCurrentType(currentType, contentTypesEntries) {
        const resultTypes = [...contentTypesEntries];
        const currentTypePresent = contentTypesEntries.find((type) => type.entry.id === currentType.entry.id);
        if (!currentTypePresent) {
            resultTypes.push(currentType);
        }
        return resultTypes;
    }
    openContentTypeDialogConfirm(nodeType) {
        const select = new Subject();
        select.subscribe({
            complete: this.close.bind(this)
        });
        const data = {
            title: 'CORE.METADATA.CONTENT_TYPE.DIALOG.TITLE',
            description: 'CORE.METADATA.CONTENT_TYPE.DIALOG.DESCRIPTION',
            confirmMessage: 'CORE.METADATA.CONTENT_TYPE.DIALOG.CONFIRM',
            select: select,
            nodeType
        };
        this.openDialog(data, 'adf-content-type-dialog', '600px');
        return select;
    }
    close() {
        this.dialog.closeAll();
    }
    openDialog(data, panelClass, width) {
        this.dialog.open(ContentTypeDialogComponent, {
            data,
            panelClass,
            width,
            disableClose: true
        });
    }
}
ContentTypePropertiesService.ɵfac = function ContentTypePropertiesService_Factory(t) { return new (t || ContentTypePropertiesService)(ɵngcc0.ɵɵinject(ɵngcc1.ContentTypeService), ɵngcc0.ɵɵinject(ɵngcc2.MatDialog), ɵngcc0.ɵɵinject(ɵngcc3.VersionCompatibilityService), ɵngcc0.ɵɵinject(ɵngcc4.PropertyGroupTranslatorService)); };
ContentTypePropertiesService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ContentTypePropertiesService_Factory() { return new ContentTypePropertiesService(i0.ɵɵinject(i1.ContentTypeService), i0.ɵɵinject(i2.MatDialog), i0.ɵɵinject(i3.VersionCompatibilityService), i0.ɵɵinject(i4.PropertyGroupTranslatorService)); }, token: ContentTypePropertiesService, providedIn: "root" });
ContentTypePropertiesService.ctorParameters = () => [
    { type: ContentTypeService },
    { type: MatDialog },
    { type: VersionCompatibilityService },
    { type: PropertyGroupTranslatorService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ContentTypePropertiesService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.ContentTypeService }, { type: ɵngcc2.MatDialog }, { type: ɵngcc3.VersionCompatibilityService }, { type: ɵngcc4.PropertyGroupTranslatorService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC10eXBlLXByb3BlcnR5LnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb250ZW50LXNlcnZpY2VzL3NyYy9saWIvY29udGVudC1tZXRhZGF0YS9zZXJ2aWNlcy9jb250ZW50LXR5cGUtcHJvcGVydHkuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFpQkEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDckQsT0FBTyxFQUFnQix1QkFBdUIsRUFBNEIscUJBQXFCLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN6SixPQUFPLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDcEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNELE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLGtEQUFrRCxDQUFDO0FBRTlGLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBRTdFLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ3RGO0FBRXNCO0FBSVI7QUFBZ0Q7QUFDdEI7Ozs7OztBQUh4QyxNQUFNLE9BQU8sNEJBQTRCO0FBQ3pDLElBQ0ksWUFBb0Isa0JBQXNDLEVBQ3RDLE1BQWlCLEVBQ2pCLDJCQUF3RCxFQUN4RCw4QkFBOEQ7QUFDdEYsUUFKd0IsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtBQUFDLFFBQ3ZDLFdBQU0sR0FBTixNQUFNLENBQVc7QUFBQyxRQUNsQixnQ0FBMkIsR0FBM0IsMkJBQTJCLENBQTZC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LDBCQUEwQixFQUFFO0FBQ3JELFlBQVksSUFBSTtBQUNoQixZQUFZLFVBQVU7QUFDdEIsWUFBWSxLQUFLO0FBQ2pCLFlBQVksWUFBWSxFQUFFLElBQUk7QUFDOUIsU0FBUyxDQUFDLENBQUM7QUFDWCxJQUFJLENBQUM7QUFDTDtxVUFBQztBQUNELDJYQWpISztBQUFDO0VBSEwsVUFBVSxTQUFDLHJCQUtHLFlBVE4sa0JBQWtCO0tBS3ZCLFVBQVUsRUFBRSxNQUFNLHZCQUxTLFlBTnRCLFNBQVM7WUFZakIsWkFacUIsWUFDMkUsMkJBQTJCO0FBQUksWUFPdkgsOEJBQThCO0FBQUc7Ozs7Ozs4TUFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTWF0RGlhbG9nIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvZGlhbG9nJztcbmltcG9ydCB7IENhcmRWaWV3SXRlbSwgQ2FyZFZpZXdTZWxlY3RJdGVtTW9kZWwsIENhcmRWaWV3U2VsZWN0SXRlbU9wdGlvbiwgQ2FyZFZpZXdUZXh0SXRlbU1vZGVsLCBWZXJzaW9uQ29tcGF0aWJpbGl0eVNlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QsIHppcCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENvbnRlbnRUeXBlRGlhbG9nQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vY29udGVudC10eXBlL2NvbnRlbnQtdHlwZS1kaWFsb2cuY29tcG9uZW50JztcbmltcG9ydCB7IENvbnRlbnRUeXBlRGlhbG9nQ29tcG9uZW50RGF0YSB9IGZyb20gJy4uLy4uL2NvbnRlbnQtdHlwZS9jb250ZW50LXR5cGUtbWV0YWRhdGEuaW50ZXJmYWNlJztcbmltcG9ydCB7IENvbnRlbnRUeXBlU2VydmljZSB9IGZyb20gJy4uLy4uL2NvbnRlbnQtdHlwZS9jb250ZW50LXR5cGUuc2VydmljZSc7XG5pbXBvcnQgeyBOb2RlLCBQcm9wZXJ0eSwgVHlwZUVudHJ5IH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBQcm9wZXJ0eUdyb3VwVHJhbnNsYXRvclNlcnZpY2UgfSBmcm9tICcuL3Byb3BlcnR5LWdyb3Vwcy10cmFuc2xhdG9yLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIENvbnRlbnRUeXBlUHJvcGVydGllc1NlcnZpY2Uge1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBjb250ZW50VHlwZVNlcnZpY2U6IENvbnRlbnRUeXBlU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGRpYWxvZzogTWF0RGlhbG9nLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdmVyc2lvbkNvbXBhdGliaWxpdHlTZXJ2aWNlOiBWZXJzaW9uQ29tcGF0aWJpbGl0eVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBwcm9wZXJ0eUdyb3VwVHJhbnNsYXRvclNlcnZpY2U6IFByb3BlcnR5R3JvdXBUcmFuc2xhdG9yU2VydmljZSkge1xuICAgIH1cblxuICAgIGdldENvbnRlbnRUeXBlQ2FyZEl0ZW0obm9kZTogTm9kZSk6IE9ic2VydmFibGU8Q2FyZFZpZXdJdGVtW10+IHtcbiAgICAgICAgaWYgKHRoaXMudmVyc2lvbkNvbXBhdGliaWxpdHlTZXJ2aWNlLmlzVmVyc2lvblN1cHBvcnRlZCgnNycpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb250ZW50VHlwZVNlcnZpY2UuZ2V0Q29udGVudFR5cGVCeVByZWZpeChub2RlLm5vZGVUeXBlKS5cbiAgICAgICAgICAgICAgICBwaXBlKFxuICAgICAgICAgICAgICAgICAgICBtYXAoKGNvbnRlbnRUeXBlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50VHlwZXNPcHRpb25zJCA9IHRoaXMuZ2V0Q29udGVudFR5cGVzQXNTZWxlY3RPcHRpb24oY29udGVudFR5cGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udGVudFR5cGVDYXJkID0gdGhpcy5idWlsZENvbnRlbnRUeXBlU2VsZWN0Q2FyZE1vZGVsKGNvbnRlbnRUeXBlLmVudHJ5LmlkLCBjb250ZW50VHlwZXNPcHRpb25zJCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXJlZFByb3BlcnRpZXMgPSAgdGhpcy5nZXRDb250ZW50VHlwZVNwZWNpZmljUHJvcGVydGllcyhjb250ZW50VHlwZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9wZXJ0aWVzQ2FyZCA9IHRoaXMuYnVpbGRDYXJkSXRlbXNGcm9tUHJvcGVydHlMaXN0KGZpbHRlcmVkUHJvcGVydGllcywgbm9kZS5wcm9wZXJ0aWVzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbY29udGVudFR5cGVDYXJkLCAuLi5wcm9wZXJ0aWVzQ2FyZF07XG4gICAgICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBvZihbdGhpcy5idWlsZENvbnRlbnRUeXBlVGV4dENhcmRNb2RlbChub2RlLm5vZGVUeXBlKV0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYnVpbGRDYXJkSXRlbXNGcm9tUHJvcGVydHlMaXN0KHByb3BlcnRpZXM6IFByb3BlcnR5W10sIGN1cnJlbnRQcm9wZXJ0aWVzOiBhbnkpOiBDYXJkVmlld0l0ZW1bXSB7XG4gICAgICAgIHJldHVybiBwcm9wZXJ0aWVzLm1hcCgocHJvcGVydHkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHByb3BlcnR5VmFsdWUgPSBjdXJyZW50UHJvcGVydGllcyA/IGN1cnJlbnRQcm9wZXJ0aWVzW3Byb3BlcnR5LmlkXSA6IG51bGw7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5idWlsZENhcmRJdGVtRnJvbVByb3BlcnR5KHByb3BlcnR5LCBwcm9wZXJ0eVZhbHVlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBidWlsZENhcmRJdGVtRnJvbVByb3BlcnR5KHByb3BlcnR5OiBQcm9wZXJ0eSwgcHJvcGVydHlWYWx1ZTogYW55KTogQ2FyZFZpZXdJdGVtIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvcGVydHlHcm91cFRyYW5zbGF0b3JTZXJ2aWNlLnRyYW5zbGF0ZVByb3BlcnR5KHByb3BlcnR5LCBwcm9wZXJ0eVZhbHVlLCB0cnVlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldENvbnRlbnRUeXBlU3BlY2lmaWNQcm9wZXJ0aWVzKGNvbnRlbnRUeXBlOiBUeXBlRW50cnkpOiBQcm9wZXJ0eVtdIHtcbiAgICAgICAgcmV0dXJuIGNvbnRlbnRUeXBlLmVudHJ5LnByb3BlcnRpZXMuZmlsdGVyKChwcm9wZXJ0eSkgPT4gcHJvcGVydHkuaWQuc3RhcnRzV2l0aChjb250ZW50VHlwZS5lbnRyeS5tb2RlbC5uYW1lc3BhY2VQcmVmaXgpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGJ1aWxkQ29udGVudFR5cGVUZXh0Q2FyZE1vZGVsKGN1cnJlbnRWYWx1ZTogc3RyaW5nKTogQ2FyZFZpZXdUZXh0SXRlbU1vZGVsIHtcbiAgICAgICAgY29uc3QgY29udGVudFR5cGVDYXJkID0gbmV3IENhcmRWaWV3VGV4dEl0ZW1Nb2RlbCh7XG4gICAgICAgICAgICBsYWJlbDogJ0NPUkUuTUVUQURBVEEuQkFTSUMuQ09OVEVOVF9UWVBFJyxcbiAgICAgICAgICAgIHZhbHVlOiBjdXJyZW50VmFsdWUsXG4gICAgICAgICAgICBrZXk6ICdub2RlVHlwZScsXG4gICAgICAgICAgICBlZGl0YWJsZTogZmFsc2VcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGNvbnRlbnRUeXBlQ2FyZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGJ1aWxkQ29udGVudFR5cGVTZWxlY3RDYXJkTW9kZWwoY3VycmVudFZhbHVlOiBzdHJpbmcsIG9wdGlvbnMkOiBPYnNlcnZhYmxlPENhcmRWaWV3U2VsZWN0SXRlbU9wdGlvbjxzdHJpbmc+W10+KTogQ2FyZFZpZXdTZWxlY3RJdGVtTW9kZWw8c3RyaW5nPiB7XG4gICAgICAgIGNvbnN0IGNvbnRlbnRUeXBlQ2FyZCA9IG5ldyBDYXJkVmlld1NlbGVjdEl0ZW1Nb2RlbCh7XG4gICAgICAgICAgICBsYWJlbDogJ0NPUkUuTUVUQURBVEEuQkFTSUMuQ09OVEVOVF9UWVBFJyxcbiAgICAgICAgICAgIHZhbHVlOiBjdXJyZW50VmFsdWUsXG4gICAgICAgICAgICBrZXk6ICdub2RlVHlwZScsXG4gICAgICAgICAgICBlZGl0YWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIG9wdGlvbnMkOiBvcHRpb25zJCxcbiAgICAgICAgICAgIGRpc3BsYXlOb25lT3B0aW9uOiBmYWxzZVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gY29udGVudFR5cGVDYXJkO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Q29udGVudFR5cGVzQXNTZWxlY3RPcHRpb24oY3VycmVudFR5cGU6IFR5cGVFbnRyeSk6IE9ic2VydmFibGU8Q2FyZFZpZXdTZWxlY3RJdGVtT3B0aW9uPHN0cmluZz5bXT4ge1xuICAgICAgICBjb25zdCBjaGlsZHJlblR5cGVzJCA9IHRoaXMuY29udGVudFR5cGVTZXJ2aWNlLmdldENvbnRlbnRUeXBlQ2hpbGRyZW4oY3VycmVudFR5cGUuZW50cnkuaWQpO1xuICAgICAgICByZXR1cm4gemlwKGNoaWxkcmVuVHlwZXMkLCBvZihjdXJyZW50VHlwZSkpLnBpcGUoXG4gICAgICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICAgICAgbWFwKChbY29udGVudFR5cGVzRW50cmllcywgY3VycmVudENvbnRlbnRUeXBlXSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHVwZGF0ZWRUeXBlcyA9IHRoaXMuYXBwZW5kQ3VycmVudFR5cGUoY3VycmVudENvbnRlbnRUeXBlLCBjb250ZW50VHlwZXNFbnRyaWVzKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlZFR5cGVzLm1hcCgoY29udGVudFR5cGUpID0+IDxDYXJkVmlld1NlbGVjdEl0ZW1PcHRpb248c3RyaW5nPj4geyBrZXk6IGNvbnRlbnRUeXBlLmVudHJ5LmlkLCBsYWJlbDogY29udGVudFR5cGUuZW50cnkudGl0bGUgPz8gY29udGVudFR5cGUuZW50cnkuaWQgfSk7XG4gICAgICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhcHBlbmRDdXJyZW50VHlwZShjdXJyZW50VHlwZTogVHlwZUVudHJ5LCBjb250ZW50VHlwZXNFbnRyaWVzOiBUeXBlRW50cnlbXSk6IFR5cGVFbnRyeVtdIHtcbiAgICAgICAgY29uc3QgcmVzdWx0VHlwZXMgPSBbLi4uY29udGVudFR5cGVzRW50cmllc107XG4gICAgICAgIGNvbnN0IGN1cnJlbnRUeXBlUHJlc2VudCA9IGNvbnRlbnRUeXBlc0VudHJpZXMuZmluZCgodHlwZSkgPT4gdHlwZS5lbnRyeS5pZCA9PT0gY3VycmVudFR5cGUuZW50cnkuaWQpO1xuICAgICAgICBpZiAoIWN1cnJlbnRUeXBlUHJlc2VudCkge1xuICAgICAgICAgICAgcmVzdWx0VHlwZXMucHVzaChjdXJyZW50VHlwZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdFR5cGVzO1xuICAgIH1cblxuICAgIG9wZW5Db250ZW50VHlwZURpYWxvZ0NvbmZpcm0obm9kZVR5cGUpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICAgICAgY29uc3Qgc2VsZWN0ID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcbiAgICAgICAgc2VsZWN0LnN1YnNjcmliZSh7XG4gICAgICAgICAgICBjb21wbGV0ZTogdGhpcy5jbG9zZS5iaW5kKHRoaXMpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGRhdGE6IENvbnRlbnRUeXBlRGlhbG9nQ29tcG9uZW50RGF0YSA9IHtcbiAgICAgICAgICAgIHRpdGxlOiAnQ09SRS5NRVRBREFUQS5DT05URU5UX1RZUEUuRElBTE9HLlRJVExFJyxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnQ09SRS5NRVRBREFUQS5DT05URU5UX1RZUEUuRElBTE9HLkRFU0NSSVBUSU9OJyxcbiAgICAgICAgICAgIGNvbmZpcm1NZXNzYWdlOiAnQ09SRS5NRVRBREFUQS5DT05URU5UX1RZUEUuRElBTE9HLkNPTkZJUk0nLFxuICAgICAgICAgICAgc2VsZWN0OiBzZWxlY3QsXG4gICAgICAgICAgICBub2RlVHlwZVxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMub3BlbkRpYWxvZyhkYXRhLCAnYWRmLWNvbnRlbnQtdHlwZS1kaWFsb2cnLCAnNjAwcHgnKTtcbiAgICAgICAgcmV0dXJuIHNlbGVjdDtcbiAgICB9XG5cbiAgICBjbG9zZSgpIHtcbiAgICAgICAgdGhpcy5kaWFsb2cuY2xvc2VBbGwoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9wZW5EaWFsb2coZGF0YTogQ29udGVudFR5cGVEaWFsb2dDb21wb25lbnREYXRhLCBwYW5lbENsYXNzOiBzdHJpbmcsIHdpZHRoOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5kaWFsb2cub3BlbihDb250ZW50VHlwZURpYWxvZ0NvbXBvbmVudCwge1xuICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgIHBhbmVsQ2xhc3MsXG4gICAgICAgICAgICB3aWR0aCxcbiAgICAgICAgICAgIGRpc2FibGVDbG9zZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=