import { Injectable } from '@angular/core';
import { CardViewTextItemModel, CardViewBoolItemModel, CardViewDateItemModel, CardViewSelectItemModel, CardViewDatetimeItemModel, CardViewIntItemModel, CardViewFloatItemModel, LogService, MultiValuePipe, AppConfigService, DecimalNumberPipe } from '@alfresco/adf-core';
import { of } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
const D_TEXT = 'd:text';
const D_MLTEXT = 'd:mltext';
const D_DATE = 'd:date';
const D_DATETIME = 'd:datetime';
const D_INT = 'd:int';
const D_LONG = 'd:long';
const D_FLOAT = 'd:float';
const D_DOUBLE = 'd:double';
const D_BOOLEAN = 'd:boolean';
export class PropertyGroupTranslatorService {
    constructor(logService, multiValuePipe, decimalNumberPipe, appConfig) {
        this.logService = logService;
        this.multiValuePipe = multiValuePipe;
        this.decimalNumberPipe = decimalNumberPipe;
        this.appConfig = appConfig;
        this.valueSeparator = this.appConfig.get('content-metadata.multi-value-pipe-separator');
    }
    translateToCardViewGroups(propertyGroups, propertyValues, definition) {
        return propertyGroups.map((propertyGroup) => {
            const translatedPropertyGroup = Object.assign({}, propertyGroup);
            translatedPropertyGroup.properties = this.translateArray(propertyGroup.properties, propertyValues, definition);
            return translatedPropertyGroup;
        });
    }
    translateProperty(property, startValue, allowEditing = false) {
        this.checkECMTypeValidity(property.dataType);
        const prefix = 'properties.';
        const propertyDefinition = {
            label: property.title || property.id,
            value: startValue ? startValue : property.defaultValue,
            key: `${prefix}${property.id}`,
            default: property.defaultValue,
            editable: property.isProtected ? false : allowEditing,
            constraints: property === null || property === void 0 ? void 0 : property.constraints
        };
        return this.transform(propertyDefinition, property.dataType, property.isMultiValued);
    }
    translateArray(properties, propertyValues, definition) {
        return properties.map((property) => {
            return this.translate(property, propertyValues, this.getPropertyConstraints(property.name, definition));
        });
    }
    translate(property, propertyValues, constraints) {
        let propertyValue;
        if (propertyValues && !this.isEmpty(propertyValues[property.name])) {
            propertyValue = propertyValues[property.name];
        }
        this.checkECMTypeValidity(property.dataType);
        const prefix = 'properties.';
        const propertyDefinition = {
            label: property.title || property.name,
            value: propertyValue,
            key: `${prefix}${property.name}`,
            default: property.defaultValue,
            editable: property.protected ? false : property.editable !== undefined ? property.editable : true,
            constraints: constraints
        };
        return this.transform(propertyDefinition, property.dataType, property.multiValued);
    }
    transform(propertyDefinition, dataType, isMultiValued) {
        let cardViewItemProperty;
        if (this.isListOfValues(propertyDefinition.constraints)) {
            const options = propertyDefinition.constraints[0].parameters.allowedValues.map((value) => ({ key: value, label: value }));
            const properties = Object.assign(propertyDefinition, { options$: of(options) });
            cardViewItemProperty = new CardViewSelectItemModel(properties);
        }
        else {
            switch (dataType) {
                case D_MLTEXT:
                    cardViewItemProperty = new CardViewTextItemModel(Object.assign(propertyDefinition, {
                        multiline: true
                    }));
                    break;
                case D_INT:
                case D_LONG:
                    cardViewItemProperty = new CardViewIntItemModel(Object.assign(propertyDefinition, {
                        multivalued: isMultiValued,
                        pipes: [{ pipe: this.multiValuePipe, params: [this.valueSeparator] }]
                    }));
                    break;
                case D_FLOAT:
                case D_DOUBLE:
                    cardViewItemProperty = new CardViewFloatItemModel(Object.assign(propertyDefinition, {
                        multivalued: isMultiValued,
                        pipes: [
                            { pipe: this.decimalNumberPipe },
                            { pipe: this.multiValuePipe, params: [this.valueSeparator] }
                        ]
                    }));
                    break;
                case D_DATE:
                    cardViewItemProperty = new CardViewDateItemModel(Object.assign(propertyDefinition, {
                        multivalued: isMultiValued,
                        pipes: [{ pipe: this.multiValuePipe, params: [this.valueSeparator] }]
                    }));
                    break;
                case D_DATETIME:
                    cardViewItemProperty = new CardViewDatetimeItemModel(Object.assign(propertyDefinition, {
                        multivalued: isMultiValued,
                        pipes: [{ pipe: this.multiValuePipe, params: [this.valueSeparator] }]
                    }));
                    break;
                case D_BOOLEAN:
                    cardViewItemProperty = new CardViewBoolItemModel(propertyDefinition);
                    break;
                case D_TEXT:
                default:
                    cardViewItemProperty = new CardViewTextItemModel(Object.assign(propertyDefinition, {
                        multivalued: isMultiValued,
                        multiline: isMultiValued,
                        pipes: [{ pipe: this.multiValuePipe, params: [this.valueSeparator] }]
                    }));
            }
        }
        return cardViewItemProperty;
    }
    isListOfValues(constraint) {
        var _a;
        return ((_a = constraint === null || constraint === void 0 ? void 0 : constraint[0]) === null || _a === void 0 ? void 0 : _a.type) === 'LIST';
    }
    getPropertyConstraints(propertyName, definition) {
        var _a, _b;
        return (_b = (_a = definition === null || definition === void 0 ? void 0 : definition.properties.find((item) => item.id === propertyName)) === null || _a === void 0 ? void 0 : _a.constraints) !== null && _b !== void 0 ? _b : [];
    }
    checkECMTypeValidity(ecmPropertyType) {
        if (PropertyGroupTranslatorService.RECOGNISED_ECM_TYPES.indexOf(ecmPropertyType) === -1) {
            this.logService.error(`Unknown type for mapping: ${ecmPropertyType}`);
        }
    }
    isEmpty(value) {
        return value === undefined || value === null || value === '';
    }
}
PropertyGroupTranslatorService.ɵfac = function PropertyGroupTranslatorService_Factory(t) { return new (t || PropertyGroupTranslatorService)(ɵngcc0.ɵɵinject(ɵngcc1.LogService), ɵngcc0.ɵɵinject(ɵngcc1.MultiValuePipe), ɵngcc0.ɵɵinject(ɵngcc1.DecimalNumberPipe), ɵngcc0.ɵɵinject(ɵngcc1.AppConfigService)); };
PropertyGroupTranslatorService.RECOGNISED_ECM_TYPES = [D_TEXT, D_MLTEXT, D_DATE, D_DATETIME, D_INT, D_LONG, D_FLOAT, D_DOUBLE, D_BOOLEAN];
PropertyGroupTranslatorService.ɵprov = i0.ɵɵdefineInjectable({ factory: function PropertyGroupTranslatorService_Factory() { return new PropertyGroupTranslatorService(i0.ɵɵinject(i1.LogService), i0.ɵɵinject(i1.MultiValuePipe), i0.ɵɵinject(i1.DecimalNumberPipe), i0.ɵɵinject(i1.AppConfigService)); }, token: PropertyGroupTranslatorService, providedIn: "root" });
PropertyGroupTranslatorService.ctorParameters = () => [
    { type: LogService },
    { type: MultiValuePipe },
    { type: DecimalNumberPipe },
    { type: AppConfigService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(PropertyGroupTranslatorService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.LogService }, { type: ɵngcc1.MultiValuePipe }, { type: ɵngcc1.DecimalNumberPipe }, { type: ɵngcc1.AppConfigService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvcGVydHktZ3JvdXBzLXRyYW5zbGF0b3Iuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvbnRlbnQtc2VydmljZXMvc3JjL2xpYi9jb250ZW50LW1ldGFkYXRhL3NlcnZpY2VzL3Byb3BlcnR5LWdyb3Vwcy10cmFuc2xhdG9yLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUdILHFCQUFxQixFQUNyQixxQkFBcUIsRUFDckIscUJBQXFCLEVBQ3JCLHVCQUF1QixFQUN2Qix5QkFBeUIsRUFDekIsb0JBQW9CLEVBQ3BCLHNCQUFzQixFQUN0QixVQUFVLEVBQ1YsY0FBYyxFQUNkLGdCQUFnQixFQUNoQixpQkFBaUIsRUFDcEIsTUFBTSxvQkFBb0IsQ0FBQztBQUU1QixPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFCO0FBQXFDOzs7QUFFckMsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDO0FBQ3hCLE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQztBQUM1QixNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUM7QUFDeEIsTUFBTSxVQUFVLEdBQUcsWUFBWSxDQUFDO0FBQ2hDLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQztBQUN0QixNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUM7QUFDeEIsTUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDO0FBQzFCLE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQztBQUM1QixNQUFNLFNBQVMsR0FBRyxXQUFXLENBQUM7QUFLOUIsTUFBTSxPQUFPLDhCQUE4QjtBQUMzQyxJQUtJLFlBQW9CLFVBQXNCLEVBQ3RCLGNBQThCLEVBQzlCLGlCQUFvQyxFQUNw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VEFBQztBQW5KbUIsbURBQW9CLEdBQUcsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBQy9ILHdXQUhLO0FBQUM7RUFITCxVQUFVLFNBQUMsckJBS0csWUF4QlgsVUFBVTthQW9CVixVQUFVLEVBQUUsekJBbkJkLFlBQUUsY0FBYztDQW1CSSxjQUNyQixmQW5CQyxZQUNFLGlCQUFpQjtBQUNsQixZQUZDLGdCQUFnQjtBQUNuQjs7Ozs7O21MQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICAgIENhcmRWaWV3SXRlbVByb3BlcnRpZXMsXG4gICAgQ2FyZFZpZXdJdGVtLFxuICAgIENhcmRWaWV3VGV4dEl0ZW1Nb2RlbCxcbiAgICBDYXJkVmlld0Jvb2xJdGVtTW9kZWwsXG4gICAgQ2FyZFZpZXdEYXRlSXRlbU1vZGVsLFxuICAgIENhcmRWaWV3U2VsZWN0SXRlbU1vZGVsLFxuICAgIENhcmRWaWV3RGF0ZXRpbWVJdGVtTW9kZWwsXG4gICAgQ2FyZFZpZXdJbnRJdGVtTW9kZWwsXG4gICAgQ2FyZFZpZXdGbG9hdEl0ZW1Nb2RlbCxcbiAgICBMb2dTZXJ2aWNlLFxuICAgIE11bHRpVmFsdWVQaXBlLFxuICAgIEFwcENvbmZpZ1NlcnZpY2UsXG4gICAgRGVjaW1hbE51bWJlclBpcGVcbn0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IFByb3BlcnR5LCBDYXJkVmlld0dyb3VwLCBPcmdhbmlzZWRQcm9wZXJ0eUdyb3VwIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9jb250ZW50LW1ldGFkYXRhLmludGVyZmFjZXMnO1xuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IERlZmluaXRpb24sIENvbnN0cmFpbnQsIFByb3BlcnR5IGFzIFByb3BlcnR5QmFzZSB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuXG5jb25zdCBEX1RFWFQgPSAnZDp0ZXh0JztcbmNvbnN0IERfTUxURVhUID0gJ2Q6bWx0ZXh0JztcbmNvbnN0IERfREFURSA9ICdkOmRhdGUnO1xuY29uc3QgRF9EQVRFVElNRSA9ICdkOmRhdGV0aW1lJztcbmNvbnN0IERfSU5UID0gJ2Q6aW50JztcbmNvbnN0IERfTE9ORyA9ICdkOmxvbmcnO1xuY29uc3QgRF9GTE9BVCA9ICdkOmZsb2F0JztcbmNvbnN0IERfRE9VQkxFID0gJ2Q6ZG91YmxlJztcbmNvbnN0IERfQk9PTEVBTiA9ICdkOmJvb2xlYW4nO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFByb3BlcnR5R3JvdXBUcmFuc2xhdG9yU2VydmljZSB7XG5cbiAgICBzdGF0aWMgcmVhZG9ubHkgUkVDT0dOSVNFRF9FQ01fVFlQRVMgPSBbRF9URVhULCBEX01MVEVYVCwgRF9EQVRFLCBEX0RBVEVUSU1FLCBEX0lOVCwgRF9MT05HLCBEX0ZMT0FULCBEX0RPVUJMRSwgRF9CT09MRUFOXTtcblxuICAgIHZhbHVlU2VwYXJhdG9yOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBtdWx0aVZhbHVlUGlwZTogTXVsdGlWYWx1ZVBpcGUsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBkZWNpbWFsTnVtYmVyUGlwZTogRGVjaW1hbE51bWJlclBpcGUsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBhcHBDb25maWc6IEFwcENvbmZpZ1NlcnZpY2UpIHtcbiAgICAgICAgdGhpcy52YWx1ZVNlcGFyYXRvciA9IHRoaXMuYXBwQ29uZmlnLmdldDxzdHJpbmc+KCdjb250ZW50LW1ldGFkYXRhLm11bHRpLXZhbHVlLXBpcGUtc2VwYXJhdG9yJyk7XG4gICAgfVxuXG4gICAgcHVibGljIHRyYW5zbGF0ZVRvQ2FyZFZpZXdHcm91cHMocHJvcGVydHlHcm91cHM6IE9yZ2FuaXNlZFByb3BlcnR5R3JvdXBbXSwgcHJvcGVydHlWYWx1ZXMsIGRlZmluaXRpb246IERlZmluaXRpb24pOiBDYXJkVmlld0dyb3VwW10ge1xuICAgICAgICByZXR1cm4gcHJvcGVydHlHcm91cHMubWFwKChwcm9wZXJ0eUdyb3VwKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0cmFuc2xhdGVkUHJvcGVydHlHcm91cDogYW55ID0gT2JqZWN0LmFzc2lnbih7fSwgcHJvcGVydHlHcm91cCk7XG4gICAgICAgICAgICB0cmFuc2xhdGVkUHJvcGVydHlHcm91cC5wcm9wZXJ0aWVzID0gdGhpcy50cmFuc2xhdGVBcnJheShwcm9wZXJ0eUdyb3VwLnByb3BlcnRpZXMsIHByb3BlcnR5VmFsdWVzLCBkZWZpbml0aW9uKTtcbiAgICAgICAgICAgIHJldHVybiB0cmFuc2xhdGVkUHJvcGVydHlHcm91cDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIHRyYW5zbGF0ZVByb3BlcnR5KHByb3BlcnR5OiBQcm9wZXJ0eUJhc2UsIHN0YXJ0VmFsdWU/OiBhbnksIGFsbG93RWRpdGluZzogYm9vbGVhbiA9IGZhbHNlKTogQ2FyZFZpZXdJdGVtIHtcbiAgICAgICAgdGhpcy5jaGVja0VDTVR5cGVWYWxpZGl0eShwcm9wZXJ0eS5kYXRhVHlwZSk7XG5cbiAgICAgICAgY29uc3QgcHJlZml4ID0gJ3Byb3BlcnRpZXMuJztcblxuICAgICAgICBjb25zdCBwcm9wZXJ0eURlZmluaXRpb246IENhcmRWaWV3SXRlbVByb3BlcnRpZXMgPSB7XG4gICAgICAgICAgICBsYWJlbDogcHJvcGVydHkudGl0bGUgfHwgcHJvcGVydHkuaWQsXG4gICAgICAgICAgICB2YWx1ZTogc3RhcnRWYWx1ZSA/IHN0YXJ0VmFsdWUgOiBwcm9wZXJ0eS5kZWZhdWx0VmFsdWUsXG4gICAgICAgICAgICBrZXk6IGAke3ByZWZpeH0ke3Byb3BlcnR5LmlkfWAsXG4gICAgICAgICAgICBkZWZhdWx0OiBwcm9wZXJ0eS5kZWZhdWx0VmFsdWUsXG4gICAgICAgICAgICBlZGl0YWJsZTogcHJvcGVydHkuaXNQcm90ZWN0ZWQgPyBmYWxzZSA6IGFsbG93RWRpdGluZyxcbiAgICAgICAgICAgIGNvbnN0cmFpbnRzOiBwcm9wZXJ0eT8uY29uc3RyYWludHNcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gdGhpcy50cmFuc2Zvcm0ocHJvcGVydHlEZWZpbml0aW9uLCBwcm9wZXJ0eS5kYXRhVHlwZSwgcHJvcGVydHkuaXNNdWx0aVZhbHVlZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0cmFuc2xhdGVBcnJheShwcm9wZXJ0aWVzOiBQcm9wZXJ0eVtdLCBwcm9wZXJ0eVZhbHVlczogYW55LCBkZWZpbml0aW9uOiBEZWZpbml0aW9uKTogQ2FyZFZpZXdJdGVtW10ge1xuICAgICAgICByZXR1cm4gcHJvcGVydGllcy5tYXAoKHByb3BlcnR5KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy50cmFuc2xhdGUocHJvcGVydHksIHByb3BlcnR5VmFsdWVzLCB0aGlzLmdldFByb3BlcnR5Q29uc3RyYWludHMocHJvcGVydHkubmFtZSwgZGVmaW5pdGlvbikpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHRyYW5zbGF0ZShwcm9wZXJ0eTogUHJvcGVydHksIHByb3BlcnR5VmFsdWVzOiBhbnksIGNvbnN0cmFpbnRzOiBDb25zdHJhaW50W10pOiBDYXJkVmlld0l0ZW0ge1xuICAgICAgICBsZXQgcHJvcGVydHlWYWx1ZTogYW55O1xuICAgICAgICBpZiAocHJvcGVydHlWYWx1ZXMgJiYgIXRoaXMuaXNFbXB0eShwcm9wZXJ0eVZhbHVlc1twcm9wZXJ0eS5uYW1lXSkpIHtcbiAgICAgICAgICAgIHByb3BlcnR5VmFsdWUgPSBwcm9wZXJ0eVZhbHVlc1twcm9wZXJ0eS5uYW1lXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY2hlY2tFQ01UeXBlVmFsaWRpdHkocHJvcGVydHkuZGF0YVR5cGUpO1xuXG4gICAgICAgIGNvbnN0IHByZWZpeCA9ICdwcm9wZXJ0aWVzLic7XG5cbiAgICAgICAgY29uc3QgcHJvcGVydHlEZWZpbml0aW9uOiBDYXJkVmlld0l0ZW1Qcm9wZXJ0aWVzID0ge1xuICAgICAgICAgICAgbGFiZWw6IHByb3BlcnR5LnRpdGxlIHx8IHByb3BlcnR5Lm5hbWUsXG4gICAgICAgICAgICB2YWx1ZTogcHJvcGVydHlWYWx1ZSxcbiAgICAgICAgICAgIGtleTogYCR7cHJlZml4fSR7cHJvcGVydHkubmFtZX1gLFxuICAgICAgICAgICAgZGVmYXVsdDogcHJvcGVydHkuZGVmYXVsdFZhbHVlLFxuICAgICAgICAgICAgZWRpdGFibGU6IHByb3BlcnR5LnByb3RlY3RlZCA/IGZhbHNlIDogcHJvcGVydHkuZWRpdGFibGUgIT09IHVuZGVmaW5lZCA/IHByb3BlcnR5LmVkaXRhYmxlIDogdHJ1ZSxcbiAgICAgICAgICAgIGNvbnN0cmFpbnRzOiBjb25zdHJhaW50c1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zZm9ybShwcm9wZXJ0eURlZmluaXRpb24sIHByb3BlcnR5LmRhdGFUeXBlLCBwcm9wZXJ0eS5tdWx0aVZhbHVlZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0cmFuc2Zvcm0ocHJvcGVydHlEZWZpbml0aW9uOiBDYXJkVmlld0l0ZW1Qcm9wZXJ0aWVzLCBkYXRhVHlwZTogc3RyaW5nLCBpc011bHRpVmFsdWVkOiBib29sZWFuKTogQ2FyZFZpZXdJdGVtIHtcbiAgICAgICAgbGV0IGNhcmRWaWV3SXRlbVByb3BlcnR5OiBDYXJkVmlld0l0ZW07XG5cbiAgICAgICAgaWYgKHRoaXMuaXNMaXN0T2ZWYWx1ZXMocHJvcGVydHlEZWZpbml0aW9uLmNvbnN0cmFpbnRzKSkge1xuICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHByb3BlcnR5RGVmaW5pdGlvbi5jb25zdHJhaW50c1swXS5wYXJhbWV0ZXJzLmFsbG93ZWRWYWx1ZXMubWFwKCh2YWx1ZSkgPT4gKHsga2V5OiB2YWx1ZSwgbGFiZWw6IHZhbHVlIH0pKTtcbiAgICAgICAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSBPYmplY3QuYXNzaWduKHByb3BlcnR5RGVmaW5pdGlvbiwgeyBvcHRpb25zJDogb2Yob3B0aW9ucykgfSk7XG5cbiAgICAgICAgICAgIGNhcmRWaWV3SXRlbVByb3BlcnR5ID0gbmV3IENhcmRWaWV3U2VsZWN0SXRlbU1vZGVsKHByb3BlcnRpZXMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3dpdGNoIChkYXRhVHlwZSkge1xuICAgICAgICAgICAgICAgIGNhc2UgRF9NTFRFWFQ6XG4gICAgICAgICAgICAgICAgICAgIGNhcmRWaWV3SXRlbVByb3BlcnR5ID0gbmV3IENhcmRWaWV3VGV4dEl0ZW1Nb2RlbChPYmplY3QuYXNzaWduKHByb3BlcnR5RGVmaW5pdGlvbiwge1xuICAgICAgICAgICAgICAgICAgICAgICAgbXVsdGlsaW5lOiB0cnVlXG4gICAgICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICBjYXNlIERfSU5UOlxuICAgICAgICAgICAgICAgIGNhc2UgRF9MT05HOlxuICAgICAgICAgICAgICAgICAgICBjYXJkVmlld0l0ZW1Qcm9wZXJ0eSA9IG5ldyBDYXJkVmlld0ludEl0ZW1Nb2RlbChPYmplY3QuYXNzaWduKHByb3BlcnR5RGVmaW5pdGlvbiwge1xuICAgICAgICAgICAgICAgICAgICAgICAgbXVsdGl2YWx1ZWQ6IGlzTXVsdGlWYWx1ZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBwaXBlczogW3sgcGlwZTogdGhpcy5tdWx0aVZhbHVlUGlwZSwgcGFyYW1zOiBbdGhpcy52YWx1ZVNlcGFyYXRvcl0gfV1cbiAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgIGNhc2UgRF9GTE9BVDpcbiAgICAgICAgICAgICAgICBjYXNlIERfRE9VQkxFOlxuICAgICAgICAgICAgICAgICAgICBjYXJkVmlld0l0ZW1Qcm9wZXJ0eSA9IG5ldyBDYXJkVmlld0Zsb2F0SXRlbU1vZGVsKE9iamVjdC5hc3NpZ24ocHJvcGVydHlEZWZpbml0aW9uLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtdWx0aXZhbHVlZDogaXNNdWx0aVZhbHVlZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpcGVzOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBwaXBlOiB0aGlzLmRlY2ltYWxOdW1iZXJQaXBlIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBwaXBlOiB0aGlzLm11bHRpVmFsdWVQaXBlLCBwYXJhbXM6IFt0aGlzLnZhbHVlU2VwYXJhdG9yXSB9XG4gICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICBjYXNlIERfREFURTpcbiAgICAgICAgICAgICAgICAgICAgY2FyZFZpZXdJdGVtUHJvcGVydHkgPSBuZXcgQ2FyZFZpZXdEYXRlSXRlbU1vZGVsKE9iamVjdC5hc3NpZ24ocHJvcGVydHlEZWZpbml0aW9uLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtdWx0aXZhbHVlZDogaXNNdWx0aVZhbHVlZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpcGVzOiBbeyBwaXBlOiB0aGlzLm11bHRpVmFsdWVQaXBlLCBwYXJhbXM6IFt0aGlzLnZhbHVlU2VwYXJhdG9yXSB9XVxuICAgICAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgY2FzZSBEX0RBVEVUSU1FOlxuICAgICAgICAgICAgICAgICAgICBjYXJkVmlld0l0ZW1Qcm9wZXJ0eSA9IG5ldyBDYXJkVmlld0RhdGV0aW1lSXRlbU1vZGVsKE9iamVjdC5hc3NpZ24ocHJvcGVydHlEZWZpbml0aW9uLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtdWx0aXZhbHVlZDogaXNNdWx0aVZhbHVlZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpcGVzOiBbeyBwaXBlOiB0aGlzLm11bHRpVmFsdWVQaXBlLCBwYXJhbXM6IFt0aGlzLnZhbHVlU2VwYXJhdG9yXSB9XVxuICAgICAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgY2FzZSBEX0JPT0xFQU46XG4gICAgICAgICAgICAgICAgICAgIGNhcmRWaWV3SXRlbVByb3BlcnR5ID0gbmV3IENhcmRWaWV3Qm9vbEl0ZW1Nb2RlbChwcm9wZXJ0eURlZmluaXRpb24pO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgIGNhc2UgRF9URVhUOlxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIGNhcmRWaWV3SXRlbVByb3BlcnR5ID0gbmV3IENhcmRWaWV3VGV4dEl0ZW1Nb2RlbChPYmplY3QuYXNzaWduKHByb3BlcnR5RGVmaW5pdGlvbiwge1xuICAgICAgICAgICAgICAgICAgICAgICAgbXVsdGl2YWx1ZWQ6IGlzTXVsdGlWYWx1ZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBtdWx0aWxpbmU6IGlzTXVsdGlWYWx1ZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBwaXBlczogW3sgcGlwZTogdGhpcy5tdWx0aVZhbHVlUGlwZSwgcGFyYW1zOiBbdGhpcy52YWx1ZVNlcGFyYXRvcl0gfV1cbiAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNhcmRWaWV3SXRlbVByb3BlcnR5O1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNMaXN0T2ZWYWx1ZXMoY29uc3RyYWludDogQ29uc3RyYWludFtdKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBjb25zdHJhaW50Py5bMF0/LnR5cGUgPT09ICdMSVNUJztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFByb3BlcnR5Q29uc3RyYWludHMocHJvcGVydHlOYW1lOiBzdHJpbmcsIGRlZmluaXRpb246IERlZmluaXRpb24pOiBDb25zdHJhaW50W10ge1xuICAgICAgICByZXR1cm4gZGVmaW5pdGlvbj8ucHJvcGVydGllcy5maW5kKChpdGVtKSA9PiBpdGVtLmlkID09PSBwcm9wZXJ0eU5hbWUpPy5jb25zdHJhaW50cyA/PyBbXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNoZWNrRUNNVHlwZVZhbGlkaXR5KGVjbVByb3BlcnR5VHlwZTogc3RyaW5nKSB7XG4gICAgICAgIGlmIChQcm9wZXJ0eUdyb3VwVHJhbnNsYXRvclNlcnZpY2UuUkVDT0dOSVNFRF9FQ01fVFlQRVMuaW5kZXhPZihlY21Qcm9wZXJ0eVR5cGUpID09PSAtMSkge1xuICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGBVbmtub3duIHR5cGUgZm9yIG1hcHBpbmc6ICR7ZWNtUHJvcGVydHlUeXBlfWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc0VtcHR5KHZhbHVlOiBhbnkpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09ICcnO1xuICAgIH1cbn1cbiJdfQ==