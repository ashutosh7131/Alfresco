import { Injectable } from '@angular/core';
import { MatDialog } from '@angular/material/dialog';
import { CardViewSelectItemModel, CardViewTextItemModel, VersionCompatibilityService } from '@alfresco/adf-core';
import { of, Subject, zip } from 'rxjs';
import { distinctUntilChanged, map } from 'rxjs/operators';
import { ContentTypeDialogComponent } from '../../content-type/content-type-dialog.component';
import { ContentTypeService } from '../../content-type/content-type.service';
import { PropertyGroupTranslatorService } from './property-groups-translator.service';
import * as i0 from "@angular/core";
import * as i1 from "../../content-type/content-type.service";
import * as i2 from "@angular/material/dialog";
import * as i3 from "@alfresco/adf-core";
import * as i4 from "./property-groups-translator.service";
export class ContentTypePropertiesService {
    constructor(contentTypeService, dialog, versionCompatibilityService, propertyGroupTranslatorService) {
        this.contentTypeService = contentTypeService;
        this.dialog = dialog;
        this.versionCompatibilityService = versionCompatibilityService;
        this.propertyGroupTranslatorService = propertyGroupTranslatorService;
    }
    getContentTypeCardItem(node) {
        if (this.versionCompatibilityService.isVersionSupported('7')) {
            return this.contentTypeService.getContentTypeByPrefix(node.nodeType).
                pipe(map((contentType) => {
                const contentTypesOptions$ = this.getContentTypesAsSelectOption(contentType);
                const contentTypeCard = this.buildContentTypeSelectCardModel(contentType.entry.id, contentTypesOptions$);
                const filteredProperties = this.getContentTypeSpecificProperties(contentType);
                const propertiesCard = this.buildCardItemsFromPropertyList(filteredProperties, node.properties);
                return [contentTypeCard, ...propertiesCard];
            }));
        }
        else {
            return of([this.buildContentTypeTextCardModel(node.nodeType)]);
        }
    }
    buildCardItemsFromPropertyList(properties, currentProperties) {
        return properties.map((property) => {
            const propertyValue = currentProperties ? currentProperties[property.id] : null;
            return this.buildCardItemFromProperty(property, propertyValue);
        });
    }
    buildCardItemFromProperty(property, propertyValue) {
        return this.propertyGroupTranslatorService.translateProperty(property, propertyValue, true);
    }
    getContentTypeSpecificProperties(contentType) {
        return contentType.entry.properties.filter((property) => property.id.startsWith(contentType.entry.model.namespacePrefix));
    }
    buildContentTypeTextCardModel(currentValue) {
        const contentTypeCard = new CardViewTextItemModel({
            label: 'CORE.METADATA.BASIC.CONTENT_TYPE',
            value: currentValue,
            key: 'nodeType',
            editable: false
        });
        return contentTypeCard;
    }
    buildContentTypeSelectCardModel(currentValue, options$) {
        const contentTypeCard = new CardViewSelectItemModel({
            label: 'CORE.METADATA.BASIC.CONTENT_TYPE',
            value: currentValue,
            key: 'nodeType',
            editable: true,
            options$: options$,
            displayNoneOption: false
        });
        return contentTypeCard;
    }
    getContentTypesAsSelectOption(currentType) {
        const childrenTypes$ = this.contentTypeService.getContentTypeChildren(currentType.entry.id);
        return zip(childrenTypes$, of(currentType)).pipe(distinctUntilChanged(), map(([contentTypesEntries, currentContentType]) => {
            const updatedTypes = this.appendCurrentType(currentContentType, contentTypesEntries);
            return updatedTypes.map((contentType) => { var _a; return ({ key: contentType.entry.id, label: (_a = contentType.entry.title) !== null && _a !== void 0 ? _a : contentType.entry.id }); });
        }));
    }
    appendCurrentType(currentType, contentTypesEntries) {
        const resultTypes = [...contentTypesEntries];
        const currentTypePresent = contentTypesEntries.find((type) => type.entry.id === currentType.entry.id);
        if (!currentTypePresent) {
            resultTypes.push(currentType);
        }
        return resultTypes;
    }
    openContentTypeDialogConfirm(nodeType) {
        const select = new Subject();
        select.subscribe({
            complete: this.close.bind(this)
        });
        const data = {
            title: 'CORE.METADATA.CONTENT_TYPE.DIALOG.TITLE',
            description: 'CORE.METADATA.CONTENT_TYPE.DIALOG.DESCRIPTION',
            confirmMessage: 'CORE.METADATA.CONTENT_TYPE.DIALOG.CONFIRM',
            select: select,
            nodeType
        };
        this.openDialog(data, 'adf-content-type-dialog', '600px');
        return select;
    }
    close() {
        this.dialog.closeAll();
    }
    openDialog(data, panelClass, width) {
        this.dialog.open(ContentTypeDialogComponent, {
            data,
            panelClass,
            width,
            disableClose: true
        });
    }
}
ContentTypePropertiesService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ContentTypePropertiesService_Factory() { return new ContentTypePropertiesService(i0.ɵɵinject(i1.ContentTypeService), i0.ɵɵinject(i2.MatDialog), i0.ɵɵinject(i3.VersionCompatibilityService), i0.ɵɵinject(i4.PropertyGroupTranslatorService)); }, token: ContentTypePropertiesService, providedIn: "root" });
ContentTypePropertiesService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
ContentTypePropertiesService.ctorParameters = () => [
    { type: ContentTypeService },
    { type: MatDialog },
    { type: VersionCompatibilityService },
    { type: PropertyGroupTranslatorService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC10eXBlLXByb3BlcnR5LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb250ZW50LXNlcnZpY2VzL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9jb250ZW50LW1ldGFkYXRhL3NlcnZpY2VzL2NvbnRlbnQtdHlwZS1wcm9wZXJ0eS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNyRCxPQUFPLEVBQWdCLHVCQUF1QixFQUE0QixxQkFBcUIsRUFBRSwyQkFBMkIsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3pKLE9BQU8sRUFBYyxFQUFFLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0QsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sa0RBQWtELENBQUM7QUFFOUYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFFN0UsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sc0NBQXNDLENBQUM7Ozs7OztBQUt0RixNQUFNLE9BQU8sNEJBQTRCO0lBRXJDLFlBQW9CLGtCQUFzQyxFQUN0QyxNQUFpQixFQUNqQiwyQkFBd0QsRUFDeEQsOEJBQThEO1FBSDlELHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQUNqQixnQ0FBMkIsR0FBM0IsMkJBQTJCLENBQTZCO1FBQ3hELG1DQUE4QixHQUE5Qiw4QkFBOEIsQ0FBZ0M7SUFDbEYsQ0FBQztJQUVELHNCQUFzQixDQUFDLElBQVU7UUFDN0Is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QyxJQUFJLENBQUM7U0FDbEMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxJQUFJLEdBQW1DO1lBQ3pDLEtBQUssRUFBRSx5Q0FBeUM7WUFDaEQsV0FBVyxFQUFFLCtDQUErQztZQUM1RCxjQUFjLEVBQUUsMkNBQTJDO1lBQzNELE1BQU0sRUFBRSxNQUFNO1lBQ2QsUUFBUTtTQUNYLENBQUM7UUFFRixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSx5QkFBeUIsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUMxRCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBRUQsS0FBSztRQUNELElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUVPLFVBQVUsQ0FBQyxJQUFvQyxFQUFFLFVBQWtCLEVBQUUsS0FBYTtRQUN0RixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQywwQkFBMEIsRUFBRTtZQUN6QyxJQUFJO1lBQ0osVUFBVTtZQUNWLEtBQUs7WUFDTCxZQUFZLEVBQUUsSUFBSTtTQUNyQixDQUFDLENBQUM7SUFDUCxDQUFDOzs7O1lBbEhKLFVBQVUsU0FBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQjs7O1lBTlEsa0JBQWtCO1lBTmxCLFNBQVM7WUFDK0UsMkJBQTJCO1lBT25ILDhCQUE4QiIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE1hdERpYWxvZyB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2RpYWxvZyc7XG5pbXBvcnQgeyBDYXJkVmlld0l0ZW0sIENhcmRWaWV3U2VsZWN0SXRlbU1vZGVsLCBDYXJkVmlld1NlbGVjdEl0ZW1PcHRpb24sIENhcmRWaWV3VGV4dEl0ZW1Nb2RlbCwgVmVyc2lvbkNvbXBhdGliaWxpdHlTZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBTdWJqZWN0LCB6aXAgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDb250ZW50VHlwZURpYWxvZ0NvbXBvbmVudCB9IGZyb20gJy4uLy4uL2NvbnRlbnQtdHlwZS9jb250ZW50LXR5cGUtZGlhbG9nLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBDb250ZW50VHlwZURpYWxvZ0NvbXBvbmVudERhdGEgfSBmcm9tICcuLi8uLi9jb250ZW50LXR5cGUvY29udGVudC10eXBlLW1ldGFkYXRhLmludGVyZmFjZSc7XG5pbXBvcnQgeyBDb250ZW50VHlwZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9jb250ZW50LXR5cGUvY29udGVudC10eXBlLnNlcnZpY2UnO1xuaW1wb3J0IHsgTm9kZSwgUHJvcGVydHksIFR5cGVFbnRyeSB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgUHJvcGVydHlHcm91cFRyYW5zbGF0b3JTZXJ2aWNlIH0gZnJvbSAnLi9wcm9wZXJ0eS1ncm91cHMtdHJhbnNsYXRvci5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBDb250ZW50VHlwZVByb3BlcnRpZXNTZXJ2aWNlIHtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgY29udGVudFR5cGVTZXJ2aWNlOiBDb250ZW50VHlwZVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBkaWFsb2c6IE1hdERpYWxvZyxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHZlcnNpb25Db21wYXRpYmlsaXR5U2VydmljZTogVmVyc2lvbkNvbXBhdGliaWxpdHlTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgcHJvcGVydHlHcm91cFRyYW5zbGF0b3JTZXJ2aWNlOiBQcm9wZXJ0eUdyb3VwVHJhbnNsYXRvclNlcnZpY2UpIHtcbiAgICB9XG5cbiAgICBnZXRDb250ZW50VHlwZUNhcmRJdGVtKG5vZGU6IE5vZGUpOiBPYnNlcnZhYmxlPENhcmRWaWV3SXRlbVtdPiB7XG4gICAgICAgIGlmICh0aGlzLnZlcnNpb25Db21wYXRpYmlsaXR5U2VydmljZS5pc1ZlcnNpb25TdXBwb3J0ZWQoJzcnKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29udGVudFR5cGVTZXJ2aWNlLmdldENvbnRlbnRUeXBlQnlQcmVmaXgobm9kZS5ub2RlVHlwZSkuXG4gICAgICAgICAgICAgICAgcGlwZShcbiAgICAgICAgICAgICAgICAgICAgbWFwKChjb250ZW50VHlwZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udGVudFR5cGVzT3B0aW9ucyQgPSB0aGlzLmdldENvbnRlbnRUeXBlc0FzU2VsZWN0T3B0aW9uKGNvbnRlbnRUeXBlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnRUeXBlQ2FyZCA9IHRoaXMuYnVpbGRDb250ZW50VHlwZVNlbGVjdENhcmRNb2RlbChjb250ZW50VHlwZS5lbnRyeS5pZCwgY29udGVudFR5cGVzT3B0aW9ucyQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyZWRQcm9wZXJ0aWVzID0gIHRoaXMuZ2V0Q29udGVudFR5cGVTcGVjaWZpY1Byb3BlcnRpZXMoY29udGVudFR5cGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvcGVydGllc0NhcmQgPSB0aGlzLmJ1aWxkQ2FyZEl0ZW1zRnJvbVByb3BlcnR5TGlzdChmaWx0ZXJlZFByb3BlcnRpZXMsIG5vZGUucHJvcGVydGllcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gW2NvbnRlbnRUeXBlQ2FyZCwgLi4ucHJvcGVydGllc0NhcmRdO1xuICAgICAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gb2YoW3RoaXMuYnVpbGRDb250ZW50VHlwZVRleHRDYXJkTW9kZWwobm9kZS5ub2RlVHlwZSldKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGJ1aWxkQ2FyZEl0ZW1zRnJvbVByb3BlcnR5TGlzdChwcm9wZXJ0aWVzOiBQcm9wZXJ0eVtdLCBjdXJyZW50UHJvcGVydGllczogYW55KTogQ2FyZFZpZXdJdGVtW10ge1xuICAgICAgICByZXR1cm4gcHJvcGVydGllcy5tYXAoKHByb3BlcnR5KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwcm9wZXJ0eVZhbHVlID0gY3VycmVudFByb3BlcnRpZXMgPyBjdXJyZW50UHJvcGVydGllc1twcm9wZXJ0eS5pZF0gOiBudWxsO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRDYXJkSXRlbUZyb21Qcm9wZXJ0eShwcm9wZXJ0eSwgcHJvcGVydHlWYWx1ZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgYnVpbGRDYXJkSXRlbUZyb21Qcm9wZXJ0eShwcm9wZXJ0eTogUHJvcGVydHksIHByb3BlcnR5VmFsdWU6IGFueSk6IENhcmRWaWV3SXRlbSB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3BlcnR5R3JvdXBUcmFuc2xhdG9yU2VydmljZS50cmFuc2xhdGVQcm9wZXJ0eShwcm9wZXJ0eSwgcHJvcGVydHlWYWx1ZSwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDb250ZW50VHlwZVNwZWNpZmljUHJvcGVydGllcyhjb250ZW50VHlwZTogVHlwZUVudHJ5KTogUHJvcGVydHlbXSB7XG4gICAgICAgIHJldHVybiBjb250ZW50VHlwZS5lbnRyeS5wcm9wZXJ0aWVzLmZpbHRlcigocHJvcGVydHkpID0+IHByb3BlcnR5LmlkLnN0YXJ0c1dpdGgoY29udGVudFR5cGUuZW50cnkubW9kZWwubmFtZXNwYWNlUHJlZml4KSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBidWlsZENvbnRlbnRUeXBlVGV4dENhcmRNb2RlbChjdXJyZW50VmFsdWU6IHN0cmluZyk6IENhcmRWaWV3VGV4dEl0ZW1Nb2RlbCB7XG4gICAgICAgIGNvbnN0IGNvbnRlbnRUeXBlQ2FyZCA9IG5ldyBDYXJkVmlld1RleHRJdGVtTW9kZWwoe1xuICAgICAgICAgICAgbGFiZWw6ICdDT1JFLk1FVEFEQVRBLkJBU0lDLkNPTlRFTlRfVFlQRScsXG4gICAgICAgICAgICB2YWx1ZTogY3VycmVudFZhbHVlLFxuICAgICAgICAgICAga2V5OiAnbm9kZVR5cGUnLFxuICAgICAgICAgICAgZWRpdGFibGU6IGZhbHNlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBjb250ZW50VHlwZUNhcmQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBidWlsZENvbnRlbnRUeXBlU2VsZWN0Q2FyZE1vZGVsKGN1cnJlbnRWYWx1ZTogc3RyaW5nLCBvcHRpb25zJDogT2JzZXJ2YWJsZTxDYXJkVmlld1NlbGVjdEl0ZW1PcHRpb248c3RyaW5nPltdPik6IENhcmRWaWV3U2VsZWN0SXRlbU1vZGVsPHN0cmluZz4ge1xuICAgICAgICBjb25zdCBjb250ZW50VHlwZUNhcmQgPSBuZXcgQ2FyZFZpZXdTZWxlY3RJdGVtTW9kZWwoe1xuICAgICAgICAgICAgbGFiZWw6ICdDT1JFLk1FVEFEQVRBLkJBU0lDLkNPTlRFTlRfVFlQRScsXG4gICAgICAgICAgICB2YWx1ZTogY3VycmVudFZhbHVlLFxuICAgICAgICAgICAga2V5OiAnbm9kZVR5cGUnLFxuICAgICAgICAgICAgZWRpdGFibGU6IHRydWUsXG4gICAgICAgICAgICBvcHRpb25zJDogb3B0aW9ucyQsXG4gICAgICAgICAgICBkaXNwbGF5Tm9uZU9wdGlvbjogZmFsc2VcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGNvbnRlbnRUeXBlQ2FyZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldENvbnRlbnRUeXBlc0FzU2VsZWN0T3B0aW9uKGN1cnJlbnRUeXBlOiBUeXBlRW50cnkpOiBPYnNlcnZhYmxlPENhcmRWaWV3U2VsZWN0SXRlbU9wdGlvbjxzdHJpbmc+W10+IHtcbiAgICAgICAgY29uc3QgY2hpbGRyZW5UeXBlcyQgPSB0aGlzLmNvbnRlbnRUeXBlU2VydmljZS5nZXRDb250ZW50VHlwZUNoaWxkcmVuKGN1cnJlbnRUeXBlLmVudHJ5LmlkKTtcbiAgICAgICAgcmV0dXJuIHppcChjaGlsZHJlblR5cGVzJCwgb2YoY3VycmVudFR5cGUpKS5waXBlKFxuICAgICAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgICAgICAgIG1hcCgoW2NvbnRlbnRUeXBlc0VudHJpZXMsIGN1cnJlbnRDb250ZW50VHlwZV0pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB1cGRhdGVkVHlwZXMgPSB0aGlzLmFwcGVuZEN1cnJlbnRUeXBlKGN1cnJlbnRDb250ZW50VHlwZSwgY29udGVudFR5cGVzRW50cmllcyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWRUeXBlcy5tYXAoKGNvbnRlbnRUeXBlKSA9PiA8Q2FyZFZpZXdTZWxlY3RJdGVtT3B0aW9uPHN0cmluZz4+IHsga2V5OiBjb250ZW50VHlwZS5lbnRyeS5pZCwgbGFiZWw6IGNvbnRlbnRUeXBlLmVudHJ5LnRpdGxlID8/IGNvbnRlbnRUeXBlLmVudHJ5LmlkIH0pO1xuICAgICAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXBwZW5kQ3VycmVudFR5cGUoY3VycmVudFR5cGU6IFR5cGVFbnRyeSwgY29udGVudFR5cGVzRW50cmllczogVHlwZUVudHJ5W10pOiBUeXBlRW50cnlbXSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdFR5cGVzID0gWy4uLmNvbnRlbnRUeXBlc0VudHJpZXNdO1xuICAgICAgICBjb25zdCBjdXJyZW50VHlwZVByZXNlbnQgPSBjb250ZW50VHlwZXNFbnRyaWVzLmZpbmQoKHR5cGUpID0+IHR5cGUuZW50cnkuaWQgPT09IGN1cnJlbnRUeXBlLmVudHJ5LmlkKTtcbiAgICAgICAgaWYgKCFjdXJyZW50VHlwZVByZXNlbnQpIHtcbiAgICAgICAgICAgIHJlc3VsdFR5cGVzLnB1c2goY3VycmVudFR5cGUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHRUeXBlcztcbiAgICB9XG5cbiAgICBvcGVuQ29udGVudFR5cGVEaWFsb2dDb25maXJtKG5vZGVUeXBlKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgICAgIGNvbnN0IHNlbGVjdCA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XG4gICAgICAgIHNlbGVjdC5zdWJzY3JpYmUoe1xuICAgICAgICAgICAgY29tcGxldGU6IHRoaXMuY2xvc2UuYmluZCh0aGlzKVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBkYXRhOiBDb250ZW50VHlwZURpYWxvZ0NvbXBvbmVudERhdGEgPSB7XG4gICAgICAgICAgICB0aXRsZTogJ0NPUkUuTUVUQURBVEEuQ09OVEVOVF9UWVBFLkRJQUxPRy5USVRMRScsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0NPUkUuTUVUQURBVEEuQ09OVEVOVF9UWVBFLkRJQUxPRy5ERVNDUklQVElPTicsXG4gICAgICAgICAgICBjb25maXJtTWVzc2FnZTogJ0NPUkUuTUVUQURBVEEuQ09OVEVOVF9UWVBFLkRJQUxPRy5DT05GSVJNJyxcbiAgICAgICAgICAgIHNlbGVjdDogc2VsZWN0LFxuICAgICAgICAgICAgbm9kZVR5cGVcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLm9wZW5EaWFsb2coZGF0YSwgJ2FkZi1jb250ZW50LXR5cGUtZGlhbG9nJywgJzYwMHB4Jyk7XG4gICAgICAgIHJldHVybiBzZWxlY3Q7XG4gICAgfVxuXG4gICAgY2xvc2UoKSB7XG4gICAgICAgIHRoaXMuZGlhbG9nLmNsb3NlQWxsKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvcGVuRGlhbG9nKGRhdGE6IENvbnRlbnRUeXBlRGlhbG9nQ29tcG9uZW50RGF0YSwgcGFuZWxDbGFzczogc3RyaW5nLCB3aWR0aDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuZGlhbG9nLm9wZW4oQ29udGVudFR5cGVEaWFsb2dDb21wb25lbnQsIHtcbiAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICBwYW5lbENsYXNzLFxuICAgICAgICAgICAgd2lkdGgsXG4gICAgICAgICAgICBkaXNhYmxlQ2xvc2U6IHRydWVcbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19