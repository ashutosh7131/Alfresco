/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { getProperty } from './property-group-reader';
export class LayoutOrientedConfigService {
    constructor(config) {
        this.config = config;
    }
    isGroupAllowed(groupName) {
        if (this.isIncludeAllEnabled()) {
            return true;
        }
        return this.getMatchingGroups(groupName).length > 0;
    }
    reorganiseByConfig(propertyGroups) {
        const layoutBlocks = this.config.filter((itemsGroup) => itemsGroup.items);
        const organisedPropertyGroup = layoutBlocks.map((layoutBlock) => {
            const flattenedItems = this.flattenItems(layoutBlock.items), properties = flattenedItems.reduce((props, explodedItem) => {
                const isProperty = typeof explodedItem.property === 'object';
                const propertyName = isProperty ? explodedItem.property.name : explodedItem.property;
                let property = getProperty(propertyGroups, explodedItem.groupName, propertyName) || [];
                if (isProperty) {
                    property = this.setPropertyTitle(property, explodedItem.property);
                }
                property = this.setEditableProperty(property, explodedItem);
                return props.concat(property);
            }, []);
            return {
                title: layoutBlock.title,
                properties
            };
        });
        return organisedPropertyGroup;
    }
    appendAllPreset(propertyGroups) {
        return Object.keys(propertyGroups)
            .map((groupName) => {
            const propertyGroup = propertyGroups[groupName], properties = propertyGroup.properties;
            return Object.assign({}, propertyGroup, {
                properties: Object.keys(properties).map((propertyName) => properties[propertyName])
            });
        });
    }
    filterExcludedPreset(propertyGroups) {
        let excludedConfig = this.config
            .map((config) => config.exclude)
            .find((exclude) => exclude !== undefined);
        if (excludedConfig === undefined) {
            excludedConfig = [];
        }
        else if (typeof excludedConfig === 'string') {
            excludedConfig = [excludedConfig];
        }
        return propertyGroups.filter((props) => {
            return !excludedConfig.includes(props.name);
        });
    }
    isIncludeAllEnabled() {
        const includeAllProperty = this.config
            .map((config) => config.includeAll)
            .find((includeAll) => includeAll !== undefined);
        return includeAllProperty !== undefined ? includeAllProperty : false;
    }
    setEditableProperty(propertyGroup, itemConfig) {
        if (Array.isArray(propertyGroup)) {
            propertyGroup.map((property) => property.editable = itemConfig.editable !== undefined ? itemConfig.editable : true);
        }
        else {
            propertyGroup.editable = itemConfig.editable !== undefined ? itemConfig.editable : true;
        }
        return propertyGroup;
    }
    setPropertyTitle(item, property) {
        if (!Array.isArray(item)) {
            return Object.assign(Object.assign({}, item), (item.name === property.name && !!property.title) && { title: property.title });
        }
        return item;
    }
    flattenItems(items) {
        return items.reduce((accumulator, item) => {
            const properties = Array.isArray(item.properties) ? item.properties : [item.properties];
            const flattenedProperties = properties.map((property) => {
                return {
                    groupName: item.aspect || item.type,
                    property,
                    editable: item.editable
                };
            });
            return accumulator.concat(flattenedProperties);
        }, []);
    }
    getMatchingGroups(groupName) {
        return this.config
            .map((layoutBlock) => layoutBlock.items)
            .reduce((accumulator, items) => accumulator.concat(items), [])
            .filter((item) => item.aspect === groupName || item.type === groupName);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF5b3V0LW9yaWVudGVkLWNvbmZpZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvY29udGVudC1zZXJ2aWNlcy9zcmMvIiwic291cmNlcyI6WyJsaWIvY29udGVudC1tZXRhZGF0YS9zZXJ2aWNlcy9jb25maWcvbGF5b3V0LW9yaWVudGVkLWNvbmZpZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7R0FlRztBQVNILE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUV0RCxNQUFNLE9BQU8sMkJBQTJCO0lBRXBDLFlBQW9CLE1BQVc7UUFBWCxXQUFNLEdBQU4sTUFBTSxDQUFLO0lBQUksQ0FBQztJQUU3QixjQUFjLENBQUMsU0FBaUI7UUFDbkMsSUFBSSxJQUFJLENBQUMsbUJBQW1CLEVBQUUsRUFBRTtZQUM1QixPQUFPLElBQUksQ0FBQztTQUNmO1FBQ0QsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBRU0sa0JBQWtCLENBQUMsY0FBc0M7UUFDNUQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUUxRSxNQUFNLHNCQUFzQixHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRTtZQUM1RCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFDdkQsVUFBVSxHQUFHLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsWUFBWSxFQUFFLEVBQUU7Z0JBQ3ZELE1BQU0sVUFBVSxHQUFHLE9B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UTtvQkFDUixRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7aUJBQzFCLENBQUM7WUFDTixDQUFDLENBQUMsQ0FBQztZQUVILE9BQU8sV0FBVyxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ25ELENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNYLENBQUM7SUFFTyxpQkFBaUIsQ0FBQyxTQUFpQjtRQUN2QyxPQUFPLElBQUksQ0FBQyxNQUFNO2FBQ2IsR0FBRyxDQUFDLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDO2FBQ3ZDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDO2FBQzdELE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxTQUFTLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQztJQUNoRixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1xuICAgIENvbnRlbnRNZXRhZGF0YUNvbmZpZyxcbiAgICBMYXlvdXRPcmllbnRlZENvbmZpZ0l0ZW0sXG4gICAgT3JnYW5pc2VkUHJvcGVydHlHcm91cCxcbiAgICBQcm9wZXJ0eUdyb3VwQ29udGFpbmVyLFxuICAgIFByb3BlcnR5XG59IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvY29udGVudC1tZXRhZGF0YS5pbnRlcmZhY2VzJztcbmltcG9ydCB7IGdldFByb3BlcnR5IH0gZnJvbSAnLi9wcm9wZXJ0eS1ncm91cC1yZWFkZXInO1xuXG5leHBvcnQgY2xhc3MgTGF5b3V0T3JpZW50ZWRDb25maWdTZXJ2aWNlIGltcGxlbWVudHMgQ29udGVudE1ldGFkYXRhQ29uZmlnIHtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgY29uZmlnOiBhbnkpIHsgfVxuXG4gICAgcHVibGljIGlzR3JvdXBBbGxvd2VkKGdyb3VwTmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGlmICh0aGlzLmlzSW5jbHVkZUFsbEVuYWJsZWQoKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TWF0Y2hpbmdHcm91cHMoZ3JvdXBOYW1lKS5sZW5ndGggPiAwO1xuICAgIH1cblxuICAgIHB1YmxpYyByZW9yZ2FuaXNlQnlDb25maWcocHJvcGVydHlHcm91cHM6IFByb3BlcnR5R3JvdXBDb250YWluZXIpOiBPcmdhbmlzZWRQcm9wZXJ0eUdyb3VwW10ge1xuICAgICAgICBjb25zdCBsYXlvdXRCbG9ja3MgPSB0aGlzLmNvbmZpZy5maWx0ZXIoKGl0ZW1zR3JvdXApID0+IGl0ZW1zR3JvdXAuaXRlbXMpO1xuXG4gICAgICAgIGNvbnN0IG9yZ2FuaXNlZFByb3BlcnR5R3JvdXAgPSBsYXlvdXRCbG9ja3MubWFwKChsYXlvdXRCbG9jaykgPT4ge1xuICAgICAgICAgICAgY29uc3QgZmxhdHRlbmVkSXRlbXMgPSB0aGlzLmZsYXR0ZW5JdGVtcyhsYXlvdXRCbG9jay5pdGVtcyksXG4gICAgICAgICAgICAgICAgcHJvcGVydGllcyA9IGZsYXR0ZW5lZEl0ZW1zLnJlZHVjZSgocHJvcHMsIGV4cGxvZGVkSXRlbSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1Byb3BlcnR5ID0gdHlwZW9mIGV4cGxvZGVkSXRlbS5wcm9wZXJ0eSAgPT09ICdvYmplY3QnO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBpc1Byb3BlcnR5ID8gZXhwbG9kZWRJdGVtLnByb3BlcnR5Lm5hbWUgOiBleHBsb2RlZEl0ZW0ucHJvcGVydHk7XG4gICAgICAgICAgICAgICAgICAgIGxldCAgcHJvcGVydHkgPSBnZXRQcm9wZXJ0eShwcm9wZXJ0eUdyb3VwcywgZXhwbG9kZWRJdGVtLmdyb3VwTmFtZSwgcHJvcGVydHlOYW1lKSB8fCBbXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzUHJvcGVydHkpIHsgcHJvcGVydHkgPSB0aGlzLnNldFByb3BlcnR5VGl0bGUocHJvcGVydHksIGV4cGxvZGVkSXRlbS5wcm9wZXJ0eSk7IH1cbiAgICAgICAgICAgICAgICAgICAgcHJvcGVydHkgPSB0aGlzLnNldEVkaXRhYmxlUHJvcGVydHkocHJvcGVydHksIGV4cGxvZGVkSXRlbSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9wcy5jb25jYXQocHJvcGVydHkpO1xuICAgICAgICAgICAgICAgIH0sIFtdKTtcblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB0aXRsZTogbGF5b3V0QmxvY2sudGl0bGUsXG4gICAgICAgICAgICAgICAgcHJvcGVydGllc1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIG9yZ2FuaXNlZFByb3BlcnR5R3JvdXA7XG4gICAgfVxuXG4gICAgcHVibGljIGFwcGVuZEFsbFByZXNldChwcm9wZXJ0eUdyb3VwczogUHJvcGVydHlHcm91cENvbnRhaW5lcik6IE9yZ2FuaXNlZFByb3BlcnR5R3JvdXBbXSB7XG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhwcm9wZXJ0eUdyb3VwcylcbiAgICAgICAgICAgIC5tYXAoKGdyb3VwTmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHByb3BlcnR5R3JvdXAgPSBwcm9wZXJ0eUdyb3Vwc1tncm91cE5hbWVdLFxuICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzID0gcHJvcGVydHlHcm91cC5wcm9wZXJ0aWVzO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHByb3BlcnR5R3JvdXAsIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllczogT2JqZWN0LmtleXMocHJvcGVydGllcykubWFwKChwcm9wZXJ0eU5hbWUpID0+IHByb3BlcnRpZXNbcHJvcGVydHlOYW1lXSlcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBmaWx0ZXJFeGNsdWRlZFByZXNldChwcm9wZXJ0eUdyb3VwczogT3JnYW5pc2VkUHJvcGVydHlHcm91cFtdKTogT3JnYW5pc2VkUHJvcGVydHlHcm91cFtdIHtcbiAgICAgICAgbGV0IGV4Y2x1ZGVkQ29uZmlnID0gdGhpcy5jb25maWdcbiAgICAgICAgICAgIC5tYXAoKGNvbmZpZykgPT4gY29uZmlnLmV4Y2x1ZGUpXG4gICAgICAgICAgICAuZmluZCgoZXhjbHVkZSkgPT4gZXhjbHVkZSAhPT0gdW5kZWZpbmVkKTtcblxuICAgICAgICBpZiAoZXhjbHVkZWRDb25maWcgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgZXhjbHVkZWRDb25maWcgPSBbXTtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZXhjbHVkZWRDb25maWcgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBleGNsdWRlZENvbmZpZyA9IFtleGNsdWRlZENvbmZpZ107XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcHJvcGVydHlHcm91cHMuZmlsdGVyKChwcm9wcykgPT4ge1xuICAgICAgICAgICAgcmV0dXJuICFleGNsdWRlZENvbmZpZy5pbmNsdWRlcyhwcm9wcy5uYW1lKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGlzSW5jbHVkZUFsbEVuYWJsZWQoKSB7XG4gICAgICAgIGNvbnN0IGluY2x1ZGVBbGxQcm9wZXJ0eSA9IHRoaXMuY29uZmlnXG4gICAgICAgICAgICAubWFwKChjb25maWcpID0+IGNvbmZpZy5pbmNsdWRlQWxsKVxuICAgICAgICAgICAgLmZpbmQoKGluY2x1ZGVBbGwpID0+IGluY2x1ZGVBbGwgIT09IHVuZGVmaW5lZCk7XG5cbiAgICAgICAgcmV0dXJuIGluY2x1ZGVBbGxQcm9wZXJ0eSAhPT0gdW5kZWZpbmVkID8gaW5jbHVkZUFsbFByb3BlcnR5IDogZmFsc2U7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXRFZGl0YWJsZVByb3BlcnR5KHByb3BlcnR5R3JvdXA6IFByb3BlcnR5IHwgUHJvcGVydHlbXSwgaXRlbUNvbmZpZyk6IFByb3BlcnR5IHwgUHJvcGVydHlbXSB7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHByb3BlcnR5R3JvdXApKSB7XG4gICAgICAgICAgICBwcm9wZXJ0eUdyb3VwLm1hcCgocHJvcGVydHkpID0+IHByb3BlcnR5LmVkaXRhYmxlID0gaXRlbUNvbmZpZy5lZGl0YWJsZSAhPT0gdW5kZWZpbmVkID8gaXRlbUNvbmZpZy5lZGl0YWJsZSA6IHRydWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcHJvcGVydHlHcm91cC5lZGl0YWJsZSA9IGl0ZW1Db25maWcuZWRpdGFibGUgIT09IHVuZGVmaW5lZCA/IGl0ZW1Db25maWcuZWRpdGFibGUgOiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHByb3BlcnR5R3JvdXA7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXRQcm9wZXJ0eVRpdGxlKGl0ZW06IFByb3BlcnR5IHwgUHJvcGVydHlbXSwgcHJvcGVydHk6IFByb3BlcnR5KTogUHJvcGVydHkgfCBQcm9wZXJ0eVtdIHtcbiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGl0ZW0pKSB7XG4gICAgICAgICAgICByZXR1cm4geyAuLi5pdGVtLCAuLi4oaXRlbS5uYW1lID09PSBwcm9wZXJ0eS5uYW1lICYmICEhcHJvcGVydHkudGl0bGUpICYmIHsgdGl0bGU6IHByb3BlcnR5LnRpdGxlIH0gfTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZsYXR0ZW5JdGVtcyhpdGVtcykge1xuICAgICAgICByZXR1cm4gaXRlbXMucmVkdWNlKChhY2N1bXVsYXRvciwgaXRlbSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcHJvcGVydGllcyA9IEFycmF5LmlzQXJyYXkoaXRlbS5wcm9wZXJ0aWVzKSA/IGl0ZW0ucHJvcGVydGllcyA6IFtpdGVtLnByb3BlcnRpZXNdO1xuICAgICAgICAgICAgY29uc3QgZmxhdHRlbmVkUHJvcGVydGllcyA9IHByb3BlcnRpZXMubWFwKChwcm9wZXJ0eSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGdyb3VwTmFtZTogaXRlbS5hc3BlY3QgfHwgaXRlbS50eXBlLFxuICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eSxcbiAgICAgICAgICAgICAgICAgICAgZWRpdGFibGU6IGl0ZW0uZWRpdGFibGVcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiBhY2N1bXVsYXRvci5jb25jYXQoZmxhdHRlbmVkUHJvcGVydGllcyk7XG4gICAgICAgIH0sIFtdKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldE1hdGNoaW5nR3JvdXBzKGdyb3VwTmFtZTogc3RyaW5nKTogTGF5b3V0T3JpZW50ZWRDb25maWdJdGVtW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5jb25maWdcbiAgICAgICAgICAgIC5tYXAoKGxheW91dEJsb2NrKSA9PiBsYXlvdXRCbG9jay5pdGVtcylcbiAgICAgICAgICAgIC5yZWR1Y2UoKGFjY3VtdWxhdG9yLCBpdGVtcykgPT4gYWNjdW11bGF0b3IuY29uY2F0KGl0ZW1zKSwgW10pXG4gICAgICAgICAgICAuZmlsdGVyKChpdGVtKSA9PiBpdGVtLmFzcGVjdCA9PT0gZ3JvdXBOYW1lIHx8IGl0ZW0udHlwZSA9PT0gZ3JvdXBOYW1lKTtcbiAgICB9XG59XG4iXX0=