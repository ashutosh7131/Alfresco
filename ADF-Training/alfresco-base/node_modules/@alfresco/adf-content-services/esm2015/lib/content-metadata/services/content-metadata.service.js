import { Injectable } from '@angular/core';
import { BasicPropertiesService } from './basic-properties.service';
import { of, iif, Subject } from 'rxjs';
import { PropertyGroupTranslatorService } from './property-groups-translator.service';
import { ContentMetadataConfigFactory } from './config/content-metadata-config.factory';
import { PropertyDescriptorsService } from './property-descriptors.service';
import { map, switchMap } from 'rxjs/operators';
import { ContentTypePropertiesService } from './content-type-property.service';
import * as i0 from "@angular/core";
import * as i1 from "./basic-properties.service";
import * as i2 from "./config/content-metadata-config.factory";
import * as i3 from "./property-groups-translator.service";
import * as i4 from "./property-descriptors.service";
import * as i5 from "./content-type-property.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './basic-properties.service';
import * as ɵngcc2 from './config/content-metadata-config.factory';
import * as ɵngcc3 from './property-groups-translator.service';
import * as ɵngcc4 from './property-descriptors.service';
import * as ɵngcc5 from './content-type-property.service';
export class ContentMetadataService {
    constructor(basicPropertiesService, contentMetadataConfigFactory, propertyGroupTranslatorService, propertyDescriptorsService, contentTypePropertyService) {
        this.basicPropertiesService = basicPropertiesService;
        this.contentMetadataConfigFactory = contentMetadataConfigFactory;
        this.propertyGroupTranslatorService = propertyGroupTranslatorService;
        this.propertyDescriptorsService = propertyDescriptorsService;
        this.contentTypePropertyService = contentTypePropertyService;
        this.error = new Subject();
    }
    getBasicProperties(node) {
        return of(this.basicPropertiesService.getProperties(node));
    }
    getContentTypeProperty(node) {
        return this.contentTypePropertyService.getContentTypeCardItem(node);
    }
    openConfirmDialog(changedProperties) {
        return this.contentTypePropertyService.openContentTypeDialogConfirm(changedProperties.nodeType);
    }
    getGroupedProperties(node, preset = 'default') {
        let groupedProperties = of([]);
        if (node.aspectNames) {
            let contentMetadataConfig;
            if (typeof preset === 'string') {
                contentMetadataConfig = this.contentMetadataConfigFactory.get(preset);
            }
            else {
                contentMetadataConfig = this.contentMetadataConfigFactory.createConfig(preset);
            }
            const groupNames = node.aspectNames
                .concat(node.nodeType)
                .filter((groupName) => contentMetadataConfig.isGroupAllowed(groupName));
            if (groupNames.length > 0) {
                groupedProperties = this.propertyDescriptorsService.load(groupNames).pipe(switchMap((groups) => iif(() => contentMetadataConfig.isIncludeAllEnabled(), of(contentMetadataConfig.appendAllPreset(groups).concat(contentMetadataConfig.reorganiseByConfig(groups))), of(contentMetadataConfig.reorganiseByConfig(groups)))), map((groups) => contentMetadataConfig.filterExcludedPreset(groups)), map((groups) => this.filterEmptyPreset(groups)), map((groups) => this.setTitleToNameIfNotSet(groups)), map((groups) => this.propertyGroupTranslatorService.translateToCardViewGroups(groups, node.properties, node.definition)));
            }
        }
        return groupedProperties;
    }
    setTitleToNameIfNotSet(propertyGroups) {
        propertyGroups.map((propertyGroup) => {
            propertyGroup.title = propertyGroup.title || propertyGroup.name;
        });
        return propertyGroups;
    }
    filterEmptyPreset(propertyGroups) {
        return propertyGroups.filter((props) => props.properties.length);
    }
}
ContentMetadataService.ɵfac = function ContentMetadataService_Factory(t) { return new (t || ContentMetadataService)(ɵngcc0.ɵɵinject(ɵngcc1.BasicPropertiesService), ɵngcc0.ɵɵinject(ɵngcc2.ContentMetadataConfigFactory), ɵngcc0.ɵɵinject(ɵngcc3.PropertyGroupTranslatorService), ɵngcc0.ɵɵinject(ɵngcc4.PropertyDescriptorsService), ɵngcc0.ɵɵinject(ɵngcc5.ContentTypePropertiesService)); };
ContentMetadataService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ContentMetadataService_Factory() { return new ContentMetadataService(i0.ɵɵinject(i1.BasicPropertiesService), i0.ɵɵinject(i2.ContentMetadataConfigFactory), i0.ɵɵinject(i3.PropertyGroupTranslatorService), i0.ɵɵinject(i4.PropertyDescriptorsService), i0.ɵɵinject(i5.ContentTypePropertiesService)); }, token: ContentMetadataService, providedIn: "root" });
ContentMetadataService.ctorParameters = () => [
    { type: BasicPropertiesService },
    { type: ContentMetadataConfigFactory },
    { type: PropertyGroupTranslatorService },
    { type: PropertyDescriptorsService },
    { type: ContentTypePropertiesService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ContentMetadataService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.BasicPropertiesService }, { type: ɵngcc2.ContentMetadataConfigFactory }, { type: ɵngcc3.PropertyGroupTranslatorService }, { type: ɵngcc4.PropertyDescriptorsService }, { type: ɵngcc5.ContentTypePropertiesService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC1tZXRhZGF0YS5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvY29udGVudC1zZXJ2aWNlcy9zcmMvbGliL2NvbnRlbnQtbWV0YWRhdGEvc2VydmljZXMvY29udGVudC1tZXRhZGF0YS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3BFLE9BQU8sRUFBYyxFQUFFLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwRCxPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUd0RixPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUN4RixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUM1RSxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQy9FO0FBRUE7QUFHUTtBQUVMO0FBQTREO0FBQ2xCOzs7Ozs7O0FBTDdDLE1BQU0sT0FBTyxzQkFBc0I7QUFDbkMsSUFHSSxZQUFvQixzQkFBOEMsRUFDOUMsNEJBQTBELEVBQzFELDhCQUE4RCxFQUM5RCwwQkFBc0QsRUFDdEQsMEJBQXdEO0FBQ2hGLFFBTHdCLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7QUFBQyxRQUMvQyxpQ0FBNEIsR0FBNUIsNEJBQTRCLENBQThCO0FBQUMsUUFDM0QsbUNBQThCLEdBQTlCLDhCQUE4QixDQUFnQztBQUFDLFFBQy9E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Q2IsU0FBUztBQUNULFFBQ1EsT0FBTyxpQkFBaUIsQ0FBQztBQUNqQyxJQUFJLENBQUM7QUFDTCxJQUNJLHNCQUFzQixDQUFDLGNBQXdDO0FBQUksUUFDL0QsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLGFBQWEsRUFBRSxFQUFFO0FBQzdDLFlBQVksYUFBYSxDQUFDLEtBQUssR0FBRyxhQUFhLENBQUMsS0FBSyxJQUFJLGFBQWEsQ0FBQyxJQUFJLENBQUM7QUFDNUUsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUNYLFFBQVEsT0FBTyxjQUFjLENBQUM7QUFDOUIsSUFBSSxDQUFDO0FBQ0wsSUFDSSxpQkFBaUIsQ0FBQyxjQUF3QztBQUFJLFFBQzFELE9BQU8sY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUN6RSxJQUFJLENBQUM7QUFDTDsrWEFBQztBQUNELHVhQXBFSztBQUFDO0VBSEwsVUFBVSxTQUFDLHJCQUtHLFlBZE4sc0JBQXNCO0NBVTNCLFVBQVUsRUFBRSxNQUFNLGNBQ3JCLGpDQVhrQyxZQUsxQiw0QkFBNEI7QUFBSSxZQUhoQyw4QkFBOEI7QUFBSSxZQUlsQywwQkFBMEI7QUFBSSxZQUU5Qiw0QkFBNEI7QUFBRzs7Ozs7O21SQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOb2RlIH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBCYXNpY1Byb3BlcnRpZXNTZXJ2aWNlIH0gZnJvbSAnLi9iYXNpYy1wcm9wZXJ0aWVzLnNlcnZpY2UnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIGlpZiwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgUHJvcGVydHlHcm91cFRyYW5zbGF0b3JTZXJ2aWNlIH0gZnJvbSAnLi9wcm9wZXJ0eS1ncm91cHMtdHJhbnNsYXRvci5zZXJ2aWNlJztcbmltcG9ydCB7IENhcmRWaWV3SXRlbSB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBDYXJkVmlld0dyb3VwLCBPcmdhbmlzZWRQcm9wZXJ0eUdyb3VwLCBQcmVzZXRDb25maWcgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2NvbnRlbnQtbWV0YWRhdGEuaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBDb250ZW50TWV0YWRhdGFDb25maWdGYWN0b3J5IH0gZnJvbSAnLi9jb25maWcvY29udGVudC1tZXRhZGF0YS1jb25maWcuZmFjdG9yeSc7XG5pbXBvcnQgeyBQcm9wZXJ0eURlc2NyaXB0b3JzU2VydmljZSB9IGZyb20gJy4vcHJvcGVydHktZGVzY3JpcHRvcnMuc2VydmljZSc7XG5pbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENvbnRlbnRUeXBlUHJvcGVydGllc1NlcnZpY2UgfSBmcm9tICcuL2NvbnRlbnQtdHlwZS1wcm9wZXJ0eS5zZXJ2aWNlJztcbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQ29udGVudE1ldGFkYXRhU2VydmljZSB7XG5cbiAgICBlcnJvciA9IG5ldyBTdWJqZWN0PHsgc3RhdHVzQ29kZTogbnVtYmVyLCBtZXNzYWdlOiBzdHJpbmcgfT4oKTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYmFzaWNQcm9wZXJ0aWVzU2VydmljZTogQmFzaWNQcm9wZXJ0aWVzU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGNvbnRlbnRNZXRhZGF0YUNvbmZpZ0ZhY3Rvcnk6IENvbnRlbnRNZXRhZGF0YUNvbmZpZ0ZhY3RvcnksXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBwcm9wZXJ0eUdyb3VwVHJhbnNsYXRvclNlcnZpY2U6IFByb3BlcnR5R3JvdXBUcmFuc2xhdG9yU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHByb3BlcnR5RGVzY3JpcHRvcnNTZXJ2aWNlOiBQcm9wZXJ0eURlc2NyaXB0b3JzU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGNvbnRlbnRUeXBlUHJvcGVydHlTZXJ2aWNlOiBDb250ZW50VHlwZVByb3BlcnRpZXNTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgZ2V0QmFzaWNQcm9wZXJ0aWVzKG5vZGU6IE5vZGUpOiBPYnNlcnZhYmxlPENhcmRWaWV3SXRlbVtdPiB7XG4gICAgICAgIHJldHVybiBvZih0aGlzLmJhc2ljUHJvcGVydGllc1NlcnZpY2UuZ2V0UHJvcGVydGllcyhub2RlKSk7XG4gICAgfVxuXG4gICAgZ2V0Q29udGVudFR5cGVQcm9wZXJ0eShub2RlOiBOb2RlKTogT2JzZXJ2YWJsZTxDYXJkVmlld0l0ZW1bXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jb250ZW50VHlwZVByb3BlcnR5U2VydmljZS5nZXRDb250ZW50VHlwZUNhcmRJdGVtKG5vZGUpO1xuICAgIH1cblxuICAgIG9wZW5Db25maXJtRGlhbG9nKGNoYW5nZWRQcm9wZXJ0aWVzKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29udGVudFR5cGVQcm9wZXJ0eVNlcnZpY2Uub3BlbkNvbnRlbnRUeXBlRGlhbG9nQ29uZmlybShjaGFuZ2VkUHJvcGVydGllcy5ub2RlVHlwZSk7XG4gICAgfVxuXG4gICAgZ2V0R3JvdXBlZFByb3BlcnRpZXMobm9kZTogTm9kZSwgcHJlc2V0OiBzdHJpbmcgfCBQcmVzZXRDb25maWcgPSAnZGVmYXVsdCcpOiBPYnNlcnZhYmxlPENhcmRWaWV3R3JvdXBbXT4ge1xuICAgICAgICBsZXQgZ3JvdXBlZFByb3BlcnRpZXMgPSBvZihbXSk7XG5cbiAgICAgICAgaWYgKG5vZGUuYXNwZWN0TmFtZXMpIHtcbiAgICAgICAgICAgIGxldCBjb250ZW50TWV0YWRhdGFDb25maWc7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHByZXNldCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICBjb250ZW50TWV0YWRhdGFDb25maWcgPSB0aGlzLmNvbnRlbnRNZXRhZGF0YUNvbmZpZ0ZhY3RvcnkuZ2V0KHByZXNldCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnRlbnRNZXRhZGF0YUNvbmZpZyA9IHRoaXMuY29udGVudE1ldGFkYXRhQ29uZmlnRmFjdG9yeS5jcmVhdGVDb25maWcocHJlc2V0KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgZ3JvdXBOYW1lcyA9IG5vZGUuYXNwZWN0TmFtZXNcbiAgICAgICAgICAgICAgICAuY29uY2F0KG5vZGUubm9kZVR5cGUpXG4gICAgICAgICAgICAgICAgLmZpbHRlcigoZ3JvdXBOYW1lKSA9PiBjb250ZW50TWV0YWRhdGFDb25maWcuaXNHcm91cEFsbG93ZWQoZ3JvdXBOYW1lKSk7XG5cbiAgICAgICAgICAgIGlmIChncm91cE5hbWVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBncm91cGVkUHJvcGVydGllcyA9IHRoaXMucHJvcGVydHlEZXNjcmlwdG9yc1NlcnZpY2UubG9hZChncm91cE5hbWVzKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKGdyb3VwcykgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlpZihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoKSA9PiBjb250ZW50TWV0YWRhdGFDb25maWcuaXNJbmNsdWRlQWxsRW5hYmxlZCgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9mKGNvbnRlbnRNZXRhZGF0YUNvbmZpZy5hcHBlbmRBbGxQcmVzZXQoZ3JvdXBzKS5jb25jYXQoY29udGVudE1ldGFkYXRhQ29uZmlnLnJlb3JnYW5pc2VCeUNvbmZpZyhncm91cHMpKSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2YoY29udGVudE1ldGFkYXRhQ29uZmlnLnJlb3JnYW5pc2VCeUNvbmZpZyhncm91cHMpKVxuICAgICAgICAgICAgICAgICAgICAgICAgKSksXG4gICAgICAgICAgICAgICAgICAgIG1hcCgoZ3JvdXBzKSA9PiBjb250ZW50TWV0YWRhdGFDb25maWcuZmlsdGVyRXhjbHVkZWRQcmVzZXQoZ3JvdXBzKSksXG4gICAgICAgICAgICAgICAgICAgIG1hcCgoZ3JvdXBzKSA9PiB0aGlzLmZpbHRlckVtcHR5UHJlc2V0KGdyb3VwcykpLFxuICAgICAgICAgICAgICAgICAgICBtYXAoKGdyb3VwcykgPT4gdGhpcy5zZXRUaXRsZVRvTmFtZUlmTm90U2V0KGdyb3VwcykpLFxuICAgICAgICAgICAgICAgICAgICBtYXAoKGdyb3VwcykgPT4gdGhpcy5wcm9wZXJ0eUdyb3VwVHJhbnNsYXRvclNlcnZpY2UudHJhbnNsYXRlVG9DYXJkVmlld0dyb3Vwcyhncm91cHMsIG5vZGUucHJvcGVydGllcywgbm9kZS5kZWZpbml0aW9uKSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGdyb3VwZWRQcm9wZXJ0aWVzO1xuICAgIH1cblxuICAgIHNldFRpdGxlVG9OYW1lSWZOb3RTZXQocHJvcGVydHlHcm91cHM6IE9yZ2FuaXNlZFByb3BlcnR5R3JvdXBbXSk6IE9yZ2FuaXNlZFByb3BlcnR5R3JvdXBbXSB7XG4gICAgICAgIHByb3BlcnR5R3JvdXBzLm1hcCgocHJvcGVydHlHcm91cCkgPT4ge1xuICAgICAgICAgICAgcHJvcGVydHlHcm91cC50aXRsZSA9IHByb3BlcnR5R3JvdXAudGl0bGUgfHwgcHJvcGVydHlHcm91cC5uYW1lO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHByb3BlcnR5R3JvdXBzO1xuICAgIH1cblxuICAgIGZpbHRlckVtcHR5UHJlc2V0KHByb3BlcnR5R3JvdXBzOiBPcmdhbmlzZWRQcm9wZXJ0eUdyb3VwW10pOiBPcmdhbmlzZWRQcm9wZXJ0eUdyb3VwW10gIHtcbiAgICAgICAgcmV0dXJuIHByb3BlcnR5R3JvdXBzLmZpbHRlcigocHJvcHMpID0+IHByb3BzLnByb3BlcnRpZXMubGVuZ3RoKTtcbiAgICB9XG59XG4iXX0=