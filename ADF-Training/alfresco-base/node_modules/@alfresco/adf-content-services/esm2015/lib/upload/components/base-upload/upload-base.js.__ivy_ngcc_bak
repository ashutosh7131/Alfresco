/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { FileModel, UploadService, TranslationService } from '@alfresco/adf-core';
import { EventEmitter, Input, Output, NgZone, Directive } from '@angular/core';
import { Subject } from 'rxjs';
import { UploadFilesEvent } from '../upload-files.event';
import { takeUntil } from 'rxjs/operators';
export class UploadBase {
    constructor(uploadService, translationService, ngZone) {
        this.uploadService = uploadService;
        this.translationService = translationService;
        this.ngZone = ngZone;
        this.rootFolderId = '-root-';
        this.disabled = false;
        this.acceptedFilesType = '*';
        this.versioning = false;
        this.majorVersion = false;
        this.nodeType = 'cm:content';
        this.success = new EventEmitter();
        this.error = new EventEmitter();
        this.beginUpload = new EventEmitter();
        this.updateFileVersion = new EventEmitter();
        this.onDestroy$ = new Subject();
    }
    ngOnInit() {
        this.uploadService.fileUploadError
            .pipe(takeUntil(this.onDestroy$))
            .subscribe(error => this.error.emit(error));
    }
    ngOnDestroy() {
        this.onDestroy$.next(true);
        this.onDestroy$.complete();
    }
    uploadFiles(files) {
        const filteredFiles = files
            .map((file) => {
            return this.createFileModel(file, this.rootFolderId, (file.webkitRelativePath || '').replace(/\/[^\/]*$/, ''));
        });
        this.uploadQueue(filteredFiles);
    }
    uploadFilesInfo(files) {
        const filteredFiles = files
            .map((fileInfo) => {
            return this.createFileModel(fileInfo.file, this.rootFolderId, fileInfo.relativeFolder);
        });
        this.uploadQueue(filteredFiles);
    }
    uploadQueue(files) {
        const filteredFiles = files
            .filter(this.isFileAcceptable.bind(this))
            .filter(this.isFileSizeAcceptable.bind(this));
        this.ngZone.run(() => {
            const event = new UploadFilesEvent([...filteredFiles], this.uploadService, this.success, this.error);
            this.beginUpload.emit(event);
            if (!event.defaultPrevented) {
                if (filteredFiles.length > 0) {
                    this.uploadService.addToQueue(...filteredFiles);
                    this.uploadService.uploadFilesInTheQueue(this.success, this.error);
                }
            }
        });
    }
    isFileAcceptable(file) {
        if (this.acceptedFilesType === '*') {
            return true;
        }
        const allowedExtensions = this.acceptedFilesType
            .split(',')
            .map((ext) => ext.trim().replace(/^\./, ''));
        return allowedExtensions.indexOf(file.extension) !== -1;
    }
    createFileModel(file, parentId, path, id) {
        return new FileModel(file, {
            comment: this.comment,
            majorVersion: this.majorVersion,
            newVersion: this.versioning,
            parentId: parentId,
            path: path,
            nodeType: this.nodeType
        }, id);
    }
    isFileSizeAllowed(file) {
        let isFileSizeAllowed = true;
        if (this.isMaxFileSizeDefined()) {
            isFileSizeAllowed = this.isFileSizeCorrect(file);
        }
        return isFileSizeAllowed;
    }
    isMaxFileSizeDefined() {
        return this.maxFilesSize !== undefined && this.maxFilesSize !== null;
    }
    isFileSizeCorrect(file) {
        return this.maxFilesSize >= 0 && file.size <= this.maxFilesSize;
    }
    isFileSizeAcceptable(file) {
        let acceptableSize = true;
        if (!this.isFileSizeAllowed(file)) {
            acceptableSize = false;
            const message = this.translationService.instant('FILE_UPLOAD.MESSAGES.EXCEED_MAX_FILE_SIZE', { fileName: file.name });
            this.error.emit(message);
        }
        return acceptableSize;
    }
}
UploadBase.decorators = [
    { type: Directive }
];
UploadBase.ctorParameters = () => [
    { type: UploadService },
    { type: TranslationService },
    { type: NgZone }
];
UploadBase.propDecorators = {
    maxFilesSize: [{ type: Input }],
    rootFolderId: [{ type: Input }],
    disabled: [{ type: Input }],
    acceptedFilesType: [{ type: Input }],
    versioning: [{ type: Input }],
    majorVersion: [{ type: Input }],
    comment: [{ type: Input }],
    nodeType: [{ type: Input }],
    success: [{ type: Output }],
    error: [{ type: Output }],
    beginUpload: [{ type: Output }],
    updateFileVersion: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkLWJhc2UuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb250ZW50LXNlcnZpY2VzL3NyYy8iLCJzb3VyY2VzIjpbImxpYi91cGxvYWQvY29tcG9uZW50cy9iYXNlLXVwbG9hZC91cGxvYWQtYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFFSCxPQUFPLEVBQUUsU0FBUyxFQUFZLGFBQWEsRUFBRSxrQkFBa0IsRUFBd0IsTUFBTSxvQkFBb0IsQ0FBQztBQUNsSCxPQUFPLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQXFCLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbEcsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJM0MsTUFBTSxPQUFnQixVQUFVO0lBd0Q1QixZQUFzQixhQUE0QixFQUM1QixrQkFBc0MsRUFDdEMsTUFBYztRQUZkLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQTlDcEMsaUJBQVksR0FBVyxRQUFRLENBQUM7UUFJaEMsYUFBUSxHQUFZLEtBQUssQ0FBQztRQUkxQixzQkFBaUIsR0FBVyxHQUFHLENBQUM7UUFJaEMsZUFBVSxHQUFZLEtBQUssQ0FBQztRQUk1QixpQkFBWSxHQUFZLEtBQUssQ0FBQztRQVE5QixhQUFRLEdBQVcsWUFBWSxDQUFDO1FBSWhDLFlBQU8sR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBSTdCLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBd0IsQ0FBQztRQUlqRCxnQkFBVyxHQUFHLElBQUksWUFBWSxFQUFvQixDQUFDO1FBSW5ELHNCQUFpQixHQUFHLElBQUksWUFBWSxFQUFlLENBQUM7UUFFMUMsZUFBVSxHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7SUFLOUMsQ0FBQztJQUVELFFBQVE7UUFDSixJQUFJLENBQUMsYUFBYSxDQUFDLGVBQWU7YUFDN0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7YUFDaEMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRUQsV0FBVztRQUNQLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNCLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQU1ELFdBQVcsQ0FBQyxLQUFhO1FBQ3JCLE1BQU0sYUFBYSxHQUFnQixLQUFLO2FBQ25DLEdBQUcsQ0FBWSxDQUFDLElBQVUsRUFBRSxFQUFFO1lBQzNCLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFRLElBQUssQ0FBQyxrQkFBa0IsSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDM0gsQ0FBQyxDQUFDLENBQUM7UUFFUCxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFRCxlQUFlLENBQUMsS0FBaUI7UUFDN0IsTUFBTSxhQUFhLEdBQWdCLEtBQUs7YUFDbkMsR0FBRyxDQUFZLENBQUMsUUFBa0IsRUFBRSxFQUFFO1lBQ25DLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsUUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQzNGLENBQUMsQ0FBQyxDQUFDO1FBRVAsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRU8sV0FBVyxDQUFDLEtBQWtCO1FBQ2xDLE1BQU0sYUFBYSxHQUFHLEtBQUs7YUFDdEIsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDeEMsTUFBTSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUVsRCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUU7WUFDakIsTUFBTSxLQUFLLEdBQUcsSUFBSSxnQkFBZ0IsQ0FDOUIsQ0FBQyxHQUFHLGFBQWEsQ0FBQyxFQUNsQixJQUFJLENBQUMsYUFBYSxFQUNsQixJQUFJLENBQUMsT0FBTyxFQUNaLElBQUksQ0FBQyxLQUFLLENBQ2IsQ0FBQztZQUNGLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRTdCLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLEVBQUU7Z0JBQ3pCLElBQUksYUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7b0JBQzFCLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLEdBQUcsYUFBYSxDQUFDLENBQUM7b0JBQ2hELElBQUksQ0FBQyxhQUFhLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7aUJBQ3RFO2FBQ0o7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFPUyxnQkFBZ0IsQ0FBQyxJQUFlO1FBQ3RDLElBQUksSUFBSSxDQUFDLGlCQUFpQixLQUFLLEdBQUcsRUFBRTtZQUNoQyxPQUFPLElBQUksQ0FBQztTQUNmO1FBRUQsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsaUJBQWlCO2FBQzNDLEtBQUssQ0FBQyxHQUFHLENBQUM7YUFDVixHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFakQsT0FBTyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFVUyxlQUFlLENBQUMsSUFBVSxFQUFFLFFBQWdCLEVBQUUsSUFBWSxFQUFFLEVBQVc7UUFDN0UsT0FBTyxJQUFJLFNBQVMsQ0FBQyxJQUFJLEVBQUU7WUFDdkIsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO1lBQ3JCLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWTtZQUMvQixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7WUFDM0IsUUFBUSxFQUFFLFFBQVE7WUFDbEIsSUFBSSxFQUFFLElBQUk7WUFDVixRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7U0FDMUIsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNYLENBQUM7SUFFUyxpQkFBaUIsQ0FBQyxJQUFlO1FBQ3ZDLElBQUksaUJBQWlCLEdBQUcsSUFBSSxDQUFDO1FBQzdCLElBQUksSUFBSSxDQUFDLG9CQUFvQixFQUFFLEVBQUU7WUFDN0IsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3BEO1FBRUQsT0FBTyxpQkFBaUIsQ0FBQztJQUM3QixDQUFDO0lBRVMsb0JBQW9CO1FBQzFCLE9BQU8sSUFBSSxDQUFDLFlBQVksS0FBSyxTQUFTLElBQUksSUFBSSxDQUFDLFlBQVksS0FBSyxJQUFJLENBQUM7SUFDekUsQ0FBQztJQUVTLGlCQUFpQixDQUFDLElBQWU7UUFDdkMsT0FBTyxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDcEUsQ0FBQztJQU9PLG9CQUFvQixDQUFDLElBQWU7UUFDeEMsSUFBSSxjQUFjLEdBQUcsSUFBSSxDQUFDO1FBRTFCLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDL0IsY0FBYyxHQUFHLEtBQUssQ0FBQztZQUV2QixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUMzQywyQ0FBMkMsRUFDM0MsRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUMxQixDQUFDO1lBRUYsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDNUI7UUFFRCxPQUFPLGNBQWMsQ0FBQztJQUMxQixDQUFDOzs7WUFoTUosU0FBUzs7O1lBTm9CLGFBQWE7WUFBRSxrQkFBa0I7WUFDTixNQUFNOzs7MkJBWTFELEtBQUs7MkJBTUwsS0FBSzt1QkFJTCxLQUFLO2dDQUlMLEtBQUs7eUJBSUwsS0FBSzsyQkFJTCxLQUFLO3NCQUlMLEtBQUs7dUJBSUwsS0FBSztzQkFJTCxNQUFNO29CQUlOLE1BQU07MEJBSU4sTUFBTTtnQ0FJTixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgRmlsZU1vZGVsLCBGaWxlSW5mbywgVXBsb2FkU2VydmljZSwgVHJhbnNsYXRpb25TZXJ2aWNlLCBGaWxlVXBsb2FkRXJyb3JFdmVudCB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIsIElucHV0LCBPdXRwdXQsIE9uSW5pdCwgT25EZXN0cm95LCBOZ1pvbmUsIERpcmVjdGl2ZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgVXBsb2FkRmlsZXNFdmVudCB9IGZyb20gJy4uL3VwbG9hZC1maWxlcy5ldmVudCc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBEaXJlY3RpdmUoKVxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBkaXJlY3RpdmUtY2xhc3Mtc3VmZml4XG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgVXBsb2FkQmFzZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcblxuICAgIC8qKiBTZXRzIGEgbGltaXQgb24gdGhlIG1heGltdW0gc2l6ZSAoaW4gYnl0ZXMpIG9mIGEgZmlsZSB0byBiZSB1cGxvYWRlZC5cbiAgICAgKiBIYXMgbm8gZWZmZWN0IGlmIHVuZGVmaW5lZC5cbiAgICAgKi9cbiAgICBASW5wdXQoKVxuICAgIG1heEZpbGVzU2l6ZTogbnVtYmVyO1xuXG4gICAgLyoqIFRoZSBJRCBvZiB0aGUgcm9vdC4gVXNlIHRoZSBub2RlSWQgZm9yXG4gICAgICogQ29udGVudCBTZXJ2aWNlcyBvciB0aGUgdGFza0lkL3Byb2Nlc3NJZCBmb3IgUHJvY2VzcyBTZXJ2aWNlcy5cbiAgICAgKi9cbiAgICBASW5wdXQoKVxuICAgIHJvb3RGb2xkZXJJZDogc3RyaW5nID0gJy1yb290LSc7XG5cbiAgICAvKiogVG9nZ2xlcyBjb21wb25lbnQgZGlzYWJsZWQgc3RhdGUgKGlmIHRoZXJlIGlzIG5vIG5vZGUgcGVybWlzc2lvbiBjaGVja2luZykuICovXG4gICAgQElucHV0KClcbiAgICBkaXNhYmxlZDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgLyoqIEZpbHRlciBmb3IgYWNjZXB0ZWQgZmlsZSB0eXBlcy4gKi9cbiAgICBASW5wdXQoKVxuICAgIGFjY2VwdGVkRmlsZXNUeXBlOiBzdHJpbmcgPSAnKic7XG5cbiAgICAvKiogVG9nZ2xlcyB2ZXJzaW9uaW5nLiAqL1xuICAgIEBJbnB1dCgpXG4gICAgdmVyc2lvbmluZzogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgLyoqIG1ham9yVmVyc2lvbiBib29sZWFuIGZpZWxkIHRvIHRydWUgdG8gaW5kaWNhdGUgYSBtYWpvciB2ZXJzaW9uIHNob3VsZCBiZSBjcmVhdGVkLiAqL1xuICAgIEBJbnB1dCgpXG4gICAgbWFqb3JWZXJzaW9uOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICAvKiogV2hlbiB5b3Ugb3ZlcndyaXRlIGV4aXN0aW5nIGNvbnRlbnQsIHlvdSBjYW4gdXNlIHRoZSBjb21tZW50IGZpZWxkIHRvIGFkZCBhIHZlcnNpb24gY29tbWVudCB0aGF0IGFwcGVhcnMgaW4gdGhlIHZlcnNpb24gaGlzdG9yeSAqL1xuICAgIEBJbnB1dCgpXG4gICAgY29tbWVudDogc3RyaW5nO1xuXG4gICAgLyoqIEN1c3RvbSBub2RlIHR5cGUgZm9yIHVwbG9hZGVkIGZpbGUgKi9cbiAgICBASW5wdXQoKVxuICAgIG5vZGVUeXBlOiBzdHJpbmcgPSAnY206Y29udGVudCc7XG5cbiAgICAvKiogRW1pdHRlZCB3aGVuIHRoZSBmaWxlIGlzIHVwbG9hZGVkIHN1Y2Nlc3NmdWxseS4gKi9cbiAgICBAT3V0cHV0KClcbiAgICBzdWNjZXNzID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgLyoqIEVtaXR0ZWQgd2hlbiBhbiBlcnJvciBvY2N1cnMuICovXG4gICAgQE91dHB1dCgpXG4gICAgZXJyb3IgPSBuZXcgRXZlbnRFbWl0dGVyPEZpbGVVcGxvYWRFcnJvckV2ZW50PigpO1xuXG4gICAgLyoqIEVtaXR0ZWQgd2hlbiB0aGUgdXBsb2FkIGJlZ2lucy4gKi9cbiAgICBAT3V0cHV0KClcbiAgICBiZWdpblVwbG9hZCA9IG5ldyBFdmVudEVtaXR0ZXI8VXBsb2FkRmlsZXNFdmVudD4oKTtcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gZHJvcHBpbmcgYSBmaWxlIG92ZXIgYW5vdGhlciBmaWxlIHRvIHVwZGF0ZSB0aGUgdmVyc2lvbi4gKi9cbiAgICBAT3V0cHV0KClcbiAgICB1cGRhdGVGaWxlVmVyc2lvbiA9IG5ldyBFdmVudEVtaXR0ZXI8Q3VzdG9tRXZlbnQ+KCk7XG5cbiAgICBwcm90ZWN0ZWQgb25EZXN0cm95JCA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgdXBsb2FkU2VydmljZTogVXBsb2FkU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcm90ZWN0ZWQgdHJhbnNsYXRpb25TZXJ2aWNlOiBUcmFuc2xhdGlvblNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJvdGVjdGVkIG5nWm9uZTogTmdab25lKSB7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIHRoaXMudXBsb2FkU2VydmljZS5maWxlVXBsb2FkRXJyb3JcbiAgICAgICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLm9uRGVzdHJveSQpKVxuICAgICAgICAgICAgLnN1YnNjcmliZShlcnJvciA9PiB0aGlzLmVycm9yLmVtaXQoZXJyb3IpKTtcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgdGhpcy5vbkRlc3Ryb3kkLm5leHQodHJ1ZSk7XG4gICAgICAgIHRoaXMub25EZXN0cm95JC5jb21wbGV0ZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwbG9hZCBhIGxpc3Qgb2YgZmlsZSBpbiB0aGUgc3BlY2lmaWVkIHBhdGhcbiAgICAgKiBAcGFyYW0gZmlsZXNcbiAgICAgKi9cbiAgICB1cGxvYWRGaWxlcyhmaWxlczogRmlsZVtdKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGZpbHRlcmVkRmlsZXM6IEZpbGVNb2RlbFtdID0gZmlsZXNcbiAgICAgICAgICAgIC5tYXA8RmlsZU1vZGVsPigoZmlsZTogRmlsZSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUZpbGVNb2RlbChmaWxlLCB0aGlzLnJvb3RGb2xkZXJJZCwgKCg8YW55PiBmaWxlKS53ZWJraXRSZWxhdGl2ZVBhdGggfHwgJycpLnJlcGxhY2UoL1xcL1teXFwvXSokLywgJycpKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudXBsb2FkUXVldWUoZmlsdGVyZWRGaWxlcyk7XG4gICAgfVxuXG4gICAgdXBsb2FkRmlsZXNJbmZvKGZpbGVzOiBGaWxlSW5mb1tdKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGZpbHRlcmVkRmlsZXM6IEZpbGVNb2RlbFtdID0gZmlsZXNcbiAgICAgICAgICAgIC5tYXA8RmlsZU1vZGVsPigoZmlsZUluZm86IEZpbGVJbmZvKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRmlsZU1vZGVsKGZpbGVJbmZvLmZpbGUsIHRoaXMucm9vdEZvbGRlcklkLCBmaWxlSW5mby5yZWxhdGl2ZUZvbGRlcik7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnVwbG9hZFF1ZXVlKGZpbHRlcmVkRmlsZXMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgdXBsb2FkUXVldWUoZmlsZXM6IEZpbGVNb2RlbFtdKSB7XG4gICAgICAgIGNvbnN0IGZpbHRlcmVkRmlsZXMgPSBmaWxlc1xuICAgICAgICAgICAgLmZpbHRlcih0aGlzLmlzRmlsZUFjY2VwdGFibGUuYmluZCh0aGlzKSlcbiAgICAgICAgICAgIC5maWx0ZXIodGhpcy5pc0ZpbGVTaXplQWNjZXB0YWJsZS5iaW5kKHRoaXMpKTtcblxuICAgICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZXZlbnQgPSBuZXcgVXBsb2FkRmlsZXNFdmVudChcbiAgICAgICAgICAgICAgICBbLi4uZmlsdGVyZWRGaWxlc10sXG4gICAgICAgICAgICAgICAgdGhpcy51cGxvYWRTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHRoaXMuc3VjY2VzcyxcbiAgICAgICAgICAgICAgICB0aGlzLmVycm9yXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhpcy5iZWdpblVwbG9hZC5lbWl0KGV2ZW50KTtcblxuICAgICAgICAgICAgaWYgKCFldmVudC5kZWZhdWx0UHJldmVudGVkKSB7XG4gICAgICAgICAgICAgICAgaWYgKGZpbHRlcmVkRmlsZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZFNlcnZpY2UuYWRkVG9RdWV1ZSguLi5maWx0ZXJlZEZpbGVzKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGxvYWRTZXJ2aWNlLnVwbG9hZEZpbGVzSW5UaGVRdWV1ZSh0aGlzLnN1Y2Nlc3MsIHRoaXMuZXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIHRoZSBnaXZlbiBmaWxlIGlzIGFsbG93ZWQgYnkgdGhlIGV4dGVuc2lvbiBmaWx0ZXJzXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZmlsZSBGaWxlTW9kZWxcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgaXNGaWxlQWNjZXB0YWJsZShmaWxlOiBGaWxlTW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHRoaXMuYWNjZXB0ZWRGaWxlc1R5cGUgPT09ICcqJykge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBhbGxvd2VkRXh0ZW5zaW9ucyA9IHRoaXMuYWNjZXB0ZWRGaWxlc1R5cGVcbiAgICAgICAgICAgIC5zcGxpdCgnLCcpXG4gICAgICAgICAgICAubWFwKChleHQpID0+IGV4dC50cmltKCkucmVwbGFjZSgvXlxcLi8sICcnKSk7XG5cbiAgICAgICAgcmV0dXJuIGFsbG93ZWRFeHRlbnNpb25zLmluZGV4T2YoZmlsZS5leHRlbnNpb24pICE9PSAtMTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIEZpbGVNb2RlbCBmcm9tIEZpbGVcbiAgICAgKlxuICAgICAqIEBwYXJhbSBmaWxlXG4gICAgICogQHBhcmFtIHBhcmVudElkXG4gICAgICogQHBhcmFtIHBhdGhcbiAgICAgKiBAcGFyYW0gaWRcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgY3JlYXRlRmlsZU1vZGVsKGZpbGU6IEZpbGUsIHBhcmVudElkOiBzdHJpbmcsIHBhdGg6IHN0cmluZywgaWQ/OiBzdHJpbmcpOiBGaWxlTW9kZWwge1xuICAgICAgICByZXR1cm4gbmV3IEZpbGVNb2RlbChmaWxlLCB7XG4gICAgICAgICAgICBjb21tZW50OiB0aGlzLmNvbW1lbnQsXG4gICAgICAgICAgICBtYWpvclZlcnNpb246IHRoaXMubWFqb3JWZXJzaW9uLFxuICAgICAgICAgICAgbmV3VmVyc2lvbjogdGhpcy52ZXJzaW9uaW5nLFxuICAgICAgICAgICAgcGFyZW50SWQ6IHBhcmVudElkLFxuICAgICAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgICAgICAgIG5vZGVUeXBlOiB0aGlzLm5vZGVUeXBlXG4gICAgICAgIH0sIGlkKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgaXNGaWxlU2l6ZUFsbG93ZWQoZmlsZTogRmlsZU1vZGVsKSB7XG4gICAgICAgIGxldCBpc0ZpbGVTaXplQWxsb3dlZCA9IHRydWU7XG4gICAgICAgIGlmICh0aGlzLmlzTWF4RmlsZVNpemVEZWZpbmVkKCkpIHtcbiAgICAgICAgICAgIGlzRmlsZVNpemVBbGxvd2VkID0gdGhpcy5pc0ZpbGVTaXplQ29ycmVjdChmaWxlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBpc0ZpbGVTaXplQWxsb3dlZDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgaXNNYXhGaWxlU2l6ZURlZmluZWQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm1heEZpbGVzU2l6ZSAhPT0gdW5kZWZpbmVkICYmIHRoaXMubWF4RmlsZXNTaXplICE9PSBudWxsO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBpc0ZpbGVTaXplQ29ycmVjdChmaWxlOiBGaWxlTW9kZWwpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWF4RmlsZXNTaXplID49IDAgJiYgZmlsZS5zaXplIDw9IHRoaXMubWF4RmlsZXNTaXplO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBpZiB0aGUgZ2l2ZW4gZmlsZSBpcyBhbiBhY2NlcHRhYmxlIHNpemVcbiAgICAgKlxuICAgICAqIEBwYXJhbSBmaWxlIEZpbGVNb2RlbFxuICAgICAqL1xuICAgIHByaXZhdGUgaXNGaWxlU2l6ZUFjY2VwdGFibGUoZmlsZTogRmlsZU1vZGVsKTogYm9vbGVhbiB7XG4gICAgICAgIGxldCBhY2NlcHRhYmxlU2l6ZSA9IHRydWU7XG5cbiAgICAgICAgaWYgKCF0aGlzLmlzRmlsZVNpemVBbGxvd2VkKGZpbGUpKSB7XG4gICAgICAgICAgICBhY2NlcHRhYmxlU2l6ZSA9IGZhbHNlO1xuXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gdGhpcy50cmFuc2xhdGlvblNlcnZpY2UuaW5zdGFudChcbiAgICAgICAgICAgICAgICAnRklMRV9VUExPQUQuTUVTU0FHRVMuRVhDRUVEX01BWF9GSUxFX1NJWkUnLFxuICAgICAgICAgICAgICAgIHsgZmlsZU5hbWU6IGZpbGUubmFtZSB9XG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICB0aGlzLmVycm9yLmVtaXQobWVzc2FnZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYWNjZXB0YWJsZVNpemU7XG4gICAgfVxuXG59XG4iXX0=