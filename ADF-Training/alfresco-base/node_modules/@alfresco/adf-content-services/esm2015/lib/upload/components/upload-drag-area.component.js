/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { EXTENDIBLE_COMPONENT, FileUtils, NotificationService, TranslationService, UploadService, ContentService, AllowableOperationsEnum } from '@alfresco/adf-core';
import { Component, forwardRef, ViewEncapsulation, NgZone } from '@angular/core';
import { UploadBase } from './base-upload/upload-base';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
import * as ɵngcc2 from '../directives/file-draggable.directive';

const _c0 = ["*"];
export class UploadDragAreaComponent extends UploadBase {
    constructor(uploadService, translationService, notificationService, contentService, ngZone) {
        super(uploadService, translationService, ngZone);
        this.uploadService = uploadService;
        this.translationService = translationService;
        this.notificationService = notificationService;
        this.contentService = contentService;
        this.ngZone = ngZone;
    }
    onFilesDropped(files) {
        if (!this.disabled && files.length) {
            this.uploadFiles(files);
        }
    }
    onFolderEntityDropped(folder) {
        if (!this.disabled && folder.isDirectory) {
            FileUtils.flatten(folder).then((filesInfo) => {
                this.uploadFilesInfo(filesInfo);
            });
        }
    }
    showUndoNotificationBar(latestFilesAdded) {
        let messageTranslate, actionTranslate;
        messageTranslate = this.translationService.get('FILE_UPLOAD.MESSAGES.PROGRESS');
        actionTranslate = this.translationService.get('FILE_UPLOAD.ACTION.UNDO');
        this.notificationService.openSnackMessageAction(messageTranslate.value, actionTranslate.value, 3000).onAction().subscribe(() => {
            this.uploadService.cancelUpload(...latestFilesAdded);
        });
    }
    isDroppable() {
        return !this.disabled;
    }
    onUploadFiles(event) {
        event.stopPropagation();
        event.preventDefault();
        const isAllowed = this.isTargetNodeFolder(event) ?
            this.contentService.hasAllowableOperations(event.detail.data.obj.entry, AllowableOperationsEnum.CREATE)
            : this.contentService.hasAllowableOperations(event.detail.data.obj.entry, AllowableOperationsEnum.UPDATE);
        if (isAllowed) {
            if (!this.isTargetNodeFolder(event) && event.detail.files.length === 1) {
                this.updateFileVersion.emit(event);
            }
            else {
                const fileInfo = event.detail.files;
                if (this.isTargetNodeFolder(event)) {
                    const destinationFolderName = event.detail.data.obj.entry.name;
                    fileInfo.map((file) => file.relativeFolder = destinationFolderName ? destinationFolderName.concat(file.relativeFolder) : file.relativeFolder);
                }
                if (fileInfo && fileInfo.length > 0) {
                    this.uploadFilesInfo(fileInfo);
                }
            }
        }
    }
    isTargetNodeFolder(event) {
        return event.detail.data.obj && event.detail.data.obj.entry.isFolder;
    }
}
UploadDragAreaComponent.ɵfac = function UploadDragAreaComponent_Factory(t) { return new (t || UploadDragAreaComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.UploadService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.TranslationService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.NotificationService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ContentService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone)); };
UploadDragAreaComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: UploadDragAreaComponent, selectors: [["adf-upload-drag-area"]], hostAttrs: [1, "adf-upload-drag-area"], features: [ɵngcc0.ɵɵProvidersFeature([], [
            { provide: EXTENDIBLE_COMPONENT, useExisting: forwardRef(() => UploadDragAreaComponent) }
        ]), ɵngcc0.ɵɵInheritDefinitionFeature], ngContentSelectors: _c0, decls: 3, vars: 1, consts: [["dropzone", "", "webkitdropzone", "*", 1, "adf-upload-border", 3, "adf-file-draggable", "filesDropped", "folderEntityDropped", "upload-files"], ["droparea", ""]], template: function UploadDragAreaComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵprojectionDef();
        ɵngcc0.ɵɵelementStart(0, "div", 0, 1);
        ɵngcc0.ɵɵlistener("filesDropped", function UploadDragAreaComponent_Template_div_filesDropped_0_listener($event) { return ctx.onFilesDropped($event); })("folderEntityDropped", function UploadDragAreaComponent_Template_div_folderEntityDropped_0_listener($event) { return ctx.onFolderEntityDropped($event); })("upload-files", function UploadDragAreaComponent_Template_div_upload_files_0_listener($event) { return ctx.onUploadFiles($event); });
        ɵngcc0.ɵɵprojection(2);
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("adf-file-draggable", ctx.isDroppable());
    } }, directives: [ɵngcc2.FileDraggableDirective], styles: ["adf-upload-drag-area{display:flex;flex:1;flex-direction:column;height:100%;min-height:0;overflow:hidden}adf-upload-drag-area .adf-upload-border{box-sizing:border-box;display:flex;flex-direction:column;height:100%;min-height:0;overflow:hidden;text-align:unset;vertical-align:unset;width:100%}adf-upload-drag-area .adf-file-draggable__input-focus{border:1px dashed #2196f3;color:#2196f3}adf-upload-drag-area .adf-file-draggable__input-focus adf-document-list{background:#e3f2fd}adf-upload-drag-area .adf-file-draggable__input-focus adf-document-list adf-datatable>table{background:inherit}adf-upload-drag-area .adf-upload__dragging{background:#e3f2fd;color:#2196f3}adf-upload-drag-area .adf-upload__dragging td{border-bottom:1px dashed #2196f3!important;border-top:1px dashed #2196f3!important}adf-upload-drag-area .adf-upload__dragging td:first-child{border-left:1px dashed #2196f3!important}adf-upload-drag-area .adf-upload__dragging td:last-child{border-right:1px dashed #2196f3!important}adf-upload-drag-area:first-child>div adf-upload-drag-area .adf-file-draggable__input-focus{border:1px dashed #2196f3!important;color:#2196f3;margin-left:0!important}adf-upload-drag-area:first-child .adf-upload-border{text-align:inherit!important;vertical-align:inherit!important}adf-upload-drag-area:first-child .adf-file-draggable__input-focus{border:1px dashed #2196f3!important;color:#2196f3!important;margin-left:0!important}adf-upload-drag-area:first-child .adf-file-draggable__input-focus adf-upload-drag-area>div{border:1px dashed #2196f3!important;color:#2196f3;margin-left:0!important}"], encapsulation: 2 });
UploadDragAreaComponent.ctorParameters = () => [
    { type: UploadService },
    { type: TranslationService },
    { type: NotificationService },
    { type: ContentService },
    { type: NgZone }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(UploadDragAreaComponent, [{
        type: Component,
        args: [{
                selector: 'adf-upload-drag-area',
                template: "<div [adf-file-draggable]=\"isDroppable()\" class=\"adf-upload-border\"\n     (filesDropped)=\"onFilesDropped($event)\"\n     (folderEntityDropped)=\"onFolderEntityDropped($event)\"\n     (upload-files)=\"onUploadFiles($any($event))\"\n     dropzone=\"\" webkitdropzone=\"*\" #droparea>\n    <ng-content></ng-content>\n</div>\n",
                host: { 'class': 'adf-upload-drag-area' },
                viewProviders: [
                    { provide: EXTENDIBLE_COMPONENT, useExisting: forwardRef(() => UploadDragAreaComponent) }
                ],
                encapsulation: ViewEncapsulation.None,
                styles: ["adf-upload-drag-area{display:flex;flex:1;flex-direction:column;height:100%;min-height:0;overflow:hidden}adf-upload-drag-area .adf-upload-border{box-sizing:border-box;display:flex;flex-direction:column;height:100%;min-height:0;overflow:hidden;text-align:unset;vertical-align:unset;width:100%}adf-upload-drag-area .adf-file-draggable__input-focus{border:1px dashed #2196f3;color:#2196f3}adf-upload-drag-area .adf-file-draggable__input-focus adf-document-list{background:#e3f2fd}adf-upload-drag-area .adf-file-draggable__input-focus adf-document-list adf-datatable>table{background:inherit}adf-upload-drag-area .adf-upload__dragging{background:#e3f2fd;color:#2196f3}adf-upload-drag-area .adf-upload__dragging td{border-bottom:1px dashed #2196f3!important;border-top:1px dashed #2196f3!important}adf-upload-drag-area .adf-upload__dragging td:first-child{border-left:1px dashed #2196f3!important}adf-upload-drag-area .adf-upload__dragging td:last-child{border-right:1px dashed #2196f3!important}adf-upload-drag-area:first-child>div adf-upload-drag-area .adf-file-draggable__input-focus{border:1px dashed #2196f3!important;color:#2196f3;margin-left:0!important}adf-upload-drag-area:first-child .adf-upload-border{text-align:inherit!important;vertical-align:inherit!important}adf-upload-drag-area:first-child .adf-file-draggable__input-focus{border:1px dashed #2196f3!important;color:#2196f3!important;margin-left:0!important}adf-upload-drag-area:first-child .adf-file-draggable__input-focus adf-upload-drag-area>div{border:1px dashed #2196f3!important;color:#2196f3;margin-left:0!important}"]
            }]
    }], function () { return [{ type: ɵngcc1.UploadService }, { type: ɵngcc1.TranslationService }, { type: ɵngcc1.NotificationService }, { type: ɵngcc1.ContentService }, { type: ɵngcc0.NgZone }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkLWRyYWctYXJlYS5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb250ZW50LXNlcnZpY2VzL3NyYy9saWIvdXBsb2FkL2NvbXBvbmVudHMvdXBsb2FkLWRyYWctYXJlYS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUVILE9BQU8sRUFDSCxvQkFBb0IsRUFBdUIsU0FBUyxFQUNwRCxtQkFBbUIsRUFBRSxrQkFBa0IsRUFBRSxhQUFhLEVBQUUsY0FBYyxFQUFFLHVCQUF1QixFQUNsRyxNQUFNLG9CQUFvQixDQUFDO0FBQzVCLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLGlCQUFpQixFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqRixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7Ozs7OztBQVl2RCxNQUFNLE9BQU8sdUJBQXdCLFNBQVEsVUFBVTtBQUFHLElBRXRELFlBQXNCLGFBQTRCLEVBQzVCLGtCQUFzQyxFQUN4QyxtQkFBd0MsRUFDeEMsY0FBOEIsRUFDNUIsTUFBYztBQUN4QyxRQUFRLEtBQUssQ0FBQyxhQUFhLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDekQsUUFOMEIsa0JBQWEsR0FBYixhQUFhLENBQWU7QUFBQyxRQUM3Qix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO0FBQUMsUUFDekMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtBQUFDLFFBQ3pDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtBQUFDLFFBQzdCLFdBQU0sR0FBTixN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Q29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1xuICAgIEVYVEVORElCTEVfQ09NUE9ORU5ULCBGaWxlSW5mbywgRmlsZU1vZGVsLCBGaWxlVXRpbHMsIE5vZGVBbGxvd2FibGVPcGVyYXRpb25TdWJqZWN0LFxuICAgIE5vdGlmaWNhdGlvblNlcnZpY2UsIFRyYW5zbGF0aW9uU2VydmljZSwgVXBsb2FkU2VydmljZSwgQ29udGVudFNlcnZpY2UsIEFsbG93YWJsZU9wZXJhdGlvbnNFbnVtXG59IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBDb21wb25lbnQsIGZvcndhcmRSZWYsIFZpZXdFbmNhcHN1bGF0aW9uLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFVwbG9hZEJhc2UgfSBmcm9tICcuL2Jhc2UtdXBsb2FkL3VwbG9hZC1iYXNlJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdhZGYtdXBsb2FkLWRyYWctYXJlYScsXG4gICAgdGVtcGxhdGVVcmw6ICcuL3VwbG9hZC1kcmFnLWFyZWEuY29tcG9uZW50Lmh0bWwnLFxuICAgIHN0eWxlVXJsczogWycuL3VwbG9hZC1kcmFnLWFyZWEuY29tcG9uZW50LnNjc3MnXSxcbiAgICBob3N0OiB7J2NsYXNzJzogJ2FkZi11cGxvYWQtZHJhZy1hcmVhJ30sXG4gICAgdmlld1Byb3ZpZGVyczogW1xuICAgICAgICB7cHJvdmlkZTogRVhURU5ESUJMRV9DT01QT05FTlQsIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IFVwbG9hZERyYWdBcmVhQ29tcG9uZW50KX1cbiAgICBdLFxuICAgIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmVcbn0pXG5leHBvcnQgY2xhc3MgVXBsb2FkRHJhZ0FyZWFDb21wb25lbnQgZXh0ZW5kcyBVcGxvYWRCYXNlIGltcGxlbWVudHMgTm9kZUFsbG93YWJsZU9wZXJhdGlvblN1YmplY3Qge1xuXG4gICAgY29uc3RydWN0b3IocHJvdGVjdGVkIHVwbG9hZFNlcnZpY2U6IFVwbG9hZFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJvdGVjdGVkIHRyYW5zbGF0aW9uU2VydmljZTogVHJhbnNsYXRpb25TZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgbm90aWZpY2F0aW9uU2VydmljZTogTm90aWZpY2F0aW9uU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGNvbnRlbnRTZXJ2aWNlOiBDb250ZW50U2VydmljZSxcbiAgICAgICAgICAgICAgICBwcm90ZWN0ZWQgbmdab25lOiBOZ1pvbmUpIHtcbiAgICAgICAgc3VwZXIodXBsb2FkU2VydmljZSwgdHJhbnNsYXRpb25TZXJ2aWNlLCBuZ1pvbmUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE1ldGhvZCBjYWxsZWQgd2hlbiBmaWxlcyBhcmUgZHJvcHBlZCBpbiB0aGUgZHJhZyBhcmVhLlxuICAgICAqXG4gICAgICogQHBhcmFtIGZpbGVzIC0gZmlsZXMgZHJvcHBlZCBpbiB0aGUgZHJhZyBhcmVhLlxuICAgICAqL1xuICAgIG9uRmlsZXNEcm9wcGVkKGZpbGVzOiBGaWxlW10pOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLmRpc2FibGVkICYmIGZpbGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy51cGxvYWRGaWxlcyhmaWxlcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxsZWQgd2hlbiBhIGZvbGRlciBhcmUgZHJvcHBlZCBpbiB0aGUgZHJhZyBhcmVhXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZm9sZGVyIC0gbmFtZSBvZiB0aGUgZHJvcHBlZCBmb2xkZXJcbiAgICAgKi9cbiAgICBvbkZvbGRlckVudGl0eURyb3BwZWQoZm9sZGVyOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLmRpc2FibGVkICYmIGZvbGRlci5pc0RpcmVjdG9yeSkge1xuICAgICAgICAgICAgRmlsZVV0aWxzLmZsYXR0ZW4oZm9sZGVyKS50aGVuKChmaWxlc0luZm8pID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZEZpbGVzSW5mbyhmaWxlc0luZm8pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTaG93IHVuZG8gbm90aWZpY2F0aW9uIGJhci5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBsYXRlc3RGaWxlc0FkZGVkIC0gZmlsZXMgaW4gdGhlIHVwbG9hZCBxdWV1ZSBlbnJpY2hlZCB3aXRoIHN0YXR1cyBmbGFnIGFuZCB4aHIgb2JqZWN0LlxuICAgICAqL1xuICAgIHNob3dVbmRvTm90aWZpY2F0aW9uQmFyKGxhdGVzdEZpbGVzQWRkZWQ6IEZpbGVNb2RlbFtdKSB7XG4gICAgICAgIGxldCBtZXNzYWdlVHJhbnNsYXRlOiBhbnksIGFjdGlvblRyYW5zbGF0ZTogYW55O1xuICAgICAgICBtZXNzYWdlVHJhbnNsYXRlID0gdGhpcy50cmFuc2xhdGlvblNlcnZpY2UuZ2V0KCdGSUxFX1VQTE9BRC5NRVNTQUdFUy5QUk9HUkVTUycpO1xuICAgICAgICBhY3Rpb25UcmFuc2xhdGUgPSB0aGlzLnRyYW5zbGF0aW9uU2VydmljZS5nZXQoJ0ZJTEVfVVBMT0FELkFDVElPTi5VTkRPJyk7XG5cbiAgICAgICAgdGhpcy5ub3RpZmljYXRpb25TZXJ2aWNlLm9wZW5TbmFja01lc3NhZ2VBY3Rpb24obWVzc2FnZVRyYW5zbGF0ZS52YWx1ZSwgYWN0aW9uVHJhbnNsYXRlLnZhbHVlLCAzMDAwKS5vbkFjdGlvbigpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnVwbG9hZFNlcnZpY2UuY2FuY2VsVXBsb2FkKC4uLmxhdGVzdEZpbGVzQWRkZWQpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKiogUmV0dXJucyB0cnVlIG9yIGZhbHNlIGNvbnNpZGVyaW5nIHRoZSBjb21wb25lbnQgb3B0aW9ucyBhbmQgbm9kZSBwZXJtaXNzaW9ucyAqL1xuICAgIGlzRHJvcHBhYmxlKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gIXRoaXMuZGlzYWJsZWQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSGFuZGxlcyAndXBsb2FkLWZpbGVzJyBldmVudHMgcmFpc2VkIGJ5IGNoaWxkIGNvbXBvbmVudHMuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZXZlbnQgRE9NIGV2ZW50XG4gICAgICovXG4gICAgb25VcGxvYWRGaWxlcyhldmVudDogQ3VzdG9tRXZlbnQpIHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGNvbnN0IGlzQWxsb3dlZDogYm9vbGVhbiA9IHRoaXMuaXNUYXJnZXROb2RlRm9sZGVyKGV2ZW50KSA/XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnRTZXJ2aWNlLmhhc0FsbG93YWJsZU9wZXJhdGlvbnMoZXZlbnQuZGV0YWlsLmRhdGEub2JqLmVudHJ5LCBBbGxvd2FibGVPcGVyYXRpb25zRW51bS5DUkVBVEUpXG4gICAgICAgICAgICA6IHRoaXMuY29udGVudFNlcnZpY2UuaGFzQWxsb3dhYmxlT3BlcmF0aW9ucyhldmVudC5kZXRhaWwuZGF0YS5vYmouZW50cnksIEFsbG93YWJsZU9wZXJhdGlvbnNFbnVtLlVQREFURSk7XG4gICAgICAgIGlmIChpc0FsbG93ZWQpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5pc1RhcmdldE5vZGVGb2xkZXIoZXZlbnQpICYmIGV2ZW50LmRldGFpbC5maWxlcy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUZpbGVWZXJzaW9uLmVtaXQoZXZlbnQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWxlSW5mbzogRmlsZUluZm9bXSA9IGV2ZW50LmRldGFpbC5maWxlcztcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1RhcmdldE5vZGVGb2xkZXIoZXZlbnQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlc3RpbmF0aW9uRm9sZGVyTmFtZSA9IGV2ZW50LmRldGFpbC5kYXRhLm9iai5lbnRyeS5uYW1lO1xuICAgICAgICAgICAgICAgICAgICBmaWxlSW5mby5tYXAoKGZpbGUpID0+IGZpbGUucmVsYXRpdmVGb2xkZXIgPSBkZXN0aW5hdGlvbkZvbGRlck5hbWUgPyBkZXN0aW5hdGlvbkZvbGRlck5hbWUuY29uY2F0KGZpbGUucmVsYXRpdmVGb2xkZXIpIDogZmlsZS5yZWxhdGl2ZUZvbGRlcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChmaWxlSW5mbyAmJiBmaWxlSW5mby5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkRmlsZXNJbmZvKGZpbGVJbmZvKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGlzVGFyZ2V0Tm9kZUZvbGRlcihldmVudDogQ3VzdG9tRXZlbnQpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGV2ZW50LmRldGFpbC5kYXRhLm9iaiAmJiBldmVudC5kZXRhaWwuZGF0YS5vYmouZW50cnkuaXNGb2xkZXI7XG4gICAgfVxuXG59XG4iXX0=