/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Component, Inject, Input, Output, EventEmitter } from '@angular/core';
import { DocumentListComponent } from '../document-list.component';
import { SEARCH_QUERY_SERVICE_TOKEN } from '../../../search/search-query-service.token';
import { SearchHeaderQueryBuilderService } from '../../../search/services/search-header-query-builder.service';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/common';
import * as ɵngcc2 from '@alfresco/adf-core';
import * as ɵngcc3 from '../../../search/components/search-filter-container/search-filter-container.component';
import * as ɵngcc4 from '../document-list.component';
import * as ɵngcc5 from '../../../search/services/search-header-query-builder.service';

function FilterHeaderComponent_div_0_ng_template_2_Template(rf, ctx) { if (rf & 1) {
    const _r4 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "adf-search-filter-container", 1);
    ɵngcc0.ɵɵlistener("filterChange", function FilterHeaderComponent_div_0_ng_template_2_Template_adf_search_filter_container_filterChange_0_listener() { ɵngcc0.ɵɵrestoreView(_r4); const ctx_r3 = ɵngcc0.ɵɵnextContext(2); return ctx_r3.onFilterSelectionChange(); });
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const col_r2 = ctx.$implicit;
    const ctx_r1 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵproperty("col", col_r2)("value", ctx_r1.value);
} }
function FilterHeaderComponent_div_0_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div");
    ɵngcc0.ɵɵelementStart(1, "adf-header-filter-template");
    ɵngcc0.ɵɵtemplate(2, FilterHeaderComponent_div_0_ng_template_2_Template, 1, 2, "ng-template");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} }
export class FilterHeaderComponent {
    constructor(documentList, searchFilterQueryBuilder) {
        this.documentList = documentList;
        this.searchFilterQueryBuilder = searchFilterQueryBuilder;
        this.value = {};
        this.filterSelection = new EventEmitter();
        this.onDestroy$ = new Subject();
        this.isFilterServiceActive = this.searchFilterQueryBuilder.isFilterServiceActive();
    }
    ngOnInit() {
        this.searchFilterQueryBuilder.executed
            .pipe(takeUntil(this.onDestroy$))
            .subscribe((newNodePaging) => {
            this.documentList.node = newNodePaging;
            this.documentList.reload();
        });
        this.initDataPagination();
        this.initDataSorting();
    }
    ngOnChanges(changes) {
        if (changes['currentFolderId'] && changes['currentFolderId'].currentValue) {
            this.resetFilterHeader();
            this.configureSearchParent(changes['currentFolderId'].currentValue);
        }
    }
    onFilterSelectionChange() {
        this.filterSelection.emit(this.searchFilterQueryBuilder.getActiveFilters());
        if (this.searchFilterQueryBuilder.isNoFilterActive()) {
            this.documentList.node = null;
            this.documentList.reload();
        }
    }
    resetFilterHeader() {
        this.searchFilterQueryBuilder.resetActiveFilters();
    }
    initDataPagination() {
        this.documentList.pagination
            .pipe(takeUntil(this.onDestroy$))
            .subscribe((newPagination) => {
            this.searchFilterQueryBuilder.setupCurrentPagination(newPagination.maxItems, newPagination.skipCount);
        });
    }
    initDataSorting() {
        this.documentList.sortingSubject
            .pipe(takeUntil(this.onDestroy$))
            .subscribe((sorting) => {
            this.searchFilterQueryBuilder.setSorting(sorting);
        });
    }
    configureSearchParent(currentFolderId) {
        if (this.searchFilterQueryBuilder.isCustomSourceNode(currentFolderId)) {
            this.searchFilterQueryBuilder.getNodeIdForCustomSource(currentFolderId).subscribe((node) => {
                this.initSearchHeader(node.id);
            });
        }
        else {
            this.initSearchHeader(currentFolderId);
        }
    }
    initSearchHeader(currentFolderId) {
        this.searchFilterQueryBuilder.setCurrentRootFolderId(currentFolderId);
        if (this.value) {
            Object.keys(this.value).forEach((columnKey) => {
                this.searchFilterQueryBuilder.setActiveFilter(columnKey, this.value[columnKey]);
            });
        }
    }
    ngOnDestroy() {
        this.onDestroy$.next(true);
        this.onDestroy$.complete();
    }
}
FilterHeaderComponent.ɵfac = function FilterHeaderComponent_Factory(t) { return new (t || FilterHeaderComponent)(ɵngcc0.ɵɵdirectiveInject(DocumentListComponent), ɵngcc0.ɵɵdirectiveInject(SEARCH_QUERY_SERVICE_TOKEN)); };
FilterHeaderComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: FilterHeaderComponent, selectors: [["adf-filter-header"]], inputs: { value: "value", currentFolderId: "currentFolderId" }, outputs: { filterSelection: "filterSelection" }, features: [ɵngcc0.ɵɵProvidersFeature([{ provide: SEARCH_QUERY_SERVICE_TOKEN, useClass: SearchHeaderQueryBuilderService }]), ɵngcc0.ɵɵNgOnChangesFeature], decls: 1, vars: 1, consts: [[4, "ngIf"], [3, "col", "value", "filterChange"]], template: function FilterHeaderComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵtemplate(0, FilterHeaderComponent_div_0_Template, 3, 0, "div", 0);
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("ngIf", ctx.isFilterServiceActive);
    } }, directives: [ɵngcc1.NgIf, ɵngcc2.HeaderFilterTemplateDirective, ɵngcc3.SearchFilterContainerComponent], encapsulation: 2 });
FilterHeaderComponent.ctorParameters = () => [
    { type: DocumentListComponent, decorators: [{ type: Inject, args: [DocumentListComponent,] }] },
    { type: SearchHeaderQueryBuilderService, decorators: [{ type: Inject, args: [SEARCH_QUERY_SERVICE_TOKEN,] }] }
];
FilterHeaderComponent.propDecorators = {
    value: [{ type: Input }],
    currentFolderId: [{ type: Input }],
    filterSelection: [{ type: Output }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(FilterHeaderComponent, [{
        type: Component,
        args: [{
                selector: 'adf-filter-header',
                template: "<div *ngIf=\"isFilterServiceActive\">\n    <adf-header-filter-template>\n        <ng-template let-col>\n            <adf-search-filter-container [col]=\"col\"\n                                         [value]=\"value\"\n                                         (filterChange)=\"onFilterSelectionChange()\">\n            </adf-search-filter-container>\n        </ng-template>\n    </adf-header-filter-template>\n</div>\n",
                providers: [{ provide: SEARCH_QUERY_SERVICE_TOKEN, useClass: SearchHeaderQueryBuilderService }]
            }]
    }], function () { return [{ type: ɵngcc4.DocumentListComponent, decorators: [{
                type: Inject,
                args: [DocumentListComponent]
            }] }, { type: ɵngcc5.SearchHeaderQueryBuilderService, decorators: [{
                type: Inject,
                args: [SEARCH_QUERY_SERVICE_TOKEN]
            }] }]; }, { value: [{
            type: Input
        }], filterSelection: [{
            type: Output
        }], currentFolderId: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyLWhlYWRlci5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb250ZW50LXNlcnZpY2VzL3NyYy9saWIvZG9jdW1lbnQtbGlzdC9jb21wb25lbnRzL2ZpbHRlci1oZWFkZXIvZmlsdGVyLWhlYWRlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUVILE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFvQyxLQUFLLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVqSCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSw0Q0FBNEMsQ0FBQztBQUN4RixPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSw4REFBOEQsQ0FBQztBQUUvRyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQVEzQyxNQUFNLE9BQU8scUJBQXFCO0FBQUcsSUFpQmpDLFlBQW1ELFlBQW1DLEVBQzlCLHdCQUF5RDtBQUNySCxRQUZ1RCxpQkFBWSxHQUFaLFlBQVksQ0FBdUI7QUFBQyxRQUMvQiw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQWlDO0FBQUMsUUFkbEgsVUFBSyxHQUFRLEVBQUUsQ0FBQztBQUNwQixRQU9JLG9CQUFlLEdBQWlDLElBQUksWUFBWSxFQUFFLENBQUM7QUFDdkUsUUFFWSxl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TSxTQUFDLDBCQUEwQjtBQUFRO0FBQUc7QUFBeUMsb0JBZmpHLEtBQUs7QUFDUiw4QkFHRyxLQUFLO0FBQ1IsOEJBR0csTUFBTTtBQUNWOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgQ29tcG9uZW50LCBJbmplY3QsIE9uSW5pdCwgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzLCBJbnB1dCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFBhZ2luYXRpb25Nb2RlbCwgRGF0YVNvcnRpbmcgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgRG9jdW1lbnRMaXN0Q29tcG9uZW50IH0gZnJvbSAnLi4vZG9jdW1lbnQtbGlzdC5jb21wb25lbnQnO1xuaW1wb3J0IHsgU0VBUkNIX1FVRVJZX1NFUlZJQ0VfVE9LRU4gfSBmcm9tICcuLi8uLi8uLi9zZWFyY2gvc2VhcmNoLXF1ZXJ5LXNlcnZpY2UudG9rZW4nO1xuaW1wb3J0IHsgU2VhcmNoSGVhZGVyUXVlcnlCdWlsZGVyU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlYXJjaC9zZXJ2aWNlcy9zZWFyY2gtaGVhZGVyLXF1ZXJ5LWJ1aWxkZXIuc2VydmljZSc7XG5pbXBvcnQgeyBGaWx0ZXJTZWFyY2ggfSBmcm9tICcuLy4uLy4uLy4uL3NlYXJjaC9tb2RlbHMvZmlsdGVyLXNlYXJjaC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTm9kZVBhZ2luZywgTWluaW1hbE5vZGUgfSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdhZGYtZmlsdGVyLWhlYWRlcicsXG4gICAgdGVtcGxhdGVVcmw6ICcuL2ZpbHRlci1oZWFkZXIuY29tcG9uZW50Lmh0bWwnLFxuICAgIHByb3ZpZGVyczogW3sgcHJvdmlkZTogU0VBUkNIX1FVRVJZX1NFUlZJQ0VfVE9LRU4sIHVzZUNsYXNzOiBTZWFyY2hIZWFkZXJRdWVyeUJ1aWxkZXJTZXJ2aWNlfV1cbn0pXG5leHBvcnQgY2xhc3MgRmlsdGVySGVhZGVyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMge1xuXG4gICAgLyoqIChvcHRpb25hbCkgSW5pdGlhbCBmaWx0ZXIgdmFsdWUgdG8gc29ydCAuICovXG4gICAgQElucHV0KClcbiAgICB2YWx1ZTogYW55ID0ge307XG5cbiAgICAvKiogVGhlIGlkIG9mIHRoZSBjdXJyZW50IGZvbGRlciBvZiB0aGUgZG9jdW1lbnQgbGlzdC4gKi9cbiAgICBASW5wdXQoKVxuICAgIGN1cnJlbnRGb2xkZXJJZDogc3RyaW5nO1xuXG4gICAgLyoqIEVtaXR0ZWQgd2hlbiBhIGZpbHRlciB2YWx1ZSBpcyBzZWxlY3RlZCAqL1xuICAgIEBPdXRwdXQoKVxuICAgIGZpbHRlclNlbGVjdGlvbjogRXZlbnRFbWl0dGVyPEZpbHRlclNlYXJjaFtdPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAgIGlzRmlsdGVyU2VydmljZUFjdGl2ZTogYm9vbGVhbjtcbiAgICBwcml2YXRlIG9uRGVzdHJveSQgPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xuXG4gICAgY29uc3RydWN0b3IoQEluamVjdChEb2N1bWVudExpc3RDb21wb25lbnQpIHByaXZhdGUgZG9jdW1lbnRMaXN0OiBEb2N1bWVudExpc3RDb21wb25lbnQsXG4gICAgICAgICAgICAgICAgQEluamVjdChTRUFSQ0hfUVVFUllfU0VSVklDRV9UT0tFTikgcHJpdmF0ZSBzZWFyY2hGaWx0ZXJRdWVyeUJ1aWxkZXI6IFNlYXJjaEhlYWRlclF1ZXJ5QnVpbGRlclNlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5pc0ZpbHRlclNlcnZpY2VBY3RpdmUgPSB0aGlzLnNlYXJjaEZpbHRlclF1ZXJ5QnVpbGRlci5pc0ZpbHRlclNlcnZpY2VBY3RpdmUoKTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgdGhpcy5zZWFyY2hGaWx0ZXJRdWVyeUJ1aWxkZXIuZXhlY3V0ZWRcbiAgICAgICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLm9uRGVzdHJveSQpKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgobmV3Tm9kZVBhZ2luZzogTm9kZVBhZ2luZykgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZG9jdW1lbnRMaXN0Lm5vZGUgPSBuZXdOb2RlUGFnaW5nO1xuICAgICAgICAgICAgICAgIHRoaXMuZG9jdW1lbnRMaXN0LnJlbG9hZCgpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5pbml0RGF0YVBhZ2luYXRpb24oKTtcbiAgICAgICAgdGhpcy5pbml0RGF0YVNvcnRpbmcoKTtcbiAgICB9XG5cbiAgICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgICAgIGlmIChjaGFuZ2VzWydjdXJyZW50Rm9sZGVySWQnXSAmJiBjaGFuZ2VzWydjdXJyZW50Rm9sZGVySWQnXS5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMucmVzZXRGaWx0ZXJIZWFkZXIoKTtcbiAgICAgICAgICAgIHRoaXMuY29uZmlndXJlU2VhcmNoUGFyZW50KGNoYW5nZXNbJ2N1cnJlbnRGb2xkZXJJZCddLmN1cnJlbnRWYWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvbkZpbHRlclNlbGVjdGlvbkNoYW5nZSgpIHtcbiAgICAgICAgdGhpcy5maWx0ZXJTZWxlY3Rpb24uZW1pdCh0aGlzLnNlYXJjaEZpbHRlclF1ZXJ5QnVpbGRlci5nZXRBY3RpdmVGaWx0ZXJzKCkpO1xuICAgICAgICBpZiAodGhpcy5zZWFyY2hGaWx0ZXJRdWVyeUJ1aWxkZXIuaXNOb0ZpbHRlckFjdGl2ZSgpKSB7XG4gICAgICAgICAgICB0aGlzLmRvY3VtZW50TGlzdC5ub2RlID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMuZG9jdW1lbnRMaXN0LnJlbG9hZCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVzZXRGaWx0ZXJIZWFkZXIoKSB7XG4gICAgICAgIHRoaXMuc2VhcmNoRmlsdGVyUXVlcnlCdWlsZGVyLnJlc2V0QWN0aXZlRmlsdGVycygpO1xuICAgIH1cblxuICAgIGluaXREYXRhUGFnaW5hdGlvbigpIHtcbiAgICAgICAgdGhpcy5kb2N1bWVudExpc3QucGFnaW5hdGlvblxuICAgICAgICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMub25EZXN0cm95JCkpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKChuZXdQYWdpbmF0aW9uOiBQYWdpbmF0aW9uTW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaEZpbHRlclF1ZXJ5QnVpbGRlci5zZXR1cEN1cnJlbnRQYWdpbmF0aW9uKG5ld1BhZ2luYXRpb24ubWF4SXRlbXMsIG5ld1BhZ2luYXRpb24uc2tpcENvdW50KTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIGluaXREYXRhU29ydGluZygpIHtcbiAgICAgICAgdGhpcy5kb2N1bWVudExpc3Quc29ydGluZ1N1YmplY3RcbiAgICAgICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLm9uRGVzdHJveSQpKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgoc29ydGluZzogRGF0YVNvcnRpbmdbXSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoRmlsdGVyUXVlcnlCdWlsZGVyLnNldFNvcnRpbmcoc29ydGluZyk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbmZpZ3VyZVNlYXJjaFBhcmVudChjdXJyZW50Rm9sZGVySWQ6IHN0cmluZykge1xuICAgICAgICBpZiAodGhpcy5zZWFyY2hGaWx0ZXJRdWVyeUJ1aWxkZXIuaXNDdXN0b21Tb3VyY2VOb2RlKGN1cnJlbnRGb2xkZXJJZCkpIHtcbiAgICAgICAgICAgIHRoaXMuc2VhcmNoRmlsdGVyUXVlcnlCdWlsZGVyLmdldE5vZGVJZEZvckN1c3RvbVNvdXJjZShjdXJyZW50Rm9sZGVySWQpLnN1YnNjcmliZSgobm9kZTogTWluaW1hbE5vZGUpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmluaXRTZWFyY2hIZWFkZXIobm9kZS5pZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdFNlYXJjaEhlYWRlcihjdXJyZW50Rm9sZGVySWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0U2VhcmNoSGVhZGVyKGN1cnJlbnRGb2xkZXJJZDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuc2VhcmNoRmlsdGVyUXVlcnlCdWlsZGVyLnNldEN1cnJlbnRSb290Rm9sZGVySWQoY3VycmVudEZvbGRlcklkKTtcbiAgICAgICAgaWYgKHRoaXMudmFsdWUpIHtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKHRoaXMudmFsdWUpLmZvckVhY2goKGNvbHVtbktleSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoRmlsdGVyUXVlcnlCdWlsZGVyLnNldEFjdGl2ZUZpbHRlcihjb2x1bW5LZXksIHRoaXMudmFsdWVbY29sdW1uS2V5XSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMub25EZXN0cm95JC5uZXh0KHRydWUpO1xuICAgICAgICB0aGlzLm9uRGVzdHJveSQuY29tcGxldGUoKTtcbiAgICB9XG59XG4iXX0=