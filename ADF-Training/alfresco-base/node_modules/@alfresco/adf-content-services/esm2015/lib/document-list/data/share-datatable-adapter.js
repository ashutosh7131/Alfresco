/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { DataSorting } from '@alfresco/adf-core';
import { ShareDataRow } from './share-data-row.model';
export class ShareDataTableAdapter {
    constructor(thumbnailService, contentService, schema = [], sorting, sortingMode = 'client', allowDropFiles = false) {
        this.thumbnailService = thumbnailService;
        this.contentService = contentService;
        this.ERR_ROW_NOT_FOUND = 'Row not found';
        this.ERR_COL_NOT_FOUND = 'Column not found';
        this.thumbnails = false;
        this.rows = [];
        this.columns = schema || [];
        this.sorting = sorting;
        this.sortingMode = sortingMode;
        this.allowDropFiles = allowDropFiles;
    }
    set sortingMode(value) {
        let newValue = (value || 'client').toLowerCase();
        if (newValue !== 'client' && newValue !== 'server') {
            newValue = 'client';
        }
        this._sortingMode = newValue;
    }
    get sortingMode() {
        return this._sortingMode;
    }
    getRows() {
        return this.rows;
    }
    setRows(rows) {
        this.rows = rows || [];
        this.sort();
    }
    getColumns() {
        return this.columns;
    }
    setColumns(columns) {
        this.columns = columns || [];
    }
    getValue(row, col) {
        if (!row) {
            throw new Error(this.ERR_ROW_NOT_FOUND);
        }
        if (!col) {
            throw new Error(this.ERR_COL_NOT_FOUND);
        }
        const dataRow = row;
        const value = row.getValue(col.key);
        if (dataRow.cache[col.key] !== undefined) {
            return dataRow.cache[col.key];
        }
        if (col.key === '$thumbnail') {
            if (this.imageResolver) {
                const resolved = this.imageResolver(row, col);
                if (resolved) {
                    return resolved;
                }
            }
            const node = row.node;
            if (node.entry.isFolder) {
                return this.getFolderIcon(node);
            }
            if (node.entry.isFile) {
                if (this.thumbnails) {
                    return this.thumbnailService.getDocumentThumbnailUrl(node);
                }
            }
            if (node.entry.content) {
                const mimeType = node.entry.content.mimeType;
                if (mimeType) {
                    return this.thumbnailService.getMimeTypeIcon(mimeType);
                }
            }
            return this.thumbnailService.getDefaultMimeTypeIcon();
        }
        if (col.type === 'image') {
            if (this.imageResolver) {
                const resolved = this.imageResolver(row, col);
                if (resolved) {
                    return resolved;
                }
            }
        }
        return dataRow.cacheValue(col.key, value);
    }
    getSorting() {
        return this.sorting;
    }
    setSorting(sorting) {
        this.sorting = sorting;
        this.sortRows(this.rows, this.sorting);
    }
    sort(key, direction) {
        const sorting = this.sorting || new DataSorting();
        if (key) {
            sorting.key = key;
            sorting.direction = direction || 'asc';
        }
        this.setSorting(sorting);
    }
    setFilter(filter) {
        this.filter = filter;
    }
    setImageResolver(resolver) {
        this.imageResolver = resolver;
    }
    getFolderIcon(node) {
        if (this.isSmartFolder(node)) {
            return this.thumbnailService.getMimeTypeIcon('smartFolder');
        }
        else if (this.isRuleFolder(node)) {
            return this.thumbnailService.getMimeTypeIcon('ruleFolder');
        }
        else if (this.isALinkFolder(node)) {
            return this.thumbnailService.getMimeTypeIcon('linkFolder');
        }
        else {
            return this.thumbnailService.getMimeTypeIcon('folder');
        }
    }
    isSmartFolder(node) {
        const nodeAspects = this.getNodeAspectNames(node);
        return nodeAspects.indexOf('smf:customConfigSmartFolder') > -1 ||
            (nodeAspects.indexOf('smf:systemConfigSmartFolder') > -1);
    }
    isRuleFolder(node) {
        const nodeAspects = this.getNodeAspectNames(node);
        return nodeAspects.indexOf('rule:rules') > -1 ||
            (nodeAspects.indexOf('rule:rules') > -1);
    }
    isALinkFolder(node) {
        const nodeType = node.entry ? node.entry.nodeType : node.nodeType;
        return nodeType === 'app:folderlink';
    }
    getNodeAspectNames(node) {
        var _a;
        return ((_a = node.entry) === null || _a === void 0 ? void 0 : _a.aspectNames) ? node.entry.aspectNames : (node.aspectNames ? node.aspectNames : []);
    }
    sortRows(rows, sorting) {
        if (this.sortingMode === 'server') {
            return;
        }
        const options = {};
        if ((sorting === null || sorting === void 0 ? void 0 : sorting.key) && (rows === null || rows === void 0 ? void 0 : rows.length)) {
            if (sorting.key.includes('sizeInBytes') || sorting.key === 'name') {
                options.numeric = true;
            }
            rows.sort((a, b) => {
                if (a.node.entry.isFolder !== b.node.entry.isFolder) {
                    return a.node.entry.isFolder ? -1 : 1;
                }
                let left = a.getValue(sorting.key);
                if (left) {
                    left = (left instanceof Date) ? left.valueOf().toString() : left.toString();
                }
                else {
                    left = '';
                }
                let right = b.getValue(sorting.key);
                if (right) {
                    right = (right instanceof Date) ? right.valueOf().toString() : right.toString();
                }
                else {
                    right = '';
                }
                return sorting.direction === 'asc'
                    ? left.localeCompare(right, undefined, options)
                    : right.localeCompare(left, undefined, options);
            });
        }
    }
    loadPage(nodePaging, merge = false, allowDropFiles) {
        var _a;
        let shareDataRows = [];
        if (allowDropFiles !== undefined) {
            this.allowDropFiles = allowDropFiles;
        }
        if (nodePaging === null || nodePaging === void 0 ? void 0 : nodePaging.list) {
            const nodeEntries = nodePaging.list.entries;
            if (nodeEntries === null || nodeEntries === void 0 ? void 0 : nodeEntries.length) {
                shareDataRows = nodeEntries.map((item) => new ShareDataRow(item, this.contentService, this.permissionsStyle, this.thumbnailService, this.allowDropFiles));
                if (this.filter) {
                    shareDataRows = shareDataRows.filter(this.filter);
                }
                if (this.sortingMode !== 'server') {
                    if ((_a = this.columns) === null || _a === void 0 ? void 0 : _a.length) {
                        const sorting = this.getSorting();
                        if (sorting) {
                            this.sortRows(shareDataRows, sorting);
                        }
                        else {
                            const sortable = this.columns.filter((c) => c.sortable);
                            if (sortable.length > 0) {
                                this.sort(sortable[0].key, 'asc');
                            }
                            else {
                                this.sort(this.columns[0].key, 'asc');
                            }
                        }
                    }
                }
            }
        }
        if (merge) {
            const listPrunedDuplicate = shareDataRows.filter((elementToFilter) => {
                const isPresent = this.rows.find((currentRow) => {
                    return currentRow.obj.entry.id === elementToFilter.obj.entry.id;
                });
                return !isPresent;
            });
            this.rows = this.rows.concat(listPrunedDuplicate);
        }
        else {
            this.rows = shareDataRows;
        }
    }
    getSelectedRows() {
        return this.rows.filter((row) => row.isSelected);
    }
    getRowByNodeId(nodeId) {
        return this.rows.find((row) => row.node.entry.id === nodeId);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcmUtZGF0YXRhYmxlLWFkYXB0ZXIuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb250ZW50LXNlcnZpY2VzL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9kb2N1bWVudC1saXN0L2RhdGEvc2hhcmUtZGF0YXRhYmxlLWFkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7OztHQWVHO0FBRUgsT0FBTyxFQUdILFdBQVcsRUFJZCxNQUFNLG9CQUFvQixDQUFDO0FBRzVCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUd0RCxNQUFNLE9BQU8scUJBQXFCO0lBOEI5QixZQUFvQixnQkFBa0MsRUFDbEMsY0FBOEIsRUFDdEMsU0FBdUIsRUFBRSxFQUN6QixPQUFxQixFQUNyQixjQUFzQixRQUFRLEVBQzlCLGlCQUEwQixLQUFLO1FBTHZCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBN0JsRCxzQkFBaUIsR0FBVyxlQUFlLENBQUM7UUFDNUMsc0JBQWlCLEdBQVcsa0JBQWtCLENBQUM7UUFVL0MsZUFBVSxHQUFZLEtBQUssQ0FBQztRQXVCeEIsSUFBSSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sSUFBSSxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFDL0IsSUFBSSxDQUFDLGNBQWMsR0FBRyxjQUFjLENBQUM7SUFDekMsQ0FBQztJQXZCRCxJQUFJLFdBQVcsQ0FBQyxLQUFhO1FBQ3pCLElBQUksUUFBUSxHQUFHLENBQUMsS0FBSyxJQUFJLFFBQVEsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ2pE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U0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsVUFBZSxFQUFFLEVBQUU7b0JBQ2pELE9BQU8sVUFBVSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxLQUFLLGVBQWUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDcEUsQ0FBQyxDQUFDLENBQUM7Z0JBRUgsT0FBTyxDQUFDLFNBQVMsQ0FBQztZQUN0QixDQUFDLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQztTQUNyRDthQUFNO1lBQ0gsSUFBSSxDQUFDLElBQUksR0FBRyxhQUFhLENBQUM7U0FDN0I7SUFDTCxDQUFDO0lBRUQsZUFBZTtRQUNYLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFZLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBRUQsY0FBYyxDQUFDLE1BQWM7UUFDMUIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQVksRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxLQUFLLE1BQU0sQ0FBQyxDQUFDO0lBQ3pFLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7XG4gICAgRGF0YUNvbHVtbixcbiAgICBEYXRhUm93LFxuICAgIERhdGFTb3J0aW5nLFxuICAgIERhdGFUYWJsZUFkYXB0ZXIsXG4gICAgVGh1bWJuYWlsU2VydmljZSxcbiAgICBDb250ZW50U2VydmljZVxufSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgTm9kZVBhZ2luZywgTm9kZUVudHJ5IH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBQZXJtaXNzaW9uU3R5bGVNb2RlbCB9IGZyb20gJy4vLi4vbW9kZWxzL3Blcm1pc3Npb25zLXN0eWxlLm1vZGVsJztcbmltcG9ydCB7IFNoYXJlRGF0YVJvdyB9IGZyb20gJy4vc2hhcmUtZGF0YS1yb3cubW9kZWwnO1xuaW1wb3J0IHsgUm93RmlsdGVyIH0gZnJvbSAnLi9yb3ctZmlsdGVyLm1vZGVsJztcblxuZXhwb3J0IGNsYXNzIFNoYXJlRGF0YVRhYmxlQWRhcHRlciBpbXBsZW1lbnRzIERhdGFUYWJsZUFkYXB0ZXIge1xuXG4gICAgRVJSX1JPV19OT1RfRk9VTkQ6IHN0cmluZyA9ICdSb3cgbm90IGZvdW5kJztcbiAgICBFUlJfQ09MX05PVF9GT1VORDogc3RyaW5nID0gJ0NvbHVtbiBub3QgZm91bmQnO1xuXG4gICAgcHJpdmF0ZSBfc29ydGluZ01vZGU6IHN0cmluZztcbiAgICBwcml2YXRlIHNvcnRpbmc6IERhdGFTb3J0aW5nO1xuICAgIHByaXZhdGUgcm93czogRGF0YVJvd1tdO1xuICAgIHByaXZhdGUgY29sdW1uczogRGF0YUNvbHVtbltdO1xuXG4gICAgcHJpdmF0ZSBmaWx0ZXI6IFJvd0ZpbHRlcjtcbiAgICBwcml2YXRlIGltYWdlUmVzb2x2ZXI6IGFueTtcblxuICAgIHRodW1ibmFpbHM6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBwZXJtaXNzaW9uc1N0eWxlOiBQZXJtaXNzaW9uU3R5bGVNb2RlbFtdO1xuICAgIHNlbGVjdGVkUm93OiBEYXRhUm93O1xuICAgIGFsbG93RHJvcEZpbGVzOiBib29sZWFuO1xuXG4gICAgc2V0IHNvcnRpbmdNb2RlKHZhbHVlOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IG5ld1ZhbHVlID0gKHZhbHVlIHx8ICdjbGllbnQnKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBpZiAobmV3VmFsdWUgIT09ICdjbGllbnQnICYmIG5ld1ZhbHVlICE9PSAnc2VydmVyJykge1xuICAgICAgICAgICAgbmV3VmFsdWUgPSAnY2xpZW50JztcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9zb3J0aW5nTW9kZSA9IG5ld1ZhbHVlO1xuICAgIH1cblxuICAgIGdldCBzb3J0aW5nTW9kZSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fc29ydGluZ01vZGU7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSB0aHVtYm5haWxTZXJ2aWNlOiBUaHVtYm5haWxTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgY29udGVudFNlcnZpY2U6IENvbnRlbnRTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHNjaGVtYTogRGF0YUNvbHVtbltdID0gW10sXG4gICAgICAgICAgICAgICAgc29ydGluZz86IERhdGFTb3J0aW5nLFxuICAgICAgICAgICAgICAgIHNvcnRpbmdNb2RlOiBzdHJpbmcgPSAnY2xpZW50JyxcbiAgICAgICAgICAgICAgICBhbGxvd0Ryb3BGaWxlczogYm9vbGVhbiA9IGZhbHNlKSB7XG4gICAgICAgIHRoaXMucm93cyA9IFtdO1xuICAgICAgICB0aGlzLmNvbHVtbnMgPSBzY2hlbWEgfHwgW107XG4gICAgICAgIHRoaXMuc29ydGluZyA9IHNvcnRpbmc7XG4gICAgICAgIHRoaXMuc29ydGluZ01vZGUgPSBzb3J0aW5nTW9kZTtcbiAgICAgICAgdGhpcy5hbGxvd0Ryb3BGaWxlcyA9IGFsbG93RHJvcEZpbGVzO1xuICAgIH1cblxuICAgIGdldFJvd3MoKTogQXJyYXk8RGF0YVJvdz4ge1xuICAgICAgICByZXR1cm4gdGhpcy5yb3dzO1xuICAgIH1cblxuICAgIC8vIFRPRE86IGRpc2FibGUgdGhpcyBhcGlcbiAgICBzZXRSb3dzKHJvd3M6IEFycmF5PERhdGFSb3c+KSB7XG4gICAgICAgIHRoaXMucm93cyA9IHJvd3MgfHwgW107XG4gICAgICAgIHRoaXMuc29ydCgpO1xuICAgIH1cblxuICAgIGdldENvbHVtbnMoKTogQXJyYXk8RGF0YUNvbHVtbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jb2x1bW5zO1xuICAgIH1cblxuICAgIHNldENvbHVtbnMoY29sdW1uczogQXJyYXk8RGF0YUNvbHVtbj4pIHtcbiAgICAgICAgdGhpcy5jb2x1bW5zID0gY29sdW1ucyB8fCBbXTtcbiAgICB9XG5cbiAgICBnZXRWYWx1ZShyb3c6IERhdGFSb3csIGNvbDogRGF0YUNvbHVtbik6IGFueSB7XG4gICAgICAgIGlmICghcm93KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IodGhpcy5FUlJfUk9XX05PVF9GT1VORCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFjb2wpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcih0aGlzLkVSUl9DT0xfTk9UX0ZPVU5EKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBkYXRhUm93OiBTaGFyZURhdGFSb3cgPSA8U2hhcmVEYXRhUm93PiByb3c7XG4gICAgICAgIGNvbnN0IHZhbHVlOiBhbnkgPSByb3cuZ2V0VmFsdWUoY29sLmtleSk7XG4gICAgICAgIGlmIChkYXRhUm93LmNhY2hlW2NvbC5rZXldICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBkYXRhUm93LmNhY2hlW2NvbC5rZXldO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbC5rZXkgPT09ICckdGh1bWJuYWlsJykge1xuXG4gICAgICAgICAgICBpZiAodGhpcy5pbWFnZVJlc29sdmVyKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSB0aGlzLmltYWdlUmVzb2x2ZXIocm93LCBjb2wpO1xuICAgICAgICAgICAgICAgIGlmIChyZXNvbHZlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBub2RlID0gKDxTaGFyZURhdGFSb3c+IHJvdykubm9kZTtcblxuICAgICAgICAgICAgaWYgKG5vZGUuZW50cnkuaXNGb2xkZXIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRGb2xkZXJJY29uKG5vZGUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAobm9kZS5lbnRyeS5pc0ZpbGUpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy50aHVtYm5haWxzKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnRodW1ibmFpbFNlcnZpY2UuZ2V0RG9jdW1lbnRUaHVtYm5haWxVcmwobm9kZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAobm9kZS5lbnRyeS5jb250ZW50KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbWltZVR5cGUgPSBub2RlLmVudHJ5LmNvbnRlbnQubWltZVR5cGU7XG4gICAgICAgICAgICAgICAgaWYgKG1pbWVUeXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnRodW1ibmFpbFNlcnZpY2UuZ2V0TWltZVR5cGVJY29uKG1pbWVUeXBlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRodW1ibmFpbFNlcnZpY2UuZ2V0RGVmYXVsdE1pbWVUeXBlSWNvbigpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbC50eXBlID09PSAnaW1hZ2UnKSB7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmltYWdlUmVzb2x2ZXIpIHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXNvbHZlZCA9IHRoaXMuaW1hZ2VSZXNvbHZlcihyb3csIGNvbCk7XG4gICAgICAgICAgICAgICAgaWYgKHJlc29sdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZGF0YVJvdy5jYWNoZVZhbHVlKGNvbC5rZXksIHZhbHVlKTtcbiAgICB9XG5cbiAgICBnZXRTb3J0aW5nKCk6IERhdGFTb3J0aW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc29ydGluZztcbiAgICB9XG5cbiAgICBzZXRTb3J0aW5nKHNvcnRpbmc6IERhdGFTb3J0aW5nKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc29ydGluZyA9IHNvcnRpbmc7XG5cbiAgICAgICAgdGhpcy5zb3J0Um93cyh0aGlzLnJvd3MsIHRoaXMuc29ydGluZyk7XG4gICAgfVxuXG4gICAgc29ydChrZXk/OiBzdHJpbmcsIGRpcmVjdGlvbj86IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBjb25zdCBzb3J0aW5nID0gdGhpcy5zb3J0aW5nIHx8IG5ldyBEYXRhU29ydGluZygpO1xuICAgICAgICBpZiAoa2V5KSB7XG4gICAgICAgICAgICBzb3J0aW5nLmtleSA9IGtleTtcbiAgICAgICAgICAgIHNvcnRpbmcuZGlyZWN0aW9uID0gZGlyZWN0aW9uIHx8ICdhc2MnO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0U29ydGluZyhzb3J0aW5nKTtcbiAgICB9XG5cbiAgICBzZXRGaWx0ZXIoZmlsdGVyOiBSb3dGaWx0ZXIpIHtcbiAgICAgICAgdGhpcy5maWx0ZXIgPSBmaWx0ZXI7XG4gICAgfVxuXG4gICAgc2V0SW1hZ2VSZXNvbHZlcihyZXNvbHZlcjogYW55KSB7XG4gICAgICAgIHRoaXMuaW1hZ2VSZXNvbHZlciA9IHJlc29sdmVyO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Rm9sZGVySWNvbihub2RlOiBhbnkpIHtcbiAgICAgICAgaWYgKHRoaXMuaXNTbWFydEZvbGRlcihub2RlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMudGh1bWJuYWlsU2VydmljZS5nZXRNaW1lVHlwZUljb24oJ3NtYXJ0Rm9sZGVyJyk7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc1J1bGVGb2xkZXIobm9kZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRodW1ibmFpbFNlcnZpY2UuZ2V0TWltZVR5cGVJY29uKCdydWxlRm9sZGVyJyk7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0FMaW5rRm9sZGVyKG5vZGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy50aHVtYm5haWxTZXJ2aWNlLmdldE1pbWVUeXBlSWNvbignbGlua0ZvbGRlcicpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMudGh1bWJuYWlsU2VydmljZS5nZXRNaW1lVHlwZUljb24oJ2ZvbGRlcicpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaXNTbWFydEZvbGRlcihub2RlOiBhbnkpIHtcbiAgICAgICAgY29uc3Qgbm9kZUFzcGVjdHMgPSB0aGlzLmdldE5vZGVBc3BlY3ROYW1lcyhub2RlKTtcbiAgICAgICAgcmV0dXJuIG5vZGVBc3BlY3RzLmluZGV4T2YoJ3NtZjpjdXN0b21Db25maWdTbWFydEZvbGRlcicpID4gLTEgfHxcbiAgICAgICAgICAgIChub2RlQXNwZWN0cy5pbmRleE9mKCdzbWY6c3lzdGVtQ29uZmlnU21hcnRGb2xkZXInKSA+IC0xKTtcbiAgICB9XG5cbiAgICBpc1J1bGVGb2xkZXIobm9kZTogYW55KSB7XG4gICAgICAgIGNvbnN0IG5vZGVBc3BlY3RzID0gdGhpcy5nZXROb2RlQXNwZWN0TmFtZXMobm9kZSk7XG4gICAgICAgIHJldHVybiBub2RlQXNwZWN0cy5pbmRleE9mKCdydWxlOnJ1bGVzJykgPiAtMSB8fFxuICAgICAgICAgICAgKG5vZGVBc3BlY3RzLmluZGV4T2YoJ3J1bGU6cnVsZXMnKSA+IC0xKTtcbiAgICB9XG5cbiAgICBpc0FMaW5rRm9sZGVyKG5vZGU6IGFueSkge1xuICAgICAgICBjb25zdCBub2RlVHlwZSA9IG5vZGUuZW50cnkgPyBub2RlLmVudHJ5Lm5vZGVUeXBlIDogbm9kZS5ub2RlVHlwZTtcbiAgICAgICAgcmV0dXJuIG5vZGVUeXBlID09PSAnYXBwOmZvbGRlcmxpbmsnO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Tm9kZUFzcGVjdE5hbWVzKG5vZGU6IGFueSk6IGFueVtdIHtcbiAgICAgICAgcmV0dXJuIG5vZGUuZW50cnk/LmFzcGVjdE5hbWVzID8gbm9kZS5lbnRyeS5hc3BlY3ROYW1lcyA6IChub2RlLmFzcGVjdE5hbWVzID8gbm9kZS5hc3BlY3ROYW1lcyA6IFtdKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNvcnRSb3dzKHJvd3M6IERhdGFSb3dbXSwgc29ydGluZzogRGF0YVNvcnRpbmcpIHtcbiAgICAgICAgaWYgKHRoaXMuc29ydGluZ01vZGUgPT09ICdzZXJ2ZXInKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBvcHRpb25zOiBJbnRsLkNvbGxhdG9yT3B0aW9ucyA9IHt9O1xuXG4gICAgICAgIGlmIChzb3J0aW5nPy5rZXkgJiYgcm93cz8ubGVuZ3RoKSB7XG5cbiAgICAgICAgICAgIGlmIChzb3J0aW5nLmtleS5pbmNsdWRlcygnc2l6ZUluQnl0ZXMnKSB8fCBzb3J0aW5nLmtleSA9PT0gJ25hbWUnKSB7XG4gICAgICAgICAgICAgICAgb3B0aW9ucy5udW1lcmljID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcm93cy5zb3J0KChhOiBTaGFyZURhdGFSb3csIGI6IFNoYXJlRGF0YVJvdykgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChhLm5vZGUuZW50cnkuaXNGb2xkZXIgIT09IGIubm9kZS5lbnRyeS5pc0ZvbGRlcikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS5ub2RlLmVudHJ5LmlzRm9sZGVyID8gLTEgOiAxO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxldCBsZWZ0ID0gYS5nZXRWYWx1ZShzb3J0aW5nLmtleSk7XG4gICAgICAgICAgICAgICAgaWYgKGxlZnQpIHtcbiAgICAgICAgICAgICAgICAgICAgbGVmdCA9IChsZWZ0IGluc3RhbmNlb2YgRGF0ZSkgPyBsZWZ0LnZhbHVlT2YoKS50b1N0cmluZygpIDogbGVmdC50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxlZnQgPSAnJztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsZXQgcmlnaHQgPSBiLmdldFZhbHVlKHNvcnRpbmcua2V5KTtcbiAgICAgICAgICAgICAgICBpZiAocmlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmlnaHQgPSAocmlnaHQgaW5zdGFuY2VvZiBEYXRlKSA/IHJpZ2h0LnZhbHVlT2YoKS50b1N0cmluZygpIDogcmlnaHQudG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByaWdodCA9ICcnO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBzb3J0aW5nLmRpcmVjdGlvbiA9PT0gJ2FzYydcbiAgICAgICAgICAgICAgICAgICAgPyBsZWZ0LmxvY2FsZUNvbXBhcmUocmlnaHQsIHVuZGVmaW5lZCwgb3B0aW9ucylcbiAgICAgICAgICAgICAgICAgICAgOiByaWdodC5sb2NhbGVDb21wYXJlKGxlZnQsIHVuZGVmaW5lZCwgb3B0aW9ucyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBsb2FkUGFnZShub2RlUGFnaW5nOiBOb2RlUGFnaW5nLCBtZXJnZTogYm9vbGVhbiA9IGZhbHNlLCBhbGxvd0Ryb3BGaWxlcz86IGJvb2xlYW4pIHtcbiAgICAgICAgbGV0IHNoYXJlRGF0YVJvd3M6IFNoYXJlRGF0YVJvd1tdID0gW107XG4gICAgICAgIGlmIChhbGxvd0Ryb3BGaWxlcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLmFsbG93RHJvcEZpbGVzID0gYWxsb3dEcm9wRmlsZXM7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5vZGVQYWdpbmc/Lmxpc3QpIHtcbiAgICAgICAgICAgIGNvbnN0IG5vZGVFbnRyaWVzOiBOb2RlRW50cnlbXSA9IG5vZGVQYWdpbmcubGlzdC5lbnRyaWVzO1xuICAgICAgICAgICAgaWYgKG5vZGVFbnRyaWVzPy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBzaGFyZURhdGFSb3dzID0gbm9kZUVudHJpZXMubWFwKChpdGVtKSA9PiBuZXcgU2hhcmVEYXRhUm93KGl0ZW0sIHRoaXMuY29udGVudFNlcnZpY2UsIHRoaXMucGVybWlzc2lvbnNTdHlsZSwgdGhpcy50aHVtYm5haWxTZXJ2aWNlLCB0aGlzLmFsbG93RHJvcEZpbGVzKSk7XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5maWx0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgc2hhcmVEYXRhUm93cyA9IHNoYXJlRGF0YVJvd3MuZmlsdGVyKHRoaXMuZmlsdGVyKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zb3J0aW5nTW9kZSAhPT0gJ3NlcnZlcicpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gU29ydCBieSBmaXJzdCBzb3J0YWJsZSBvciBqdXN0IGZpcnN0IGNvbHVtblxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jb2x1bW5zPy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNvcnRpbmcgPSB0aGlzLmdldFNvcnRpbmcoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzb3J0aW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zb3J0Um93cyhzaGFyZURhdGFSb3dzLCBzb3J0aW5nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc29ydGFibGUgPSB0aGlzLmNvbHVtbnMuZmlsdGVyKChjKSA9PiBjLnNvcnRhYmxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc29ydGFibGUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNvcnQoc29ydGFibGVbMF0ua2V5LCAnYXNjJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zb3J0KHRoaXMuY29sdW1uc1swXS5rZXksICdhc2MnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobWVyZ2UpIHtcbiAgICAgICAgICAgIGNvbnN0IGxpc3RQcnVuZWREdXBsaWNhdGUgPSBzaGFyZURhdGFSb3dzLmZpbHRlcigoZWxlbWVudFRvRmlsdGVyOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBpc1ByZXNlbnQgPSB0aGlzLnJvd3MuZmluZCgoY3VycmVudFJvdzogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50Um93Lm9iai5lbnRyeS5pZCA9PT0gZWxlbWVudFRvRmlsdGVyLm9iai5lbnRyeS5pZDtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHJldHVybiAhaXNQcmVzZW50O1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMucm93cyA9IHRoaXMucm93cy5jb25jYXQobGlzdFBydW5lZER1cGxpY2F0ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnJvd3MgPSBzaGFyZURhdGFSb3dzO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0U2VsZWN0ZWRSb3dzKCk6IERhdGFSb3dbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJvd3MuZmlsdGVyKChyb3c6IERhdGFSb3cpID0+IHJvdy5pc1NlbGVjdGVkKTtcbiAgICB9XG5cbiAgICBnZXRSb3dCeU5vZGVJZChub2RlSWQ6IHN0cmluZyk6IERhdGFSb3cge1xuICAgICAgIHJldHVybiB0aGlzLnJvd3MuZmluZCgocm93OiBEYXRhUm93KSA9PiByb3cubm9kZS5lbnRyeS5pZCA9PT0gbm9kZUlkKTtcbiAgICB9XG59XG4iXX0=