import { Inject, Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { SEARCH_QUERY_SERVICE_TOKEN } from '../search-query-service.token';
import { SearchQueryBuilderService } from './search-query-builder.service';
import { SearchService, TranslationService } from '@alfresco/adf-core';
import { takeUntil } from 'rxjs/operators';
import { SearchFilterList } from '../models/search-filter-list.model';
import * as i0 from "@angular/core";
import * as i1 from "../search-query-service.token";
import * as i2 from "@alfresco/adf-core";
export class SearchFacetFiltersService {
    constructor(queryBuilder, searchService, translationService) {
        this.queryBuilder = queryBuilder;
        this.searchService = searchService;
        this.translationService = translationService;
        this.responseFacets = null;
        this.selectedBuckets = [];
        this.DEFAULT_PAGE_SIZE = 5;
        this.facetQueriesPageSize = this.DEFAULT_PAGE_SIZE;
        this.onDestroy$ = new Subject();
        if (queryBuilder.config && queryBuilder.config.facetQueries) {
            this.facetQueriesPageSize = queryBuilder.config.facetQueries.pageSize || this.DEFAULT_PAGE_SIZE;
        }
        this.queryBuilder.configUpdated
            .pipe(takeUntil(this.onDestroy$))
            .subscribe(() => {
            this.selectedBuckets = [];
            this.responseFacets = null;
        });
        this.queryBuilder.updated
            .pipe(takeUntil(this.onDestroy$))
            .subscribe((query) => this.queryBuilder.execute(query));
        this.queryBuilder.executed
            .pipe(takeUntil(this.onDestroy$))
            .subscribe((resultSetPaging) => {
            this.onDataLoaded(resultSetPaging);
            this.searchService.dataLoaded.next(resultSetPaging);
        });
    }
    onDataLoaded(data) {
        const context = data.list.context;
        if (context) {
            this.parseFacets(context);
        }
        else {
            this.responseFacets = null;
        }
    }
    parseFacets(context) {
        this.parseFacetFields(context);
        this.parseFacetIntervals(context);
        this.parseFacetQueries(context);
    }
    parseFacetItems(context, configFacetFields, itemType) {
        configFacetFields.forEach((field) => {
            const responseField = this.findFacet(context, itemType, field.label);
            const responseBuckets = this.getResponseBuckets(responseField, field)
                .filter(this.getFilterByMinCount(field.mincount));
            const alreadyExistingField = this.findResponseFacet(itemType, field.label);
            if (alreadyExistingField) {
                const alreadyExistingBuckets = alreadyExistingField.buckets && alreadyExistingField.buckets.items || [];
                this.updateExistingBuckets(responseField, responseBuckets, alreadyExistingField, alreadyExistingBuckets);
            }
            else if (responseField) {
                if (responseBuckets.length > 0) {
                    const bucketList = new SearchFilterList(responseBuckets, field.pageSize);
                    bucketList.filter = this.getBucketFilterFunction(bucketList);
                    if (!this.responseFacets) {
                        this.responseFacets = [];
                    }
                    this.responseFacets.push(Object.assign(Object.assign({}, field), { type: responseField.type || itemType, label: field.label, pageSize: field.pageSize | this.DEFAULT_PAGE_SIZE, currentPageSize: field.pageSize | this.DEFAULT_PAGE_SIZE, buckets: bucketList }));
                }
            }
        });
    }
    parseFacetFields(context) {
        const configFacetFields = this.queryBuilder.config.facetFields && this.queryBuilder.config.facetFields.fields || [];
        this.parseFacetItems(context, configFacetFields, 'field');
    }
    parseFacetIntervals(context) {
        const configFacetIntervals = this.queryBuilder.config.facetIntervals && this.queryBuilder.config.facetIntervals.intervals || [];
        this.parseFacetItems(context, configFacetIntervals, 'interval');
    }
    parseFacetQueries(context) {
        var _a;
        const facetQuerySetting = ((_a = this.queryBuilder.config.facetQueries) === null || _a === void 0 ? void 0 : _a.settings) || {};
        const configFacetQueries = this.queryBuilder.config.facetQueries && this.queryBuilder.config.facetQueries.queries || [];
        const configGroups = configFacetQueries.reduce((acc, query) => {
            const group = this.queryBuilder.getQueryGroup(query);
            if (acc[group]) {
                acc[group].push(query);
            }
            else {
                acc[group] = [query];
            }
            return acc;
        }, []);
        const mincount = this.queryBuilder.config.facetQueries && this.queryBuilder.config.facetQueries.mincount;
        const mincountFilter = this.getFilterByMinCount(mincount);
        Object.keys(configGroups).forEach((group) => {
            const responseField = this.findFacet(context, 'query', group);
            const responseBuckets = this.getResponseQueryBuckets(responseField, configGroups[group])
                .filter(mincountFilter);
            const alreadyExistingField = this.findResponseFacet('query', group);
            if (alreadyExistingField) {
                const alreadyExistingBuckets = alreadyExistingField.buckets && alreadyExistingField.buckets.items || [];
                this.updateExistingBuckets(responseField, responseBuckets, alreadyExistingField, alreadyExistingBuckets);
            }
            else if (responseField) {
                if (responseBuckets.length > 0) {
                    const bucketList = new SearchFilterList(responseBuckets, this.facetQueriesPageSize);
                    bucketList.filter = this.getBucketFilterFunction(bucketList);
                    if (!this.responseFacets) {
                        this.responseFacets = [];
                    }
                    this.responseFacets.push({
                        field: group,
                        type: responseField.type || 'query',
                        label: group,
                        pageSize: this.DEFAULT_PAGE_SIZE,
                        currentPageSize: this.DEFAULT_PAGE_SIZE,
                        buckets: bucketList,
                        settings: facetQuerySetting
                    });
                }
            }
        });
    }
    getResponseBuckets(responseField, configField) {
        return ((responseField && responseField.buckets) || []).map((respBucket) => {
            respBucket['count'] = this.getCountValue(respBucket);
            respBucket.filterQuery = respBucket.filterQuery || this.getCorrespondingFilterQuery(configField, respBucket.label);
            return Object.assign(Object.assign({}, respBucket), { checked: false, display: respBucket.display, label: respBucket.label });
        });
    }
    getResponseQueryBuckets(responseField, configGroup) {
        return (configGroup || []).map((query) => {
            const respBucket = ((responseField && responseField.buckets) || [])
                .find((bucket) => bucket.label === query.label) || {};
            respBucket['count'] = this.getCountValue(respBucket);
            return Object.assign(Object.assign({}, respBucket), { checked: false, display: respBucket.display, label: respBucket.label });
        });
    }
    getCountValue(bucket) {
        var _a, _b;
        return (!!bucket && !!bucket.metrics && ((_b = (_a = bucket.metrics[0]) === null || _a === void 0 ? void 0 : _a.value) === null || _b === void 0 ? void 0 : _b.count)) || 0;
    }
    getBucketCountDisplay(bucket) {
        return bucket.count === null ? '' : `(${bucket.count})`;
    }
    getFilterByMinCount(mincountInput) {
        return (bucket) => {
            let mincount = mincountInput;
            if (mincount === undefined) {
                mincount = 1;
            }
            return bucket.count >= mincount;
        };
    }
    getCorrespondingFilterQuery(configFacetItem, bucketLabel) {
        let filterQuery = null;
        if (configFacetItem.field && bucketLabel) {
            if (configFacetItem.sets) {
                const configSet = configFacetItem.sets.find((set) => bucketLabel === set.label);
                if (configSet) {
                    filterQuery = this.buildIntervalQuery(configFacetItem.field, configSet);
                }
            }
            else {
                filterQuery = `${configFacetItem.field}:"${bucketLabel}"`;
            }
        }
        return filterQuery;
    }
    buildIntervalQuery(fieldName, interval) {
        const start = interval.start;
        const end = interval.end;
        const startLimit = (interval.startInclusive === undefined || interval.startInclusive === true) ? '[' : '<';
        const endLimit = (interval.endInclusive === undefined || interval.endInclusive === true) ? ']' : '>';
        return `${fieldName}:${startLimit}"${start}" TO "${end}"${endLimit}`;
    }
    findFacet(context, itemType, fieldLabel) {
        return (context.facets || []).find((response) => response.type === itemType && response.label === fieldLabel) || {};
    }
    findResponseFacet(itemType, fieldLabel) {
        return (this.responseFacets || []).find((response) => response.type === itemType && response.label === fieldLabel);
    }
    updateExistingBuckets(responseField, responseBuckets, alreadyExistingField, alreadyExistingBuckets) {
        const bucketsToDelete = [];
        alreadyExistingBuckets
            .map((bucket) => {
            const responseBucket = ((responseField && responseField.buckets) || []).find((respBucket) => respBucket.label === bucket.label);
            if (!responseBucket) {
                bucketsToDelete.push(bucket);
            }
            bucket.count = this.getCountValue(responseBucket);
            return bucket;
        });
        const hasSelection = this.selectedBuckets
            .find((selBuckets) => alreadyExistingField.label === selBuckets.field.label && alreadyExistingField.type === selBuckets.field.type);
        if (!hasSelection && bucketsToDelete.length) {
            bucketsToDelete.forEach((bucket) => {
                alreadyExistingField.buckets.deleteItem(bucket);
            });
        }
        responseBuckets.forEach((respBucket) => {
            const existingBucket = alreadyExistingBuckets.find((oldBucket) => oldBucket.label === respBucket.label);
            if (!existingBucket) {
                alreadyExistingField.buckets.addItem(respBucket);
            }
        });
    }
    getBucketFilterFunction(bucketList) {
        return (bucket) => {
            if (bucket && bucketList.filterText) {
                const pattern = (bucketList.filterText || '').toLowerCase();
                const label = (this.translationService.instant(bucket.display) || this.translationService.instant(bucket.label)).toLowerCase();
                return this.queryBuilder.config.filterWithContains ? label.indexOf(pattern) !== -1 : label.startsWith(pattern);
            }
            return true;
        };
    }
    unselectFacetBucket(field, bucket) {
        if (bucket) {
            bucket.checked = false;
            this.queryBuilder.removeUserFacetBucket(field, bucket);
            this.updateSelectedBuckets();
            this.queryBuilder.update();
        }
    }
    updateSelectedBuckets() {
        if (this.responseFacets) {
            this.selectedBuckets = [];
            for (const field of this.responseFacets) {
                if (field.buckets) {
                    this.selectedBuckets.push(...this.queryBuilder.getUserFacetBuckets(field.field)
                        .filter((bucket) => bucket.checked)
                        .map((bucket) => {
                        return { field, bucket };
                    }));
                }
            }
        }
        else {
            this.selectedBuckets = [];
        }
    }
    ngOnDestroy() {
        this.onDestroy$.next();
        this.onDestroy$.complete();
    }
    resetAllSelectedBuckets() {
        this.responseFacets.forEach((field) => {
            if (field && field.buckets) {
                for (const bucket of field.buckets.items) {
                    bucket.checked = false;
                    this.queryBuilder.removeUserFacetBucket(field, bucket);
                }
                this.updateSelectedBuckets();
            }
        });
        this.queryBuilder.update();
    }
    resetQueryFragments() {
        this.queryBuilder.queryFragments = {};
        this.queryBuilder.resetToDefaults();
    }
    reset() {
        this.responseFacets = [];
        this.selectedBuckets = [];
        this.queryBuilder.resetToDefaults();
        this.queryBuilder.update();
    }
}
SearchFacetFiltersService.ɵprov = i0.ɵɵdefineInjectable({ factory: function SearchFacetFiltersService_Factory() { return new SearchFacetFiltersService(i0.ɵɵinject(i1.SEARCH_QUERY_SERVICE_TOKEN), i0.ɵɵinject(i2.SearchService), i0.ɵɵinject(i2.TranslationService)); }, token: SearchFacetFiltersService, providedIn: "root" });
SearchFacetFiltersService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
SearchFacetFiltersService.ctorParameters = () => [
    { type: SearchQueryBuilderService, decorators: [{ type: Inject, args: [SEARCH_QUERY_SERVICE_TOKEN,] }] },
    { type: SearchService },
    { type: TranslationService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLWZhY2V0LWZpbHRlcnMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvbnRlbnQtc2VydmljZXMvc3JjLyIsInNvdXJjZXMiOlsibGliL3NlYXJjaC9zZXJ2aWNlcy9zZWFyY2gtZmFjZXQtZmlsdGVycy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBYSxNQUFNLGVBQWUsQ0FBQztBQUU5RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQzNFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQzNFLE9BQU8sRUFBRSxhQUFhLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN2RSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0MsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7Ozs7QUFXdEUsTUFBTSxPQUFPLHlCQUF5QjtJQWVsQyxZQUF1RCxZQUF1QyxFQUMxRSxhQUE0QixFQUM1QixrQkFBc0M7UUFGSCxpQkFBWSxHQUFaLFlBQVksQ0FBMkI7UUFDMUUsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQVgxRCxtQkFBYyxHQUFpQixJQUFJLENBQUM7UUFHcEMsb0JBQWUsR0FBcUIsRUFBRSxDQUFDO1FBRS9CLHNCQUFpQixHQUFHLENBQUMsQ0FBQztRQUNiLHlCQUFvQixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQztRQUM5QyxlQUFVLEdBQUcsSUFBSSxPQUFPLEVBQVcsQ0FBQztRQUtqRCxJQUFJLFlBQVksQ0FBQyxNQUFN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LEtBQUssRUFBRSxFQUFFO1lBQ2xDLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUU7Z0JBQ3hCLEtBQUssTUFBTSxNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUU7b0JBQ3RDLE1BQU0sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO29CQUN2QixJQUFJLENBQUMsWUFBWSxDQUFDLHFCQUFxQixDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztpQkFDMUQ7Z0JBQ0QsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7YUFDaEM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQUVELG1CQUFtQjtRQUNmLElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQztRQUN0QyxJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQ3hDLENBQUM7SUFFRCxLQUFLO1FBQ0QsSUFBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7UUFDekIsSUFBSSxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUNwQyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQy9CLENBQUM7Ozs7WUEvVUosVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7WUFkUSx5QkFBeUIsdUJBOEJqQixNQUFNLFNBQUMsMEJBQTBCO1lBN0J6QyxhQUFhO1lBQUUsa0JBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZhY2V0RmllbGQgfSBmcm9tICcuLi9tb2RlbHMvZmFjZXQtZmllbGQuaW50ZXJmYWNlJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFNFQVJDSF9RVUVSWV9TRVJWSUNFX1RPS0VOIH0gZnJvbSAnLi4vc2VhcmNoLXF1ZXJ5LXNlcnZpY2UudG9rZW4nO1xuaW1wb3J0IHsgU2VhcmNoUXVlcnlCdWlsZGVyU2VydmljZSB9IGZyb20gJy4vc2VhcmNoLXF1ZXJ5LWJ1aWxkZXIuc2VydmljZSc7XG5pbXBvcnQgeyBTZWFyY2hTZXJ2aWNlLCBUcmFuc2xhdGlvblNlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgR2VuZXJpY0J1Y2tldCwgR2VuZXJpY0ZhY2V0UmVzcG9uc2UsIFJlc3VsdFNldENvbnRleHQsIFJlc3VsdFNldFBhZ2luZyB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgU2VhcmNoRmlsdGVyTGlzdCB9IGZyb20gJy4uL21vZGVscy9zZWFyY2gtZmlsdGVyLWxpc3QubW9kZWwnO1xuaW1wb3J0IHsgRmFjZXRGaWVsZEJ1Y2tldCB9IGZyb20gJy4uL21vZGVscy9mYWNldC1maWVsZC1idWNrZXQuaW50ZXJmYWNlJztcblxuZXhwb3J0IGludGVyZmFjZSBTZWxlY3RlZEJ1Y2tldCB7XG4gICAgZmllbGQ6IEZhY2V0RmllbGQ7XG4gICAgYnVja2V0OiBGYWNldEZpZWxkQnVja2V0O1xufVxuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFNlYXJjaEZhY2V0RmlsdGVyc1NlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuXG4gICAgLyoqIEFsbCBmYWNldCBmaWVsZCBpdGVtcyB0byBiZSBkaXNwbGF5ZWQgaW4gdGhlIGNvbXBvbmVudC4gVGhlc2UgYXJlIHVwZGF0ZWQgYWNjb3JkaW5nIHRvIHRoZSByZXNwb25zZS5cbiAgICAgKiAgV2hlbiBhIG5ldyBzZWFyY2ggaXMgcGVyZm9ybWVkLCB0aGUgYWxyZWFkeSBleGlzdGluZyBpdGVtcyBhcmUgdXBkYXRlZCB3aXRoIHRoZSBuZXcgYnVja2V0IGNvdW50IHZhbHVlcyBhbmRcbiAgICAgKiAgdGhlIG5ld2x5IHJlY2VpdmVkIGl0ZW1zIGFyZSBhZGRlZCB0byB0aGUgcmVzcG9uc2VGYWNldHMuXG4gICAgICovXG4gICAgcmVzcG9uc2VGYWNldHM6IEZhY2V0RmllbGRbXSA9IG51bGw7XG5cbiAgICAvKiogc2hvd3MgdGhlIGZhY2V0IGNoaXBzICovXG4gICAgc2VsZWN0ZWRCdWNrZXRzOiBTZWxlY3RlZEJ1Y2tldFtdID0gW107XG5cbiAgICBwcml2YXRlIERFRkFVTFRfUEFHRV9TSVpFID0gNTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZhY2V0UXVlcmllc1BhZ2VTaXplID0gdGhpcy5ERUZBVUxUX1BBR0VfU0laRTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IG9uRGVzdHJveSQgPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xuXG4gICAgY29uc3RydWN0b3IoQEluamVjdChTRUFSQ0hfUVVFUllfU0VSVklDRV9UT0tFTikgcHVibGljIHF1ZXJ5QnVpbGRlcjogU2VhcmNoUXVlcnlCdWlsZGVyU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHNlYXJjaFNlcnZpY2U6IFNlYXJjaFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSB0cmFuc2xhdGlvblNlcnZpY2U6IFRyYW5zbGF0aW9uU2VydmljZSkge1xuICAgICAgICBpZiAocXVlcnlCdWlsZGVyLmNvbmZpZyAmJiBxdWVyeUJ1aWxkZXIuY29uZmlnLmZhY2V0UXVlcmllcykge1xuICAgICAgICAgICAgdGhpcy5mYWNldFF1ZXJpZXNQYWdlU2l6ZSA9IHF1ZXJ5QnVpbGRlci5jb25maWcuZmFjZXRRdWVyaWVzLnBhZ2VTaXplIHx8IHRoaXMuREVGQVVMVF9QQUdFX1NJWkU7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci5jb25maWdVcGRhdGVkXG4gICAgICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5vbkRlc3Ryb3kkKSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRCdWNrZXRzID0gW107XG4gICAgICAgICAgICAgICAgdGhpcy5yZXNwb25zZUZhY2V0cyA9IG51bGw7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci51cGRhdGVkXG4gICAgICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5vbkRlc3Ryb3kkKSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKHF1ZXJ5KSA9PiB0aGlzLnF1ZXJ5QnVpbGRlci5leGVjdXRlKHF1ZXJ5KSk7XG5cbiAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIuZXhlY3V0ZWRcbiAgICAgICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLm9uRGVzdHJveSQpKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgocmVzdWx0U2V0UGFnaW5nOiBSZXN1bHRTZXRQYWdpbmcpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uRGF0YUxvYWRlZChyZXN1bHRTZXRQYWdpbmcpO1xuICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoU2VydmljZS5kYXRhTG9hZGVkLm5leHQocmVzdWx0U2V0UGFnaW5nKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIG9uRGF0YUxvYWRlZChkYXRhOiBhbnkpIHtcbiAgICAgICAgY29uc3QgY29udGV4dCA9IGRhdGEubGlzdC5jb250ZXh0O1xuXG4gICAgICAgIGlmIChjb250ZXh0KSB7XG4gICAgICAgICAgICB0aGlzLnBhcnNlRmFjZXRzKGNvbnRleHQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZXNwb25zZUZhY2V0cyA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHBhcnNlRmFjZXRzKGNvbnRleHQ6IFJlc3VsdFNldENvbnRleHQpIHtcbiAgICAgICAgdGhpcy5wYXJzZUZhY2V0RmllbGRzKGNvbnRleHQpO1xuICAgICAgICB0aGlzLnBhcnNlRmFjZXRJbnRlcnZhbHMoY29udGV4dCk7XG4gICAgICAgIHRoaXMucGFyc2VGYWNldFF1ZXJpZXMoY29udGV4dCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXJzZUZhY2V0SXRlbXMoY29udGV4dDogUmVzdWx0U2V0Q29udGV4dCwgY29uZmlnRmFjZXRGaWVsZHM6IEZhY2V0RmllbGRbXSwgaXRlbVR5cGU6IHN0cmluZykge1xuICAgICAgICBjb25maWdGYWNldEZpZWxkcy5mb3JFYWNoKChmaWVsZCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VGaWVsZCA9IHRoaXMuZmluZEZhY2V0KGNvbnRleHQsIGl0ZW1UeXBlLCBmaWVsZC5sYWJlbCk7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZUJ1Y2tldHMgPSB0aGlzLmdldFJlc3BvbnNlQnVja2V0cyhyZXNwb25zZUZpZWxkLCBmaWVsZClcbiAgICAgICAgICAgICAgICAuZmlsdGVyKHRoaXMuZ2V0RmlsdGVyQnlNaW5Db3VudChmaWVsZC5taW5jb3VudCkpO1xuICAgICAgICAgICAgY29uc3QgYWxyZWFkeUV4aXN0aW5nRmllbGQgPSB0aGlzLmZpbmRSZXNwb25zZUZhY2V0KGl0ZW1UeXBlLCBmaWVsZC5sYWJlbCk7XG5cbiAgICAgICAgICAgIGlmIChhbHJlYWR5RXhpc3RpbmdGaWVsZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFscmVhZHlFeGlzdGluZ0J1Y2tldHMgPSBhbHJlYWR5RXhpc3RpbmdGaWVsZC5idWNrZXRzICYmIGFscmVhZHlFeGlzdGluZ0ZpZWxkLmJ1Y2tldHMuaXRlbXMgfHwgW107XG5cbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUV4aXN0aW5nQnVja2V0cyhyZXNwb25zZUZpZWxkLCByZXNwb25zZUJ1Y2tldHMsIGFscmVhZHlFeGlzdGluZ0ZpZWxkLCBhbHJlYWR5RXhpc3RpbmdCdWNrZXRzKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2VGaWVsZCkge1xuICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZUJ1Y2tldHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBidWNrZXRMaXN0ID0gbmV3IFNlYXJjaEZpbHRlckxpc3Q8RmFjZXRGaWVsZEJ1Y2tldD4ocmVzcG9uc2VCdWNrZXRzLCBmaWVsZC5wYWdlU2l6ZSk7XG4gICAgICAgICAgICAgICAgICAgIGJ1Y2tldExpc3QuZmlsdGVyID0gdGhpcy5nZXRCdWNrZXRGaWx0ZXJGdW5jdGlvbihidWNrZXRMaXN0KTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMucmVzcG9uc2VGYWNldHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVzcG9uc2VGYWNldHMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc3BvbnNlRmFjZXRzLnB1c2goPEZhY2V0RmllbGQ+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLmZpZWxkLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogcmVzcG9uc2VGaWVsZC50eXBlIHx8IGl0ZW1UeXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGZpZWxkLmxhYmVsLFxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZVNpemU6IGZpZWxkLnBhZ2VTaXplIHwgdGhpcy5ERUZBVUxUX1BBR0VfU0laRSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQYWdlU2l6ZTogZmllbGQucGFnZVNpemUgfCB0aGlzLkRFRkFVTFRfUEFHRV9TSVpFLFxuICAgICAgICAgICAgICAgICAgICAgICAgYnVja2V0czogYnVja2V0TGlzdFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGFyc2VGYWNldEZpZWxkcyhjb250ZXh0OiBSZXN1bHRTZXRDb250ZXh0KSB7XG4gICAgICAgIGNvbnN0IGNvbmZpZ0ZhY2V0RmllbGRzID0gdGhpcy5xdWVyeUJ1aWxkZXIuY29uZmlnLmZhY2V0RmllbGRzICYmIHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldEZpZWxkcy5maWVsZHMgfHwgW107XG4gICAgICAgIHRoaXMucGFyc2VGYWNldEl0ZW1zKGNvbnRleHQsIGNvbmZpZ0ZhY2V0RmllbGRzLCAnZmllbGQnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBhcnNlRmFjZXRJbnRlcnZhbHMoY29udGV4dDogUmVzdWx0U2V0Q29udGV4dCkge1xuICAgICAgICBjb25zdCBjb25maWdGYWNldEludGVydmFscyA9IHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldEludGVydmFscyAmJiB0aGlzLnF1ZXJ5QnVpbGRlci5jb25maWcuZmFjZXRJbnRlcnZhbHMuaW50ZXJ2YWxzIHx8IFtdO1xuICAgICAgICB0aGlzLnBhcnNlRmFjZXRJdGVtcyhjb250ZXh0LCBjb25maWdGYWNldEludGVydmFscywgJ2ludGVydmFsJyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXJzZUZhY2V0UXVlcmllcyhjb250ZXh0OiBSZXN1bHRTZXRDb250ZXh0KSB7XG4gICAgICAgIGNvbnN0IGZhY2V0UXVlcnlTZXR0aW5nID0gdGhpcy5xdWVyeUJ1aWxkZXIuY29uZmlnLmZhY2V0UXVlcmllcz8uc2V0dGluZ3MgfHwge307XG4gICAgICAgIGNvbnN0IGNvbmZpZ0ZhY2V0UXVlcmllcyA9IHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldFF1ZXJpZXMgJiYgdGhpcy5xdWVyeUJ1aWxkZXIuY29uZmlnLmZhY2V0UXVlcmllcy5xdWVyaWVzIHx8IFtdO1xuICAgICAgICBjb25zdCBjb25maWdHcm91cHMgPSBjb25maWdGYWNldFF1ZXJpZXMucmVkdWNlKChhY2MsIHF1ZXJ5KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBncm91cCA9IHRoaXMucXVlcnlCdWlsZGVyLmdldFF1ZXJ5R3JvdXAocXVlcnkpO1xuICAgICAgICAgICAgaWYgKGFjY1tncm91cF0pIHtcbiAgICAgICAgICAgICAgICBhY2NbZ3JvdXBdLnB1c2gocXVlcnkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhY2NbZ3JvdXBdID0gW3F1ZXJ5XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBhY2M7XG4gICAgICAgIH0sIFtdKTtcblxuICAgICAgICBjb25zdCBtaW5jb3VudCA9IHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldFF1ZXJpZXMgJiYgdGhpcy5xdWVyeUJ1aWxkZXIuY29uZmlnLmZhY2V0UXVlcmllcy5taW5jb3VudDtcbiAgICAgICAgY29uc3QgbWluY291bnRGaWx0ZXIgPSB0aGlzLmdldEZpbHRlckJ5TWluQ291bnQobWluY291bnQpO1xuXG4gICAgICAgIE9iamVjdC5rZXlzKGNvbmZpZ0dyb3VwcykuZm9yRWFjaCgoZ3JvdXApID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlRmllbGQgPSB0aGlzLmZpbmRGYWNldChjb250ZXh0LCAncXVlcnknLCBncm91cCk7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZUJ1Y2tldHMgPSB0aGlzLmdldFJlc3BvbnNlUXVlcnlCdWNrZXRzKHJlc3BvbnNlRmllbGQsIGNvbmZpZ0dyb3Vwc1tncm91cF0pXG4gICAgICAgICAgICAgICAgLmZpbHRlcihtaW5jb3VudEZpbHRlcik7XG4gICAgICAgICAgICBjb25zdCBhbHJlYWR5RXhpc3RpbmdGaWVsZCA9IHRoaXMuZmluZFJlc3BvbnNlRmFjZXQoJ3F1ZXJ5JywgZ3JvdXApO1xuXG4gICAgICAgICAgICBpZiAoYWxyZWFkeUV4aXN0aW5nRmllbGQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBhbHJlYWR5RXhpc3RpbmdCdWNrZXRzID0gYWxyZWFkeUV4aXN0aW5nRmllbGQuYnVja2V0cyAmJiBhbHJlYWR5RXhpc3RpbmdGaWVsZC5idWNrZXRzLml0ZW1zIHx8IFtdO1xuXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVFeGlzdGluZ0J1Y2tldHMocmVzcG9uc2VGaWVsZCwgcmVzcG9uc2VCdWNrZXRzLCBhbHJlYWR5RXhpc3RpbmdGaWVsZCwgYWxyZWFkeUV4aXN0aW5nQnVja2V0cyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlRmllbGQpIHtcbiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2VCdWNrZXRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYnVja2V0TGlzdCA9IG5ldyBTZWFyY2hGaWx0ZXJMaXN0PEZhY2V0RmllbGRCdWNrZXQ+KHJlc3BvbnNlQnVja2V0cywgdGhpcy5mYWNldFF1ZXJpZXNQYWdlU2l6ZSk7XG4gICAgICAgICAgICAgICAgICAgIGJ1Y2tldExpc3QuZmlsdGVyID0gdGhpcy5nZXRCdWNrZXRGaWx0ZXJGdW5jdGlvbihidWNrZXRMaXN0KTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMucmVzcG9uc2VGYWNldHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVzcG9uc2VGYWNldHMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc3BvbnNlRmFjZXRzLnB1c2goPEZhY2V0RmllbGQ+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkOiBncm91cCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IHJlc3BvbnNlRmllbGQudHlwZSB8fCAncXVlcnknLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGdyb3VwLFxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZVNpemU6IHRoaXMuREVGQVVMVF9QQUdFX1NJWkUsXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGFnZVNpemU6IHRoaXMuREVGQVVMVF9QQUdFX1NJWkUsXG4gICAgICAgICAgICAgICAgICAgICAgICBidWNrZXRzOiBidWNrZXRMaXN0LFxuICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3M6IGZhY2V0UXVlcnlTZXR0aW5nXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFJlc3BvbnNlQnVja2V0cyhyZXNwb25zZUZpZWxkOiBHZW5lcmljRmFjZXRSZXNwb25zZSwgY29uZmlnRmllbGQ6IEZhY2V0RmllbGQpOiBGYWNldEZpZWxkQnVja2V0W10ge1xuICAgICAgICByZXR1cm4gKChyZXNwb25zZUZpZWxkICYmIHJlc3BvbnNlRmllbGQuYnVja2V0cykgfHwgW10pLm1hcCgocmVzcEJ1Y2tldCkgPT4ge1xuXG4gICAgICAgICAgICByZXNwQnVja2V0Wydjb3VudCddID0gdGhpcy5nZXRDb3VudFZhbHVlKHJlc3BCdWNrZXQpO1xuICAgICAgICAgICAgcmVzcEJ1Y2tldC5maWx0ZXJRdWVyeSA9IHJlc3BCdWNrZXQuZmlsdGVyUXVlcnkgfHwgdGhpcy5nZXRDb3JyZXNwb25kaW5nRmlsdGVyUXVlcnkoY29uZmlnRmllbGQsIHJlc3BCdWNrZXQubGFiZWwpO1xuICAgICAgICAgICAgcmV0dXJuIDxGYWNldEZpZWxkQnVja2V0PiB7XG4gICAgICAgICAgICAgICAgLi4ucmVzcEJ1Y2tldCxcbiAgICAgICAgICAgICAgICBjaGVja2VkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBkaXNwbGF5OiByZXNwQnVja2V0LmRpc3BsYXksXG4gICAgICAgICAgICAgICAgbGFiZWw6IHJlc3BCdWNrZXQubGFiZWxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0UmVzcG9uc2VRdWVyeUJ1Y2tldHMocmVzcG9uc2VGaWVsZDogR2VuZXJpY0ZhY2V0UmVzcG9uc2UsIGNvbmZpZ0dyb3VwOiBhbnkpOiBGYWNldEZpZWxkQnVja2V0W10ge1xuICAgICAgICByZXR1cm4gKGNvbmZpZ0dyb3VwIHx8IFtdKS5tYXAoKHF1ZXJ5KSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXNwQnVja2V0ID0gKChyZXNwb25zZUZpZWxkICYmIHJlc3BvbnNlRmllbGQuYnVja2V0cykgfHwgW10pXG4gICAgICAgICAgICAgICAgLmZpbmQoKGJ1Y2tldCkgPT4gYnVja2V0LmxhYmVsID09PSBxdWVyeS5sYWJlbCkgfHwge307XG5cbiAgICAgICAgICAgIHJlc3BCdWNrZXRbJ2NvdW50J10gPSB0aGlzLmdldENvdW50VmFsdWUocmVzcEJ1Y2tldCk7XG4gICAgICAgICAgICByZXR1cm4gPEZhY2V0RmllbGRCdWNrZXQ+IHtcbiAgICAgICAgICAgICAgICAuLi5yZXNwQnVja2V0LFxuICAgICAgICAgICAgICAgIGNoZWNrZWQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGRpc3BsYXk6IHJlc3BCdWNrZXQuZGlzcGxheSxcbiAgICAgICAgICAgICAgICBsYWJlbDogcmVzcEJ1Y2tldC5sYWJlbFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDb3VudFZhbHVlKGJ1Y2tldDogR2VuZXJpY0J1Y2tldCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiAoISFidWNrZXQgJiYgISFidWNrZXQubWV0cmljcyAmJiBidWNrZXQubWV0cmljc1swXT8udmFsdWU/LmNvdW50KSB8fCAwO1xuICAgIH1cblxuICAgIGdldEJ1Y2tldENvdW50RGlzcGxheShidWNrZXQ6IEZhY2V0RmllbGRCdWNrZXQpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gYnVja2V0LmNvdW50ID09PSBudWxsID8gJycgOiBgKCR7YnVja2V0LmNvdW50fSlgO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0RmlsdGVyQnlNaW5Db3VudChtaW5jb3VudElucHV0OiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIChidWNrZXQpID0+IHtcbiAgICAgICAgICAgIGxldCBtaW5jb3VudCA9IG1pbmNvdW50SW5wdXQ7XG4gICAgICAgICAgICBpZiAobWluY291bnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIG1pbmNvdW50ID0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBidWNrZXQuY291bnQgPj0gbWluY291bnQ7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDb3JyZXNwb25kaW5nRmlsdGVyUXVlcnkoY29uZmlnRmFjZXRJdGVtOiBGYWNldEZpZWxkLCBidWNrZXRMYWJlbDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IGZpbHRlclF1ZXJ5ID0gbnVsbDtcblxuICAgICAgICBpZiAoY29uZmlnRmFjZXRJdGVtLmZpZWxkICYmIGJ1Y2tldExhYmVsKSB7XG5cbiAgICAgICAgICAgIGlmIChjb25maWdGYWNldEl0ZW0uc2V0cykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbmZpZ1NldCA9IGNvbmZpZ0ZhY2V0SXRlbS5zZXRzLmZpbmQoKHNldCkgPT4gYnVja2V0TGFiZWwgPT09IHNldC5sYWJlbCk7XG5cbiAgICAgICAgICAgICAgICBpZiAoY29uZmlnU2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIGZpbHRlclF1ZXJ5ID0gdGhpcy5idWlsZEludGVydmFsUXVlcnkoY29uZmlnRmFjZXRJdGVtLmZpZWxkLCBjb25maWdTZXQpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBmaWx0ZXJRdWVyeSA9IGAke2NvbmZpZ0ZhY2V0SXRlbS5maWVsZH06XCIke2J1Y2tldExhYmVsfVwiYDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmaWx0ZXJRdWVyeTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGJ1aWxkSW50ZXJ2YWxRdWVyeShmaWVsZE5hbWU6IHN0cmluZywgaW50ZXJ2YWw6IGFueSk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHN0YXJ0ID0gaW50ZXJ2YWwuc3RhcnQ7XG4gICAgICAgIGNvbnN0IGVuZCA9IGludGVydmFsLmVuZDtcbiAgICAgICAgY29uc3Qgc3RhcnRMaW1pdCA9IChpbnRlcnZhbC5zdGFydEluY2x1c2l2ZSA9PT0gdW5kZWZpbmVkIHx8IGludGVydmFsLnN0YXJ0SW5jbHVzaXZlID09PSB0cnVlKSA/ICdbJyA6ICc8JztcbiAgICAgICAgY29uc3QgZW5kTGltaXQgPSAoaW50ZXJ2YWwuZW5kSW5jbHVzaXZlID09PSB1bmRlZmluZWQgfHwgaW50ZXJ2YWwuZW5kSW5jbHVzaXZlID09PSB0cnVlKSA/ICddJyA6ICc+JztcblxuICAgICAgICByZXR1cm4gYCR7ZmllbGROYW1lfToke3N0YXJ0TGltaXR9XCIke3N0YXJ0fVwiIFRPIFwiJHtlbmR9XCIke2VuZExpbWl0fWA7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmaW5kRmFjZXQoY29udGV4dDogUmVzdWx0U2V0Q29udGV4dCwgaXRlbVR5cGU6IHN0cmluZywgZmllbGRMYWJlbDogc3RyaW5nKTogR2VuZXJpY0ZhY2V0UmVzcG9uc2Uge1xuICAgICAgICByZXR1cm4gKGNvbnRleHQuZmFjZXRzIHx8IFtdKS5maW5kKChyZXNwb25zZSkgPT4gcmVzcG9uc2UudHlwZSA9PT0gaXRlbVR5cGUgJiYgcmVzcG9uc2UubGFiZWwgPT09IGZpZWxkTGFiZWwpIHx8IHt9O1xuICAgIH1cblxuICAgIHByaXZhdGUgZmluZFJlc3BvbnNlRmFjZXQoaXRlbVR5cGU6IHN0cmluZywgZmllbGRMYWJlbDogc3RyaW5nKTogRmFjZXRGaWVsZCB7XG4gICAgICAgIHJldHVybiAodGhpcy5yZXNwb25zZUZhY2V0cyB8fCBbXSkuZmluZCgocmVzcG9uc2UpID0+IHJlc3BvbnNlLnR5cGUgPT09IGl0ZW1UeXBlICYmIHJlc3BvbnNlLmxhYmVsID09PSBmaWVsZExhYmVsKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZUV4aXN0aW5nQnVja2V0cyhyZXNwb25zZUZpZWxkLCByZXNwb25zZUJ1Y2tldHMsIGFscmVhZHlFeGlzdGluZ0ZpZWxkLCBhbHJlYWR5RXhpc3RpbmdCdWNrZXRzKSB7XG4gICAgICAgIGNvbnN0IGJ1Y2tldHNUb0RlbGV0ZSA9IFtdO1xuXG4gICAgICAgIGFscmVhZHlFeGlzdGluZ0J1Y2tldHNcbiAgICAgICAgICAgIC5tYXAoKGJ1Y2tldCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlQnVja2V0ID0gKChyZXNwb25zZUZpZWxkICYmIHJlc3BvbnNlRmllbGQuYnVja2V0cykgfHwgW10pLmZpbmQoKHJlc3BCdWNrZXQpID0+IHJlc3BCdWNrZXQubGFiZWwgPT09IGJ1Y2tldC5sYWJlbCk7XG5cbiAgICAgICAgICAgICAgICBpZiAoIXJlc3BvbnNlQnVja2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIGJ1Y2tldHNUb0RlbGV0ZS5wdXNoKGJ1Y2tldCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJ1Y2tldC5jb3VudCA9IHRoaXMuZ2V0Q291bnRWYWx1ZShyZXNwb25zZUJ1Y2tldCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGJ1Y2tldDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGhhc1NlbGVjdGlvbiA9IHRoaXMuc2VsZWN0ZWRCdWNrZXRzXG4gICAgICAgICAgICAuZmluZCgoc2VsQnVja2V0cykgPT4gYWxyZWFkeUV4aXN0aW5nRmllbGQubGFiZWwgPT09IHNlbEJ1Y2tldHMuZmllbGQubGFiZWwgJiYgYWxyZWFkeUV4aXN0aW5nRmllbGQudHlwZSA9PT0gc2VsQnVja2V0cy5maWVsZC50eXBlKTtcblxuICAgICAgICBpZiAoIWhhc1NlbGVjdGlvbiAmJiBidWNrZXRzVG9EZWxldGUubGVuZ3RoKSB7XG4gICAgICAgICAgICBidWNrZXRzVG9EZWxldGUuZm9yRWFjaCgoYnVja2V0KSA9PiB7XG4gICAgICAgICAgICAgICAgYWxyZWFkeUV4aXN0aW5nRmllbGQuYnVja2V0cy5kZWxldGVJdGVtKGJ1Y2tldCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlc3BvbnNlQnVja2V0cy5mb3JFYWNoKChyZXNwQnVja2V0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBleGlzdGluZ0J1Y2tldCA9IGFscmVhZHlFeGlzdGluZ0J1Y2tldHMuZmluZCgob2xkQnVja2V0KSA9PiBvbGRCdWNrZXQubGFiZWwgPT09IHJlc3BCdWNrZXQubGFiZWwpO1xuXG4gICAgICAgICAgICBpZiAoIWV4aXN0aW5nQnVja2V0KSB7XG4gICAgICAgICAgICAgICAgYWxyZWFkeUV4aXN0aW5nRmllbGQuYnVja2V0cy5hZGRJdGVtKHJlc3BCdWNrZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEJ1Y2tldEZpbHRlckZ1bmN0aW9uKGJ1Y2tldExpc3QpIHtcbiAgICAgICAgcmV0dXJuIChidWNrZXQ6IEZhY2V0RmllbGRCdWNrZXQpOiBib29sZWFuID0+IHtcbiAgICAgICAgICAgIGlmIChidWNrZXQgJiYgYnVja2V0TGlzdC5maWx0ZXJUZXh0KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGF0dGVybiA9IChidWNrZXRMaXN0LmZpbHRlclRleHQgfHwgJycpLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgY29uc3QgbGFiZWwgPSAodGhpcy50cmFuc2xhdGlvblNlcnZpY2UuaW5zdGFudChidWNrZXQuZGlzcGxheSkgfHwgdGhpcy50cmFuc2xhdGlvblNlcnZpY2UuaW5zdGFudChidWNrZXQubGFiZWwpKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnF1ZXJ5QnVpbGRlci5jb25maWcuZmlsdGVyV2l0aENvbnRhaW5zID8gbGFiZWwuaW5kZXhPZihwYXR0ZXJuKSAhPT0gLTEgOiBsYWJlbC5zdGFydHNXaXRoKHBhdHRlcm4pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgdW5zZWxlY3RGYWNldEJ1Y2tldChmaWVsZDogRmFjZXRGaWVsZCwgYnVja2V0OiBGYWNldEZpZWxkQnVja2V0KSB7XG4gICAgICAgIGlmIChidWNrZXQpIHtcbiAgICAgICAgICAgIGJ1Y2tldC5jaGVja2VkID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci5yZW1vdmVVc2VyRmFjZXRCdWNrZXQoZmllbGQsIGJ1Y2tldCk7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVNlbGVjdGVkQnVja2V0cygpO1xuICAgICAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIudXBkYXRlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKiB1cGRhdGUgYWRmLXNlYXJjaC1jaGlwLWxpc3QgY29tcG9uZW50IHZpZXcgKi9cbiAgICB1cGRhdGVTZWxlY3RlZEJ1Y2tldHMoKSB7XG4gICAgICAgIGlmICh0aGlzLnJlc3BvbnNlRmFjZXRzKSB7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkQnVja2V0cyA9IFtdO1xuICAgICAgICAgICAgZm9yIChjb25zdCBmaWVsZCBvZiB0aGlzLnJlc3BvbnNlRmFjZXRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKGZpZWxkLmJ1Y2tldHMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEJ1Y2tldHMucHVzaChcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLnRoaXMucXVlcnlCdWlsZGVyLmdldFVzZXJGYWNldEJ1Y2tldHMoZmllbGQuZmllbGQpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcigoYnVja2V0KSA9PiBidWNrZXQuY2hlY2tlZClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwKChidWNrZXQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtmaWVsZCwgYnVja2V0fTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRCdWNrZXRzID0gW107XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5vbkRlc3Ryb3kkLm5leHQoKTtcbiAgICAgICAgdGhpcy5vbkRlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gICAgfVxuXG4gICAgcmVzZXRBbGxTZWxlY3RlZEJ1Y2tldHMoKSB7XG4gICAgICAgIHRoaXMucmVzcG9uc2VGYWNldHMuZm9yRWFjaCgoZmllbGQpID0+IHtcbiAgICAgICAgICAgIGlmIChmaWVsZCAmJiBmaWVsZC5idWNrZXRzKSB7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBidWNrZXQgb2YgZmllbGQuYnVja2V0cy5pdGVtcykge1xuICAgICAgICAgICAgICAgICAgICBidWNrZXQuY2hlY2tlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci5yZW1vdmVVc2VyRmFjZXRCdWNrZXQoZmllbGQsIGJ1Y2tldCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWRCdWNrZXRzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci51cGRhdGUoKTtcbiAgICB9XG5cbiAgICByZXNldFF1ZXJ5RnJhZ21lbnRzKCkge1xuICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci5xdWVyeUZyYWdtZW50cyA9IHt9O1xuICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci5yZXNldFRvRGVmYXVsdHMoKTtcbiAgICB9XG5cbiAgICByZXNldCgpIHtcbiAgICAgICAgdGhpcy5yZXNwb25zZUZhY2V0cyA9IFtdO1xuICAgICAgICB0aGlzLnNlbGVjdGVkQnVja2V0cyA9IFtdO1xuICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci5yZXNldFRvRGVmYXVsdHMoKTtcbiAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIudXBkYXRlKCk7XG4gICAgfVxufVxuIl19