import { Injectable } from '@angular/core';
import { AlfrescoApiService, AppConfigService, NodesApiService } from '@alfresco/adf-core';
import { BaseQueryBuilderService } from './base-query-builder.service';
import { filter } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
export class SearchHeaderQueryBuilderService extends BaseQueryBuilderService {
    constructor(appConfig, alfrescoApiService, nodeApiService) {
        super(appConfig, alfrescoApiService);
        this.nodeApiService = nodeApiService;
        this.customSources = ['-trashcan-', '-sharedlinks-', '-sites-', '-mysites-', '-favorites-', '-recent-', '-my-'];
        this.activeFilters = [];
        this.updated.pipe(filter((query) => !!query)).subscribe(() => {
            this.execute();
        });
    }
    isFilterServiceActive() {
        return true;
    }
    loadConfiguration() {
        return this.appConfig.get('search-headers');
    }
    setupCurrentPagination(maxItems, skipCount) {
        if (!this.paging ||
            (this.paging &&
                this.paging.maxItems !== maxItems || this.paging.skipCount !== skipCount)) {
            this.paging = { maxItems, skipCount };
            this.execute();
        }
    }
    setActiveFilter(columnActivated, filterValue) {
        const selectedFilter = this.activeFilters.find((activeFilter) => activeFilter.key === columnActivated);
        if (!selectedFilter) {
            this.activeFilters.push({
                key: columnActivated,
                value: filterValue
            });
        }
        else {
            selectedFilter.value = filterValue;
        }
    }
    resetActiveFilters() {
        this.activeFilters = [];
    }
    getActiveFilters() {
        return this.activeFilters;
    }
    isNoFilterActive() {
        return this.activeFilters.length === 0;
    }
    removeActiveFilter(columnRemoved) {
        const filterIndex = this.activeFilters.map((activeFilter) => activeFilter.key).indexOf(columnRemoved);
        if (filterIndex >= 0) {
            this.activeFilters.splice(filterIndex, 1);
        }
    }
    setSorting(dataSorting) {
        this.sorting = [];
        dataSorting.forEach((columnSorting) => {
            const fieldValue = this.getSortingFieldFromColumnName(columnSorting.key);
            if (fieldValue) {
                const optionAscending = columnSorting.direction.toLocaleLowerCase() === 'asc';
                const type = fieldValue === 'score' ? 'SCORE' : 'FIELD';
                const currentSort = {
                    key: columnSorting.key,
                    label: 'current',
                    type: type,
                    field: fieldValue,
                    ascending: optionAscending
                };
                this.sorting.push(currentSort);
            }
        });
        this.execute();
    }
    getSortingFieldFromColumnName(columnName) {
        if (this.sortingOptions.length > 0) {
            const sortOption = this.sortingOptions.find((option) => option.key === columnName);
            return sortOption ? sortOption.field : '';
        }
        return '';
    }
    getCategoryForColumn(columnKey) {
        let foundCategory = null;
        if (this.categories !== null) {
            foundCategory = this.categories.find(category => category.columnKey === columnKey);
        }
        return foundCategory;
    }
    setCurrentRootFolderId(currentFolderId) {
        const alreadyAddedFilter = this.filterQueries.find(filterQueries => filterQueries.query.includes(currentFolderId));
        if (alreadyAddedFilter !== undefined) {
            this.filterQueries = [];
        }
        this.filterQueries = [{
                query: `PARENT:"workspace://SpacesStore/${currentFolderId}"`
            }];
        this.execute();
    }
    isCustomSourceNode(currentNodeId) {
        return this.customSources.includes(currentNodeId);
    }
    getNodeIdForCustomSource(customSourceId) {
        return this.nodeApiService.getNode(customSourceId);
    }
}
SearchHeaderQueryBuilderService.ɵprov = i0.ɵɵdefineInjectable({ factory: function SearchHeaderQueryBuilderService_Factory() { return new SearchHeaderQueryBuilderService(i0.ɵɵinject(i1.AppConfigService), i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i1.NodesApiService)); }, token: SearchHeaderQueryBuilderService, providedIn: "root" });
SearchHeaderQueryBuilderService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
SearchHeaderQueryBuilderService.ctorParameters = () => [
    { type: AppConfigService },
    { type: AlfrescoApiService },
    { type: NodesApiService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLWhlYWRlci1xdWVyeS1idWlsZGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb250ZW50LXNlcnZpY2VzL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9zZWFyY2gvc2VydmljZXMvc2VhcmNoLWhlYWRlci1xdWVyeS1idWlsZGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLGVBQWUsRUFBZSxNQUFNLG9CQUFvQixDQUFDO0FBRXhHLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBR3ZFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7O0FBUXhDLE1BQU0sT0FBTywrQkFBZ0MsU0FBUSx1QkFBdUI7SUFNeEUsWUFBWSxTQUEyQixFQUMzQixrQkFBc0MsRUFDOUIsY0FBK0I7UUFDL0MsS0FBSyxDQUFDLFNBQVMsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO1FBRHJCLG1CQUFjLEdBQWQsY0FBYyxDQUFpQjtRQU4zQyxrQkFBYSxHQUFHLENBQUMsWUFBWSxFQUFFLGVBQWUsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFbkgsa0JBQWEsR0FBbUIsRUFBRSxDQUFDO1FBTy9CLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUNiLE1BQU0sQ0FBQyxDQUFDLEtBQWdCLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7WUFDdEQsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ25CLENBQUMsQ0FBQyxDQUFDO0lBQ1As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TyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQsd0JBQXdCLENBQUMsY0FBc0I7UUFDM0MsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUN2RCxDQUFDOzs7O1lBaklKLFVBQVUsU0FBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQjs7O1lBWjRCLGdCQUFnQjtZQUFwQyxrQkFBa0I7WUFBb0IsZUFBZSIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSwgQXBwQ29uZmlnU2VydmljZSwgTm9kZXNBcGlTZXJ2aWNlLCBEYXRhU29ydGluZyB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBTZWFyY2hDb25maWd1cmF0aW9uIH0gZnJvbSAnLi4vbW9kZWxzL3NlYXJjaC1jb25maWd1cmF0aW9uLmludGVyZmFjZSc7XG5pbXBvcnQgeyBCYXNlUXVlcnlCdWlsZGVyU2VydmljZSB9IGZyb20gJy4vYmFzZS1xdWVyeS1idWlsZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgU2VhcmNoQ2F0ZWdvcnkgfSBmcm9tICcuLi9tb2RlbHMvc2VhcmNoLWNhdGVnb3J5LmludGVyZmFjZSc7XG5pbXBvcnQgeyBNaW5pbWFsTm9kZSwgUXVlcnlCb2R5IH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBmaWx0ZXIgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBTZWFyY2hTb3J0aW5nRGVmaW5pdGlvbiB9IGZyb20gJy4uL21vZGVscy9zZWFyY2gtc29ydGluZy1kZWZpbml0aW9uLmludGVyZmFjZSc7XG5pbXBvcnQgeyBGaWx0ZXJTZWFyY2ggfSBmcm9tICcuLi9tb2RlbHMvZmlsdGVyLXNlYXJjaC5pbnRlcmZhY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFNlYXJjaEhlYWRlclF1ZXJ5QnVpbGRlclNlcnZpY2UgZXh0ZW5kcyBCYXNlUXVlcnlCdWlsZGVyU2VydmljZSB7XG5cbiAgICBwcml2YXRlIGN1c3RvbVNvdXJjZXMgPSBbJy10cmFzaGNhbi0nLCAnLXNoYXJlZGxpbmtzLScsICctc2l0ZXMtJywgJy1teXNpdGVzLScsICctZmF2b3JpdGVzLScsICctcmVjZW50LScsICctbXktJ107XG5cbiAgICBhY3RpdmVGaWx0ZXJzOiBGaWx0ZXJTZWFyY2hbXSA9IFtdO1xuXG4gICAgY29uc3RydWN0b3IoYXBwQ29uZmlnOiBBcHBDb25maWdTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIGFsZnJlc2NvQXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgbm9kZUFwaVNlcnZpY2U6IE5vZGVzQXBpU2VydmljZSkge1xuICAgICAgICBzdXBlcihhcHBDb25maWcsIGFsZnJlc2NvQXBpU2VydmljZSk7XG5cbiAgICAgICAgdGhpcy51cGRhdGVkLnBpcGUoXG4gICAgICAgICAgICBmaWx0ZXIoKHF1ZXJ5OiBRdWVyeUJvZHkpID0+ICEhcXVlcnkpKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5leGVjdXRlKCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc0ZpbHRlclNlcnZpY2VBY3RpdmUoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGxvYWRDb25maWd1cmF0aW9uKCk6IFNlYXJjaENvbmZpZ3VyYXRpb24ge1xuICAgICAgICByZXR1cm4gdGhpcy5hcHBDb25maWcuZ2V0PFNlYXJjaENvbmZpZ3VyYXRpb24+KCdzZWFyY2gtaGVhZGVycycpO1xuICAgIH1cblxuICAgIHNldHVwQ3VycmVudFBhZ2luYXRpb24obWF4SXRlbXM6IG51bWJlciwgc2tpcENvdW50OiBudW1iZXIpIHtcbiAgICAgICAgaWYgKCF0aGlzLnBhZ2luZyB8fFxuICAgICAgICAgICAgKHRoaXMucGFnaW5nICYmXG4gICAgICAgICAgICAgICAgdGhpcy5wYWdpbmcubWF4SXRlbXMgIT09IG1heEl0ZW1zIHx8IHRoaXMucGFnaW5nLnNraXBDb3VudCAhPT0gc2tpcENvdW50KSkge1xuICAgICAgICAgICAgdGhpcy5wYWdpbmcgPSB7IG1heEl0ZW1zLCBza2lwQ291bnQgfTtcbiAgICAgICAgICAgIHRoaXMuZXhlY3V0ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2V0QWN0aXZlRmlsdGVyKGNvbHVtbkFjdGl2YXRlZDogc3RyaW5nLCBmaWx0ZXJWYWx1ZTogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkRmlsdGVyID0gdGhpcy5hY3RpdmVGaWx0ZXJzLmZpbmQoKGFjdGl2ZUZpbHRlcikgPT4gYWN0aXZlRmlsdGVyLmtleSA9PT0gY29sdW1uQWN0aXZhdGVkKTtcbiAgICAgICAgaWYgKCFzZWxlY3RlZEZpbHRlcikge1xuICAgICAgICAgICAgdGhpcy5hY3RpdmVGaWx0ZXJzLnB1c2goPEZpbHRlclNlYXJjaD4ge1xuICAgICAgICAgICAgICAgIGtleTogY29sdW1uQWN0aXZhdGVkLFxuICAgICAgICAgICAgICAgIHZhbHVlOiBmaWx0ZXJWYWx1ZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzZWxlY3RlZEZpbHRlci52YWx1ZSA9IGZpbHRlclZhbHVlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVzZXRBY3RpdmVGaWx0ZXJzKCkge1xuICAgICAgICB0aGlzLmFjdGl2ZUZpbHRlcnMgPSBbXTtcbiAgICB9XG5cbiAgICBnZXRBY3RpdmVGaWx0ZXJzKCk6IEZpbHRlclNlYXJjaFtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYWN0aXZlRmlsdGVycztcbiAgICB9XG5cbiAgICBpc05vRmlsdGVyQWN0aXZlKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5hY3RpdmVGaWx0ZXJzLmxlbmd0aCA9PT0gMDtcbiAgICB9XG5cbiAgICByZW1vdmVBY3RpdmVGaWx0ZXIoY29sdW1uUmVtb3ZlZDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGZpbHRlckluZGV4ID0gdGhpcy5hY3RpdmVGaWx0ZXJzLm1hcCgoYWN0aXZlRmlsdGVyKSA9PiBhY3RpdmVGaWx0ZXIua2V5KS5pbmRleE9mKGNvbHVtblJlbW92ZWQpO1xuICAgICAgICBpZiAoZmlsdGVySW5kZXggPj0gMCkge1xuICAgICAgICAgICAgdGhpcy5hY3RpdmVGaWx0ZXJzLnNwbGljZShmaWx0ZXJJbmRleCwgMSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZXRTb3J0aW5nKGRhdGFTb3J0aW5nOiBEYXRhU29ydGluZ1tdKSB7XG4gICAgICAgIHRoaXMuc29ydGluZyA9IFtdO1xuICAgICAgICBkYXRhU29ydGluZy5mb3JFYWNoKChjb2x1bW5Tb3J0aW5nOiBEYXRhU29ydGluZykgPT4ge1xuICAgICAgICAgICAgY29uc3QgZmllbGRWYWx1ZSA9IHRoaXMuZ2V0U29ydGluZ0ZpZWxkRnJvbUNvbHVtbk5hbWUoY29sdW1uU29ydGluZy5rZXkpO1xuICAgICAgICAgICAgaWYgKGZpZWxkVmFsdWUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBvcHRpb25Bc2NlbmRpbmcgPSBjb2x1bW5Tb3J0aW5nLmRpcmVjdGlvbi50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSAnYXNjJztcbiAgICAgICAgICAgICAgICBjb25zdCB0eXBlID0gZmllbGRWYWx1ZSA9PT0gJ3Njb3JlJyA/ICdTQ09SRScgOiAnRklFTEQnO1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTb3J0OiBTZWFyY2hTb3J0aW5nRGVmaW5pdGlvbiA9IHtcbiAgICAgICAgICAgICAgICAgICAga2V5OiBjb2x1bW5Tb3J0aW5nLmtleSxcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6ICdjdXJyZW50JyxcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogdHlwZSxcbiAgICAgICAgICAgICAgICAgICAgZmllbGQ6IGZpZWxkVmFsdWUsXG4gICAgICAgICAgICAgICAgICAgIGFzY2VuZGluZzogb3B0aW9uQXNjZW5kaW5nXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB0aGlzLnNvcnRpbmcucHVzaChjdXJyZW50U29ydCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuZXhlY3V0ZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0U29ydGluZ0ZpZWxkRnJvbUNvbHVtbk5hbWUoY29sdW1uTmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGlmICh0aGlzLnNvcnRpbmdPcHRpb25zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHNvcnRPcHRpb246IFNlYXJjaFNvcnRpbmdEZWZpbml0aW9uID0gdGhpcy5zb3J0aW5nT3B0aW9ucy5maW5kKChvcHRpb246IFNlYXJjaFNvcnRpbmdEZWZpbml0aW9uKSA9PiBvcHRpb24ua2V5ID09PSBjb2x1bW5OYW1lKTtcbiAgICAgICAgICAgIHJldHVybiBzb3J0T3B0aW9uID8gc29ydE9wdGlvbi5maWVsZCA6ICcnO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAnJztcbiAgICB9XG5cbiAgICBnZXRDYXRlZ29yeUZvckNvbHVtbihjb2x1bW5LZXk6IHN0cmluZyk6IFNlYXJjaENhdGVnb3J5IHtcbiAgICAgICAgbGV0IGZvdW5kQ2F0ZWdvcnkgPSBudWxsO1xuICAgICAgICBpZiAodGhpcy5jYXRlZ29yaWVzICE9PSBudWxsKSB7XG4gICAgICAgICAgICBmb3VuZENhdGVnb3J5ID0gdGhpcy5jYXRlZ29yaWVzLmZpbmQoXG4gICAgICAgICAgICAgICAgY2F0ZWdvcnkgPT4gY2F0ZWdvcnkuY29sdW1uS2V5ID09PSBjb2x1bW5LZXlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZvdW5kQ2F0ZWdvcnk7XG4gICAgfVxuXG4gICAgc2V0Q3VycmVudFJvb3RGb2xkZXJJZChjdXJyZW50Rm9sZGVySWQ6IHN0cmluZykge1xuICAgICAgICBjb25zdCBhbHJlYWR5QWRkZWRGaWx0ZXIgPSB0aGlzLmZpbHRlclF1ZXJpZXMuZmluZChmaWx0ZXJRdWVyaWVzID0+XG4gICAgICAgICAgICBmaWx0ZXJRdWVyaWVzLnF1ZXJ5LmluY2x1ZGVzKGN1cnJlbnRGb2xkZXJJZClcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoYWxyZWFkeUFkZGVkRmlsdGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyUXVlcmllcyA9IFtdO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5maWx0ZXJRdWVyaWVzID0gW3tcbiAgICAgICAgICAgIHF1ZXJ5OiBgUEFSRU5UOlwid29ya3NwYWNlOi8vU3BhY2VzU3RvcmUvJHtjdXJyZW50Rm9sZGVySWR9XCJgXG4gICAgICAgIH1dO1xuXG4gICAgICAgIHRoaXMuZXhlY3V0ZSgpO1xuICAgIH1cblxuICAgIGlzQ3VzdG9tU291cmNlTm9kZShjdXJyZW50Tm9kZUlkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VzdG9tU291cmNlcy5pbmNsdWRlcyhjdXJyZW50Tm9kZUlkKTtcbiAgICB9XG5cbiAgICBnZXROb2RlSWRGb3JDdXN0b21Tb3VyY2UoY3VzdG9tU291cmNlSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8TWluaW1hbE5vZGU+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMubm9kZUFwaVNlcnZpY2UuZ2V0Tm9kZShjdXN0b21Tb3VyY2VJZCk7XG4gICAgfVxuXG59XG4iXX0=