import { Injectable } from '@angular/core';
import { AlfrescoApiService, AppConfigService, NodesApiService } from '@alfresco/adf-core';
import { BaseQueryBuilderService } from './base-query-builder.service';
import { filter } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
export class SearchHeaderQueryBuilderService extends BaseQueryBuilderService {
    constructor(appConfig, alfrescoApiService, nodeApiService) {
        super(appConfig, alfrescoApiService);
        this.nodeApiService = nodeApiService;
        this.customSources = ['-trashcan-', '-sharedlinks-', '-sites-', '-mysites-', '-favorites-', '-recent-', '-my-'];
        this.activeFilters = [];
        this.updated.pipe(filter((query) => !!query)).subscribe(() => {
            this.execute();
        });
    }
    isFilterServiceActive() {
        return true;
    }
    loadConfiguration() {
        return this.appConfig.get('search-headers');
    }
    setupCurrentPagination(maxItems, skipCount) {
        if (!this.paging ||
            (this.paging &&
                this.paging.maxItems !== maxItems || this.paging.skipCount !== skipCount)) {
            this.paging = { maxItems, skipCount };
            this.execute();
        }
    }
    setActiveFilter(columnActivated, filterValue) {
        const selectedFilter = this.activeFilters.find((activeFilter) => activeFilter.key === columnActivated);
        if (!selectedFilter) {
            this.activeFilters.push({
                key: columnActivated,
                value: filterValue
            });
        }
        else {
            selectedFilter.value = filterValue;
        }
    }
    resetActiveFilters() {
        this.activeFilters = [];
    }
    getActiveFilters() {
        return this.activeFilters;
    }
    isNoFilterActive() {
        return this.activeFilters.length === 0;
    }
    removeActiveFilter(columnRemoved) {
        const filterIndex = this.activeFilters.map((activeFilter) => activeFilter.key).indexOf(columnRemoved);
        if (filterIndex >= 0) {
            this.activeFilters.splice(filterIndex, 1);
        }
    }
    setSorting(dataSorting) {
        this.sorting = [];
        dataSorting.forEach((columnSorting) => {
            const fieldValue = this.getSortingFieldFromColumnName(columnSorting.key);
            if (fieldValue) {
                const optionAscending = columnSorting.direction.toLocaleLowerCase() === 'asc';
                const type = fieldValue === 'score' ? 'SCORE' : 'FIELD';
                const currentSort = {
                    key: columnSorting.key,
                    label: 'current',
                    type: type,
                    field: fieldValue,
                    ascending: optionAscending
                };
                this.sorting.push(currentSort);
            }
        });
        this.execute();
    }
    getSortingFieldFromColumnName(columnName) {
        if (this.sortingOptions.length > 0) {
            const sortOption = this.sortingOptions.find((option) => option.key === columnName);
            return sortOption ? sortOption.field : '';
        }
        return '';
    }
    getCategoryForColumn(columnKey) {
        let foundCategory = null;
        if (this.categories !== null) {
            foundCategory = this.categories.find(category => category.columnKey === columnKey);
        }
        return foundCategory;
    }
    setCurrentRootFolderId(currentFolderId) {
        const alreadyAddedFilter = this.filterQueries.find(filterQueries => filterQueries.query.includes(currentFolderId));
        if (alreadyAddedFilter !== undefined) {
            this.filterQueries = [];
        }
        this.filterQueries = [{
                query: `PARENT:"workspace://SpacesStore/${currentFolderId}"`
            }];
        this.execute();
    }
    isCustomSourceNode(currentNodeId) {
        return this.customSources.includes(currentNodeId);
    }
    getNodeIdForCustomSource(customSourceId) {
        return this.nodeApiService.getNode(customSourceId);
    }
}
SearchHeaderQueryBuilderService.ɵfac = function SearchHeaderQueryBuilderService_Factory(t) { return new (t || SearchHeaderQueryBuilderService)(ɵngcc0.ɵɵinject(ɵngcc1.AppConfigService), ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc1.NodesApiService)); };
SearchHeaderQueryBuilderService.ɵprov = i0.ɵɵdefineInjectable({ factory: function SearchHeaderQueryBuilderService_Factory() { return new SearchHeaderQueryBuilderService(i0.ɵɵinject(i1.AppConfigService), i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i1.NodesApiService)); }, token: SearchHeaderQueryBuilderService, providedIn: "root" });
SearchHeaderQueryBuilderService.ctorParameters = () => [
    { type: AppConfigService },
    { type: AlfrescoApiService },
    { type: NodesApiService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(SearchHeaderQueryBuilderService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AppConfigService }, { type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc1.NodesApiService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLWhlYWRlci1xdWVyeS1idWlsZGVyLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb250ZW50LXNlcnZpY2VzL3NyYy9saWIvc2VhcmNoL3NlcnZpY2VzL3NlYXJjaC1oZWFkZXItcXVlcnktYnVpbGRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQWUsTUFBTSxvQkFBb0IsQ0FBQztBQUV4RyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUd2RSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEM7QUFDRTs7O0FBTUYsTUFBTSxPQUFPLCtCQUFnQyxTQUFRLHVCQUF1QjtBQUM1RSxJQUtJLFlBQVksU0FBMkIsRUFDM0Isa0JBQXNDLEVBQzlCLGNBQStCO0FBQ3ZELFFBQVEsS0FBSyxDQUFDLFNBQVMsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO0FBQzdDLFFBRndCLG1CQUFjLEdBQWQsY0FBYyxDQUFpQjtBQUFDLFFBTjVDLGtCQUFhLEdBQUcsQ0FBQyxZQUFZLEVBQUUsZUFBZSxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUN2SCxRQUNJLGtCQUFhLEdBQW1CLEVBQUUsQ0FBQztBQUN2QyxRQU1RLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUNiLE1BQU0sQ0FBQyxDQUFDLEtBQWdCLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFH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MTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlLCBBcHBDb25maWdTZXJ2aWNlLCBOb2Rlc0FwaVNlcnZpY2UsIERhdGFTb3J0aW5nIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IFNlYXJjaENvbmZpZ3VyYXRpb24gfSBmcm9tICcuLi9tb2RlbHMvc2VhcmNoLWNvbmZpZ3VyYXRpb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IEJhc2VRdWVyeUJ1aWxkZXJTZXJ2aWNlIH0gZnJvbSAnLi9iYXNlLXF1ZXJ5LWJ1aWxkZXIuc2VydmljZSc7XG5pbXBvcnQgeyBTZWFyY2hDYXRlZ29yeSB9IGZyb20gJy4uL21vZGVscy9zZWFyY2gtY2F0ZWdvcnkuaW50ZXJmYWNlJztcbmltcG9ydCB7IE1pbmltYWxOb2RlLCBRdWVyeUJvZHkgfSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFNlYXJjaFNvcnRpbmdEZWZpbml0aW9uIH0gZnJvbSAnLi4vbW9kZWxzL3NlYXJjaC1zb3J0aW5nLWRlZmluaXRpb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IEZpbHRlclNlYXJjaCB9IGZyb20gJy4uL21vZGVscy9maWx0ZXItc2VhcmNoLmludGVyZmFjZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgU2VhcmNoSGVhZGVyUXVlcnlCdWlsZGVyU2VydmljZSBleHRlbmRzIEJhc2VRdWVyeUJ1aWxkZXJTZXJ2aWNlIHtcblxuICAgIHByaXZhdGUgY3VzdG9tU291cmNlcyA9IFsnLXRyYXNoY2FuLScsICctc2hhcmVkbGlua3MtJywgJy1zaXRlcy0nLCAnLW15c2l0ZXMtJywgJy1mYXZvcml0ZXMtJywgJy1yZWNlbnQtJywgJy1teS0nXTtcblxuICAgIGFjdGl2ZUZpbHRlcnM6IEZpbHRlclNlYXJjaFtdID0gW107XG5cbiAgICBjb25zdHJ1Y3RvcihhcHBDb25maWc6IEFwcENvbmZpZ1NlcnZpY2UsXG4gICAgICAgICAgICAgICAgYWxmcmVzY29BcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBub2RlQXBpU2VydmljZTogTm9kZXNBcGlTZXJ2aWNlKSB7XG4gICAgICAgIHN1cGVyKGFwcENvbmZpZywgYWxmcmVzY29BcGlTZXJ2aWNlKTtcblxuICAgICAgICB0aGlzLnVwZGF0ZWQucGlwZShcbiAgICAgICAgICAgIGZpbHRlcigocXVlcnk6IFF1ZXJ5Qm9keSkgPT4gISFxdWVyeSkpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmV4ZWN1dGUoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGlzRmlsdGVyU2VydmljZUFjdGl2ZSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgbG9hZENvbmZpZ3VyYXRpb24oKTogU2VhcmNoQ29uZmlndXJhdGlvbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwcENvbmZpZy5nZXQ8U2VhcmNoQ29uZmlndXJhdGlvbj4oJ3NlYXJjaC1oZWFkZXJzJyk7XG4gICAgfVxuXG4gICAgc2V0dXBDdXJyZW50UGFnaW5hdGlvbihtYXhJdGVtczogbnVtYmVyLCBza2lwQ291bnQ6IG51bWJlcikge1xuICAgICAgICBpZiAoIXRoaXMucGFnaW5nIHx8XG4gICAgICAgICAgICAodGhpcy5wYWdpbmcgJiZcbiAgICAgICAgICAgICAgICB0aGlzLnBhZ2luZy5tYXhJdGVtcyAhPT0gbWF4SXRlbXMgfHwgdGhpcy5wYWdpbmcuc2tpcENvdW50ICE9PSBza2lwQ291bnQpKSB7XG4gICAgICAgICAgICB0aGlzLnBhZ2luZyA9IHsgbWF4SXRlbXMsIHNraXBDb3VudCB9O1xuICAgICAgICAgICAgdGhpcy5leGVjdXRlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZXRBY3RpdmVGaWx0ZXIoY29sdW1uQWN0aXZhdGVkOiBzdHJpbmcsIGZpbHRlclZhbHVlOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRGaWx0ZXIgPSB0aGlzLmFjdGl2ZUZpbHRlcnMuZmluZCgoYWN0aXZlRmlsdGVyKSA9PiBhY3RpdmVGaWx0ZXIua2V5ID09PSBjb2x1bW5BY3RpdmF0ZWQpO1xuICAgICAgICBpZiAoIXNlbGVjdGVkRmlsdGVyKSB7XG4gICAgICAgICAgICB0aGlzLmFjdGl2ZUZpbHRlcnMucHVzaCg8RmlsdGVyU2VhcmNoPiB7XG4gICAgICAgICAgICAgICAga2V5OiBjb2x1bW5BY3RpdmF0ZWQsXG4gICAgICAgICAgICAgICAgdmFsdWU6IGZpbHRlclZhbHVlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHNlbGVjdGVkRmlsdGVyLnZhbHVlID0gZmlsdGVyVmFsdWU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXNldEFjdGl2ZUZpbHRlcnMoKSB7XG4gICAgICAgIHRoaXMuYWN0aXZlRmlsdGVycyA9IFtdO1xuICAgIH1cblxuICAgIGdldEFjdGl2ZUZpbHRlcnMoKTogRmlsdGVyU2VhcmNoW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5hY3RpdmVGaWx0ZXJzO1xuICAgIH1cblxuICAgIGlzTm9GaWx0ZXJBY3RpdmUoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFjdGl2ZUZpbHRlcnMubGVuZ3RoID09PSAwO1xuICAgIH1cblxuICAgIHJlbW92ZUFjdGl2ZUZpbHRlcihjb2x1bW5SZW1vdmVkOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgZmlsdGVySW5kZXggPSB0aGlzLmFjdGl2ZUZpbHRlcnMubWFwKChhY3RpdmVGaWx0ZXIpID0+IGFjdGl2ZUZpbHRlci5rZXkpLmluZGV4T2YoY29sdW1uUmVtb3ZlZCk7XG4gICAgICAgIGlmIChmaWx0ZXJJbmRleCA+PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmFjdGl2ZUZpbHRlcnMuc3BsaWNlKGZpbHRlckluZGV4LCAxKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNldFNvcnRpbmcoZGF0YVNvcnRpbmc6IERhdGFTb3J0aW5nW10pIHtcbiAgICAgICAgdGhpcy5zb3J0aW5nID0gW107XG4gICAgICAgIGRhdGFTb3J0aW5nLmZvckVhY2goKGNvbHVtblNvcnRpbmc6IERhdGFTb3J0aW5nKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBmaWVsZFZhbHVlID0gdGhpcy5nZXRTb3J0aW5nRmllbGRGcm9tQ29sdW1uTmFtZShjb2x1bW5Tb3J0aW5nLmtleSk7XG4gICAgICAgICAgICBpZiAoZmllbGRWYWx1ZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG9wdGlvbkFzY2VuZGluZyA9IGNvbHVtblNvcnRpbmcuZGlyZWN0aW9uLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09ICdhc2MnO1xuICAgICAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBmaWVsZFZhbHVlID09PSAnc2NvcmUnID8gJ1NDT1JFJyA6ICdGSUVMRCc7XG4gICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNvcnQ6IFNlYXJjaFNvcnRpbmdEZWZpbml0aW9uID0ge1xuICAgICAgICAgICAgICAgICAgICBrZXk6IGNvbHVtblNvcnRpbmcua2V5LFxuICAgICAgICAgICAgICAgICAgICBsYWJlbDogJ2N1cnJlbnQnLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLFxuICAgICAgICAgICAgICAgICAgICBmaWVsZDogZmllbGRWYWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgYXNjZW5kaW5nOiBvcHRpb25Bc2NlbmRpbmdcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHRoaXMuc29ydGluZy5wdXNoKGN1cnJlbnRTb3J0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5leGVjdXRlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRTb3J0aW5nRmllbGRGcm9tQ29sdW1uTmFtZShjb2x1bW5OYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKHRoaXMuc29ydGluZ09wdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3Qgc29ydE9wdGlvbjogU2VhcmNoU29ydGluZ0RlZmluaXRpb24gPSB0aGlzLnNvcnRpbmdPcHRpb25zLmZpbmQoKG9wdGlvbjogU2VhcmNoU29ydGluZ0RlZmluaXRpb24pID0+IG9wdGlvbi5rZXkgPT09IGNvbHVtbk5hbWUpO1xuICAgICAgICAgICAgcmV0dXJuIHNvcnRPcHRpb24gPyBzb3J0T3B0aW9uLmZpZWxkIDogJyc7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICcnO1xuICAgIH1cblxuICAgIGdldENhdGVnb3J5Rm9yQ29sdW1uKGNvbHVtbktleTogc3RyaW5nKTogU2VhcmNoQ2F0ZWdvcnkge1xuICAgICAgICBsZXQgZm91bmRDYXRlZ29yeSA9IG51bGw7XG4gICAgICAgIGlmICh0aGlzLmNhdGVnb3JpZXMgIT09IG51bGwpIHtcbiAgICAgICAgICAgIGZvdW5kQ2F0ZWdvcnkgPSB0aGlzLmNhdGVnb3JpZXMuZmluZChcbiAgICAgICAgICAgICAgICBjYXRlZ29yeSA9PiBjYXRlZ29yeS5jb2x1bW5LZXkgPT09IGNvbHVtbktleVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZm91bmRDYXRlZ29yeTtcbiAgICB9XG5cbiAgICBzZXRDdXJyZW50Um9vdEZvbGRlcklkKGN1cnJlbnRGb2xkZXJJZDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGFscmVhZHlBZGRlZEZpbHRlciA9IHRoaXMuZmlsdGVyUXVlcmllcy5maW5kKGZpbHRlclF1ZXJpZXMgPT5cbiAgICAgICAgICAgIGZpbHRlclF1ZXJpZXMucXVlcnkuaW5jbHVkZXMoY3VycmVudEZvbGRlcklkKVxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChhbHJlYWR5QWRkZWRGaWx0ZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5maWx0ZXJRdWVyaWVzID0gW107XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmZpbHRlclF1ZXJpZXMgPSBbe1xuICAgICAgICAgICAgcXVlcnk6IGBQQVJFTlQ6XCJ3b3Jrc3BhY2U6Ly9TcGFjZXNTdG9yZS8ke2N1cnJlbnRGb2xkZXJJZH1cImBcbiAgICAgICAgfV07XG5cbiAgICAgICAgdGhpcy5leGVjdXRlKCk7XG4gICAgfVxuXG4gICAgaXNDdXN0b21Tb3VyY2VOb2RlKGN1cnJlbnROb2RlSWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jdXN0b21Tb3VyY2VzLmluY2x1ZGVzKGN1cnJlbnROb2RlSWQpO1xuICAgIH1cblxuICAgIGdldE5vZGVJZEZvckN1c3RvbVNvdXJjZShjdXN0b21Tb3VyY2VJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxNaW5pbWFsTm9kZT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5ub2RlQXBpU2VydmljZS5nZXROb2RlKGN1c3RvbVNvdXJjZUlkKTtcbiAgICB9XG5cbn1cbiJdfQ==