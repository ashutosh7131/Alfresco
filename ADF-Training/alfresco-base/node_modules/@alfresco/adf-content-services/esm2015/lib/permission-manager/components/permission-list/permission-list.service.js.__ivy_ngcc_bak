import { AllowableOperationsEnum, ContentService, NodesApiService, NotificationService } from '@alfresco/adf-core';
import { EventEmitter, Injectable } from '@angular/core';
import { BehaviorSubject, forkJoin, of, Subject } from 'rxjs';
import { finalize, map, switchMap } from 'rxjs/operators';
import { NodePermissionService } from '../../services/node-permission.service';
import { NodePermissionDialogService } from '../../services/node-permission-dialog.service';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as i2 from "../../services/node-permission.service";
import * as i3 from "../../services/node-permission-dialog.service";
export class PermissionListService {
    constructor(nodeService, nodePermissionService, nodePermissionDialogService, contentService, notificationService) {
        this.nodeService = nodeService;
        this.nodePermissionService = nodePermissionService;
        this.nodePermissionDialogService = nodePermissionDialogService;
        this.contentService = contentService;
        this.notificationService = notificationService;
        this.updated = new EventEmitter();
        this.errored = new EventEmitter();
        this.loading$ = new BehaviorSubject(true);
        this.error$ = new Subject();
        this.nodeWithRoles$ = new Subject();
        this.data$ = this.nodeWithRoles$.pipe(map(({ node, roles }) => {
            const nodeLocalPermissions = this.nodePermissionService.getLocalPermissions(node);
            const localPermissions = this.updateReadOnlyPermission(node, nodeLocalPermissions);
            return {
                node,
                roles,
                localPermissions,
                inheritedPermissions: this.nodePermissionService.getInheritedPermission(node)
            };
        }));
        this.SITE_MANAGER_ROLE = 'SiteManager';
    }
    fetchPermission(nodeId) {
        this.loading$.next(true);
        this.nodePermissionService.getNodeWithRoles(nodeId)
            .pipe(finalize(() => this.loading$.next(false)))
            .subscribe(({ node, roles }) => {
            this.node = node;
            this.roles = roles;
            this.nodeWithRoles$.next({ node, roles });
        }, () => this.error$.next(true));
    }
    toggleInherited(change) {
        if (this.contentService.hasAllowableOperations(this.node, AllowableOperationsEnum.UPDATEPERMISSIONS)) {
            let updateLocalPermission$ = of(null);
            const nodeBody = {
                permissions: {
                    isInheritanceEnabled: !this.node.permissions.isInheritanceEnabled
                }
            };
            const authorityId = this.getManagerAuthority(this.node);
            if (authorityId) {
                const permissions = [
                    ...(this.node.permissions.locallySet || []),
                    { authorityId, name: this.SITE_MANAGER_ROLE, accessStatus: 'ALLOWED' }
                ];
                updateLocalPermission$ = this.nodePermissionService.updatePermissions(this.node, permissions);
            }
            updateLocalPermission$.pipe(switchMap(() => this.nodeService.updateNode(this.node.id, nodeBody, { include: ['permissions'] })))
                .subscribe((nodeUpdated) => {
                var _a, _b;
                const message = nodeUpdated.permissions.isInheritanceEnabled ? 'PERMISSION_MANAGER.MESSAGE.INHERIT-ENABLE-SUCCESS' : 'PERMISSION_MANAGER.MESSAGE.INHERIT-DISABLE-SUCCESS';
                this.notificationService.showInfo(message);
                nodeUpdated.permissions.inherited = (_b = (_a = nodeUpdated.permissions) === null || _a === void 0 ? void 0 : _a.inherited) !== null && _b !== void 0 ? _b : [];
                this.reloadNode(nodeUpdated);
            }, () => {
                change.source.checked = this.node.permissions.isInheritanceEnabled;
                this.notificationService.showWarning('PERMISSION_MANAGER.MESSAGE.TOGGLE-PERMISSION-FAILED');
            });
        }
        else {
            change.source.checked = this.node.permissions.isInheritanceEnabled;
            this.notificationService.showError('PERMISSION_MANAGER.ERROR.NOT-ALLOWED');
        }
    }
    updateNodePermissionByDialog() {
        this.nodePermissionDialogService
            .openAddPermissionDialog(this.node, this.roles, 'PERMISSION_MANAGER.ADD-PERMISSION.TITLE')
            .pipe(switchMap(selection => {
            const total = selection.length;
            const group = selection.filter(({ authorityId }) => this.isGroup(authorityId)).length;
            return forkJoin({
                user: of(total - group),
                group: of(group),
                node: this.nodePermissionService.updateNodePermissions(this.node.id, selection)
            });
        }))
            .subscribe(({ user, group, node }) => {
            this.notificationService.showInfo('PERMISSION_MANAGER.MESSAGE.PERMISSION-ADD-SUCCESS', null, { user, group });
            this.reloadNode(node);
        }, () => {
            this.notificationService.showError('PERMISSION_MANAGER.MESSAGE.PERMISSION-ADD-FAIL');
            this.reloadNode();
        });
    }
    deletePermissions(permissions) {
        this.nodePermissionService.removePermissions(this.node, permissions)
            .subscribe((node) => {
            const total = permissions.length;
            const group = permissions.filter(({ authorityId }) => this.isGroup(authorityId)).length;
            this.notificationService.showInfo('PERMISSION_MANAGER.MESSAGE.PERMISSION-BULK-DELETE-SUCCESS', null, { user: total - group, group });
            this.reloadNode(node);
        }, () => {
            this.notificationService.showError('PERMISSION_MANAGER.MESSAGE.PERMISSION-DELETE-FAIL');
            this.reloadNode();
        });
    }
    updateRole(role, permission) {
        const updatedPermissionRole = this.buildUpdatedPermission(role, permission);
        this.nodePermissionService.updatePermissionRole(this.node, updatedPermissionRole)
            .subscribe((node) => {
            this.notificationService.showInfo('PERMISSION_MANAGER.MESSAGE.PERMISSION-UPDATE-SUCCESS');
            this.reloadNode(node);
            this.updated.emit(permission);
        }, () => {
            this.notificationService.showError('PERMISSION_MANAGER.MESSAGE.PERMISSION-UPDATE-FAIL');
            this.reloadNode();
            this.errored.emit(permission);
        });
    }
    bulkRoleUpdate(role) {
        const permissions = [...this.node.permissions.locallySet].map((permission) => this.buildUpdatedPermission(role, permission));
        this.nodePermissionService.updatePermissions(this.node, permissions)
            .subscribe((node) => {
            const total = permissions.length;
            const group = permissions.filter(({ authorityId }) => this.isGroup(authorityId)).length;
            this.notificationService.showInfo('PERMISSION_MANAGER.MESSAGE.PERMISSION-BULK-UPDATE-SUCCESS', null, { user: total - group, group });
            this.reloadNode(node);
        }, () => {
            this.notificationService.showError('PERMISSION_MANAGER.MESSAGE.PERMISSION-UPDATE-FAIL');
            this.reloadNode();
        });
    }
    deletePermission(permission) {
        const cloneNode = Object.assign(Object.assign({}, this.node), { permissions: Object.assign(Object.assign({}, this.node.permissions), { locallySet: [...this.node.permissions.locallySet] }) });
        this.nodePermissionService
            .removePermission(cloneNode, permission)
            .subscribe((node) => {
            this.notificationService.showInfo('PERMISSION_MANAGER.MESSAGE.PERMISSION-DELETE-SUCCESS');
            if (!node.permissions.locallySet) {
                node.permissions.locallySet = [];
            }
            this.reloadNode(node);
        }, () => {
            this.notificationService.showError('PERMISSION_MANAGER.MESSAGE.PERMISSION-DELETE-FAIL');
            this.reloadNode();
        });
    }
    buildUpdatedPermission(role, permission) {
        return {
            accessStatus: permission.accessStatus,
            name: this.canUpdateThePermission(this.node, permission) ? role : permission.name,
            authorityId: permission.authorityId
        };
    }
    reloadNode(node) {
        if (node != null) {
            Object.assign(this.node.permissions, node.permissions);
        }
        this.nodeWithRoles$.next({ node: this.node, roles: this.roles });
    }
    getManagerAuthority(node) {
        var _a;
        const sitePath = node.path.elements.find((path) => path.nodeType === 'st:site');
        let hasLocalManagerPermission = false, authorityId;
        if (sitePath) {
            authorityId = `GROUP_site_${sitePath.name}_${this.SITE_MANAGER_ROLE}`;
            hasLocalManagerPermission = !!((_a = node.permissions.locallySet) === null || _a === void 0 ? void 0 : _a.find((permission) => permission.authorityId === authorityId && permission.name === this.SITE_MANAGER_ROLE));
        }
        if (!hasLocalManagerPermission && authorityId) {
            return authorityId;
        }
        return null;
    }
    updateReadOnlyPermission(node, permissions) {
        permissions.forEach((permission) => {
            if (!this.canUpdateThePermission(node, permission)) {
                permission.readonly = true;
            }
        });
        return permissions;
    }
    canUpdateThePermission(node, permission) {
        const sitePath = node.path.elements.find((path) => path.nodeType === 'st:site');
        if (!node.permissions.isInheritanceEnabled && sitePath) {
            const authorityId = `GROUP_site_${sitePath.name}_${this.SITE_MANAGER_ROLE}`;
            return !(permission.authorityId === authorityId && permission.name === this.SITE_MANAGER_ROLE);
        }
        return true;
    }
    isGroup(authorityId) {
        return authorityId.startsWith('GROUP_') || authorityId.startsWith('ROLE_');
    }
}
PermissionListService.Éµprov = i0.ÉµÉµdefineInjectable({ factory: function PermissionListService_Factory() { return new PermissionListService(i0.ÉµÉµinject(i1.NodesApiService), i0.ÉµÉµinject(i2.NodePermissionService), i0.ÉµÉµinject(i3.NodePermissionDialogService), i0.ÉµÉµinject(i1.ContentService), i0.ÉµÉµinject(i1.NotificationService)); }, token: PermissionListService, providedIn: "root" });
PermissionListService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
PermissionListService.ctorParameters = () => [
    { type: NodesApiService },
    { type: NodePermissionService },
    { type: NodePermissionDialogService },
    { type: ContentService },
    { type: NotificationService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbi1saXN0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb250ZW50LXNlcnZpY2VzL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9wZXJtaXNzaW9uLW1hbmFnZXIvY29tcG9uZW50cy9wZXJtaXNzaW9uLWxpc3QvcGVybWlzc2lvbi1saXN0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBaUJBLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxjQUFjLEVBQUUsZUFBZSxFQUFFLG1CQUFtQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFbkgsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFekQsT0FBTyxFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxRSxPQUFPLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUkxRCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUMvRSxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSwrQ0FBK0MsQ0FBQzs7Ozs7QUFLNUYsTUFBTSxPQUFPLHFCQUFxQjtJQXdCOUIsWUFDWSxXQUE0QixFQUM1QixxQkFBNEMsRUFDNUMsMkJBQXdELEVBQ3hELGNBQThCLEVBQzlCLG1CQUF3QztRQUp4QyxnQkFBVyxHQUFYLFdBQVcsQ0FBaUI7UUFDNUIsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF1QjtRQUM1QyxnQ0FBMkIsR0FBM0IsMkJBQTJCLENBQTZCO1FBQ3hELG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5Qix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBNUJwRCxZQUFPLEdBQUcsSUFBSSxZQUFZLEVBQTBCLENBQUM7UUFDckQs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QUN2QixDQUFDO0lBRUQsc0JBQXNCLENBQUMsSUFBVSxFQUFFLFVBQTZCO1FBQzVELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUMsQ0FBQztRQUNoRixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxvQkFBb0IsSUFBSSxRQUFRLEVBQUU7WUFDckQsTUFBTSxXQUFXLEdBQUcsY0FBYyxRQUFRLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1lBQzVFLE9BQU8sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxXQUFXLEtBQUssV0FBVyxJQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7U0FDakc7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRU8sT0FBTyxDQUFDLFdBQVc7UUFDdkIsT0FBTyxXQUFXLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDL0UsQ0FBQzs7OztZQWpPSixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7OztZQWRpRCxlQUFlO1lBU3hELHFCQUFxQjtZQUNyQiwyQkFBMkI7WUFWRixjQUFjO1lBQW1CLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEFsbG93YWJsZU9wZXJhdGlvbnNFbnVtLCBDb250ZW50U2VydmljZSwgTm9kZXNBcGlTZXJ2aWNlLCBOb3RpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IE5vZGUsIFBlcm1pc3Npb25FbGVtZW50IH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE1hdFNsaWRlVG9nZ2xlQ2hhbmdlIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvc2xpZGUtdG9nZ2xlJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgZm9ya0pvaW4sIE9ic2VydmFibGUsIG9mLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaW5hbGl6ZSwgbWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBSb2xlTW9kZWwgfSBmcm9tICcuLi8uLi9tb2RlbHMvcm9sZS5tb2RlbCc7XG5pbXBvcnQgeyBQZXJtaXNzaW9uRGlzcGxheU1vZGVsIH0gZnJvbSAnLi4vLi4vbW9kZWxzL3Blcm1pc3Npb24ubW9kZWwnO1xuaW1wb3J0IHsgTm9kZVBlcm1pc3Npb25zTW9kZWwgfSBmcm9tICcuLi8uLi9tb2RlbHMvbWVtYmVyLm1vZGVsJztcbmltcG9ydCB7IE5vZGVQZXJtaXNzaW9uU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL25vZGUtcGVybWlzc2lvbi5zZXJ2aWNlJztcbmltcG9ydCB7IE5vZGVQZXJtaXNzaW9uRGlhbG9nU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL25vZGUtcGVybWlzc2lvbi1kaWFsb2cuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFBlcm1pc3Npb25MaXN0U2VydmljZSB7XG4gICAgdXBkYXRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8UGVybWlzc2lvbkRpc3BsYXlNb2RlbD4oKTtcbiAgICBlcnJvcmVkID0gbmV3IEV2ZW50RW1pdHRlcjxQZXJtaXNzaW9uRGlzcGxheU1vZGVsPigpO1xuXG4gICAgbG9hZGluZyQ6IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPiA9IG5ldyBCZWhhdmlvclN1YmplY3QodHJ1ZSk7XG4gICAgZXJyb3IkOiBTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IFN1YmplY3QoKTtcbiAgICBub2RlV2l0aFJvbGVzJDogU3ViamVjdDx7IG5vZGU6IE5vZGUsIHJvbGVzOiBSb2xlTW9kZWxbXSB9PiA9IG5ldyBTdWJqZWN0KCk7XG4gICAgZGF0YSQ6IE9ic2VydmFibGU8Tm9kZVBlcm1pc3Npb25zTW9kZWw+ID0gdGhpcy5ub2RlV2l0aFJvbGVzJC5waXBlKFxuICAgICAgICBtYXAoKHsgbm9kZSwgcm9sZXN9KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBub2RlTG9jYWxQZXJtaXNzaW9ucyA9IHRoaXMubm9kZVBlcm1pc3Npb25TZXJ2aWNlLmdldExvY2FsUGVybWlzc2lvbnMobm9kZSk7XG4gICAgICAgICAgICBjb25zdCBsb2NhbFBlcm1pc3Npb25zID0gdGhpcy51cGRhdGVSZWFkT25seVBlcm1pc3Npb24obm9kZSwgbm9kZUxvY2FsUGVybWlzc2lvbnMpO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBub2RlLFxuICAgICAgICAgICAgICAgIHJvbGVzLFxuICAgICAgICAgICAgICAgIGxvY2FsUGVybWlzc2lvbnMsXG4gICAgICAgICAgICAgICAgaW5oZXJpdGVkUGVybWlzc2lvbnM6IHRoaXMubm9kZVBlcm1pc3Npb25TZXJ2aWNlLmdldEluaGVyaXRlZFBlcm1pc3Npb24obm9kZSlcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pXG4gICAgKTtcblxuICAgIHByaXZhdGUgbm9kZTogTm9kZTtcbiAgICBwcml2YXRlIHJvbGVzOiBSb2xlTW9kZWxbXTtcbiAgICBwcml2YXRlIFNJVEVfTUFOQUdFUl9ST0xFID0gJ1NpdGVNYW5hZ2VyJztcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIG5vZGVTZXJ2aWNlOiBOb2Rlc0FwaVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgbm9kZVBlcm1pc3Npb25TZXJ2aWNlOiBOb2RlUGVybWlzc2lvblNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgbm9kZVBlcm1pc3Npb25EaWFsb2dTZXJ2aWNlOiBOb2RlUGVybWlzc2lvbkRpYWxvZ1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgY29udGVudFNlcnZpY2U6IENvbnRlbnRTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIG5vdGlmaWNhdGlvblNlcnZpY2U6IE5vdGlmaWNhdGlvblNlcnZpY2VcbiAgICApIHt9XG5cbiAgICBmZXRjaFBlcm1pc3Npb24obm9kZUlkOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5sb2FkaW5nJC5uZXh0KHRydWUpO1xuICAgICAgICB0aGlzLm5vZGVQZXJtaXNzaW9uU2VydmljZS5nZXROb2RlV2l0aFJvbGVzKG5vZGVJZClcbiAgICAgICAgICAgIC5waXBlKGZpbmFsaXplKCgpID0+IHRoaXMubG9hZGluZyQubmV4dChmYWxzZSkpKVxuICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoeyBub2RlLCByb2xlcyB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubm9kZSA9IG5vZGU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucm9sZXMgPSByb2xlcztcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ub2RlV2l0aFJvbGVzJC5uZXh0KHsgbm9kZSwgcm9sZXMgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoKSA9PiB0aGlzLmVycm9yJC5uZXh0KHRydWUpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHRvZ2dsZUluaGVyaXRlZChjaGFuZ2U6IE1hdFNsaWRlVG9nZ2xlQ2hhbmdlKSB7XG4gICAgICAgIGlmICh0aGlzLmNvbnRlbnRTZXJ2aWNlLmhhc0FsbG93YWJsZU9wZXJhdGlvbnModGhpcy5ub2RlLCBBbGxvd2FibGVPcGVyYXRpb25zRW51bS5VUERBVEVQRVJNSVNTSU9OUykpIHtcbiAgICAgICAgICAgIGxldCB1cGRhdGVMb2NhbFBlcm1pc3Npb24kID0gb2YobnVsbCk7XG4gICAgICAgICAgICBjb25zdCBub2RlQm9keSA9IHtcbiAgICAgICAgICAgICAgICBwZXJtaXNzaW9uczoge1xuICAgICAgICAgICAgICAgICAgICBpc0luaGVyaXRhbmNlRW5hYmxlZDogIXRoaXMubm9kZS5wZXJtaXNzaW9ucy5pc0luaGVyaXRhbmNlRW5hYmxlZFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGNvbnN0IGF1dGhvcml0eUlkID0gdGhpcy5nZXRNYW5hZ2VyQXV0aG9yaXR5KHRoaXMubm9kZSk7XG4gICAgICAgICAgICBpZiAoYXV0aG9yaXR5SWQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBwZXJtaXNzaW9ucyA9IFtcbiAgICAgICAgICAgICAgICAgICAgLi4uKHRoaXMubm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0IHx8IFtdKSxcbiAgICAgICAgICAgICAgICAgICAgeyBhdXRob3JpdHlJZCwgbmFtZTogdGhpcy5TSVRFX01BTkFHRVJfUk9MRSwgYWNjZXNzU3RhdHVzOiAnQUxMT1dFRCcgfVxuICAgICAgICAgICAgICAgIF07XG4gICAgICAgICAgICAgICAgdXBkYXRlTG9jYWxQZXJtaXNzaW9uJCA9IHRoaXMubm9kZVBlcm1pc3Npb25TZXJ2aWNlLnVwZGF0ZVBlcm1pc3Npb25zKHRoaXMubm9kZSwgcGVybWlzc2lvbnMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB1cGRhdGVMb2NhbFBlcm1pc3Npb24kLnBpcGUoc3dpdGNoTWFwKCgpID0+IHRoaXMubm9kZVNlcnZpY2UudXBkYXRlTm9kZSh0aGlzLm5vZGUuaWQsIG5vZGVCb2R5LCB7aW5jbHVkZTogWydwZXJtaXNzaW9ucyddfSkpKVxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgICAgIChub2RlVXBkYXRlZDogTm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IG5vZGVVcGRhdGVkLnBlcm1pc3Npb25zLmlzSW5oZXJpdGFuY2VFbmFibGVkID8gJ1BFUk1JU1NJT05fTUFOQUdFUi5NRVNTQUdFLklOSEVSSVQtRU5BQkxFLVNVQ0NFU1MnIDogJ1BFUk1JU1NJT05fTUFOQUdFUi5NRVNTQUdFLklOSEVSSVQtRElTQUJMRS1TVUNDRVNTJztcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubm90aWZpY2F0aW9uU2VydmljZS5zaG93SW5mbyhtZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVVcGRhdGVkLnBlcm1pc3Npb25zLmluaGVyaXRlZCA9IG5vZGVVcGRhdGVkLnBlcm1pc3Npb25zPy5pbmhlcml0ZWQgPz8gW107XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbG9hZE5vZGUobm9kZVVwZGF0ZWQpO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2Uuc291cmNlLmNoZWNrZWQgPSB0aGlzLm5vZGUucGVybWlzc2lvbnMuaXNJbmhlcml0YW5jZUVuYWJsZWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5vdGlmaWNhdGlvblNlcnZpY2Uuc2hvd1dhcm5pbmcoJ1BFUk1JU1NJT05fTUFOQUdFUi5NRVNTQUdFLlRPR0dMRS1QRVJNSVNTSU9OLUZBSUxFRCcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNoYW5nZS5zb3VyY2UuY2hlY2tlZCA9IHRoaXMubm9kZS5wZXJtaXNzaW9ucy5pc0luaGVyaXRhbmNlRW5hYmxlZDtcbiAgICAgICAgICAgIHRoaXMubm90aWZpY2F0aW9uU2VydmljZS5zaG93RXJyb3IoJ1BFUk1JU1NJT05fTUFOQUdFUi5FUlJPUi5OT1QtQUxMT1dFRCcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdXBkYXRlTm9kZVBlcm1pc3Npb25CeURpYWxvZygpIHtcbiAgICAgICAgdGhpcy5ub2RlUGVybWlzc2lvbkRpYWxvZ1NlcnZpY2VcbiAgICAgICAgICAgIC5vcGVuQWRkUGVybWlzc2lvbkRpYWxvZyh0aGlzLm5vZGUsIHRoaXMucm9sZXMsICdQRVJNSVNTSU9OX01BTkFHRVIuQURELVBFUk1JU1NJT04uVElUTEUnKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKHNlbGVjdGlvbiA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsID0gc2VsZWN0aW9uLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ3JvdXAgPSBzZWxlY3Rpb24uZmlsdGVyKCh7YXV0aG9yaXR5SWR9KSA9PiB0aGlzLmlzR3JvdXAoYXV0aG9yaXR5SWQpKS5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmb3JrSm9pbih7XG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VyOiBvZih0b3RhbCAtIGdyb3VwKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwOiBvZihncm91cCksXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlOiB0aGlzLm5vZGVQZXJtaXNzaW9uU2VydmljZS51cGRhdGVOb2RlUGVybWlzc2lvbnModGhpcy5ub2RlLmlkLCBzZWxlY3Rpb24pXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAuc3Vic2NyaWJlKCh7IHVzZXIsICBncm91cCwgbm9kZX0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3RpZmljYXRpb25TZXJ2aWNlLnNob3dJbmZvKCAnUEVSTUlTU0lPTl9NQU5BR0VSLk1FU1NBR0UuUEVSTUlTU0lPTi1BREQtU1VDQ0VTUycsIG51bGwsIHsgdXNlciwgZ3JvdXAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVsb2FkTm9kZShub2RlKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3RpZmljYXRpb25TZXJ2aWNlLnNob3dFcnJvciggJ1BFUk1JU1NJT05fTUFOQUdFUi5NRVNTQUdFLlBFUk1JU1NJT04tQURELUZBSUwnKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWxvYWROb2RlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBkZWxldGVQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbkVsZW1lbnRbXSkge1xuICAgICAgICB0aGlzLm5vZGVQZXJtaXNzaW9uU2VydmljZS5yZW1vdmVQZXJtaXNzaW9ucyh0aGlzLm5vZGUsIHBlcm1pc3Npb25zKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgobm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbCA9IHBlcm1pc3Npb25zLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ3JvdXAgPSBwZXJtaXNzaW9ucy5maWx0ZXIoKHthdXRob3JpdHlJZH0pID0+IHRoaXMuaXNHcm91cChhdXRob3JpdHlJZCkpLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3RpZmljYXRpb25TZXJ2aWNlLnNob3dJbmZvKCdQRVJNSVNTSU9OX01BTkFHRVIuTUVTU0FHRS5QRVJNSVNTSU9OLUJVTEstREVMRVRFLVNVQ0NFU1MnLCBudWxsLCB7dXNlcjogdG90YWwgLSBncm91cCwgZ3JvdXB9KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWxvYWROb2RlKG5vZGUpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm5vdGlmaWNhdGlvblNlcnZpY2Uuc2hvd0Vycm9yKCdQRVJNSVNTSU9OX01BTkFHRVIuTUVTU0FHRS5QRVJNSVNTSU9OLURFTEVURS1GQUlMJyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVsb2FkTm9kZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgdXBkYXRlUm9sZShyb2xlOiBzdHJpbmcsIHBlcm1pc3Npb246IFBlcm1pc3Npb25EaXNwbGF5TW9kZWwpIHtcbiAgICAgICAgY29uc3QgdXBkYXRlZFBlcm1pc3Npb25Sb2xlID0gdGhpcy5idWlsZFVwZGF0ZWRQZXJtaXNzaW9uKHJvbGUsIHBlcm1pc3Npb24pO1xuICAgICAgICB0aGlzLm5vZGVQZXJtaXNzaW9uU2VydmljZS51cGRhdGVQZXJtaXNzaW9uUm9sZSh0aGlzLm5vZGUsIHVwZGF0ZWRQZXJtaXNzaW9uUm9sZSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKG5vZGUpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm5vdGlmaWNhdGlvblNlcnZpY2Uuc2hvd0luZm8oJ1BFUk1JU1NJT05fTUFOQUdFUi5NRVNTQUdFLlBFUk1JU1NJT04tVVBEQVRFLVNVQ0NFU1MnKTtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbG9hZE5vZGUobm9kZSk7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVkLmVtaXQocGVybWlzc2lvbik7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubm90aWZpY2F0aW9uU2VydmljZS5zaG93RXJyb3IoJ1BFUk1JU1NJT05fTUFOQUdFUi5NRVNTQUdFLlBFUk1JU1NJT04tVVBEQVRFLUZBSUwnKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWxvYWROb2RlKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXJyb3JlZC5lbWl0KHBlcm1pc3Npb24pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgYnVsa1JvbGVVcGRhdGUocm9sZTogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHBlcm1pc3Npb25zID0gWy4uLnRoaXMubm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0XS5tYXAoKHBlcm1pc3Npb24pID0+IHRoaXMuYnVpbGRVcGRhdGVkUGVybWlzc2lvbihyb2xlLCBwZXJtaXNzaW9uKSk7XG4gICAgICAgIHRoaXMubm9kZVBlcm1pc3Npb25TZXJ2aWNlLnVwZGF0ZVBlcm1pc3Npb25zKHRoaXMubm9kZSwgcGVybWlzc2lvbnMpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKChub2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsID0gcGVybWlzc2lvbnMubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBncm91cCA9IHBlcm1pc3Npb25zLmZpbHRlcigoe2F1dGhvcml0eUlkfSkgPT4gdGhpcy5pc0dyb3VwKGF1dGhvcml0eUlkKSkubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm5vdGlmaWNhdGlvblNlcnZpY2Uuc2hvd0luZm8oJ1BFUk1JU1NJT05fTUFOQUdFUi5NRVNTQUdFLlBFUk1JU1NJT04tQlVMSy1VUERBVEUtU1VDQ0VTUycsIG51bGwsIHt1c2VyOiB0b3RhbCAtIGdyb3VwLCBncm91cH0pO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbG9hZE5vZGUobm9kZSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubm90aWZpY2F0aW9uU2VydmljZS5zaG93RXJyb3IoJ1BFUk1JU1NJT05fTUFOQUdFUi5NRVNTQUdFLlBFUk1JU1NJT04tVVBEQVRFLUZBSUwnKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWxvYWROb2RlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBkZWxldGVQZXJtaXNzaW9uKHBlcm1pc3Npb246IFBlcm1pc3Npb25EaXNwbGF5TW9kZWwpIHtcbiAgICAgICAgY29uc3QgY2xvbmVOb2RlID0geyAuLi50aGlzLm5vZGUsIHBlcm1pc3Npb25zOiB7IC4uLnRoaXMubm9kZS5wZXJtaXNzaW9ucywgbG9jYWxseVNldDogWyAuLi50aGlzLm5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldCBdIH0gfTtcbiAgICAgICAgdGhpcy5ub2RlUGVybWlzc2lvblNlcnZpY2VcbiAgICAgICAgICAgIC5yZW1vdmVQZXJtaXNzaW9uKGNsb25lTm9kZSwgcGVybWlzc2lvbilcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKG5vZGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3RpZmljYXRpb25TZXJ2aWNlLnNob3dJbmZvKCdQRVJNSVNTSU9OX01BTkFHRVIuTUVTU0FHRS5QRVJNSVNTSU9OLURFTEVURS1TVUNDRVNTJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgIG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldCA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVsb2FkTm9kZShub2RlKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3RpZmljYXRpb25TZXJ2aWNlLnNob3dFcnJvcignUEVSTUlTU0lPTl9NQU5BR0VSLk1FU1NBR0UuUEVSTUlTU0lPTi1ERUxFVEUtRkFJTCcpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbG9hZE5vZGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgYnVpbGRVcGRhdGVkUGVybWlzc2lvbihyb2xlOiBzdHJpbmcsIHBlcm1pc3Npb246IFBlcm1pc3Npb25FbGVtZW50KTogUGVybWlzc2lvbkVsZW1lbnQge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgYWNjZXNzU3RhdHVzOiBwZXJtaXNzaW9uLmFjY2Vzc1N0YXR1cyxcbiAgICAgICAgICAgIG5hbWU6IHRoaXMuY2FuVXBkYXRlVGhlUGVybWlzc2lvbih0aGlzLm5vZGUsIHBlcm1pc3Npb24pID8gcm9sZSA6ICBwZXJtaXNzaW9uLm5hbWUsXG4gICAgICAgICAgICBhdXRob3JpdHlJZDogcGVybWlzc2lvbi5hdXRob3JpdHlJZFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVsb2FkTm9kZShub2RlPzogTm9kZSkge1xuICAgICAgICBpZiAobm9kZSAhPSBudWxsKSB7XG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMubm9kZS5wZXJtaXNzaW9ucywgbm9kZS5wZXJtaXNzaW9ucyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5ub2RlV2l0aFJvbGVzJC5uZXh0KHsgbm9kZTogdGhpcy5ub2RlLCByb2xlczogdGhpcy5yb2xlcyB9KTtcbiAgICB9XG5cbiAgICBnZXRNYW5hZ2VyQXV0aG9yaXR5KG5vZGU6IE5vZGUpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBzaXRlUGF0aCA9IG5vZGUucGF0aC5lbGVtZW50cy5maW5kKChwYXRoKSA9PiBwYXRoLm5vZGVUeXBlID09PSAnc3Q6c2l0ZScpO1xuICAgICAgICBsZXQgaGFzTG9jYWxNYW5hZ2VyUGVybWlzc2lvbiA9IGZhbHNlLCBhdXRob3JpdHlJZDogc3RyaW5nO1xuICAgICAgICBpZiAoc2l0ZVBhdGgpIHtcbiAgICAgICAgICAgIGF1dGhvcml0eUlkID0gYEdST1VQX3NpdGVfJHtzaXRlUGF0aC5uYW1lfV8ke3RoaXMuU0lURV9NQU5BR0VSX1JPTEV9YDtcbiAgICAgICAgICAgIGhhc0xvY2FsTWFuYWdlclBlcm1pc3Npb24gPSAhIW5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldD8uZmluZCgocGVybWlzc2lvbikgPT4gcGVybWlzc2lvbi5hdXRob3JpdHlJZCA9PT0gYXV0aG9yaXR5SWQgJiYgcGVybWlzc2lvbi5uYW1lID09PSB0aGlzLlNJVEVfTUFOQUdFUl9ST0xFKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghaGFzTG9jYWxNYW5hZ2VyUGVybWlzc2lvbiAmJiBhdXRob3JpdHlJZCkge1xuICAgICAgICAgICAgcmV0dXJuIGF1dGhvcml0eUlkO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHVwZGF0ZVJlYWRPbmx5UGVybWlzc2lvbihub2RlOiBOb2RlLCBwZXJtaXNzaW9uczogUGVybWlzc2lvbkRpc3BsYXlNb2RlbFtdKTogUGVybWlzc2lvbkRpc3BsYXlNb2RlbFtdIHtcbiAgICAgICAgcGVybWlzc2lvbnMuZm9yRWFjaCgocGVybWlzc2lvbikgPT4ge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmNhblVwZGF0ZVRoZVBlcm1pc3Npb24obm9kZSwgcGVybWlzc2lvbikpIHtcbiAgICAgICAgICAgICAgICBwZXJtaXNzaW9uLnJlYWRvbmx5ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBwZXJtaXNzaW9ucztcbiAgICB9XG5cbiAgICBjYW5VcGRhdGVUaGVQZXJtaXNzaW9uKG5vZGU6IE5vZGUsIHBlcm1pc3Npb246IFBlcm1pc3Npb25FbGVtZW50KTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IHNpdGVQYXRoID0gbm9kZS5wYXRoLmVsZW1lbnRzLmZpbmQoKHBhdGgpID0+IHBhdGgubm9kZVR5cGUgPT09ICdzdDpzaXRlJyk7XG4gICAgICAgIGlmICghbm9kZS5wZXJtaXNzaW9ucy5pc0luaGVyaXRhbmNlRW5hYmxlZCAmJiBzaXRlUGF0aCkge1xuICAgICAgICAgICBjb25zdCBhdXRob3JpdHlJZCA9IGBHUk9VUF9zaXRlXyR7c2l0ZVBhdGgubmFtZX1fJHt0aGlzLlNJVEVfTUFOQUdFUl9ST0xFfWA7XG4gICAgICAgICAgIHJldHVybiAhKHBlcm1pc3Npb24uYXV0aG9yaXR5SWQgPT09IGF1dGhvcml0eUlkICYmIHBlcm1pc3Npb24ubmFtZSA9PT0gdGhpcy5TSVRFX01BTkFHRVJfUk9MRSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc0dyb3VwKGF1dGhvcml0eUlkKSB7XG4gICAgICAgIHJldHVybiBhdXRob3JpdHlJZC5zdGFydHNXaXRoKCdHUk9VUF8nKSB8fCBhdXRob3JpdHlJZC5zdGFydHNXaXRoKCdST0xFXycpO1xuICAgIH1cbn1cbiJdfQ==