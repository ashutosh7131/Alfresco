import { AlfrescoApiService, NodesApiService, SearchService, TranslationService, EcmUserModel } from '@alfresco/adf-core';
import { Group, GroupsApi } from '@alfresco/js-api';
import { Injectable } from '@angular/core';
import { forkJoin, from, of, throwError } from 'rxjs';
import { catchError, map, switchMap } from 'rxjs/operators';
import { PermissionDisplayModel } from '../models/permission.model';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
export class NodePermissionService {
    constructor(apiService, searchApiService, nodeService, translation) {
        this.apiService = apiService;
        this.searchApiService = searchApiService;
        this.nodeService = nodeService;
        this.translation = translation;
    }
    get groupsApi() {
        var _a;
        this._groupsApi = (_a = this._groupsApi) !== null && _a !== void 0 ? _a : new GroupsApi(this.apiService.getInstance());
        return this._groupsApi;
    }
    getNodeRoles(node) {
        const retrieveSiteQueryBody = this.buildRetrieveSiteQueryBody(node.path.elements);
        return this.searchApiService.searchByQueryBody(retrieveSiteQueryBody)
            .pipe(switchMap((siteNodeList) => {
            var _a;
            if (siteNodeList.list.entries.length > 0) {
                const siteName = siteNodeList.list.entries[0].entry.name;
                return this.getGroupMembersBySiteName(siteName);
            }
            else {
                return of((_a = node.permissions) === null || _a === void 0 ? void 0 : _a.settable);
            }
        }));
    }
    getNodePermissions(node) {
        var _a, _b;
        const result = [];
        if ((_a = node === null || node === void 0 ? void 0 : node.permissions) === null || _a === void 0 ? void 0 : _a.locallySet) {
            node.permissions.locallySet.map((permissionElement) => {
                result.push(new PermissionDisplayModel(permissionElement));
            });
        }
        if ((_b = node === null || node === void 0 ? void 0 : node.permissions) === null || _b === void 0 ? void 0 : _b.inherited) {
            node.permissions.inherited.map((permissionElement) => {
                const permissionInherited = new PermissionDisplayModel(permissionElement);
                permissionInherited.isInherited = true;
                result.push(permissionInherited);
            });
        }
        return result;
    }
    updatePermissionRole(node, updatedPermissionRole) {
        const permissionBody = { permissions: { locallySet: [] } };
        const index = node.permissions.locallySet.map((permission) => permission.authorityId).indexOf(updatedPermissionRole.authorityId);
        permissionBody.permissions.locallySet = permissionBody.permissions.locallySet.concat(node.permissions.locallySet);
        if (index !== -1) {
            permissionBody.permissions.locallySet[index] = updatedPermissionRole;
        }
        else {
            permissionBody.permissions.locallySet.push(updatedPermissionRole);
        }
        return this.nodeService.updateNode(node.id, permissionBody);
    }
    updateNodePermissions(nodeId, permissionList) {
        return this.nodeService.getNode(nodeId).pipe(switchMap((node) => this.updateLocallySetPermissions(node, permissionList)));
    }
    updateLocallySetPermissions(node, permissions) {
        const permissionBody = { permissions: { locallySet: [] } };
        const permissionList = permissions;
        const duplicatedPermissions = this.getDuplicatedPermissions(node.permissions.locallySet, permissionList);
        if (duplicatedPermissions.length > 0) {
            const list = duplicatedPermissions.map((permission) => 'authority -> ' + permission.authorityId + ' / role -> ' + permission.name).join(', ');
            const duplicatePermissionMessage = this.translation.instant('PERMISSION_MANAGER.ERROR.DUPLICATE-PERMISSION', { list });
            return throwError(duplicatePermissionMessage);
        }
        permissionBody.permissions.locallySet = node.permissions.locallySet ? node.permissions.locallySet.concat(permissionList) : permissionList;
        return this.nodeService.updateNode(node.id, permissionBody);
    }
    getDuplicatedPermissions(nodeLocallySet, permissionListAdded) {
        const duplicatePermissions = [];
        if (nodeLocallySet) {
            permissionListAdded.forEach((permission) => {
                const duplicate = nodeLocallySet.find((localPermission) => this.isEqualPermission(localPermission, permission));
                if (duplicate) {
                    duplicatePermissions.push(duplicate);
                }
            });
        }
        return duplicatePermissions;
    }
    isEqualPermission(oldPermission, newPermission) {
        return oldPermission.accessStatus === newPermission.accessStatus &&
            oldPermission.authorityId === newPermission.authorityId &&
            oldPermission.name === newPermission.name;
    }
    removePermission(node, permissionToRemove) {
        const permissionBody = { permissions: { locallySet: [] } };
        const index = node.permissions.locallySet.map((permission) => permission.authorityId).indexOf(permissionToRemove.authorityId);
        if (index !== -1) {
            node.permissions.locallySet.splice(index, 1);
            permissionBody.permissions.locallySet = node.permissions.locallySet;
            return this.nodeService.updateNode(node.id, permissionBody);
        }
        else {
            return of(node);
        }
    }
    getGroupMembersBySiteName(siteName) {
        const groupName = 'GROUP_site_' + siteName;
        return this.getGroupMemberByGroupName(groupName)
            .pipe(map((groupMemberPaging) => {
            const displayResult = [];
            groupMemberPaging.list.entries.forEach((member) => {
                displayResult.push(this.formattedRoleName(member.entry.displayName, 'site_' + siteName));
            });
            return displayResult;
        }));
    }
    getGroupMemberByGroupName(groupName, opts) {
        return from(this.groupsApi.listGroupMemberships(groupName, opts));
    }
    formattedRoleName(displayName, siteName) {
        return displayName.replace(siteName + '_', '');
    }
    buildRetrieveSiteQueryBody(nodePath) {
        const pathNames = nodePath.map((node) => 'name: "' + node.name + '"');
        const builtPathNames = pathNames.join(' OR ');
        return {
            'query': {
                'query': builtPathNames
            },
            'paging': {
                'maxItems': 100,
                'skipCount': 0
            },
            'include': ['aspectNames', 'properties'],
            'filterQueries': [
                {
                    'query': "TYPE:'st:site'"
                }
            ]
        };
    }
    getLocalPermissions(node) {
        var _a;
        const result = [];
        if ((_a = node === null || node === void 0 ? void 0 : node.permissions) === null || _a === void 0 ? void 0 : _a.locallySet) {
            node.permissions.locallySet.forEach((permissionElement) => {
                result.push(new PermissionDisplayModel(permissionElement));
            });
        }
        return result;
    }
    getInheritedPermission(node) {
        var _a;
        const result = [];
        if ((_a = node === null || node === void 0 ? void 0 : node.permissions) === null || _a === void 0 ? void 0 : _a.inherited) {
            node.permissions.inherited.forEach((permissionElement) => {
                const permissionInherited = new PermissionDisplayModel(permissionElement);
                permissionInherited.isInherited = true;
                result.push(permissionInherited);
            });
        }
        return result;
    }
    removePermissions(node, permissions) {
        const permissionBody = { permissions: { locallySet: [] } };
        permissions.forEach((permission) => {
            const index = node.permissions.locallySet.findIndex((locallySet) => locallySet.authorityId === permission.authorityId);
            if (index !== -1) {
                node.permissions.locallySet.splice(index, 1);
            }
        });
        permissionBody.permissions.locallySet = node.permissions.locallySet;
        return this.nodeService.updateNode(node.id, permissionBody);
    }
    updatePermissions(node, permissions) {
        const permissionBody = { permissions: { locallySet: [] } };
        permissionBody.permissions.locallySet = permissions;
        return this.nodeService.updateNode(node.id, permissionBody);
    }
    getNodeWithRoles(nodeId) {
        return this.nodeService.getNode(nodeId).pipe(switchMap(node => {
            return forkJoin({
                node: of(node),
                roles: this.getNodeRoles(node)
                    .pipe(catchError(() => { var _a; return of((_a = node.permissions) === null || _a === void 0 ? void 0 : _a.settable); }), map(_roles => _roles.map(role => ({ role, label: role }))))
            });
        }));
    }
    transformNodeToUserPerson(node) {
        let person = null, group = null;
        if (node.nodeType === 'cm:person') {
            const firstName = node.properties['cm:firstName'];
            const lastName = node.properties['cm:lastName'];
            const email = node.properties['cm:email'];
            const id = node.properties['cm:userName'];
            person = new EcmUserModel({ id, firstName, lastName, email });
        }
        if (node.nodeType === 'cm:authorityContainer') {
            const displayName = node.properties['cm:authorityDisplayName'] || node.properties['cm:authorityName'];
            const id = node.properties['cm:authorityName'];
            group = new Group({ displayName, id });
        }
        return { person, group };
    }
}
NodePermissionService.ɵprov = i0.ɵɵdefineInjectable({ factory: function NodePermissionService_Factory() { return new NodePermissionService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i1.SearchService), i0.ɵɵinject(i1.NodesApiService), i0.ɵɵinject(i1.TranslationService)); }, token: NodePermissionService, providedIn: "root" });
NodePermissionService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
NodePermissionService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: SearchService },
    { type: NodesApiService },
    { type: TranslationService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS1wZXJtaXNzaW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb250ZW50LXNlcnZpY2VzL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9wZXJtaXNzaW9uLW1hbmFnZXIvc2VydmljZXMvbm9kZS1wZXJtaXNzaW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBaUJBLE9BQU8sRUFDSCxrQkFBa0IsRUFDbEIsZUFBZSxFQUNmLGFBQWEsRUFDYixrQkFBa0IsRUFDbEIsWUFBWSxFQUNmLE1BQU0sb0JBQW9CLENBQUM7QUFDNUIsT0FBTyxFQUNILEtBQUssRUFFYyxTQUFTLEVBSy9CLE1BQU0sa0JBQWtCLENBQUM7QUFDMUIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBYyxFQUFFLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2xFLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVELE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDOzs7QUFNcEUsTUFBTSxPQUFPLHFCQUFxQjtJQVE5QixZQUFvQixVQUE4QixFQUM5QixnQkFBK0IsRUFDL0IsV0FBNEIsRUFDNUIsV0FBK0I7UUFIL0IsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7UUFDOUIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFlO1FBQy9CLGdCQUFXLEdBQVgsV0FBVyxDQUFpQjtRQUM1QixnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7SUFDbkQsQ0FBQztJQVRELElBQUksU0FBUzs7UUFDVCxJQUFJLENBQUMsVUFBVSxTQUFHLElBQUksQ0FBQyxVQUFVLG1DQUFJLElBQUksU0FBUyxDQUFDLElBQUksQ0FBQyxVQUFVLENB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YyxDQUFDLENBQUM7WUFDbEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUNoRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDMUMsTUFBTSxHQUFHLElBQUksWUFBWSxDQUFDLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztTQUNqRTtRQUVELElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyx1QkFBdUIsRUFBRTtZQUMzQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLHlCQUF5QixDQUFDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQ3RHLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUMvQyxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztTQUMxQztRQUNELE9BQU8sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUM7SUFDN0IsQ0FBQzs7OztZQTlSSixVQUFVLFNBQUM7Z0JBQ1IsVUFBVSxFQUFFLE1BQU07YUFDckI7OztZQXZCRyxrQkFBa0I7WUFFbEIsYUFBYTtZQURiLGVBQWU7WUFFZixrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1xuICAgIEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICBOb2Rlc0FwaVNlcnZpY2UsXG4gICAgU2VhcmNoU2VydmljZSxcbiAgICBUcmFuc2xhdGlvblNlcnZpY2UsXG4gICAgRWNtVXNlck1vZGVsXG59IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQge1xuICAgIEdyb3VwLFxuICAgIEdyb3VwTWVtYmVyRW50cnksXG4gICAgR3JvdXBNZW1iZXJQYWdpbmcsIEdyb3Vwc0FwaSxcbiAgICBOb2RlLFxuICAgIFBhdGhFbGVtZW50LFxuICAgIFBlcm1pc3Npb25FbGVtZW50LFxuICAgIFF1ZXJ5Qm9keVxufSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZvcmtKb2luLCBmcm9tLCBPYnNlcnZhYmxlLCBvZiwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQZXJtaXNzaW9uRGlzcGxheU1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL3Blcm1pc3Npb24ubW9kZWwnO1xuaW1wb3J0IHsgUm9sZU1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL3JvbGUubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIE5vZGVQZXJtaXNzaW9uU2VydmljZSB7XG5cbiAgICBfZ3JvdXBzQXBpOiBHcm91cHNBcGk7XG4gICAgZ2V0IGdyb3Vwc0FwaSgpOiBHcm91cHNBcGkge1xuICAgICAgICB0aGlzLl9ncm91cHNBcGkgPSB0aGlzLl9ncm91cHNBcGkgPz8gbmV3IEdyb3Vwc0FwaSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl9ncm91cHNBcGk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBzZWFyY2hBcGlTZXJ2aWNlOiBTZWFyY2hTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgbm9kZVNlcnZpY2U6IE5vZGVzQXBpU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRyYW5zbGF0aW9uOiBUcmFuc2xhdGlvblNlcnZpY2UpIHtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGEgbGlzdCBvZiByb2xlcyBmb3IgdGhlIGN1cnJlbnQgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZSBUaGUgdGFyZ2V0IG5vZGVcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBzdHJpbmdzIHJlcHJlc2VudGluZyB0aGUgcm9sZXNcbiAgICAgKi9cbiAgICBnZXROb2RlUm9sZXMobm9kZTogTm9kZSk6IE9ic2VydmFibGU8c3RyaW5nW10+IHtcbiAgICAgICAgY29uc3QgcmV0cmlldmVTaXRlUXVlcnlCb2R5OiBRdWVyeUJvZHkgPSB0aGlzLmJ1aWxkUmV0cmlldmVTaXRlUXVlcnlCb2R5KG5vZGUucGF0aC5lbGVtZW50cyk7XG4gICAgICAgIHJldHVybiB0aGlzLnNlYXJjaEFwaVNlcnZpY2Uuc2VhcmNoQnlRdWVyeUJvZHkocmV0cmlldmVTaXRlUXVlcnlCb2R5KVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKChzaXRlTm9kZUxpc3Q6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2l0ZU5vZGVMaXN0Lmxpc3QuZW50cmllcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzaXRlTmFtZSA9IHNpdGVOb2RlTGlzdC5saXN0LmVudHJpZXNbMF0uZW50cnkubmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEdyb3VwTWVtYmVyc0J5U2l0ZU5hbWUoc2l0ZU5hbWUpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKG5vZGUucGVybWlzc2lvbnM/LnNldHRhYmxlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIGdldE5vZGVQZXJtaXNzaW9ucyhub2RlOiBOb2RlKTogUGVybWlzc2lvbkRpc3BsYXlNb2RlbFtdIHtcbiAgICAgICAgY29uc3QgcmVzdWx0OiBQZXJtaXNzaW9uRGlzcGxheU1vZGVsW10gPSBbXTtcblxuICAgICAgICBpZiAobm9kZT8ucGVybWlzc2lvbnM/LmxvY2FsbHlTZXQpIHtcbiAgICAgICAgICAgIG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldC5tYXAoKHBlcm1pc3Npb25FbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobmV3IFBlcm1pc3Npb25EaXNwbGF5TW9kZWwocGVybWlzc2lvbkVsZW1lbnQpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG5vZGU/LnBlcm1pc3Npb25zPy5pbmhlcml0ZWQpIHtcbiAgICAgICAgICAgIG5vZGUucGVybWlzc2lvbnMuaW5oZXJpdGVkLm1hcCgocGVybWlzc2lvbkVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBwZXJtaXNzaW9uSW5oZXJpdGVkID0gbmV3IFBlcm1pc3Npb25EaXNwbGF5TW9kZWwocGVybWlzc2lvbkVsZW1lbnQpO1xuICAgICAgICAgICAgICAgIHBlcm1pc3Npb25Jbmhlcml0ZWQuaXNJbmhlcml0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHBlcm1pc3Npb25Jbmhlcml0ZWQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBwZXJtaXNzaW9uIHJvbGUgZm9yIGEgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZSBUYXJnZXQgbm9kZVxuICAgICAqIEBwYXJhbSB1cGRhdGVkUGVybWlzc2lvblJvbGUgUGVybWlzc2lvbiByb2xlIHRvIHVwZGF0ZSBvciBhZGRcbiAgICAgKiBAcmV0dXJucyBOb2RlIHdpdGggdXBkYXRlZCBwZXJtaXNzaW9uXG4gICAgICovXG4gICAgdXBkYXRlUGVybWlzc2lvblJvbGUobm9kZTogTm9kZSwgdXBkYXRlZFBlcm1pc3Npb25Sb2xlOiBQZXJtaXNzaW9uRWxlbWVudCk6IE9ic2VydmFibGU8Tm9kZT4ge1xuICAgICAgICBjb25zdCBwZXJtaXNzaW9uQm9keSA9IHsgcGVybWlzc2lvbnM6IHsgbG9jYWxseVNldDogW10gfSB9O1xuICAgICAgICBjb25zdCBpbmRleCA9IG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldC5tYXAoKHBlcm1pc3Npb24pID0+IHBlcm1pc3Npb24uYXV0aG9yaXR5SWQpLmluZGV4T2YodXBkYXRlZFBlcm1pc3Npb25Sb2xlLmF1dGhvcml0eUlkKTtcbiAgICAgICAgcGVybWlzc2lvbkJvZHkucGVybWlzc2lvbnMubG9jYWxseVNldCA9IHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXQuY29uY2F0KG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldCk7XG4gICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgIHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXRbaW5kZXhdID0gdXBkYXRlZFBlcm1pc3Npb25Sb2xlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcGVybWlzc2lvbkJvZHkucGVybWlzc2lvbnMubG9jYWxseVNldC5wdXNoKHVwZGF0ZWRQZXJtaXNzaW9uUm9sZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMubm9kZVNlcnZpY2UudXBkYXRlTm9kZShub2RlLmlkLCBwZXJtaXNzaW9uQm9keSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIHBlcm1pc3Npb25zIGZvciBhIG5vZGUuXG4gICAgICogQHBhcmFtIG5vZGVJZCBJRCBvZiB0aGUgdGFyZ2V0IG5vZGVcbiAgICAgKiBAcGFyYW0gcGVybWlzc2lvbkxpc3QgTmV3IHBlcm1pc3Npb24gc2V0dGluZ3NcbiAgICAgKiBAcmV0dXJucyBOb2RlIHdpdGggdXBkYXRlZCBwZXJtaXNzaW9uc1xuICAgICAqL1xuICAgIHVwZGF0ZU5vZGVQZXJtaXNzaW9ucyhub2RlSWQ6IHN0cmluZywgcGVybWlzc2lvbkxpc3Q6IFBlcm1pc3Npb25FbGVtZW50W10pOiBPYnNlcnZhYmxlPE5vZGU+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMubm9kZVNlcnZpY2UuZ2V0Tm9kZShub2RlSWQpLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKG5vZGUpID0+IHRoaXMudXBkYXRlTG9jYWxseVNldFBlcm1pc3Npb25zKG5vZGUsIHBlcm1pc3Npb25MaXN0KSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBsb2NhbGx5IHNldCBwZXJtaXNzaW9ucyBmb3IgYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlIElEIG9mIHRoZSB0YXJnZXQgbm9kZVxuICAgICAqIEBwYXJhbSBwZXJtaXNzaW9ucyBQZXJtaXNzaW9uIHNldHRpbmdzXG4gICAgICogQHJldHVybnMgTm9kZSB3aXRoIHVwZGF0ZWQgcGVybWlzc2lvbnNcbiAgICAgKi9cbiAgICB1cGRhdGVMb2NhbGx5U2V0UGVybWlzc2lvbnMobm9kZTogTm9kZSwgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25FbGVtZW50W10pOiBPYnNlcnZhYmxlPE5vZGU+IHtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbkJvZHkgPSB7IHBlcm1pc3Npb25zOiB7IGxvY2FsbHlTZXQ6IFtdIH0gfTtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbkxpc3QgPSBwZXJtaXNzaW9ucztcbiAgICAgICAgY29uc3QgZHVwbGljYXRlZFBlcm1pc3Npb25zID0gdGhpcy5nZXREdXBsaWNhdGVkUGVybWlzc2lvbnMobm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0LCBwZXJtaXNzaW9uTGlzdCk7XG4gICAgICAgIGlmIChkdXBsaWNhdGVkUGVybWlzc2lvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3QgbGlzdCA9IGR1cGxpY2F0ZWRQZXJtaXNzaW9ucy5tYXAoKHBlcm1pc3Npb24pID0+ICdhdXRob3JpdHkgLT4gJyArIHBlcm1pc3Npb24uYXV0aG9yaXR5SWQgKyAnIC8gcm9sZSAtPiAnICsgcGVybWlzc2lvbi5uYW1lKS5qb2luKCcsICcpO1xuICAgICAgICAgICAgY29uc3QgZHVwbGljYXRlUGVybWlzc2lvbk1lc3NhZ2U6IHN0cmluZyA9IHRoaXMudHJhbnNsYXRpb24uaW5zdGFudCgnUEVSTUlTU0lPTl9NQU5BR0VSLkVSUk9SLkRVUExJQ0FURS1QRVJNSVNTSU9OJywgeyBsaXN0IH0pO1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZHVwbGljYXRlUGVybWlzc2lvbk1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICAgIHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXQgPSBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQgPyBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQuY29uY2F0KHBlcm1pc3Npb25MaXN0KSA6IHBlcm1pc3Npb25MaXN0O1xuICAgICAgICByZXR1cm4gdGhpcy5ub2RlU2VydmljZS51cGRhdGVOb2RlKG5vZGUuaWQsIHBlcm1pc3Npb25Cb2R5KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldER1cGxpY2F0ZWRQZXJtaXNzaW9ucyhub2RlTG9jYWxseVNldDogUGVybWlzc2lvbkVsZW1lbnRbXSwgcGVybWlzc2lvbkxpc3RBZGRlZDogUGVybWlzc2lvbkVsZW1lbnRbXSk6IFBlcm1pc3Npb25FbGVtZW50W10ge1xuICAgICAgICBjb25zdCBkdXBsaWNhdGVQZXJtaXNzaW9uczogUGVybWlzc2lvbkVsZW1lbnRbXSA9IFtdO1xuICAgICAgICBpZiAobm9kZUxvY2FsbHlTZXQpIHtcbiAgICAgICAgICAgIHBlcm1pc3Npb25MaXN0QWRkZWQuZm9yRWFjaCgocGVybWlzc2lvbjogUGVybWlzc2lvbkVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBkdXBsaWNhdGUgPSBub2RlTG9jYWxseVNldC5maW5kKChsb2NhbFBlcm1pc3Npb24pID0+IHRoaXMuaXNFcXVhbFBlcm1pc3Npb24obG9jYWxQZXJtaXNzaW9uLCBwZXJtaXNzaW9uKSk7XG4gICAgICAgICAgICAgICAgaWYgKGR1cGxpY2F0ZSkge1xuICAgICAgICAgICAgICAgICAgICBkdXBsaWNhdGVQZXJtaXNzaW9ucy5wdXNoKGR1cGxpY2F0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGR1cGxpY2F0ZVBlcm1pc3Npb25zO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNFcXVhbFBlcm1pc3Npb24ob2xkUGVybWlzc2lvbjogUGVybWlzc2lvbkVsZW1lbnQsIG5ld1Blcm1pc3Npb246IFBlcm1pc3Npb25FbGVtZW50KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBvbGRQZXJtaXNzaW9uLmFjY2Vzc1N0YXR1cyA9PT0gbmV3UGVybWlzc2lvbi5hY2Nlc3NTdGF0dXMgJiZcbiAgICAgICAgICAgIG9sZFBlcm1pc3Npb24uYXV0aG9yaXR5SWQgPT09IG5ld1Blcm1pc3Npb24uYXV0aG9yaXR5SWQgJiZcbiAgICAgICAgICAgIG9sZFBlcm1pc3Npb24ubmFtZSA9PT0gbmV3UGVybWlzc2lvbi5uYW1lO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZXMgYSBwZXJtaXNzaW9uIHNldHRpbmcgZnJvbSBhIG5vZGUuXG4gICAgICogQHBhcmFtIG5vZGUgSUQgb2YgdGhlIHRhcmdldCBub2RlXG4gICAgICogQHBhcmFtIHBlcm1pc3Npb25Ub1JlbW92ZSBQZXJtaXNzaW9uIHNldHRpbmcgdG8gcmVtb3ZlXG4gICAgICogQHJldHVybnMgTm9kZSB3aXRoIG1vZGlmaWVkIHBlcm1pc3Npb25zXG4gICAgICovXG4gICAgcmVtb3ZlUGVybWlzc2lvbihub2RlOiBOb2RlLCBwZXJtaXNzaW9uVG9SZW1vdmU6IFBlcm1pc3Npb25FbGVtZW50KTogT2JzZXJ2YWJsZTxOb2RlPiB7XG4gICAgICAgIGNvbnN0IHBlcm1pc3Npb25Cb2R5ID0geyBwZXJtaXNzaW9uczogeyBsb2NhbGx5U2V0OiBbXSB9IH07XG4gICAgICAgIGNvbnN0IGluZGV4ID0gbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0Lm1hcCgocGVybWlzc2lvbikgPT4gcGVybWlzc2lvbi5hdXRob3JpdHlJZCkuaW5kZXhPZihwZXJtaXNzaW9uVG9SZW1vdmUuYXV0aG9yaXR5SWQpO1xuXG4gICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgIG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldC5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgcGVybWlzc2lvbkJvZHkucGVybWlzc2lvbnMubG9jYWxseVNldCA9IG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldDtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm5vZGVTZXJ2aWNlLnVwZGF0ZU5vZGUobm9kZS5pZCwgcGVybWlzc2lvbkJvZHkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG9mKG5vZGUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRHcm91cE1lbWJlcnNCeVNpdGVOYW1lKHNpdGVOYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZ1tdPiB7XG4gICAgICAgIGNvbnN0IGdyb3VwTmFtZSA9ICdHUk9VUF9zaXRlXycgKyBzaXRlTmFtZTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0R3JvdXBNZW1iZXJCeUdyb3VwTmFtZShncm91cE5hbWUpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKGdyb3VwTWVtYmVyUGFnaW5nOiBHcm91cE1lbWJlclBhZ2luZykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXNwbGF5UmVzdWx0OiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBncm91cE1lbWJlclBhZ2luZy5saXN0LmVudHJpZXMuZm9yRWFjaCgobWVtYmVyOiBHcm91cE1lbWJlckVudHJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5UmVzdWx0LnB1c2godGhpcy5mb3JtYXR0ZWRSb2xlTmFtZShtZW1iZXIuZW50cnkuZGlzcGxheU5hbWUsICdzaXRlXycgKyBzaXRlTmFtZSkpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlSZXN1bHQ7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgbWVtYmVycyByZWxhdGVkIHRvIGEgZ3JvdXAgbmFtZS5cbiAgICAgKiBAcGFyYW0gZ3JvdXBOYW1lIE5hbWUgb2YgZ3JvdXAgdG8gbG9vayBmb3IgbWVtYmVyc1xuICAgICAqIEBwYXJhbSBvcHRzIEV4dHJhIG9wdGlvbnMgc3VwcG9ydGVkIGJ5IEpTLUFQSVxuICAgICAqIEByZXR1cm5zIExpc3Qgb2YgbWVtYmVyc1xuICAgICAqL1xuICAgIGdldEdyb3VwTWVtYmVyQnlHcm91cE5hbWUoZ3JvdXBOYW1lOiBzdHJpbmcsIG9wdHM/OiBhbnkpOiBPYnNlcnZhYmxlPEdyb3VwTWVtYmVyUGFnaW5nPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuZ3JvdXBzQXBpLmxpc3RHcm91cE1lbWJlcnNoaXBzKGdyb3VwTmFtZSwgb3B0cykpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZm9ybWF0dGVkUm9sZU5hbWUoZGlzcGxheU5hbWUsIHNpdGVOYW1lKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lLnJlcGxhY2Uoc2l0ZU5hbWUgKyAnXycsICcnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGJ1aWxkUmV0cmlldmVTaXRlUXVlcnlCb2R5KG5vZGVQYXRoOiBQYXRoRWxlbWVudFtdKTogUXVlcnlCb2R5IHtcbiAgICAgICAgY29uc3QgcGF0aE5hbWVzID0gbm9kZVBhdGgubWFwKChub2RlOiBQYXRoRWxlbWVudCkgPT4gJ25hbWU6IFwiJyArIG5vZGUubmFtZSArICdcIicpO1xuICAgICAgICBjb25zdCBidWlsdFBhdGhOYW1lcyA9IHBhdGhOYW1lcy5qb2luKCcgT1IgJyk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdxdWVyeSc6IHtcbiAgICAgICAgICAgICAgICAncXVlcnknOiBidWlsdFBhdGhOYW1lc1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdwYWdpbmcnOiB7XG4gICAgICAgICAgICAgICAgJ21heEl0ZW1zJzogMTAwLFxuICAgICAgICAgICAgICAgICdza2lwQ291bnQnOiAwXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ2luY2x1ZGUnOiBbJ2FzcGVjdE5hbWVzJywgJ3Byb3BlcnRpZXMnXSxcbiAgICAgICAgICAgICdmaWx0ZXJRdWVyaWVzJzogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgJ3F1ZXJ5JzpcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiVFlQRTonc3Q6c2l0ZSdcIlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBnZXRMb2NhbFBlcm1pc3Npb25zKG5vZGU6IE5vZGUpOiBQZXJtaXNzaW9uRGlzcGxheU1vZGVsW10ge1xuICAgICAgICBjb25zdCByZXN1bHQ6IFBlcm1pc3Npb25EaXNwbGF5TW9kZWxbXSA9IFtdO1xuXG4gICAgICAgIGlmIChub2RlPy5wZXJtaXNzaW9ucz8ubG9jYWxseVNldCkge1xuICAgICAgICAgICAgbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0LmZvckVhY2goKHBlcm1pc3Npb25FbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobmV3IFBlcm1pc3Npb25EaXNwbGF5TW9kZWwocGVybWlzc2lvbkVsZW1lbnQpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBnZXRJbmhlcml0ZWRQZXJtaXNzaW9uKG5vZGU6IE5vZGUpOiBQZXJtaXNzaW9uRGlzcGxheU1vZGVsW10ge1xuICAgICAgICBjb25zdCByZXN1bHQ6IFBlcm1pc3Npb25EaXNwbGF5TW9kZWxbXSA9IFtdO1xuXG4gICAgICAgIGlmIChub2RlPy5wZXJtaXNzaW9ucz8uaW5oZXJpdGVkKSB7XG4gICAgICAgICAgICBub2RlLnBlcm1pc3Npb25zLmluaGVyaXRlZC5mb3JFYWNoKChwZXJtaXNzaW9uRWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBlcm1pc3Npb25Jbmhlcml0ZWQgPSBuZXcgUGVybWlzc2lvbkRpc3BsYXlNb2RlbChwZXJtaXNzaW9uRWxlbWVudCk7XG4gICAgICAgICAgICAgICAgcGVybWlzc2lvbkluaGVyaXRlZC5pc0luaGVyaXRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gocGVybWlzc2lvbkluaGVyaXRlZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZXMgcGVybWlzc2lvbnMgc2V0dGluZyBmcm9tIGEgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZSB0YXJnZXQgbm9kZSB3aXRoIHBlcm1pc3Npb25cbiAgICAgKiBAcGFyYW0gcGVybWlzc2lvbnMgUGVybWlzc2lvbnMgdG8gcmVtb3ZlXG4gICAgICogQHJldHVybnMgTm9kZSB3aXRoIG1vZGlmaWVkIHBlcm1pc3Npb25zXG4gICAgICovXG4gICAgcmVtb3ZlUGVybWlzc2lvbnMobm9kZTogTm9kZSwgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25FbGVtZW50W10pOiBPYnNlcnZhYmxlPE5vZGU+IHtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbkJvZHkgPSB7IHBlcm1pc3Npb25zOiB7IGxvY2FsbHlTZXQ6IFtdIH0gfTtcblxuICAgICAgICBwZXJtaXNzaW9ucy5mb3JFYWNoKChwZXJtaXNzaW9uKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldC5maW5kSW5kZXgoKGxvY2FsbHlTZXQpID0+IGxvY2FsbHlTZXQuYXV0aG9yaXR5SWQgPT09IHBlcm1pc3Npb24uYXV0aG9yaXR5SWQpO1xuICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgIG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldC5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcGVybWlzc2lvbkJvZHkucGVybWlzc2lvbnMubG9jYWxseVNldCA9IG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldDtcbiAgICAgICAgcmV0dXJuIHRoaXMubm9kZVNlcnZpY2UudXBkYXRlTm9kZShub2RlLmlkLCBwZXJtaXNzaW9uQm9keSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogdXBkYXRlcyBwZXJtaXNzaW9ucyBzZXR0aW5nIGZyb20gYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlIHRhcmdldCBub2RlIHdpdGggcGVybWlzc2lvblxuICAgICAqIEBwYXJhbSBwZXJtaXNzaW9ucyBQZXJtaXNzaW9ucyB0byB1cGRhdGVcbiAgICAgKiBAcmV0dXJucyBOb2RlIHdpdGggbW9kaWZpZWQgcGVybWlzc2lvbnNcbiAgICAgKi9cbiAgICB1cGRhdGVQZXJtaXNzaW9ucyhub2RlOiBOb2RlLCBwZXJtaXNzaW9uczogUGVybWlzc2lvbkVsZW1lbnRbXSk6IE9ic2VydmFibGU8Tm9kZT4ge1xuICAgICAgICBjb25zdCBwZXJtaXNzaW9uQm9keSA9IHsgcGVybWlzc2lvbnM6IHsgbG9jYWxseVNldDogW10gfSB9O1xuICAgICAgICBwZXJtaXNzaW9uQm9keS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0ID0gcGVybWlzc2lvbnM7XG4gICAgICAgIHJldHVybiB0aGlzLm5vZGVTZXJ2aWNlLnVwZGF0ZU5vZGUobm9kZS5pZCwgcGVybWlzc2lvbkJvZHkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYWxsIG5vZGUgZGV0YWlsIGZvciBub2RlSWQgYWxvbmcgd2l0aCBzZXR0YWJsZSBwZXJtaXNzaW9ucy5cbiAgICAgKiBAcGFyYW0gbm9kZUlkIElkIG9mIHRoZSBub2RlXG4gICAgICogQHJldHVybnMgbm9kZSBhbmQgaXQncyBhc3NvY2lhdGVkIHJvbGVzIHsgbm9kZTogTm9kZTsgcm9sZXM6IFJvbGVNb2RlbFtdIH1cbiAgICAgKi9cbiAgICBnZXROb2RlV2l0aFJvbGVzKG5vZGVJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTx7IG5vZGU6IE5vZGU7IHJvbGVzOiBSb2xlTW9kZWxbXSB9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLm5vZGVTZXJ2aWNlLmdldE5vZGUobm9kZUlkKS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKG5vZGUgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBmb3JrSm9pbih7XG4gICAgICAgICAgICAgICAgICAgIG5vZGU6IG9mKG5vZGUpLFxuICAgICAgICAgICAgICAgICAgICByb2xlczogdGhpcy5nZXROb2RlUm9sZXMobm9kZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKCkgPT4gb2Yobm9kZS5wZXJtaXNzaW9ucz8uc2V0dGFibGUpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXAoX3JvbGVzID0+IF9yb2xlcy5tYXAocm9sZSA9PiAoeyByb2xlLCBsYWJlbDogcm9sZSB9KSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHRyYW5zZm9ybU5vZGVUb1VzZXJQZXJzb24obm9kZTogTm9kZSk6IHsgcGVyc29uOiBFY21Vc2VyTW9kZWwsIGdyb3VwOiBHcm91cCB9IHtcbiAgICAgICAgbGV0IHBlcnNvbiA9IG51bGwsIGdyb3VwID0gbnVsbDtcbiAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09ICdjbTpwZXJzb24nKSB7XG4gICAgICAgICAgICBjb25zdCBmaXJzdE5hbWUgPSBub2RlLnByb3BlcnRpZXNbJ2NtOmZpcnN0TmFtZSddO1xuICAgICAgICAgICAgY29uc3QgbGFzdE5hbWUgPSBub2RlLnByb3BlcnRpZXNbJ2NtOmxhc3ROYW1lJ107XG4gICAgICAgICAgICBjb25zdCBlbWFpbCA9IG5vZGUucHJvcGVydGllc1snY206ZW1haWwnXTtcbiAgICAgICAgICAgIGNvbnN0IGlkID0gbm9kZS5wcm9wZXJ0aWVzWydjbTp1c2VyTmFtZSddO1xuICAgICAgICAgICAgcGVyc29uID0gbmV3IEVjbVVzZXJNb2RlbCh7IGlkLCBmaXJzdE5hbWUsIGxhc3ROYW1lLCBlbWFpbCB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAnY206YXV0aG9yaXR5Q29udGFpbmVyJykge1xuICAgICAgICAgICAgY29uc3QgZGlzcGxheU5hbWUgPSBub2RlLnByb3BlcnRpZXNbJ2NtOmF1dGhvcml0eURpc3BsYXlOYW1lJ10gfHwgbm9kZS5wcm9wZXJ0aWVzWydjbTphdXRob3JpdHlOYW1lJ107XG4gICAgICAgICAgICBjb25zdCBpZCA9IG5vZGUucHJvcGVydGllc1snY206YXV0aG9yaXR5TmFtZSddO1xuICAgICAgICAgICAgZ3JvdXAgPSBuZXcgR3JvdXAoeyBkaXNwbGF5TmFtZSwgaWQgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHsgcGVyc29uLCBncm91cCB9O1xuICAgIH1cbn1cbiJdfQ==