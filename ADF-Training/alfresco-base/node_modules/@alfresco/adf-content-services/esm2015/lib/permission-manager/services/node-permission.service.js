import { AlfrescoApiService, NodesApiService, SearchService, TranslationService, EcmUserModel } from '@alfresco/adf-core';
import { Group, GroupsApi } from '@alfresco/js-api';
import { Injectable } from '@angular/core';
import { forkJoin, from, of, throwError } from 'rxjs';
import { catchError, map, switchMap } from 'rxjs/operators';
import { PermissionDisplayModel } from '../models/permission.model';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
export class NodePermissionService {
    constructor(apiService, searchApiService, nodeService, translation) {
        this.apiService = apiService;
        this.searchApiService = searchApiService;
        this.nodeService = nodeService;
        this.translation = translation;
    }
    get groupsApi() {
        var _a;
        this._groupsApi = (_a = this._groupsApi) !== null && _a !== void 0 ? _a : new GroupsApi(this.apiService.getInstance());
        return this._groupsApi;
    }
    getNodeRoles(node) {
        const retrieveSiteQueryBody = this.buildRetrieveSiteQueryBody(node.path.elements);
        return this.searchApiService.searchByQueryBody(retrieveSiteQueryBody)
            .pipe(switchMap((siteNodeList) => {
            var _a;
            if (siteNodeList.list.entries.length > 0) {
                const siteName = siteNodeList.list.entries[0].entry.name;
                return this.getGroupMembersBySiteName(siteName);
            }
            else {
                return of((_a = node.permissions) === null || _a === void 0 ? void 0 : _a.settable);
            }
        }));
    }
    getNodePermissions(node) {
        var _a, _b;
        const result = [];
        if ((_a = node === null || node === void 0 ? void 0 : node.permissions) === null || _a === void 0 ? void 0 : _a.locallySet) {
            node.permissions.locallySet.map((permissionElement) => {
                result.push(new PermissionDisplayModel(permissionElement));
            });
        }
        if ((_b = node === null || node === void 0 ? void 0 : node.permissions) === null || _b === void 0 ? void 0 : _b.inherited) {
            node.permissions.inherited.map((permissionElement) => {
                const permissionInherited = new PermissionDisplayModel(permissionElement);
                permissionInherited.isInherited = true;
                result.push(permissionInherited);
            });
        }
        return result;
    }
    updatePermissionRole(node, updatedPermissionRole) {
        const permissionBody = { permissions: { locallySet: [] } };
        const index = node.permissions.locallySet.map((permission) => permission.authorityId).indexOf(updatedPermissionRole.authorityId);
        permissionBody.permissions.locallySet = permissionBody.permissions.locallySet.concat(node.permissions.locallySet);
        if (index !== -1) {
            permissionBody.permissions.locallySet[index] = updatedPermissionRole;
        }
        else {
            permissionBody.permissions.locallySet.push(updatedPermissionRole);
        }
        return this.nodeService.updateNode(node.id, permissionBody);
    }
    updateNodePermissions(nodeId, permissionList) {
        return this.nodeService.getNode(nodeId).pipe(switchMap((node) => this.updateLocallySetPermissions(node, permissionList)));
    }
    updateLocallySetPermissions(node, permissions) {
        const permissionBody = { permissions: { locallySet: [] } };
        const permissionList = permissions;
        const duplicatedPermissions = this.getDuplicatedPermissions(node.permissions.locallySet, permissionList);
        if (duplicatedPermissions.length > 0) {
            const list = duplicatedPermissions.map((permission) => 'authority -> ' + permission.authorityId + ' / role -> ' + permission.name).join(', ');
            const duplicatePermissionMessage = this.translation.instant('PERMISSION_MANAGER.ERROR.DUPLICATE-PERMISSION', { list });
            return throwError(duplicatePermissionMessage);
        }
        permissionBody.permissions.locallySet = node.permissions.locallySet ? node.permissions.locallySet.concat(permissionList) : permissionList;
        return this.nodeService.updateNode(node.id, permissionBody);
    }
    getDuplicatedPermissions(nodeLocallySet, permissionListAdded) {
        const duplicatePermissions = [];
        if (nodeLocallySet) {
            permissionListAdded.forEach((permission) => {
                const duplicate = nodeLocallySet.find((localPermission) => this.isEqualPermission(localPermission, permission));
                if (duplicate) {
                    duplicatePermissions.push(duplicate);
                }
            });
        }
        return duplicatePermissions;
    }
    isEqualPermission(oldPermission, newPermission) {
        return oldPermission.accessStatus === newPermission.accessStatus &&
            oldPermission.authorityId === newPermission.authorityId &&
            oldPermission.name === newPermission.name;
    }
    removePermission(node, permissionToRemove) {
        const permissionBody = { permissions: { locallySet: [] } };
        const index = node.permissions.locallySet.map((permission) => permission.authorityId).indexOf(permissionToRemove.authorityId);
        if (index !== -1) {
            node.permissions.locallySet.splice(index, 1);
            permissionBody.permissions.locallySet = node.permissions.locallySet;
            return this.nodeService.updateNode(node.id, permissionBody);
        }
        else {
            return of(node);
        }
    }
    getGroupMembersBySiteName(siteName) {
        const groupName = 'GROUP_site_' + siteName;
        return this.getGroupMemberByGroupName(groupName)
            .pipe(map((groupMemberPaging) => {
            const displayResult = [];
            groupMemberPaging.list.entries.forEach((member) => {
                displayResult.push(this.formattedRoleName(member.entry.displayName, 'site_' + siteName));
            });
            return displayResult;
        }));
    }
    getGroupMemberByGroupName(groupName, opts) {
        return from(this.groupsApi.listGroupMemberships(groupName, opts));
    }
    formattedRoleName(displayName, siteName) {
        return displayName.replace(siteName + '_', '');
    }
    buildRetrieveSiteQueryBody(nodePath) {
        const pathNames = nodePath.map((node) => 'name: "' + node.name + '"');
        const builtPathNames = pathNames.join(' OR ');
        return {
            'query': {
                'query': builtPathNames
            },
            'paging': {
                'maxItems': 100,
                'skipCount': 0
            },
            'include': ['aspectNames', 'properties'],
            'filterQueries': [
                {
                    'query': "TYPE:'st:site'"
                }
            ]
        };
    }
    getLocalPermissions(node) {
        var _a;
        const result = [];
        if ((_a = node === null || node === void 0 ? void 0 : node.permissions) === null || _a === void 0 ? void 0 : _a.locallySet) {
            node.permissions.locallySet.forEach((permissionElement) => {
                result.push(new PermissionDisplayModel(permissionElement));
            });
        }
        return result;
    }
    getInheritedPermission(node) {
        var _a;
        const result = [];
        if ((_a = node === null || node === void 0 ? void 0 : node.permissions) === null || _a === void 0 ? void 0 : _a.inherited) {
            node.permissions.inherited.forEach((permissionElement) => {
                const permissionInherited = new PermissionDisplayModel(permissionElement);
                permissionInherited.isInherited = true;
                result.push(permissionInherited);
            });
        }
        return result;
    }
    removePermissions(node, permissions) {
        const permissionBody = { permissions: { locallySet: [] } };
        permissions.forEach((permission) => {
            const index = node.permissions.locallySet.findIndex((locallySet) => locallySet.authorityId === permission.authorityId);
            if (index !== -1) {
                node.permissions.locallySet.splice(index, 1);
            }
        });
        permissionBody.permissions.locallySet = node.permissions.locallySet;
        return this.nodeService.updateNode(node.id, permissionBody);
    }
    updatePermissions(node, permissions) {
        const permissionBody = { permissions: { locallySet: [] } };
        permissionBody.permissions.locallySet = permissions;
        return this.nodeService.updateNode(node.id, permissionBody);
    }
    getNodeWithRoles(nodeId) {
        return this.nodeService.getNode(nodeId).pipe(switchMap(node => {
            return forkJoin({
                node: of(node),
                roles: this.getNodeRoles(node)
                    .pipe(catchError(() => { var _a; return of((_a = node.permissions) === null || _a === void 0 ? void 0 : _a.settable); }), map(_roles => _roles.map(role => ({ role, label: role }))))
            });
        }));
    }
    transformNodeToUserPerson(node) {
        let person = null, group = null;
        if (node.nodeType === 'cm:person') {
            const firstName = node.properties['cm:firstName'];
            const lastName = node.properties['cm:lastName'];
            const email = node.properties['cm:email'];
            const id = node.properties['cm:userName'];
            person = new EcmUserModel({ id, firstName, lastName, email });
        }
        if (node.nodeType === 'cm:authorityContainer') {
            const displayName = node.properties['cm:authorityDisplayName'] || node.properties['cm:authorityName'];
            const id = node.properties['cm:authorityName'];
            group = new Group({ displayName, id });
        }
        return { person, group };
    }
}
NodePermissionService.ɵfac = function NodePermissionService_Factory(t) { return new (t || NodePermissionService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc1.SearchService), ɵngcc0.ɵɵinject(ɵngcc1.NodesApiService), ɵngcc0.ɵɵinject(ɵngcc1.TranslationService)); };
NodePermissionService.ɵprov = i0.ɵɵdefineInjectable({ factory: function NodePermissionService_Factory() { return new NodePermissionService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i1.SearchService), i0.ɵɵinject(i1.NodesApiService), i0.ɵɵinject(i1.TranslationService)); }, token: NodePermissionService, providedIn: "root" });
NodePermissionService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: SearchService },
    { type: NodesApiService },
    { type: TranslationService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(NodePermissionService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc1.SearchService }, { type: ɵngcc1.NodesApiService }, { type: ɵngcc1.TranslationService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS1wZXJtaXNzaW9uLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb250ZW50LXNlcnZpY2VzL3NyYy9saWIvcGVybWlzc2lvbi1tYW5hZ2VyL3NlcnZpY2VzL25vZGUtcGVybWlzc2lvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQ0gsa0JBQWtCLEVBQ2xCLGVBQWUsRUFDZixhQUFhLEVBQ2Isa0JBQWtCLEVBQ2xCLFlBQVksRUFDZixNQUFNLG9CQUFvQixDQUFDO0FBQzVCLE9BQU8sRUFDSCxLQUFLLEVBRWMsU0FBUyxFQUsvQixNQUFNLGtCQUFrQixDQUFDO0FBQzFCLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRSxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRTtBQUFxQzs7O0FBS3JDLE1BQU0sT0FBTyxxQkFBcUI7QUFDbEMsSUFPSSxZQUFvQixVQUE4QixFQUM5QixnQkFBK0IsRUFDL0IsV0FBNEIsRUFDNUIsV0FBK0I7QUFDdkQsUUFKd0IsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7QUFBQyxRQUMvQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWU7QUFBQyxRQUNoQyxnQkFBVyxHQUFYLFdBQVcsQ0FBaUI7QUFBQyxRQUM3QixnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7QUFBQyxJQUNwRCxDQUFDO0FBQ0wsSUFWSSxJQUFJLFNBQVM7QUFBSztBQUNq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LGtCQUFrQjtBQUNyQjs7Ozs7OzBMQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1xuICAgIEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICBOb2Rlc0FwaVNlcnZpY2UsXG4gICAgU2VhcmNoU2VydmljZSxcbiAgICBUcmFuc2xhdGlvblNlcnZpY2UsXG4gICAgRWNtVXNlck1vZGVsXG59IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQge1xuICAgIEdyb3VwLFxuICAgIEdyb3VwTWVtYmVyRW50cnksXG4gICAgR3JvdXBNZW1iZXJQYWdpbmcsIEdyb3Vwc0FwaSxcbiAgICBOb2RlLFxuICAgIFBhdGhFbGVtZW50LFxuICAgIFBlcm1pc3Npb25FbGVtZW50LFxuICAgIFF1ZXJ5Qm9keVxufSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZvcmtKb2luLCBmcm9tLCBPYnNlcnZhYmxlLCBvZiwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQZXJtaXNzaW9uRGlzcGxheU1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL3Blcm1pc3Npb24ubW9kZWwnO1xuaW1wb3J0IHsgUm9sZU1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL3JvbGUubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIE5vZGVQZXJtaXNzaW9uU2VydmljZSB7XG5cbiAgICBfZ3JvdXBzQXBpOiBHcm91cHNBcGk7XG4gICAgZ2V0IGdyb3Vwc0FwaSgpOiBHcm91cHNBcGkge1xuICAgICAgICB0aGlzLl9ncm91cHNBcGkgPSB0aGlzLl9ncm91cHNBcGkgPz8gbmV3IEdyb3Vwc0FwaSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl9ncm91cHNBcGk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBzZWFyY2hBcGlTZXJ2aWNlOiBTZWFyY2hTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgbm9kZVNlcnZpY2U6IE5vZGVzQXBpU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRyYW5zbGF0aW9uOiBUcmFuc2xhdGlvblNlcnZpY2UpIHtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGEgbGlzdCBvZiByb2xlcyBmb3IgdGhlIGN1cnJlbnQgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZSBUaGUgdGFyZ2V0IG5vZGVcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBzdHJpbmdzIHJlcHJlc2VudGluZyB0aGUgcm9sZXNcbiAgICAgKi9cbiAgICBnZXROb2RlUm9sZXMobm9kZTogTm9kZSk6IE9ic2VydmFibGU8c3RyaW5nW10+IHtcbiAgICAgICAgY29uc3QgcmV0cmlldmVTaXRlUXVlcnlCb2R5OiBRdWVyeUJvZHkgPSB0aGlzLmJ1aWxkUmV0cmlldmVTaXRlUXVlcnlCb2R5KG5vZGUucGF0aC5lbGVtZW50cyk7XG4gICAgICAgIHJldHVybiB0aGlzLnNlYXJjaEFwaVNlcnZpY2Uuc2VhcmNoQnlRdWVyeUJvZHkocmV0cmlldmVTaXRlUXVlcnlCb2R5KVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKChzaXRlTm9kZUxpc3Q6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2l0ZU5vZGVMaXN0Lmxpc3QuZW50cmllcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzaXRlTmFtZSA9IHNpdGVOb2RlTGlzdC5saXN0LmVudHJpZXNbMF0uZW50cnkubmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEdyb3VwTWVtYmVyc0J5U2l0ZU5hbWUoc2l0ZU5hbWUpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKG5vZGUucGVybWlzc2lvbnM/LnNldHRhYmxlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIGdldE5vZGVQZXJtaXNzaW9ucyhub2RlOiBOb2RlKTogUGVybWlzc2lvbkRpc3BsYXlNb2RlbFtdIHtcbiAgICAgICAgY29uc3QgcmVzdWx0OiBQZXJtaXNzaW9uRGlzcGxheU1vZGVsW10gPSBbXTtcblxuICAgICAgICBpZiAobm9kZT8ucGVybWlzc2lvbnM/LmxvY2FsbHlTZXQpIHtcbiAgICAgICAgICAgIG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldC5tYXAoKHBlcm1pc3Npb25FbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobmV3IFBlcm1pc3Npb25EaXNwbGF5TW9kZWwocGVybWlzc2lvbkVsZW1lbnQpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG5vZGU/LnBlcm1pc3Npb25zPy5pbmhlcml0ZWQpIHtcbiAgICAgICAgICAgIG5vZGUucGVybWlzc2lvbnMuaW5oZXJpdGVkLm1hcCgocGVybWlzc2lvbkVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBwZXJtaXNzaW9uSW5oZXJpdGVkID0gbmV3IFBlcm1pc3Npb25EaXNwbGF5TW9kZWwocGVybWlzc2lvbkVsZW1lbnQpO1xuICAgICAgICAgICAgICAgIHBlcm1pc3Npb25Jbmhlcml0ZWQuaXNJbmhlcml0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHBlcm1pc3Npb25Jbmhlcml0ZWQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBwZXJtaXNzaW9uIHJvbGUgZm9yIGEgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZSBUYXJnZXQgbm9kZVxuICAgICAqIEBwYXJhbSB1cGRhdGVkUGVybWlzc2lvblJvbGUgUGVybWlzc2lvbiByb2xlIHRvIHVwZGF0ZSBvciBhZGRcbiAgICAgKiBAcmV0dXJucyBOb2RlIHdpdGggdXBkYXRlZCBwZXJtaXNzaW9uXG4gICAgICovXG4gICAgdXBkYXRlUGVybWlzc2lvblJvbGUobm9kZTogTm9kZSwgdXBkYXRlZFBlcm1pc3Npb25Sb2xlOiBQZXJtaXNzaW9uRWxlbWVudCk6IE9ic2VydmFibGU8Tm9kZT4ge1xuICAgICAgICBjb25zdCBwZXJtaXNzaW9uQm9keSA9IHsgcGVybWlzc2lvbnM6IHsgbG9jYWxseVNldDogW10gfSB9O1xuICAgICAgICBjb25zdCBpbmRleCA9IG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldC5tYXAoKHBlcm1pc3Npb24pID0+IHBlcm1pc3Npb24uYXV0aG9yaXR5SWQpLmluZGV4T2YodXBkYXRlZFBlcm1pc3Npb25Sb2xlLmF1dGhvcml0eUlkKTtcbiAgICAgICAgcGVybWlzc2lvbkJvZHkucGVybWlzc2lvbnMubG9jYWxseVNldCA9IHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXQuY29uY2F0KG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldCk7XG4gICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgIHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXRbaW5kZXhdID0gdXBkYXRlZFBlcm1pc3Npb25Sb2xlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcGVybWlzc2lvbkJvZHkucGVybWlzc2lvbnMubG9jYWxseVNldC5wdXNoKHVwZGF0ZWRQZXJtaXNzaW9uUm9sZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMubm9kZVNlcnZpY2UudXBkYXRlTm9kZShub2RlLmlkLCBwZXJtaXNzaW9uQm9keSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIHBlcm1pc3Npb25zIGZvciBhIG5vZGUuXG4gICAgICogQHBhcmFtIG5vZGVJZCBJRCBvZiB0aGUgdGFyZ2V0IG5vZGVcbiAgICAgKiBAcGFyYW0gcGVybWlzc2lvbkxpc3QgTmV3IHBlcm1pc3Npb24gc2V0dGluZ3NcbiAgICAgKiBAcmV0dXJucyBOb2RlIHdpdGggdXBkYXRlZCBwZXJtaXNzaW9uc1xuICAgICAqL1xuICAgIHVwZGF0ZU5vZGVQZXJtaXNzaW9ucyhub2RlSWQ6IHN0cmluZywgcGVybWlzc2lvbkxpc3Q6IFBlcm1pc3Npb25FbGVtZW50W10pOiBPYnNlcnZhYmxlPE5vZGU+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMubm9kZVNlcnZpY2UuZ2V0Tm9kZShub2RlSWQpLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKG5vZGUpID0+IHRoaXMudXBkYXRlTG9jYWxseVNldFBlcm1pc3Npb25zKG5vZGUsIHBlcm1pc3Npb25MaXN0KSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBsb2NhbGx5IHNldCBwZXJtaXNzaW9ucyBmb3IgYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlIElEIG9mIHRoZSB0YXJnZXQgbm9kZVxuICAgICAqIEBwYXJhbSBwZXJtaXNzaW9ucyBQZXJtaXNzaW9uIHNldHRpbmdzXG4gICAgICogQHJldHVybnMgTm9kZSB3aXRoIHVwZGF0ZWQgcGVybWlzc2lvbnNcbiAgICAgKi9cbiAgICB1cGRhdGVMb2NhbGx5U2V0UGVybWlzc2lvbnMobm9kZTogTm9kZSwgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25FbGVtZW50W10pOiBPYnNlcnZhYmxlPE5vZGU+IHtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbkJvZHkgPSB7IHBlcm1pc3Npb25zOiB7IGxvY2FsbHlTZXQ6IFtdIH0gfTtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbkxpc3QgPSBwZXJtaXNzaW9ucztcbiAgICAgICAgY29uc3QgZHVwbGljYXRlZFBlcm1pc3Npb25zID0gdGhpcy5nZXREdXBsaWNhdGVkUGVybWlzc2lvbnMobm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0LCBwZXJtaXNzaW9uTGlzdCk7XG4gICAgICAgIGlmIChkdXBsaWNhdGVkUGVybWlzc2lvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3QgbGlzdCA9IGR1cGxpY2F0ZWRQZXJtaXNzaW9ucy5tYXAoKHBlcm1pc3Npb24pID0+ICdhdXRob3JpdHkgLT4gJyArIHBlcm1pc3Npb24uYXV0aG9yaXR5SWQgKyAnIC8gcm9sZSAtPiAnICsgcGVybWlzc2lvbi5uYW1lKS5qb2luKCcsICcpO1xuICAgICAgICAgICAgY29uc3QgZHVwbGljYXRlUGVybWlzc2lvbk1lc3NhZ2U6IHN0cmluZyA9IHRoaXMudHJhbnNsYXRpb24uaW5zdGFudCgnUEVSTUlTU0lPTl9NQU5BR0VSLkVSUk9SLkRVUExJQ0FURS1QRVJNSVNTSU9OJywgeyBsaXN0IH0pO1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZHVwbGljYXRlUGVybWlzc2lvbk1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICAgIHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXQgPSBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQgPyBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQuY29uY2F0KHBlcm1pc3Npb25MaXN0KSA6IHBlcm1pc3Npb25MaXN0O1xuICAgICAgICByZXR1cm4gdGhpcy5ub2RlU2VydmljZS51cGRhdGVOb2RlKG5vZGUuaWQsIHBlcm1pc3Npb25Cb2R5KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldER1cGxpY2F0ZWRQZXJtaXNzaW9ucyhub2RlTG9jYWxseVNldDogUGVybWlzc2lvbkVsZW1lbnRbXSwgcGVybWlzc2lvbkxpc3RBZGRlZDogUGVybWlzc2lvbkVsZW1lbnRbXSk6IFBlcm1pc3Npb25FbGVtZW50W10ge1xuICAgICAgICBjb25zdCBkdXBsaWNhdGVQZXJtaXNzaW9uczogUGVybWlzc2lvbkVsZW1lbnRbXSA9IFtdO1xuICAgICAgICBpZiAobm9kZUxvY2FsbHlTZXQpIHtcbiAgICAgICAgICAgIHBlcm1pc3Npb25MaXN0QWRkZWQuZm9yRWFjaCgocGVybWlzc2lvbjogUGVybWlzc2lvbkVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBkdXBsaWNhdGUgPSBub2RlTG9jYWxseVNldC5maW5kKChsb2NhbFBlcm1pc3Npb24pID0+IHRoaXMuaXNFcXVhbFBlcm1pc3Npb24obG9jYWxQZXJtaXNzaW9uLCBwZXJtaXNzaW9uKSk7XG4gICAgICAgICAgICAgICAgaWYgKGR1cGxpY2F0ZSkge1xuICAgICAgICAgICAgICAgICAgICBkdXBsaWNhdGVQZXJtaXNzaW9ucy5wdXNoKGR1cGxpY2F0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGR1cGxpY2F0ZVBlcm1pc3Npb25zO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNFcXVhbFBlcm1pc3Npb24ob2xkUGVybWlzc2lvbjogUGVybWlzc2lvbkVsZW1lbnQsIG5ld1Blcm1pc3Npb246IFBlcm1pc3Npb25FbGVtZW50KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBvbGRQZXJtaXNzaW9uLmFjY2Vzc1N0YXR1cyA9PT0gbmV3UGVybWlzc2lvbi5hY2Nlc3NTdGF0dXMgJiZcbiAgICAgICAgICAgIG9sZFBlcm1pc3Npb24uYXV0aG9yaXR5SWQgPT09IG5ld1Blcm1pc3Npb24uYXV0aG9yaXR5SWQgJiZcbiAgICAgICAgICAgIG9sZFBlcm1pc3Npb24ubmFtZSA9PT0gbmV3UGVybWlzc2lvbi5uYW1lO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZXMgYSBwZXJtaXNzaW9uIHNldHRpbmcgZnJvbSBhIG5vZGUuXG4gICAgICogQHBhcmFtIG5vZGUgSUQgb2YgdGhlIHRhcmdldCBub2RlXG4gICAgICogQHBhcmFtIHBlcm1pc3Npb25Ub1JlbW92ZSBQZXJtaXNzaW9uIHNldHRpbmcgdG8gcmVtb3ZlXG4gICAgICogQHJldHVybnMgTm9kZSB3aXRoIG1vZGlmaWVkIHBlcm1pc3Npb25zXG4gICAgICovXG4gICAgcmVtb3ZlUGVybWlzc2lvbihub2RlOiBOb2RlLCBwZXJtaXNzaW9uVG9SZW1vdmU6IFBlcm1pc3Npb25FbGVtZW50KTogT2JzZXJ2YWJsZTxOb2RlPiB7XG4gICAgICAgIGNvbnN0IHBlcm1pc3Npb25Cb2R5ID0geyBwZXJtaXNzaW9uczogeyBsb2NhbGx5U2V0OiBbXSB9IH07XG4gICAgICAgIGNvbnN0IGluZGV4ID0gbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0Lm1hcCgocGVybWlzc2lvbikgPT4gcGVybWlzc2lvbi5hdXRob3JpdHlJZCkuaW5kZXhPZihwZXJtaXNzaW9uVG9SZW1vdmUuYXV0aG9yaXR5SWQpO1xuXG4gICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgIG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldC5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgcGVybWlzc2lvbkJvZHkucGVybWlzc2lvbnMubG9jYWxseVNldCA9IG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldDtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm5vZGVTZXJ2aWNlLnVwZGF0ZU5vZGUobm9kZS5pZCwgcGVybWlzc2lvbkJvZHkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG9mKG5vZGUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRHcm91cE1lbWJlcnNCeVNpdGVOYW1lKHNpdGVOYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZ1tdPiB7XG4gICAgICAgIGNvbnN0IGdyb3VwTmFtZSA9ICdHUk9VUF9zaXRlXycgKyBzaXRlTmFtZTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0R3JvdXBNZW1iZXJCeUdyb3VwTmFtZShncm91cE5hbWUpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKGdyb3VwTWVtYmVyUGFnaW5nOiBHcm91cE1lbWJlclBhZ2luZykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXNwbGF5UmVzdWx0OiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBncm91cE1lbWJlclBhZ2luZy5saXN0LmVudHJpZXMuZm9yRWFjaCgobWVtYmVyOiBHcm91cE1lbWJlckVudHJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5UmVzdWx0LnB1c2godGhpcy5mb3JtYXR0ZWRSb2xlTmFtZShtZW1iZXIuZW50cnkuZGlzcGxheU5hbWUsICdzaXRlXycgKyBzaXRlTmFtZSkpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlSZXN1bHQ7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgbWVtYmVycyByZWxhdGVkIHRvIGEgZ3JvdXAgbmFtZS5cbiAgICAgKiBAcGFyYW0gZ3JvdXBOYW1lIE5hbWUgb2YgZ3JvdXAgdG8gbG9vayBmb3IgbWVtYmVyc1xuICAgICAqIEBwYXJhbSBvcHRzIEV4dHJhIG9wdGlvbnMgc3VwcG9ydGVkIGJ5IEpTLUFQSVxuICAgICAqIEByZXR1cm5zIExpc3Qgb2YgbWVtYmVyc1xuICAgICAqL1xuICAgIGdldEdyb3VwTWVtYmVyQnlHcm91cE5hbWUoZ3JvdXBOYW1lOiBzdHJpbmcsIG9wdHM/OiBhbnkpOiBPYnNlcnZhYmxlPEdyb3VwTWVtYmVyUGFnaW5nPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuZ3JvdXBzQXBpLmxpc3RHcm91cE1lbWJlcnNoaXBzKGdyb3VwTmFtZSwgb3B0cykpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZm9ybWF0dGVkUm9sZU5hbWUoZGlzcGxheU5hbWUsIHNpdGVOYW1lKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lLnJlcGxhY2Uoc2l0ZU5hbWUgKyAnXycsICcnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGJ1aWxkUmV0cmlldmVTaXRlUXVlcnlCb2R5KG5vZGVQYXRoOiBQYXRoRWxlbWVudFtdKTogUXVlcnlCb2R5IHtcbiAgICAgICAgY29uc3QgcGF0aE5hbWVzID0gbm9kZVBhdGgubWFwKChub2RlOiBQYXRoRWxlbWVudCkgPT4gJ25hbWU6IFwiJyArIG5vZGUubmFtZSArICdcIicpO1xuICAgICAgICBjb25zdCBidWlsdFBhdGhOYW1lcyA9IHBhdGhOYW1lcy5qb2luKCcgT1IgJyk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdxdWVyeSc6IHtcbiAgICAgICAgICAgICAgICAncXVlcnknOiBidWlsdFBhdGhOYW1lc1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdwYWdpbmcnOiB7XG4gICAgICAgICAgICAgICAgJ21heEl0ZW1zJzogMTAwLFxuICAgICAgICAgICAgICAgICdza2lwQ291bnQnOiAwXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ2luY2x1ZGUnOiBbJ2FzcGVjdE5hbWVzJywgJ3Byb3BlcnRpZXMnXSxcbiAgICAgICAgICAgICdmaWx0ZXJRdWVyaWVzJzogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgJ3F1ZXJ5JzpcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiVFlQRTonc3Q6c2l0ZSdcIlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBnZXRMb2NhbFBlcm1pc3Npb25zKG5vZGU6IE5vZGUpOiBQZXJtaXNzaW9uRGlzcGxheU1vZGVsW10ge1xuICAgICAgICBjb25zdCByZXN1bHQ6IFBlcm1pc3Npb25EaXNwbGF5TW9kZWxbXSA9IFtdO1xuXG4gICAgICAgIGlmIChub2RlPy5wZXJtaXNzaW9ucz8ubG9jYWxseVNldCkge1xuICAgICAgICAgICAgbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0LmZvckVhY2goKHBlcm1pc3Npb25FbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobmV3IFBlcm1pc3Npb25EaXNwbGF5TW9kZWwocGVybWlzc2lvbkVsZW1lbnQpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBnZXRJbmhlcml0ZWRQZXJtaXNzaW9uKG5vZGU6IE5vZGUpOiBQZXJtaXNzaW9uRGlzcGxheU1vZGVsW10ge1xuICAgICAgICBjb25zdCByZXN1bHQ6IFBlcm1pc3Npb25EaXNwbGF5TW9kZWxbXSA9IFtdO1xuXG4gICAgICAgIGlmIChub2RlPy5wZXJtaXNzaW9ucz8uaW5oZXJpdGVkKSB7XG4gICAgICAgICAgICBub2RlLnBlcm1pc3Npb25zLmluaGVyaXRlZC5mb3JFYWNoKChwZXJtaXNzaW9uRWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBlcm1pc3Npb25Jbmhlcml0ZWQgPSBuZXcgUGVybWlzc2lvbkRpc3BsYXlNb2RlbChwZXJtaXNzaW9uRWxlbWVudCk7XG4gICAgICAgICAgICAgICAgcGVybWlzc2lvbkluaGVyaXRlZC5pc0luaGVyaXRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gocGVybWlzc2lvbkluaGVyaXRlZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZXMgcGVybWlzc2lvbnMgc2V0dGluZyBmcm9tIGEgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZSB0YXJnZXQgbm9kZSB3aXRoIHBlcm1pc3Npb25cbiAgICAgKiBAcGFyYW0gcGVybWlzc2lvbnMgUGVybWlzc2lvbnMgdG8gcmVtb3ZlXG4gICAgICogQHJldHVybnMgTm9kZSB3aXRoIG1vZGlmaWVkIHBlcm1pc3Npb25zXG4gICAgICovXG4gICAgcmVtb3ZlUGVybWlzc2lvbnMobm9kZTogTm9kZSwgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25FbGVtZW50W10pOiBPYnNlcnZhYmxlPE5vZGU+IHtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbkJvZHkgPSB7IHBlcm1pc3Npb25zOiB7IGxvY2FsbHlTZXQ6IFtdIH0gfTtcblxuICAgICAgICBwZXJtaXNzaW9ucy5mb3JFYWNoKChwZXJtaXNzaW9uKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldC5maW5kSW5kZXgoKGxvY2FsbHlTZXQpID0+IGxvY2FsbHlTZXQuYXV0aG9yaXR5SWQgPT09IHBlcm1pc3Npb24uYXV0aG9yaXR5SWQpO1xuICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgIG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldC5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcGVybWlzc2lvbkJvZHkucGVybWlzc2lvbnMubG9jYWxseVNldCA9IG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldDtcbiAgICAgICAgcmV0dXJuIHRoaXMubm9kZVNlcnZpY2UudXBkYXRlTm9kZShub2RlLmlkLCBwZXJtaXNzaW9uQm9keSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogdXBkYXRlcyBwZXJtaXNzaW9ucyBzZXR0aW5nIGZyb20gYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlIHRhcmdldCBub2RlIHdpdGggcGVybWlzc2lvblxuICAgICAqIEBwYXJhbSBwZXJtaXNzaW9ucyBQZXJtaXNzaW9ucyB0byB1cGRhdGVcbiAgICAgKiBAcmV0dXJucyBOb2RlIHdpdGggbW9kaWZpZWQgcGVybWlzc2lvbnNcbiAgICAgKi9cbiAgICB1cGRhdGVQZXJtaXNzaW9ucyhub2RlOiBOb2RlLCBwZXJtaXNzaW9uczogUGVybWlzc2lvbkVsZW1lbnRbXSk6IE9ic2VydmFibGU8Tm9kZT4ge1xuICAgICAgICBjb25zdCBwZXJtaXNzaW9uQm9keSA9IHsgcGVybWlzc2lvbnM6IHsgbG9jYWxseVNldDogW10gfSB9O1xuICAgICAgICBwZXJtaXNzaW9uQm9keS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0ID0gcGVybWlzc2lvbnM7XG4gICAgICAgIHJldHVybiB0aGlzLm5vZGVTZXJ2aWNlLnVwZGF0ZU5vZGUobm9kZS5pZCwgcGVybWlzc2lvbkJvZHkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYWxsIG5vZGUgZGV0YWlsIGZvciBub2RlSWQgYWxvbmcgd2l0aCBzZXR0YWJsZSBwZXJtaXNzaW9ucy5cbiAgICAgKiBAcGFyYW0gbm9kZUlkIElkIG9mIHRoZSBub2RlXG4gICAgICogQHJldHVybnMgbm9kZSBhbmQgaXQncyBhc3NvY2lhdGVkIHJvbGVzIHsgbm9kZTogTm9kZTsgcm9sZXM6IFJvbGVNb2RlbFtdIH1cbiAgICAgKi9cbiAgICBnZXROb2RlV2l0aFJvbGVzKG5vZGVJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTx7IG5vZGU6IE5vZGU7IHJvbGVzOiBSb2xlTW9kZWxbXSB9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLm5vZGVTZXJ2aWNlLmdldE5vZGUobm9kZUlkKS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKG5vZGUgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBmb3JrSm9pbih7XG4gICAgICAgICAgICAgICAgICAgIG5vZGU6IG9mKG5vZGUpLFxuICAgICAgICAgICAgICAgICAgICByb2xlczogdGhpcy5nZXROb2RlUm9sZXMobm9kZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKCkgPT4gb2Yobm9kZS5wZXJtaXNzaW9ucz8uc2V0dGFibGUpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXAoX3JvbGVzID0+IF9yb2xlcy5tYXAocm9sZSA9PiAoeyByb2xlLCBsYWJlbDogcm9sZSB9KSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHRyYW5zZm9ybU5vZGVUb1VzZXJQZXJzb24obm9kZTogTm9kZSk6IHsgcGVyc29uOiBFY21Vc2VyTW9kZWwsIGdyb3VwOiBHcm91cCB9IHtcbiAgICAgICAgbGV0IHBlcnNvbiA9IG51bGwsIGdyb3VwID0gbnVsbDtcbiAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09ICdjbTpwZXJzb24nKSB7XG4gICAgICAgICAgICBjb25zdCBmaXJzdE5hbWUgPSBub2RlLnByb3BlcnRpZXNbJ2NtOmZpcnN0TmFtZSddO1xuICAgICAgICAgICAgY29uc3QgbGFzdE5hbWUgPSBub2RlLnByb3BlcnRpZXNbJ2NtOmxhc3ROYW1lJ107XG4gICAgICAgICAgICBjb25zdCBlbWFpbCA9IG5vZGUucHJvcGVydGllc1snY206ZW1haWwnXTtcbiAgICAgICAgICAgIGNvbnN0IGlkID0gbm9kZS5wcm9wZXJ0aWVzWydjbTp1c2VyTmFtZSddO1xuICAgICAgICAgICAgcGVyc29uID0gbmV3IEVjbVVzZXJNb2RlbCh7IGlkLCBmaXJzdE5hbWUsIGxhc3ROYW1lLCBlbWFpbCB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAnY206YXV0aG9yaXR5Q29udGFpbmVyJykge1xuICAgICAgICAgICAgY29uc3QgZGlzcGxheU5hbWUgPSBub2RlLnByb3BlcnRpZXNbJ2NtOmF1dGhvcml0eURpc3BsYXlOYW1lJ10gfHwgbm9kZS5wcm9wZXJ0aWVzWydjbTphdXRob3JpdHlOYW1lJ107XG4gICAgICAgICAgICBjb25zdCBpZCA9IG5vZGUucHJvcGVydGllc1snY206YXV0aG9yaXR5TmFtZSddO1xuICAgICAgICAgICAgZ3JvdXAgPSBuZXcgR3JvdXAoeyBkaXNwbGF5TmFtZSwgaWQgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHsgcGVyc29uLCBncm91cCB9O1xuICAgIH1cbn1cbiJdfQ==