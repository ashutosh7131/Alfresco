import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { AlfrescoApiService, LogService, NotificationService } from '@alfresco/adf-core';
import { MatDialog } from '@angular/material/dialog';
import { ContentNodeSelectorComponent, NodeAction } from '@alfresco/adf-content-services';
import { NodesApi } from '@alfresco/js-api';
import { from, Subject, throwError } from 'rxjs';
import { catchError, map, mapTo } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as i2 from "@angular/material/dialog";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
import * as ɵngcc2 from '@angular/material/dialog';
export class ContentCloudNodeSelectorService {
    constructor(apiService, notificationService, logService, dialog) {
        this.apiService = apiService;
        this.notificationService = notificationService;
        this.logService = logService;
        this.dialog = dialog;
        this.sourceNodeNotFound = false;
    }
    get nodesApi() {
        var _a;
        this._nodesApi = (_a = this._nodesApi) !== null && _a !== void 0 ? _a : new NodesApi(this.apiService.getInstance());
        return this._nodesApi;
    }
    openUploadFileDialog(currentFolderId, selectionMode, isAllFileSources, restrictRootToCurrentFolderId) {
        const select = new Subject();
        select.subscribe({ complete: this.close.bind(this) });
        const data = {
            title: 'Select a file',
            actionName: NodeAction.ATTACH,
            currentFolderId,
            restrictRootToCurrentFolderId,
            select,
            selectionMode,
            isSelectionValid: (entry) => entry.isFile,
            showFilesInResult: true,
            showDropdownSiteList: false,
            showLocalUploadButton: isAllFileSources
        };
        this.openContentNodeDialog(data, 'adf-content-node-selector-dialog', '66%');
        return select;
    }
    getNodeIdFromPath(destinationFolderPath) {
        return __awaiter(this, void 0, void 0, function* () {
            if (destinationFolderPath.alias && destinationFolderPath.path) {
                try {
                    return yield this.getNodeId(destinationFolderPath.alias, destinationFolderPath.path).toPromise();
                }
                catch (error) {
                    this.logService.error(error);
                }
            }
            return this.getNodeId(destinationFolderPath.alias).toPromise();
        });
    }
    getNodeIdFromFolderVariableValue(variableValue, defaultAlias) {
        return __awaiter(this, void 0, void 0, function* () {
            const isExistingNode = yield this.isExistingNode(variableValue);
            return isExistingNode ? variableValue : this.getNodeId(defaultAlias).toPromise();
        });
    }
    isExistingNode(nodeId) {
        return __awaiter(this, void 0, void 0, function* () {
            let isExistingNode = false;
            if (nodeId) {
                try {
                    isExistingNode = yield this.getNodeId(nodeId).pipe(mapTo(true)).toPromise();
                }
                catch (error) {
                    this.logService.error(error);
                }
            }
            return isExistingNode;
        });
    }
    getNodeId(nodeId, relativePath) {
        let opts;
        if (relativePath) {
            opts = { relativePath };
        }
        return from(this.nodesApi.getNode(nodeId, opts)).pipe(map((nodeEntry) => nodeEntry.entry.id), catchError((error) => {
            this.sourceNodeNotFound = true;
            return this.handleError(error);
        }));
    }
    openContentNodeDialog(data, currentPanelClass, chosenWidth) {
        const contentNodeDialog = this.dialog.open(ContentNodeSelectorComponent, { data, panelClass: currentPanelClass, width: chosenWidth });
        contentNodeDialog.afterOpened().subscribe(() => {
            if (this.sourceNodeNotFound) {
                this.notificationService.showWarning('ADF_CLOUD_TASK_FORM.ERROR.DESTINATION_FOLDER_PATH_ERROR');
            }
        });
        contentNodeDialog.afterClosed().subscribe(() => {
            this.sourceNodeNotFound = false;
        });
    }
    close() {
        this.dialog.closeAll();
    }
    handleError(error) {
        return throwError(error || 'Server error');
    }
}
ContentCloudNodeSelectorService.ɵfac = function ContentCloudNodeSelectorService_Factory(t) { return new (t || ContentCloudNodeSelectorService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc1.NotificationService), ɵngcc0.ɵɵinject(ɵngcc1.LogService), ɵngcc0.ɵɵinject(ɵngcc2.MatDialog)); };
ContentCloudNodeSelectorService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ContentCloudNodeSelectorService_Factory() { return new ContentCloudNodeSelectorService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i1.NotificationService), i0.ɵɵinject(i1.LogService), i0.ɵɵinject(i2.MatDialog)); }, token: ContentCloudNodeSelectorService, providedIn: "root" });
ContentCloudNodeSelectorService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: NotificationService },
    { type: LogService },
    { type: MatDialog }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ContentCloudNodeSelectorService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc1.NotificationService }, { type: ɵngcc1.LogService }, { type: ɵngcc2.MatDialog }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC1jbG91ZC1ub2RlLXNlbGVjdG9yLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9wcm9jZXNzLXNlcnZpY2VzLWNsb3VkL3NyYy9saWIvZm9ybS9zZXJ2aWNlcy9jb250ZW50LWNsb3VkLW5vZGUtc2VsZWN0b3Iuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGtCQUFrQixFQUFFLFVBQVUsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3pGLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNyRCxPQUFPLEVBQ0gsNEJBQTRCLEVBRTVCLFVBQVUsRUFDYixNQUFNLGdDQUFnQyxDQUFDO0FBQ3hDLE9BQU8sRUFBbUIsUUFBUSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDN0QsT0FBTyxFQUFFLElBQUksRUFBYyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzdELE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3hEO0FBQXFDO0FBQTBDOzs7O0FBSy9FLE1BQU0sT0FBTywrQkFBK0I7QUFDNUMsSUFTSSxZQUNZLFVBQThCLEVBQzlCLG1CQUF3QyxFQUN4QyxVQUFzQixFQUN0QixNQUFpQjtBQUNqQyxRQUpnQixlQUFVLEdBQVYsVUFBVSxDQUFvQjtBQUFDLFFBQy9CLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7QUFBQyxRQUN6QyxlQUFVLEdBQVYsVUFBVSxDQUFZO0FBQUMsUUFDdkIsV0FBTSxHQUFOLE1BQU0sQ0FBVztBQUFDLFFBTjlCLHVC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QUU7QUFDekMsZ0JBQWdCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxXQUFXLENBQUMseURBQXlELENBQUMsQ0FBQztBQUNoSCxhQUFhO0FBQ2IsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUNYLFFBQVEsaUJBQWlCLENBQUMsV0FBVyxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtBQUN2RCxZQUFZLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUM7QUFDNUMsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUNYLElBQUksQ0FBQztBQUNMLElBQ0ksS0FBSztBQUNULFFBQVEsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUMvQixJQUFJLENBQUM7QUFDTCxJQUNZLFdBQVcsQ0FBQyxLQUFVO0FBQUksUUFDOUIsT0FBTyxVQUFVLENBQUMsS0FBSyxJQUFJLGNBQWMsQ0FBQyxDQUFDO0FBQ25ELElBQUksQ0FBQztBQUNMO2tUQUFDO0FBQ0QsMldBbkdLO0FBQUM7RUFITCxVQUFVLFNBQUMsckJBS0csWUFqQk4sa0JBQWtCO0tBYXZCLFVBQVUsRUFBRSxNQUFNLHZCQWJTLFlBQVUsbUJBQW1CO0VBYzNELEZBZCtELFlBQW5DLFVBQVU7QUFBSSxZQUNsQyxTQUFTO0FBQUc7Ozs7OztrTEFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlLCBMb2dTZXJ2aWNlLCBOb3RpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IE1hdERpYWxvZyB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2RpYWxvZyc7XG5pbXBvcnQge1xuICAgIENvbnRlbnROb2RlU2VsZWN0b3JDb21wb25lbnQsXG4gICAgQ29udGVudE5vZGVTZWxlY3RvckNvbXBvbmVudERhdGEsXG4gICAgTm9kZUFjdGlvblxufSBmcm9tICdAYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMnO1xuaW1wb3J0IHsgTm9kZSwgTm9kZUVudHJ5LCBOb2Rlc0FwaSB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgZnJvbSwgT2JzZXJ2YWJsZSwgU3ViamVjdCwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBtYXBUbyB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IERlc3RpbmF0aW9uRm9sZGVyUGF0aE1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL2Zvcm0tY2xvdWQtcmVwcmVzZW50YXRpb24ubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIENvbnRlbnRDbG91ZE5vZGVTZWxlY3RvclNlcnZpY2Uge1xuXG4gICAgcHJpdmF0ZSBfbm9kZXNBcGk6IE5vZGVzQXBpO1xuICAgIGdldCBub2Rlc0FwaSgpOiBOb2Rlc0FwaSB7XG4gICAgICAgIHRoaXMuX25vZGVzQXBpID0gdGhpcy5fbm9kZXNBcGkgPz8gbmV3IE5vZGVzQXBpKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX25vZGVzQXBpO1xuICAgIH1cblxuICAgIHNvdXJjZU5vZGVOb3RGb3VuZCA9IGZhbHNlO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgYXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIG5vdGlmaWNhdGlvblNlcnZpY2U6IE5vdGlmaWNhdGlvblNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgbG9nU2VydmljZTogTG9nU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBkaWFsb2c6IE1hdERpYWxvZykge1xuICAgIH1cblxuICAgIG9wZW5VcGxvYWRGaWxlRGlhbG9nKGN1cnJlbnRGb2xkZXJJZD86IHN0cmluZywgc2VsZWN0aW9uTW9kZT86IHN0cmluZywgaXNBbGxGaWxlU291cmNlcz86IGJvb2xlYW4sIHJlc3RyaWN0Um9vdFRvQ3VycmVudEZvbGRlcklkPzogYm9vbGVhbik6IE9ic2VydmFibGU8Tm9kZVtdPiB7XG4gICAgICAgIGNvbnN0IHNlbGVjdCA9IG5ldyBTdWJqZWN0PE5vZGVbXT4oKTtcbiAgICAgICAgc2VsZWN0LnN1YnNjcmliZSh7IGNvbXBsZXRlOiB0aGlzLmNsb3NlLmJpbmQodGhpcykgfSk7XG4gICAgICAgIGNvbnN0IGRhdGEgPSA8Q29udGVudE5vZGVTZWxlY3RvckNvbXBvbmVudERhdGE+IHtcbiAgICAgICAgICAgIHRpdGxlOiAnU2VsZWN0IGEgZmlsZScsXG4gICAgICAgICAgICBhY3Rpb25OYW1lOiBOb2RlQWN0aW9uLkFUVEFDSCxcbiAgICAgICAgICAgIGN1cnJlbnRGb2xkZXJJZCxcbiAgICAgICAgICAgIHJlc3RyaWN0Um9vdFRvQ3VycmVudEZvbGRlcklkLFxuICAgICAgICAgICAgc2VsZWN0LFxuICAgICAgICAgICAgc2VsZWN0aW9uTW9kZSxcbiAgICAgICAgICAgIGlzU2VsZWN0aW9uVmFsaWQ6IChlbnRyeTogTm9kZSkgPT4gZW50cnkuaXNGaWxlLFxuICAgICAgICAgICAgc2hvd0ZpbGVzSW5SZXN1bHQ6IHRydWUsXG4gICAgICAgICAgICBzaG93RHJvcGRvd25TaXRlTGlzdDogZmFsc2UsXG4gICAgICAgICAgICBzaG93TG9jYWxVcGxvYWRCdXR0b246IGlzQWxsRmlsZVNvdXJjZXNcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5vcGVuQ29udGVudE5vZGVEaWFsb2coZGF0YSwgJ2FkZi1jb250ZW50LW5vZGUtc2VsZWN0b3ItZGlhbG9nJywgJzY2JScpO1xuICAgICAgICByZXR1cm4gc2VsZWN0O1xuICAgIH1cblxuICAgIGFzeW5jIGdldE5vZGVJZEZyb21QYXRoKGRlc3RpbmF0aW9uRm9sZGVyUGF0aDogRGVzdGluYXRpb25Gb2xkZXJQYXRoTW9kZWwpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICBpZiAoZGVzdGluYXRpb25Gb2xkZXJQYXRoLmFsaWFzICYmIGRlc3RpbmF0aW9uRm9sZGVyUGF0aC5wYXRoKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmdldE5vZGVJZChkZXN0aW5hdGlvbkZvbGRlclBhdGguYWxpYXMsIGRlc3RpbmF0aW9uRm9sZGVyUGF0aC5wYXRoKS50b1Byb21pc2UoKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmdldE5vZGVJZChkZXN0aW5hdGlvbkZvbGRlclBhdGguYWxpYXMpLnRvUHJvbWlzZSgpO1xuICAgIH1cblxuICAgIGFzeW5jIGdldE5vZGVJZEZyb21Gb2xkZXJWYXJpYWJsZVZhbHVlKHZhcmlhYmxlVmFsdWU6IHN0cmluZywgZGVmYXVsdEFsaWFzPzogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgY29uc3QgaXNFeGlzdGluZ05vZGUgPSBhd2FpdCB0aGlzLmlzRXhpc3RpbmdOb2RlKHZhcmlhYmxlVmFsdWUpO1xuICAgICAgICByZXR1cm4gaXNFeGlzdGluZ05vZGUgPyB2YXJpYWJsZVZhbHVlIDogdGhpcy5nZXROb2RlSWQoZGVmYXVsdEFsaWFzKS50b1Byb21pc2UoKTtcbiAgICB9XG5cbiAgICBhc3luYyBpc0V4aXN0aW5nTm9kZShub2RlSWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBsZXQgaXNFeGlzdGluZ05vZGUgPSBmYWxzZTtcbiAgICAgICAgaWYgKG5vZGVJZCkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBpc0V4aXN0aW5nTm9kZSA9IGF3YWl0IHRoaXMuZ2V0Tm9kZUlkKG5vZGVJZCkucGlwZShtYXBUbyh0cnVlKSkudG9Qcm9taXNlKCk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGlzRXhpc3RpbmdOb2RlO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Tm9kZUlkKG5vZGVJZDogc3RyaW5nLCByZWxhdGl2ZVBhdGg/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgICAgICBsZXQgb3B0czogYW55O1xuICAgICAgICBpZiAocmVsYXRpdmVQYXRoKSB7XG4gICAgICAgICAgICBvcHRzID0geyByZWxhdGl2ZVBhdGggfTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLm5vZGVzQXBpLmdldE5vZGUobm9kZUlkLCBvcHRzKSkucGlwZShcbiAgICAgICAgICAgIG1hcCgobm9kZUVudHJ5OiBOb2RlRW50cnkpID0+IG5vZGVFbnRyeS5lbnRyeS5pZCksXG4gICAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc291cmNlTm9kZU5vdEZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5oYW5kbGVFcnJvcihlcnJvcik7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgb3BlbkNvbnRlbnROb2RlRGlhbG9nKGRhdGE6IENvbnRlbnROb2RlU2VsZWN0b3JDb21wb25lbnREYXRhLCBjdXJyZW50UGFuZWxDbGFzczogc3RyaW5nLCBjaG9zZW5XaWR0aDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGNvbnRlbnROb2RlRGlhbG9nID0gdGhpcy5kaWFsb2cub3BlbihDb250ZW50Tm9kZVNlbGVjdG9yQ29tcG9uZW50LCB7IGRhdGEsIHBhbmVsQ2xhc3M6IGN1cnJlbnRQYW5lbENsYXNzLCB3aWR0aDogY2hvc2VuV2lkdGggfSk7XG4gICAgICAgIGNvbnRlbnROb2RlRGlhbG9nLmFmdGVyT3BlbmVkKCkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLnNvdXJjZU5vZGVOb3RGb3VuZCkge1xuICAgICAgICAgICAgICAgIHRoaXMubm90aWZpY2F0aW9uU2VydmljZS5zaG93V2FybmluZygnQURGX0NMT1VEX1RBU0tfRk9STS5FUlJPUi5ERVNUSU5BVElPTl9GT0xERVJfUEFUSF9FUlJPUicpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgY29udGVudE5vZGVEaWFsb2cuYWZ0ZXJDbG9zZWQoKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2VOb2RlTm90Rm91bmQgPSBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgY2xvc2UoKSB7XG4gICAgICAgIHRoaXMuZGlhbG9nLmNsb3NlQWxsKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVFcnJvcihlcnJvcjogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IgfHwgJ1NlcnZlciBlcnJvcicpO1xuICAgIH1cbn1cbiJdfQ==