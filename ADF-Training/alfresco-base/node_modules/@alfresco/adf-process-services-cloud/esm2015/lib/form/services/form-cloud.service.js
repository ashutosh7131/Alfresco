import { Injectable } from '@angular/core';
import { AlfrescoApiService, AppConfigService, FormOutcomeModel, FormModel } from '@alfresco/adf-core';
import { from } from 'rxjs';
import { map, switchMap } from 'rxjs/operators';
import { UploadApi } from '@alfresco/js-api';
import { TaskVariableCloud } from '../models/task-variable-cloud.model';
import { BaseCloudService } from '../../services/base-cloud.service';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
export class FormCloudService extends BaseCloudService {
    constructor(apiService, appConfigService) {
        super(apiService, appConfigService);
    }
    get uploadApi() {
        var _a;
        this._uploadApi = (_a = this._uploadApi) !== null && _a !== void 0 ? _a : new UploadApi(this.apiService.getInstance());
        return this._uploadApi;
    }
    getTaskForm(appName, taskId, version) {
        return this.getTask(appName, taskId).pipe(switchMap(task => {
            return this.getForm(appName, task.formKey, version).pipe(map((form) => {
                const flattenForm = Object.assign(Object.assign(Object.assign({}, form.formRepresentation), form.formRepresentation.formDefinition), { taskId: task.id, taskName: task.name, processDefinitionId: task.processDefinitionId, processInstanceId: task.processInstanceId });
                delete flattenForm.formDefinition;
                return flattenForm;
            }));
        }));
    }
    saveTaskForm(appName, taskId, processInstanceId, formId, values) {
        const apiUrl = `${this.getBasePath(appName)}/form/v1/forms/${formId}/save`;
        const saveFormRepresentation = {
            values,
            taskId,
            processInstanceId
        };
        return this.post(apiUrl, saveFormRepresentation).pipe(map((res) => res.entry));
    }
    createTemporaryRawRelatedContent(file, nodeId, contentHost) {
        const changedConfig = this.apiService.lastConfig;
        changedConfig.provider = 'ALL';
        changedConfig.hostEcm = contentHost.replace('/alfresco', '');
        this.apiService.getInstance().setConfig(changedConfig);
        return from(this.uploadApi.uploadFile(file, '', nodeId, '', { overwrite: true })).pipe(map((res) => res.entry));
    }
    completeTaskForm(appName, taskId, processInstanceId, formId, formValues, outcome, version) {
        const apiUrl = `${this.getBasePath(appName)}/form/v1/forms/${formId}/submit/versions/${version}`;
        const completeFormRepresentation = {
            values: formValues,
            taskId: taskId,
            processInstanceId: processInstanceId
        };
        if (outcome) {
            completeFormRepresentation.outcome = outcome;
        }
        return this.post(apiUrl, completeFormRepresentation).pipe(map((res) => res.entry));
    }
    getTask(appName, taskId) {
        const apiUrl = `${this.getBasePath(appName)}/query/v1/tasks/${taskId}`;
        return this.get(apiUrl).pipe(map((res) => res.entry));
    }
    getTaskVariables(appName, taskId) {
        const apiUrl = `${this.getBasePath(appName)}/query/v1/tasks/${taskId}/variables`;
        return this.get(apiUrl).pipe(map((res) => {
            return res.list.entries.map((variable) => new TaskVariableCloud(variable.entry));
        }));
    }
    getForm(appName, formKey, version) {
        let url = `${this.getBasePath(appName)}/form/v1/forms/${formKey}`;
        if (version) {
            url += `/versions/${version}`;
        }
        return this.get(url);
    }
    getRestWidgetData(formName, widgetId, body = {}) {
        var _a;
        const appName = (_a = this.appConfigService.get('alfresco-deployed-apps')[0]) === null || _a === void 0 ? void 0 : _a.name;
        const apiUrl = `${this.getBasePath(appName)}/form/v1/forms/${formName}/values/${widgetId}`;
        return this.post(apiUrl, body);
    }
    parseForm(json, data, readOnly = false) {
        if (json) {
            const flattenForm = Object.assign(Object.assign({}, json.formRepresentation), json.formRepresentation.formDefinition);
            delete flattenForm.formDefinition;
            const formValues = {};
            (data || []).forEach(variable => {
                formValues[variable.name] = variable.value;
            });
            const form = new FormModel(flattenForm, formValues, readOnly);
            if (!json.fields) {
                form.outcomes = [
                    new FormOutcomeModel(form, {
                        id: '$save',
                        name: FormOutcomeModel.SAVE_ACTION,
                        isSystem: true
                    })
                ];
            }
            return form;
        }
        return null;
    }
}
FormCloudService.ɵfac = function FormCloudService_Factory(t) { return new (t || FormCloudService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc1.AppConfigService)); };
FormCloudService.ɵprov = i0.ɵɵdefineInjectable({ factory: function FormCloudService_Factory() { return new FormCloudService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i1.AppConfigService)); }, token: FormCloudService, providedIn: "root" });
FormCloudService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: AppConfigService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(FormCloudService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc1.AppConfigService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1jbG91ZC5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvcHJvY2Vzcy1zZXJ2aWNlcy1jbG91ZC9zcmMvbGliL2Zvcm0vc2VydmljZXMvZm9ybS1jbG91ZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFDSCxrQkFBa0IsRUFFbEIsZ0JBQWdCLEVBQ2hCLGdCQUFnQixFQUNoQixTQUFTLEVBRVosTUFBTSxvQkFBb0IsQ0FBQztBQUM1QixPQUFPLEVBQWMsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFaEQsT0FBTyxFQUE4QixTQUFTLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUN4RSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNyRTtBQUFxQzs7O0FBTXJDLE1BQU0sT0FBTyxnQkFBaUIsU0FBUSxnQkFBZ0I7QUFBRyxJQVFyRCxZQUNJLFVBQThCLEVBQzlCLGdCQUFrQztBQUN2QyxRQUNLLEtBQUssQ0FBQyxVQUFVLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztBQUM1QyxJQUFJLENBQUM7QUFDTCxJQVhJLElBQUksU0FBUztBQUFLO0FBQ2pCLFFBQUcsSUFBSSxDQUFDLFVBQVUsU0FBRyxJQUFJLENBQUMsVUFBVSxtQ0FBSSxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7QUFDMUYsUUFBUSxPQUFPLElBQUksQ0FBQyxV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LEVBQUUsQ0FBQztBQUM5QyxZQUFZLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRTtBQUM1QyxnQkFBZ0IsVUFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDO0FBQzNELFlBQVksQ0FBQyxDQUFDLENBQUM7QUFDZixZQUNZLE1BQU0sSUFBSSxHQUFHLElBQUksU0FBUyxDQUFDLFdBQVcsRUFBRSxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFDMUUsWUFBWSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtBQUM5QixnQkFBZ0IsSUFBSSxDQUFDLFFBQVEsR0FBRztBQUNoQyxvQkFBb0IsSUFBSSxnQkFBZ0IsQ0FBTyxJQUFJLEVBQUU7QUFDckQsd0JBQXdCLEVBQUUsRUFBRSxPQUFPO0FBQ25DLHdCQUF3QixJQUFJLEVBQUUsZ0JBQWdCLENBQUMsV0FBVztBQUMxRCx3QkFBd0IsUUFBUSxFQUFFLElBQUk7QUFDdEMscUJBQXFCLENBQUM7QUFDdEIsaUJBQWlCLENBQUM7QUFDbEIsYUFBYTtBQUNiLFlBQVksT0FBTyxJQUFJLENBQUM7QUFDeEIsU0FBUztBQUNULFFBQVEsT0FBTyxJQUFJLENBQUM7QUFDcEIsSUFBSSxDQUFDO0FBQ0w7MkxBQUM7QUFDRCxxUEFyTUs7QUFBQztFQUhMLFVBQVUsU0FBQyxyQkFHb0MsWUFuQjVDLGtCQUFrQjtLQWlCbEIsVUFBVSxFQUFFLE1BQU0sdkJBaEJwQixZQUNFLGdCQUFnQjtBQUNuQjtHQWVBOzs7OztzSEFmRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgICBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgRm9ybVZhbHVlcyxcbiAgICBBcHBDb25maWdTZXJ2aWNlLFxuICAgIEZvcm1PdXRjb21lTW9kZWwsXG4gICAgRm9ybU1vZGVsLFxuICAgIEZvcm1GaWVsZE9wdGlvblxufSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBUYXNrRGV0YWlsc0Nsb3VkTW9kZWwgfSBmcm9tICcuLi8uLi90YXNrL3N0YXJ0LXRhc2svbW9kZWxzL3Rhc2stZGV0YWlscy1jbG91ZC5tb2RlbCc7XG5pbXBvcnQgeyBDb21wbGV0ZUZvcm1SZXByZXNlbnRhdGlvbiwgVXBsb2FkQXBpIH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBUYXNrVmFyaWFibGVDbG91ZCB9IGZyb20gJy4uL21vZGVscy90YXNrLXZhcmlhYmxlLWNsb3VkLm1vZGVsJztcbmltcG9ydCB7IEJhc2VDbG91ZFNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9iYXNlLWNsb3VkLnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9ybUNvbnRlbnQgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9mb3JtLWZpZWxkcy5pbnRlcmZhY2VzJztcbmltcG9ydCB7IEZvcm1DbG91ZFNlcnZpY2VJbnRlcmZhY2UgfSBmcm9tICcuL2Zvcm0tY2xvdWQuc2VydmljZS5pbnRlcmZhY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEZvcm1DbG91ZFNlcnZpY2UgZXh0ZW5kcyBCYXNlQ2xvdWRTZXJ2aWNlIGltcGxlbWVudHMgRm9ybUNsb3VkU2VydmljZUludGVyZmFjZSB7XG5cbiAgICBwcml2YXRlIF91cGxvYWRBcGk7XG4gICAgZ2V0IHVwbG9hZEFwaSgpOiBVcGxvYWRBcGkge1xuICAgICAgICB0aGlzLl91cGxvYWRBcGkgPSB0aGlzLl91cGxvYWRBcGkgPz8gbmV3IFVwbG9hZEFwaSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl91cGxvYWRBcGk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIGFwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICAgICAgYXBwQ29uZmlnU2VydmljZTogQXBwQ29uZmlnU2VydmljZVxuICAgICkge1xuICAgICAgICBzdXBlcihhcGlTZXJ2aWNlLCBhcHBDb25maWdTZXJ2aWNlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBmb3JtIGRlZmluaXRpb24gb2YgYSB0YXNrLlxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIGFwcFxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHBhcmFtIHZlcnNpb24gVmVyc2lvbiBvZiB0aGUgZm9ybVxuICAgICAqIEByZXR1cm5zIEZvcm0gZGVmaW5pdGlvblxuICAgICAqL1xuICAgIGdldFRhc2tGb3JtKGFwcE5hbWU6IHN0cmluZywgdGFza0lkOiBzdHJpbmcsIHZlcnNpb24/OiBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRUYXNrKGFwcE5hbWUsIHRhc2tJZCkucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCh0YXNrID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRGb3JtKGFwcE5hbWUsIHRhc2suZm9ybUtleSwgdmVyc2lvbikucGlwZShcbiAgICAgICAgICAgICAgICAgICAgbWFwKChmb3JtOiBGb3JtQ29udGVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmxhdHRlbkZvcm0gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4uZm9ybS5mb3JtUmVwcmVzZW50YXRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4uZm9ybS5mb3JtUmVwcmVzZW50YXRpb24uZm9ybURlZmluaXRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza0lkOiB0YXNrLmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tOYW1lOiB0YXNrLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc0RlZmluaXRpb25JZDogdGFzay5wcm9jZXNzRGVmaW5pdGlvbklkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NJbnN0YW5jZUlkOiB0YXNrLnByb2Nlc3NJbnN0YW5jZUlkXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGZsYXR0ZW5Gb3JtLmZvcm1EZWZpbml0aW9uO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZsYXR0ZW5Gb3JtO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNhdmVzIGEgdGFzayBmb3JtLlxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIGFwcFxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHBhcmFtIHByb2Nlc3NJbnN0YW5jZUlkIElEIG9mIHByb2Nlc3NJbnN0YW5jZVxuICAgICAqIEBwYXJhbSBmb3JtSWQgSUQgb2YgdGhlIGZvcm0gdG8gc2F2ZVxuICAgICAqIEBwYXJhbSB2YWx1ZXMgRm9ybSB2YWx1ZXMgb2JqZWN0XG4gICAgICogQHJldHVybnMgVXBkYXRlZCB0YXNrIGRldGFpbHNcbiAgICAgKi9cbiAgICBzYXZlVGFza0Zvcm0oYXBwTmFtZTogc3RyaW5nLCB0YXNrSWQ6IHN0cmluZywgcHJvY2Vzc0luc3RhbmNlSWQ6IHN0cmluZywgZm9ybUlkOiBzdHJpbmcsIHZhbHVlczogRm9ybVZhbHVlcyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNDbG91ZE1vZGVsPiB7XG4gICAgICAgIGNvbnN0IGFwaVVybCA9IGAke3RoaXMuZ2V0QmFzZVBhdGgoYXBwTmFtZSl9L2Zvcm0vdjEvZm9ybXMvJHtmb3JtSWR9L3NhdmVgO1xuICAgICAgICBjb25zdCBzYXZlRm9ybVJlcHJlc2VudGF0aW9uOiBhbnkgPSB7XG4gICAgICAgICAgICB2YWx1ZXMsXG4gICAgICAgICAgICB0YXNrSWQsXG4gICAgICAgICAgICBwcm9jZXNzSW5zdGFuY2VJZFxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiB0aGlzLnBvc3QoYXBpVXJsLCBzYXZlRm9ybVJlcHJlc2VudGF0aW9uKS5waXBlKFxuICAgICAgICAgICAgbWFwKChyZXM6IGFueSkgPT4gcmVzLmVudHJ5KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIGNyZWF0ZVRlbXBvcmFyeVJhd1JlbGF0ZWRDb250ZW50KGZpbGU6IGFueSwgbm9kZUlkOiBzdHJpbmcsIGNvbnRlbnRIb3N0OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuXG4gICAgICAgIGNvbnN0IGNoYW5nZWRDb25maWcgPSB0aGlzLmFwaVNlcnZpY2UubGFzdENvbmZpZztcbiAgICAgICAgY2hhbmdlZENvbmZpZy5wcm92aWRlciA9ICdBTEwnO1xuICAgICAgICBjaGFuZ2VkQ29uZmlnLmhvc3RFY20gPSBjb250ZW50SG9zdC5yZXBsYWNlKCcvYWxmcmVzY28nLCAnJyk7XG4gICAgICAgIHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLnNldENvbmZpZyhjaGFuZ2VkQ29uZmlnKTtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy51cGxvYWRBcGkudXBsb2FkRmlsZShcbiAgICAgICAgICAgIGZpbGUsXG4gICAgICAgICAgICAnJyxcbiAgICAgICAgICAgIG5vZGVJZCxcbiAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgeyBvdmVyd3JpdGU6IHRydWUgfVxuICAgICAgICApKS5waXBlKFxuICAgICAgICAgICAgbWFwKChyZXM6IGFueSkgPT4gcmVzLmVudHJ5KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENvbXBsZXRlcyBhIHRhc2sgZm9ybS5cbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSBhcHBcbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXJnZXQgdGFza1xuICAgICAqIEBwYXJhbSBwcm9jZXNzSW5zdGFuY2VJZCBJRCBvZiBwcm9jZXNzSW5zdGFuY2VcbiAgICAgKiBAcGFyYW0gZm9ybUlkIElEIG9mIHRoZSBmb3JtIHRvIGNvbXBsZXRlXG4gICAgICogQHBhcmFtIGZvcm1WYWx1ZXMgRm9ybSB2YWx1ZXMgb2JqZWN0XG4gICAgICogQHBhcmFtIG91dGNvbWUgRm9ybSBvdXRjb21lXG4gICAgICogQHBhcmFtIHZlcnNpb24gb2YgdGhlIGZvcm1cbiAgICAgKiBAcmV0dXJucyBVcGRhdGVkIHRhc2sgZGV0YWlsc1xuICAgICAqL1xuICAgIGNvbXBsZXRlVGFza0Zvcm0oYXBwTmFtZTogc3RyaW5nLCB0YXNrSWQ6IHN0cmluZywgcHJvY2Vzc0luc3RhbmNlSWQ6IHN0cmluZywgZm9ybUlkOiBzdHJpbmcsIGZvcm1WYWx1ZXM6IEZvcm1WYWx1ZXMsIG91dGNvbWU6IHN0cmluZywgdmVyc2lvbjogbnVtYmVyKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc0Nsb3VkTW9kZWw+IHtcbiAgICAgICAgY29uc3QgYXBpVXJsID0gYCR7dGhpcy5nZXRCYXNlUGF0aChhcHBOYW1lKX0vZm9ybS92MS9mb3Jtcy8ke2Zvcm1JZH0vc3VibWl0L3ZlcnNpb25zLyR7dmVyc2lvbn1gO1xuICAgICAgICBjb25zdCBjb21wbGV0ZUZvcm1SZXByZXNlbnRhdGlvbiA9IDxDb21wbGV0ZUZvcm1SZXByZXNlbnRhdGlvbj4ge1xuICAgICAgICAgICAgdmFsdWVzOiBmb3JtVmFsdWVzLFxuICAgICAgICAgICAgdGFza0lkOiB0YXNrSWQsXG4gICAgICAgICAgICBwcm9jZXNzSW5zdGFuY2VJZDogcHJvY2Vzc0luc3RhbmNlSWRcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKG91dGNvbWUpIHtcbiAgICAgICAgICAgIGNvbXBsZXRlRm9ybVJlcHJlc2VudGF0aW9uLm91dGNvbWUgPSBvdXRjb21lO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMucG9zdChhcGlVcmwsIGNvbXBsZXRlRm9ybVJlcHJlc2VudGF0aW9uKS5waXBlKFxuICAgICAgICAgICAgbWFwKChyZXM6IGFueSkgPT4gcmVzLmVudHJ5KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgZGV0YWlscyBvZiBhIHRhc2tcbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSBhcHBcbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXJnZXQgdGFza1xuICAgICAqIEByZXR1cm5zIERldGFpbHMgb2YgdGhlIHRhc2tcbiAgICAgKi9cbiAgICBnZXRUYXNrKGFwcE5hbWU6IHN0cmluZywgdGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzQ2xvdWRNb2RlbD4ge1xuICAgICAgICBjb25zdCBhcGlVcmwgPSBgJHt0aGlzLmdldEJhc2VQYXRoKGFwcE5hbWUpfS9xdWVyeS92MS90YXNrcy8ke3Rhc2tJZH1gO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmdldChhcGlVcmwpLnBpcGUoXG4gICAgICAgICAgICBtYXAoKHJlczogYW55KSA9PiByZXMuZW50cnkpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgdmFyaWFibGVzIG9mIGEgdGFzay5cbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSBhcHBcbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXJnZXQgdGFza1xuICAgICAqIEByZXR1cm5zIFRhc2sgdmFyaWFibGVzXG4gICAgICovXG4gICAgZ2V0VGFza1ZhcmlhYmxlcyhhcHBOYW1lOiBzdHJpbmcsIHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrVmFyaWFibGVDbG91ZFtdPiB7XG4gICAgICAgIGNvbnN0IGFwaVVybCA9IGAke3RoaXMuZ2V0QmFzZVBhdGgoYXBwTmFtZSl9L3F1ZXJ5L3YxL3Rhc2tzLyR7dGFza0lkfS92YXJpYWJsZXNgO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmdldChhcGlVcmwpLnBpcGUoXG4gICAgICAgICAgICBtYXAoKHJlczogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5saXN0LmVudHJpZXMubWFwKCh2YXJpYWJsZSkgPT4gbmV3IFRhc2tWYXJpYWJsZUNsb3VkKHZhcmlhYmxlLmVudHJ5KSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSBmb3JtIGRlZmluaXRpb24uXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgYXBwXG4gICAgICogQHBhcmFtIGZvcm1LZXkga2V5IG9mIHRoZSB0YXJnZXQgdGFza1xuICAgICAqIEBwYXJhbSB2ZXJzaW9uIFZlcnNpb24gb2YgdGhlIGZvcm1cbiAgICAgKiBAcmV0dXJucyBGb3JtIGRlZmluaXRpb25cbiAgICAgKi9cbiAgICBnZXRGb3JtKGFwcE5hbWU6IHN0cmluZywgZm9ybUtleTogc3RyaW5nLCB2ZXJzaW9uPzogbnVtYmVyKTogT2JzZXJ2YWJsZTxGb3JtQ29udGVudD4ge1xuICAgICAgICBsZXQgdXJsID0gYCR7dGhpcy5nZXRCYXNlUGF0aChhcHBOYW1lKX0vZm9ybS92MS9mb3Jtcy8ke2Zvcm1LZXl9YDtcblxuICAgICAgICBpZiAodmVyc2lvbikge1xuICAgICAgICAgICAgdXJsICs9IGAvdmVyc2lvbnMvJHt2ZXJzaW9ufWA7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5nZXQodXJsKTtcbiAgICB9XG5cbiAgICBnZXRSZXN0V2lkZ2V0RGF0YShmb3JtTmFtZTogc3RyaW5nLCB3aWRnZXRJZDogc3RyaW5nLCBib2R5OiBhbnkgPSB7fSk6IE9ic2VydmFibGU8Rm9ybUZpZWxkT3B0aW9uW10+IHtcbiAgICAgICAgY29uc3QgYXBwTmFtZSA9IHRoaXMuYXBwQ29uZmlnU2VydmljZS5nZXQoJ2FsZnJlc2NvLWRlcGxveWVkLWFwcHMnKVswXT8ubmFtZTtcbiAgICAgICAgY29uc3QgYXBpVXJsID0gYCR7dGhpcy5nZXRCYXNlUGF0aChhcHBOYW1lKX0vZm9ybS92MS9mb3Jtcy8ke2Zvcm1OYW1lfS92YWx1ZXMvJHt3aWRnZXRJZH1gO1xuICAgICAgICByZXR1cm4gdGhpcy5wb3N0KGFwaVVybCwgYm9keSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGFyc2VzIEpTT04gZGF0YSB0byBjcmVhdGUgYSBjb3JyZXNwb25kaW5nIGZvcm0uXG4gICAgICogQHBhcmFtIGpzb24gSlNPTiBkYXRhIHRvIGNyZWF0ZSB0aGUgZm9ybVxuICAgICAqIEBwYXJhbSBkYXRhIFZhbHVlcyBmb3IgdGhlIGZvcm0ncyBmaWVsZHNcbiAgICAgKiBAcGFyYW0gcmVhZE9ubHkgVG9nZ2xlcyB3aGV0aGVyIG9yIG5vdCB0aGUgZm9ybSBzaG91bGQgYmUgcmVhZC1vbmx5XG4gICAgICogQHJldHVybnMgRm9ybSBjcmVhdGVkIGZyb20gdGhlIEpTT04gc3BlY2lmaWNhdGlvblxuICAgICAqL1xuICAgIHBhcnNlRm9ybShqc29uOiBhbnksIGRhdGE/OiBUYXNrVmFyaWFibGVDbG91ZFtdLCByZWFkT25seTogYm9vbGVhbiA9IGZhbHNlKTogRm9ybU1vZGVsIHtcbiAgICAgICAgaWYgKGpzb24pIHtcbiAgICAgICAgICAgIGNvbnN0IGZsYXR0ZW5Gb3JtID0ge1xuICAgICAgICAgICAgICAgIC4uLmpzb24uZm9ybVJlcHJlc2VudGF0aW9uLFxuICAgICAgICAgICAgICAgIC4uLmpzb24uZm9ybVJlcHJlc2VudGF0aW9uLmZvcm1EZWZpbml0aW9uXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgZGVsZXRlIGZsYXR0ZW5Gb3JtLmZvcm1EZWZpbml0aW9uO1xuXG4gICAgICAgICAgICBjb25zdCBmb3JtVmFsdWVzOiBGb3JtVmFsdWVzID0ge307XG4gICAgICAgICAgICAoZGF0YSB8fCBbXSkuZm9yRWFjaCh2YXJpYWJsZSA9PiB7XG4gICAgICAgICAgICAgICAgZm9ybVZhbHVlc1t2YXJpYWJsZS5uYW1lXSA9IHZhcmlhYmxlLnZhbHVlO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGZvcm0gPSBuZXcgRm9ybU1vZGVsKGZsYXR0ZW5Gb3JtLCBmb3JtVmFsdWVzLCByZWFkT25seSk7XG4gICAgICAgICAgICBpZiAoIWpzb24uZmllbGRzKSB7XG4gICAgICAgICAgICAgICAgZm9ybS5vdXRjb21lcyA9IFtcbiAgICAgICAgICAgICAgICAgICAgbmV3IEZvcm1PdXRjb21lTW9kZWwoPGFueT4gZm9ybSwge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICckc2F2ZScsXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBGb3JtT3V0Y29tZU1vZGVsLlNBVkVfQUNUSU9OLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNTeXN0ZW06IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGZvcm07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxufVxuIl19