import { Injectable } from '@angular/core';
import { AlfrescoApiService, AppConfigService, FormOutcomeModel, FormModel } from '@alfresco/adf-core';
import { from } from 'rxjs';
import { map, switchMap } from 'rxjs/operators';
import { UploadApi } from '@alfresco/js-api';
import { TaskVariableCloud } from '../models/task-variable-cloud.model';
import { BaseCloudService } from '../../services/base-cloud.service';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
export class FormCloudService extends BaseCloudService {
    constructor(apiService, appConfigService) {
        super(apiService, appConfigService);
    }
    get uploadApi() {
        var _a;
        this._uploadApi = (_a = this._uploadApi) !== null && _a !== void 0 ? _a : new UploadApi(this.apiService.getInstance());
        return this._uploadApi;
    }
    getTaskForm(appName, taskId, version) {
        return this.getTask(appName, taskId).pipe(switchMap(task => {
            return this.getForm(appName, task.formKey, version).pipe(map((form) => {
                const flattenForm = Object.assign(Object.assign(Object.assign({}, form.formRepresentation), form.formRepresentation.formDefinition), { taskId: task.id, taskName: task.name, processDefinitionId: task.processDefinitionId, processInstanceId: task.processInstanceId });
                delete flattenForm.formDefinition;
                return flattenForm;
            }));
        }));
    }
    saveTaskForm(appName, taskId, processInstanceId, formId, values) {
        const apiUrl = `${this.getBasePath(appName)}/form/v1/forms/${formId}/save`;
        const saveFormRepresentation = {
            values,
            taskId,
            processInstanceId
        };
        return this.post(apiUrl, saveFormRepresentation).pipe(map((res) => res.entry));
    }
    createTemporaryRawRelatedContent(file, nodeId, contentHost) {
        const changedConfig = this.apiService.lastConfig;
        changedConfig.provider = 'ALL';
        changedConfig.hostEcm = contentHost.replace('/alfresco', '');
        this.apiService.getInstance().setConfig(changedConfig);
        return from(this.uploadApi.uploadFile(file, '', nodeId, '', { overwrite: true })).pipe(map((res) => res.entry));
    }
    completeTaskForm(appName, taskId, processInstanceId, formId, formValues, outcome, version) {
        const apiUrl = `${this.getBasePath(appName)}/form/v1/forms/${formId}/submit/versions/${version}`;
        const completeFormRepresentation = {
            values: formValues,
            taskId: taskId,
            processInstanceId: processInstanceId
        };
        if (outcome) {
            completeFormRepresentation.outcome = outcome;
        }
        return this.post(apiUrl, completeFormRepresentation).pipe(map((res) => res.entry));
    }
    getTask(appName, taskId) {
        const apiUrl = `${this.getBasePath(appName)}/query/v1/tasks/${taskId}`;
        return this.get(apiUrl).pipe(map((res) => res.entry));
    }
    getTaskVariables(appName, taskId) {
        const apiUrl = `${this.getBasePath(appName)}/query/v1/tasks/${taskId}/variables`;
        return this.get(apiUrl).pipe(map((res) => {
            return res.list.entries.map((variable) => new TaskVariableCloud(variable.entry));
        }));
    }
    getForm(appName, formKey, version) {
        let url = `${this.getBasePath(appName)}/form/v1/forms/${formKey}`;
        if (version) {
            url += `/versions/${version}`;
        }
        return this.get(url);
    }
    getRestWidgetData(formName, widgetId, body = {}) {
        var _a;
        const appName = (_a = this.appConfigService.get('alfresco-deployed-apps')[0]) === null || _a === void 0 ? void 0 : _a.name;
        const apiUrl = `${this.getBasePath(appName)}/form/v1/forms/${formName}/values/${widgetId}`;
        return this.post(apiUrl, body);
    }
    parseForm(json, data, readOnly = false) {
        if (json) {
            const flattenForm = Object.assign(Object.assign({}, json.formRepresentation), json.formRepresentation.formDefinition);
            delete flattenForm.formDefinition;
            const formValues = {};
            (data || []).forEach(variable => {
                formValues[variable.name] = variable.value;
            });
            const form = new FormModel(flattenForm, formValues, readOnly);
            if (!json.fields) {
                form.outcomes = [
                    new FormOutcomeModel(form, {
                        id: '$save',
                        name: FormOutcomeModel.SAVE_ACTION,
                        isSystem: true
                    })
                ];
            }
            return form;
        }
        return null;
    }
}
FormCloudService.ɵprov = i0.ɵɵdefineInjectable({ factory: function FormCloudService_Factory() { return new FormCloudService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i1.AppConfigService)); }, token: FormCloudService, providedIn: "root" });
FormCloudService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
FormCloudService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: AppConfigService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1jbG91ZC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvcHJvY2Vzcy1zZXJ2aWNlcy1jbG91ZC9zcmMvIiwic291cmNlcyI6WyJsaWIvZm9ybS9zZXJ2aWNlcy9mb3JtLWNsb3VkLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUNILGtCQUFrQixFQUVsQixnQkFBZ0IsRUFDaEIsZ0JBQWdCLEVBQ2hCLFNBQVMsRUFFWixNQUFNLG9CQUFvQixDQUFDO0FBQzVCLE9BQU8sRUFBYyxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDeEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVoRCxPQUFPLEVBQThCLFNBQVMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3pFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG1DQUFtQyxDQUFDOzs7QUFPckUsTUFBTSxPQUFPLGdCQUFpQixTQUFRLGdCQUFnQjtJQVFsRCxZQUNJLFVBQThCLEVBQzlCLGdCQUFrQztRQUVsQyxLQUFLLENBQUMsVUFBVSxFQUFFLGdCQUFnQixDQUFDLENBQUM7SUFDeEMsQ0FBQztJQVZELElBQUksU0FBUzs7UUFDVCxJQUFJLENBQUMsVUFBVSxTQUFHLElBQUksQ0FBQyxVQUFVLG1DQUFJLElBQUksU0FBUyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUNsRixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDM0IsQ0FBQztJQWdCRCxXQUFXLENBQUMsT0FBZSxFQUFFLE1BQWMsRUFBRSxPQUFnQjtRQUN6RCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FDckMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ2IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDcEQsR0FBRyxDQUFDLENBQUMsSUFBaUIsRUFBRSxFQUFFO2dCQUN0QixNQUFNLFdBQVcsaURBQ1YsSUFBSSxDQUFDLGtCQUFrQixHQUN2QixJQUFJLENBQUMsa0JBQWtCLENBQUMsY0FBYyxLQUN6QyxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFDZixRQUFRLEVBQUUsSUFBSSxDQUFDLElBQUksRUFDbkIsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixFQUM3QyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsaUJBQWlCLEdBQzVDLENBQUM7Z0JBQ0YsT0FBTyxXQUFXLENBQUMsY0FBYyxDQUFDO2dCQUNsQyxPQUFPLFdBQVcsQ0FBQztZQUN2QixDQUFDLENBQUMsQ0FDTCxDQUFDO1FBQ04sQ0FBQyxDQUFDLENBQ0wsQ0FBQztJQUNOLENBQUM7SUFXRCxZQUFZLENBQUMsT0FBZSxFQUFFLE1BQWMsRUFBRSxpQkFBeUIsRUFBRSxNQUFjLEVBQUUsTUFBa0I7UUFDdkcsTUFBTSxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsTUFBTSxPQUFPLENBQUM7UUFDM0UsTUFBTSxzQkFBc0IsR0FBUTtZQUNoQyxNQUFNO1lBQ04sTUFBTTtZQUNOLGlCQUFpQjtTQUNwQixDQUFDO1FBRUYsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxzQkFBc0IsQ0FBQyxDQUFDLElBQUksQ0FDakQsR0FBRyxDQUFDLENBQUMsR0FBUSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQy9CLENBQUM7SUFDTixDQUFDO0lBRUQsZ0NBQWdDLENBQUMsSUFBUyxFQUFFLE1BQWMsRUFBRSxXQUFtQjtRQUUzRSxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQztRQUNqRCxhQUFhLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUMvQixhQUFhLENBQUMsT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3ZELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUNqQyxJQUFJLEVBQ0osRUFBRSxFQUNGLE1BQU0sRUFDTixFQUFFLEVBQ0YsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQ3RCLENBQUMsQ0FBQyxJQUFJLENBQ0gsR0FBRyxDQUFDLENBQUMsR0FBUSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQy9CLENBQUM7SUFDTixDQUFDO0lBYUQsZ0JBQWdCLENBQUMsT0FBZSxFQUFFLE1BQWMsRUFBRSxpQkFBeUIsRUFBRSxNQUFjLEVBQUUsVUFBc0IsRUFBRSxPQUFlLEVBQUUsT0FBZTtRQUNqSixNQUFNLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLGtCQUFrQixNQUFNLG9CQUFvQixPQUFPLEVBQUUsQ0FBQztRQUNqRyxNQUFNLDBCQUEwQixHQUFnQztZQUM1RCxNQUFNLEVBQUUsVUFBVTtZQUNsQixNQUFNLEVBQUUsTUFBTTtZQUNkLGlCQUFpQixFQUFFLGlCQUFpQjtTQUN2QyxDQUFDO1FBQ0YsSUFBSSxPQUFPLEVBQUU7WUFDVCwwQkFBMEIsQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1NBQ2hEO1FBRUQsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSwwQkFBMEIsQ0FBQyxDQUFDLElBQUksQ0FDckQsR0FBRyxDQUFDLENBQUMsR0FBUSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQy9CLENBQUM7SUFDTixDQUFDO0lBUUQsT0FBTyxDQUFDLE9BQWUsRUFBRSxNQUFjO1FBQ25DLE1BQU0sTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsbUJBQW1CLE1BQU0sRUFBRSxDQUFDO1FBRXZFLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQ3hCLEdBQUcsQ0FBQyxDQUFDLEdBQVEsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUMvQixDQUFDO0lBQ04sQ0FBQztJQVFELGdCQUFnQixDQUFDLE9BQWUsRUFBRSxNQUFjO1FBQzVDLE1BQU0sTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsbUJBQW1CLE1BQU0sWUFBWSxDQUFDO1FBRWpGLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQ3hCLEdBQUcsQ0FBQyxDQUFDLEdBQVEsRUFBRSxFQUFFO1lBQ2IsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLElBQUksaUJBQWlCLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDckYsQ0FBQyxDQUFDLENBQ0wsQ0FBQztJQUNOLENBQUM7SUFTRCxPQUFPLENBQUMsT0FBZSxFQUFFLE9BQWUsRUFBRSxPQUFnQjtRQUN0RCxJQUFJLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLGtCQUFrQixPQUFPLEVBQUUsQ0FBQztRQUVsRSxJQUFJLE9BQU8sRUFBRTtZQUNULEdBQUcsSUFBSSxhQUFhLE9BQU8sRUFBRSxDQUFDO1NBQ2pDO1FBRUQsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFRCxpQkFBaUIsQ0FBQyxRQUFnQixFQUFFLFFBQWdCLEVBQUUsT0FBWSxFQUFFOztRQUNoRSxNQUFNLE9BQU8sU0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLHdCQUF3QixDQUFDLENBQUMsQ0FBQyxDQUFDLDBDQUFFLElBQUksQ0FBQztRQUM3RSxNQUFNLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLGtCQUFrQixRQUFRLFdBQVcsUUFBUSxFQUFFLENBQUM7UUFDM0YsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBU0QsU0FBUyxDQUFDLElBQVMsRUFBRSxJQUEwQixFQUFFLFdBQW9CLEtBQUs7UUFDdEUsSUFBSSxJQUFJLEVBQUU7WUFDTixNQUFNLFdBQVcsbUNBQ1YsSUFBSSxDQUFDLGtCQUFrQixHQUN2QixJQUFJLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUM1QyxDQUFDO1lBQ0YsT0FBTyxXQUFXLENBQUMsY0FBYyxDQUFDO1lBRWxDLE1BQU0sVUFBVSxHQUFlLEVBQUUsQ0FBQztZQUNsQyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQzVCLFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQztZQUMvQyxDQUFDLENBQUMsQ0FBQztZQUVILE1BQU0sSUFBSSxHQUFHLElBQUksU0FBUyxDQUFDLFdBQVcsRUFBRSxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDOUQsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ2QsSUFBSSxDQUFDLFFBQVEsR0FBRztvQkFDWixJQUFJLGdCQUFnQixDQUFPLElBQUksRUFBRTt3QkFDN0IsRUFBRSxFQUFFLE9BQU87d0JBQ1gsSUFBSSxFQUFFLGdCQUFnQixDQUFDLFdBQVc7d0JBQ2xDLFFBQVEsRUFBRSxJQUFJO3FCQUNqQixDQUFDO2lCQUNMLENBQUM7YUFDTDtZQUNELE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDOzs7O1lBdE1KLFVBQVUsU0FBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQjs7O1lBbEJHLGtCQUFrQjtZQUVsQixnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICAgIEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICBGb3JtVmFsdWVzLFxuICAgIEFwcENvbmZpZ1NlcnZpY2UsXG4gICAgRm9ybU91dGNvbWVNb2RlbCxcbiAgICBGb3JtTW9kZWwsXG4gICAgRm9ybUZpZWxkT3B0aW9uXG59IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBmcm9tIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFRhc2tEZXRhaWxzQ2xvdWRNb2RlbCB9IGZyb20gJy4uLy4uL3Rhc2svc3RhcnQtdGFzay9tb2RlbHMvdGFzay1kZXRhaWxzLWNsb3VkLm1vZGVsJztcbmltcG9ydCB7IENvbXBsZXRlRm9ybVJlcHJlc2VudGF0aW9uLCBVcGxvYWRBcGkgfSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IFRhc2tWYXJpYWJsZUNsb3VkIH0gZnJvbSAnLi4vbW9kZWxzL3Rhc2stdmFyaWFibGUtY2xvdWQubW9kZWwnO1xuaW1wb3J0IHsgQmFzZUNsb3VkU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2Jhc2UtY2xvdWQuc2VydmljZSc7XG5pbXBvcnQgeyBGb3JtQ29udGVudCB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2Zvcm0tZmllbGRzLmludGVyZmFjZXMnO1xuaW1wb3J0IHsgRm9ybUNsb3VkU2VydmljZUludGVyZmFjZSB9IGZyb20gJy4vZm9ybS1jbG91ZC5zZXJ2aWNlLmludGVyZmFjZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgRm9ybUNsb3VkU2VydmljZSBleHRlbmRzIEJhc2VDbG91ZFNlcnZpY2UgaW1wbGVtZW50cyBGb3JtQ2xvdWRTZXJ2aWNlSW50ZXJmYWNlIHtcblxuICAgIHByaXZhdGUgX3VwbG9hZEFwaTtcbiAgICBnZXQgdXBsb2FkQXBpKCk6IFVwbG9hZEFwaSB7XG4gICAgICAgIHRoaXMuX3VwbG9hZEFwaSA9IHRoaXMuX3VwbG9hZEFwaSA/PyBuZXcgVXBsb2FkQXBpKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3VwbG9hZEFwaTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgYXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlLFxuICAgICAgICBhcHBDb25maWdTZXJ2aWNlOiBBcHBDb25maWdTZXJ2aWNlXG4gICAgKSB7XG4gICAgICAgIHN1cGVyKGFwaVNlcnZpY2UsIGFwcENvbmZpZ1NlcnZpY2UpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIGZvcm0gZGVmaW5pdGlvbiBvZiBhIHRhc2suXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgYXBwXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFyZ2V0IHRhc2tcbiAgICAgKiBAcGFyYW0gdmVyc2lvbiBWZXJzaW9uIG9mIHRoZSBmb3JtXG4gICAgICogQHJldHVybnMgRm9ybSBkZWZpbml0aW9uXG4gICAgICovXG4gICAgZ2V0VGFza0Zvcm0oYXBwTmFtZTogc3RyaW5nLCB0YXNrSWQ6IHN0cmluZywgdmVyc2lvbj86IG51bWJlcik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldFRhc2soYXBwTmFtZSwgdGFza0lkKS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKHRhc2sgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEZvcm0oYXBwTmFtZSwgdGFzay5mb3JtS2V5LCB2ZXJzaW9uKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICBtYXAoKGZvcm06IEZvcm1Db250ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmbGF0dGVuRm9ybSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5mb3JtLmZvcm1SZXByZXNlbnRhdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5mb3JtLmZvcm1SZXByZXNlbnRhdGlvbi5mb3JtRGVmaW5pdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrSWQ6IHRhc2suaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFza05hbWU6IHRhc2submFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzRGVmaW5pdGlvbklkOiB0YXNrLnByb2Nlc3NEZWZpbml0aW9uSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc0luc3RhbmNlSWQ6IHRhc2sucHJvY2Vzc0luc3RhbmNlSWRcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZmxhdHRlbkZvcm0uZm9ybURlZmluaXRpb247XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmxhdHRlbkZvcm07XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2F2ZXMgYSB0YXNrIGZvcm0uXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgYXBwXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFyZ2V0IHRhc2tcbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0luc3RhbmNlSWQgSUQgb2YgcHJvY2Vzc0luc3RhbmNlXG4gICAgICogQHBhcmFtIGZvcm1JZCBJRCBvZiB0aGUgZm9ybSB0byBzYXZlXG4gICAgICogQHBhcmFtIHZhbHVlcyBGb3JtIHZhbHVlcyBvYmplY3RcbiAgICAgKiBAcmV0dXJucyBVcGRhdGVkIHRhc2sgZGV0YWlsc1xuICAgICAqL1xuICAgIHNhdmVUYXNrRm9ybShhcHBOYW1lOiBzdHJpbmcsIHRhc2tJZDogc3RyaW5nLCBwcm9jZXNzSW5zdGFuY2VJZDogc3RyaW5nLCBmb3JtSWQ6IHN0cmluZywgdmFsdWVzOiBGb3JtVmFsdWVzKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc0Nsb3VkTW9kZWw+IHtcbiAgICAgICAgY29uc3QgYXBpVXJsID0gYCR7dGhpcy5nZXRCYXNlUGF0aChhcHBOYW1lKX0vZm9ybS92MS9mb3Jtcy8ke2Zvcm1JZH0vc2F2ZWA7XG4gICAgICAgIGNvbnN0IHNhdmVGb3JtUmVwcmVzZW50YXRpb246IGFueSA9IHtcbiAgICAgICAgICAgIHZhbHVlcyxcbiAgICAgICAgICAgIHRhc2tJZCxcbiAgICAgICAgICAgIHByb2Nlc3NJbnN0YW5jZUlkXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIHRoaXMucG9zdChhcGlVcmwsIHNhdmVGb3JtUmVwcmVzZW50YXRpb24pLnBpcGUoXG4gICAgICAgICAgICBtYXAoKHJlczogYW55KSA9PiByZXMuZW50cnkpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgY3JlYXRlVGVtcG9yYXJ5UmF3UmVsYXRlZENvbnRlbnQoZmlsZTogYW55LCBub2RlSWQ6IHN0cmluZywgY29udGVudEhvc3Q6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG5cbiAgICAgICAgY29uc3QgY2hhbmdlZENvbmZpZyA9IHRoaXMuYXBpU2VydmljZS5sYXN0Q29uZmlnO1xuICAgICAgICBjaGFuZ2VkQ29uZmlnLnByb3ZpZGVyID0gJ0FMTCc7XG4gICAgICAgIGNoYW5nZWRDb25maWcuaG9zdEVjbSA9IGNvbnRlbnRIb3N0LnJlcGxhY2UoJy9hbGZyZXNjbycsICcnKTtcbiAgICAgICAgdGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuc2V0Q29uZmlnKGNoYW5nZWRDb25maWcpO1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnVwbG9hZEFwaS51cGxvYWRGaWxlKFxuICAgICAgICAgICAgZmlsZSxcbiAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgbm9kZUlkLFxuICAgICAgICAgICAgJycsXG4gICAgICAgICAgICB7IG92ZXJ3cml0ZTogdHJ1ZSB9XG4gICAgICAgICkpLnBpcGUoXG4gICAgICAgICAgICBtYXAoKHJlczogYW55KSA9PiByZXMuZW50cnkpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ29tcGxldGVzIGEgdGFzayBmb3JtLlxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIGFwcFxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHBhcmFtIHByb2Nlc3NJbnN0YW5jZUlkIElEIG9mIHByb2Nlc3NJbnN0YW5jZVxuICAgICAqIEBwYXJhbSBmb3JtSWQgSUQgb2YgdGhlIGZvcm0gdG8gY29tcGxldGVcbiAgICAgKiBAcGFyYW0gZm9ybVZhbHVlcyBGb3JtIHZhbHVlcyBvYmplY3RcbiAgICAgKiBAcGFyYW0gb3V0Y29tZSBGb3JtIG91dGNvbWVcbiAgICAgKiBAcGFyYW0gdmVyc2lvbiBvZiB0aGUgZm9ybVxuICAgICAqIEByZXR1cm5zIFVwZGF0ZWQgdGFzayBkZXRhaWxzXG4gICAgICovXG4gICAgY29tcGxldGVUYXNrRm9ybShhcHBOYW1lOiBzdHJpbmcsIHRhc2tJZDogc3RyaW5nLCBwcm9jZXNzSW5zdGFuY2VJZDogc3RyaW5nLCBmb3JtSWQ6IHN0cmluZywgZm9ybVZhbHVlczogRm9ybVZhbHVlcywgb3V0Y29tZTogc3RyaW5nLCB2ZXJzaW9uOiBudW1iZXIpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzQ2xvdWRNb2RlbD4ge1xuICAgICAgICBjb25zdCBhcGlVcmwgPSBgJHt0aGlzLmdldEJhc2VQYXRoKGFwcE5hbWUpfS9mb3JtL3YxL2Zvcm1zLyR7Zm9ybUlkfS9zdWJtaXQvdmVyc2lvbnMvJHt2ZXJzaW9ufWA7XG4gICAgICAgIGNvbnN0IGNvbXBsZXRlRm9ybVJlcHJlc2VudGF0aW9uID0gPENvbXBsZXRlRm9ybVJlcHJlc2VudGF0aW9uPiB7XG4gICAgICAgICAgICB2YWx1ZXM6IGZvcm1WYWx1ZXMsXG4gICAgICAgICAgICB0YXNrSWQ6IHRhc2tJZCxcbiAgICAgICAgICAgIHByb2Nlc3NJbnN0YW5jZUlkOiBwcm9jZXNzSW5zdGFuY2VJZFxuICAgICAgICB9O1xuICAgICAgICBpZiAob3V0Y29tZSkge1xuICAgICAgICAgICAgY29tcGxldGVGb3JtUmVwcmVzZW50YXRpb24ub3V0Y29tZSA9IG91dGNvbWU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5wb3N0KGFwaVVybCwgY29tcGxldGVGb3JtUmVwcmVzZW50YXRpb24pLnBpcGUoXG4gICAgICAgICAgICBtYXAoKHJlczogYW55KSA9PiByZXMuZW50cnkpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBkZXRhaWxzIG9mIGEgdGFza1xuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIGFwcFxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHJldHVybnMgRGV0YWlscyBvZiB0aGUgdGFza1xuICAgICAqL1xuICAgIGdldFRhc2soYXBwTmFtZTogc3RyaW5nLCB0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNDbG91ZE1vZGVsPiB7XG4gICAgICAgIGNvbnN0IGFwaVVybCA9IGAke3RoaXMuZ2V0QmFzZVBhdGgoYXBwTmFtZSl9L3F1ZXJ5L3YxL3Rhc2tzLyR7dGFza0lkfWA7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KGFwaVVybCkucGlwZShcbiAgICAgICAgICAgIG1hcCgocmVzOiBhbnkpID0+IHJlcy5lbnRyeSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSB2YXJpYWJsZXMgb2YgYSB0YXNrLlxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIGFwcFxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHJldHVybnMgVGFzayB2YXJpYWJsZXNcbiAgICAgKi9cbiAgICBnZXRUYXNrVmFyaWFibGVzKGFwcE5hbWU6IHN0cmluZywgdGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tWYXJpYWJsZUNsb3VkW10+IHtcbiAgICAgICAgY29uc3QgYXBpVXJsID0gYCR7dGhpcy5nZXRCYXNlUGF0aChhcHBOYW1lKX0vcXVlcnkvdjEvdGFza3MvJHt0YXNrSWR9L3ZhcmlhYmxlc2A7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KGFwaVVybCkucGlwZShcbiAgICAgICAgICAgIG1hcCgocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzLmxpc3QuZW50cmllcy5tYXAoKHZhcmlhYmxlKSA9PiBuZXcgVGFza1ZhcmlhYmxlQ2xvdWQodmFyaWFibGUuZW50cnkpKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhIGZvcm0gZGVmaW5pdGlvbi5cbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSBhcHBcbiAgICAgKiBAcGFyYW0gZm9ybUtleSBrZXkgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHBhcmFtIHZlcnNpb24gVmVyc2lvbiBvZiB0aGUgZm9ybVxuICAgICAqIEByZXR1cm5zIEZvcm0gZGVmaW5pdGlvblxuICAgICAqL1xuICAgIGdldEZvcm0oYXBwTmFtZTogc3RyaW5nLCBmb3JtS2V5OiBzdHJpbmcsIHZlcnNpb24/OiBudW1iZXIpOiBPYnNlcnZhYmxlPEZvcm1Db250ZW50PiB7XG4gICAgICAgIGxldCB1cmwgPSBgJHt0aGlzLmdldEJhc2VQYXRoKGFwcE5hbWUpfS9mb3JtL3YxL2Zvcm1zLyR7Zm9ybUtleX1gO1xuXG4gICAgICAgIGlmICh2ZXJzaW9uKSB7XG4gICAgICAgICAgICB1cmwgKz0gYC92ZXJzaW9ucy8ke3ZlcnNpb259YDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmdldCh1cmwpO1xuICAgIH1cblxuICAgIGdldFJlc3RXaWRnZXREYXRhKGZvcm1OYW1lOiBzdHJpbmcsIHdpZGdldElkOiBzdHJpbmcsIGJvZHk6IGFueSA9IHt9KTogT2JzZXJ2YWJsZTxGb3JtRmllbGRPcHRpb25bXT4ge1xuICAgICAgICBjb25zdCBhcHBOYW1lID0gdGhpcy5hcHBDb25maWdTZXJ2aWNlLmdldCgnYWxmcmVzY28tZGVwbG95ZWQtYXBwcycpWzBdPy5uYW1lO1xuICAgICAgICBjb25zdCBhcGlVcmwgPSBgJHt0aGlzLmdldEJhc2VQYXRoKGFwcE5hbWUpfS9mb3JtL3YxL2Zvcm1zLyR7Zm9ybU5hbWV9L3ZhbHVlcy8ke3dpZGdldElkfWA7XG4gICAgICAgIHJldHVybiB0aGlzLnBvc3QoYXBpVXJsLCBib2R5KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQYXJzZXMgSlNPTiBkYXRhIHRvIGNyZWF0ZSBhIGNvcnJlc3BvbmRpbmcgZm9ybS5cbiAgICAgKiBAcGFyYW0ganNvbiBKU09OIGRhdGEgdG8gY3JlYXRlIHRoZSBmb3JtXG4gICAgICogQHBhcmFtIGRhdGEgVmFsdWVzIGZvciB0aGUgZm9ybSdzIGZpZWxkc1xuICAgICAqIEBwYXJhbSByZWFkT25seSBUb2dnbGVzIHdoZXRoZXIgb3Igbm90IHRoZSBmb3JtIHNob3VsZCBiZSByZWFkLW9ubHlcbiAgICAgKiBAcmV0dXJucyBGb3JtIGNyZWF0ZWQgZnJvbSB0aGUgSlNPTiBzcGVjaWZpY2F0aW9uXG4gICAgICovXG4gICAgcGFyc2VGb3JtKGpzb246IGFueSwgZGF0YT86IFRhc2tWYXJpYWJsZUNsb3VkW10sIHJlYWRPbmx5OiBib29sZWFuID0gZmFsc2UpOiBGb3JtTW9kZWwge1xuICAgICAgICBpZiAoanNvbikge1xuICAgICAgICAgICAgY29uc3QgZmxhdHRlbkZvcm0gPSB7XG4gICAgICAgICAgICAgICAgLi4uanNvbi5mb3JtUmVwcmVzZW50YXRpb24sXG4gICAgICAgICAgICAgICAgLi4uanNvbi5mb3JtUmVwcmVzZW50YXRpb24uZm9ybURlZmluaXRpb25cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBkZWxldGUgZmxhdHRlbkZvcm0uZm9ybURlZmluaXRpb247XG5cbiAgICAgICAgICAgIGNvbnN0IGZvcm1WYWx1ZXM6IEZvcm1WYWx1ZXMgPSB7fTtcbiAgICAgICAgICAgIChkYXRhIHx8IFtdKS5mb3JFYWNoKHZhcmlhYmxlID0+IHtcbiAgICAgICAgICAgICAgICBmb3JtVmFsdWVzW3ZhcmlhYmxlLm5hbWVdID0gdmFyaWFibGUudmFsdWU7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY29uc3QgZm9ybSA9IG5ldyBGb3JtTW9kZWwoZmxhdHRlbkZvcm0sIGZvcm1WYWx1ZXMsIHJlYWRPbmx5KTtcbiAgICAgICAgICAgIGlmICghanNvbi5maWVsZHMpIHtcbiAgICAgICAgICAgICAgICBmb3JtLm91dGNvbWVzID0gW1xuICAgICAgICAgICAgICAgICAgICBuZXcgRm9ybU91dGNvbWVNb2RlbCg8YW55PiBmb3JtLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZDogJyRzYXZlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IEZvcm1PdXRjb21lTW9kZWwuU0FWRV9BQ1RJT04sXG4gICAgICAgICAgICAgICAgICAgICAgICBpc1N5c3RlbTogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZm9ybTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59XG4iXX0=