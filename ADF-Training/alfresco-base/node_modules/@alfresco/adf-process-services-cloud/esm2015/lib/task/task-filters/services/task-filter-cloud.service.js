import { AlfrescoApiService, AppConfigService, IdentityUserService } from '@alfresco/adf-core';
import { Injectable, Inject } from '@angular/core';
import { of, BehaviorSubject, throwError } from 'rxjs';
import { TaskFilterCloudModel } from '../models/filter-cloud.model';
import { switchMap, map } from 'rxjs/operators';
import { BaseCloudService } from '../../../services/base-cloud.service';
import { TASK_FILTERS_SERVICE_TOKEN } from '../../../services/cloud-token.service';
import { NotificationCloudService } from '../../../services/notification-cloud.service';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as i2 from "../../../services/cloud-token.service";
import * as i3 from "../../../services/notification-cloud.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
import * as ɵngcc2 from '../../../services/notification-cloud.service';
const TASK_EVENT_SUBSCRIPTION_QUERY = `
    subscription {
        engineEvents(eventType: [
            TASK_COMPLETED
            TASK_ASSIGNED
            TASK_ACTIVATED
            TASK_SUSPENDED
            TASK_CANCELLED,
            TASK_CREATED
        ]) {
            eventType
            entity
        }
    }
`;
export class TaskFilterCloudService extends BaseCloudService {
    constructor(identityUserService, preferenceService, apiService, appConfigService, notificationCloudService) {
        super(apiService, appConfigService);
        this.identityUserService = identityUserService;
        this.preferenceService = preferenceService;
        this.notificationCloudService = notificationCloudService;
        this.filtersSubject = new BehaviorSubject([]);
        this.filters$ = this.filtersSubject.asObservable();
    }
    createDefaultFilters(appName) {
        const key = this.prepareKey(appName);
        this.preferenceService.getPreferences(appName, key).pipe(switchMap((response) => {
            const preferences = (response && response.list && response.list.entries) ? response.list.entries : [];
            if (!this.hasPreferences(preferences) || !this.hasTaskFilters(preferences, key)) {
                return this.createTaskFilters(appName, key, this.defaultTaskFilters(appName));
            }
            else {
                return of(this.findFiltersByKeyInPreferences(preferences, key));
            }
        })).subscribe((filters) => {
            this.addFiltersToStream(filters);
        });
    }
    hasPreferences(preferences) {
        return preferences && preferences.length > 0;
    }
    hasTaskFilters(preferences, key) {
        const filters = preferences.find((filter) => { return filter.entry.key === key; });
        return (filters && filters.entry) ? JSON.parse(filters.entry.value).length > 0 : false;
    }
    createTaskFilters(appName, key, filters) {
        return this.preferenceService.createPreference(appName, key, filters);
    }
    getTaskFiltersByKey(appName, key) {
        return this.preferenceService.getPreferenceByKey(appName, key);
    }
    getTaskListFilters(appName) {
        this.createDefaultFilters(appName);
        return this.filters$;
    }
    getTaskFilterById(appName, id) {
        const key = this.prepareKey(appName);
        return this.getTaskFiltersByKey(appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length === 0) {
                return this.createTaskFilters(appName, key, this.defaultTaskFilters(appName));
            }
            else {
                return of(filters);
            }
        }), map((filters) => {
            return filters.filter((filter) => {
                return filter.id === id;
            })[0];
        }));
    }
    addFilter(newFilter) {
        const key = this.prepareKey(newFilter.appName);
        return this.getTaskFiltersByKey(newFilter.appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length === 0) {
                return this.createTaskFilters(newFilter.appName, key, [newFilter]);
            }
            else {
                filters.push(newFilter);
                return this.preferenceService.updatePreference(newFilter.appName, key, filters);
            }
        }), map((filters) => {
            this.addFiltersToStream(filters);
            return filters;
        }));
    }
    addFiltersToStream(filters) {
        this.filtersSubject.next(filters);
    }
    updateFilter(updatedFilter) {
        const key = this.prepareKey(updatedFilter.appName);
        return this.getTaskFiltersByKey(updatedFilter.appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length === 0) {
                return this.createTaskFilters(updatedFilter.appName, key, [updatedFilter]);
            }
            else {
                const itemIndex = filters.findIndex((filter) => filter.id === updatedFilter.id);
                filters[itemIndex] = updatedFilter;
                return this.updateTaskFilters(updatedFilter.appName, key, filters);
            }
        }), map((updatedFilters) => {
            this.addFiltersToStream(updatedFilters);
            return updatedFilters;
        }));
    }
    deleteFilter(deletedFilter) {
        const key = this.prepareKey(deletedFilter.appName);
        return this.getTaskFiltersByKey(deletedFilter.appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length > 0) {
                filters = filters.filter(filter => filter.id !== deletedFilter.id);
                return this.updateTaskFilters(deletedFilter.appName, key, filters);
            }
            return of([]);
        }), map(filters => {
            this.addFiltersToStream(filters);
            return filters;
        }));
    }
    isDefaultFilter(filterName) {
        const defaultFilters = this.defaultTaskFilters();
        return defaultFilters.findIndex((filter) => filterName === filter.name) !== -1;
    }
    getTaskFilterCounter(taskFilter) {
        if (taskFilter.appName || taskFilter.appName === '') {
            const queryUrl = `${this.getBasePath(taskFilter.appName)}/query/v1/tasks`;
            const queryParams = {
                assignee: taskFilter.assignee,
                status: taskFilter.status,
                appName: taskFilter.appName,
                maxItems: 1
            };
            return this.get(queryUrl, queryParams).pipe(map((tasks) => tasks.list.pagination.totalItems));
        }
        else {
            return throwError('Appname not configured');
        }
    }
    updateTaskFilters(appName, key, filters) {
        return this.preferenceService.updatePreference(appName, key, filters);
    }
    prepareKey(appName) {
        return `task-filters-${appName}-${this.identityUserService.getCurrentUserInfo().username}`;
    }
    findFiltersByKeyInPreferences(preferences, key) {
        const result = preferences.find((filter) => { return filter.entry.key === key; });
        return result && result.entry ? JSON.parse(result.entry.value) : [];
    }
    defaultTaskFilters(appName) {
        return [
            new TaskFilterCloudModel({
                name: 'ADF_CLOUD_TASK_FILTERS.MY_TASKS',
                key: 'my-tasks',
                icon: 'inbox',
                appName,
                status: 'ASSIGNED',
                assignee: this.identityUserService.getCurrentUserInfo().username,
                sort: 'createdDate',
                order: 'DESC',
                showCounter: true
            }),
            new TaskFilterCloudModel({
                name: 'ADF_CLOUD_TASK_FILTERS.QUEUED_TASKS',
                key: 'queued-tasks',
                icon: 'queue',
                appName,
                status: 'CREATED',
                assignee: '',
                sort: 'createdDate',
                order: 'DESC',
                showCounter: true
            }),
            new TaskFilterCloudModel({
                name: 'ADF_CLOUD_TASK_FILTERS.COMPLETED_TASKS',
                key: 'completed-tasks',
                icon: 'done',
                appName,
                status: 'COMPLETED',
                assignee: '',
                sort: 'createdDate',
                order: 'DESC'
            })
        ];
    }
    getTaskNotificationSubscription(appName) {
        return this.notificationCloudService.makeGQLQuery(appName, TASK_EVENT_SUBSCRIPTION_QUERY)
            .pipe(map((events) => events.data.engineEvents));
    }
}
TaskFilterCloudService.ɵfac = function TaskFilterCloudService_Factory(t) { return new (t || TaskFilterCloudService)(ɵngcc0.ɵɵinject(ɵngcc1.IdentityUserService), ɵngcc0.ɵɵinject(TASK_FILTERS_SERVICE_TOKEN), ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc1.AppConfigService), ɵngcc0.ɵɵinject(ɵngcc2.NotificationCloudService)); };
TaskFilterCloudService.ɵprov = i0.ɵɵdefineInjectable({ factory: function TaskFilterCloudService_Factory() { return new TaskFilterCloudService(i0.ɵɵinject(i1.IdentityUserService), i0.ɵɵinject(i2.TASK_FILTERS_SERVICE_TOKEN), i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i1.AppConfigService), i0.ɵɵinject(i3.NotificationCloudService)); }, token: TaskFilterCloudService, providedIn: "root" });
TaskFilterCloudService.ctorParameters = () => [
    { type: IdentityUserService },
    { type: undefined, decorators: [{ type: Inject, args: [TASK_FILTERS_SERVICE_TOKEN,] }] },
    { type: AlfrescoApiService },
    { type: AppConfigService },
    { type: NotificationCloudService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(TaskFilterCloudService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.IdentityUserService }, { type: undefined, decorators: [{
                type: Inject,
                args: [TASK_FILTERS_SERVICE_TOKEN]
            }] }, { type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc1.AppConfigService }, { type: ɵngcc2.NotificationCloudService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFzay1maWx0ZXItY2xvdWQuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL3Byb2Nlc3Mtc2VydmljZXMtY2xvdWQvc3JjL2xpYi90YXNrL3Rhc2stZmlsdGVycy9zZXJ2aWNlcy90YXNrLWZpbHRlci1jbG91ZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsZ0JBQWdCLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMvRixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQWMsRUFBRSxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbkUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDcEUsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUV4RSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQztBQUVuRixPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw4Q0FBOEMsQ0FBQztBQUN4RjtBQUFxQztBQUEwQztBQUc3RDs7OztBQURsQixNQUFNLDZCQUE2QixHQUFHO0FBQ3RDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsQ0FBQyxDQUFDO0FBS0YsTUFBTSxPQUFPLHNCQUF1QixTQUFRLGdCQUFnQjtBQUM1RCxJQUdJLFlBQ1ksbUJBQXdDLEVBRXpDLGlCQUFrRCxFQUN6RCxVQUE4QixF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QyxnQkFBZ0IsSUFBSSxFQUFFLE1BQU07QUFDNUIsZ0JBQWdCLE9BQU87QUFDdkIsZ0JBQWdCLE1BQU0sRUFBRSxXQUFXO0FBQ25DLGdCQUFnQixRQUFRLEVBQUUsRUFBRTtBQUM1QixnQkFBZ0IsSUFBSSxFQUFFLGFBQWE7QUFDbkMsZ0JBQWdCLEtBQUssRUFBRSxNQUFNO0FBQzdCLGFBQWEsQ0FBQztBQUNkLFNBQVMsQ0FBQztBQUNWLElBQUksQ0FBQztBQUNMLElBQ0ksK0JBQStCLENBQUMsT0FBZTtBQUFJLFFBQy9DLE9BQU8sSUFBSSxDQUFDLHdCQUF3QixDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsNkJBQTZCLENBQUM7QUFDakcsYUFBYSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBVyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7QUFDbEUsSUFBSSxDQUFDO0FBQ0w7eVZBQUM7QUFDRCx3WUF2U0s7QUFBQztFQUhMLFVBQVUsU0FBQyxyQkFHMEMsWUEvQlAsbUJBQW1CO0lBNkI5RCxVQUFVLEVBQUUsTUFBTSxjQUNyQixwQ0E5QnFFLDRDQXFDN0QsTUFBTSxTQUFDLDBCQUEwQjtBQUNuQyxZQXRDRSxrQkFBa0I7QUFBSSxZQUFGLGdCQUFnQjtBQUFJLFlBU3hDLHdCQUF3QjtBQUFHOzs7Ozs7Ozs7cUpBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSwgQXBwQ29uZmlnU2VydmljZSwgSWRlbnRpdHlVc2VyU2VydmljZSB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBCZWhhdmlvclN1YmplY3QsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFRhc2tGaWx0ZXJDbG91ZE1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL2ZpbHRlci1jbG91ZC5tb2RlbCc7XG5pbXBvcnQgeyBzd2l0Y2hNYXAsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEJhc2VDbG91ZFNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9iYXNlLWNsb3VkLnNlcnZpY2UnO1xuaW1wb3J0IHsgUHJlZmVyZW5jZUNsb3VkU2VydmljZUludGVyZmFjZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL3ByZWZlcmVuY2UtY2xvdWQuaW50ZXJmYWNlJztcbmltcG9ydCB7IFRBU0tfRklMVEVSU19TRVJWSUNFX1RPS0VOIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvY2xvdWQtdG9rZW4uc2VydmljZSc7XG5pbXBvcnQgeyBUYXNrQ2xvdWROb2RlUGFnaW5nIH0gZnJvbSAnLi4vLi4vdGFzay1saXN0L21vZGVscy90YXNrLWNsb3VkLm1vZGVsJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvbkNsb3VkU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL25vdGlmaWNhdGlvbi1jbG91ZC5zZXJ2aWNlJztcbmltcG9ydCB7IFRhc2tDbG91ZEVuZ2luZUV2ZW50IH0gZnJvbSAnLi4vLi4vLi4vbW9kZWxzL2VuZ2luZS1ldmVudC1jbG91ZC5tb2RlbCc7XG5cbmNvbnN0IFRBU0tfRVZFTlRfU1VCU0NSSVBUSU9OX1FVRVJZID0gYFxuICAgIHN1YnNjcmlwdGlvbiB7XG4gICAgICAgIGVuZ2luZUV2ZW50cyhldmVudFR5cGU6IFtcbiAgICAgICAgICAgIFRBU0tfQ09NUExFVEVEXG4gICAgICAgICAgICBUQVNLX0FTU0lHTkVEXG4gICAgICAgICAgICBUQVNLX0FDVElWQVRFRFxuICAgICAgICAgICAgVEFTS19TVVNQRU5ERURcbiAgICAgICAgICAgIFRBU0tfQ0FOQ0VMTEVELFxuICAgICAgICAgICAgVEFTS19DUkVBVEVEXG4gICAgICAgIF0pIHtcbiAgICAgICAgICAgIGV2ZW50VHlwZVxuICAgICAgICAgICAgZW50aXR5XG4gICAgICAgIH1cbiAgICB9XG5gO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFRhc2tGaWx0ZXJDbG91ZFNlcnZpY2UgZXh0ZW5kcyBCYXNlQ2xvdWRTZXJ2aWNlIHtcbiAgICBwcml2YXRlIGZpbHRlcnNTdWJqZWN0OiBCZWhhdmlvclN1YmplY3Q8VGFza0ZpbHRlckNsb3VkTW9kZWxbXT47XG4gICAgZmlsdGVycyQ6IE9ic2VydmFibGU8VGFza0ZpbHRlckNsb3VkTW9kZWxbXT47XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBpZGVudGl0eVVzZXJTZXJ2aWNlOiBJZGVudGl0eVVzZXJTZXJ2aWNlLFxuICAgICAgICBASW5qZWN0KFRBU0tfRklMVEVSU19TRVJWSUNFX1RPS0VOKVxuICAgICAgICBwdWJsaWMgcHJlZmVyZW5jZVNlcnZpY2U6IFByZWZlcmVuY2VDbG91ZFNlcnZpY2VJbnRlcmZhY2UsXG4gICAgICAgIGFwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICAgICAgYXBwQ29uZmlnU2VydmljZTogQXBwQ29uZmlnU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBub3RpZmljYXRpb25DbG91ZFNlcnZpY2U6IE5vdGlmaWNhdGlvbkNsb3VkU2VydmljZSkge1xuICAgICAgICBzdXBlcihhcGlTZXJ2aWNlLCBhcHBDb25maWdTZXJ2aWNlKTtcbiAgICAgICAgdGhpcy5maWx0ZXJzU3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3QoW10pO1xuICAgICAgICB0aGlzLmZpbHRlcnMkID0gdGhpcy5maWx0ZXJzU3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGFuZCByZXR1cm5zIHRoZSBkZWZhdWx0IHRhc2sgZmlsdGVycyBmb3IgYW4gYXBwLlxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIG9mIGRlZmF1bHQgZmlsdGVycyB0YXNrIGZpbHRlcnMganVzdCBjcmVhdGVkIG9yIGNyZWF0ZWQgZmlsdGVyc1xuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlRGVmYXVsdEZpbHRlcnMoYXBwTmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGtleTogc3RyaW5nID0gdGhpcy5wcmVwYXJlS2V5KGFwcE5hbWUpO1xuICAgICAgICB0aGlzLnByZWZlcmVuY2VTZXJ2aWNlLmdldFByZWZlcmVuY2VzKGFwcE5hbWUsIGtleSkucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgocmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHByZWZlcmVuY2VzID0gKHJlc3BvbnNlICYmIHJlc3BvbnNlLmxpc3QgJiYgcmVzcG9uc2UubGlzdC5lbnRyaWVzKSA/IHJlc3BvbnNlLmxpc3QuZW50cmllcyA6IFtdO1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy5oYXNQcmVmZXJlbmNlcyhwcmVmZXJlbmNlcykgfHwgIXRoaXMuaGFzVGFza0ZpbHRlcnMocHJlZmVyZW5jZXMsIGtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlVGFza0ZpbHRlcnMoYXBwTmFtZSwga2V5LCB0aGlzLmRlZmF1bHRUYXNrRmlsdGVycyhhcHBOYW1lKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKHRoaXMuZmluZEZpbHRlcnNCeUtleUluUHJlZmVyZW5jZXMocHJlZmVyZW5jZXMsIGtleSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICkuc3Vic2NyaWJlKChmaWx0ZXJzKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmFkZEZpbHRlcnNUb1N0cmVhbShmaWx0ZXJzKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIHVzZXIgcHJlZmVyZW5jZSBhcmUgZW1wdHkgb3Igbm90XG4gICAgICogQHBhcmFtIHByZWZlcmVuY2VzIFVzZXIgcHJlZmVyZW5jZXMgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcmV0dXJucyBCb29sZWFuIHZhbHVlIGlmIHRoZSBwcmVmZXJlbmNlcyBhcmUgbm90IGVtcHR5XG4gICAgICovXG4gICAgcHJpdmF0ZSBoYXNQcmVmZXJlbmNlcyhwcmVmZXJlbmNlczogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBwcmVmZXJlbmNlcyAmJiBwcmVmZXJlbmNlcy5sZW5ndGggPiAwO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBmb3IgdGFzayBmaWx0ZXJzIGluIGdpdmVuIHVzZXIgcHJlZmVyZW5jZXNcbiAgICAgKiBAcGFyYW0gcHJlZmVyZW5jZXMgVXNlciBwcmVmZXJlbmNlcyBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSB0YXNrIGZpbHRlcnNcbiAgICAgKiBAcGFyYW0gZmlsdGVycyBEZXRhaWxzIG9mIGNyZWF0ZSBmaWx0ZXJcbiAgICAgKiBAcmV0dXJucyBCb29sZWFuIHZhbHVlIGlmIHRoZSBwcmVmZXJlbmNlIGhhcyB0YXNrIGZpbHRlcnNcbiAgICAgKi9cbiAgICBwcml2YXRlIGhhc1Rhc2tGaWx0ZXJzKHByZWZlcmVuY2VzOiBhbnksIGtleTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGZpbHRlcnMgPSBwcmVmZXJlbmNlcy5maW5kKChmaWx0ZXI6IGFueSkgPT4geyByZXR1cm4gZmlsdGVyLmVudHJ5LmtleSA9PT0ga2V5OyB9KTtcbiAgICAgICAgcmV0dXJuIChmaWx0ZXJzICYmIGZpbHRlcnMuZW50cnkpID8gSlNPTi5wYXJzZShmaWx0ZXJzLmVudHJ5LnZhbHVlKS5sZW5ndGggPiAwIDogZmFsc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsbHMgY3JlYXRlIHByZWZlcmVuY2UgYXBpIHRvIGNyZWF0ZSB0YXNrIGZpbHRlcnNcbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHBhcmFtIGtleSBLZXkgb2YgdGhlIHRhc2sgaW5zdGFuY2UgZmlsdGVyc1xuICAgICAqIEBwYXJhbSBmaWx0ZXJzIERldGFpbHMgb2YgbmV3IHRhc2sgZmlsdGVyXG4gICAgICogQHJldHVybnMgT2JzZXJ2YWJsZSBvZiBjcmVhdGVkIHRhc2sgZmlsdGVyc1xuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlVGFza0ZpbHRlcnMoYXBwTmFtZTogc3RyaW5nLCBrZXk6IHN0cmluZywgZmlsdGVyczogVGFza0ZpbHRlckNsb3VkTW9kZWxbXSk6IE9ic2VydmFibGU8VGFza0ZpbHRlckNsb3VkTW9kZWxbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcmVmZXJlbmNlU2VydmljZS5jcmVhdGVQcmVmZXJlbmNlKGFwcE5hbWUsIGtleSwgZmlsdGVycyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsbHMgZ2V0IHByZWZlcmVuY2UgYXBpIHRvIGdldCB0YXNrIGZpbHRlciBieSBwcmVmZXJlbmNlIGtleVxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcGFyYW0ga2V5IEtleSBvZiB0aGUgdGFzayBmaWx0ZXJzXG4gICAgICogQHJldHVybnMgT2JzZXJ2YWJsZSBvZiB0YXNrIGZpbHRlcnNcbiAgICAgKi9cbiAgICBwcml2YXRlIGdldFRhc2tGaWx0ZXJzQnlLZXkoYXBwTmFtZTogc3RyaW5nLCBrZXk6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0ZpbHRlckNsb3VkTW9kZWxbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcmVmZXJlbmNlU2VydmljZS5nZXRQcmVmZXJlbmNlQnlLZXkoYXBwTmFtZSwga2V5KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGFsbCB0YXNrIGZpbHRlcnMgZm9yIGEgdGFzayBhcHAuXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGUgb2YgdGFzayBmaWx0ZXIgZGV0YWlsc1xuICAgICAqL1xuICAgIGdldFRhc2tMaXN0RmlsdGVycyhhcHBOYW1lPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdPiB7XG4gICAgICAgIHRoaXMuY3JlYXRlRGVmYXVsdEZpbHRlcnMoYXBwTmFtZSk7XG4gICAgICAgIHJldHVybiB0aGlzLmZpbHRlcnMkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSB0YXNrIGZpbHRlci5cbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHBhcmFtIGlkIElEIG9mIHRoZSB0YXNrXG4gICAgICogQHJldHVybnMgRGV0YWlscyBvZiB0aGUgdGFzayBmaWx0ZXJcbiAgICAgKi9cbiAgICBnZXRUYXNrRmlsdGVyQnlJZChhcHBOYW1lOiBzdHJpbmcsIGlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tGaWx0ZXJDbG91ZE1vZGVsPiB7XG4gICAgICAgIGNvbnN0IGtleTogc3RyaW5nID0gdGhpcy5wcmVwYXJlS2V5KGFwcE5hbWUpO1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRUYXNrRmlsdGVyc0J5S2V5KGFwcE5hbWUsIGtleSkucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoZmlsdGVyczogVGFza0ZpbHRlckNsb3VkTW9kZWxbXSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJzICYmIGZpbHRlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZVRhc2tGaWx0ZXJzKGFwcE5hbWUsIGtleSwgdGhpcy5kZWZhdWx0VGFza0ZpbHRlcnMoYXBwTmFtZSkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihmaWx0ZXJzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIG1hcCgoZmlsdGVyczogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlcnMuZmlsdGVyKChmaWx0ZXI6IFRhc2tGaWx0ZXJDbG91ZE1vZGVsKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXIuaWQgPT09IGlkO1xuICAgICAgICAgICAgICAgIH0pWzBdO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgbmV3IHRhc2sgZmlsdGVyLlxuICAgICAqIEBwYXJhbSBmaWx0ZXIgVGhlIG5ldyBmaWx0ZXIgdG8gYWRkXG4gICAgICogQHJldHVybnMgT2JzZXJ2YWJsZSBvZiB0YXNrIGluc3RhbmNlIGZpbHRlcnMgd2l0aCBuZXdseSBhZGRlZCBmaWx0ZXJcbiAgICAgKi9cbiAgICBhZGRGaWx0ZXIobmV3RmlsdGVyOiBUYXNrRmlsdGVyQ2xvdWRNb2RlbCk6IE9ic2VydmFibGU8VGFza0ZpbHRlckNsb3VkTW9kZWxbXT4ge1xuICAgICAgICBjb25zdCBrZXk6IHN0cmluZyA9IHRoaXMucHJlcGFyZUtleShuZXdGaWx0ZXIuYXBwTmFtZSk7XG4gICAgICAgIHJldHVybiB0aGlzLmdldFRhc2tGaWx0ZXJzQnlLZXkobmV3RmlsdGVyLmFwcE5hbWUsIGtleSkucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoZmlsdGVyczogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGZpbHRlcnMgJiYgZmlsdGVycy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlVGFza0ZpbHRlcnMobmV3RmlsdGVyLmFwcE5hbWUsIGtleSwgPFRhc2tGaWx0ZXJDbG91ZE1vZGVsW10+IFtuZXdGaWx0ZXJdKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmaWx0ZXJzLnB1c2gobmV3RmlsdGVyKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJlZmVyZW5jZVNlcnZpY2UudXBkYXRlUHJlZmVyZW5jZShuZXdGaWx0ZXIuYXBwTmFtZSwga2V5LCBmaWx0ZXJzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIG1hcCgoZmlsdGVyczogVGFza0ZpbHRlckNsb3VkTW9kZWxbXSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkRmlsdGVyc1RvU3RyZWFtKGZpbHRlcnMpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXJzO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFkZEZpbHRlcnNUb1N0cmVhbShmaWx0ZXJzOiBUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdKSB7XG4gICAgICAgIHRoaXMuZmlsdGVyc1N1YmplY3QubmV4dChmaWx0ZXJzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIGEgdGFzayBmaWx0ZXIuXG4gICAgICogQHBhcmFtIGZpbHRlciBUaGUgZmlsdGVyIHRvIHVwZGF0ZVxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGUgb2YgdGFzayBpbnN0YW5jZSBmaWx0ZXJzIHdpdGggdXBkYXRlZCBmaWx0ZXJcbiAgICAgKi9cbiAgICB1cGRhdGVGaWx0ZXIodXBkYXRlZEZpbHRlcjogVGFza0ZpbHRlckNsb3VkTW9kZWwpOiBPYnNlcnZhYmxlPFRhc2tGaWx0ZXJDbG91ZE1vZGVsW10+IHtcbiAgICAgICAgY29uc3Qga2V5OiBzdHJpbmcgPSB0aGlzLnByZXBhcmVLZXkodXBkYXRlZEZpbHRlci5hcHBOYW1lKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VGFza0ZpbHRlcnNCeUtleSh1cGRhdGVkRmlsdGVyLmFwcE5hbWUsIGtleSkucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoZmlsdGVyczogVGFza0ZpbHRlckNsb3VkTW9kZWxbXSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJzICYmIGZpbHRlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZVRhc2tGaWx0ZXJzKHVwZGF0ZWRGaWx0ZXIuYXBwTmFtZSwga2V5LCA8VGFza0ZpbHRlckNsb3VkTW9kZWxbXT4gW3VwZGF0ZWRGaWx0ZXJdKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpdGVtSW5kZXggPSBmaWx0ZXJzLmZpbmRJbmRleCgoZmlsdGVyOiBUYXNrRmlsdGVyQ2xvdWRNb2RlbCkgPT4gZmlsdGVyLmlkID09PSB1cGRhdGVkRmlsdGVyLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyc1tpdGVtSW5kZXhdID0gdXBkYXRlZEZpbHRlcjtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlVGFza0ZpbHRlcnModXBkYXRlZEZpbHRlci5hcHBOYW1lLCBrZXksIGZpbHRlcnMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgbWFwKCh1cGRhdGVkRmlsdGVyczogVGFza0ZpbHRlckNsb3VkTW9kZWxbXSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkRmlsdGVyc1RvU3RyZWFtKHVwZGF0ZWRGaWx0ZXJzKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlZEZpbHRlcnM7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlbGV0ZXMgYSB0YXNrIGZpbHRlclxuICAgICAqIEBwYXJhbSBmaWx0ZXIgVGhlIGZpbHRlciB0byBkZWxldGVcbiAgICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIG9mIHRhc2sgaW5zdGFuY2UgZmlsdGVycyB3aXRob3V0IGRlbGV0ZWQgZmlsdGVyXG4gICAgICovXG4gICAgZGVsZXRlRmlsdGVyKGRlbGV0ZWRGaWx0ZXI6IFRhc2tGaWx0ZXJDbG91ZE1vZGVsKTogT2JzZXJ2YWJsZTxUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdPiB7XG4gICAgICAgIGNvbnN0IGtleSA9IHRoaXMucHJlcGFyZUtleShkZWxldGVkRmlsdGVyLmFwcE5hbWUpO1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRUYXNrRmlsdGVyc0J5S2V5KGRlbGV0ZWRGaWx0ZXIuYXBwTmFtZSwga2V5KS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKChmaWx0ZXJzOiBUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGZpbHRlcnMgJiYgZmlsdGVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGZpbHRlcnMgPSBmaWx0ZXJzLmZpbHRlcihmaWx0ZXIgPT4gZmlsdGVyLmlkICE9PSBkZWxldGVkRmlsdGVyLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlVGFza0ZpbHRlcnMoZGVsZXRlZEZpbHRlci5hcHBOYW1lLCBrZXksIGZpbHRlcnMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gb2YoW10pO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBtYXAoZmlsdGVycyA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hZGRGaWx0ZXJzVG9TdHJlYW0oZmlsdGVycyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlcnM7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBpZiBnaXZlbiBmaWx0ZXIgaXMgYSBkZWZhdWx0IGZpbHRlclxuICAgICAqIEBwYXJhbSBmaWx0ZXJOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCB0YXNrIGZpbHRlclxuICAgICAqIEByZXR1cm5zIEJvb2xlYW4gdmFsdWUgZm9yIHdoZXRoZXIgdGhlIGZpbHRlciBpcyBhIGRlZmF1bHQgZmlsdGVyXG4gICAgICovXG4gICAgaXNEZWZhdWx0RmlsdGVyKGZpbHRlck5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBkZWZhdWx0RmlsdGVycyA9IHRoaXMuZGVmYXVsdFRhc2tGaWx0ZXJzKCk7XG4gICAgICAgIHJldHVybiBkZWZhdWx0RmlsdGVycy5maW5kSW5kZXgoKGZpbHRlcikgPT4gZmlsdGVyTmFtZSA9PT0gZmlsdGVyLm5hbWUpICE9PSAtMTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kcyBhIHRhc2sgdXNpbmcgYW4gb2JqZWN0IHdpdGggb3B0aW9uYWwgcXVlcnkgcHJvcGVydGllcy5cbiAgICAgKiBAcGFyYW0gcmVxdWVzdE5vZGUgUXVlcnkgb2JqZWN0XG4gICAgICogQHJldHVybnMgVGFzayBpbmZvcm1hdGlvblxuICAgICAqL1xuICAgIGdldFRhc2tGaWx0ZXJDb3VudGVyKHRhc2tGaWx0ZXI6IFRhc2tGaWx0ZXJDbG91ZE1vZGVsKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgaWYgKHRhc2tGaWx0ZXIuYXBwTmFtZSB8fCB0YXNrRmlsdGVyLmFwcE5hbWUgPT09ICcnKSB7XG4gICAgICAgICAgICBjb25zdCBxdWVyeVVybCA9IGAke3RoaXMuZ2V0QmFzZVBhdGgodGFza0ZpbHRlci5hcHBOYW1lKX0vcXVlcnkvdjEvdGFza3NgO1xuICAgICAgICAgICAgY29uc3QgcXVlcnlQYXJhbXMgPSB7XG4gICAgICAgICAgICAgICAgYXNzaWduZWU6IHRhc2tGaWx0ZXIuYXNzaWduZWUsXG4gICAgICAgICAgICAgICAgc3RhdHVzOiB0YXNrRmlsdGVyLnN0YXR1cyxcbiAgICAgICAgICAgICAgICBhcHBOYW1lOiB0YXNrRmlsdGVyLmFwcE5hbWUsXG4gICAgICAgICAgICAgICAgbWF4SXRlbXM6IDFcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQ8VGFza0Nsb3VkTm9kZVBhZ2luZz4ocXVlcnlVcmwsIHF1ZXJ5UGFyYW1zKS5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgodGFza3MpID0+IHRhc2tzLmxpc3QucGFnaW5hdGlvbi50b3RhbEl0ZW1zKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdBcHBuYW1lIG5vdCBjb25maWd1cmVkJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxscyB1cGRhdGUgcHJlZmVyZW5jZSBhcGkgdG8gdXBkYXRlIHRhc2sgZmlsdGVyXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSB0YXNrIGZpbHRlcnNcbiAgICAgKiBAcGFyYW0gZmlsdGVycyBEZXRhaWxzIG9mIHVwZGF0ZSBmaWx0ZXJcbiAgICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIG9mIHVwZGF0ZWQgdGFzayBmaWx0ZXJzXG4gICAgICovXG4gICAgcHJpdmF0ZSB1cGRhdGVUYXNrRmlsdGVycyhhcHBOYW1lOiBzdHJpbmcsIGtleTogc3RyaW5nLCBmaWx0ZXJzOiBUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdKTogT2JzZXJ2YWJsZTxUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnByZWZlcmVuY2VTZXJ2aWNlLnVwZGF0ZVByZWZlcmVuY2UoYXBwTmFtZSwga2V5LCBmaWx0ZXJzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGEgdW5pcSBrZXkgd2l0aCBhcHBOYW1lIGFuZCB1c2VybmFtZVxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcmV0dXJucyBTdHJpbmcgb2YgdGFzayBmaWx0ZXJzIHByZWZlcmVuY2Uga2V5XG4gICAgICovXG4gICAgcHJpdmF0ZSBwcmVwYXJlS2V5KGFwcE5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBgdGFzay1maWx0ZXJzLSR7YXBwTmFtZX0tJHt0aGlzLmlkZW50aXR5VXNlclNlcnZpY2UuZ2V0Q3VycmVudFVzZXJJbmZvKCkudXNlcm5hbWV9YDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kcyBhbmQgcmV0dXJucyB0aGUgdGFzayBmaWx0ZXJzIGZyb20gcHJlZmVyZW5jZXNcbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgVGFza0ZpbHRlckNsb3VkTW9kZWxcbiAgICAgKi9cbiAgICBwcml2YXRlIGZpbmRGaWx0ZXJzQnlLZXlJblByZWZlcmVuY2VzKHByZWZlcmVuY2VzOiBhbnksIGtleTogc3RyaW5nKTogVGFza0ZpbHRlckNsb3VkTW9kZWxbXSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHByZWZlcmVuY2VzLmZpbmQoKGZpbHRlcjogYW55KSA9PiB7IHJldHVybiBmaWx0ZXIuZW50cnkua2V5ID09PSBrZXk7IH0pO1xuICAgICAgICByZXR1cm4gcmVzdWx0ICYmIHJlc3VsdC5lbnRyeSA/IEpTT04ucGFyc2UocmVzdWx0LmVudHJ5LnZhbHVlKSA6IFtdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYW5kIHJldHVybnMgdGhlIGRlZmF1bHQgZmlsdGVycyBmb3IgYSB0YXNrIGFwcC5cbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgVGFza0ZpbHRlckNsb3VkTW9kZWxcbiAgICAgKi9cbiAgICBwcml2YXRlIGRlZmF1bHRUYXNrRmlsdGVycyhhcHBOYW1lPzogc3RyaW5nKTogVGFza0ZpbHRlckNsb3VkTW9kZWxbXSB7XG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICBuZXcgVGFza0ZpbHRlckNsb3VkTW9kZWwoe1xuICAgICAgICAgICAgICAgIG5hbWU6ICdBREZfQ0xPVURfVEFTS19GSUxURVJTLk1ZX1RBU0tTJyxcbiAgICAgICAgICAgICAgICBrZXk6ICdteS10YXNrcycsXG4gICAgICAgICAgICAgICAgaWNvbjogJ2luYm94JyxcbiAgICAgICAgICAgICAgICBhcHBOYW1lLFxuICAgICAgICAgICAgICAgIHN0YXR1czogJ0FTU0lHTkVEJyxcbiAgICAgICAgICAgICAgICBhc3NpZ25lZTogdGhpcy5pZGVudGl0eVVzZXJTZXJ2aWNlLmdldEN1cnJlbnRVc2VySW5mbygpLnVzZXJuYW1lLFxuICAgICAgICAgICAgICAgIHNvcnQ6ICdjcmVhdGVkRGF0ZScsXG4gICAgICAgICAgICAgICAgb3JkZXI6ICdERVNDJyxcbiAgICAgICAgICAgICAgICBzaG93Q291bnRlcjogdHJ1ZVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBuZXcgVGFza0ZpbHRlckNsb3VkTW9kZWwoe1xuICAgICAgICAgICAgICAgIG5hbWU6ICdBREZfQ0xPVURfVEFTS19GSUxURVJTLlFVRVVFRF9UQVNLUycsXG4gICAgICAgICAgICAgICAga2V5OiAncXVldWVkLXRhc2tzJyxcbiAgICAgICAgICAgICAgICBpY29uOiAncXVldWUnLFxuICAgICAgICAgICAgICAgIGFwcE5hbWUsXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnQ1JFQVRFRCcsXG4gICAgICAgICAgICAgICAgYXNzaWduZWU6ICcnLFxuICAgICAgICAgICAgICAgIHNvcnQ6ICdjcmVhdGVkRGF0ZScsXG4gICAgICAgICAgICAgICAgb3JkZXI6ICdERVNDJyxcbiAgICAgICAgICAgICAgICBzaG93Q291bnRlcjogdHJ1ZVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBuZXcgVGFza0ZpbHRlckNsb3VkTW9kZWwoe1xuICAgICAgICAgICAgICAgIG5hbWU6ICdBREZfQ0xPVURfVEFTS19GSUxURVJTLkNPTVBMRVRFRF9UQVNLUycsXG4gICAgICAgICAgICAgICAga2V5OiAnY29tcGxldGVkLXRhc2tzJyxcbiAgICAgICAgICAgICAgICBpY29uOiAnZG9uZScsXG4gICAgICAgICAgICAgICAgYXBwTmFtZSxcbiAgICAgICAgICAgICAgICBzdGF0dXM6ICdDT01QTEVURUQnLFxuICAgICAgICAgICAgICAgIGFzc2lnbmVlOiAnJyxcbiAgICAgICAgICAgICAgICBzb3J0OiAnY3JlYXRlZERhdGUnLFxuICAgICAgICAgICAgICAgIG9yZGVyOiAnREVTQydcbiAgICAgICAgICAgIH0pXG4gICAgICAgIF07XG4gICAgfVxuXG4gICAgZ2V0VGFza05vdGlmaWNhdGlvblN1YnNjcmlwdGlvbihhcHBOYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tDbG91ZEVuZ2luZUV2ZW50W10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMubm90aWZpY2F0aW9uQ2xvdWRTZXJ2aWNlLm1ha2VHUUxRdWVyeShhcHBOYW1lLCBUQVNLX0VWRU5UX1NVQlNDUklQVElPTl9RVUVSWSlcbiAgICAgICAgICAgIC5waXBlKG1hcCgoZXZlbnRzOiBhbnkpID0+IGV2ZW50cy5kYXRhLmVuZ2luZUV2ZW50cykpO1xuICAgIH1cbn1cbiJdfQ==