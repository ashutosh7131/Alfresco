import { IdentityUserService } from '@alfresco/adf-core';
import { Injectable, Inject } from '@angular/core';
import { of, BehaviorSubject } from 'rxjs';
import { switchMap, map } from 'rxjs/operators';
import { TASK_FILTERS_SERVICE_TOKEN } from '../../../services/cloud-token.service';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as i2 from "../../../services/cloud-token.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
export class ServiceTaskFilterCloudService {
    constructor(identityUserService, preferenceService) {
        this.identityUserService = identityUserService;
        this.preferenceService = preferenceService;
        this.filtersSubject = new BehaviorSubject([]);
        this.filters$ = this.filtersSubject.asObservable();
    }
    createDefaultFilters(appName) {
        const key = this.prepareKey(appName);
        this.preferenceService.getPreferences(appName, key).pipe(switchMap((response) => {
            const preferences = (response && response.list && response.list.entries) ? response.list.entries : [];
            if (!this.hasPreferences(preferences) || !this.hasTaskFilters(preferences, key)) {
                return this.createTaskFilters(appName, key, this.defaultServiceTaskFilters(appName));
            }
            else {
                return of(this.findFiltersByKeyInPreferences(preferences, key));
            }
        })).subscribe((filters) => {
            this.addFiltersToStream(filters);
        });
    }
    hasPreferences(preferences) {
        return preferences && preferences.length > 0;
    }
    hasTaskFilters(preferences, key) {
        const filters = preferences.find((filter) => { return filter.entry.key === key; });
        return (filters && filters.entry) ? JSON.parse(filters.entry.value).length > 0 : false;
    }
    createTaskFilters(appName, key, filters) {
        return this.preferenceService.createPreference(appName, key, filters);
    }
    getTaskFiltersByKey(appName, key) {
        return this.preferenceService.getPreferenceByKey(appName, key);
    }
    getTaskListFilters(appName) {
        this.createDefaultFilters(appName);
        return this.filters$;
    }
    getTaskFilterById(appName, id) {
        const key = this.prepareKey(appName);
        return this.getTaskFiltersByKey(appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length === 0) {
                return this.createTaskFilters(appName, key, this.defaultServiceTaskFilters(appName));
            }
            else {
                return of(filters);
            }
        }), map((filters) => {
            return filters.filter((filter) => {
                return filter.id === id;
            })[0];
        }));
    }
    addFilter(newFilter) {
        const key = this.prepareKey(newFilter.appName);
        return this.getTaskFiltersByKey(newFilter.appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length === 0) {
                return this.createTaskFilters(newFilter.appName, key, [newFilter]);
            }
            else {
                filters.push(newFilter);
                return this.preferenceService.updatePreference(newFilter.appName, key, filters);
            }
        }), map((filters) => {
            this.addFiltersToStream(filters);
            return filters;
        }));
    }
    addFiltersToStream(filters) {
        this.filtersSubject.next(filters);
    }
    updateFilter(updatedFilter) {
        const key = this.prepareKey(updatedFilter.appName);
        return this.getTaskFiltersByKey(updatedFilter.appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length === 0) {
                return this.createTaskFilters(updatedFilter.appName, key, [updatedFilter]);
            }
            else {
                const itemIndex = filters.findIndex((filter) => filter.id === updatedFilter.id);
                filters[itemIndex] = updatedFilter;
                return this.updateTaskFilters(updatedFilter.appName, key, filters);
            }
        }), map((updatedFilters) => {
            this.addFiltersToStream(updatedFilters);
            return updatedFilters;
        }));
    }
    deleteFilter(deletedFilter) {
        const key = this.prepareKey(deletedFilter.appName);
        return this.getTaskFiltersByKey(deletedFilter.appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length > 0) {
                filters = filters.filter(filter => filter.id !== deletedFilter.id);
                return this.updateTaskFilters(deletedFilter.appName, key, filters);
            }
            return of([]);
        }), map(filters => {
            this.addFiltersToStream(filters);
            return filters;
        }));
    }
    isDefaultFilter(filterName) {
        const defaultFilters = this.defaultServiceTaskFilters();
        return defaultFilters.findIndex((filter) => filterName === filter.name) !== -1;
    }
    updateTaskFilters(appName, key, filters) {
        return this.preferenceService.updatePreference(appName, key, filters);
    }
    prepareKey(appName) {
        return `service-task-filters-${appName}-${this.identityUserService.getCurrentUserInfo().username}`;
    }
    findFiltersByKeyInPreferences(preferences, key) {
        const result = preferences.find((filter) => { return filter.entry.key === key; });
        return result && result.entry ? JSON.parse(result.entry.value) : [];
    }
    defaultServiceTaskFilters(appName) {
        return [
            {
                id: this.generateRandomId(),
                name: 'ADF_CLOUD_SERVICE_TASK_FILTERS.ALL_SERVICE_TASKS',
                key: 'my-service-tasks',
                icon: 'inbox',
                appName,
                status: '',
                sort: 'startedDate',
                order: 'DESC'
            },
            {
                id: this.generateRandomId(),
                name: 'ADF_CLOUD_SERVICE_TASK_FILTERS.COMPLETED_TASKS',
                key: 'completed-tasks',
                icon: 'done',
                appName,
                status: 'COMPLETED',
                sort: 'completedDate',
                order: 'DESC'
            },
            {
                id: this.generateRandomId(),
                name: 'ADF_CLOUD_SERVICE_TASK_FILTERS.ERRORED_TASKS',
                key: 'errored-service-tasks',
                icon: 'error',
                appName,
                status: 'ERROR',
                sort: 'startedDate',
                order: 'DESC'
            }
        ];
    }
    generateRandomId() {
        return Math.random().toString(36).substr(2, 9);
    }
}
ServiceTaskFilterCloudService.ɵfac = function ServiceTaskFilterCloudService_Factory(t) { return new (t || ServiceTaskFilterCloudService)(ɵngcc0.ɵɵinject(ɵngcc1.IdentityUserService), ɵngcc0.ɵɵinject(TASK_FILTERS_SERVICE_TOKEN)); };
ServiceTaskFilterCloudService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ServiceTaskFilterCloudService_Factory() { return new ServiceTaskFilterCloudService(i0.ɵɵinject(i1.IdentityUserService), i0.ɵɵinject(i2.TASK_FILTERS_SERVICE_TOKEN)); }, token: ServiceTaskFilterCloudService, providedIn: "root" });
ServiceTaskFilterCloudService.ctorParameters = () => [
    { type: IdentityUserService },
    { type: undefined, decorators: [{ type: Inject, args: [TASK_FILTERS_SERVICE_TOKEN,] }] }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ServiceTaskFilterCloudService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.IdentityUserService }, { type: undefined, decorators: [{
                type: Inject,
                args: [TASK_FILTERS_SERVICE_TOKEN]
            }] }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS10YXNrLWZpbHRlci1jbG91ZC5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvcHJvY2Vzcy1zZXJ2aWNlcy1jbG91ZC9zcmMvbGliL3Rhc2svdGFzay1maWx0ZXJzL3NlcnZpY2VzL3NlcnZpY2UtdGFzay1maWx0ZXItY2xvdWQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFpQkEsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDekQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFjLEVBQUUsRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFdkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVoRCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQztBQUNuRjtBQUVzQjtBQUVnQjs7O0FBQXRDLE1BQU0sT0FBTyw2QkFBNkI7QUFDMUMsSUFHSSxZQUNZLG1CQUF3QyxFQUV6QyxpQkFBa0Q7QUFDOUQsUUFIYSx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO0FBQUMsUUFFMUMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFpQztBQUNqRSxRQUNRLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDdEQsUUFBUSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxFQUFFLENBQUM7QUFDM0QsSUFBSSxDQUFDO0FBQ0wsSUFNWSxvQkFBb0IsQ0FBQyxPQUFlO0FBQ2hELFFBQVEsTUFBTSxHQUFHLEdBQVcsSUFBSSxDQUFDLFVBQVUsQ0FB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SSxnQkFBZ0I7QUFBSyxRQUNqQixPQUFPLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUN2RCxJQUFJLENBQUM7QUFDTDtzT0FBQztBQUNELG9UQTNRSztBQUFDO0VBSEwsVUFBVSxTQUFDLHJCQUlJLFlBWlAsbUJBQW1CO0lBU3hCLFVBQVUsRUFBRSxNQUFNLGNBQ3JCLHBDQVYrQiw0Q0FpQnZCLE1BQU0sU0FBQywwQkFBMEI7QUFDcEM7Ozs7Ozs7OztrQ0FBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSWRlbnRpdHlVc2VyU2VydmljZSB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbCB9IGZyb20gJy4uL21vZGVscy9maWx0ZXItY2xvdWQubW9kZWwnO1xuaW1wb3J0IHsgc3dpdGNoTWFwLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQcmVmZXJlbmNlQ2xvdWRTZXJ2aWNlSW50ZXJmYWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvcHJlZmVyZW5jZS1jbG91ZC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgVEFTS19GSUxURVJTX1NFUlZJQ0VfVE9LRU4gfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9jbG91ZC10b2tlbi5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkU2VydmljZSB7XG4gICAgcHJpdmF0ZSBmaWx0ZXJzU3ViamVjdDogQmVoYXZpb3JTdWJqZWN0PFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdPjtcbiAgICBmaWx0ZXJzJDogT2JzZXJ2YWJsZTxTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXT47XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBpZGVudGl0eVVzZXJTZXJ2aWNlOiBJZGVudGl0eVVzZXJTZXJ2aWNlLFxuICAgICAgICBASW5qZWN0KFRBU0tfRklMVEVSU19TRVJWSUNFX1RPS0VOKVxuICAgICAgICBwdWJsaWMgcHJlZmVyZW5jZVNlcnZpY2U6IFByZWZlcmVuY2VDbG91ZFNlcnZpY2VJbnRlcmZhY2VcbiAgICApIHtcbiAgICAgICAgdGhpcy5maWx0ZXJzU3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3QoW10pO1xuICAgICAgICB0aGlzLmZpbHRlcnMkID0gdGhpcy5maWx0ZXJzU3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGFuZCByZXR1cm5zIHRoZSBkZWZhdWx0IHRhc2sgZmlsdGVycyBmb3IgYW4gYXBwLlxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIG9mIGRlZmF1bHQgZmlsdGVycyB0YXNrIGZpbHRlcnMganVzdCBjcmVhdGVkIG9yIGNyZWF0ZWQgZmlsdGVyc1xuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlRGVmYXVsdEZpbHRlcnMoYXBwTmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGtleTogc3RyaW5nID0gdGhpcy5wcmVwYXJlS2V5KGFwcE5hbWUpO1xuICAgICAgICB0aGlzLnByZWZlcmVuY2VTZXJ2aWNlLmdldFByZWZlcmVuY2VzKGFwcE5hbWUsIGtleSkucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgocmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHByZWZlcmVuY2VzID0gKHJlc3BvbnNlICYmIHJlc3BvbnNlLmxpc3QgJiYgcmVzcG9uc2UubGlzdC5lbnRyaWVzKSA/IHJlc3BvbnNlLmxpc3QuZW50cmllcyA6IFtdO1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy5oYXNQcmVmZXJlbmNlcyhwcmVmZXJlbmNlcykgfHwgIXRoaXMuaGFzVGFza0ZpbHRlcnMocHJlZmVyZW5jZXMsIGtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlVGFza0ZpbHRlcnMoYXBwTmFtZSwga2V5LCB0aGlzLmRlZmF1bHRTZXJ2aWNlVGFza0ZpbHRlcnMoYXBwTmFtZSkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBvZih0aGlzLmZpbmRGaWx0ZXJzQnlLZXlJblByZWZlcmVuY2VzKHByZWZlcmVuY2VzLCBrZXkpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICApLnN1YnNjcmliZSgoZmlsdGVycykgPT4ge1xuICAgICAgICAgICAgdGhpcy5hZGRGaWx0ZXJzVG9TdHJlYW0oZmlsdGVycyk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyB1c2VyIHByZWZlcmVuY2UgYXJlIGVtcHR5IG9yIG5vdFxuICAgICAqIEBwYXJhbSBwcmVmZXJlbmNlcyBVc2VyIHByZWZlcmVuY2VzIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHJldHVybnMgQm9vbGVhbiB2YWx1ZSBpZiB0aGUgcHJlZmVyZW5jZXMgYXJlIG5vdCBlbXB0eVxuICAgICAqL1xuICAgIHByaXZhdGUgaGFzUHJlZmVyZW5jZXMocHJlZmVyZW5jZXM6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gcHJlZmVyZW5jZXMgJiYgcHJlZmVyZW5jZXMubGVuZ3RoID4gMDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3MgZm9yIHRhc2sgZmlsdGVycyBpbiBnaXZlbiB1c2VyIHByZWZlcmVuY2VzXG4gICAgICogQHBhcmFtIHByZWZlcmVuY2VzIFVzZXIgcHJlZmVyZW5jZXMgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcGFyYW0ga2V5IEtleSBvZiB0aGUgdGFzayBmaWx0ZXJzXG4gICAgICogQHBhcmFtIGZpbHRlcnMgRGV0YWlscyBvZiBjcmVhdGUgZmlsdGVyXG4gICAgICogQHJldHVybnMgQm9vbGVhbiB2YWx1ZSBpZiB0aGUgcHJlZmVyZW5jZSBoYXMgdGFzayBmaWx0ZXJzXG4gICAgICovXG4gICAgcHJpdmF0ZSBoYXNUYXNrRmlsdGVycyhwcmVmZXJlbmNlczogYW55LCBrZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBmaWx0ZXJzID0gcHJlZmVyZW5jZXMuZmluZCgoZmlsdGVyOiBhbnkpID0+IHsgcmV0dXJuIGZpbHRlci5lbnRyeS5rZXkgPT09IGtleTsgfSk7XG4gICAgICAgIHJldHVybiAoZmlsdGVycyAmJiBmaWx0ZXJzLmVudHJ5KSA/IEpTT04ucGFyc2UoZmlsdGVycy5lbnRyeS52YWx1ZSkubGVuZ3RoID4gMCA6IGZhbHNlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGxzIGNyZWF0ZSBwcmVmZXJlbmNlIGFwaSB0byBjcmVhdGUgdGFzayBmaWx0ZXJzXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSB0YXNrIGluc3RhbmNlIGZpbHRlcnNcbiAgICAgKiBAcGFyYW0gZmlsdGVycyBEZXRhaWxzIG9mIG5ldyB0YXNrIGZpbHRlclxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGUgb2YgY3JlYXRlZCB0YXNrIGZpbHRlcnNcbiAgICAgKi9cbiAgICBwcml2YXRlIGNyZWF0ZVRhc2tGaWx0ZXJzKGFwcE5hbWU6IHN0cmluZywga2V5OiBzdHJpbmcsIGZpbHRlcnM6IFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdKTogT2JzZXJ2YWJsZTxTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcmVmZXJlbmNlU2VydmljZS5jcmVhdGVQcmVmZXJlbmNlKGFwcE5hbWUsIGtleSwgZmlsdGVycyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsbHMgZ2V0IHByZWZlcmVuY2UgYXBpIHRvIGdldCB0YXNrIGZpbHRlciBieSBwcmVmZXJlbmNlIGtleVxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcGFyYW0ga2V5IEtleSBvZiB0aGUgdGFzayBmaWx0ZXJzXG4gICAgICogQHJldHVybnMgT2JzZXJ2YWJsZSBvZiB0YXNrIGZpbHRlcnNcbiAgICAgKi9cbiAgICBwcml2YXRlIGdldFRhc2tGaWx0ZXJzQnlLZXkoYXBwTmFtZTogc3RyaW5nLCBrZXk6IHN0cmluZyk6IE9ic2VydmFibGU8U2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsW10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJlZmVyZW5jZVNlcnZpY2UuZ2V0UHJlZmVyZW5jZUJ5S2V5KGFwcE5hbWUsIGtleSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgdGFzayBmaWx0ZXJzIGZvciBhIHRhc2sgYXBwLlxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIG9mIHRhc2sgZmlsdGVyIGRldGFpbHNcbiAgICAgKi9cbiAgICBnZXRUYXNrTGlzdEZpbHRlcnMoYXBwTmFtZT86IHN0cmluZyk6IE9ic2VydmFibGU8U2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsW10+IHtcbiAgICAgICAgdGhpcy5jcmVhdGVEZWZhdWx0RmlsdGVycyhhcHBOYW1lKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsdGVycyQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhIHRhc2sgZmlsdGVyLlxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcGFyYW0gaWQgSUQgb2YgdGhlIHRhc2tcbiAgICAgKiBAcmV0dXJucyBEZXRhaWxzIG9mIHRoZSB0YXNrIGZpbHRlclxuICAgICAqL1xuICAgIGdldFRhc2tGaWx0ZXJCeUlkKGFwcE5hbWU6IHN0cmluZywgaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8U2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsPiB7XG4gICAgICAgIGNvbnN0IGtleTogc3RyaW5nID0gdGhpcy5wcmVwYXJlS2V5KGFwcE5hbWUpO1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRUYXNrRmlsdGVyc0J5S2V5KGFwcE5hbWUsIGtleSkucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoZmlsdGVyczogU2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsW10pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZmlsdGVycyAmJiBmaWx0ZXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVUYXNrRmlsdGVycyhhcHBOYW1lLCBrZXksIHRoaXMuZGVmYXVsdFNlcnZpY2VUYXNrRmlsdGVycyhhcHBOYW1lKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKGZpbHRlcnMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgbWFwKChmaWx0ZXJzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmlsdGVycy5maWx0ZXIoKGZpbHRlcjogU2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXIuaWQgPT09IGlkO1xuICAgICAgICAgICAgICAgIH0pWzBdO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgbmV3IHRhc2sgZmlsdGVyLlxuICAgICAqIEBwYXJhbSBmaWx0ZXIgVGhlIG5ldyBmaWx0ZXIgdG8gYWRkXG4gICAgICogQHJldHVybnMgT2JzZXJ2YWJsZSBvZiB0YXNrIGluc3RhbmNlIGZpbHRlcnMgd2l0aCBuZXdseSBhZGRlZCBmaWx0ZXJcbiAgICAgKi9cbiAgICBhZGRGaWx0ZXIobmV3RmlsdGVyOiBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWwpOiBPYnNlcnZhYmxlPFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdPiB7XG4gICAgICAgIGNvbnN0IGtleTogc3RyaW5nID0gdGhpcy5wcmVwYXJlS2V5KG5ld0ZpbHRlci5hcHBOYW1lKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VGFza0ZpbHRlcnNCeUtleShuZXdGaWx0ZXIuYXBwTmFtZSwga2V5KS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKChmaWx0ZXJzOiBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJzICYmIGZpbHRlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZVRhc2tGaWx0ZXJzKG5ld0ZpbHRlci5hcHBOYW1lLCBrZXksIDxTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXT4gW25ld0ZpbHRlcl0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZpbHRlcnMucHVzaChuZXdGaWx0ZXIpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wcmVmZXJlbmNlU2VydmljZS51cGRhdGVQcmVmZXJlbmNlKG5ld0ZpbHRlci5hcHBOYW1lLCBrZXksIGZpbHRlcnMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgbWFwKChmaWx0ZXJzOiBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkRmlsdGVyc1RvU3RyZWFtKGZpbHRlcnMpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXJzO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFkZEZpbHRlcnNUb1N0cmVhbShmaWx0ZXJzOiBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXSkge1xuICAgICAgICB0aGlzLmZpbHRlcnNTdWJqZWN0Lm5leHQoZmlsdGVycyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlcyBhIHRhc2sgZmlsdGVyLlxuICAgICAqIEBwYXJhbSBmaWx0ZXIgVGhlIGZpbHRlciB0byB1cGRhdGVcbiAgICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIG9mIHRhc2sgaW5zdGFuY2UgZmlsdGVycyB3aXRoIHVwZGF0ZWQgZmlsdGVyXG4gICAgICovXG4gICAgdXBkYXRlRmlsdGVyKHVwZGF0ZWRGaWx0ZXI6IFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbCk6IE9ic2VydmFibGU8U2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsW10+IHtcbiAgICAgICAgY29uc3Qga2V5OiBzdHJpbmcgPSB0aGlzLnByZXBhcmVLZXkodXBkYXRlZEZpbHRlci5hcHBOYW1lKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VGFza0ZpbHRlcnNCeUtleSh1cGRhdGVkRmlsdGVyLmFwcE5hbWUsIGtleSkucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoZmlsdGVyczogU2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsW10pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZmlsdGVycyAmJiBmaWx0ZXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVUYXNrRmlsdGVycyh1cGRhdGVkRmlsdGVyLmFwcE5hbWUsIGtleSwgPFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdPiBbdXBkYXRlZEZpbHRlcl0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1JbmRleCA9IGZpbHRlcnMuZmluZEluZGV4KChmaWx0ZXI6IFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbCkgPT4gZmlsdGVyLmlkID09PSB1cGRhdGVkRmlsdGVyLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyc1tpdGVtSW5kZXhdID0gdXBkYXRlZEZpbHRlcjtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlVGFza0ZpbHRlcnModXBkYXRlZEZpbHRlci5hcHBOYW1lLCBrZXksIGZpbHRlcnMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgbWFwKCh1cGRhdGVkRmlsdGVyczogU2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsW10pID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmFkZEZpbHRlcnNUb1N0cmVhbSh1cGRhdGVkRmlsdGVycyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWRGaWx0ZXJzO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZWxldGVzIGEgdGFzayBmaWx0ZXJcbiAgICAgKiBAcGFyYW0gZmlsdGVyIFRoZSBmaWx0ZXIgdG8gZGVsZXRlXG4gICAgICogQHJldHVybnMgT2JzZXJ2YWJsZSBvZiB0YXNrIGluc3RhbmNlIGZpbHRlcnMgd2l0aG91dCBkZWxldGVkIGZpbHRlclxuICAgICAqL1xuICAgIGRlbGV0ZUZpbHRlcihkZWxldGVkRmlsdGVyOiBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWwpOiBPYnNlcnZhYmxlPFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdPiB7XG4gICAgICAgIGNvbnN0IGtleSA9IHRoaXMucHJlcGFyZUtleShkZWxldGVkRmlsdGVyLmFwcE5hbWUpO1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRUYXNrRmlsdGVyc0J5S2V5KGRlbGV0ZWRGaWx0ZXIuYXBwTmFtZSwga2V5KS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKChmaWx0ZXJzOiBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJzICYmIGZpbHRlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBmaWx0ZXJzID0gZmlsdGVycy5maWx0ZXIoZmlsdGVyID0+IGZpbHRlci5pZCAhPT0gZGVsZXRlZEZpbHRlci5pZCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZVRhc2tGaWx0ZXJzKGRlbGV0ZWRGaWx0ZXIuYXBwTmFtZSwga2V5LCBmaWx0ZXJzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9mKFtdKTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgbWFwKGZpbHRlcnMgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkRmlsdGVyc1RvU3RyZWFtKGZpbHRlcnMpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXJzO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3MgaWYgZ2l2ZW4gZmlsdGVyIGlzIGEgZGVmYXVsdCBmaWx0ZXJcbiAgICAgKiBAcGFyYW0gZmlsdGVyTmFtZSBOYW1lIG9mIHRoZSB0YXJnZXQgdGFzayBmaWx0ZXJcbiAgICAgKiBAcmV0dXJucyBCb29sZWFuIHZhbHVlIGZvciB3aGV0aGVyIHRoZSBmaWx0ZXIgaXMgYSBkZWZhdWx0IGZpbHRlclxuICAgICAqL1xuICAgIGlzRGVmYXVsdEZpbHRlcihmaWx0ZXJOYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgZGVmYXVsdEZpbHRlcnMgPSB0aGlzLmRlZmF1bHRTZXJ2aWNlVGFza0ZpbHRlcnMoKTtcbiAgICAgICAgcmV0dXJuIGRlZmF1bHRGaWx0ZXJzLmZpbmRJbmRleCgoZmlsdGVyKSA9PiBmaWx0ZXJOYW1lID09PSBmaWx0ZXIubmFtZSkgIT09IC0xO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGxzIHVwZGF0ZSBwcmVmZXJlbmNlIGFwaSB0byB1cGRhdGUgdGFzayBmaWx0ZXJcbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHBhcmFtIGtleSBLZXkgb2YgdGhlIHRhc2sgZmlsdGVyc1xuICAgICAqIEBwYXJhbSBmaWx0ZXJzIERldGFpbHMgb2YgdXBkYXRlIGZpbHRlclxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGUgb2YgdXBkYXRlZCB0YXNrIGZpbHRlcnNcbiAgICAgKi9cbiAgICBwcml2YXRlIHVwZGF0ZVRhc2tGaWx0ZXJzKGFwcE5hbWU6IHN0cmluZywga2V5OiBzdHJpbmcsIGZpbHRlcnM6IFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdKTogT2JzZXJ2YWJsZTxTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcmVmZXJlbmNlU2VydmljZS51cGRhdGVQcmVmZXJlbmNlKGFwcE5hbWUsIGtleSwgZmlsdGVycyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBhIHVuaXEga2V5IHdpdGggYXBwTmFtZSBhbmQgdXNlcm5hbWVcbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHJldHVybnMgU3RyaW5nIG9mIHRhc2sgZmlsdGVycyBwcmVmZXJlbmNlIGtleVxuICAgICAqL1xuICAgIHByaXZhdGUgcHJlcGFyZUtleShhcHBOYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gYHNlcnZpY2UtdGFzay1maWx0ZXJzLSR7YXBwTmFtZX0tJHt0aGlzLmlkZW50aXR5VXNlclNlcnZpY2UuZ2V0Q3VycmVudFVzZXJJbmZvKCkudXNlcm5hbWV9YDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kcyBhbmQgcmV0dXJucyB0aGUgdGFzayBmaWx0ZXJzIGZyb20gcHJlZmVyZW5jZXNcbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgVGFza0ZpbHRlckNsb3VkTW9kZWxcbiAgICAgKi9cbiAgICBwcml2YXRlIGZpbmRGaWx0ZXJzQnlLZXlJblByZWZlcmVuY2VzKHByZWZlcmVuY2VzOiBhbnksIGtleTogc3RyaW5nKTogU2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsW10ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBwcmVmZXJlbmNlcy5maW5kKChmaWx0ZXI6IGFueSkgPT4geyByZXR1cm4gZmlsdGVyLmVudHJ5LmtleSA9PT0ga2V5OyB9KTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdCAmJiByZXN1bHQuZW50cnkgPyBKU09OLnBhcnNlKHJlc3VsdC5lbnRyeS52YWx1ZSkgOiBbXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGFuZCByZXR1cm5zIHRoZSBkZWZhdWx0IGZpbHRlcnMgZm9yIGEgdGFzayBhcHAuXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIFRhc2tGaWx0ZXJDbG91ZE1vZGVsXG4gICAgICovXG4gICAgcHJpdmF0ZSBkZWZhdWx0U2VydmljZVRhc2tGaWx0ZXJzKGFwcE5hbWU/OiBzdHJpbmcpOiBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXSB7XG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgaWQ6IHRoaXMuZ2VuZXJhdGVSYW5kb21JZCgpLFxuICAgICAgICAgICAgICAgIG5hbWU6ICdBREZfQ0xPVURfU0VSVklDRV9UQVNLX0ZJTFRFUlMuQUxMX1NFUlZJQ0VfVEFTS1MnLFxuICAgICAgICAgICAgICAgIGtleTogJ215LXNlcnZpY2UtdGFza3MnLFxuICAgICAgICAgICAgICAgIGljb246ICdpbmJveCcsXG4gICAgICAgICAgICAgICAgYXBwTmFtZSxcbiAgICAgICAgICAgICAgICBzdGF0dXM6ICcnLFxuICAgICAgICAgICAgICAgIHNvcnQ6ICdzdGFydGVkRGF0ZScsXG4gICAgICAgICAgICAgICAgb3JkZXI6ICdERVNDJ1xuICAgICAgICAgICAgfSBhcyBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWwsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgaWQ6IHRoaXMuZ2VuZXJhdGVSYW5kb21JZCgpLFxuICAgICAgICAgICAgICAgIG5hbWU6ICdBREZfQ0xPVURfU0VSVklDRV9UQVNLX0ZJTFRFUlMuQ09NUExFVEVEX1RBU0tTJyxcbiAgICAgICAgICAgICAgICBrZXk6ICdjb21wbGV0ZWQtdGFza3MnLFxuICAgICAgICAgICAgICAgIGljb246ICdkb25lJyxcbiAgICAgICAgICAgICAgICBhcHBOYW1lLFxuICAgICAgICAgICAgICAgIHN0YXR1czogJ0NPTVBMRVRFRCcsXG4gICAgICAgICAgICAgICAgc29ydDogJ2NvbXBsZXRlZERhdGUnLFxuICAgICAgICAgICAgICAgIG9yZGVyOiAnREVTQydcbiAgICAgICAgICAgIH0gYXMgU2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGlkOiB0aGlzLmdlbmVyYXRlUmFuZG9tSWQoKSxcbiAgICAgICAgICAgICAgICBuYW1lOiAnQURGX0NMT1VEX1NFUlZJQ0VfVEFTS19GSUxURVJTLkVSUk9SRURfVEFTS1MnLFxuICAgICAgICAgICAgICAgIGtleTogJ2Vycm9yZWQtc2VydmljZS10YXNrcycsXG4gICAgICAgICAgICAgICAgaWNvbjogJ2Vycm9yJyxcbiAgICAgICAgICAgICAgICBhcHBOYW1lLFxuICAgICAgICAgICAgICAgIHN0YXR1czogJ0VSUk9SJyxcbiAgICAgICAgICAgICAgICBzb3J0OiAnc3RhcnRlZERhdGUnLFxuICAgICAgICAgICAgICAgIG9yZGVyOiAnREVTQydcbiAgICAgICAgICAgIH0gYXMgU2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsXG4gICAgICAgIF07XG4gICAgfVxuXG4gICAgZ2VuZXJhdGVSYW5kb21JZCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpO1xuICAgIH1cbn1cbiJdfQ==