import { Injectable } from '@angular/core';
import { AlfrescoApiService, LogService, AppConfigService, IdentityUserService, TranslationService } from '@alfresco/adf-core';
import { throwError, of, Subject } from 'rxjs';
import { map } from 'rxjs/operators';
import { BaseCloudService } from '../../services/base-cloud.service';
import { StartTaskCloudRequestModel } from '../start-task/models/start-task-cloud-request.model';
import { ProcessDefinitionCloud } from '../../models/process-definition-cloud.model';
import { DEFAULT_TASK_PRIORITIES, TASK_ASSIGNED_STATE, TASK_CREATED_STATE } from '../models/task.model';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
export class TaskCloudService extends BaseCloudService {
    constructor(apiService, appConfigService, logService, translateService, identityUserService) {
        super(apiService, appConfigService);
        this.logService = logService;
        this.translateService = translateService;
        this.identityUserService = identityUserService;
        this.dataChangesDetected$ = new Subject();
    }
    completeTask(appName, taskId) {
        if ((appName || appName === '') && taskId) {
            const url = `${this.getBasePath(appName)}/rb/v1/tasks/${taskId}/complete`;
            const payload = { 'payloadType': 'CompleteTaskPayload' };
            return this.post(url, payload);
        }
        else {
            this.logService.error('AppName and TaskId are mandatory for complete a task');
            return throwError('AppName/TaskId not configured');
        }
    }
    canCompleteTask(taskDetails) {
        return taskDetails && taskDetails.status === TASK_ASSIGNED_STATE && this.isAssignedToMe(taskDetails.assignee);
    }
    isTaskEditable(taskDetails) {
        return taskDetails && taskDetails.status === TASK_ASSIGNED_STATE && this.isAssignedToMe(taskDetails.assignee);
    }
    isAssigneePropertyClickable(taskDetails, candidateUsers, candidateGroups) {
        let isClickable = false;
        const states = [TASK_ASSIGNED_STATE];
        if ((candidateUsers === null || candidateUsers === void 0 ? void 0 : candidateUsers.length) || (candidateGroups === null || candidateGroups === void 0 ? void 0 : candidateGroups.length)) {
            isClickable = states.includes(taskDetails.status);
        }
        return isClickable;
    }
    canClaimTask(taskDetails) {
        return taskDetails && taskDetails.status === TASK_CREATED_STATE;
    }
    canUnclaimTask(taskDetails) {
        const currentUser = this.identityUserService.getCurrentUserInfo().username;
        return taskDetails && taskDetails.status === TASK_ASSIGNED_STATE && taskDetails.assignee === currentUser;
    }
    claimTask(appName, taskId, assignee) {
        if ((appName || appName === '') && taskId) {
            const queryUrl = `${this.getBasePath(appName)}/rb/v1/tasks/${taskId}/claim?assignee=${assignee}`;
            return this.post(queryUrl).pipe(map((res) => {
                this.dataChangesDetected$.next();
                return res.entry;
            }));
        }
        else {
            this.logService.error('AppName and TaskId are mandatory for querying a task');
            return throwError('AppName/TaskId not configured');
        }
    }
    unclaimTask(appName, taskId) {
        if ((appName || appName === '') && taskId) {
            const queryUrl = `${this.getBasePath(appName)}/rb/v1/tasks/${taskId}/release`;
            return this.post(queryUrl).pipe(map((res) => {
                this.dataChangesDetected$.next();
                return res.entry;
            }));
        }
        else {
            this.logService.error('AppName and TaskId are mandatory for querying a task');
            return throwError('AppName/TaskId not configured');
        }
    }
    getTaskById(appName, taskId) {
        if ((appName || appName === '') && taskId) {
            const queryUrl = `${this.getBasePath(appName)}/query/v1/tasks/${taskId}`;
            return this.get(queryUrl).pipe(map((res) => res.entry));
        }
        else {
            this.logService.error('AppName and TaskId are mandatory for querying a task');
            return throwError('AppName/TaskId not configured');
        }
    }
    createNewTask(startTaskRequest, appName) {
        const queryUrl = `${this.getBasePath(appName)}/rb/v1/tasks`;
        const payload = JSON.stringify(new StartTaskCloudRequestModel(startTaskRequest));
        return this.post(queryUrl, payload)
            .pipe(map(response => response.entry));
    }
    updateTask(appName, taskId, payload) {
        if ((appName || appName === '') && taskId) {
            payload.payloadType = 'UpdateTaskPayload';
            const queryUrl = `${this.getBasePath(appName)}/rb/v1/tasks/${taskId}`;
            return this.put(queryUrl, payload).pipe(map((res) => res.entry));
        }
        else {
            this.logService.error('AppName and TaskId are mandatory for querying a task');
            return throwError('AppName/TaskId not configured');
        }
    }
    getCandidateUsers(appName, taskId) {
        if ((appName || appName === '') && taskId) {
            const queryUrl = `${this.getBasePath(appName)}/query/v1/tasks/${taskId}/candidate-users`;
            return this.get(queryUrl);
        }
        else {
            this.logService.error('AppName and TaskId are mandatory to get candidate user');
            return of([]);
        }
    }
    getCandidateGroups(appName, taskId) {
        if ((appName || appName === '') && taskId) {
            const queryUrl = `${this.getBasePath(appName)}/query/v1/tasks/${taskId}/candidate-groups`;
            return this.get(queryUrl);
        }
        else {
            this.logService.error('AppName and TaskId are mandatory to get candidate groups');
            return of([]);
        }
    }
    getProcessDefinitions(appName) {
        if (appName || appName === '') {
            const url = `${this.getBasePath(appName)}/rb/v1/process-definitions`;
            return this.get(url).pipe(map((res) => {
                return res.list.entries.map((processDefs) => new ProcessDefinitionCloud(processDefs.entry));
            }));
        }
        else {
            this.logService.error('AppName is mandatory for querying task');
            return throwError('AppName not configured');
        }
    }
    assign(appName, taskId, assignee) {
        if (appName && taskId) {
            const payLoad = { 'assignee': assignee, 'taskId': taskId, 'payloadType': 'AssignTaskPayload' };
            const url = `${this.getBasePath(appName)}/rb/v1/tasks/${taskId}/assign`;
            return this.post(url, payLoad).pipe(map((res) => {
                return res.entry;
            }));
        }
        else {
            this.logService.error('AppName and TaskId are mandatory to change/update the task assignee');
            return throwError('AppName/TaskId not configured');
        }
    }
    getPriorityLabel(priority) {
        const priorityItem = this.priorities.find(item => item.value === priority.toString()) || this.priorities[0];
        return this.translateService.instant(priorityItem.label);
    }
    get priorities() {
        return this.appConfigService.get('adf-cloud-priority-values') || DEFAULT_TASK_PRIORITIES;
    }
    isAssignedToMe(assignee) {
        const currentUser = this.identityUserService.getCurrentUserInfo().username;
        return assignee === currentUser;
    }
}
TaskCloudService.ɵfac = function TaskCloudService_Factory(t) { return new (t || TaskCloudService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc1.AppConfigService), ɵngcc0.ɵɵinject(ɵngcc1.LogService), ɵngcc0.ɵɵinject(ɵngcc1.TranslationService), ɵngcc0.ɵɵinject(ɵngcc1.IdentityUserService)); };
TaskCloudService.ɵprov = i0.ɵɵdefineInjectable({ factory: function TaskCloudService_Factory() { return new TaskCloudService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i1.AppConfigService), i0.ɵɵinject(i1.LogService), i0.ɵɵinject(i1.TranslationService), i0.ɵɵinject(i1.IdentityUserService)); }, token: TaskCloudService, providedIn: "root" });
TaskCloudService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: AppConfigService },
    { type: LogService },
    { type: TranslationService },
    { type: IdentityUserService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(TaskCloudService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc1.AppConfigService }, { type: ɵngcc1.LogService }, { type: ɵngcc1.TranslationService }, { type: ɵngcc1.IdentityUserService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFzay1jbG91ZC5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvcHJvY2Vzcy1zZXJ2aWNlcy1jbG91ZC9zcmMvbGliL3Rhc2svc2VydmljZXMvdGFzay1jbG91ZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsbUJBQW1CLEVBQXFCLGtCQUFrQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDbEosT0FBTyxFQUFFLFVBQVUsRUFBYyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVyQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNyRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxxREFBcUQsQ0FBQztBQUNqRyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw2Q0FBNkMsQ0FBQztBQUNyRixPQUFPLEVBQUUsdUJBQXVCLEVBQXNCLG1CQUFtQixFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDNUg7QUFBcUM7OztBQUtyQyxNQUFNLE9BQU8sZ0JBQWlCLFNBQVEsZ0JBQWdCO0FBQUcsSUFJckQsWUFDSSxVQUE4QixFQUM5QixnQkFBa0MsRUFDMUIsVUFBc0IsRUFDdEIsZ0JBQW9DLEVBQ3BDLG1CQUF3QztBQUNyRCxRQUNLLEtBQUssQ0FBQyxVQUFVLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztBQUM1QyxRQUxnQixlQUFVLEdBQVYsVUFBVSxDQUFZO0FBQUMsUUFDdkIscUJB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Q0FBQyxtQkFBbUIsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDLFFBQVEsQ0FBQztBQUNuRixRQUFRLE9BQU8sUUFBUSxLQUFLLFdBQVcsQ0FBQztBQUN4QyxJQUFJLENBQUM7QUFDTDt3VEFBQztBQUNELDBWQTNRSztBQUFDO0VBSEwsVUFBVSxTQUFDLHJCQUdvQyxZQWJ2QyxrQkFBa0I7S0FXdkIsVUFBVSxFQUFFLE1BQU0sdkJBWFMsWUFBVSxnQkFBZ0I7S0FZeEQsTEFaNEQsWUFBaEMsVUFBVTtBQUFJLFlBQXdELGtCQUFrQjtBQUFJLFlBQTlELG1CQUFtQjtBQUFHOzs7Ozs7OE5BQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSwgTG9nU2VydmljZSwgQXBwQ29uZmlnU2VydmljZSwgSWRlbnRpdHlVc2VyU2VydmljZSwgQ2FyZFZpZXdBcnJheUl0ZW0sIFRyYW5zbGF0aW9uU2VydmljZSB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyB0aHJvd0Vycm9yLCBPYnNlcnZhYmxlLCBvZiwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgVGFza0RldGFpbHNDbG91ZE1vZGVsLCBTdGFydFRhc2tDbG91ZFJlc3BvbnNlTW9kZWwgfSBmcm9tICcuLi9zdGFydC10YXNrL21vZGVscy90YXNrLWRldGFpbHMtY2xvdWQubW9kZWwnO1xuaW1wb3J0IHsgQmFzZUNsb3VkU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2Jhc2UtY2xvdWQuc2VydmljZSc7XG5pbXBvcnQgeyBTdGFydFRhc2tDbG91ZFJlcXVlc3RNb2RlbCB9IGZyb20gJy4uL3N0YXJ0LXRhc2svbW9kZWxzL3N0YXJ0LXRhc2stY2xvdWQtcmVxdWVzdC5tb2RlbCc7XG5pbXBvcnQgeyBQcm9jZXNzRGVmaW5pdGlvbkNsb3VkIH0gZnJvbSAnLi4vLi4vbW9kZWxzL3Byb2Nlc3MtZGVmaW5pdGlvbi1jbG91ZC5tb2RlbCc7XG5pbXBvcnQgeyBERUZBVUxUX1RBU0tfUFJJT1JJVElFUywgVGFza1ByaW9yaXR5T3B0aW9uLCBUQVNLX0FTU0lHTkVEX1NUQVRFLCBUQVNLX0NSRUFURURfU1RBVEUgfSBmcm9tICcuLi9tb2RlbHMvdGFzay5tb2RlbCc7XG5pbXBvcnQgeyBUYXNrQ2xvdWRTZXJ2aWNlSW50ZXJmYWNlIH0gZnJvbSAnLi90YXNrLWNsb3VkLnNlcnZpY2UuaW50ZXJmYWNlJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBUYXNrQ2xvdWRTZXJ2aWNlIGV4dGVuZHMgQmFzZUNsb3VkU2VydmljZSBpbXBsZW1lbnRzIFRhc2tDbG91ZFNlcnZpY2VJbnRlcmZhY2Uge1xuXG4gICAgZGF0YUNoYW5nZXNEZXRlY3RlZCQgPSBuZXcgU3ViamVjdCgpO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIGFwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICAgICAgYXBwQ29uZmlnU2VydmljZTogQXBwQ29uZmlnU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0aW9uU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBpZGVudGl0eVVzZXJTZXJ2aWNlOiBJZGVudGl0eVVzZXJTZXJ2aWNlXG4gICAgKSB7XG4gICAgICAgIHN1cGVyKGFwaVNlcnZpY2UsIGFwcENvbmZpZ1NlcnZpY2UpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENvbXBsZXRlIGEgdGFzay5cbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSBhcHBcbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXNrIHRvIGNvbXBsZXRlXG4gICAgICogQHJldHVybnMgRGV0YWlscyBvZiB0aGUgdGFzayB0aGF0IHdhcyBjb21wbGV0ZWRcbiAgICAgKi9cbiAgICBjb21wbGV0ZVRhc2soYXBwTmFtZTogc3RyaW5nLCB0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNDbG91ZE1vZGVsPiB7XG4gICAgICAgIGlmICgoYXBwTmFtZSB8fCBhcHBOYW1lID09PSAnJykgJiYgdGFza0lkKSB7XG4gICAgICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmdldEJhc2VQYXRoKGFwcE5hbWUpfS9yYi92MS90YXNrcy8ke3Rhc2tJZH0vY29tcGxldGVgO1xuICAgICAgICAgICAgY29uc3QgcGF5bG9hZCA9IHsgJ3BheWxvYWRUeXBlJzogJ0NvbXBsZXRlVGFza1BheWxvYWQnIH07XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvc3Q8YW55LCBUYXNrRGV0YWlsc0Nsb3VkTW9kZWw+KHVybCwgcGF5bG9hZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoJ0FwcE5hbWUgYW5kIFRhc2tJZCBhcmUgbWFuZGF0b3J5IGZvciBjb21wbGV0ZSBhIHRhc2snKTtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdBcHBOYW1lL1Rhc2tJZCBub3QgY29uZmlndXJlZCcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVmFsaWRhdGUgaWYgYSB0YXNrIGNhbiBiZSBjb21wbGV0ZWQuXG4gICAgICogQHBhcmFtIHRhc2tEZXRhaWxzIHRhc2sgZGV0YWlscyBvYmplY3RcbiAgICAgKiBAcmV0dXJucyBCb29sZWFuIHZhbHVlIGlmIHRoZSB0YXNrIGNhbiBiZSBjb21wbGV0ZWRcbiAgICAgKi9cbiAgICBjYW5Db21wbGV0ZVRhc2sodGFza0RldGFpbHM6IFRhc2tEZXRhaWxzQ2xvdWRNb2RlbCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGFza0RldGFpbHMgJiYgdGFza0RldGFpbHMuc3RhdHVzID09PSBUQVNLX0FTU0lHTkVEX1NUQVRFICYmIHRoaXMuaXNBc3NpZ25lZFRvTWUodGFza0RldGFpbHMuYXNzaWduZWUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFZhbGlkYXRlIGlmIGEgdGFzayBpcyBlZGl0YWJsZS5cbiAgICAgKiBAcGFyYW0gdGFza0RldGFpbHMgdGFzayBkZXRhaWxzIG9iamVjdFxuICAgICAqIEByZXR1cm5zIEJvb2xlYW4gdmFsdWUgaWYgdGhlIHRhc2sgaXMgZWRpdGFibGVcbiAgICAgKi9cbiAgICBpc1Rhc2tFZGl0YWJsZSh0YXNrRGV0YWlsczogVGFza0RldGFpbHNDbG91ZE1vZGVsKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0YXNrRGV0YWlscyAmJiB0YXNrRGV0YWlscy5zdGF0dXMgPT09IFRBU0tfQVNTSUdORURfU1RBVEUgJiYgdGhpcy5pc0Fzc2lnbmVkVG9NZSh0YXNrRGV0YWlscy5hc3NpZ25lZSk7XG4gICAgfVxuXG4gICAgaXNBc3NpZ25lZVByb3BlcnR5Q2xpY2thYmxlKHRhc2tEZXRhaWxzOiBUYXNrRGV0YWlsc0Nsb3VkTW9kZWwsIGNhbmRpZGF0ZVVzZXJzOiBDYXJkVmlld0FycmF5SXRlbVtdLCBjYW5kaWRhdGVHcm91cHM6IENhcmRWaWV3QXJyYXlJdGVtW10pOiBib29sZWFuIHtcbiAgICAgICAgbGV0IGlzQ2xpY2thYmxlID0gZmFsc2U7XG4gICAgICAgIGNvbnN0IHN0YXRlcyA9IFtUQVNLX0FTU0lHTkVEX1NUQVRFXTtcbiAgICAgICAgaWYgKGNhbmRpZGF0ZVVzZXJzPy5sZW5ndGggfHwgY2FuZGlkYXRlR3JvdXBzPy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGlzQ2xpY2thYmxlID0gc3RhdGVzLmluY2x1ZGVzKHRhc2tEZXRhaWxzLnN0YXR1cyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGlzQ2xpY2thYmxlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFZhbGlkYXRlIGlmIGEgdGFzayBjYW4gYmUgY2xhaW1lZC5cbiAgICAgKiBAcGFyYW0gdGFza0RldGFpbHMgdGFzayBkZXRhaWxzIG9iamVjdFxuICAgICAqIEByZXR1cm5zIEJvb2xlYW4gdmFsdWUgaWYgdGhlIHRhc2sgY2FuIGJlIGNvbXBsZXRlZFxuICAgICAqL1xuICAgIGNhbkNsYWltVGFzayh0YXNrRGV0YWlsczogVGFza0RldGFpbHNDbG91ZE1vZGVsKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0YXNrRGV0YWlscyAmJiB0YXNrRGV0YWlscy5zdGF0dXMgPT09IFRBU0tfQ1JFQVRFRF9TVEFURTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBWYWxpZGF0ZSBpZiBhIHRhc2sgY2FuIGJlIHVuY2xhaW1lZC5cbiAgICAgKiBAcGFyYW0gdGFza0RldGFpbHMgdGFzayBkZXRhaWxzIG9iamVjdFxuICAgICAqIEByZXR1cm5zIEJvb2xlYW4gdmFsdWUgaWYgdGhlIHRhc2sgY2FuIGJlIGNvbXBsZXRlZFxuICAgICAqL1xuICAgIGNhblVuY2xhaW1UYXNrKHRhc2tEZXRhaWxzOiBUYXNrRGV0YWlsc0Nsb3VkTW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgY3VycmVudFVzZXIgPSB0aGlzLmlkZW50aXR5VXNlclNlcnZpY2UuZ2V0Q3VycmVudFVzZXJJbmZvKCkudXNlcm5hbWU7XG4gICAgICAgIHJldHVybiB0YXNrRGV0YWlscyAmJiB0YXNrRGV0YWlscy5zdGF0dXMgPT09IFRBU0tfQVNTSUdORURfU1RBVEUgJiYgdGFza0RldGFpbHMuYXNzaWduZWUgPT09IGN1cnJlbnRVc2VyO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsYWltcyBhIHRhc2sgZm9yIGFuIGFzc2lnbmVlLlxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIGFwcFxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhc2sgdG8gY2xhaW1cbiAgICAgKiBAcGFyYW0gYXNzaWduZWUgVXNlciB0byBhc3NpZ24gdGhlIHRhc2sgdG9cbiAgICAgKiBAcmV0dXJucyBEZXRhaWxzIG9mIHRoZSBjbGFpbWVkIHRhc2tcbiAgICAgKi9cbiAgICBjbGFpbVRhc2soYXBwTmFtZTogc3RyaW5nLCB0YXNrSWQ6IHN0cmluZywgYXNzaWduZWU6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNDbG91ZE1vZGVsPiB7XG4gICAgICAgIGlmICgoYXBwTmFtZSB8fCBhcHBOYW1lID09PSAnJykgJiYgdGFza0lkKSB7XG4gICAgICAgICAgICBjb25zdCBxdWVyeVVybCA9IGAke3RoaXMuZ2V0QmFzZVBhdGgoYXBwTmFtZSl9L3JiL3YxL3Rhc2tzLyR7dGFza0lkfS9jbGFpbT9hc3NpZ25lZT0ke2Fzc2lnbmVlfWA7XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvc3QocXVlcnlVcmwpLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXM6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRhdGFDaGFuZ2VzRGV0ZWN0ZWQkLm5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5lbnRyeTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcignQXBwTmFtZSBhbmQgVGFza0lkIGFyZSBtYW5kYXRvcnkgZm9yIHF1ZXJ5aW5nIGEgdGFzaycpO1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ0FwcE5hbWUvVGFza0lkIG5vdCBjb25maWd1cmVkJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVbi1jbGFpbXMgYSB0YXNrLlxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIGFwcFxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhc2sgdG8gdW5jbGFpbVxuICAgICAqIEByZXR1cm5zIERldGFpbHMgb2YgdGhlIHRhc2sgdGhhdCB3YXMgdW5jbGFpbWVkXG4gICAgICovXG4gICAgdW5jbGFpbVRhc2soYXBwTmFtZTogc3RyaW5nLCB0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNDbG91ZE1vZGVsPiB7XG4gICAgICAgIGlmICgoYXBwTmFtZSB8fCBhcHBOYW1lID09PSAnJykgJiYgdGFza0lkKSB7XG4gICAgICAgICAgICBjb25zdCBxdWVyeVVybCA9IGAke3RoaXMuZ2V0QmFzZVBhdGgoYXBwTmFtZSl9L3JiL3YxL3Rhc2tzLyR7dGFza0lkfS9yZWxlYXNlYDtcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9zdChxdWVyeVVybCkucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlczogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YUNoYW5nZXNEZXRlY3RlZCQubmV4dCgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLmVudHJ5O1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKCdBcHBOYW1lIGFuZCBUYXNrSWQgYXJlIG1hbmRhdG9yeSBmb3IgcXVlcnlpbmcgYSB0YXNrJyk7XG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcignQXBwTmFtZS9UYXNrSWQgbm90IGNvbmZpZ3VyZWQnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgZGV0YWlscyBvZiBhIHRhc2suXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgYXBwXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFzayB3aG9zZSBkZXRhaWxzIHlvdSB3YW50XG4gICAgICogQHJldHVybnMgVGFzayBkZXRhaWxzXG4gICAgICovXG4gICAgZ2V0VGFza0J5SWQoYXBwTmFtZTogc3RyaW5nLCB0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNDbG91ZE1vZGVsPiB7XG4gICAgICAgIGlmICgoYXBwTmFtZSB8fCBhcHBOYW1lID09PSAnJykgJiYgdGFza0lkKSB7XG4gICAgICAgICAgICBjb25zdCBxdWVyeVVybCA9IGAke3RoaXMuZ2V0QmFzZVBhdGgoYXBwTmFtZSl9L3F1ZXJ5L3YxL3Rhc2tzLyR7dGFza0lkfWA7XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldChxdWVyeVVybCkucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlczogYW55KSA9PiByZXMuZW50cnkpXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKCdBcHBOYW1lIGFuZCBUYXNrSWQgYXJlIG1hbmRhdG9yeSBmb3IgcXVlcnlpbmcgYSB0YXNrJyk7XG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcignQXBwTmFtZS9UYXNrSWQgbm90IGNvbmZpZ3VyZWQnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgICAvKipcbiAgICAgICogQ3JlYXRlcyBhIG5ldyBzdGFuZGFsb25lIHRhc2suXG4gICAgICAqIEBwYXJhbSB0YXNrRGV0YWlscyBEZXRhaWxzIG9mIHRoZSB0YXNrIHRvIGNyZWF0ZVxuICAgICAgKiBAcmV0dXJucyBEZXRhaWxzIG9mIHRoZSBuZXdseSBjcmVhdGVkIHRhc2tcbiAgICAgICovXG4gICAgY3JlYXRlTmV3VGFzayhzdGFydFRhc2tSZXF1ZXN0OiBTdGFydFRhc2tDbG91ZFJlcXVlc3RNb2RlbCwgYXBwTmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc0Nsb3VkTW9kZWw+IHtcbiAgICAgICAgY29uc3QgcXVlcnlVcmwgPSBgJHt0aGlzLmdldEJhc2VQYXRoKGFwcE5hbWUpfS9yYi92MS90YXNrc2A7XG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSBKU09OLnN0cmluZ2lmeShuZXcgU3RhcnRUYXNrQ2xvdWRSZXF1ZXN0TW9kZWwoc3RhcnRUYXNrUmVxdWVzdCkpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLnBvc3Q8YW55LCBTdGFydFRhc2tDbG91ZFJlc3BvbnNlTW9kZWw+KHF1ZXJ5VXJsLCBwYXlsb2FkKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKHJlc3BvbnNlID0+IHJlc3BvbnNlLmVudHJ5KVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBkZXRhaWxzIChuYW1lLCBkZXNjcmlwdGlvbiwgZHVlIGRhdGUpIGZvciBhIHRhc2suXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgYXBwXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFzayB0byB1cGRhdGVcbiAgICAgKiBAcGFyYW0gcGF5bG9hZCBEYXRhIHRvIHVwZGF0ZSB0aGUgdGFza1xuICAgICAqIEByZXR1cm5zIFVwZGF0ZWQgdGFzayBkZXRhaWxzXG4gICAgICovXG4gICAgdXBkYXRlVGFzayhhcHBOYW1lOiBzdHJpbmcsIHRhc2tJZDogc3RyaW5nLCBwYXlsb2FkOiBhbnkpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzQ2xvdWRNb2RlbD4ge1xuICAgICAgICBpZiAoKGFwcE5hbWUgfHwgYXBwTmFtZSA9PT0gJycpICYmIHRhc2tJZCkge1xuICAgICAgICAgICAgcGF5bG9hZC5wYXlsb2FkVHlwZSA9ICdVcGRhdGVUYXNrUGF5bG9hZCc7XG4gICAgICAgICAgICBjb25zdCBxdWVyeVVybCA9IGAke3RoaXMuZ2V0QmFzZVBhdGgoYXBwTmFtZSl9L3JiL3YxL3Rhc2tzLyR7dGFza0lkfWA7XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLnB1dChxdWVyeVVybCwgcGF5bG9hZCkucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlczogYW55KSA9PiByZXMuZW50cnkpXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKCdBcHBOYW1lIGFuZCBUYXNrSWQgYXJlIG1hbmRhdG9yeSBmb3IgcXVlcnlpbmcgYSB0YXNrJyk7XG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcignQXBwTmFtZS9UYXNrSWQgbm90IGNvbmZpZ3VyZWQnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgY2FuZGlkYXRlIHVzZXJzIG9mIHRoZSB0YXNrLlxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIGFwcFxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhc2tcbiAgICAgKiBAcmV0dXJucyBDYW5kaWRhdGUgdXNlcnNcbiAgICAgKi9cbiAgICBnZXRDYW5kaWRhdGVVc2VycyhhcHBOYW1lOiBzdHJpbmcsIHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmdbXT4ge1xuICAgICAgICBpZiAoKGFwcE5hbWUgfHwgYXBwTmFtZSA9PT0gJycpICYmIHRhc2tJZCkge1xuICAgICAgICAgICAgY29uc3QgcXVlcnlVcmwgPSBgJHt0aGlzLmdldEJhc2VQYXRoKGFwcE5hbWUpfS9xdWVyeS92MS90YXNrcy8ke3Rhc2tJZH0vY2FuZGlkYXRlLXVzZXJzYDtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldDxzdHJpbmdbXT4ocXVlcnlVcmwpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKCdBcHBOYW1lIGFuZCBUYXNrSWQgYXJlIG1hbmRhdG9yeSB0byBnZXQgY2FuZGlkYXRlIHVzZXInKTtcbiAgICAgICAgICAgIHJldHVybiBvZihbXSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGNhbmRpZGF0ZSBncm91cHMgb2YgdGhlIHRhc2suXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgYXBwXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFza1xuICAgICAqIEByZXR1cm5zIENhbmRpZGF0ZSBncm91cHNcbiAgICAgKi9cbiAgICBnZXRDYW5kaWRhdGVHcm91cHMoYXBwTmFtZTogc3RyaW5nLCB0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8c3RyaW5nW10+IHtcbiAgICAgICAgaWYgKChhcHBOYW1lIHx8IGFwcE5hbWUgPT09ICcnKSAmJiB0YXNrSWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHF1ZXJ5VXJsID0gYCR7dGhpcy5nZXRCYXNlUGF0aChhcHBOYW1lKX0vcXVlcnkvdjEvdGFza3MvJHt0YXNrSWR9L2NhbmRpZGF0ZS1ncm91cHNgO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0PHN0cmluZ1tdPihxdWVyeVVybCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoJ0FwcE5hbWUgYW5kIFRhc2tJZCBhcmUgbWFuZGF0b3J5IHRvIGdldCBjYW5kaWRhdGUgZ3JvdXBzJyk7XG4gICAgICAgICAgICByZXR1cm4gb2YoW10pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgcHJvY2VzcyBkZWZpbml0aW9ucyBhc3NvY2lhdGVkIHdpdGggYW4gYXBwLlxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBwcm9jZXNzIGRlZmluaXRpb25zXG4gICAgICovXG4gICAgZ2V0UHJvY2Vzc0RlZmluaXRpb25zKGFwcE5hbWU6IHN0cmluZyk6IE9ic2VydmFibGU8UHJvY2Vzc0RlZmluaXRpb25DbG91ZFtdPiB7XG4gICAgICAgIGlmIChhcHBOYW1lIHx8IGFwcE5hbWUgPT09ICcnKSB7XG4gICAgICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmdldEJhc2VQYXRoKGFwcE5hbWUpfS9yYi92MS9wcm9jZXNzLWRlZmluaXRpb25zYDtcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KHVybCkucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlczogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXMubGlzdC5lbnRyaWVzLm1hcCgocHJvY2Vzc0RlZnMpID0+IG5ldyBQcm9jZXNzRGVmaW5pdGlvbkNsb3VkKHByb2Nlc3NEZWZzLmVudHJ5KSk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoJ0FwcE5hbWUgaXMgbWFuZGF0b3J5IGZvciBxdWVyeWluZyB0YXNrJyk7XG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcignQXBwTmFtZSBub3QgY29uZmlndXJlZCcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlcyB0aGUgdGFzayBhc3NpZ25lZS5cbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSBhcHBcbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXNrIHRvIHVwZGF0ZSBhc3NpZ25lZVxuICAgICAqIEBwYXJhbSBhc3NpZ25lZSBhc3NpZ25lZSB0byB1cGRhdGUgY3VycmVudCB1c2VyIHRhc2sgYXNzaWduZWVcbiAgICAgKiBAcmV0dXJucyBVcGRhdGVkIHRhc2sgZGV0YWlscyB3aXRoIG5ldyBhc3NpZ25lZVxuICAgICAqL1xuICAgIGFzc2lnbihhcHBOYW1lOiBzdHJpbmcsIHRhc2tJZDogc3RyaW5nLCBhc3NpZ25lZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc0Nsb3VkTW9kZWw+IHtcbiAgICAgICAgaWYgKGFwcE5hbWUgJiYgdGFza0lkKSB7XG4gICAgICAgICAgICBjb25zdCBwYXlMb2FkID0geyAnYXNzaWduZWUnOiBhc3NpZ25lZSwgJ3Rhc2tJZCc6IHRhc2tJZCwgJ3BheWxvYWRUeXBlJzogJ0Fzc2lnblRhc2tQYXlsb2FkJyB9O1xuICAgICAgICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5nZXRCYXNlUGF0aChhcHBOYW1lKX0vcmIvdjEvdGFza3MvJHt0YXNrSWR9L2Fzc2lnbmA7XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvc3QodXJsLCBwYXlMb2FkKS5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5lbnRyeTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcignQXBwTmFtZSBhbmQgVGFza0lkIGFyZSBtYW5kYXRvcnkgdG8gY2hhbmdlL3VwZGF0ZSB0aGUgdGFzayBhc3NpZ25lZScpO1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ0FwcE5hbWUvVGFza0lkIG5vdCBjb25maWd1cmVkJyk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgIGdldFByaW9yaXR5TGFiZWwocHJpb3JpdHk6IG51bWJlcik6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHByaW9yaXR5SXRlbSA9IHRoaXMucHJpb3JpdGllcy5maW5kKGl0ZW0gPT4gaXRlbS52YWx1ZSA9PT0gcHJpb3JpdHkudG9TdHJpbmcoKSkgfHwgdGhpcy5wcmlvcml0aWVzWzBdO1xuICAgICAgICByZXR1cm4gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQocHJpb3JpdHlJdGVtLmxhYmVsKTtcbiAgICB9XG5cbiAgICBnZXQgcHJpb3JpdGllcygpOiBUYXNrUHJpb3JpdHlPcHRpb25bXSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwcENvbmZpZ1NlcnZpY2UuZ2V0KCdhZGYtY2xvdWQtcHJpb3JpdHktdmFsdWVzJykgfHwgREVGQVVMVF9UQVNLX1BSSU9SSVRJRVM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc0Fzc2lnbmVkVG9NZShhc3NpZ25lZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gdGhpcy5pZGVudGl0eVVzZXJTZXJ2aWNlLmdldEN1cnJlbnRVc2VySW5mbygpLnVzZXJuYW1lO1xuICAgICAgICByZXR1cm4gYXNzaWduZWUgPT09IGN1cnJlbnRVc2VyO1xuICAgIH1cbn1cbiJdfQ==