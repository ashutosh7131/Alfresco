import { Injectable } from '@angular/core';
import { AlfrescoApiService, LogService, AppConfigService, IdentityUserService, TranslationService } from '@alfresco/adf-core';
import { throwError, of, Subject } from 'rxjs';
import { map } from 'rxjs/operators';
import { BaseCloudService } from '../../services/base-cloud.service';
import { StartTaskCloudRequestModel } from '../start-task/models/start-task-cloud-request.model';
import { ProcessDefinitionCloud } from '../../models/process-definition-cloud.model';
import { DEFAULT_TASK_PRIORITIES, TASK_ASSIGNED_STATE, TASK_CREATED_STATE } from '../models/task.model';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
export class TaskCloudService extends BaseCloudService {
    constructor(apiService, appConfigService, logService, translateService, identityUserService) {
        super(apiService, appConfigService);
        this.logService = logService;
        this.translateService = translateService;
        this.identityUserService = identityUserService;
        this.dataChangesDetected$ = new Subject();
    }
    completeTask(appName, taskId) {
        if ((appName || appName === '') && taskId) {
            const url = `${this.getBasePath(appName)}/rb/v1/tasks/${taskId}/complete`;
            const payload = { 'payloadType': 'CompleteTaskPayload' };
            return this.post(url, payload);
        }
        else {
            this.logService.error('AppName and TaskId are mandatory for complete a task');
            return throwError('AppName/TaskId not configured');
        }
    }
    canCompleteTask(taskDetails) {
        return taskDetails && taskDetails.status === TASK_ASSIGNED_STATE && this.isAssignedToMe(taskDetails.assignee);
    }
    isTaskEditable(taskDetails) {
        return taskDetails && taskDetails.status === TASK_ASSIGNED_STATE && this.isAssignedToMe(taskDetails.assignee);
    }
    isAssigneePropertyClickable(taskDetails, candidateUsers, candidateGroups) {
        let isClickable = false;
        const states = [TASK_ASSIGNED_STATE];
        if ((candidateUsers === null || candidateUsers === void 0 ? void 0 : candidateUsers.length) || (candidateGroups === null || candidateGroups === void 0 ? void 0 : candidateGroups.length)) {
            isClickable = states.includes(taskDetails.status);
        }
        return isClickable;
    }
    canClaimTask(taskDetails) {
        return taskDetails && taskDetails.status === TASK_CREATED_STATE;
    }
    canUnclaimTask(taskDetails) {
        const currentUser = this.identityUserService.getCurrentUserInfo().username;
        return taskDetails && taskDetails.status === TASK_ASSIGNED_STATE && taskDetails.assignee === currentUser;
    }
    claimTask(appName, taskId, assignee) {
        if ((appName || appName === '') && taskId) {
            const queryUrl = `${this.getBasePath(appName)}/rb/v1/tasks/${taskId}/claim?assignee=${assignee}`;
            return this.post(queryUrl).pipe(map((res) => {
                this.dataChangesDetected$.next();
                return res.entry;
            }));
        }
        else {
            this.logService.error('AppName and TaskId are mandatory for querying a task');
            return throwError('AppName/TaskId not configured');
        }
    }
    unclaimTask(appName, taskId) {
        if ((appName || appName === '') && taskId) {
            const queryUrl = `${this.getBasePath(appName)}/rb/v1/tasks/${taskId}/release`;
            return this.post(queryUrl).pipe(map((res) => {
                this.dataChangesDetected$.next();
                return res.entry;
            }));
        }
        else {
            this.logService.error('AppName and TaskId are mandatory for querying a task');
            return throwError('AppName/TaskId not configured');
        }
    }
    getTaskById(appName, taskId) {
        if ((appName || appName === '') && taskId) {
            const queryUrl = `${this.getBasePath(appName)}/query/v1/tasks/${taskId}`;
            return this.get(queryUrl).pipe(map((res) => res.entry));
        }
        else {
            this.logService.error('AppName and TaskId are mandatory for querying a task');
            return throwError('AppName/TaskId not configured');
        }
    }
    createNewTask(startTaskRequest, appName) {
        const queryUrl = `${this.getBasePath(appName)}/rb/v1/tasks`;
        const payload = JSON.stringify(new StartTaskCloudRequestModel(startTaskRequest));
        return this.post(queryUrl, payload)
            .pipe(map(response => response.entry));
    }
    updateTask(appName, taskId, payload) {
        if ((appName || appName === '') && taskId) {
            payload.payloadType = 'UpdateTaskPayload';
            const queryUrl = `${this.getBasePath(appName)}/rb/v1/tasks/${taskId}`;
            return this.put(queryUrl, payload).pipe(map((res) => res.entry));
        }
        else {
            this.logService.error('AppName and TaskId are mandatory for querying a task');
            return throwError('AppName/TaskId not configured');
        }
    }
    getCandidateUsers(appName, taskId) {
        if ((appName || appName === '') && taskId) {
            const queryUrl = `${this.getBasePath(appName)}/query/v1/tasks/${taskId}/candidate-users`;
            return this.get(queryUrl);
        }
        else {
            this.logService.error('AppName and TaskId are mandatory to get candidate user');
            return of([]);
        }
    }
    getCandidateGroups(appName, taskId) {
        if ((appName || appName === '') && taskId) {
            const queryUrl = `${this.getBasePath(appName)}/query/v1/tasks/${taskId}/candidate-groups`;
            return this.get(queryUrl);
        }
        else {
            this.logService.error('AppName and TaskId are mandatory to get candidate groups');
            return of([]);
        }
    }
    getProcessDefinitions(appName) {
        if (appName || appName === '') {
            const url = `${this.getBasePath(appName)}/rb/v1/process-definitions`;
            return this.get(url).pipe(map((res) => {
                return res.list.entries.map((processDefs) => new ProcessDefinitionCloud(processDefs.entry));
            }));
        }
        else {
            this.logService.error('AppName is mandatory for querying task');
            return throwError('AppName not configured');
        }
    }
    assign(appName, taskId, assignee) {
        if (appName && taskId) {
            const payLoad = { 'assignee': assignee, 'taskId': taskId, 'payloadType': 'AssignTaskPayload' };
            const url = `${this.getBasePath(appName)}/rb/v1/tasks/${taskId}/assign`;
            return this.post(url, payLoad).pipe(map((res) => {
                return res.entry;
            }));
        }
        else {
            this.logService.error('AppName and TaskId are mandatory to change/update the task assignee');
            return throwError('AppName/TaskId not configured');
        }
    }
    getPriorityLabel(priority) {
        const priorityItem = this.priorities.find(item => item.value === priority.toString()) || this.priorities[0];
        return this.translateService.instant(priorityItem.label);
    }
    get priorities() {
        return this.appConfigService.get('adf-cloud-priority-values') || DEFAULT_TASK_PRIORITIES;
    }
    isAssignedToMe(assignee) {
        const currentUser = this.identityUserService.getCurrentUserInfo().username;
        return assignee === currentUser;
    }
}
TaskCloudService.ɵprov = i0.ɵɵdefineInjectable({ factory: function TaskCloudService_Factory() { return new TaskCloudService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i1.AppConfigService), i0.ɵɵinject(i1.LogService), i0.ɵɵinject(i1.TranslationService), i0.ɵɵinject(i1.IdentityUserService)); }, token: TaskCloudService, providedIn: "root" });
TaskCloudService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
TaskCloudService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: AppConfigService },
    { type: LogService },
    { type: TranslationService },
    { type: IdentityUserService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFzay1jbG91ZC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvcHJvY2Vzcy1zZXJ2aWNlcy1jbG91ZC9zcmMvIiwic291cmNlcyI6WyJsaWIvdGFzay9zZXJ2aWNlcy90YXNrLWNsb3VkLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGtCQUFrQixFQUFFLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxtQkFBbUIsRUFBcUIsa0JBQWtCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNsSixPQUFPLEVBQUUsVUFBVSxFQUFjLEVBQUUsRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0QsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3JFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLHFEQUFxRCxDQUFDO0FBQ2pHLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDZDQUE2QyxDQUFDO0FBQ3JGLE9BQU8sRUFBRSx1QkFBdUIsRUFBc0IsbUJBQW1CLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7O0FBTTVILE1BQU0sT0FBTyxnQkFBaUIsU0FBUSxnQkFBZ0I7SUFJbEQsWUFDSSxVQUE4QixFQUM5QixnQkFBa0MsRUFDMUIsVUFBc0IsRUFDdEIsZ0JBQW9DLEVBQ3BDLG1CQUF3QztRQUVoRCxLQUFLLENBQUMsVUFBVSxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFKNUIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN0QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQW9CO1FBQ3BDLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7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TyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLDJCQUEyQixDQUFDLElBQUksdUJBQXVCLENBQUM7SUFDN0YsQ0FBQztJQUVPLGNBQWMsQ0FBQyxRQUFnQjtRQUNuQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxRQUFRLENBQUM7UUFDM0UsT0FBTyxRQUFRLEtBQUssV0FBVyxDQUFDO0lBQ3BDLENBQUM7Ozs7WUE1UUosVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7WUFaUSxrQkFBa0I7WUFBYyxnQkFBZ0I7WUFBNUIsVUFBVTtZQUE0RCxrQkFBa0I7WUFBMUQsbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlLCBMb2dTZXJ2aWNlLCBBcHBDb25maWdTZXJ2aWNlLCBJZGVudGl0eVVzZXJTZXJ2aWNlLCBDYXJkVmlld0FycmF5SXRlbSwgVHJhbnNsYXRpb25TZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IHRocm93RXJyb3IsIE9ic2VydmFibGUsIG9mLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBUYXNrRGV0YWlsc0Nsb3VkTW9kZWwsIFN0YXJ0VGFza0Nsb3VkUmVzcG9uc2VNb2RlbCB9IGZyb20gJy4uL3N0YXJ0LXRhc2svbW9kZWxzL3Rhc2stZGV0YWlscy1jbG91ZC5tb2RlbCc7XG5pbXBvcnQgeyBCYXNlQ2xvdWRTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvYmFzZS1jbG91ZC5zZXJ2aWNlJztcbmltcG9ydCB7IFN0YXJ0VGFza0Nsb3VkUmVxdWVzdE1vZGVsIH0gZnJvbSAnLi4vc3RhcnQtdGFzay9tb2RlbHMvc3RhcnQtdGFzay1jbG91ZC1yZXF1ZXN0Lm1vZGVsJztcbmltcG9ydCB7IFByb2Nlc3NEZWZpbml0aW9uQ2xvdWQgfSBmcm9tICcuLi8uLi9tb2RlbHMvcHJvY2Vzcy1kZWZpbml0aW9uLWNsb3VkLm1vZGVsJztcbmltcG9ydCB7IERFRkFVTFRfVEFTS19QUklPUklUSUVTLCBUYXNrUHJpb3JpdHlPcHRpb24sIFRBU0tfQVNTSUdORURfU1RBVEUsIFRBU0tfQ1JFQVRFRF9TVEFURSB9IGZyb20gJy4uL21vZGVscy90YXNrLm1vZGVsJztcbmltcG9ydCB7IFRhc2tDbG91ZFNlcnZpY2VJbnRlcmZhY2UgfSBmcm9tICcuL3Rhc2stY2xvdWQuc2VydmljZS5pbnRlcmZhY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFRhc2tDbG91ZFNlcnZpY2UgZXh0ZW5kcyBCYXNlQ2xvdWRTZXJ2aWNlIGltcGxlbWVudHMgVGFza0Nsb3VkU2VydmljZUludGVyZmFjZSB7XG5cbiAgICBkYXRhQ2hhbmdlc0RldGVjdGVkJCA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgYXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlLFxuICAgICAgICBhcHBDb25maWdTZXJ2aWNlOiBBcHBDb25maWdTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRpb25TZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGlkZW50aXR5VXNlclNlcnZpY2U6IElkZW50aXR5VXNlclNlcnZpY2VcbiAgICApIHtcbiAgICAgICAgc3VwZXIoYXBpU2VydmljZSwgYXBwQ29uZmlnU2VydmljZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ29tcGxldGUgYSB0YXNrLlxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIGFwcFxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhc2sgdG8gY29tcGxldGVcbiAgICAgKiBAcmV0dXJucyBEZXRhaWxzIG9mIHRoZSB0YXNrIHRoYXQgd2FzIGNvbXBsZXRlZFxuICAgICAqL1xuICAgIGNvbXBsZXRlVGFzayhhcHBOYW1lOiBzdHJpbmcsIHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc0Nsb3VkTW9kZWw+IHtcbiAgICAgICAgaWYgKChhcHBOYW1lIHx8IGFwcE5hbWUgPT09ICcnKSAmJiB0YXNrSWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHVybCA9IGAke3RoaXMuZ2V0QmFzZVBhdGgoYXBwTmFtZSl9L3JiL3YxL3Rhc2tzLyR7dGFza0lkfS9jb21wbGV0ZWA7XG4gICAgICAgICAgICBjb25zdCBwYXlsb2FkID0geyAncGF5bG9hZFR5cGUnOiAnQ29tcGxldGVUYXNrUGF5bG9hZCcgfTtcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9zdDxhbnksIFRhc2tEZXRhaWxzQ2xvdWRNb2RlbD4odXJsLCBwYXlsb2FkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcignQXBwTmFtZSBhbmQgVGFza0lkIGFyZSBtYW5kYXRvcnkgZm9yIGNvbXBsZXRlIGEgdGFzaycpO1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ0FwcE5hbWUvVGFza0lkIG5vdCBjb25maWd1cmVkJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBWYWxpZGF0ZSBpZiBhIHRhc2sgY2FuIGJlIGNvbXBsZXRlZC5cbiAgICAgKiBAcGFyYW0gdGFza0RldGFpbHMgdGFzayBkZXRhaWxzIG9iamVjdFxuICAgICAqIEByZXR1cm5zIEJvb2xlYW4gdmFsdWUgaWYgdGhlIHRhc2sgY2FuIGJlIGNvbXBsZXRlZFxuICAgICAqL1xuICAgIGNhbkNvbXBsZXRlVGFzayh0YXNrRGV0YWlsczogVGFza0RldGFpbHNDbG91ZE1vZGVsKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0YXNrRGV0YWlscyAmJiB0YXNrRGV0YWlscy5zdGF0dXMgPT09IFRBU0tfQVNTSUdORURfU1RBVEUgJiYgdGhpcy5pc0Fzc2lnbmVkVG9NZSh0YXNrRGV0YWlscy5hc3NpZ25lZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVmFsaWRhdGUgaWYgYSB0YXNrIGlzIGVkaXRhYmxlLlxuICAgICAqIEBwYXJhbSB0YXNrRGV0YWlscyB0YXNrIGRldGFpbHMgb2JqZWN0XG4gICAgICogQHJldHVybnMgQm9vbGVhbiB2YWx1ZSBpZiB0aGUgdGFzayBpcyBlZGl0YWJsZVxuICAgICAqL1xuICAgIGlzVGFza0VkaXRhYmxlKHRhc2tEZXRhaWxzOiBUYXNrRGV0YWlsc0Nsb3VkTW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRhc2tEZXRhaWxzICYmIHRhc2tEZXRhaWxzLnN0YXR1cyA9PT0gVEFTS19BU1NJR05FRF9TVEFURSAmJiB0aGlzLmlzQXNzaWduZWRUb01lKHRhc2tEZXRhaWxzLmFzc2lnbmVlKTtcbiAgICB9XG5cbiAgICBpc0Fzc2lnbmVlUHJvcGVydHlDbGlja2FibGUodGFza0RldGFpbHM6IFRhc2tEZXRhaWxzQ2xvdWRNb2RlbCwgY2FuZGlkYXRlVXNlcnM6IENhcmRWaWV3QXJyYXlJdGVtW10sIGNhbmRpZGF0ZUdyb3VwczogQ2FyZFZpZXdBcnJheUl0ZW1bXSk6IGJvb2xlYW4ge1xuICAgICAgICBsZXQgaXNDbGlja2FibGUgPSBmYWxzZTtcbiAgICAgICAgY29uc3Qgc3RhdGVzID0gW1RBU0tfQVNTSUdORURfU1RBVEVdO1xuICAgICAgICBpZiAoY2FuZGlkYXRlVXNlcnM/Lmxlbmd0aCB8fCBjYW5kaWRhdGVHcm91cHM/Lmxlbmd0aCkge1xuICAgICAgICAgICAgaXNDbGlja2FibGUgPSBzdGF0ZXMuaW5jbHVkZXModGFza0RldGFpbHMuc3RhdHVzKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaXNDbGlja2FibGU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVmFsaWRhdGUgaWYgYSB0YXNrIGNhbiBiZSBjbGFpbWVkLlxuICAgICAqIEBwYXJhbSB0YXNrRGV0YWlscyB0YXNrIGRldGFpbHMgb2JqZWN0XG4gICAgICogQHJldHVybnMgQm9vbGVhbiB2YWx1ZSBpZiB0aGUgdGFzayBjYW4gYmUgY29tcGxldGVkXG4gICAgICovXG4gICAgY2FuQ2xhaW1UYXNrKHRhc2tEZXRhaWxzOiBUYXNrRGV0YWlsc0Nsb3VkTW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRhc2tEZXRhaWxzICYmIHRhc2tEZXRhaWxzLnN0YXR1cyA9PT0gVEFTS19DUkVBVEVEX1NUQVRFO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFZhbGlkYXRlIGlmIGEgdGFzayBjYW4gYmUgdW5jbGFpbWVkLlxuICAgICAqIEBwYXJhbSB0YXNrRGV0YWlscyB0YXNrIGRldGFpbHMgb2JqZWN0XG4gICAgICogQHJldHVybnMgQm9vbGVhbiB2YWx1ZSBpZiB0aGUgdGFzayBjYW4gYmUgY29tcGxldGVkXG4gICAgICovXG4gICAgY2FuVW5jbGFpbVRhc2sodGFza0RldGFpbHM6IFRhc2tEZXRhaWxzQ2xvdWRNb2RlbCk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBjdXJyZW50VXNlciA9IHRoaXMuaWRlbnRpdHlVc2VyU2VydmljZS5nZXRDdXJyZW50VXNlckluZm8oKS51c2VybmFtZTtcbiAgICAgICAgcmV0dXJuIHRhc2tEZXRhaWxzICYmIHRhc2tEZXRhaWxzLnN0YXR1cyA9PT0gVEFTS19BU1NJR05FRF9TVEFURSAmJiB0YXNrRGV0YWlscy5hc3NpZ25lZSA9PT0gY3VycmVudFVzZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xhaW1zIGEgdGFzayBmb3IgYW4gYXNzaWduZWUuXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgYXBwXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFzayB0byBjbGFpbVxuICAgICAqIEBwYXJhbSBhc3NpZ25lZSBVc2VyIHRvIGFzc2lnbiB0aGUgdGFzayB0b1xuICAgICAqIEByZXR1cm5zIERldGFpbHMgb2YgdGhlIGNsYWltZWQgdGFza1xuICAgICAqL1xuICAgIGNsYWltVGFzayhhcHBOYW1lOiBzdHJpbmcsIHRhc2tJZDogc3RyaW5nLCBhc3NpZ25lZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc0Nsb3VkTW9kZWw+IHtcbiAgICAgICAgaWYgKChhcHBOYW1lIHx8IGFwcE5hbWUgPT09ICcnKSAmJiB0YXNrSWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHF1ZXJ5VXJsID0gYCR7dGhpcy5nZXRCYXNlUGF0aChhcHBOYW1lKX0vcmIvdjEvdGFza3MvJHt0YXNrSWR9L2NsYWltP2Fzc2lnbmVlPSR7YXNzaWduZWV9YDtcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9zdChxdWVyeVVybCkucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlczogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YUNoYW5nZXNEZXRlY3RlZCQubmV4dCgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLmVudHJ5O1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKCdBcHBOYW1lIGFuZCBUYXNrSWQgYXJlIG1hbmRhdG9yeSBmb3IgcXVlcnlpbmcgYSB0YXNrJyk7XG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcignQXBwTmFtZS9UYXNrSWQgbm90IGNvbmZpZ3VyZWQnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVuLWNsYWltcyBhIHRhc2suXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgYXBwXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFzayB0byB1bmNsYWltXG4gICAgICogQHJldHVybnMgRGV0YWlscyBvZiB0aGUgdGFzayB0aGF0IHdhcyB1bmNsYWltZWRcbiAgICAgKi9cbiAgICB1bmNsYWltVGFzayhhcHBOYW1lOiBzdHJpbmcsIHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc0Nsb3VkTW9kZWw+IHtcbiAgICAgICAgaWYgKChhcHBOYW1lIHx8IGFwcE5hbWUgPT09ICcnKSAmJiB0YXNrSWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHF1ZXJ5VXJsID0gYCR7dGhpcy5nZXRCYXNlUGF0aChhcHBOYW1lKX0vcmIvdjEvdGFza3MvJHt0YXNrSWR9L3JlbGVhc2VgO1xuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wb3N0KHF1ZXJ5VXJsKS5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXRhQ2hhbmdlc0RldGVjdGVkJC5uZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXMuZW50cnk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoJ0FwcE5hbWUgYW5kIFRhc2tJZCBhcmUgbWFuZGF0b3J5IGZvciBxdWVyeWluZyBhIHRhc2snKTtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdBcHBOYW1lL1Rhc2tJZCBub3QgY29uZmlndXJlZCcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBkZXRhaWxzIG9mIGEgdGFzay5cbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSBhcHBcbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXNrIHdob3NlIGRldGFpbHMgeW91IHdhbnRcbiAgICAgKiBAcmV0dXJucyBUYXNrIGRldGFpbHNcbiAgICAgKi9cbiAgICBnZXRUYXNrQnlJZChhcHBOYW1lOiBzdHJpbmcsIHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc0Nsb3VkTW9kZWw+IHtcbiAgICAgICAgaWYgKChhcHBOYW1lIHx8IGFwcE5hbWUgPT09ICcnKSAmJiB0YXNrSWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHF1ZXJ5VXJsID0gYCR7dGhpcy5nZXRCYXNlUGF0aChhcHBOYW1lKX0vcXVlcnkvdjEvdGFza3MvJHt0YXNrSWR9YDtcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KHF1ZXJ5VXJsKS5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzOiBhbnkpID0+IHJlcy5lbnRyeSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoJ0FwcE5hbWUgYW5kIFRhc2tJZCBhcmUgbWFuZGF0b3J5IGZvciBxdWVyeWluZyBhIHRhc2snKTtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdBcHBOYW1lL1Rhc2tJZCBub3QgY29uZmlndXJlZCcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgIC8qKlxuICAgICAgKiBDcmVhdGVzIGEgbmV3IHN0YW5kYWxvbmUgdGFzay5cbiAgICAgICogQHBhcmFtIHRhc2tEZXRhaWxzIERldGFpbHMgb2YgdGhlIHRhc2sgdG8gY3JlYXRlXG4gICAgICAqIEByZXR1cm5zIERldGFpbHMgb2YgdGhlIG5ld2x5IGNyZWF0ZWQgdGFza1xuICAgICAgKi9cbiAgICBjcmVhdGVOZXdUYXNrKHN0YXJ0VGFza1JlcXVlc3Q6IFN0YXJ0VGFza0Nsb3VkUmVxdWVzdE1vZGVsLCBhcHBOYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzQ2xvdWRNb2RlbD4ge1xuICAgICAgICBjb25zdCBxdWVyeVVybCA9IGAke3RoaXMuZ2V0QmFzZVBhdGgoYXBwTmFtZSl9L3JiL3YxL3Rhc2tzYDtcbiAgICAgICAgY29uc3QgcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KG5ldyBTdGFydFRhc2tDbG91ZFJlcXVlc3RNb2RlbChzdGFydFRhc2tSZXF1ZXN0KSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMucG9zdDxhbnksIFN0YXJ0VGFza0Nsb3VkUmVzcG9uc2VNb2RlbD4ocXVlcnlVcmwsIHBheWxvYWQpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAocmVzcG9uc2UgPT4gcmVzcG9uc2UuZW50cnkpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZXMgdGhlIGRldGFpbHMgKG5hbWUsIGRlc2NyaXB0aW9uLCBkdWUgZGF0ZSkgZm9yIGEgdGFzay5cbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSBhcHBcbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXNrIHRvIHVwZGF0ZVxuICAgICAqIEBwYXJhbSBwYXlsb2FkIERhdGEgdG8gdXBkYXRlIHRoZSB0YXNrXG4gICAgICogQHJldHVybnMgVXBkYXRlZCB0YXNrIGRldGFpbHNcbiAgICAgKi9cbiAgICB1cGRhdGVUYXNrKGFwcE5hbWU6IHN0cmluZywgdGFza0lkOiBzdHJpbmcsIHBheWxvYWQ6IGFueSk6IE9ic2VydmFibGU8VGFza0RldGFpbHNDbG91ZE1vZGVsPiB7XG4gICAgICAgIGlmICgoYXBwTmFtZSB8fCBhcHBOYW1lID09PSAnJykgJiYgdGFza0lkKSB7XG4gICAgICAgICAgICBwYXlsb2FkLnBheWxvYWRUeXBlID0gJ1VwZGF0ZVRhc2tQYXlsb2FkJztcbiAgICAgICAgICAgIGNvbnN0IHF1ZXJ5VXJsID0gYCR7dGhpcy5nZXRCYXNlUGF0aChhcHBOYW1lKX0vcmIvdjEvdGFza3MvJHt0YXNrSWR9YDtcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucHV0KHF1ZXJ5VXJsLCBwYXlsb2FkKS5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzOiBhbnkpID0+IHJlcy5lbnRyeSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoJ0FwcE5hbWUgYW5kIFRhc2tJZCBhcmUgbWFuZGF0b3J5IGZvciBxdWVyeWluZyBhIHRhc2snKTtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdBcHBOYW1lL1Rhc2tJZCBub3QgY29uZmlndXJlZCcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBjYW5kaWRhdGUgdXNlcnMgb2YgdGhlIHRhc2suXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgYXBwXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFza1xuICAgICAqIEByZXR1cm5zIENhbmRpZGF0ZSB1c2Vyc1xuICAgICAqL1xuICAgIGdldENhbmRpZGF0ZVVzZXJzKGFwcE5hbWU6IHN0cmluZywgdGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZ1tdPiB7XG4gICAgICAgIGlmICgoYXBwTmFtZSB8fCBhcHBOYW1lID09PSAnJykgJiYgdGFza0lkKSB7XG4gICAgICAgICAgICBjb25zdCBxdWVyeVVybCA9IGAke3RoaXMuZ2V0QmFzZVBhdGgoYXBwTmFtZSl9L3F1ZXJ5L3YxL3Rhc2tzLyR7dGFza0lkfS9jYW5kaWRhdGUtdXNlcnNgO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0PHN0cmluZ1tdPihxdWVyeVVybCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoJ0FwcE5hbWUgYW5kIFRhc2tJZCBhcmUgbWFuZGF0b3J5IHRvIGdldCBjYW5kaWRhdGUgdXNlcicpO1xuICAgICAgICAgICAgcmV0dXJuIG9mKFtdKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgY2FuZGlkYXRlIGdyb3VwcyBvZiB0aGUgdGFzay5cbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSBhcHBcbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXNrXG4gICAgICogQHJldHVybnMgQ2FuZGlkYXRlIGdyb3Vwc1xuICAgICAqL1xuICAgIGdldENhbmRpZGF0ZUdyb3VwcyhhcHBOYW1lOiBzdHJpbmcsIHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmdbXT4ge1xuICAgICAgICBpZiAoKGFwcE5hbWUgfHwgYXBwTmFtZSA9PT0gJycpICYmIHRhc2tJZCkge1xuICAgICAgICAgICAgY29uc3QgcXVlcnlVcmwgPSBgJHt0aGlzLmdldEJhc2VQYXRoKGFwcE5hbWUpfS9xdWVyeS92MS90YXNrcy8ke3Rhc2tJZH0vY2FuZGlkYXRlLWdyb3Vwc2A7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQ8c3RyaW5nW10+KHF1ZXJ5VXJsKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcignQXBwTmFtZSBhbmQgVGFza0lkIGFyZSBtYW5kYXRvcnkgdG8gZ2V0IGNhbmRpZGF0ZSBncm91cHMnKTtcbiAgICAgICAgICAgIHJldHVybiBvZihbXSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBwcm9jZXNzIGRlZmluaXRpb25zIGFzc29jaWF0ZWQgd2l0aCBhbiBhcHAuXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIHByb2Nlc3MgZGVmaW5pdGlvbnNcbiAgICAgKi9cbiAgICBnZXRQcm9jZXNzRGVmaW5pdGlvbnMoYXBwTmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxQcm9jZXNzRGVmaW5pdGlvbkNsb3VkW10+IHtcbiAgICAgICAgaWYgKGFwcE5hbWUgfHwgYXBwTmFtZSA9PT0gJycpIHtcbiAgICAgICAgICAgIGNvbnN0IHVybCA9IGAke3RoaXMuZ2V0QmFzZVBhdGgoYXBwTmFtZSl9L3JiL3YxL3Byb2Nlc3MtZGVmaW5pdGlvbnNgO1xuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQodXJsKS5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5saXN0LmVudHJpZXMubWFwKChwcm9jZXNzRGVmcykgPT4gbmV3IFByb2Nlc3NEZWZpbml0aW9uQ2xvdWQocHJvY2Vzc0RlZnMuZW50cnkpKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcignQXBwTmFtZSBpcyBtYW5kYXRvcnkgZm9yIHF1ZXJ5aW5nIHRhc2snKTtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdBcHBOYW1lIG5vdCBjb25maWd1cmVkJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSB0YXNrIGFzc2lnbmVlLlxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIGFwcFxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhc2sgdG8gdXBkYXRlIGFzc2lnbmVlXG4gICAgICogQHBhcmFtIGFzc2lnbmVlIGFzc2lnbmVlIHRvIHVwZGF0ZSBjdXJyZW50IHVzZXIgdGFzayBhc3NpZ25lZVxuICAgICAqIEByZXR1cm5zIFVwZGF0ZWQgdGFzayBkZXRhaWxzIHdpdGggbmV3IGFzc2lnbmVlXG4gICAgICovXG4gICAgYXNzaWduKGFwcE5hbWU6IHN0cmluZywgdGFza0lkOiBzdHJpbmcsIGFzc2lnbmVlOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzQ2xvdWRNb2RlbD4ge1xuICAgICAgICBpZiAoYXBwTmFtZSAmJiB0YXNrSWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHBheUxvYWQgPSB7ICdhc3NpZ25lZSc6IGFzc2lnbmVlLCAndGFza0lkJzogdGFza0lkLCAncGF5bG9hZFR5cGUnOiAnQXNzaWduVGFza1BheWxvYWQnIH07XG4gICAgICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmdldEJhc2VQYXRoKGFwcE5hbWUpfS9yYi92MS90YXNrcy8ke3Rhc2tJZH0vYXNzaWduYDtcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9zdCh1cmwsIHBheUxvYWQpLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXM6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLmVudHJ5O1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKCdBcHBOYW1lIGFuZCBUYXNrSWQgYXJlIG1hbmRhdG9yeSB0byBjaGFuZ2UvdXBkYXRlIHRoZSB0YXNrIGFzc2lnbmVlJyk7XG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcignQXBwTmFtZS9UYXNrSWQgbm90IGNvbmZpZ3VyZWQnKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgZ2V0UHJpb3JpdHlMYWJlbChwcmlvcml0eTogbnVtYmVyKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgcHJpb3JpdHlJdGVtID0gdGhpcy5wcmlvcml0aWVzLmZpbmQoaXRlbSA9PiBpdGVtLnZhbHVlID09PSBwcmlvcml0eS50b1N0cmluZygpKSB8fCB0aGlzLnByaW9yaXRpZXNbMF07XG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudChwcmlvcml0eUl0ZW0ubGFiZWwpO1xuICAgIH1cblxuICAgIGdldCBwcmlvcml0aWVzKCk6IFRhc2tQcmlvcml0eU9wdGlvbltdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwQ29uZmlnU2VydmljZS5nZXQoJ2FkZi1jbG91ZC1wcmlvcml0eS12YWx1ZXMnKSB8fCBERUZBVUxUX1RBU0tfUFJJT1JJVElFUztcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzQXNzaWduZWRUb01lKGFzc2lnbmVlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgY3VycmVudFVzZXIgPSB0aGlzLmlkZW50aXR5VXNlclNlcnZpY2UuZ2V0Q3VycmVudFVzZXJJbmZvKCkudXNlcm5hbWU7XG4gICAgICAgIHJldHVybiBhc3NpZ25lZSA9PT0gY3VycmVudFVzZXI7XG4gICAgfVxufVxuIl19