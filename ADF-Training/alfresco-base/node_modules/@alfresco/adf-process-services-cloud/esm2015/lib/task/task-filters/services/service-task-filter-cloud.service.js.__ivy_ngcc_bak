import { IdentityUserService } from '@alfresco/adf-core';
import { Injectable, Inject } from '@angular/core';
import { of, BehaviorSubject } from 'rxjs';
import { switchMap, map } from 'rxjs/operators';
import { TASK_FILTERS_SERVICE_TOKEN } from '../../../services/cloud-token.service';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as i2 from "../../../services/cloud-token.service";
export class ServiceTaskFilterCloudService {
    constructor(identityUserService, preferenceService) {
        this.identityUserService = identityUserService;
        this.preferenceService = preferenceService;
        this.filtersSubject = new BehaviorSubject([]);
        this.filters$ = this.filtersSubject.asObservable();
    }
    createDefaultFilters(appName) {
        const key = this.prepareKey(appName);
        this.preferenceService.getPreferences(appName, key).pipe(switchMap((response) => {
            const preferences = (response && response.list && response.list.entries) ? response.list.entries : [];
            if (!this.hasPreferences(preferences) || !this.hasTaskFilters(preferences, key)) {
                return this.createTaskFilters(appName, key, this.defaultServiceTaskFilters(appName));
            }
            else {
                return of(this.findFiltersByKeyInPreferences(preferences, key));
            }
        })).subscribe((filters) => {
            this.addFiltersToStream(filters);
        });
    }
    hasPreferences(preferences) {
        return preferences && preferences.length > 0;
    }
    hasTaskFilters(preferences, key) {
        const filters = preferences.find((filter) => { return filter.entry.key === key; });
        return (filters && filters.entry) ? JSON.parse(filters.entry.value).length > 0 : false;
    }
    createTaskFilters(appName, key, filters) {
        return this.preferenceService.createPreference(appName, key, filters);
    }
    getTaskFiltersByKey(appName, key) {
        return this.preferenceService.getPreferenceByKey(appName, key);
    }
    getTaskListFilters(appName) {
        this.createDefaultFilters(appName);
        return this.filters$;
    }
    getTaskFilterById(appName, id) {
        const key = this.prepareKey(appName);
        return this.getTaskFiltersByKey(appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length === 0) {
                return this.createTaskFilters(appName, key, this.defaultServiceTaskFilters(appName));
            }
            else {
                return of(filters);
            }
        }), map((filters) => {
            return filters.filter((filter) => {
                return filter.id === id;
            })[0];
        }));
    }
    addFilter(newFilter) {
        const key = this.prepareKey(newFilter.appName);
        return this.getTaskFiltersByKey(newFilter.appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length === 0) {
                return this.createTaskFilters(newFilter.appName, key, [newFilter]);
            }
            else {
                filters.push(newFilter);
                return this.preferenceService.updatePreference(newFilter.appName, key, filters);
            }
        }), map((filters) => {
            this.addFiltersToStream(filters);
            return filters;
        }));
    }
    addFiltersToStream(filters) {
        this.filtersSubject.next(filters);
    }
    updateFilter(updatedFilter) {
        const key = this.prepareKey(updatedFilter.appName);
        return this.getTaskFiltersByKey(updatedFilter.appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length === 0) {
                return this.createTaskFilters(updatedFilter.appName, key, [updatedFilter]);
            }
            else {
                const itemIndex = filters.findIndex((filter) => filter.id === updatedFilter.id);
                filters[itemIndex] = updatedFilter;
                return this.updateTaskFilters(updatedFilter.appName, key, filters);
            }
        }), map((updatedFilters) => {
            this.addFiltersToStream(updatedFilters);
            return updatedFilters;
        }));
    }
    deleteFilter(deletedFilter) {
        const key = this.prepareKey(deletedFilter.appName);
        return this.getTaskFiltersByKey(deletedFilter.appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length > 0) {
                filters = filters.filter(filter => filter.id !== deletedFilter.id);
                return this.updateTaskFilters(deletedFilter.appName, key, filters);
            }
            return of([]);
        }), map(filters => {
            this.addFiltersToStream(filters);
            return filters;
        }));
    }
    isDefaultFilter(filterName) {
        const defaultFilters = this.defaultServiceTaskFilters();
        return defaultFilters.findIndex((filter) => filterName === filter.name) !== -1;
    }
    updateTaskFilters(appName, key, filters) {
        return this.preferenceService.updatePreference(appName, key, filters);
    }
    prepareKey(appName) {
        return `service-task-filters-${appName}-${this.identityUserService.getCurrentUserInfo().username}`;
    }
    findFiltersByKeyInPreferences(preferences, key) {
        const result = preferences.find((filter) => { return filter.entry.key === key; });
        return result && result.entry ? JSON.parse(result.entry.value) : [];
    }
    defaultServiceTaskFilters(appName) {
        return [
            {
                id: this.generateRandomId(),
                name: 'ADF_CLOUD_SERVICE_TASK_FILTERS.ALL_SERVICE_TASKS',
                key: 'my-service-tasks',
                icon: 'inbox',
                appName,
                status: '',
                sort: 'startedDate',
                order: 'DESC'
            },
            {
                id: this.generateRandomId(),
                name: 'ADF_CLOUD_SERVICE_TASK_FILTERS.COMPLETED_TASKS',
                key: 'completed-tasks',
                icon: 'done',
                appName,
                status: 'COMPLETED',
                sort: 'completedDate',
                order: 'DESC'
            },
            {
                id: this.generateRandomId(),
                name: 'ADF_CLOUD_SERVICE_TASK_FILTERS.ERRORED_TASKS',
                key: 'errored-service-tasks',
                icon: 'error',
                appName,
                status: 'ERROR',
                sort: 'startedDate',
                order: 'DESC'
            }
        ];
    }
    generateRandomId() {
        return Math.random().toString(36).substr(2, 9);
    }
}
ServiceTaskFilterCloudService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ServiceTaskFilterCloudService_Factory() { return new ServiceTaskFilterCloudService(i0.ɵɵinject(i1.IdentityUserService), i0.ɵɵinject(i2.TASK_FILTERS_SERVICE_TOKEN)); }, token: ServiceTaskFilterCloudService, providedIn: "root" });
ServiceTaskFilterCloudService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
ServiceTaskFilterCloudService.ctorParameters = () => [
    { type: IdentityUserService },
    { type: undefined, decorators: [{ type: Inject, args: [TASK_FILTERS_SERVICE_TOKEN,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS10YXNrLWZpbHRlci1jbG91ZC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvcHJvY2Vzcy1zZXJ2aWNlcy1jbG91ZC9zcmMvIiwic291cmNlcyI6WyJsaWIvdGFzay90YXNrLWZpbHRlcnMvc2VydmljZXMvc2VydmljZS10YXNrLWZpbHRlci1jbG91ZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQWMsRUFBRSxFQUFFLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUV2RCxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWhELE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLHVDQUF1QyxDQUFDOzs7O0FBS25GLE1BQU0sT0FBTyw2QkFBNkI7SUFJdEMsWUFDWSxtQkFBd0MsRUFFekMsaUJBQWtEO1FBRmpELHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFFekMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFpQztRQUV6RCxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzlDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUN2RCxDQUFDO0lBT08sb0JBQW9CLENBQUMsT0FBZTtRQUN4QyxNQUFNLEdBQUcsR0FBVyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLElB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TTthQUNlO1NBQ25DLENBQUM7SUFDTixDQUFDO0lBRUQsZ0JBQWdCO1FBQ1osT0FBTyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDbkQsQ0FBQzs7OztZQTVRSixVQUFVLFNBQUM7Z0JBQ1IsVUFBVSxFQUFFLE1BQU07YUFDckI7OztZQVZRLG1CQUFtQjs0Q0FpQm5CLE1BQU0sU0FBQywwQkFBMEIiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBJZGVudGl0eVVzZXJTZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgU2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL2ZpbHRlci1jbG91ZC5tb2RlbCc7XG5pbXBvcnQgeyBzd2l0Y2hNYXAsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFByZWZlcmVuY2VDbG91ZFNlcnZpY2VJbnRlcmZhY2UgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9wcmVmZXJlbmNlLWNsb3VkLmludGVyZmFjZSc7XG5pbXBvcnQgeyBUQVNLX0ZJTFRFUlNfU0VSVklDRV9UT0tFTiB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL2Nsb3VkLXRva2VuLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRTZXJ2aWNlIHtcbiAgICBwcml2YXRlIGZpbHRlcnNTdWJqZWN0OiBCZWhhdmlvclN1YmplY3Q8U2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsW10+O1xuICAgIGZpbHRlcnMkOiBPYnNlcnZhYmxlPFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdPjtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGlkZW50aXR5VXNlclNlcnZpY2U6IElkZW50aXR5VXNlclNlcnZpY2UsXG4gICAgICAgIEBJbmplY3QoVEFTS19GSUxURVJTX1NFUlZJQ0VfVE9LRU4pXG4gICAgICAgIHB1YmxpYyBwcmVmZXJlbmNlU2VydmljZTogUHJlZmVyZW5jZUNsb3VkU2VydmljZUludGVyZmFjZVxuICAgICkge1xuICAgICAgICB0aGlzLmZpbHRlcnNTdWJqZWN0ID0gbmV3IEJlaGF2aW9yU3ViamVjdChbXSk7XG4gICAgICAgIHRoaXMuZmlsdGVycyQgPSB0aGlzLmZpbHRlcnNTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYW5kIHJldHVybnMgdGhlIGRlZmF1bHQgdGFzayBmaWx0ZXJzIGZvciBhbiBhcHAuXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGUgb2YgZGVmYXVsdCBmaWx0ZXJzIHRhc2sgZmlsdGVycyBqdXN0IGNyZWF0ZWQgb3IgY3JlYXRlZCBmaWx0ZXJzXG4gICAgICovXG4gICAgcHJpdmF0ZSBjcmVhdGVEZWZhdWx0RmlsdGVycyhhcHBOYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3Qga2V5OiBzdHJpbmcgPSB0aGlzLnByZXBhcmVLZXkoYXBwTmFtZSk7XG4gICAgICAgIHRoaXMucHJlZmVyZW5jZVNlcnZpY2UuZ2V0UHJlZmVyZW5jZXMoYXBwTmFtZSwga2V5KS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcHJlZmVyZW5jZXMgPSAocmVzcG9uc2UgJiYgcmVzcG9uc2UubGlzdCAmJiByZXNwb25zZS5saXN0LmVudHJpZXMpID8gcmVzcG9uc2UubGlzdC5lbnRyaWVzIDogW107XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc1ByZWZlcmVuY2VzKHByZWZlcmVuY2VzKSB8fCAhdGhpcy5oYXNUYXNrRmlsdGVycyhwcmVmZXJlbmNlcywga2V5KSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVUYXNrRmlsdGVycyhhcHBOYW1lLCBrZXksIHRoaXMuZGVmYXVsdFNlcnZpY2VUYXNrRmlsdGVycyhhcHBOYW1lKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKHRoaXMuZmluZEZpbHRlcnNCeUtleUluUHJlZmVyZW5jZXMocHJlZmVyZW5jZXMsIGtleSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICkuc3Vic2NyaWJlKChmaWx0ZXJzKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmFkZEZpbHRlcnNUb1N0cmVhbShmaWx0ZXJzKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIHVzZXIgcHJlZmVyZW5jZSBhcmUgZW1wdHkgb3Igbm90XG4gICAgICogQHBhcmFtIHByZWZlcmVuY2VzIFVzZXIgcHJlZmVyZW5jZXMgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcmV0dXJucyBCb29sZWFuIHZhbHVlIGlmIHRoZSBwcmVmZXJlbmNlcyBhcmUgbm90IGVtcHR5XG4gICAgICovXG4gICAgcHJpdmF0ZSBoYXNQcmVmZXJlbmNlcyhwcmVmZXJlbmNlczogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBwcmVmZXJlbmNlcyAmJiBwcmVmZXJlbmNlcy5sZW5ndGggPiAwO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBmb3IgdGFzayBmaWx0ZXJzIGluIGdpdmVuIHVzZXIgcHJlZmVyZW5jZXNcbiAgICAgKiBAcGFyYW0gcHJlZmVyZW5jZXMgVXNlciBwcmVmZXJlbmNlcyBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSB0YXNrIGZpbHRlcnNcbiAgICAgKiBAcGFyYW0gZmlsdGVycyBEZXRhaWxzIG9mIGNyZWF0ZSBmaWx0ZXJcbiAgICAgKiBAcmV0dXJucyBCb29sZWFuIHZhbHVlIGlmIHRoZSBwcmVmZXJlbmNlIGhhcyB0YXNrIGZpbHRlcnNcbiAgICAgKi9cbiAgICBwcml2YXRlIGhhc1Rhc2tGaWx0ZXJzKHByZWZlcmVuY2VzOiBhbnksIGtleTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGZpbHRlcnMgPSBwcmVmZXJlbmNlcy5maW5kKChmaWx0ZXI6IGFueSkgPT4geyByZXR1cm4gZmlsdGVyLmVudHJ5LmtleSA9PT0ga2V5OyB9KTtcbiAgICAgICAgcmV0dXJuIChmaWx0ZXJzICYmIGZpbHRlcnMuZW50cnkpID8gSlNPTi5wYXJzZShmaWx0ZXJzLmVudHJ5LnZhbHVlKS5sZW5ndGggPiAwIDogZmFsc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsbHMgY3JlYXRlIHByZWZlcmVuY2UgYXBpIHRvIGNyZWF0ZSB0YXNrIGZpbHRlcnNcbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHBhcmFtIGtleSBLZXkgb2YgdGhlIHRhc2sgaW5zdGFuY2UgZmlsdGVyc1xuICAgICAqIEBwYXJhbSBmaWx0ZXJzIERldGFpbHMgb2YgbmV3IHRhc2sgZmlsdGVyXG4gICAgICogQHJldHVybnMgT2JzZXJ2YWJsZSBvZiBjcmVhdGVkIHRhc2sgZmlsdGVyc1xuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlVGFza0ZpbHRlcnMoYXBwTmFtZTogc3RyaW5nLCBrZXk6IHN0cmluZywgZmlsdGVyczogU2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsW10pOiBPYnNlcnZhYmxlPFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnByZWZlcmVuY2VTZXJ2aWNlLmNyZWF0ZVByZWZlcmVuY2UoYXBwTmFtZSwga2V5LCBmaWx0ZXJzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxscyBnZXQgcHJlZmVyZW5jZSBhcGkgdG8gZ2V0IHRhc2sgZmlsdGVyIGJ5IHByZWZlcmVuY2Uga2V5XG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSB0YXNrIGZpbHRlcnNcbiAgICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIG9mIHRhc2sgZmlsdGVyc1xuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0VGFza0ZpbHRlcnNCeUtleShhcHBOYW1lOiBzdHJpbmcsIGtleTogc3RyaW5nKTogT2JzZXJ2YWJsZTxTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcmVmZXJlbmNlU2VydmljZS5nZXRQcmVmZXJlbmNlQnlLZXkoYXBwTmFtZSwga2V5KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGFsbCB0YXNrIGZpbHRlcnMgZm9yIGEgdGFzayBhcHAuXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGUgb2YgdGFzayBmaWx0ZXIgZGV0YWlsc1xuICAgICAqL1xuICAgIGdldFRhc2tMaXN0RmlsdGVycyhhcHBOYW1lPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXT4ge1xuICAgICAgICB0aGlzLmNyZWF0ZURlZmF1bHRGaWx0ZXJzKGFwcE5hbWUpO1xuICAgICAgICByZXR1cm4gdGhpcy5maWx0ZXJzJDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGEgdGFzayBmaWx0ZXIuXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEBwYXJhbSBpZCBJRCBvZiB0aGUgdGFza1xuICAgICAqIEByZXR1cm5zIERldGFpbHMgb2YgdGhlIHRhc2sgZmlsdGVyXG4gICAgICovXG4gICAgZ2V0VGFza0ZpbHRlckJ5SWQoYXBwTmFtZTogc3RyaW5nLCBpZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWw+IHtcbiAgICAgICAgY29uc3Qga2V5OiBzdHJpbmcgPSB0aGlzLnByZXBhcmVLZXkoYXBwTmFtZSk7XG4gICAgICAgIHJldHVybiB0aGlzLmdldFRhc2tGaWx0ZXJzQnlLZXkoYXBwTmFtZSwga2V5KS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKChmaWx0ZXJzOiBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJzICYmIGZpbHRlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZVRhc2tGaWx0ZXJzKGFwcE5hbWUsIGtleSwgdGhpcy5kZWZhdWx0U2VydmljZVRhc2tGaWx0ZXJzKGFwcE5hbWUpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoZmlsdGVycyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBtYXAoKGZpbHRlcnM6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXJzLmZpbHRlcigoZmlsdGVyOiBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlci5pZCA9PT0gaWQ7XG4gICAgICAgICAgICAgICAgfSlbMF07XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBuZXcgdGFzayBmaWx0ZXIuXG4gICAgICogQHBhcmFtIGZpbHRlciBUaGUgbmV3IGZpbHRlciB0byBhZGRcbiAgICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIG9mIHRhc2sgaW5zdGFuY2UgZmlsdGVycyB3aXRoIG5ld2x5IGFkZGVkIGZpbHRlclxuICAgICAqL1xuICAgIGFkZEZpbHRlcihuZXdGaWx0ZXI6IFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbCk6IE9ic2VydmFibGU8U2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsW10+IHtcbiAgICAgICAgY29uc3Qga2V5OiBzdHJpbmcgPSB0aGlzLnByZXBhcmVLZXkobmV3RmlsdGVyLmFwcE5hbWUpO1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRUYXNrRmlsdGVyc0J5S2V5KG5ld0ZpbHRlci5hcHBOYW1lLCBrZXkpLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKGZpbHRlcnM6IFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGZpbHRlcnMgJiYgZmlsdGVycy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlVGFza0ZpbHRlcnMobmV3RmlsdGVyLmFwcE5hbWUsIGtleSwgPFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdPiBbbmV3RmlsdGVyXSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVycy5wdXNoKG5ld0ZpbHRlcik7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnByZWZlcmVuY2VTZXJ2aWNlLnVwZGF0ZVByZWZlcmVuY2UobmV3RmlsdGVyLmFwcE5hbWUsIGtleSwgZmlsdGVycyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBtYXAoKGZpbHRlcnM6IFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hZGRGaWx0ZXJzVG9TdHJlYW0oZmlsdGVycyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlcnM7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgYWRkRmlsdGVyc1RvU3RyZWFtKGZpbHRlcnM6IFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdKSB7XG4gICAgICAgIHRoaXMuZmlsdGVyc1N1YmplY3QubmV4dChmaWx0ZXJzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIGEgdGFzayBmaWx0ZXIuXG4gICAgICogQHBhcmFtIGZpbHRlciBUaGUgZmlsdGVyIHRvIHVwZGF0ZVxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGUgb2YgdGFzayBpbnN0YW5jZSBmaWx0ZXJzIHdpdGggdXBkYXRlZCBmaWx0ZXJcbiAgICAgKi9cbiAgICB1cGRhdGVGaWx0ZXIodXBkYXRlZEZpbHRlcjogU2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsKTogT2JzZXJ2YWJsZTxTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXT4ge1xuICAgICAgICBjb25zdCBrZXk6IHN0cmluZyA9IHRoaXMucHJlcGFyZUtleSh1cGRhdGVkRmlsdGVyLmFwcE5hbWUpO1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRUYXNrRmlsdGVyc0J5S2V5KHVwZGF0ZWRGaWx0ZXIuYXBwTmFtZSwga2V5KS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKChmaWx0ZXJzOiBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJzICYmIGZpbHRlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZVRhc2tGaWx0ZXJzKHVwZGF0ZWRGaWx0ZXIuYXBwTmFtZSwga2V5LCA8U2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsW10+IFt1cGRhdGVkRmlsdGVyXSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRlbUluZGV4ID0gZmlsdGVycy5maW5kSW5kZXgoKGZpbHRlcjogU2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsKSA9PiBmaWx0ZXIuaWQgPT09IHVwZGF0ZWRGaWx0ZXIuaWQpO1xuICAgICAgICAgICAgICAgICAgICBmaWx0ZXJzW2l0ZW1JbmRleF0gPSB1cGRhdGVkRmlsdGVyO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVUYXNrRmlsdGVycyh1cGRhdGVkRmlsdGVyLmFwcE5hbWUsIGtleSwgZmlsdGVycyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBtYXAoKHVwZGF0ZWRGaWx0ZXJzOiBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkRmlsdGVyc1RvU3RyZWFtKHVwZGF0ZWRGaWx0ZXJzKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlZEZpbHRlcnM7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlbGV0ZXMgYSB0YXNrIGZpbHRlclxuICAgICAqIEBwYXJhbSBmaWx0ZXIgVGhlIGZpbHRlciB0byBkZWxldGVcbiAgICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIG9mIHRhc2sgaW5zdGFuY2UgZmlsdGVycyB3aXRob3V0IGRlbGV0ZWQgZmlsdGVyXG4gICAgICovXG4gICAgZGVsZXRlRmlsdGVyKGRlbGV0ZWRGaWx0ZXI6IFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbCk6IE9ic2VydmFibGU8U2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsW10+IHtcbiAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5wcmVwYXJlS2V5KGRlbGV0ZWRGaWx0ZXIuYXBwTmFtZSk7XG4gICAgICAgIHJldHVybiB0aGlzLmdldFRhc2tGaWx0ZXJzQnlLZXkoZGVsZXRlZEZpbHRlci5hcHBOYW1lLCBrZXkpLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKGZpbHRlcnM6IFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGZpbHRlcnMgJiYgZmlsdGVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGZpbHRlcnMgPSBmaWx0ZXJzLmZpbHRlcihmaWx0ZXIgPT4gZmlsdGVyLmlkICE9PSBkZWxldGVkRmlsdGVyLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlVGFza0ZpbHRlcnMoZGVsZXRlZEZpbHRlci5hcHBOYW1lLCBrZXksIGZpbHRlcnMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gb2YoW10pO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBtYXAoZmlsdGVycyA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hZGRGaWx0ZXJzVG9TdHJlYW0oZmlsdGVycyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlcnM7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBpZiBnaXZlbiBmaWx0ZXIgaXMgYSBkZWZhdWx0IGZpbHRlclxuICAgICAqIEBwYXJhbSBmaWx0ZXJOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCB0YXNrIGZpbHRlclxuICAgICAqIEByZXR1cm5zIEJvb2xlYW4gdmFsdWUgZm9yIHdoZXRoZXIgdGhlIGZpbHRlciBpcyBhIGRlZmF1bHQgZmlsdGVyXG4gICAgICovXG4gICAgaXNEZWZhdWx0RmlsdGVyKGZpbHRlck5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBkZWZhdWx0RmlsdGVycyA9IHRoaXMuZGVmYXVsdFNlcnZpY2VUYXNrRmlsdGVycygpO1xuICAgICAgICByZXR1cm4gZGVmYXVsdEZpbHRlcnMuZmluZEluZGV4KChmaWx0ZXIpID0+IGZpbHRlck5hbWUgPT09IGZpbHRlci5uYW1lKSAhPT0gLTE7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsbHMgdXBkYXRlIHByZWZlcmVuY2UgYXBpIHRvIHVwZGF0ZSB0YXNrIGZpbHRlclxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcGFyYW0ga2V5IEtleSBvZiB0aGUgdGFzayBmaWx0ZXJzXG4gICAgICogQHBhcmFtIGZpbHRlcnMgRGV0YWlscyBvZiB1cGRhdGUgZmlsdGVyXG4gICAgICogQHJldHVybnMgT2JzZXJ2YWJsZSBvZiB1cGRhdGVkIHRhc2sgZmlsdGVyc1xuICAgICAqL1xuICAgIHByaXZhdGUgdXBkYXRlVGFza0ZpbHRlcnMoYXBwTmFtZTogc3RyaW5nLCBrZXk6IHN0cmluZywgZmlsdGVyczogU2VydmljZVRhc2tGaWx0ZXJDbG91ZE1vZGVsW10pOiBPYnNlcnZhYmxlPFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnByZWZlcmVuY2VTZXJ2aWNlLnVwZGF0ZVByZWZlcmVuY2UoYXBwTmFtZSwga2V5LCBmaWx0ZXJzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGEgdW5pcSBrZXkgd2l0aCBhcHBOYW1lIGFuZCB1c2VybmFtZVxuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcmV0dXJucyBTdHJpbmcgb2YgdGFzayBmaWx0ZXJzIHByZWZlcmVuY2Uga2V5XG4gICAgICovXG4gICAgcHJpdmF0ZSBwcmVwYXJlS2V5KGFwcE5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBgc2VydmljZS10YXNrLWZpbHRlcnMtJHthcHBOYW1lfS0ke3RoaXMuaWRlbnRpdHlVc2VyU2VydmljZS5nZXRDdXJyZW50VXNlckluZm8oKS51c2VybmFtZX1gO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZpbmRzIGFuZCByZXR1cm5zIHRoZSB0YXNrIGZpbHRlcnMgZnJvbSBwcmVmZXJlbmNlc1xuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBUYXNrRmlsdGVyQ2xvdWRNb2RlbFxuICAgICAqL1xuICAgIHByaXZhdGUgZmluZEZpbHRlcnNCeUtleUluUHJlZmVyZW5jZXMocHJlZmVyZW5jZXM6IGFueSwga2V5OiBzdHJpbmcpOiBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxbXSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHByZWZlcmVuY2VzLmZpbmQoKGZpbHRlcjogYW55KSA9PiB7IHJldHVybiBmaWx0ZXIuZW50cnkua2V5ID09PSBrZXk7IH0pO1xuICAgICAgICByZXR1cm4gcmVzdWx0ICYmIHJlc3VsdC5lbnRyeSA/IEpTT04ucGFyc2UocmVzdWx0LmVudHJ5LnZhbHVlKSA6IFtdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYW5kIHJldHVybnMgdGhlIGRlZmF1bHQgZmlsdGVycyBmb3IgYSB0YXNrIGFwcC5cbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgVGFza0ZpbHRlckNsb3VkTW9kZWxcbiAgICAgKi9cbiAgICBwcml2YXRlIGRlZmF1bHRTZXJ2aWNlVGFza0ZpbHRlcnMoYXBwTmFtZT86IHN0cmluZyk6IFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbFtdIHtcbiAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBpZDogdGhpcy5nZW5lcmF0ZVJhbmRvbUlkKCksXG4gICAgICAgICAgICAgICAgbmFtZTogJ0FERl9DTE9VRF9TRVJWSUNFX1RBU0tfRklMVEVSUy5BTExfU0VSVklDRV9UQVNLUycsXG4gICAgICAgICAgICAgICAga2V5OiAnbXktc2VydmljZS10YXNrcycsXG4gICAgICAgICAgICAgICAgaWNvbjogJ2luYm94JyxcbiAgICAgICAgICAgICAgICBhcHBOYW1lLFxuICAgICAgICAgICAgICAgIHN0YXR1czogJycsXG4gICAgICAgICAgICAgICAgc29ydDogJ3N0YXJ0ZWREYXRlJyxcbiAgICAgICAgICAgICAgICBvcmRlcjogJ0RFU0MnXG4gICAgICAgICAgICB9IGFzIFNlcnZpY2VUYXNrRmlsdGVyQ2xvdWRNb2RlbCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBpZDogdGhpcy5nZW5lcmF0ZVJhbmRvbUlkKCksXG4gICAgICAgICAgICAgICAgbmFtZTogJ0FERl9DTE9VRF9TRVJWSUNFX1RBU0tfRklMVEVSUy5DT01QTEVURURfVEFTS1MnLFxuICAgICAgICAgICAgICAgIGtleTogJ2NvbXBsZXRlZC10YXNrcycsXG4gICAgICAgICAgICAgICAgaWNvbjogJ2RvbmUnLFxuICAgICAgICAgICAgICAgIGFwcE5hbWUsXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnQ09NUExFVEVEJyxcbiAgICAgICAgICAgICAgICBzb3J0OiAnY29tcGxldGVkRGF0ZScsXG4gICAgICAgICAgICAgICAgb3JkZXI6ICdERVNDJ1xuICAgICAgICAgICAgfSBhcyBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWwsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgaWQ6IHRoaXMuZ2VuZXJhdGVSYW5kb21JZCgpLFxuICAgICAgICAgICAgICAgIG5hbWU6ICdBREZfQ0xPVURfU0VSVklDRV9UQVNLX0ZJTFRFUlMuRVJST1JFRF9UQVNLUycsXG4gICAgICAgICAgICAgICAga2V5OiAnZXJyb3JlZC1zZXJ2aWNlLXRhc2tzJyxcbiAgICAgICAgICAgICAgICBpY29uOiAnZXJyb3InLFxuICAgICAgICAgICAgICAgIGFwcE5hbWUsXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnRVJST1InLFxuICAgICAgICAgICAgICAgIHNvcnQ6ICdzdGFydGVkRGF0ZScsXG4gICAgICAgICAgICAgICAgb3JkZXI6ICdERVNDJ1xuICAgICAgICAgICAgfSBhcyBTZXJ2aWNlVGFza0ZpbHRlckNsb3VkTW9kZWxcbiAgICAgICAgXTtcbiAgICB9XG5cbiAgICBnZW5lcmF0ZVJhbmRvbUlkKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSk7XG4gICAgfVxufVxuIl19