import { IdentityUserService } from '@alfresco/adf-core';
import { Injectable, Inject } from '@angular/core';
import { of, BehaviorSubject, throwError } from 'rxjs';
import { ProcessFilterCloudModel } from '../models/process-filter-cloud.model';
import { switchMap, map, catchError } from 'rxjs/operators';
import { PROCESS_FILTERS_SERVICE_TOKEN } from '../../../services/cloud-token.service';
import * as i0 from "@angular/core";
import * as i1 from "../../../services/cloud-token.service";
import * as i2 from "@alfresco/adf-core";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
export class ProcessFilterCloudService {
    constructor(preferenceService, identityUserService) {
        this.preferenceService = preferenceService;
        this.identityUserService = identityUserService;
        this.filtersSubject = new BehaviorSubject([]);
        this.filters$ = this.filtersSubject.asObservable();
    }
    readQueryParams(obj) {
        const model = Object.assign({}, obj);
        if (obj.hasOwnProperty('appVersion') && obj['appVersion']) {
            if (typeof obj['appVersion'] === 'string') {
                model.appVersion = obj['appVersion'].split(',').map(str => parseInt(str, 10));
            }
        }
        if (obj.hasOwnProperty('lastModifiedFrom')) {
            model.lastModifiedFrom = new Date(parseInt(obj['lastModifiedFrom'], 10));
        }
        if (obj.hasOwnProperty('lastModifiedTo')) {
            model.lastModifiedTo = new Date(parseInt(obj['lastModifiedTo'], 10));
        }
        return model;
    }
    writeQueryParams(value, filterProperties, appName, id) {
        value = value || {};
        const result = {
            appName: appName || value['appName'],
            id: id || value['id']
        };
        for (const prop of filterProperties) {
            if (prop === 'appVersionMultiple') {
                const versions = value['appVersion'];
                if (Array.isArray(versions) && versions.length > 0) {
                    result['appVersion'] = versions.join(',');
                }
            }
            else if (prop === 'lastModified') {
                if (value['lastModifiedFrom']) {
                    result['lastModifiedFrom'] = value['lastModifiedFrom'].valueOf();
                }
                if (value['lastModifiedTo']) {
                    result['lastModifiedTo'] = value['lastModifiedTo'].valueOf();
                }
            }
            else if (value.hasOwnProperty(prop)) {
                result[prop] = value[prop];
            }
        }
        return result;
    }
    createDefaultFilters(appName) {
        const key = this.prepareKey(appName);
        this.preferenceService.getPreferences(appName, key).pipe(switchMap((response) => {
            const preferences = (response && response.list && response.list.entries) ? response.list.entries : [];
            if (!this.hasPreferences(preferences)) {
                return this.createProcessFilters(appName, key, this.defaultProcessFilters(appName));
            }
            else if (!this.hasProcessFilters(preferences, key)) {
                return this.createProcessFilters(appName, key, this.defaultProcessFilters(appName));
            }
            else {
                return of(this.findFiltersByKeyInPreferences(preferences, key));
            }
        }), catchError((err) => this.handleProcessError(err))).subscribe((filters) => {
            this.addFiltersToStream(filters);
        });
    }
    getProcessFilters(appName) {
        this.createDefaultFilters(appName);
        return this.filters$;
    }
    getFilterById(appName, id) {
        const key = this.prepareKey(appName);
        return this.getProcessFiltersByKey(appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length === 0) {
                return this.createProcessFilters(appName, key, this.defaultProcessFilters(appName));
            }
            else {
                return of(filters);
            }
        }), map((filters) => {
            return filters.filter((filter) => {
                return filter.id === id;
            })[0];
        }), catchError((err) => this.handleProcessError(err)));
    }
    addFilter(newFilter) {
        const { appName, name } = newFilter;
        const key = this.prepareKey(appName);
        return this.getProcessFiltersByKey(appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length === 0) {
                return this.createProcessFilters(appName, key, [newFilter]);
            }
            else {
                const index = filters.findIndex(filter => filter.name === name);
                if (index >= 0) {
                    filters.splice(index, 1);
                }
                filters.push(newFilter);
                return this.preferenceService.updatePreference(appName, key, filters);
            }
        }), map((filters) => {
            this.addFiltersToStream(filters);
            return filters;
        }), catchError((err) => this.handleProcessError(err)));
    }
    updateFilter(updatedFilter) {
        const key = this.prepareKey(updatedFilter.appName);
        return this.getProcessFiltersByKey(updatedFilter.appName, key).pipe(switchMap((filters) => {
            if (filters && filters.length === 0) {
                return this.createProcessFilters(updatedFilter.appName, key, [updatedFilter]);
            }
            else {
                const itemIndex = filters.findIndex((filter) => filter.id === updatedFilter.id);
                filters[itemIndex] = updatedFilter;
                return this.updateProcessFilters(updatedFilter.appName, key, filters);
            }
        }), map((updatedFilters) => {
            this.addFiltersToStream(updatedFilters);
            return updatedFilters;
        }), catchError((err) => this.handleProcessError(err)));
    }
    deleteFilter(deletedFilter) {
        const key = this.prepareKey(deletedFilter.appName);
        return this.getProcessFiltersByKey(deletedFilter.appName, key).pipe(switchMap(filters => {
            if (filters && filters.length > 0) {
                filters = filters.filter(filter => filter.id !== deletedFilter.id);
                return this.updateProcessFilters(deletedFilter.appName, key, filters);
            }
            else {
                return of([]);
            }
        }), map((filters) => {
            this.addFiltersToStream(filters);
            return filters;
        }), catchError((err) => this.handleProcessError(err)));
    }
    isDefaultFilter(filterName) {
        const defaultFilters = this.defaultProcessFilters();
        return defaultFilters.findIndex((filter) => filterName === filter.name) !== -1;
    }
    hasPreferences(preferences) {
        return preferences && preferences.length > 0;
    }
    hasProcessFilters(preferences, key) {
        const filters = preferences.find((filter) => { return filter.entry.key === key; });
        return (filters && filters.entry) ? JSON.parse(filters.entry.value).length > 0 : false;
    }
    createProcessFilters(appName, key, filters) {
        return this.preferenceService.createPreference(appName, key, filters);
    }
    getProcessFiltersByKey(appName, key) {
        return this.preferenceService.getPreferenceByKey(appName, key);
    }
    updateProcessFilters(appName, key, filters) {
        return this.preferenceService.updatePreference(appName, key, filters);
    }
    prepareKey(appName) {
        const user = this.identityUserService.getCurrentUserInfo();
        return `process-filters-${appName}-${user.username}`;
    }
    findFiltersByKeyInPreferences(preferences, key) {
        const result = preferences.find((filter) => { return filter.entry.key === key; });
        return result && result.entry ? JSON.parse(result.entry.value) : [];
    }
    addFiltersToStream(filters) {
        this.filtersSubject.next(filters);
    }
    handleProcessError(error) {
        return throwError(error || 'Server error');
    }
    defaultProcessFilters(appName) {
        return [
            new ProcessFilterCloudModel({
                name: 'ADF_CLOUD_PROCESS_FILTERS.RUNNING_PROCESSES',
                icon: 'inbox',
                key: 'running-processes',
                appName,
                sort: 'startDate',
                status: 'RUNNING',
                order: 'DESC'
            }),
            new ProcessFilterCloudModel({
                name: 'ADF_CLOUD_PROCESS_FILTERS.COMPLETED_PROCESSES',
                icon: 'done',
                key: 'completed-processes',
                appName,
                sort: 'startDate',
                status: 'COMPLETED',
                order: 'DESC'
            }),
            new ProcessFilterCloudModel({
                name: 'ADF_CLOUD_PROCESS_FILTERS.ALL_PROCESSES',
                key: 'all-processes',
                icon: 'adjust',
                appName,
                sort: 'startDate',
                status: '',
                order: 'DESC'
            })
        ];
    }
}
ProcessFilterCloudService.ɵfac = function ProcessFilterCloudService_Factory(t) { return new (t || ProcessFilterCloudService)(ɵngcc0.ɵɵinject(PROCESS_FILTERS_SERVICE_TOKEN), ɵngcc0.ɵɵinject(ɵngcc1.IdentityUserService)); };
ProcessFilterCloudService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ProcessFilterCloudService_Factory() { return new ProcessFilterCloudService(i0.ɵɵinject(i1.PROCESS_FILTERS_SERVICE_TOKEN), i0.ɵɵinject(i2.IdentityUserService)); }, token: ProcessFilterCloudService, providedIn: "root" });
ProcessFilterCloudService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [PROCESS_FILTERS_SERVICE_TOKEN,] }] },
    { type: IdentityUserService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ProcessFilterCloudService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [PROCESS_FILTERS_SERVICE_TOKEN]
            }] }, { type: ɵngcc1.IdentityUserService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy1maWx0ZXItY2xvdWQuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL3Byb2Nlc3Mtc2VydmljZXMtY2xvdWQvc3JjL2xpYi9wcm9jZXNzL3Byb2Nlc3MtZmlsdGVycy9zZXJ2aWNlcy9wcm9jZXNzLWZpbHRlci1jbG91ZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQWMsRUFBRSxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbkUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDL0UsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDdEY7QUFBcUM7QUFDbkM7OztBQUdGLE1BQU0sT0FBTyx5QkFBeUI7QUFDdEMsSUFJSSxZQUNrRCxpQkFBa0QsRUFDeEYsbUJBQXdDO0FBQ3hELFFBRnNELHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBaUM7QUFBQyxRQUN6Rix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO0FBQUMsUUFDakQsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN0RCxRQUFRLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztBQUMzRCxJQUFJLENBQUM7QUFDTCxJQUNJ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Q0FBQztBQUNWLElBQUksQ0FBQztBQUNMOzZOQUFDO0FBQ0QsdVNBNVVLO0FBQUM7RUFITCxVQUFVLFNBQUMsa0JBQ1IsVUFBVSxFQUFFLE1BQU0sY0FDckIsdkVBR2MsNENBSU4sTUFBTSxTQUFDLDZCQUE2QjtBQUFTLFlBaEI3QyxtQkFBbUI7QUFBRzs7Ozs7Ozs7O3dFQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBJZGVudGl0eVVzZXJTZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIEJlaGF2aW9yU3ViamVjdCwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgUHJvY2Vzc0ZpbHRlckNsb3VkTW9kZWwgfSBmcm9tICcuLi9tb2RlbHMvcHJvY2Vzcy1maWx0ZXItY2xvdWQubW9kZWwnO1xuaW1wb3J0IHsgc3dpdGNoTWFwLCBtYXAsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQUk9DRVNTX0ZJTFRFUlNfU0VSVklDRV9UT0tFTiB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL2Nsb3VkLXRva2VuLnNlcnZpY2UnO1xuaW1wb3J0IHsgUHJlZmVyZW5jZUNsb3VkU2VydmljZUludGVyZmFjZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL3ByZWZlcmVuY2UtY2xvdWQuaW50ZXJmYWNlJztcbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgUHJvY2Vzc0ZpbHRlckNsb3VkU2VydmljZSB7XG5cbiAgICBwcml2YXRlIGZpbHRlcnNTdWJqZWN0OiBCZWhhdmlvclN1YmplY3Q8UHJvY2Vzc0ZpbHRlckNsb3VkTW9kZWxbXT47XG4gICAgZmlsdGVycyQ6IE9ic2VydmFibGU8UHJvY2Vzc0ZpbHRlckNsb3VkTW9kZWxbXT47XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgQEluamVjdChQUk9DRVNTX0ZJTFRFUlNfU0VSVklDRV9UT0tFTikgcHVibGljIHByZWZlcmVuY2VTZXJ2aWNlOiBQcmVmZXJlbmNlQ2xvdWRTZXJ2aWNlSW50ZXJmYWNlLFxuICAgICAgICBwcml2YXRlIGlkZW50aXR5VXNlclNlcnZpY2U6IElkZW50aXR5VXNlclNlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5maWx0ZXJzU3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3QoW10pO1xuICAgICAgICB0aGlzLmZpbHRlcnMkID0gdGhpcy5maWx0ZXJzU3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgICB9XG5cbiAgICByZWFkUXVlcnlQYXJhbXMob2JqOiBPYmplY3QpOiBQcm9jZXNzRmlsdGVyQ2xvdWRNb2RlbCB7XG4gICAgICAgIGNvbnN0IG1vZGVsID0gT2JqZWN0LmFzc2lnbih7fSwgb2JqKSBhcyBQcm9jZXNzRmlsdGVyQ2xvdWRNb2RlbDtcblxuICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KCdhcHBWZXJzaW9uJykgJiYgb2JqWydhcHBWZXJzaW9uJ10pIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqWydhcHBWZXJzaW9uJ10gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgbW9kZWwuYXBwVmVyc2lvbiA9IG9ialsnYXBwVmVyc2lvbiddLnNwbGl0KCcsJykubWFwKHN0ciA9PiBwYXJzZUludChzdHIsIDEwKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KCdsYXN0TW9kaWZpZWRGcm9tJykpIHtcbiAgICAgICAgICAgIG1vZGVsLmxhc3RNb2RpZmllZEZyb20gPSBuZXcgRGF0ZShwYXJzZUludChvYmpbJ2xhc3RNb2RpZmllZEZyb20nXSwgMTApKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoJ2xhc3RNb2RpZmllZFRvJykpIHtcbiAgICAgICAgICAgIG1vZGVsLmxhc3RNb2RpZmllZFRvID0gbmV3IERhdGUocGFyc2VJbnQob2JqWydsYXN0TW9kaWZpZWRUbyddLCAxMCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG1vZGVsO1xuICAgIH1cblxuICAgIHdyaXRlUXVlcnlQYXJhbXModmFsdWU6IE9iamVjdCwgZmlsdGVyUHJvcGVydGllczogc3RyaW5nW10sIGFwcE5hbWU/OiBzdHJpbmcsIGlkPzogc3RyaW5nKTogT2JqZWN0IHtcbiAgICAgICAgdmFsdWUgPSB2YWx1ZSB8fCB7fTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgICAgICAgYXBwTmFtZTogYXBwTmFtZSB8fCB2YWx1ZVsnYXBwTmFtZSddLFxuICAgICAgICAgICAgaWQ6IGlkIHx8IHZhbHVlWydpZCddXG4gICAgICAgIH07XG5cbiAgICAgICAgZm9yIChjb25zdCBwcm9wIG9mIGZpbHRlclByb3BlcnRpZXMpIHtcbiAgICAgICAgICAgIGlmIChwcm9wID09PSAnYXBwVmVyc2lvbk11bHRpcGxlJykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHZlcnNpb25zID0gdmFsdWVbJ2FwcFZlcnNpb24nXTtcblxuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZlcnNpb25zKSAmJiB2ZXJzaW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFsnYXBwVmVyc2lvbiddID0gdmVyc2lvbnMuam9pbignLCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcCA9PT0gJ2xhc3RNb2RpZmllZCcpIHtcbiAgICAgICAgICAgICAgICBpZiAodmFsdWVbJ2xhc3RNb2RpZmllZEZyb20nXSkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRbJ2xhc3RNb2RpZmllZEZyb20nXSA9IHZhbHVlWydsYXN0TW9kaWZpZWRGcm9tJ10udmFsdWVPZigpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICh2YWx1ZVsnbGFzdE1vZGlmaWVkVG8nXSkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRbJ2xhc3RNb2RpZmllZFRvJ10gPSB2YWx1ZVsnbGFzdE1vZGlmaWVkVG8nXS52YWx1ZU9mKCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLmhhc093blByb3BlcnR5KHByb3ApKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0W3Byb3BdID0gdmFsdWVbcHJvcF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYW5kIHJldHVybnMgdGhlIGRlZmF1bHQgcHJvY2VzcyBpbnN0YW5jZSBmaWx0ZXJzIGZvciBhIGFwcC5cbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHJldHVybnMgT2JzZXJ2YWJsZSBvZiBkZWZhdWx0IHByb2Nlc3MgaW5zdGFuY2UgZmlsdGVycyBqdXN0IGNyZWF0ZWQgb3IgY3JlYXRlZCBmaWx0ZXJzXG4gICAgICovXG4gICAgcHJpdmF0ZSBjcmVhdGVEZWZhdWx0RmlsdGVycyhhcHBOYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3Qga2V5OiBzdHJpbmcgPSB0aGlzLnByZXBhcmVLZXkoYXBwTmFtZSk7XG4gICAgICAgIHRoaXMucHJlZmVyZW5jZVNlcnZpY2UuZ2V0UHJlZmVyZW5jZXMoYXBwTmFtZSwga2V5KS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcHJlZmVyZW5jZXMgPSAocmVzcG9uc2UgJiYgcmVzcG9uc2UubGlzdCAmJiByZXNwb25zZS5saXN0LmVudHJpZXMpID8gcmVzcG9uc2UubGlzdC5lbnRyaWVzIDogW107XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhc1ByZWZlcmVuY2VzKHByZWZlcmVuY2VzKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVQcm9jZXNzRmlsdGVycyhhcHBOYW1lLCBrZXksIHRoaXMuZGVmYXVsdFByb2Nlc3NGaWx0ZXJzKGFwcE5hbWUpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLmhhc1Byb2Nlc3NGaWx0ZXJzKHByZWZlcmVuY2VzLCBrZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZVByb2Nlc3NGaWx0ZXJzKGFwcE5hbWUsIGtleSwgdGhpcy5kZWZhdWx0UHJvY2Vzc0ZpbHRlcnMoYXBwTmFtZSkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBvZih0aGlzLmZpbmRGaWx0ZXJzQnlLZXlJblByZWZlcmVuY2VzKHByZWZlcmVuY2VzLCBrZXkpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgKS5zdWJzY3JpYmUoKGZpbHRlcnMpID0+IHtcbiAgICAgICAgICAgIHRoaXMuYWRkRmlsdGVyc1RvU3RyZWFtKGZpbHRlcnMpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGFsbCBwcm9jZXNzIGluc3RhbmNlIGZpbHRlcnMgZm9yIGEgcHJvY2VzcyBhcHAuXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGUgb2YgcHJvY2VzcyBmaWx0ZXJzIGRldGFpbHNcbiAgICAgKi9cbiAgICBnZXRQcm9jZXNzRmlsdGVycyhhcHBOYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFByb2Nlc3NGaWx0ZXJDbG91ZE1vZGVsW10+IHtcbiAgICAgICAgdGhpcy5jcmVhdGVEZWZhdWx0RmlsdGVycyhhcHBOYW1lKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsdGVycyQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHByb2Nlc3MgaW5zdGFuY2UgZmlsdGVyIGZvciBnaXZlbiBmaWx0ZXIgaWRcbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHBhcmFtIGlkIElkIG9mIHRoZSB0YXJnZXQgcHJvY2VzcyBpbnN0YW5jZSBmaWx0ZXJcbiAgICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIG9mIHByb2Nlc3MgaW5zdGFuY2UgZmlsdGVyIGRldGFpbHNcbiAgICAgKi9cbiAgICBnZXRGaWx0ZXJCeUlkKGFwcE5hbWU6IHN0cmluZywgaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8UHJvY2Vzc0ZpbHRlckNsb3VkTW9kZWw+IHtcbiAgICAgICAgY29uc3Qga2V5OiBzdHJpbmcgPSB0aGlzLnByZXBhcmVLZXkoYXBwTmFtZSk7XG4gICAgICAgIHJldHVybiB0aGlzLmdldFByb2Nlc3NGaWx0ZXJzQnlLZXkoYXBwTmFtZSwga2V5KS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKChmaWx0ZXJzOiBQcm9jZXNzRmlsdGVyQ2xvdWRNb2RlbFtdKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGZpbHRlcnMgJiYgZmlsdGVycy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlUHJvY2Vzc0ZpbHRlcnMoYXBwTmFtZSwga2V5LCB0aGlzLmRlZmF1bHRQcm9jZXNzRmlsdGVycyhhcHBOYW1lKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKGZpbHRlcnMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgbWFwKChmaWx0ZXJzOiBQcm9jZXNzRmlsdGVyQ2xvdWRNb2RlbFtdKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlcnMuZmlsdGVyKChmaWx0ZXI6IFByb2Nlc3NGaWx0ZXJDbG91ZE1vZGVsKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXIuaWQgPT09IGlkO1xuICAgICAgICAgICAgICAgIH0pWzBdO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBuZXcgcHJvY2VzcyBpbnN0YW5jZSBmaWx0ZXJcbiAgICAgKiBAcGFyYW0gZmlsdGVyIFRoZSBuZXcgZmlsdGVyIHRvIGFkZFxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGUgb2YgcHJvY2VzcyBpbnN0YW5jZSBmaWx0ZXJzIHdpdGggbmV3bHkgYWRkZWQgZmlsdGVyXG4gICAgICovXG4gICAgYWRkRmlsdGVyKG5ld0ZpbHRlcjogUHJvY2Vzc0ZpbHRlckNsb3VkTW9kZWwpOiBPYnNlcnZhYmxlPFByb2Nlc3NGaWx0ZXJDbG91ZE1vZGVsW10+IHtcbiAgICAgICAgY29uc3QgeyBhcHBOYW1lLCBuYW1lIH0gPSBuZXdGaWx0ZXI7XG4gICAgICAgIGNvbnN0IGtleTogc3RyaW5nID0gdGhpcy5wcmVwYXJlS2V5KGFwcE5hbWUpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmdldFByb2Nlc3NGaWx0ZXJzQnlLZXkoYXBwTmFtZSwga2V5KS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKChmaWx0ZXJzOiBQcm9jZXNzRmlsdGVyQ2xvdWRNb2RlbFtdKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGZpbHRlcnMgJiYgZmlsdGVycy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlUHJvY2Vzc0ZpbHRlcnMoYXBwTmFtZSwga2V5LCBbbmV3RmlsdGVyXSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBmaWx0ZXJzLmZpbmRJbmRleChmaWx0ZXIgPT4gZmlsdGVyLm5hbWUgPT09IG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVycy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgZmlsdGVycy5wdXNoKG5ld0ZpbHRlcik7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnByZWZlcmVuY2VTZXJ2aWNlLnVwZGF0ZVByZWZlcmVuY2UoYXBwTmFtZSwga2V5LCBmaWx0ZXJzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIG1hcCgoZmlsdGVyczogUHJvY2Vzc0ZpbHRlckNsb3VkTW9kZWxbXSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkRmlsdGVyc1RvU3RyZWFtKGZpbHRlcnMpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXJzO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogIFVwZGF0ZSBwcm9jZXNzIGluc3RhbmNlIGZpbHRlclxuICAgICAqIEBwYXJhbSBmaWx0ZXIgVGhlIG5ldyBmaWx0ZXIgdG8gdXBkYXRlXG4gICAgICogQHJldHVybnMgT2JzZXJ2YWJsZSBvZiBwcm9jZXNzIGluc3RhbmNlIGZpbHRlcnMgd2l0aCB1cGRhdGVkIGZpbHRlclxuICAgICAqL1xuICAgIHVwZGF0ZUZpbHRlcih1cGRhdGVkRmlsdGVyOiBQcm9jZXNzRmlsdGVyQ2xvdWRNb2RlbCk6IE9ic2VydmFibGU8UHJvY2Vzc0ZpbHRlckNsb3VkTW9kZWxbXT4ge1xuICAgICAgICBjb25zdCBrZXk6IHN0cmluZyA9IHRoaXMucHJlcGFyZUtleSh1cGRhdGVkRmlsdGVyLmFwcE5hbWUpO1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRQcm9jZXNzRmlsdGVyc0J5S2V5KHVwZGF0ZWRGaWx0ZXIuYXBwTmFtZSwga2V5KS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKChmaWx0ZXJzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZmlsdGVycyAmJiBmaWx0ZXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVQcm9jZXNzRmlsdGVycyh1cGRhdGVkRmlsdGVyLmFwcE5hbWUsIGtleSwgW3VwZGF0ZWRGaWx0ZXJdKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpdGVtSW5kZXggPSBmaWx0ZXJzLmZpbmRJbmRleCgoZmlsdGVyOiBQcm9jZXNzRmlsdGVyQ2xvdWRNb2RlbCkgPT4gZmlsdGVyLmlkID09PSB1cGRhdGVkRmlsdGVyLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyc1tpdGVtSW5kZXhdID0gdXBkYXRlZEZpbHRlcjtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlUHJvY2Vzc0ZpbHRlcnModXBkYXRlZEZpbHRlci5hcHBOYW1lLCBrZXksIGZpbHRlcnMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgbWFwKCh1cGRhdGVkRmlsdGVyczogUHJvY2Vzc0ZpbHRlckNsb3VkTW9kZWxbXSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkRmlsdGVyc1RvU3RyZWFtKHVwZGF0ZWRGaWx0ZXJzKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlZEZpbHRlcnM7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiAgRGVsZXRlIHByb2Nlc3MgaW5zdGFuY2UgZmlsdGVyXG4gICAgICogQHBhcmFtIGZpbHRlciBUaGUgbmV3IGZpbHRlciB0byBkZWxldGVcbiAgICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIG9mIHByb2Nlc3MgaW5zdGFuY2UgZmlsdGVycyB3aXRob3V0IGRlbGV0ZWQgZmlsdGVyXG4gICAgICovXG4gICAgZGVsZXRlRmlsdGVyKGRlbGV0ZWRGaWx0ZXI6IFByb2Nlc3NGaWx0ZXJDbG91ZE1vZGVsKTogT2JzZXJ2YWJsZTxQcm9jZXNzRmlsdGVyQ2xvdWRNb2RlbFtdPiB7XG4gICAgICAgIGNvbnN0IGtleSA9IHRoaXMucHJlcGFyZUtleShkZWxldGVkRmlsdGVyLmFwcE5hbWUpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmdldFByb2Nlc3NGaWx0ZXJzQnlLZXkoZGVsZXRlZEZpbHRlci5hcHBOYW1lLCBrZXkpLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoZmlsdGVycyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGZpbHRlcnMgJiYgZmlsdGVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGZpbHRlcnMgPSBmaWx0ZXJzLmZpbHRlcihmaWx0ZXIgPT4gZmlsdGVyLmlkICE9PSBkZWxldGVkRmlsdGVyLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlUHJvY2Vzc0ZpbHRlcnMoZGVsZXRlZEZpbHRlci5hcHBOYW1lLCBrZXksIGZpbHRlcnMpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihbXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBtYXAoKGZpbHRlcnM6IFByb2Nlc3NGaWx0ZXJDbG91ZE1vZGVsW10pID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmFkZEZpbHRlcnNUb1N0cmVhbShmaWx0ZXJzKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmlsdGVycztcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBpZiBnaXZlbiBmaWx0ZXIgaXMgYSBkZWZhdWx0IGZpbHRlclxuICAgICAqIEBwYXJhbSBmaWx0ZXJOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCBwcm9jZXNzIGZpbHRlclxuICAgICAqIEByZXR1cm5zIEJvb2xlYW4gdmFsdWUgZm9yIHdoZXRoZXIgdGhlIGZpbHRlciBpcyBhIGRlZmF1bHQgZmlsdGVyXG4gICAgICovXG4gICAgaXNEZWZhdWx0RmlsdGVyKGZpbHRlck5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBkZWZhdWx0RmlsdGVycyA9IHRoaXMuZGVmYXVsdFByb2Nlc3NGaWx0ZXJzKCk7XG4gICAgICAgIHJldHVybiBkZWZhdWx0RmlsdGVycy5maW5kSW5kZXgoKGZpbHRlcikgPT4gZmlsdGVyTmFtZSA9PT0gZmlsdGVyLm5hbWUpICE9PSAtMTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3MgdXNlciBwcmVmZXJlbmNlIGFyZSBlbXB0eSBvciBub3RcbiAgICAgKiBAcGFyYW0gcHJlZmVyZW5jZXMgVXNlciBwcmVmZXJlbmNlcyBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIEJvb2xlYW4gdmFsdWUgaWYgdGhlIHByZWZlcmVuY2VzIGFyZSBub3QgZW1wdHlcbiAgICAgKi9cbiAgICBwcml2YXRlIGhhc1ByZWZlcmVuY2VzKHByZWZlcmVuY2VzOiBhbnkpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHByZWZlcmVuY2VzICYmIHByZWZlcmVuY2VzLmxlbmd0aCA+IDA7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGZvciBwcm9jZXNzIGluc3RhbmNlIGZpbHRlcnMgaW4gZ2l2ZW4gdXNlciBwcmVmZXJlbmNlc1xuICAgICAqIEBwYXJhbSBwcmVmZXJlbmNlcyBVc2VyIHByZWZlcmVuY2VzIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHBhcmFtIGtleSBLZXkgb2YgdGhlIHByb2Nlc3MgaW5zdGFuY2UgZmlsdGVyc1xuICAgICAqIEBwYXJhbSBmaWx0ZXJzIERldGFpbHMgb2YgY3JlYXRlIGZpbHRlclxuICAgICAqIEByZXR1cm5zIEJvb2xlYW4gdmFsdWUgaWYgdGhlIHByZWZlcmVuY2UgaGFzIHByb2Nlc3MgaW5zdGFuY2UgZmlsdGVyc1xuICAgICAqL1xuICAgIHByaXZhdGUgaGFzUHJvY2Vzc0ZpbHRlcnMocHJlZmVyZW5jZXM6IGFueSwga2V5OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgZmlsdGVycyA9IHByZWZlcmVuY2VzLmZpbmQoKGZpbHRlcjogYW55KSA9PiB7IHJldHVybiBmaWx0ZXIuZW50cnkua2V5ID09PSBrZXk7IH0pO1xuICAgICAgICByZXR1cm4gKGZpbHRlcnMgJiYgZmlsdGVycy5lbnRyeSkgPyBKU09OLnBhcnNlKGZpbHRlcnMuZW50cnkudmFsdWUpLmxlbmd0aCA+IDAgOiBmYWxzZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxscyBjcmVhdGUgcHJlZmVyZW5jZSBhcGkgdG8gY3JlYXRlIHByb2Nlc3MgaW5zdGFuY2UgZmlsdGVyc1xuICAgICAqIEBwYXJhbSBhcHBOYW1lIE5hbWUgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcGFyYW0ga2V5IEtleSBvZiB0aGUgcHJvY2VzcyBpbnN0YW5jZSBmaWx0ZXJzXG4gICAgICogQHBhcmFtIGZpbHRlcnMgRGV0YWlscyBvZiBuZXcgcHJvY2VzcyBpbnN0YW5jZSBmaWx0ZXJcbiAgICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIG9mIGNyZWF0ZWQgcHJvY2VzcyBpbnN0YW5jZSBmaWx0ZXJzXG4gICAgICovXG4gICAgcHJpdmF0ZSBjcmVhdGVQcm9jZXNzRmlsdGVycyhhcHBOYW1lOiBzdHJpbmcsIGtleTogc3RyaW5nLCBmaWx0ZXJzOiBQcm9jZXNzRmlsdGVyQ2xvdWRNb2RlbFtdKTogT2JzZXJ2YWJsZTxQcm9jZXNzRmlsdGVyQ2xvdWRNb2RlbFtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnByZWZlcmVuY2VTZXJ2aWNlLmNyZWF0ZVByZWZlcmVuY2UoYXBwTmFtZSwga2V5LCBmaWx0ZXJzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxscyBnZXQgcHJlZmVyZW5jZSBhcGkgdG8gZ2V0IHByb2Nlc3MgaW5zdGFuY2UgZmlsdGVyIGJ5IHByZWZlcmVuY2Uga2V5XG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSBwcm9jZXNzIGluc3RhbmNlIGZpbHRlcnNcbiAgICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIG9mIHByb2Nlc3MgaW5zdGFuY2UgZmlsdGVyc1xuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0UHJvY2Vzc0ZpbHRlcnNCeUtleShhcHBOYW1lOiBzdHJpbmcsIGtleTogc3RyaW5nKTogT2JzZXJ2YWJsZTxQcm9jZXNzRmlsdGVyQ2xvdWRNb2RlbFtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnByZWZlcmVuY2VTZXJ2aWNlLmdldFByZWZlcmVuY2VCeUtleShhcHBOYW1lLCBrZXkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGxzIHVwZGF0ZSBwcmVmZXJlbmNlIGFwaSB0byB1cGRhdGUgcHJvY2VzcyBpbnN0YW5jZSBmaWx0ZXJcbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHBhcmFtIGtleSBLZXkgb2YgdGhlIHByb2Nlc3MgaW5zdGFuY2UgZmlsdGVyc1xuICAgICAqIEBwYXJhbSBmaWx0ZXJzIERldGFpbHMgb2YgdXBkYXRlIGZpbHRlclxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGUgb2YgdXBkYXRlZCBwcm9jZXNzIGluc3RhbmNlIGZpbHRlcnNcbiAgICAgKi9cbiAgICBwcml2YXRlIHVwZGF0ZVByb2Nlc3NGaWx0ZXJzKGFwcE5hbWU6IHN0cmluZywga2V5OiBzdHJpbmcsIGZpbHRlcnM6IFByb2Nlc3NGaWx0ZXJDbG91ZE1vZGVsW10pOiBPYnNlcnZhYmxlPFByb2Nlc3NGaWx0ZXJDbG91ZE1vZGVsW10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJlZmVyZW5jZVNlcnZpY2UudXBkYXRlUHJlZmVyZW5jZShhcHBOYW1lLCBrZXksIGZpbHRlcnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSB1bmlxIGtleSB3aXRoIGFwcE5hbWUgYW5kIHVzZXJuYW1lXG4gICAgICogQHBhcmFtIGFwcE5hbWUgTmFtZSBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIFN0cmluZyBvZiBwcm9jZXNzIGluc3RhbmNlIGZpbHRlcnMgcHJlZmVyZW5jZSBrZXlcbiAgICAgKi9cbiAgICBwcml2YXRlIHByZXBhcmVLZXkoYXBwTmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgdXNlciA9IHRoaXMuaWRlbnRpdHlVc2VyU2VydmljZS5nZXRDdXJyZW50VXNlckluZm8oKTtcbiAgICAgICAgcmV0dXJuIGBwcm9jZXNzLWZpbHRlcnMtJHthcHBOYW1lfS0ke3VzZXIudXNlcm5hbWV9YDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kcyBhbmQgcmV0dXJucyB0aGUgcHJvY2VzcyBpbnN0YW5jZSBmaWx0ZXJzIGZyb20gcHJlZmVyZW5jZXNcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBQcm9jZXNzRmlsdGVyQ2xvdWRNb2RlbFxuICAgICAqIEBwYXJhbSBwcmVmZXJlbmNlc1xuICAgICAqIEBwYXJhbSBrZXlcbiAgICAgKi9cbiAgICBwcml2YXRlIGZpbmRGaWx0ZXJzQnlLZXlJblByZWZlcmVuY2VzKHByZWZlcmVuY2VzOiBhbnksIGtleTogc3RyaW5nKTogUHJvY2Vzc0ZpbHRlckNsb3VkTW9kZWxbXSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHByZWZlcmVuY2VzLmZpbmQoKGZpbHRlcjogYW55KSA9PiB7IHJldHVybiBmaWx0ZXIuZW50cnkua2V5ID09PSBrZXk7IH0pO1xuICAgICAgICByZXR1cm4gcmVzdWx0ICYmIHJlc3VsdC5lbnRyeSA/IEpTT04ucGFyc2UocmVzdWx0LmVudHJ5LnZhbHVlKSA6IFtdO1xuICAgIH1cblxuICAgIHByaXZhdGUgYWRkRmlsdGVyc1RvU3RyZWFtKGZpbHRlcnM6IFByb2Nlc3NGaWx0ZXJDbG91ZE1vZGVsW10pIHtcbiAgICAgICAgdGhpcy5maWx0ZXJzU3ViamVjdC5uZXh0KGZpbHRlcnMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlUHJvY2Vzc0Vycm9yKGVycm9yOiBhbnkpIHtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IgfHwgJ1NlcnZlciBlcnJvcicpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYW5kIHJldHVybnMgdGhlIGRlZmF1bHQgZmlsdGVycyBmb3IgYSBwcm9jZXNzIGFwcC5cbiAgICAgKiBAcGFyYW0gYXBwTmFtZSBOYW1lIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgUHJvY2Vzc0ZpbHRlckNsb3VkTW9kZWxcbiAgICAgKi9cbiAgICBwcml2YXRlIGRlZmF1bHRQcm9jZXNzRmlsdGVycyhhcHBOYW1lPzogc3RyaW5nKTogUHJvY2Vzc0ZpbHRlckNsb3VkTW9kZWxbXSB7XG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICBuZXcgUHJvY2Vzc0ZpbHRlckNsb3VkTW9kZWwoe1xuICAgICAgICAgICAgICAgIG5hbWU6ICdBREZfQ0xPVURfUFJPQ0VTU19GSUxURVJTLlJVTk5JTkdfUFJPQ0VTU0VTJyxcbiAgICAgICAgICAgICAgICBpY29uOiAnaW5ib3gnLFxuICAgICAgICAgICAgICAgIGtleTogJ3J1bm5pbmctcHJvY2Vzc2VzJyxcbiAgICAgICAgICAgICAgICBhcHBOYW1lLFxuICAgICAgICAgICAgICAgIHNvcnQ6ICdzdGFydERhdGUnLFxuICAgICAgICAgICAgICAgIHN0YXR1czogJ1JVTk5JTkcnLFxuICAgICAgICAgICAgICAgIG9yZGVyOiAnREVTQydcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgbmV3IFByb2Nlc3NGaWx0ZXJDbG91ZE1vZGVsKHtcbiAgICAgICAgICAgICAgICBuYW1lOiAnQURGX0NMT1VEX1BST0NFU1NfRklMVEVSUy5DT01QTEVURURfUFJPQ0VTU0VTJyxcbiAgICAgICAgICAgICAgICBpY29uOiAnZG9uZScsXG4gICAgICAgICAgICAgICAga2V5OiAnY29tcGxldGVkLXByb2Nlc3NlcycsXG4gICAgICAgICAgICAgICAgYXBwTmFtZSxcbiAgICAgICAgICAgICAgICBzb3J0OiAnc3RhcnREYXRlJyxcbiAgICAgICAgICAgICAgICBzdGF0dXM6ICdDT01QTEVURUQnLFxuICAgICAgICAgICAgICAgIG9yZGVyOiAnREVTQydcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgbmV3IFByb2Nlc3NGaWx0ZXJDbG91ZE1vZGVsKHtcbiAgICAgICAgICAgICAgICBuYW1lOiAnQURGX0NMT1VEX1BST0NFU1NfRklMVEVSUy5BTExfUFJPQ0VTU0VTJyxcbiAgICAgICAgICAgICAgICBrZXk6ICdhbGwtcHJvY2Vzc2VzJyxcbiAgICAgICAgICAgICAgICBpY29uOiAnYWRqdXN0JyxcbiAgICAgICAgICAgICAgICBhcHBOYW1lLFxuICAgICAgICAgICAgICAgIHNvcnQ6ICdzdGFydERhdGUnLFxuICAgICAgICAgICAgICAgIHN0YXR1czogJycsXG4gICAgICAgICAgICAgICAgb3JkZXI6ICdERVNDJ1xuICAgICAgICAgICAgfSlcbiAgICAgICAgXTtcbiAgICB9XG59XG4iXX0=