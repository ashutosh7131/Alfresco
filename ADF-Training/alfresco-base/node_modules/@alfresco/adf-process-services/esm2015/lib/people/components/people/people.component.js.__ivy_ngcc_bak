/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { LogService, PeopleProcessService } from '@alfresco/adf-core';
import { Component, Input, ViewChild, ViewEncapsulation } from '@angular/core';
import { Observable } from 'rxjs';
import { PeopleSearchComponent } from '../people-search/people-search.component';
import { share } from 'rxjs/operators';
export class PeopleComponent {
    constructor(logService, peopleProcessService) {
        this.logService = logService;
        this.peopleProcessService = peopleProcessService;
        this.people = [];
        this.taskId = '';
        this.readOnly = false;
        this.showAssignment = false;
        this.peopleSearch$ = new Observable((observer) => this.peopleSearchObserver = observer)
            .pipe(share());
    }
    involveUserAndCloseSearch() {
        if (this.peopleSearch) {
            this.peopleSearch.involveUserAndClose();
        }
    }
    involveUserWithoutCloseSearch() {
        if (this.peopleSearch) {
            this.peopleSearch.involveUser();
        }
    }
    searchUser(searchedWord) {
        this.peopleProcessService.getWorkflowUsers(this.taskId, searchedWord)
            .subscribe((users) => {
            this.peopleSearchObserver.next(users);
        }, (error) => this.logService.error(error));
    }
    involveUser(user) {
        if (user && user.id) {
            this.peopleProcessService
                .involveUserWithTask(this.taskId, user.id.toString())
                .subscribe(() => this.people = [...this.people, user], () => this.logService.error('Impossible to involve user with task'));
        }
    }
    removeInvolvedUser(user) {
        this.peopleProcessService
            .removeInvolvedUser(this.taskId, user.id.toString())
            .subscribe(() => {
            this.people = this.people.filter(involvedUser => involvedUser.id !== user.id);
        }, () => this.logService.error('Impossible to remove involved user from task'));
    }
    getDisplayUser(firstName, lastName, delimiter = '-') {
        firstName = (firstName !== null ? firstName : '');
        lastName = (lastName !== null ? lastName : '');
        return firstName + delimiter + lastName;
    }
    getInitialUserName(firstName, lastName) {
        firstName = (firstName !== null && firstName !== '' ? firstName[0] : '');
        lastName = (lastName !== null && lastName !== '' ? lastName[0] : '');
        return this.getDisplayUser(firstName, lastName, '');
    }
    onAddAssignment() {
        this.showAssignment = true;
    }
    onClickAction(event) {
        if (event && event.value && event.type === 'remove') {
            this.removeInvolvedUser(event.value);
        }
    }
    hasPeople() {
        return this.people && this.people.length > 0;
    }
    isEditMode() {
        return !this.readOnly;
    }
    onCloseSearch() {
        this.showAssignment = false;
    }
}
PeopleComponent.decorators = [
    { type: Component, args: [{
                selector: 'adf-people',
                template: "<mat-card class=\"adf-assignment-top-container\">\n    <div mat-card-content class=\"adf-assignment-top-container-content\">\n        <div class=\"assignment-header\">\n                <div *ngIf=\"hasPeople()\" class=\"adf-assignment-count\" id=\"people-title\">\n                    {{ 'ADF_TASK_LIST.DETAILS.LABELS.PEOPLE' | translate }} {{ ' (' + people.length + ')' }}\n                </div>\n                <div *ngIf=\"!hasPeople()\" class=\"adf-assignment-count\" id=\"no-people-label\">\n                    {{ 'ADF_TASK_LIST.DETAILS.PEOPLE.NONE' | translate }}\n                </div>\n                <div *ngIf=\"isEditMode()\" class=\"adf-add-people\" (click)=\"onAddAssignment()\">\n                    <mat-icon class=\"adf-add-person-icon\">person_add</mat-icon>\n                </div>\n            </div>\n            <div class=\"adf-assignment-container\" *ngIf=\"showAssignment\">\n                <adf-people-search\n                    #peopleSearch\n                    (searchPeople)=\"searchUser($event)\"\n                    (success)=\"involveUser($event)\"\n                    (closeSearch)=\"onCloseSearch()\"\n                    [results]=\"peopleSearch$\">\n                    <ng-container adf-people-search-title>{{ 'ADF_TASK_LIST.DETAILS.LABELS.ADD_PEOPLE' | translate }}</ng-container>\n                    <ng-container adf-people-search-action-label>{{ 'ADF_TASK_LIST.PEOPLE.ADD_USER' | translate }}</ng-container>\n                </adf-people-search>\n            </div>\n            <div class=\"adf-assignment-list-container\" id=\"assignment-people-list\" *ngIf=\"hasPeople()\">\n                <adf-people-list\n                [users]=\"people\"\n                [actions]=\"isEditMode()\"\n                (clickAction)=\"onClickAction($event)\">\n                    <data-columns>\n                        <data-column key=\"firstName\">\n                            <ng-template let-entry=\"$implicit\">\n                                <div *ngIf=\"!entry.row.obj.pictureId\" class=\"adf-people-search-people-pic\">\n                                    {{getInitialUserName(entry.row.obj.firstName, entry.row.obj.lastName)}}</div>\n                                <div>\n                                    <img [alt]=\"getDisplayUser(entry.row.obj.firstName, entry.row.obj.lastName, ' ')\" *ngIf=\"entry.row.obj.pictureId\" class=\"adf-people-img\"\n                                        [src]=\"peopleProcessService.getUserImage(entry.row.obj)\"/>\n                                </div>\n                            </ng-template>\n                        </data-column>\n                        <data-column key=\"email\" class=\"adf-full-width\">\n                            <ng-template let-entry=\"$implicit\">\n                                <div class=\"adf-people-user-info\">\n                                    <div [attr.data-automation-id]=\"'adf-people-full-name-'+ getDisplayUser(entry.row.obj.firstName, entry.row.obj.lastName, '-')\" class=\"adf-people-full-name\">{{ getDisplayUser(entry.row.obj.firstName, entry.row.obj.lastName, ' ') }}</div>\n                                    <div [attr.data-automation-id]=\"'adf-people-email-'+ getDisplayUser(entry.row.obj.firstName, entry.row.obj.lastName, '-')\"  class=\"adf-people-email\">{{ entry.row.obj.email }}</div>\n                                </div>\n                            </ng-template>\n                        </data-column>\n                    </data-columns>\n                </adf-people-list>\n            </div>\n    </div>\n</mat-card>\n",
                encapsulation: ViewEncapsulation.None,
                styles: [".adf-assignment-header{border-bottom:1px solid var(--theme-fg-divider);padding:6px 20px}.adf-assignment-count{float:left;font-weight:bolder;margin:13px;opacity:.54;padding:10px 0}.adf-add-people{cursor:pointer;float:right;height:26px;margin:13px;opacity:.54;padding:8px}.adf-add-people:hover{color:var(--theme-primary-color)}.adf-assignment-top-container.mat-card{align-items:stretch;border-top:1px solid var(--theme-fg-divider);display:flex;flex-flow:row wrap;margin:0;padding:0}.adf-assignment-top-container-content{align-items:stretch;display:flex;flex:1 0 auto;flex-flow:column;max-width:100%}.adf-assignment-container{border-bottom:1px solid var(--theme-fg-divider);max-width:100%;padding:10px 20px}.adf-assignment-list-container{padding:0}adf-people-list adf-datatable thead{display:none}adf-people-list adf-datatable .adf-datatable-cell{margin:13px}adf-people-list adf-datatable .adf-datatable .adf-datatable-cell .adf-cell-container{align-items:left;flex-direction:column}adf-people-list adf-datatable .adf-people-email{opacity:.54}.adf-people-img{border-radius:90%;height:40px;vertical-align:middle;width:40px}.adf-people-search-people-pic{background:var(--theme-primary-color);border-radius:100px;color:#fff;font-size:18px;font-weight:bolder;padding:10px 5px;text-align:center;text-transform:uppercase;vertical-align:text-bottom;width:30px}.adf-people-user-info{flex-direction:column;text-align:center}"]
            },] }
];
PeopleComponent.ctorParameters = () => [
    { type: LogService },
    { type: PeopleProcessService }
];
PeopleComponent.propDecorators = {
    people: [{ type: Input }],
    taskId: [{ type: Input }],
    readOnly: [{ type: Input }],
    peopleSearch: [{ type: ViewChild, args: ['peopleSearch',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVvcGxlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL3Byb2Nlc3Mtc2VydmljZXMvc3JjLyIsInNvdXJjZXMiOlsibGliL3Blb3BsZS9jb21wb25lbnRzL3Blb3BsZS9wZW9wbGUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7R0FlRztBQUVILE9BQU8sRUFBRSxVQUFVLEVBQW9CLG9CQUFvQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDeEYsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQy9FLE9BQU8sRUFBRSxVQUFVLEVBQVksTUFBTSxNQUFNLENBQUM7QUFFNUMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDakYsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBUXZDLE1BQU0sT0FBTyxlQUFlO0lBc0J4QixZQUFvQixVQUFzQixFQUFTLG9CQUEwQztRQUF6RSxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQVMseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQWxCN0YsV0FBTSxHQUF1QixFQUFFLENBQUM7UUFJaEMsV0FBTSxHQUFXLEVBQUUsQ0FBQztRQUlwQixhQUFRLEdBQVksS0FBSyxDQUFDO1FBSzFCLG1CQUFjLEdBQVksS0FBSyxDQUFDO1FBTTVCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxVQUFVLENBQXFCLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsUUFBUSxDQUFDO2FBQ3RHLElBQUksQ0FDRCxLQUFLLEVBQUUsQ0FDVixDQUFDO0lBQ1YsQ0FBQztJQUVELHlCQUF5QjtRQUNyQixJQUFJLElBQUksQ0FBQyxZQUFZ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LEdBQUcsSUFBSSxDQUFDO0lBQy9CLENBQUM7SUFFRCxhQUFhLENBQUMsS0FBcUI7UUFDL0IsSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUNqRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3hDO0lBQ0wsQ0FBQztJQUVELFNBQVM7UUFDTCxPQUFPLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFRCxVQUFVO1FBQ04sT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDMUIsQ0FBQztJQUVELGFBQWE7UUFDVCxJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQztJQUNoQyxDQUFDOzs7WUEzR0osU0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSxZQUFZO2dCQUN0QixtaEhBQXNDO2dCQUV0QyxhQUFhLEVBQUUsaUJBQWlCLENBQUMsSUFBSTs7YUFDeEM7OztZQVpRLFVBQVU7WUFBb0Isb0JBQW9COzs7cUJBZ0J0RCxLQUFLO3FCQUlMLEtBQUs7dUJBSUwsS0FBSzsyQkFHTCxTQUFTLFNBQUMsY0FBYyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IExvZ1NlcnZpY2UsIFVzZXJQcm9jZXNzTW9kZWwsIFBlb3BsZVByb2Nlc3NTZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIFZpZXdDaGlsZCwgVmlld0VuY2Fwc3VsYXRpb24gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIE9ic2VydmVyIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBVc2VyRXZlbnRNb2RlbCB9IGZyb20gJy4uLy4uLy4uL3Rhc2stbGlzdC9tb2RlbHMvdXNlci1ldmVudC5tb2RlbCc7XG5pbXBvcnQgeyBQZW9wbGVTZWFyY2hDb21wb25lbnQgfSBmcm9tICcuLi9wZW9wbGUtc2VhcmNoL3Blb3BsZS1zZWFyY2guY29tcG9uZW50JztcbmltcG9ydCB7IHNoYXJlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ2FkZi1wZW9wbGUnLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9wZW9wbGUuY29tcG9uZW50Lmh0bWwnLFxuICAgIHN0eWxlVXJsczogWycuL3Blb3BsZS5jb21wb25lbnQuc2NzcyddLFxuICAgIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmVcbn0pXG5leHBvcnQgY2xhc3MgUGVvcGxlQ29tcG9uZW50IHtcblxuICAgIC8qKiBUaGUgYXJyYXkgb2YgVXNlciBvYmplY3RzIHRvIGRpc3BsYXkuICovXG4gICAgQElucHV0KClcbiAgICBwZW9wbGU6IFVzZXJQcm9jZXNzTW9kZWxbXSA9IFtdO1xuXG4gICAgLyoqIFRoZSBudW1lcmljIElEIG9mIHRoZSB0YXNrLiAqL1xuICAgIEBJbnB1dCgpXG4gICAgdGFza0lkOiBzdHJpbmcgPSAnJztcblxuICAgIC8qKiBTaG91bGQgdGhlIGRhdGEgYmUgcmVhZC1vbmx5PyAqL1xuICAgIEBJbnB1dCgpXG4gICAgcmVhZE9ubHk6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIEBWaWV3Q2hpbGQoJ3Blb3BsZVNlYXJjaCcpXG4gICAgcGVvcGxlU2VhcmNoOiBQZW9wbGVTZWFyY2hDb21wb25lbnQ7XG5cbiAgICBzaG93QXNzaWdubWVudDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgcHJpdmF0ZSBwZW9wbGVTZWFyY2hPYnNlcnZlcjogT2JzZXJ2ZXI8VXNlclByb2Nlc3NNb2RlbFtdPjtcbiAgICBwZW9wbGVTZWFyY2gkOiBPYnNlcnZhYmxlPFVzZXJQcm9jZXNzTW9kZWxbXT47XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2UsIHB1YmxpYyBwZW9wbGVQcm9jZXNzU2VydmljZTogUGVvcGxlUHJvY2Vzc1NlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5wZW9wbGVTZWFyY2gkID0gbmV3IE9ic2VydmFibGU8VXNlclByb2Nlc3NNb2RlbFtdPigob2JzZXJ2ZXIpID0+IHRoaXMucGVvcGxlU2VhcmNoT2JzZXJ2ZXIgPSBvYnNlcnZlcilcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIHNoYXJlKClcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgaW52b2x2ZVVzZXJBbmRDbG9zZVNlYXJjaCgpIHtcbiAgICAgICAgaWYgKHRoaXMucGVvcGxlU2VhcmNoKSB7XG4gICAgICAgICAgICB0aGlzLnBlb3BsZVNlYXJjaC5pbnZvbHZlVXNlckFuZENsb3NlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpbnZvbHZlVXNlcldpdGhvdXRDbG9zZVNlYXJjaCgpIHtcbiAgICAgICAgaWYgKHRoaXMucGVvcGxlU2VhcmNoKSB7XG4gICAgICAgICAgICB0aGlzLnBlb3BsZVNlYXJjaC5pbnZvbHZlVXNlcigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2VhcmNoVXNlcihzZWFyY2hlZFdvcmQ6IHN0cmluZykge1xuICAgICAgICB0aGlzLnBlb3BsZVByb2Nlc3NTZXJ2aWNlLmdldFdvcmtmbG93VXNlcnModGhpcy50YXNrSWQsIHNlYXJjaGVkV29yZClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKHVzZXJzKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5wZW9wbGVTZWFyY2hPYnNlcnZlci5uZXh0KHVzZXJzKTtcbiAgICAgICAgICAgIH0sIChlcnJvcikgPT4gdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGVycm9yKSk7XG4gICAgfVxuXG4gICAgaW52b2x2ZVVzZXIodXNlcjogVXNlclByb2Nlc3NNb2RlbCkge1xuICAgICAgICBpZiAodXNlciAmJiB1c2VyLmlkKSB7XG4gICAgICAgICAgICB0aGlzLnBlb3BsZVByb2Nlc3NTZXJ2aWNlXG4gICAgICAgICAgICAgICAgLmludm9sdmVVc2VyV2l0aFRhc2sodGhpcy50YXNrSWQsIHVzZXIuaWQudG9TdHJpbmcoKSlcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiB0aGlzLnBlb3BsZSA9IFsuLi50aGlzLnBlb3BsZSwgdXNlcl0sXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHRoaXMubG9nU2VydmljZS5lcnJvcignSW1wb3NzaWJsZSB0byBpbnZvbHZlIHVzZXIgd2l0aCB0YXNrJylcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVtb3ZlSW52b2x2ZWRVc2VyKHVzZXI6IFVzZXJQcm9jZXNzTW9kZWwpIHtcbiAgICAgICAgdGhpcy5wZW9wbGVQcm9jZXNzU2VydmljZVxuICAgICAgICAgICAgLnJlbW92ZUludm9sdmVkVXNlcih0aGlzLnRhc2tJZCwgdXNlci5pZC50b1N0cmluZygpKVxuICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGVvcGxlID0gdGhpcy5wZW9wbGUuZmlsdGVyKGludm9sdmVkVXNlciA9PiBpbnZvbHZlZFVzZXIuaWQgIT09IHVzZXIuaWQpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKCkgPT4gdGhpcy5sb2dTZXJ2aWNlLmVycm9yKCdJbXBvc3NpYmxlIHRvIHJlbW92ZSBpbnZvbHZlZCB1c2VyIGZyb20gdGFzaycpKTtcbiAgICB9XG5cbiAgICBnZXREaXNwbGF5VXNlcihmaXJzdE5hbWU6IHN0cmluZywgbGFzdE5hbWU6IHN0cmluZywgZGVsaW1pdGVyOiBzdHJpbmcgPSAnLScpOiBzdHJpbmcge1xuICAgICAgICBmaXJzdE5hbWUgPSAoZmlyc3ROYW1lICE9PSBudWxsID8gZmlyc3ROYW1lIDogJycpO1xuICAgICAgICBsYXN0TmFtZSA9IChsYXN0TmFtZSAhPT0gbnVsbCA/IGxhc3ROYW1lIDogJycpO1xuICAgICAgICByZXR1cm4gZmlyc3ROYW1lICsgZGVsaW1pdGVyICsgbGFzdE5hbWU7XG4gICAgfVxuXG4gICAgZ2V0SW5pdGlhbFVzZXJOYW1lKGZpcnN0TmFtZTogc3RyaW5nLCBsYXN0TmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGZpcnN0TmFtZSA9IChmaXJzdE5hbWUgIT09IG51bGwgJiYgZmlyc3ROYW1lICE9PSAnJyA/IGZpcnN0TmFtZVswXSA6ICcnKTtcbiAgICAgICAgbGFzdE5hbWUgPSAobGFzdE5hbWUgIT09IG51bGwgJiYgbGFzdE5hbWUgIT09ICcnID8gbGFzdE5hbWVbMF0gOiAnJyk7XG4gICAgICAgIHJldHVybiB0aGlzLmdldERpc3BsYXlVc2VyKGZpcnN0TmFtZSwgbGFzdE5hbWUsICcnKTtcbiAgICB9XG5cbiAgICBvbkFkZEFzc2lnbm1lbnQoKSB7XG4gICAgICAgIHRoaXMuc2hvd0Fzc2lnbm1lbnQgPSB0cnVlO1xuICAgIH1cblxuICAgIG9uQ2xpY2tBY3Rpb24oZXZlbnQ6IFVzZXJFdmVudE1vZGVsKSB7XG4gICAgICAgIGlmIChldmVudCAmJiBldmVudC52YWx1ZSAmJiBldmVudC50eXBlID09PSAncmVtb3ZlJykge1xuICAgICAgICAgICAgdGhpcy5yZW1vdmVJbnZvbHZlZFVzZXIoZXZlbnQudmFsdWUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaGFzUGVvcGxlKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wZW9wbGUgJiYgdGhpcy5wZW9wbGUubGVuZ3RoID4gMDtcbiAgICB9XG5cbiAgICBpc0VkaXRNb2RlKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gIXRoaXMucmVhZE9ubHk7XG4gICAgfVxuXG4gICAgb25DbG9zZVNlYXJjaCgpIHtcbiAgICAgICAgdGhpcy5zaG93QXNzaWdubWVudCA9IGZhbHNlO1xuICAgIH1cbn1cbiJdfQ==