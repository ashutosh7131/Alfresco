import { MatDialog } from '@angular/material/dialog';
import { EventEmitter, Injectable, Output } from '@angular/core';
import { TranslationService } from '@alfresco/adf-core';
import { of, Subject } from 'rxjs';
import { ContentApi } from '@alfresco/js-api';
import { AttachFileWidgetDialogComponent } from './attach-file-widget-dialog.component';
import { switchMap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/material/dialog";
import * as i2 from "@alfresco/adf-core";
export class AttachFileWidgetDialogService {
    constructor(dialog, translation) {
        this.dialog = dialog;
        this.translation = translation;
        this.externalApis = {};
        this.error = new EventEmitter();
    }
    openLogin(repository, currentFolderId = '-my-', accountIdentifier) {
        const { title, ecmHost, selected, registerExternalHost } = this.constructPayload(repository);
        const data = {
            title,
            selected,
            ecmHost,
            currentFolderId,
            isSelectionValid: (entry) => entry.isFile,
            showFilesInResult: true,
            registerExternalHost,
            accountIdentifier
        };
        this.openLoginDialog(data, 'adf-attach-file-widget-dialog', '630px');
        return selected;
    }
    openLoginDialog(data, currentPanelClass, chosenWidth) {
        this.dialog.open(AttachFileWidgetDialogComponent, { data, panelClass: currentPanelClass, width: chosenWidth });
    }
    showExternalHostLoginDialog(repository) {
        const data = Object.assign(Object.assign({}, this.constructPayload(repository)), { loginOnly: true });
        return this.dialog.open(AttachFileWidgetDialogComponent, { data, panelClass: 'adf-attach-file-widget-dialog', width: '630px' })
            .afterClosed();
    }
    downloadURL(repository, sourceId) {
        var _a;
        const { accountIdentifier } = this.constructPayload(repository);
        if ((_a = this.externalApis[accountIdentifier]) === null || _a === void 0 ? void 0 : _a.getInstance()) {
            const contentApi = new ContentApi(this.externalApis[accountIdentifier].getInstance());
            if (this.externalApis[accountIdentifier].getInstance().isLoggedIn()) {
                return of(contentApi.getContentUrl(sourceId));
            }
        }
        return this.showExternalHostLoginDialog(repository).pipe(switchMap(() => {
            const contentApi = new ContentApi(this.externalApis[accountIdentifier].getInstance());
            return of(contentApi.getContentUrl(sourceId));
        }));
    }
    constructPayload(repository) {
        const accountIdentifier = 'alfresco-' + repository.id + '-' + repository.name;
        const ecmHost = repository.repositoryUrl.replace('/alfresco', '');
        const selected = new Subject();
        selected.subscribe({
            complete: this.close.bind(this)
        });
        const title = this.getLoginTitleTranslation(ecmHost);
        const registerExternalHost = this.addService.bind(this);
        return { ecmHost, accountIdentifier, selected, title, registerExternalHost };
    }
    addService(accountIdentifier, apiService) {
        if (!this.externalApis[accountIdentifier]) {
            this.externalApis[accountIdentifier] = apiService;
        }
    }
    close() {
        this.dialog.closeAll();
    }
    getLoginTitleTranslation(ecmHost) {
        return this.translation.instant(`ATTACH-FILE.DIALOG.LOGIN`, { ecmHost });
    }
}
AttachFileWidgetDialogService.ɵprov = i0.ɵɵdefineInjectable({ factory: function AttachFileWidgetDialogService_Factory() { return new AttachFileWidgetDialogService(i0.ɵɵinject(i1.MatDialog), i0.ɵɵinject(i2.TranslationService)); }, token: AttachFileWidgetDialogService, providedIn: "root" });
AttachFileWidgetDialogService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
AttachFileWidgetDialogService.ctorParameters = () => [
    { type: MatDialog },
    { type: TranslationService }
];
AttachFileWidgetDialogService.propDecorators = {
    error: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNoLWZpbGUtd2lkZ2V0LWRpYWxvZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvcHJvY2Vzcy1zZXJ2aWNlcy9zcmMvIiwic291cmNlcyI6WyJsaWIvY29udGVudC13aWRnZXQvYXR0YWNoLWZpbGUtd2lkZ2V0LWRpYWxvZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDckQsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pFLE9BQU8sRUFBc0Isa0JBQWtCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM1RSxPQUFPLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQyxPQUFPLEVBQXdDLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3BGLE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBQ3hGLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQU0zQyxNQUFNLE9BQU8sNkJBQTZCO0lBT3RDLFlBQW9CLE1BQWlCLEVBQ2pCLFdBQStCO1FBRC9CLFdBQU0sR0FBTixNQUFNLENBQVc7UUFDakIsZ0JBQVcsR0FBWCxXQUFXLENBQW9CO1FBUDNDLGlCQUFZLEdBQTBDLEVBQUUsQ0FBQztRQUlqRSxVQUFLLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7SUFJbkQsQ0FBQztJQVFELFNBQVMsQ0FBQyxVQUEwQyxFQUFFLGVBQWUsR0FBRyxNQUFNLEVBQUUsaUJBQTBCO1FBQ3RHLE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxvQkFBb0IsRUFBRSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FB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QUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3hELE9BQU8sRUFBRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxvQkFBb0IsRUFBRSxDQUFDO0lBQ2pGLENBQUM7SUFFRCxVQUFVLENBQUMsaUJBQXlCLEVBQUUsVUFBOEI7UUFDaEUsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsaUJBQWlCLENBQUMsRUFBRTtZQUN2QyxJQUFJLENBQUMsWUFBWSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsVUFBVSxDQUFDO1NBQ3JEO0lBQ0wsQ0FBQztJQUdELEtBQUs7UUFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFTyx3QkFBd0IsQ0FBQyxPQUFlO1FBQzVDLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsMEJBQTBCLEVBQUUsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBQzdFLENBQUM7Ozs7WUEvRkosVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7WUFYUSxTQUFTO1lBRVcsa0JBQWtCOzs7b0JBZTFDLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBNYXREaWFsb2cgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9kaWFsb2cnO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCBJbmplY3RhYmxlLCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSwgVHJhbnNsYXRpb25TZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBBdHRhY2hGaWxlV2lkZ2V0RGlhbG9nQ29tcG9uZW50RGF0YSB9IGZyb20gJy4vYXR0YWNoLWZpbGUtd2lkZ2V0LWRpYWxvZy1jb21wb25lbnQuaW50ZXJmYWNlJztcbmltcG9ydCB7IEFsZnJlc2NvRW5kcG9pbnRSZXByZXNlbnRhdGlvbiwgTm9kZSwgQ29udGVudEFwaSB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgQXR0YWNoRmlsZVdpZGdldERpYWxvZ0NvbXBvbmVudCB9IGZyb20gJy4vYXR0YWNoLWZpbGUtd2lkZ2V0LWRpYWxvZy5jb21wb25lbnQnO1xuaW1wb3J0IHsgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBkaXJlY3RpdmUtY2xhc3Mtc3VmZml4XG5leHBvcnQgY2xhc3MgQXR0YWNoRmlsZVdpZGdldERpYWxvZ1NlcnZpY2Uge1xuICAgIHByaXZhdGUgZXh0ZXJuYWxBcGlzOiB7IFtrZXk6IHN0cmluZ106IEFsZnJlc2NvQXBpU2VydmljZSB9ID0ge307XG5cbiAgICAvKiogRW1pdHRlZCB3aGVuIGFuIGVycm9yIG9jY3Vycy4gKi9cbiAgICBAT3V0cHV0KClcbiAgICBlcnJvcjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZGlhbG9nOiBNYXREaWFsb2csXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSB0cmFuc2xhdGlvbjogVHJhbnNsYXRpb25TZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogT3BlbnMgYSBkaWFsb2cgdG8gY2hvb3NlIGEgZmlsZSB0byB1cGxvYWQuXG4gICAgICogQHBhcmFtIHJlcG9zaXRvcnkgQWxmcmVzY28gZW5kcG9pbnQgdGhhdCByZXByZXNlbnRzIHRoZSBjb250ZW50IHNlcnZpY2VcbiAgICAgKiBAcGFyYW0gY3VycmVudEZvbGRlcklkIFVwbG9hZCBmaWxlIGZyb20gc3BlY2lmaWMgZm9sZGVyXG4gICAgICogQHJldHVybnMgSW5mb3JtYXRpb24gYWJvdXQgdGhlIGNob3NlbiBmaWxlKHMpXG4gICAgICovXG4gICAgb3BlbkxvZ2luKHJlcG9zaXRvcnk6IEFsZnJlc2NvRW5kcG9pbnRSZXByZXNlbnRhdGlvbiwgY3VycmVudEZvbGRlcklkID0gJy1teS0nLCBhY2NvdW50SWRlbnRpZmllcj86IHN0cmluZyk6IE9ic2VydmFibGU8Tm9kZVtdPiB7XG4gICAgICAgIGNvbnN0IHsgdGl0bGUsIGVjbUhvc3QsIHNlbGVjdGVkLCByZWdpc3RlckV4dGVybmFsSG9zdCB9ID0gdGhpcy5jb25zdHJ1Y3RQYXlsb2FkKHJlcG9zaXRvcnkpO1xuICAgICAgICBjb25zdCBkYXRhOiBBdHRhY2hGaWxlV2lkZ2V0RGlhbG9nQ29tcG9uZW50RGF0YSA9IHtcbiAgICAgICAgICAgIHRpdGxlLFxuICAgICAgICAgICAgc2VsZWN0ZWQsXG4gICAgICAgICAgICBlY21Ib3N0LFxuICAgICAgICAgICAgY3VycmVudEZvbGRlcklkLFxuICAgICAgICAgICAgaXNTZWxlY3Rpb25WYWxpZDogKGVudHJ5OiBOb2RlKSA9PiBlbnRyeS5pc0ZpbGUsXG4gICAgICAgICAgICBzaG93RmlsZXNJblJlc3VsdDogdHJ1ZSxcbiAgICAgICAgICAgIHJlZ2lzdGVyRXh0ZXJuYWxIb3N0LFxuICAgICAgICAgICAgYWNjb3VudElkZW50aWZpZXJcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLm9wZW5Mb2dpbkRpYWxvZyhkYXRhLCAnYWRmLWF0dGFjaC1maWxlLXdpZGdldC1kaWFsb2cnLCAnNjMwcHgnKTtcbiAgICAgICAgcmV0dXJuIHNlbGVjdGVkO1xuICAgIH1cblxuICAgIHByaXZhdGUgb3BlbkxvZ2luRGlhbG9nKGRhdGE6IEF0dGFjaEZpbGVXaWRnZXREaWFsb2dDb21wb25lbnREYXRhLCBjdXJyZW50UGFuZWxDbGFzczogc3RyaW5nLCBjaG9zZW5XaWR0aDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuZGlhbG9nLm9wZW4oQXR0YWNoRmlsZVdpZGdldERpYWxvZ0NvbXBvbmVudCwgeyBkYXRhLCBwYW5lbENsYXNzOiBjdXJyZW50UGFuZWxDbGFzcywgd2lkdGg6IGNob3NlbldpZHRoIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2hvd0V4dGVybmFsSG9zdExvZ2luRGlhbG9nKHJlcG9zaXRvcnk6IEFsZnJlc2NvRW5kcG9pbnRSZXByZXNlbnRhdGlvbik6IE9ic2VydmFibGU8QWxmcmVzY29BcGlTZXJ2aWNlPiB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgICAgICAuLi50aGlzLmNvbnN0cnVjdFBheWxvYWQocmVwb3NpdG9yeSksXG4gICAgICAgICAgICBsb2dpbk9ubHk6IHRydWVcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGlhbG9nLm9wZW4oQXR0YWNoRmlsZVdpZGdldERpYWxvZ0NvbXBvbmVudCwgeyBkYXRhLCBwYW5lbENsYXNzOiAnYWRmLWF0dGFjaC1maWxlLXdpZGdldC1kaWFsb2cnLCB3aWR0aDogJzYzMHB4JyB9KVxuICAgICAgICAgICAgLmFmdGVyQ2xvc2VkKCk7XG4gICAgfVxuXG4gICAgZG93bmxvYWRVUkwocmVwb3NpdG9yeTogQWxmcmVzY29FbmRwb2ludFJlcHJlc2VudGF0aW9uLCBzb3VyY2VJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICAgICAgY29uc3QgeyBhY2NvdW50SWRlbnRpZmllciB9ID0gdGhpcy5jb25zdHJ1Y3RQYXlsb2FkKHJlcG9zaXRvcnkpO1xuXG4gICAgICAgIGlmICh0aGlzLmV4dGVybmFsQXBpc1thY2NvdW50SWRlbnRpZmllcl0/LmdldEluc3RhbmNlKCkpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnRBcGkgPSBuZXcgQ29udGVudEFwaSh0aGlzLmV4dGVybmFsQXBpc1thY2NvdW50SWRlbnRpZmllcl0uZ2V0SW5zdGFuY2UoKSk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmV4dGVybmFsQXBpc1thY2NvdW50SWRlbnRpZmllcl0uZ2V0SW5zdGFuY2UoKS5pc0xvZ2dlZEluKCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YoY29udGVudEFwaS5nZXRDb250ZW50VXJsKHNvdXJjZUlkKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5zaG93RXh0ZXJuYWxIb3N0TG9naW5EaWFsb2cocmVwb3NpdG9yeSkucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgY29udGVudEFwaSA9IG5ldyBDb250ZW50QXBpKHRoaXMuZXh0ZXJuYWxBcGlzW2FjY291bnRJZGVudGlmaWVyXS5nZXRJbnN0YW5jZSgpKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YoY29udGVudEFwaS5nZXRDb250ZW50VXJsKHNvdXJjZUlkKSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgY29uc3RydWN0UGF5bG9hZChyZXBvc2l0b3J5OiBBbGZyZXNjb0VuZHBvaW50UmVwcmVzZW50YXRpb24pIHtcbiAgICAgICAgY29uc3QgYWNjb3VudElkZW50aWZpZXIgPSAnYWxmcmVzY28tJyArIHJlcG9zaXRvcnkuaWQgKyAnLScgKyByZXBvc2l0b3J5Lm5hbWU7XG4gICAgICAgIGNvbnN0IGVjbUhvc3QgPSByZXBvc2l0b3J5LnJlcG9zaXRvcnlVcmwucmVwbGFjZSgnL2FsZnJlc2NvJywgJycpO1xuICAgICAgICBjb25zdCBzZWxlY3RlZCA9IG5ldyBTdWJqZWN0PE5vZGVbXT4oKTtcbiAgICAgICAgc2VsZWN0ZWQuc3Vic2NyaWJlKHtcbiAgICAgICAgICAgIGNvbXBsZXRlOiB0aGlzLmNsb3NlLmJpbmQodGhpcylcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHRpdGxlID0gdGhpcy5nZXRMb2dpblRpdGxlVHJhbnNsYXRpb24oZWNtSG9zdCk7XG4gICAgICAgIGNvbnN0IHJlZ2lzdGVyRXh0ZXJuYWxIb3N0ID0gdGhpcy5hZGRTZXJ2aWNlLmJpbmQodGhpcyk7XG4gICAgICAgIHJldHVybiB7IGVjbUhvc3QsIGFjY291bnRJZGVudGlmaWVyLCBzZWxlY3RlZCwgdGl0bGUsIHJlZ2lzdGVyRXh0ZXJuYWxIb3N0IH07XG4gICAgfVxuXG4gICAgYWRkU2VydmljZShhY2NvdW50SWRlbnRpZmllcjogc3RyaW5nLCBhcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UpIHtcbiAgICAgICAgaWYgKCF0aGlzLmV4dGVybmFsQXBpc1thY2NvdW50SWRlbnRpZmllcl0pIHtcbiAgICAgICAgICAgIHRoaXMuZXh0ZXJuYWxBcGlzW2FjY291bnRJZGVudGlmaWVyXSA9IGFwaVNlcnZpY2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKiogQ2xvc2VzIHRoZSBjdXJyZW50bHkgb3BlbiBkaWFsb2cuICovXG4gICAgY2xvc2UoKSB7XG4gICAgICAgIHRoaXMuZGlhbG9nLmNsb3NlQWxsKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRMb2dpblRpdGxlVHJhbnNsYXRpb24oZWNtSG9zdDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNsYXRpb24uaW5zdGFudChgQVRUQUNILUZJTEUuRElBTE9HLkxPR0lOYCwgeyBlY21Ib3N0IH0pO1xuICAgIH1cbn1cbiJdfQ==