import { MatDialog } from '@angular/material/dialog';
import { EventEmitter, Injectable, Output } from '@angular/core';
import { TranslationService } from '@alfresco/adf-core';
import { of, Subject } from 'rxjs';
import { ContentApi } from '@alfresco/js-api';
import { AttachFileWidgetDialogComponent } from './attach-file-widget-dialog.component';
import { switchMap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/material/dialog";
import * as i2 from "@alfresco/adf-core";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/material/dialog';
import * as ɵngcc2 from '@alfresco/adf-core';
export class AttachFileWidgetDialogService {
    constructor(dialog, translation) {
        this.dialog = dialog;
        this.translation = translation;
        this.externalApis = {};
        this.error = new EventEmitter();
    }
    openLogin(repository, currentFolderId = '-my-', accountIdentifier) {
        const { title, ecmHost, selected, registerExternalHost } = this.constructPayload(repository);
        const data = {
            title,
            selected,
            ecmHost,
            currentFolderId,
            isSelectionValid: (entry) => entry.isFile,
            showFilesInResult: true,
            registerExternalHost,
            accountIdentifier
        };
        this.openLoginDialog(data, 'adf-attach-file-widget-dialog', '630px');
        return selected;
    }
    openLoginDialog(data, currentPanelClass, chosenWidth) {
        this.dialog.open(AttachFileWidgetDialogComponent, { data, panelClass: currentPanelClass, width: chosenWidth });
    }
    showExternalHostLoginDialog(repository) {
        const data = Object.assign(Object.assign({}, this.constructPayload(repository)), { loginOnly: true });
        return this.dialog.open(AttachFileWidgetDialogComponent, { data, panelClass: 'adf-attach-file-widget-dialog', width: '630px' })
            .afterClosed();
    }
    downloadURL(repository, sourceId) {
        var _a;
        const { accountIdentifier } = this.constructPayload(repository);
        if ((_a = this.externalApis[accountIdentifier]) === null || _a === void 0 ? void 0 : _a.getInstance()) {
            const contentApi = new ContentApi(this.externalApis[accountIdentifier].getInstance());
            if (this.externalApis[accountIdentifier].getInstance().isLoggedIn()) {
                return of(contentApi.getContentUrl(sourceId));
            }
        }
        return this.showExternalHostLoginDialog(repository).pipe(switchMap(() => {
            const contentApi = new ContentApi(this.externalApis[accountIdentifier].getInstance());
            return of(contentApi.getContentUrl(sourceId));
        }));
    }
    constructPayload(repository) {
        const accountIdentifier = 'alfresco-' + repository.id + '-' + repository.name;
        const ecmHost = repository.repositoryUrl.replace('/alfresco', '');
        const selected = new Subject();
        selected.subscribe({
            complete: this.close.bind(this)
        });
        const title = this.getLoginTitleTranslation(ecmHost);
        const registerExternalHost = this.addService.bind(this);
        return { ecmHost, accountIdentifier, selected, title, registerExternalHost };
    }
    addService(accountIdentifier, apiService) {
        if (!this.externalApis[accountIdentifier]) {
            this.externalApis[accountIdentifier] = apiService;
        }
    }
    close() {
        this.dialog.closeAll();
    }
    getLoginTitleTranslation(ecmHost) {
        return this.translation.instant(`ATTACH-FILE.DIALOG.LOGIN`, { ecmHost });
    }
}
AttachFileWidgetDialogService.ɵfac = function AttachFileWidgetDialogService_Factory(t) { return new (t || AttachFileWidgetDialogService)(ɵngcc0.ɵɵinject(ɵngcc1.MatDialog), ɵngcc0.ɵɵinject(ɵngcc2.TranslationService)); };
AttachFileWidgetDialogService.ɵprov = i0.ɵɵdefineInjectable({ factory: function AttachFileWidgetDialogService_Factory() { return new AttachFileWidgetDialogService(i0.ɵɵinject(i1.MatDialog), i0.ɵɵinject(i2.TranslationService)); }, token: AttachFileWidgetDialogService, providedIn: "root" });
AttachFileWidgetDialogService.ctorParameters = () => [
    { type: MatDialog },
    { type: TranslationService }
];
AttachFileWidgetDialogService.propDecorators = {
    error: [{ type: Output }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AttachFileWidgetDialogService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.MatDialog }, { type: ɵngcc2.TranslationService }]; }, { error: [{
            type: Output
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNoLWZpbGUtd2lkZ2V0LWRpYWxvZy5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvcHJvY2Vzcy1zZXJ2aWNlcy9zcmMvbGliL2NvbnRlbnQtd2lkZ2V0L2F0dGFjaC1maWxlLXdpZGdldC1kaWFsb2cuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFpQkEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqRSxPQUFPLEVBQXNCLGtCQUFrQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDNUUsT0FBTyxFQUFjLEVBQUUsRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0MsT0FBTyxFQUF3QyxVQUFVLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNwRixPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQztBQUN4RixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0M7QUFFc0I7QUFFc0I7Ozs7QUFDNUMsTUFBTSxPQUFPLDZCQUE2QjtBQUMxQyxJQU1JLFlBQW9CLE1BQWlCLEVBQ2pCLFdBQStCO0FBQ3ZELFFBRndCLFdBQU0sR0FBTixNQUFNLENBQVc7QUFBQyxRQUNsQixnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7QUFBQyxRQVA1QyxpQkFBWSxHQUEwQyxFQUFFLENBQUM7QUFDckUsUUFHSSxVQUFLLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7QUFDdkQsSUFHSSxDQUFDO0FBQ0wsSUFPSSxTQUFTLENBQUMsVUFBMEMsRUFBRSxlQUFlLEdBQUcsTUFBTSxFQUFFLGlCQUEwQjtBQUFJLFFBQzFH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QVZBLFlBRU8sa0JBQWtCO0FBQUc7VUFTakQsVkFUb0Q7QUFDNUIsb0JBY3BCLE1BQU07QUFDVjs7Ozs7Ozs7b0JBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IE1hdERpYWxvZyB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2RpYWxvZyc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIsIEluamVjdGFibGUsIE91dHB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlLCBUcmFuc2xhdGlvblNlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEF0dGFjaEZpbGVXaWRnZXREaWFsb2dDb21wb25lbnREYXRhIH0gZnJvbSAnLi9hdHRhY2gtZmlsZS13aWRnZXQtZGlhbG9nLWNvbXBvbmVudC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQWxmcmVzY29FbmRwb2ludFJlcHJlc2VudGF0aW9uLCBOb2RlLCBDb250ZW50QXBpIH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBBdHRhY2hGaWxlV2lkZ2V0RGlhbG9nQ29tcG9uZW50IH0gZnJvbSAnLi9hdHRhY2gtZmlsZS13aWRnZXQtZGlhbG9nLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGRpcmVjdGl2ZS1jbGFzcy1zdWZmaXhcbmV4cG9ydCBjbGFzcyBBdHRhY2hGaWxlV2lkZ2V0RGlhbG9nU2VydmljZSB7XG4gICAgcHJpdmF0ZSBleHRlcm5hbEFwaXM6IHsgW2tleTogc3RyaW5nXTogQWxmcmVzY29BcGlTZXJ2aWNlIH0gPSB7fTtcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gYW4gZXJyb3Igb2NjdXJzLiAqL1xuICAgIEBPdXRwdXQoKVxuICAgIGVycm9yOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBkaWFsb2c6IE1hdERpYWxvZyxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRyYW5zbGF0aW9uOiBUcmFuc2xhdGlvblNlcnZpY2UpIHtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPcGVucyBhIGRpYWxvZyB0byBjaG9vc2UgYSBmaWxlIHRvIHVwbG9hZC5cbiAgICAgKiBAcGFyYW0gcmVwb3NpdG9yeSBBbGZyZXNjbyBlbmRwb2ludCB0aGF0IHJlcHJlc2VudHMgdGhlIGNvbnRlbnQgc2VydmljZVxuICAgICAqIEBwYXJhbSBjdXJyZW50Rm9sZGVySWQgVXBsb2FkIGZpbGUgZnJvbSBzcGVjaWZpYyBmb2xkZXJcbiAgICAgKiBAcmV0dXJucyBJbmZvcm1hdGlvbiBhYm91dCB0aGUgY2hvc2VuIGZpbGUocylcbiAgICAgKi9cbiAgICBvcGVuTG9naW4ocmVwb3NpdG9yeTogQWxmcmVzY29FbmRwb2ludFJlcHJlc2VudGF0aW9uLCBjdXJyZW50Rm9sZGVySWQgPSAnLW15LScsIGFjY291bnRJZGVudGlmaWVyPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxOb2RlW10+IHtcbiAgICAgICAgY29uc3QgeyB0aXRsZSwgZWNtSG9zdCwgc2VsZWN0ZWQsIHJlZ2lzdGVyRXh0ZXJuYWxIb3N0IH0gPSB0aGlzLmNvbnN0cnVjdFBheWxvYWQocmVwb3NpdG9yeSk7XG4gICAgICAgIGNvbnN0IGRhdGE6IEF0dGFjaEZpbGVXaWRnZXREaWFsb2dDb21wb25lbnREYXRhID0ge1xuICAgICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgICBzZWxlY3RlZCxcbiAgICAgICAgICAgIGVjbUhvc3QsXG4gICAgICAgICAgICBjdXJyZW50Rm9sZGVySWQsXG4gICAgICAgICAgICBpc1NlbGVjdGlvblZhbGlkOiAoZW50cnk6IE5vZGUpID0+IGVudHJ5LmlzRmlsZSxcbiAgICAgICAgICAgIHNob3dGaWxlc0luUmVzdWx0OiB0cnVlLFxuICAgICAgICAgICAgcmVnaXN0ZXJFeHRlcm5hbEhvc3QsXG4gICAgICAgICAgICBhY2NvdW50SWRlbnRpZmllclxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMub3BlbkxvZ2luRGlhbG9nKGRhdGEsICdhZGYtYXR0YWNoLWZpbGUtd2lkZ2V0LWRpYWxvZycsICc2MzBweCcpO1xuICAgICAgICByZXR1cm4gc2VsZWN0ZWQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvcGVuTG9naW5EaWFsb2coZGF0YTogQXR0YWNoRmlsZVdpZGdldERpYWxvZ0NvbXBvbmVudERhdGEsIGN1cnJlbnRQYW5lbENsYXNzOiBzdHJpbmcsIGNob3NlbldpZHRoOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5kaWFsb2cub3BlbihBdHRhY2hGaWxlV2lkZ2V0RGlhbG9nQ29tcG9uZW50LCB7IGRhdGEsIHBhbmVsQ2xhc3M6IGN1cnJlbnRQYW5lbENsYXNzLCB3aWR0aDogY2hvc2VuV2lkdGggfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzaG93RXh0ZXJuYWxIb3N0TG9naW5EaWFsb2cocmVwb3NpdG9yeTogQWxmcmVzY29FbmRwb2ludFJlcHJlc2VudGF0aW9uKTogT2JzZXJ2YWJsZTxBbGZyZXNjb0FwaVNlcnZpY2U+IHtcbiAgICAgICAgY29uc3QgZGF0YSA9IHtcbiAgICAgICAgICAgIC4uLnRoaXMuY29uc3RydWN0UGF5bG9hZChyZXBvc2l0b3J5KSxcbiAgICAgICAgICAgIGxvZ2luT25seTogdHJ1ZVxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gdGhpcy5kaWFsb2cub3BlbihBdHRhY2hGaWxlV2lkZ2V0RGlhbG9nQ29tcG9uZW50LCB7IGRhdGEsIHBhbmVsQ2xhc3M6ICdhZGYtYXR0YWNoLWZpbGUtd2lkZ2V0LWRpYWxvZycsIHdpZHRoOiAnNjMwcHgnIH0pXG4gICAgICAgICAgICAuYWZ0ZXJDbG9zZWQoKTtcbiAgICB9XG5cbiAgICBkb3dubG9hZFVSTChyZXBvc2l0b3J5OiBBbGZyZXNjb0VuZHBvaW50UmVwcmVzZW50YXRpb24sIHNvdXJjZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgICAgICBjb25zdCB7IGFjY291bnRJZGVudGlmaWVyIH0gPSB0aGlzLmNvbnN0cnVjdFBheWxvYWQocmVwb3NpdG9yeSk7XG5cbiAgICAgICAgaWYgKHRoaXMuZXh0ZXJuYWxBcGlzW2FjY291bnRJZGVudGlmaWVyXT8uZ2V0SW5zdGFuY2UoKSkge1xuICAgICAgICAgICAgY29uc3QgY29udGVudEFwaSA9IG5ldyBDb250ZW50QXBpKHRoaXMuZXh0ZXJuYWxBcGlzW2FjY291bnRJZGVudGlmaWVyXS5nZXRJbnN0YW5jZSgpKTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuZXh0ZXJuYWxBcGlzW2FjY291bnRJZGVudGlmaWVyXS5nZXRJbnN0YW5jZSgpLmlzTG9nZ2VkSW4oKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBvZihjb250ZW50QXBpLmdldENvbnRlbnRVcmwoc291cmNlSWQpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLnNob3dFeHRlcm5hbEhvc3RMb2dpbkRpYWxvZyhyZXBvc2l0b3J5KS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50QXBpID0gbmV3IENvbnRlbnRBcGkodGhpcy5leHRlcm5hbEFwaXNbYWNjb3VudElkZW50aWZpZXJdLmdldEluc3RhbmNlKCkpO1xuICAgICAgICAgICAgICAgIHJldHVybiBvZihjb250ZW50QXBpLmdldENvbnRlbnRVcmwoc291cmNlSWQpKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3RQYXlsb2FkKHJlcG9zaXRvcnk6IEFsZnJlc2NvRW5kcG9pbnRSZXByZXNlbnRhdGlvbikge1xuICAgICAgICBjb25zdCBhY2NvdW50SWRlbnRpZmllciA9ICdhbGZyZXNjby0nICsgcmVwb3NpdG9yeS5pZCArICctJyArIHJlcG9zaXRvcnkubmFtZTtcbiAgICAgICAgY29uc3QgZWNtSG9zdCA9IHJlcG9zaXRvcnkucmVwb3NpdG9yeVVybC5yZXBsYWNlKCcvYWxmcmVzY28nLCAnJyk7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkID0gbmV3IFN1YmplY3Q8Tm9kZVtdPigpO1xuICAgICAgICBzZWxlY3RlZC5zdWJzY3JpYmUoe1xuICAgICAgICAgICAgY29tcGxldGU6IHRoaXMuY2xvc2UuYmluZCh0aGlzKVxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgdGl0bGUgPSB0aGlzLmdldExvZ2luVGl0bGVUcmFuc2xhdGlvbihlY21Ib3N0KTtcbiAgICAgICAgY29uc3QgcmVnaXN0ZXJFeHRlcm5hbEhvc3QgPSB0aGlzLmFkZFNlcnZpY2UuYmluZCh0aGlzKTtcbiAgICAgICAgcmV0dXJuIHsgZWNtSG9zdCwgYWNjb3VudElkZW50aWZpZXIsIHNlbGVjdGVkLCB0aXRsZSwgcmVnaXN0ZXJFeHRlcm5hbEhvc3QgfTtcbiAgICB9XG5cbiAgICBhZGRTZXJ2aWNlKGFjY291bnRJZGVudGlmaWVyOiBzdHJpbmcsIGFwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSkge1xuICAgICAgICBpZiAoIXRoaXMuZXh0ZXJuYWxBcGlzW2FjY291bnRJZGVudGlmaWVyXSkge1xuICAgICAgICAgICAgdGhpcy5leHRlcm5hbEFwaXNbYWNjb3VudElkZW50aWZpZXJdID0gYXBpU2VydmljZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKiBDbG9zZXMgdGhlIGN1cnJlbnRseSBvcGVuIGRpYWxvZy4gKi9cbiAgICBjbG9zZSgpIHtcbiAgICAgICAgdGhpcy5kaWFsb2cuY2xvc2VBbGwoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldExvZ2luVGl0bGVUcmFuc2xhdGlvbihlY21Ib3N0OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy50cmFuc2xhdGlvbi5pbnN0YW50KGBBVFRBQ0gtRklMRS5ESUFMT0cuTE9HSU5gLCB7IGVjbUhvc3QgfSk7XG4gICAgfVxufVxuIl19