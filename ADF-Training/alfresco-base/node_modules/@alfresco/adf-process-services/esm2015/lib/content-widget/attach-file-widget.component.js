/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Component, ViewEncapsulation } from '@angular/core';
import { ActivitiContentService, AppConfigService, AppConfigValues, ContentService, DownloadService, FormService, LogService, ProcessContentService, ThumbnailService, UploadWidgetComponent } from '@alfresco/adf-core';
import { ContentNodeDialogService } from '@alfresco/adf-content-services';
import { from, of, Subject, zip } from 'rxjs';
import { mergeMap, takeUntil } from 'rxjs/operators';
import { AttachFileWidgetDialogService } from './attach-file-widget-dialog.service';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
import * as ɵngcc2 from '@alfresco/adf-content-services';
import * as ɵngcc3 from './attach-file-widget-dialog.service';
import * as ɵngcc4 from '@angular/common';
import * as ɵngcc5 from '@angular/material/button';
import * as ɵngcc6 from '@angular/material/icon';
import * as ɵngcc7 from '@angular/material/menu';
import * as ɵngcc8 from '@angular/material/list';
import * as ɵngcc9 from '@angular/material/core';
import * as ɵngcc10 from '@ngx-translate/core';

function AttachFileWidgetComponent_span_4_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "span");
    ɵngcc0.ɵɵtext(1, "*");
    ɵngcc0.ɵɵelementEnd();
} }
function AttachFileWidgetComponent_div_6_Template(rf, ctx) { if (rf & 1) {
    const _r7 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "div", 8);
    ɵngcc0.ɵɵelementStart(1, "a", 9);
    ɵngcc0.ɵɵtext(2);
    ɵngcc0.ɵɵpipe(3, "translate");
    ɵngcc0.ɵɵelementStart(4, "mat-icon");
    ɵngcc0.ɵɵtext(5, "file_upload");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(6, "input", 10, 11);
    ɵngcc0.ɵɵlistener("change", function AttachFileWidgetComponent_div_6_Template_input_change_6_listener($event) { ɵngcc0.ɵɵrestoreView(_r7); const ctx_r6 = ɵngcc0.ɵɵnextContext(); return ctx_r6.onAttachFileChanged($event); });
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r1 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(3, 3, "FORM.FIELD.UPLOAD"), " ");
    ɵngcc0.ɵɵadvance(4);
    ɵngcc0.ɵɵproperty("multiple", ctx_r1.multipleOption)("id", ctx_r1.field.id);
} }
function AttachFileWidgetComponent_div_7_button_8_Template(rf, ctx) { if (rf & 1) {
    const _r14 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "button", 18);
    ɵngcc0.ɵɵlistener("click", function AttachFileWidgetComponent_div_7_button_8_Template_button_click_0_listener() { ɵngcc0.ɵɵrestoreView(_r14); const _r12 = ɵngcc0.ɵɵreference(6); return _r12.click(); });
    ɵngcc0.ɵɵtext(1);
    ɵngcc0.ɵɵpipe(2, "translate");
    ɵngcc0.ɵɵelementStart(3, "mat-icon");
    ɵngcc0.ɵɵtext(4, "file_upload");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(5, "input", 19, 20);
    ɵngcc0.ɵɵlistener("change", function AttachFileWidgetComponent_div_7_button_8_Template_input_change_5_listener($event) { ɵngcc0.ɵɵrestoreView(_r14); const ctx_r15 = ɵngcc0.ɵɵnextContext(2); return ctx_r15.onAttachFileChanged($event); });
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r9 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(2, 3, "FORM.FIELD.LOCALSTORAGE"), " ");
    ɵngcc0.ɵɵadvance(4);
    ɵngcc0.ɵɵproperty("multiple", ctx_r9.multipleOption)("id", ctx_r9.field.id);
} }
function AttachFileWidgetComponent_div_7_button_9_Template(rf, ctx) { if (rf & 1) {
    const _r17 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "button", 21);
    ɵngcc0.ɵɵlistener("click", function AttachFileWidgetComponent_div_7_button_9_Template_button_click_0_listener() { ɵngcc0.ɵɵrestoreView(_r17); const ctx_r16 = ɵngcc0.ɵɵnextContext(2); return ctx_r16.openSelectDialogFromFileSource(); });
    ɵngcc0.ɵɵtext(1);
    ɵngcc0.ɵɵelementStart(2, "mat-icon");
    ɵngcc0.ɵɵelement(3, "img", 22);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r10 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵpropertyInterpolate1("id", "attach-", ctx_r10.field.params == null ? null : ctx_r10.field.params.fileSource == null ? null : ctx_r10.field.params.fileSource.name, "");
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate1(" ", ctx_r10.field.params == null ? null : ctx_r10.field.params.fileSource == null ? null : ctx_r10.field.params.fileSource.name, " ");
} }
function AttachFileWidgetComponent_div_7_div_10_button_1_Template(rf, ctx) { if (rf & 1) {
    const _r21 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "button", 21);
    ɵngcc0.ɵɵlistener("click", function AttachFileWidgetComponent_div_7_div_10_button_1_Template_button_click_0_listener() { ɵngcc0.ɵɵrestoreView(_r21); const repo_r19 = ctx.$implicit; const ctx_r20 = ɵngcc0.ɵɵnextContext(3); return ctx_r20.openSelectDialog(repo_r19); });
    ɵngcc0.ɵɵtext(1);
    ɵngcc0.ɵɵelementStart(2, "mat-icon");
    ɵngcc0.ɵɵelement(3, "img", 22);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const repo_r19 = ctx.$implicit;
    ɵngcc0.ɵɵpropertyInterpolate1("id", "attach-", repo_r19 == null ? null : repo_r19.name, "");
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate1(" ", repo_r19.name, " ");
} }
function AttachFileWidgetComponent_div_7_div_10_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div");
    ɵngcc0.ɵɵtemplate(1, AttachFileWidgetComponent_div_7_div_10_button_1_Template, 4, 2, "button", 23);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r11 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngForOf", ctx_r11.repositoryList);
} }
function AttachFileWidgetComponent_div_7_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 12);
    ɵngcc0.ɵɵelementStart(1, "button", 13);
    ɵngcc0.ɵɵtext(2);
    ɵngcc0.ɵɵpipe(3, "translate");
    ɵngcc0.ɵɵelementStart(4, "mat-icon");
    ɵngcc0.ɵɵtext(5, "attach_file");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(6, "mat-menu", 14, 15);
    ɵngcc0.ɵɵtemplate(8, AttachFileWidgetComponent_div_7_button_8_Template, 7, 5, "button", 16);
    ɵngcc0.ɵɵtemplate(9, AttachFileWidgetComponent_div_7_button_9_Template, 4, 2, "button", 17);
    ɵngcc0.ɵɵtemplate(10, AttachFileWidgetComponent_div_7_div_10_Template, 2, 1, "div", 1);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const _r8 = ɵngcc0.ɵɵreference(7);
    const ctx_r2 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("matMenuTriggerFor", _r8)("id", ctx_r2.field.id);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(3, 6, "FORM.FIELD.UPLOAD"), " ");
    ɵngcc0.ɵɵadvance(6);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r2.isAllFileSourceSelected());
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r2.isDefinedSourceFolder());
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", !ctx_r2.isDefinedSourceFolder());
} }
function AttachFileWidgetComponent_mat_list_9_mat_list_item_1_button_21_Template(rf, ctx) { if (rf & 1) {
    const _r28 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "button", 33);
    ɵngcc0.ɵɵlistener("click", function AttachFileWidgetComponent_mat_list_9_mat_list_item_1_button_21_Template_button_click_0_listener() { ɵngcc0.ɵɵrestoreView(_r28); const file_r23 = ɵngcc0.ɵɵnextContext().$implicit; const ctx_r26 = ɵngcc0.ɵɵnextContext(2); return ctx_r26.onRemoveAttachFile(file_r23); })("keyup.enter", function AttachFileWidgetComponent_mat_list_9_mat_list_item_1_button_21_Template_button_keyup_enter_0_listener() { ɵngcc0.ɵɵrestoreView(_r28); const file_r23 = ɵngcc0.ɵɵnextContext().$implicit; const ctx_r29 = ɵngcc0.ɵɵnextContext(2); return ctx_r29.onRemoveAttachFile(file_r23); });
    ɵngcc0.ɵɵelementStart(1, "mat-icon", 34);
    ɵngcc0.ɵɵtext(2, "highlight_off");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(3, "span");
    ɵngcc0.ɵɵtext(4);
    ɵngcc0.ɵɵpipe(5, "translate");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const file_r23 = ɵngcc0.ɵɵnextContext().$implicit;
    ɵngcc0.ɵɵpropertyInterpolate("id", "file-" + file_r23.id + "-remove-file");
    ɵngcc0.ɵɵproperty("id", "file-" + file_r23.id + "-remove");
    ɵngcc0.ɵɵadvance(4);
    ɵngcc0.ɵɵtextInterpolate(ɵngcc0.ɵɵpipeBind1(5, 3, "FORM.FIELD.REMOVE_FILE"));
} }
function AttachFileWidgetComponent_mat_list_9_mat_list_item_1_Template(rf, ctx) { if (rf & 1) {
    const _r33 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "mat-list-item", 25);
    ɵngcc0.ɵɵelementStart(1, "img", 26);
    ɵngcc0.ɵɵlistener("click", function AttachFileWidgetComponent_mat_list_9_mat_list_item_1_Template_img_click_1_listener() { ɵngcc0.ɵɵrestoreView(_r33); const file_r23 = ctx.$implicit; const ctx_r32 = ɵngcc0.ɵɵnextContext(2); return ctx_r32.onAttachFileClicked(file_r23); })("keyup.enter", function AttachFileWidgetComponent_mat_list_9_mat_list_item_1_Template_img_keyup_enter_1_listener() { ɵngcc0.ɵɵrestoreView(_r33); const file_r23 = ctx.$implicit; const ctx_r34 = ɵngcc0.ɵɵnextContext(2); return ctx_r34.onAttachFileClicked(file_r23); });
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(2, "span", 27);
    ɵngcc0.ɵɵlistener("click", function AttachFileWidgetComponent_mat_list_9_mat_list_item_1_Template_span_click_2_listener() { ɵngcc0.ɵɵrestoreView(_r33); const file_r23 = ctx.$implicit; const ctx_r35 = ɵngcc0.ɵɵnextContext(2); return ctx_r35.onAttachFileClicked(file_r23); })("keyup.enter", function AttachFileWidgetComponent_mat_list_9_mat_list_item_1_Template_span_keyup_enter_2_listener() { ɵngcc0.ɵɵrestoreView(_r33); const file_r23 = ctx.$implicit; const ctx_r36 = ɵngcc0.ɵɵnextContext(2); return ctx_r36.onAttachFileClicked(file_r23); });
    ɵngcc0.ɵɵtext(3);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(4, "button", 28);
    ɵngcc0.ɵɵelementStart(5, "mat-icon");
    ɵngcc0.ɵɵtext(6, "more_vert");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(7, "mat-menu", 29, 30);
    ɵngcc0.ɵɵelementStart(9, "button", 31);
    ɵngcc0.ɵɵlistener("click", function AttachFileWidgetComponent_mat_list_9_mat_list_item_1_Template_button_click_9_listener() { ɵngcc0.ɵɵrestoreView(_r33); const file_r23 = ctx.$implicit; const ctx_r37 = ɵngcc0.ɵɵnextContext(2); return ctx_r37.onAttachFileClicked(file_r23); });
    ɵngcc0.ɵɵelementStart(10, "mat-icon");
    ɵngcc0.ɵɵtext(11, "visibility");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(12, "span");
    ɵngcc0.ɵɵtext(13);
    ɵngcc0.ɵɵpipe(14, "translate");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(15, "button", 31);
    ɵngcc0.ɵɵlistener("click", function AttachFileWidgetComponent_mat_list_9_mat_list_item_1_Template_button_click_15_listener() { ɵngcc0.ɵɵrestoreView(_r33); const file_r23 = ctx.$implicit; const ctx_r38 = ɵngcc0.ɵɵnextContext(2); return ctx_r38.downloadContent(file_r23); });
    ɵngcc0.ɵɵelementStart(16, "mat-icon");
    ɵngcc0.ɵɵtext(17, "file_download");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(18, "span");
    ɵngcc0.ɵɵtext(19);
    ɵngcc0.ɵɵpipe(20, "translate");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵtemplate(21, AttachFileWidgetComponent_mat_list_9_mat_list_item_1_button_21_Template, 6, 5, "button", 32);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const file_r23 = ctx.$implicit;
    const _r24 = ɵngcc0.ɵɵreference(8);
    const ctx_r22 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("id", "file-" + file_r23.id + "-icon")("src", file_r23.content ? ctx_r22.getIcon(file_r23.content.mimeType) : ctx_r22.getIcon(file_r23.mimeType), ɵngcc0.ɵɵsanitizeUrl)("alt", ctx_r22.mimeTypeIcon);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵpropertyInterpolate("id", "file-" + file_r23.id);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate(file_r23.name);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵpropertyInterpolate("id", "file-" + file_r23.id + "-option-menu");
    ɵngcc0.ɵɵproperty("matMenuTriggerFor", _r24);
    ɵngcc0.ɵɵadvance(5);
    ɵngcc0.ɵɵpropertyInterpolate("id", "file-" + file_r23.id + "-show-file");
    ɵngcc0.ɵɵproperty("disabled", file_r23.isExternal || !file_r23.contentAvailable || !file_r23.mimeType);
    ɵngcc0.ɵɵadvance(4);
    ɵngcc0.ɵɵtextInterpolate(ɵngcc0.ɵɵpipeBind1(14, 14, "FORM.FIELD.VIEW_FILE"));
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵpropertyInterpolate("id", "file-" + file_r23.id + "-download-file");
    ɵngcc0.ɵɵproperty("disabled", file_r23.isExternal || !file_r23.mimeType);
    ɵngcc0.ɵɵadvance(4);
    ɵngcc0.ɵɵtextInterpolate(ɵngcc0.ɵɵpipeBind1(20, 16, "FORM.FIELD.DOWNLOAD_FILE"));
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("ngIf", !ctx_r22.field.readOnly);
} }
function AttachFileWidgetComponent_mat_list_9_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "mat-list");
    ɵngcc0.ɵɵtemplate(1, AttachFileWidgetComponent_mat_list_9_mat_list_item_1_Template, 22, 18, "mat-list-item", 24);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r3 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngForOf", ctx_r3.field.value);
} }
function AttachFileWidgetComponent_error_widget_11_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "error-widget", 35);
    ɵngcc0.ɵɵpipe(1, "translate");
} if (rf & 2) {
    ɵngcc0.ɵɵpropertyInterpolate("required", ɵngcc0.ɵɵpipeBind1(1, 1, "FORM.FIELD.REQUIRED"));
} }
export class AttachFileWidgetComponent extends UploadWidgetComponent {
    constructor(formService, logger, thumbnails, processContentService, activitiContentService, contentService, contentDialog, appConfigService, downloadService, attachDialogService) {
        super(formService, logger, thumbnails, processContentService);
        this.formService = formService;
        this.logger = logger;
        this.thumbnails = thumbnails;
        this.processContentService = processContentService;
        this.activitiContentService = activitiContentService;
        this.contentService = contentService;
        this.contentDialog = contentDialog;
        this.appConfigService = appConfigService;
        this.downloadService = downloadService;
        this.attachDialogService = attachDialogService;
        this.typeId = 'AttachFileWidgetComponent';
        this.repositoryList = [];
        this.tempFilesList = [];
        this.onDestroy$ = new Subject();
    }
    ngOnInit() {
        super.ngOnInit();
        this.activitiContentService.getAlfrescoRepositories().subscribe((repoList) => {
            this.repositoryList = repoList;
        });
        this.formService.taskSaved
            .pipe(takeUntil(this.onDestroy$))
            .subscribe(formSaved => {
            if (formSaved.form.id === this.field.form.id) {
                this.tempFilesList = [];
            }
        });
    }
    ngOnDestroy() {
        this.onDestroy$.next(true);
        this.onDestroy$.complete();
    }
    isFileSourceConfigured() {
        return !!this.field.params && !!this.field.params.fileSource;
    }
    isMultipleSourceUpload() {
        return !this.field.readOnly && this.isFileSourceConfigured() && !this.isOnlyLocalSourceSelected();
    }
    isAllFileSourceSelected() {
        return this.field.params &&
            this.field.params.fileSource &&
            this.field.params.fileSource.serviceId === 'all-file-sources' &&
            !this.field.params.link;
    }
    isOnlyLocalSourceSelected() {
        return this.field.params &&
            this.field.params.fileSource &&
            this.field.params.fileSource.serviceId === 'local-file';
    }
    isSimpleUploadButton() {
        return this.isUploadButtonVisible() &&
            !this.isFileSourceConfigured() ||
            this.isOnlyLocalSourceSelected();
    }
    isUploadButtonVisible() {
        return (!this.hasFile || this.multipleOption) && !this.field.readOnly;
    }
    isDefinedSourceFolder() {
        var _a, _b;
        return !!((_b = (_a = this.field.params) === null || _a === void 0 ? void 0 : _a.fileSource) === null || _b === void 0 ? void 0 : _b.selectedFolder);
    }
    isTemporaryFile(file) {
        return this.tempFilesList.findIndex((elem) => elem.name === file.name) >= 0;
    }
    getNodeFromTempFile(file) {
        return this.tempFilesList.find((elem) => elem.name === file.name);
    }
    openSelectDialogFromFileSource() {
        var _a, _b;
        const params = this.field.params;
        const repository = this.repositoryList.find((repo) => { var _a; return repo.name === ((_a = params === null || params === void 0 ? void 0 : params.fileSource) === null || _a === void 0 ? void 0 : _a.name); });
        if (repository && this.isExternalHost(repository)) {
            this.uploadFileFromExternalCS(repository, (_b = (_a = params === null || params === void 0 ? void 0 : params.fileSource) === null || _a === void 0 ? void 0 : _a.selectedFolder) === null || _b === void 0 ? void 0 : _b.pathId);
        }
        else {
            this.contentDialog.openFileBrowseDialogByFolderId(params.fileSource.selectedFolder.pathId).subscribe((selections) => {
                this.tempFilesList.push(...selections);
                this.uploadFileFromCS(selections, this.field.params.fileSource.selectedFolder.accountId, this.field.params.fileSource.selectedFolder.siteId);
            });
        }
    }
    onAttachFileChanged(event) {
        this.tempFilesList.push(...Array.from(event.target.files));
        this.onFileChanged(event);
    }
    onRemoveAttachFile(file) {
        if (this.isTemporaryFile(file)) {
            this.tempFilesList.splice(this.tempFilesList.indexOf(file.contentBlob), 1);
        }
        this.removeFile(file);
    }
    onAttachFileClicked(file) {
        if (file.isExternal || !file.contentAvailable) {
            this.logger.info(`The file ${file.name} comes from an external source and cannot be showed at this moment`);
            return;
        }
        if (this.isTemporaryFile(file)) {
            this.formService.formContentClicked.next(file);
        }
        else {
            this.fileClicked(file);
        }
    }
    downloadContent(file) {
        if (this.isTemporaryFile(file)) {
            const fileBlob = file.contentBlob;
            if (fileBlob) {
                this.downloadService.downloadBlob(fileBlob, file.name);
            }
            else {
                const nodeUploaded = this.getNodeFromTempFile(file);
                const nodeUrl = this.contentService.getContentUrl(nodeUploaded.id);
                this.downloadService.downloadUrl(nodeUrl, file.name);
            }
        }
        if (file.sourceId) {
            const sourceHost = this.findSource(file.source);
            if (sourceHost && this.isExternalHost(sourceHost)) {
                this.attachDialogService.downloadURL(sourceHost, file.sourceId).subscribe((nodeUrl) => {
                    this.downloadService.downloadUrl(nodeUrl, file.name);
                });
            }
            else {
                const nodeUrl = this.contentService.getContentUrl(file.sourceId);
                this.downloadService.downloadUrl(nodeUrl, file.name);
            }
        }
        else {
            this.processContentService.getFileRawContent(file.id).subscribe((blob) => {
                this.downloadService.downloadBlob(blob, file.name);
            }, () => {
                this.logger.error('Impossible retrieve content for download');
            });
        }
    }
    openSelectDialog(repository) {
        if (this.isExternalHost(repository)) {
            this.uploadFileFromExternalCS(repository);
        }
        else {
            this.contentDialog.openFileBrowseDialogByDefaultLocation().subscribe((selections) => {
                this.tempFilesList.push(...selections);
                this.uploadFileFromCS(selections, `alfresco-${repository.id}-${repository.name}`);
            });
        }
    }
    isExternalHost(repository) {
        const currentECMHost = this.getDomainHost(this.appConfigService.get(AppConfigValues.ECMHOST));
        const chosenRepositoryHost = this.getDomainHost(repository.repositoryUrl);
        return chosenRepositoryHost !== currentECMHost;
    }
    findSource(sourceIdentifier) {
        return this.repositoryList.find(repository => sourceIdentifier === `alfresco-${repository.id}-${repository.name}`);
    }
    uploadFileFromExternalCS(repository, currentFolderId) {
        const accountIdentifier = `alfresco-${repository.id}-${repository.name}`;
        this.attachDialogService.openLogin(repository, currentFolderId, accountIdentifier).subscribe((selections) => {
            selections.forEach((node) => node.isExternal = true);
            this.tempFilesList.push(...selections);
            this.uploadFileFromCS(selections, accountIdentifier);
        });
    }
    uploadFileFromCS(fileNodeList, accountId, siteId) {
        const filesSaved = [];
        fileNodeList.forEach(node => {
            node.isLink = this.field.params.link;
        });
        from(fileNodeList).pipe(mergeMap((node) => {
            var _a;
            return zip(of((_a = node === null || node === void 0 ? void 0 : node.content) === null || _a === void 0 ? void 0 : _a.mimeType), this.activitiContentService.applyAlfrescoNode(node, siteId, accountId), of(node.isExternal));
        }))
            .subscribe(([mimeType, res, isExternal]) => {
            res.mimeType = mimeType;
            res.isExternal = isExternal;
            filesSaved.push(res);
        }, (error) => {
            this.logger.error(error);
        }, () => {
            const previousFiles = this.field.value ? this.field.value : [];
            this.field.value = [...previousFiles, ...filesSaved];
            this.field.json.value = [...previousFiles, ...filesSaved];
            this.hasFile = true;
        });
    }
    getDomainHost(urlToCheck) {
        const result = urlToCheck.match('^(?:https?:\/\/)?(?:[^@\/\n]+@)?(?:www\.)?([^:\/?\n]+)');
        return result[1];
    }
}
AttachFileWidgetComponent.ɵfac = function AttachFileWidgetComponent_Factory(t) { return new (t || AttachFileWidgetComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.FormService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.LogService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ThumbnailService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ProcessContentService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ActivitiContentService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ContentService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.ContentNodeDialogService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.AppConfigService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.DownloadService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.AttachFileWidgetDialogService)); };
AttachFileWidgetComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: AttachFileWidgetComponent, selectors: [["attach-widget"]], hostBindings: function AttachFileWidgetComponent_HostBindings(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵlistener("click", function AttachFileWidgetComponent_click_HostBindingHandler($event) { return ctx.event($event); })("blur", function AttachFileWidgetComponent_blur_HostBindingHandler($event) { return ctx.event($event); })("change", function AttachFileWidgetComponent_change_HostBindingHandler($event) { return ctx.event($event); })("focus", function AttachFileWidgetComponent_focus_HostBindingHandler($event) { return ctx.event($event); })("focusin", function AttachFileWidgetComponent_focusin_HostBindingHandler($event) { return ctx.event($event); })("focusout", function AttachFileWidgetComponent_focusout_HostBindingHandler($event) { return ctx.event($event); })("input", function AttachFileWidgetComponent_input_HostBindingHandler($event) { return ctx.event($event); })("invalid", function AttachFileWidgetComponent_invalid_HostBindingHandler($event) { return ctx.event($event); })("select", function AttachFileWidgetComponent_select_HostBindingHandler($event) { return ctx.event($event); });
    } }, features: [ɵngcc0.ɵɵInheritDefinitionFeature], decls: 12, vars: 17, consts: [[1, "adf-label"], [4, "ngIf"], [1, "adf-attach-widget-container"], ["id", "adf-attach-widget-simple-upload", 4, "ngIf"], ["class", "adf-attach-widget__menu-upload", 4, "ngIf"], ["id", "adf-attach-widget-readonly-list"], [3, "error"], [3, "required", 4, "ngIf"], ["id", "adf-attach-widget-simple-upload"], ["mat-raised-button", "", "color", "primary"], ["type", "file", 3, "multiple", "id", "change"], ["uploadFiles", ""], [1, "adf-attach-widget__menu-upload"], ["mat-raised-button", "", "color", "primary", 3, "matMenuTriggerFor", "id"], [1, "adf-attach-widget__menu-content"], ["menu", "matMenu"], ["mat-menu-item", "", "id", "attach-local-file", 3, "click", 4, "ngIf"], ["mat-menu-item", "", 3, "id", "click", 4, "ngIf"], ["mat-menu-item", "", "id", "attach-local-file", 3, "click"], ["type", "file", 1, "adf-attach-widget__input-type", 3, "multiple", "id", "change"], ["uploadFile", ""], ["mat-menu-item", "", 3, "id", "click"], ["alt", "alfresco", "src", "../assets/images/alfresco-flower.svg", 1, "adf-attach-widget__image-logo"], ["mat-menu-item", "", 3, "id", "click", 4, "ngFor", "ngForOf"], ["class", "adf-attach-files-row", 4, "ngFor", "ngForOf"], [1, "adf-attach-files-row"], ["mat-list-icon", "", "role", "button", "tabindex", "0", 1, "adf-attach-widget__icon", 3, "id", "src", "alt", "click", "keyup.enter"], ["matLine", "", "role", "button", "tabindex", "0", 1, "adf-file", 3, "id", "click", "keyup.enter"], ["mat-icon-button", "", 3, "id", "matMenuTriggerFor"], ["xPosition", "before"], ["fileActionMenu", "matMenu"], ["mat-menu-item", "", 3, "id", "disabled", "click"], ["mat-menu-item", "", 3, "id", "click", "keyup.enter", 4, "ngIf"], ["mat-menu-item", "", 3, "id", "click", "keyup.enter"], [1, "mat-24"], [3, "required"]], template: function AttachFileWidgetComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "div");
        ɵngcc0.ɵɵelementStart(1, "label", 0);
        ɵngcc0.ɵɵtext(2);
        ɵngcc0.ɵɵpipe(3, "translate");
        ɵngcc0.ɵɵtemplate(4, AttachFileWidgetComponent_span_4_Template, 2, 0, "span", 1);
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(5, "div", 2);
        ɵngcc0.ɵɵtemplate(6, AttachFileWidgetComponent_div_6_Template, 8, 5, "div", 3);
        ɵngcc0.ɵɵtemplate(7, AttachFileWidgetComponent_div_7_Template, 11, 8, "div", 4);
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(8, "div", 5);
        ɵngcc0.ɵɵtemplate(9, AttachFileWidgetComponent_mat_list_9_Template, 2, 1, "mat-list", 1);
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelement(10, "error-widget", 6);
        ɵngcc0.ɵɵtemplate(11, AttachFileWidgetComponent_error_widget_11_Template, 2, 3, "error-widget", 7);
    } if (rf & 2) {
        ɵngcc0.ɵɵclassMapInterpolate1("adf-attach-widget ", ctx.field.className, "");
        ɵngcc0.ɵɵclassProp("adf-invalid", !ctx.field.isValid)("adf-readonly", ctx.field.readOnly);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵattribute("for", ctx.field.id);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵtextInterpolate1("", ɵngcc0.ɵɵpipeBind1(3, 15, ctx.field.name), " ");
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("ngIf", ctx.isRequired());
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("ngIf", ctx.isSimpleUploadButton() && ctx.isUploadButtonVisible());
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.isUploadButtonVisible() && ctx.isMultipleSourceUpload());
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("ngIf", ctx.hasFile);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("error", ctx.field.validationSummary);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.isInvalidFieldRequired());
    } }, directives: [ɵngcc4.NgIf, ɵngcc1.ErrorWidgetComponent, ɵngcc5.MatAnchor, ɵngcc6.MatIcon, ɵngcc5.MatButton, ɵngcc7.MatMenuTrigger, ɵngcc7._MatMenu, ɵngcc7.MatMenuItem, ɵngcc4.NgForOf, ɵngcc8.MatList, ɵngcc8.MatListItem, ɵngcc8.MatListIconCssMatStyler, ɵngcc9.MatLine], pipes: [ɵngcc10.TranslatePipe], styles: [".adf-attach-widget-container{align-items:center;display:flex;margin-bottom:15px}.adf-attach-widget-container input{cursor:pointer;height:100%;opacity:0;position:absolute;right:0;top:0;width:300px;z-index:4}.adf-attach-widget__menu-upload{align-items:center;display:flex}.adf-attach-widget__input-type{height:.1px;opacity:0;overflow:hidden;position:absolute;width:.1px;z-index:-1}.adf-attach-widget__image-logo{padding-left:5px}.adf-attach-widget-repo-button{padding-left:10px}.adf-attach-widget-repo-button .mat-button-wrapper{display:inline}.adf-attach-widget-repo-button .mat-mini-fab.mat-accent{background-color:inherit}.adf-attach-widget{border-top:.84375em solid transparent;padding:.4375em 0;width:100%;word-break:break-all}.adf-attach-widget__icon{cursor:pointer;float:left;padding:6px}.adf-attach-widget__reset{margin-top:-2px}.adf-attach-files-row .mat-line{margin-bottom:0}"], encapsulation: 2 });
AttachFileWidgetComponent.ctorParameters = () => [
    { type: FormService },
    { type: LogService },
    { type: ThumbnailService },
    { type: ProcessContentService },
    { type: ActivitiContentService },
    { type: ContentService },
    { type: ContentNodeDialogService },
    { type: AppConfigService },
    { type: DownloadService },
    { type: AttachFileWidgetDialogService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AttachFileWidgetComponent, [{
        type: Component,
        args: [{
                selector: 'attach-widget',
                template: "<div class=\"adf-attach-widget {{field.className}}\"\n    [class.adf-invalid]=\"!field.isValid\"\n    [class.adf-readonly]=\"field.readOnly\">\n    <label class=\"adf-label\" [attr.for]=\"field.id\">{{field.name | translate}}\n        <span *ngIf=\"isRequired()\">*</span>\n    </label>\n    <div class=\"adf-attach-widget-container\">\n        <div id=\"adf-attach-widget-simple-upload\" *ngIf=\"isSimpleUploadButton() && isUploadButtonVisible()\">\n            <a mat-raised-button color=\"primary\">\n                {{ 'FORM.FIELD.UPLOAD' | translate }}\n                <mat-icon>file_upload</mat-icon>\n                <input #uploadFiles\n                        [multiple]=\"multipleOption\"\n                        type=\"file\"\n                        [id]=\"field.id\"\n                        (change)=\"onAttachFileChanged($event)\" />\n            </a>\n        </div>\n        <div class=\"adf-attach-widget__menu-upload\" *ngIf=\"isUploadButtonVisible() && isMultipleSourceUpload()\">\n            <button mat-raised-button color=\"primary\" [matMenuTriggerFor]=\"menu\" [id]=\"field.id\">\n                    {{ 'FORM.FIELD.UPLOAD' | translate }}\n                    <mat-icon>attach_file</mat-icon>\n            </button>\n            <mat-menu #menu=\"matMenu\" class=\"adf-attach-widget__menu-content\">\n                <button mat-menu-item (click)=\"uploadFile.click()\"\n                        id=\"attach-local-file\"\n                        *ngIf=\"isAllFileSourceSelected()\">\n                    {{ 'FORM.FIELD.LOCALSTORAGE' | translate }}\n                    <mat-icon>file_upload</mat-icon>\n                    <input #uploadFile\n                            class=\"adf-attach-widget__input-type\"\n                            [multiple]=\"multipleOption\"\n                            type=\"file\"\n                            [id]=\"field.id\"\n                            (change)=\"onAttachFileChanged($event)\" />\n                </button>\n                <button mat-menu-item\n                        *ngIf=\"isDefinedSourceFolder()\"\n                        id=\"attach-{{field.params?.fileSource?.name}}\"\n                        (click)=\"openSelectDialogFromFileSource()\">\n                        {{field.params?.fileSource?.name}}\n                        <mat-icon>\n                            <img alt=\"alfresco\" class=\"adf-attach-widget__image-logo\" src=\"../assets/images/alfresco-flower.svg\">\n                        </mat-icon>\n                </button>\n                <div *ngIf=\"!isDefinedSourceFolder()\">\n                    <button mat-menu-item *ngFor=\"let repo of repositoryList\"\n                            id=\"attach-{{repo?.name}}\"\n                           (click)=\"openSelectDialog(repo)\">\n                            {{repo.name}}\n                            <mat-icon>\n                                <img alt=\"alfresco\" class=\"adf-attach-widget__image-logo\" src=\"../assets/images/alfresco-flower.svg\">\n                            </mat-icon>\n                    </button>\n                </div>\n            </mat-menu>\n        </div>\n    </div>\n</div>\n\n<div id=\"adf-attach-widget-readonly-list\">\n    <mat-list *ngIf=\"hasFile\">\n        <mat-list-item class=\"adf-attach-files-row\" *ngFor=\"let file of field.value\">\n            <img mat-list-icon class=\"adf-attach-widget__icon\"\n                 [id]=\"'file-'+file.id+'-icon'\"\n                 [src]=\"file.content ? getIcon(file.content.mimeType) : getIcon(file.mimeType)\"\n                 [alt]=\"mimeTypeIcon\"\n                 (click)=\"onAttachFileClicked(file)\"\n                 (keyup.enter)=\"onAttachFileClicked(file)\"\n                 role=\"button\"\n                 tabindex=\"0\"/>\n            <span matLine id=\"{{'file-'+file.id}}\" (click)=\"onAttachFileClicked(file)\" (keyup.enter)=\"onAttachFileClicked(file)\"\n                  role=\"button\" tabindex=\"0\" class=\"adf-file\">{{file.name}}</span>\n            <button id=\"{{'file-'+file.id+'-option-menu'}}\" mat-icon-button [matMenuTriggerFor]=\"fileActionMenu\">\n                <mat-icon>more_vert</mat-icon>\n            </button>\n            <mat-menu #fileActionMenu=\"matMenu\" xPosition=\"before\">\n                <button id=\"{{'file-'+file.id+'-show-file'}}\"\n                    [disabled]=\"file.isExternal || !file.contentAvailable || !file.mimeType\"\n                    mat-menu-item (click)=\"onAttachFileClicked(file)\">\n                    <mat-icon>visibility</mat-icon>\n                    <span>{{ 'FORM.FIELD.VIEW_FILE' | translate }}</span>\n                </button>\n                <button id=\"{{'file-'+file.id+'-download-file'}}\"\n                    [disabled]=\"file.isExternal || !file.mimeType\"\n                    mat-menu-item (click)=\"downloadContent(file)\">\n                    <mat-icon>file_download</mat-icon>\n                    <span>{{ 'FORM.FIELD.DOWNLOAD_FILE' | translate }}</span>\n                </button>\n                <button *ngIf=\"!field.readOnly\" id=\"{{'file-'+file.id+'-remove-file'}}\"\n                        mat-menu-item [id]=\"'file-'+file.id+'-remove'\"\n                        (click)=\"onRemoveAttachFile(file);\" (keyup.enter)=\"onRemoveAttachFile(file);\">\n                    <mat-icon class=\"mat-24\">highlight_off</mat-icon>\n                    <span>{{ 'FORM.FIELD.REMOVE_FILE' | translate }}</span>\n                </button>\n            </mat-menu>\n        </mat-list-item>\n    </mat-list>\n</div>\n\n<error-widget [error]=\"field.validationSummary\"></error-widget>\n<error-widget *ngIf=\"isInvalidFieldRequired()\" required=\"{{ 'FORM.FIELD.REQUIRED' | translate }}\"></error-widget>\n",
                host: {
                    '(click)': 'event($event)',
                    '(blur)': 'event($event)',
                    '(change)': 'event($event)',
                    '(focus)': 'event($event)',
                    '(focusin)': 'event($event)',
                    '(focusout)': 'event($event)',
                    '(input)': 'event($event)',
                    '(invalid)': 'event($event)',
                    '(select)': 'event($event)'
                },
                encapsulation: ViewEncapsulation.None,
                styles: [".adf-attach-widget-container{align-items:center;display:flex;margin-bottom:15px}.adf-attach-widget-container input{cursor:pointer;height:100%;opacity:0;position:absolute;right:0;top:0;width:300px;z-index:4}.adf-attach-widget__menu-upload{align-items:center;display:flex}.adf-attach-widget__input-type{height:.1px;opacity:0;overflow:hidden;position:absolute;width:.1px;z-index:-1}.adf-attach-widget__image-logo{padding-left:5px}.adf-attach-widget-repo-button{padding-left:10px}.adf-attach-widget-repo-button .mat-button-wrapper{display:inline}.adf-attach-widget-repo-button .mat-mini-fab.mat-accent{background-color:inherit}.adf-attach-widget{border-top:.84375em solid transparent;padding:.4375em 0;width:100%;word-break:break-all}.adf-attach-widget__icon{cursor:pointer;float:left;padding:6px}.adf-attach-widget__reset{margin-top:-2px}.adf-attach-files-row .mat-line{margin-bottom:0}"]
            }]
    }], function () { return [{ type: ɵngcc1.FormService }, { type: ɵngcc1.LogService }, { type: ɵngcc1.ThumbnailService }, { type: ɵngcc1.ProcessContentService }, { type: ɵngcc1.ActivitiContentService }, { type: ɵngcc1.ContentService }, { type: ɵngcc2.ContentNodeDialogService }, { type: ɵngcc1.AppConfigService }, { type: ɵngcc1.DownloadService }, { type: ɵngcc3.AttachFileWidgetDialogService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNoLWZpbGUtd2lkZ2V0LmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL3Byb2Nlc3Mtc2VydmljZXMvc3JjL2xpYi9jb250ZW50LXdpZGdldC9hdHRhY2gtZmlsZS13aWRnZXQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFJSCxPQUFPLEVBQUUsU0FBUyxFQUFxQixpQkFBaUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNoRixPQUFPLEVBQ0gsc0JBQXNCLEVBQ3RCLGdCQUFnQixFQUNoQixlQUFlLEVBQ2YsY0FBYyxFQUNkLGVBQWUsRUFDZixXQUFXLEVBQ1gsVUFBVSxFQUNWLHFCQUFxQixFQUNyQixnQkFBZ0IsRUFDaEIscUJBQXFCLEVBQ3hCLE1BQU0sb0JBQW9CLENBQUM7QUFDNUIsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFPMUUsT0FBTyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5QyxPQUFPLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JELE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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MUIsV0FBVyxFQUFFLGVBQWUsc0JBQzVCLFlBQVksRUFBRSxlQUFlLHNCQUM3QixTQUFTLEVBQUUsZUFBZSxzQkFDMUIsV0FBVyxFQUFFLGVBQWUsc0JBQzVCLFVBQVUsRUFBRSxlQUFlLGtCQUM5QixrQkFDRCxhQUFhLEVBQUUsaUJBQWlCLENBQUMsSUFBSSwrY0FFcEM7QUFBQztBQUFtRCxZQWxDckQsV0FBVztBQUNiLFlBQUUsVUFBVTtBQUNaLFlBQ0UsZ0JBQWdCO0FBQ2xCLFlBRkUscUJBQXFCO0FBQ3ZCLFlBUkUsc0JBQXNCO0FBQ3hCLFlBRUUsY0FBYztBQUNoQixZQU9PLHdCQUF3QjtBQUFJLFlBVmpDLGdCQUFnQjtBQUNsQixZQUVFLGVBQWU7QUFDakIsWUFlTyw2QkFBNkI7QUFBRzt3RUFrQnhDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OzhaQWxCMEM7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8qIHRzbGludDpkaXNhYmxlOmNvbXBvbmVudC1zZWxlY3RvciAqL1xuXG5pbXBvcnQgeyBDb21wb25lbnQsIE9uRGVzdHJveSwgT25Jbml0LCBWaWV3RW5jYXBzdWxhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgICBBY3Rpdml0aUNvbnRlbnRTZXJ2aWNlLFxuICAgIEFwcENvbmZpZ1NlcnZpY2UsXG4gICAgQXBwQ29uZmlnVmFsdWVzLFxuICAgIENvbnRlbnRTZXJ2aWNlLFxuICAgIERvd25sb2FkU2VydmljZSxcbiAgICBGb3JtU2VydmljZSxcbiAgICBMb2dTZXJ2aWNlLFxuICAgIFByb2Nlc3NDb250ZW50U2VydmljZSxcbiAgICBUaHVtYm5haWxTZXJ2aWNlLFxuICAgIFVwbG9hZFdpZGdldENvbXBvbmVudFxufSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgQ29udGVudE5vZGVEaWFsb2dTZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb250ZW50LXNlcnZpY2VzJztcbmltcG9ydCB7XG4gICAgQWxmcmVzY29FbmRwb2ludFJlcHJlc2VudGF0aW9uLFxuICAgIE5vZGUsXG4gICAgTm9kZUNoaWxkQXNzb2NpYXRpb24sXG4gICAgUmVsYXRlZENvbnRlbnRSZXByZXNlbnRhdGlvblxufSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IGZyb20sIG9mLCBTdWJqZWN0LCB6aXAgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1lcmdlTWFwLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBBdHRhY2hGaWxlV2lkZ2V0RGlhbG9nU2VydmljZSB9IGZyb20gJy4vYXR0YWNoLWZpbGUtd2lkZ2V0LWRpYWxvZy5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdhdHRhY2gtd2lkZ2V0JyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vYXR0YWNoLWZpbGUtd2lkZ2V0LmNvbXBvbmVudC5odG1sJyxcbiAgICBzdHlsZVVybHM6IFsnLi9hdHRhY2gtZmlsZS13aWRnZXQuY29tcG9uZW50LnNjc3MnXSxcbiAgICBob3N0OiB7XG4gICAgICAgICcoY2xpY2spJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKGJsdXIpJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKGNoYW5nZSknOiAnZXZlbnQoJGV2ZW50KScsXG4gICAgICAgICcoZm9jdXMpJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKGZvY3VzaW4pJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKGZvY3Vzb3V0KSc6ICdldmVudCgkZXZlbnQpJyxcbiAgICAgICAgJyhpbnB1dCknOiAnZXZlbnQoJGV2ZW50KScsXG4gICAgICAgICcoaW52YWxpZCknOiAnZXZlbnQoJGV2ZW50KScsXG4gICAgICAgICcoc2VsZWN0KSc6ICdldmVudCgkZXZlbnQpJ1xuICAgIH0sXG4gICAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZVxufSlcbmV4cG9ydCBjbGFzcyBBdHRhY2hGaWxlV2lkZ2V0Q29tcG9uZW50IGV4dGVuZHMgVXBsb2FkV2lkZ2V0Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuXG4gICAgdHlwZUlkID0gJ0F0dGFjaEZpbGVXaWRnZXRDb21wb25lbnQnO1xuICAgIHJlcG9zaXRvcnlMaXN0OiBBbGZyZXNjb0VuZHBvaW50UmVwcmVzZW50YXRpb25bXSA9IFtdO1xuICAgIHByaXZhdGUgdGVtcEZpbGVzTGlzdCA9IFtdO1xuICAgIHByaXZhdGUgb25EZXN0cm95JCA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgZm9ybVNlcnZpY2U6IEZvcm1TZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgbG9nZ2VyOiBMb2dTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHB1YmxpYyB0aHVtYm5haWxzOiBUaHVtYm5haWxTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHB1YmxpYyBwcm9jZXNzQ29udGVudFNlcnZpY2U6IFByb2Nlc3NDb250ZW50U2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGFjdGl2aXRpQ29udGVudFNlcnZpY2U6IEFjdGl2aXRpQ29udGVudFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBjb250ZW50U2VydmljZTogQ29udGVudFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBjb250ZW50RGlhbG9nOiBDb250ZW50Tm9kZURpYWxvZ1NlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBhcHBDb25maWdTZXJ2aWNlOiBBcHBDb25maWdTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgZG93bmxvYWRTZXJ2aWNlOiBEb3dubG9hZFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBhdHRhY2hEaWFsb2dTZXJ2aWNlOiBBdHRhY2hGaWxlV2lkZ2V0RGlhbG9nU2VydmljZSkge1xuICAgICAgICBzdXBlcihmb3JtU2VydmljZSwgbG9nZ2VyLCB0aHVtYm5haWxzLCBwcm9jZXNzQ29udGVudFNlcnZpY2UpO1xuICAgIH1cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICBzdXBlci5uZ09uSW5pdCgpO1xuXG4gICAgICAgIHRoaXMuYWN0aXZpdGlDb250ZW50U2VydmljZS5nZXRBbGZyZXNjb1JlcG9zaXRvcmllcygpLnN1YnNjcmliZSgocmVwb0xpc3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVwb3NpdG9yeUxpc3QgPSByZXBvTGlzdDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5mb3JtU2VydmljZS50YXNrU2F2ZWRcbiAgICAgICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLm9uRGVzdHJveSQpKVxuICAgICAgICAgICAgLnN1YnNjcmliZShmb3JtU2F2ZWQgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChmb3JtU2F2ZWQuZm9ybS5pZCA9PT0gdGhpcy5maWVsZC5mb3JtLmlkKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGVtcEZpbGVzTGlzdCA9IFtdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCkge1xuICAgICAgICB0aGlzLm9uRGVzdHJveSQubmV4dCh0cnVlKTtcbiAgICAgICAgdGhpcy5vbkRlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gICAgfVxuXG4gICAgaXNGaWxlU291cmNlQ29uZmlndXJlZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICEhdGhpcy5maWVsZC5wYXJhbXMgJiYgISF0aGlzLmZpZWxkLnBhcmFtcy5maWxlU291cmNlO1xuICAgIH1cblxuICAgIGlzTXVsdGlwbGVTb3VyY2VVcGxvYWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAhdGhpcy5maWVsZC5yZWFkT25seSAmJiB0aGlzLmlzRmlsZVNvdXJjZUNvbmZpZ3VyZWQoKSAmJiAhdGhpcy5pc09ubHlMb2NhbFNvdXJjZVNlbGVjdGVkKCk7XG4gICAgfVxuXG4gICAgaXNBbGxGaWxlU291cmNlU2VsZWN0ZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmZpZWxkLnBhcmFtcyAmJlxuICAgICAgICAgICAgdGhpcy5maWVsZC5wYXJhbXMuZmlsZVNvdXJjZSAmJlxuICAgICAgICAgICAgdGhpcy5maWVsZC5wYXJhbXMuZmlsZVNvdXJjZS5zZXJ2aWNlSWQgPT09ICdhbGwtZmlsZS1zb3VyY2VzJyAmJlxuICAgICAgICAgICAgIXRoaXMuZmllbGQucGFyYW1zLmxpbms7XG4gICAgfVxuXG4gICAgaXNPbmx5TG9jYWxTb3VyY2VTZWxlY3RlZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmllbGQucGFyYW1zICYmXG4gICAgICAgICAgICB0aGlzLmZpZWxkLnBhcmFtcy5maWxlU291cmNlICYmXG4gICAgICAgICAgICB0aGlzLmZpZWxkLnBhcmFtcy5maWxlU291cmNlLnNlcnZpY2VJZCA9PT0gJ2xvY2FsLWZpbGUnO1xuICAgIH1cblxuICAgIGlzU2ltcGxlVXBsb2FkQnV0dG9uKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5pc1VwbG9hZEJ1dHRvblZpc2libGUoKSAmJlxuICAgICAgICAgICAgIXRoaXMuaXNGaWxlU291cmNlQ29uZmlndXJlZCgpIHx8XG4gICAgICAgICAgICB0aGlzLmlzT25seUxvY2FsU291cmNlU2VsZWN0ZWQoKTtcbiAgICB9XG5cbiAgICBpc1VwbG9hZEJ1dHRvblZpc2libGUoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAoIXRoaXMuaGFzRmlsZSB8fCB0aGlzLm11bHRpcGxlT3B0aW9uKSAmJiAhdGhpcy5maWVsZC5yZWFkT25seTtcbiAgICB9XG5cbiAgICBpc0RlZmluZWRTb3VyY2VGb2xkZXIoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAhIXRoaXMuZmllbGQucGFyYW1zPy5maWxlU291cmNlPy5zZWxlY3RlZEZvbGRlcjtcbiAgICB9XG5cbiAgICBpc1RlbXBvcmFyeUZpbGUoZmlsZSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy50ZW1wRmlsZXNMaXN0LmZpbmRJbmRleCgoZWxlbSkgPT4gZWxlbS5uYW1lID09PSBmaWxlLm5hbWUpID49IDA7XG4gICAgfVxuXG4gICAgZ2V0Tm9kZUZyb21UZW1wRmlsZShmaWxlKTogTm9kZUNoaWxkQXNzb2NpYXRpb24ge1xuICAgICAgICByZXR1cm4gdGhpcy50ZW1wRmlsZXNMaXN0LmZpbmQoKGVsZW0pID0+IGVsZW0ubmFtZSA9PT0gZmlsZS5uYW1lKTtcbiAgICB9XG5cbiAgICBvcGVuU2VsZWN0RGlhbG9nRnJvbUZpbGVTb3VyY2UoKSB7XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuZmllbGQucGFyYW1zO1xuICAgICAgICBjb25zdCByZXBvc2l0b3J5ID0gdGhpcy5yZXBvc2l0b3J5TGlzdC5maW5kKChyZXBvKSA9PiByZXBvLm5hbWUgPT09IHBhcmFtcz8uZmlsZVNvdXJjZT8ubmFtZSk7XG4gICAgICAgIGlmIChyZXBvc2l0b3J5ICYmIHRoaXMuaXNFeHRlcm5hbEhvc3QocmVwb3NpdG9yeSkpIHtcbiAgICAgICAgICAgIHRoaXMudXBsb2FkRmlsZUZyb21FeHRlcm5hbENTKHJlcG9zaXRvcnksIHBhcmFtcz8uZmlsZVNvdXJjZT8uc2VsZWN0ZWRGb2xkZXI/LnBhdGhJZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnREaWFsb2cub3BlbkZpbGVCcm93c2VEaWFsb2dCeUZvbGRlcklkKHBhcmFtcy5maWxlU291cmNlLnNlbGVjdGVkRm9sZGVyLnBhdGhJZCkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIChzZWxlY3Rpb25zOiBOb2RlW10pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZW1wRmlsZXNMaXN0LnB1c2goLi4uc2VsZWN0aW9ucyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkRmlsZUZyb21DUyhzZWxlY3Rpb25zLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5maWVsZC5wYXJhbXMuZmlsZVNvdXJjZS5zZWxlY3RlZEZvbGRlci5hY2NvdW50SWQsXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLnBhcmFtcy5maWxlU291cmNlLnNlbGVjdGVkRm9sZGVyLnNpdGVJZCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvbkF0dGFjaEZpbGVDaGFuZ2VkKGV2ZW50OiBhbnkpIHtcbiAgICAgICAgdGhpcy50ZW1wRmlsZXNMaXN0LnB1c2goLi4uQXJyYXkuZnJvbShldmVudC50YXJnZXQuZmlsZXMpKTtcbiAgICAgICAgdGhpcy5vbkZpbGVDaGFuZ2VkKGV2ZW50KTtcbiAgICB9XG5cbiAgICBvblJlbW92ZUF0dGFjaEZpbGUoZmlsZTogRmlsZSB8IFJlbGF0ZWRDb250ZW50UmVwcmVzZW50YXRpb24pIHtcbiAgICAgICAgaWYgKHRoaXMuaXNUZW1wb3JhcnlGaWxlKGZpbGUpKSB7XG4gICAgICAgICAgICB0aGlzLnRlbXBGaWxlc0xpc3Quc3BsaWNlKHRoaXMudGVtcEZpbGVzTGlzdC5pbmRleE9mKCg8UmVsYXRlZENvbnRlbnRSZXByZXNlbnRhdGlvbj4gZmlsZSkuY29udGVudEJsb2IpLCAxKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJlbW92ZUZpbGUoZmlsZSk7XG4gICAgfVxuXG4gICAgb25BdHRhY2hGaWxlQ2xpY2tlZChmaWxlOiBhbnkpIHtcbiAgICAgICAgaWYgKGZpbGUuaXNFeHRlcm5hbCB8fCAhZmlsZS5jb250ZW50QXZhaWxhYmxlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5pbmZvKGBUaGUgZmlsZSAke2ZpbGUubmFtZX0gY29tZXMgZnJvbSBhbiBleHRlcm5hbCBzb3VyY2UgYW5kIGNhbm5vdCBiZSBzaG93ZWQgYXQgdGhpcyBtb21lbnRgKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5pc1RlbXBvcmFyeUZpbGUoZmlsZSkpIHtcbiAgICAgICAgICAgIHRoaXMuZm9ybVNlcnZpY2UuZm9ybUNvbnRlbnRDbGlja2VkLm5leHQoZmlsZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmZpbGVDbGlja2VkKGZpbGUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZG93bmxvYWRDb250ZW50KGZpbGU6IGFueSB8IFJlbGF0ZWRDb250ZW50UmVwcmVzZW50YXRpb24pOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuaXNUZW1wb3JhcnlGaWxlKGZpbGUpKSB7XG4gICAgICAgICAgICBjb25zdCBmaWxlQmxvYiA9ICg8UmVsYXRlZENvbnRlbnRSZXByZXNlbnRhdGlvbj4gZmlsZSkuY29udGVudEJsb2I7XG4gICAgICAgICAgICBpZiAoZmlsZUJsb2IpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRvd25sb2FkU2VydmljZS5kb3dubG9hZEJsb2IoZmlsZUJsb2IsIGZpbGUubmFtZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5vZGVVcGxvYWRlZDogTm9kZUNoaWxkQXNzb2NpYXRpb24gPSB0aGlzLmdldE5vZGVGcm9tVGVtcEZpbGUoZmlsZSk7XG4gICAgICAgICAgICAgICAgY29uc3Qgbm9kZVVybCA9IHRoaXMuY29udGVudFNlcnZpY2UuZ2V0Q29udGVudFVybChub2RlVXBsb2FkZWQuaWQpO1xuICAgICAgICAgICAgICAgIHRoaXMuZG93bmxvYWRTZXJ2aWNlLmRvd25sb2FkVXJsKG5vZGVVcmwsIGZpbGUubmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZpbGUuc291cmNlSWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZUhvc3QgPSB0aGlzLmZpbmRTb3VyY2UoZmlsZS5zb3VyY2UpO1xuICAgICAgICAgICAgaWYgKHNvdXJjZUhvc3QgJiYgdGhpcy5pc0V4dGVybmFsSG9zdChzb3VyY2VIb3N0KSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYXR0YWNoRGlhbG9nU2VydmljZS5kb3dubG9hZFVSTChzb3VyY2VIb3N0LCBmaWxlLnNvdXJjZUlkKS5zdWJzY3JpYmUoKG5vZGVVcmwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kb3dubG9hZFNlcnZpY2UuZG93bmxvYWRVcmwobm9kZVVybCwgZmlsZS5uYW1lKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgbm9kZVVybCA9IHRoaXMuY29udGVudFNlcnZpY2UuZ2V0Q29udGVudFVybChmaWxlLnNvdXJjZUlkKTtcbiAgICAgICAgICAgICAgICB0aGlzLmRvd25sb2FkU2VydmljZS5kb3dubG9hZFVybChub2RlVXJsLCBmaWxlLm5hbWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wcm9jZXNzQ29udGVudFNlcnZpY2UuZ2V0RmlsZVJhd0NvbnRlbnQoKDxhbnk+IGZpbGUpLmlkKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKGJsb2I6IEJsb2IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kb3dubG9hZFNlcnZpY2UuZG93bmxvYWRCbG9iKGJsb2IsICg8YW55PiBmaWxlKS5uYW1lKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ltcG9zc2libGUgcmV0cmlldmUgY29udGVudCBmb3IgZG93bmxvYWQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb3BlblNlbGVjdERpYWxvZyhyZXBvc2l0b3J5OiBBbGZyZXNjb0VuZHBvaW50UmVwcmVzZW50YXRpb24pIHtcbiAgICAgICAgaWYgKHRoaXMuaXNFeHRlcm5hbEhvc3QocmVwb3NpdG9yeSkpIHtcbiAgICAgICAgICAgIHRoaXMudXBsb2FkRmlsZUZyb21FeHRlcm5hbENTKHJlcG9zaXRvcnkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jb250ZW50RGlhbG9nLm9wZW5GaWxlQnJvd3NlRGlhbG9nQnlEZWZhdWx0TG9jYXRpb24oKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKHNlbGVjdGlvbnM6IE5vZGVbXSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRlbXBGaWxlc0xpc3QucHVzaCguLi5zZWxlY3Rpb25zKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGxvYWRGaWxlRnJvbUNTKHNlbGVjdGlvbnMsIGBhbGZyZXNjby0ke3JlcG9zaXRvcnkuaWR9LSR7cmVwb3NpdG9yeS5uYW1lfWApO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc0V4dGVybmFsSG9zdChyZXBvc2l0b3J5OiBBbGZyZXNjb0VuZHBvaW50UmVwcmVzZW50YXRpb24pOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgY3VycmVudEVDTUhvc3QgPSB0aGlzLmdldERvbWFpbkhvc3QodGhpcy5hcHBDb25maWdTZXJ2aWNlLmdldChBcHBDb25maWdWYWx1ZXMuRUNNSE9TVCkpO1xuICAgICAgICBjb25zdCBjaG9zZW5SZXBvc2l0b3J5SG9zdCA9IHRoaXMuZ2V0RG9tYWluSG9zdChyZXBvc2l0b3J5LnJlcG9zaXRvcnlVcmwpO1xuICAgICAgICByZXR1cm4gY2hvc2VuUmVwb3NpdG9yeUhvc3QgIT09IGN1cnJlbnRFQ01Ib3N0O1xuICAgIH1cblxuICAgIHByaXZhdGUgZmluZFNvdXJjZShzb3VyY2VJZGVudGlmaWVyOiBzdHJpbmcpOiBBbGZyZXNjb0VuZHBvaW50UmVwcmVzZW50YXRpb24ge1xuICAgICAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5TGlzdC5maW5kKHJlcG9zaXRvcnkgPT4gc291cmNlSWRlbnRpZmllciA9PT0gYGFsZnJlc2NvLSR7cmVwb3NpdG9yeS5pZH0tJHtyZXBvc2l0b3J5Lm5hbWV9YCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGxvYWRGaWxlRnJvbUV4dGVybmFsQ1MocmVwb3NpdG9yeTogQWxmcmVzY29FbmRwb2ludFJlcHJlc2VudGF0aW9uLCBjdXJyZW50Rm9sZGVySWQ/OiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgYWNjb3VudElkZW50aWZpZXIgPSBgYWxmcmVzY28tJHtyZXBvc2l0b3J5LmlkfS0ke3JlcG9zaXRvcnkubmFtZX1gO1xuICAgICAgICB0aGlzLmF0dGFjaERpYWxvZ1NlcnZpY2Uub3BlbkxvZ2luKHJlcG9zaXRvcnksIGN1cnJlbnRGb2xkZXJJZCwgYWNjb3VudElkZW50aWZpZXIpLnN1YnNjcmliZShcbiAgICAgICAgICAgIChzZWxlY3Rpb25zOiBhbnlbXSkgPT4ge1xuICAgICAgICAgICAgICAgIHNlbGVjdGlvbnMuZm9yRWFjaCgobm9kZSkgPT4gbm9kZS5pc0V4dGVybmFsID0gdHJ1ZSk7XG4gICAgICAgICAgICAgICAgdGhpcy50ZW1wRmlsZXNMaXN0LnB1c2goLi4uc2VsZWN0aW9ucyk7XG4gICAgICAgICAgICAgICAgdGhpcy51cGxvYWRGaWxlRnJvbUNTKHNlbGVjdGlvbnMsIGFjY291bnRJZGVudGlmaWVyKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgdXBsb2FkRmlsZUZyb21DUyhmaWxlTm9kZUxpc3Q6IGFueVtdLCBhY2NvdW50SWQ6IHN0cmluZywgc2l0ZUlkPzogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGZpbGVzU2F2ZWQgPSBbXTtcblxuICAgICAgICBmaWxlTm9kZUxpc3QuZm9yRWFjaChub2RlID0+IHtcbiAgICAgICAgICAgIG5vZGUuaXNMaW5rID0gdGhpcy5maWVsZC5wYXJhbXMubGluaztcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZnJvbShmaWxlTm9kZUxpc3QpLnBpcGUoXG4gICAgICAgICAgICBtZXJnZU1hcCgobm9kZSkgPT5cbiAgICAgICAgICAgICAgICB6aXAoXG4gICAgICAgICAgICAgICAgICAgIG9mKG5vZGU/LmNvbnRlbnQ/Lm1pbWVUeXBlKSxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpdml0aUNvbnRlbnRTZXJ2aWNlLmFwcGx5QWxmcmVzY29Ob2RlKG5vZGUsIHNpdGVJZCwgYWNjb3VudElkKSxcbiAgICAgICAgICAgICAgICAgICAgb2Yobm9kZS5pc0V4dGVybmFsKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgoW21pbWVUeXBlLCByZXMsIGlzRXh0ZXJuYWxdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlcy5taW1lVHlwZSA9IG1pbWVUeXBlO1xuICAgICAgICAgICAgICAgICAgICByZXMuaXNFeHRlcm5hbCA9IGlzRXh0ZXJuYWw7XG4gICAgICAgICAgICAgICAgICAgIGZpbGVzU2F2ZWQucHVzaChyZXMpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJldmlvdXNGaWxlcyA9IHRoaXMuZmllbGQudmFsdWUgPyB0aGlzLmZpZWxkLnZhbHVlIDogW107XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGQudmFsdWUgPSBbLi4ucHJldmlvdXNGaWxlcywgLi4uZmlsZXNTYXZlZF07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGQuanNvbi52YWx1ZSA9IFsuLi5wcmV2aW91c0ZpbGVzLCAuLi5maWxlc1NhdmVkXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYXNGaWxlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldERvbWFpbkhvc3QodXJsVG9DaGVjazogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdXJsVG9DaGVjay5tYXRjaCgnXig/Omh0dHBzPzpcXC9cXC8pPyg/OlteQFxcL1xcbl0rQCk/KD86d3d3XFwuKT8oW146XFwvP1xcbl0rKScpO1xuICAgICAgICByZXR1cm4gcmVzdWx0WzFdO1xuICAgIH1cblxufVxuIl19