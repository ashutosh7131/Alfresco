import { AlfrescoApiService, LogService } from '@alfresco/adf-core';
import { Injectable } from '@angular/core';
import { from, forkJoin, throwError, of } from 'rxjs';
import { map, catchError, switchMap, flatMap, filter } from 'rxjs/operators';
import { TaskQueryRequestRepresentationModel } from '../models/filter.model';
import { Form } from '../models/form.model';
import { TaskDetailsModel } from '../models/task-details.model';
import { TaskListModel } from '../models/task-list.model';
import { ModelsApi, TaskActionsApi, TasksApi, ChecklistsApi } from '@alfresco/js-api';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
export class TaskListService {
    constructor(apiService, logService) {
        this.apiService = apiService;
        this.logService = logService;
    }
    get modelsApi() {
        var _a;
        this._modelsApi = (_a = this._modelsApi) !== null && _a !== void 0 ? _a : new ModelsApi(this.apiService.getInstance());
        return this._modelsApi;
    }
    get tasksApi() {
        var _a;
        this._tasksApi = (_a = this._tasksApi) !== null && _a !== void 0 ? _a : new TasksApi(this.apiService.getInstance());
        return this._tasksApi;
    }
    get taskActionsApi() {
        var _a;
        this._taskActionsApi = (_a = this._taskActionsApi) !== null && _a !== void 0 ? _a : new TaskActionsApi(this.apiService.getInstance());
        return this._taskActionsApi;
    }
    get checklistsApi() {
        var _a;
        this._checklistsApi = (_a = this._checklistsApi) !== null && _a !== void 0 ? _a : new ChecklistsApi(this.apiService.getInstance());
        return this._checklistsApi;
    }
    getFilterForTaskById(taskId, filterList) {
        return from(filterList)
            .pipe(flatMap((data) => this.isTaskRelatedToFilter(taskId, data)), filter((data) => data != null));
    }
    generateTaskRequestNodeFromFilter(filterModel) {
        const requestNode = {
            appDefinitionId: filterModel.appId,
            assignment: filterModel.filter.assignment,
            state: filterModel.filter.state,
            sort: filterModel.filter.sort
        };
        return new TaskQueryRequestRepresentationModel(requestNode);
    }
    isTaskRelatedToFilter(taskId, filterModel) {
        const requestNodeForFilter = this.generateTaskRequestNodeFromFilter(filterModel);
        return from(this.callApiTasksFiltered(requestNodeForFilter))
            .pipe(map(res => {
            return res.data.find((element) => element.id === taskId) ? filterModel : null;
        }), catchError((err) => this.handleError(err)));
    }
    getTasks(requestNode) {
        return from(this.callApiTasksFiltered(requestNode))
            .pipe(catchError((err) => this.handleError(err)));
    }
    findTasksByState(requestNode, state) {
        if (state) {
            requestNode.state = state;
        }
        return this.getTasks(requestNode)
            .pipe(catchError(() => of(new TaskListModel())));
    }
    findAllTaskByState(requestNode, state) {
        if (state) {
            requestNode.state = state;
        }
        return this.getTotalTasks(requestNode)
            .pipe(switchMap((res) => {
            requestNode.size = res.total;
            return this.getTasks(requestNode);
        }));
    }
    findAllTasksWithoutState(requestNode) {
        return forkJoin(this.findTasksByState(requestNode, 'open'), this.findAllTaskByState(requestNode, 'completed'), (activeTasks, completedTasks) => {
            const tasks = Object.assign({}, activeTasks);
            tasks.total += completedTasks.total;
            tasks.data = tasks.data.concat(completedTasks.data);
            return tasks;
        });
    }
    getTaskDetails(taskId) {
        return from(this.callApiTaskDetails(taskId))
            .pipe(map(details => {
            return new TaskDetailsModel(details);
        }), catchError((err) => this.handleError(err)));
    }
    getTaskChecklist(id) {
        return from(this.callApiTaskChecklist(id))
            .pipe(map(response => {
            const checklists = [];
            response.data.forEach((checklist) => {
                checklists.push(new TaskDetailsModel(checklist));
            });
            return checklists;
        }), catchError((err) => this.handleError(err)));
    }
    getFormList() {
        const opts = {
            'filter': 'myReusableForms',
            'sort': 'modifiedDesc',
            'modelType': 2
        };
        return from(this.modelsApi.getModels(opts))
            .pipe(map(response => {
            const forms = [];
            response.data.forEach((form) => {
                forms.push(new Form(form.id, form.name));
            });
            return forms;
        }), catchError((err) => this.handleError(err)));
    }
    attachFormToATask(taskId, formId) {
        return from(this.taskActionsApi.attachForm(taskId, { 'formId': formId }))
            .pipe(catchError((err) => this.handleError(err)));
    }
    addTask(task) {
        return from(this.callApiAddTask(task))
            .pipe(map((response) => {
            return new TaskDetailsModel(response);
        }), catchError((err) => this.handleError(err)));
    }
    deleteTask(taskId) {
        return from(this.callApiDeleteTask(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    deleteForm(taskId) {
        return from(this.callApiDeleteForm(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    completeTask(taskId) {
        return from(this.taskActionsApi.completeTask(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getTotalTasks(requestNode) {
        requestNode.size = 0;
        return from(this.callApiTasksFiltered(requestNode))
            .pipe(catchError((err) => this.handleError(err)));
    }
    createNewTask(task) {
        return from(this.callApiCreateTask(task))
            .pipe(map((response) => {
            return new TaskDetailsModel(response);
        }), catchError((err) => this.handleError(err)));
    }
    assignTask(taskId, requestNode) {
        const assignee = { assignee: requestNode.id };
        return from(this.callApiAssignTask(taskId, assignee))
            .pipe(map((response) => {
            return new TaskDetailsModel(response);
        }), catchError((err) => this.handleError(err)));
    }
    assignTaskByUserId(taskId, userId) {
        const assignee = { assignee: userId };
        return from(this.callApiAssignTask(taskId, assignee))
            .pipe(map((response) => {
            return new TaskDetailsModel(response);
        }), catchError((err) => this.handleError(err)));
    }
    claimTask(taskId) {
        return from(this.taskActionsApi.claimTask(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    unclaimTask(taskId) {
        return from(this.taskActionsApi.unclaimTask(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    updateTask(taskId, updated) {
        return from(this.tasksApi.updateTask(taskId, updated))
            .pipe(map((result) => result), catchError((err) => this.handleError(err)));
    }
    fetchTaskAuditPdfById(taskId) {
        return from(this.tasksApi.getTaskAuditPdf(taskId))
            .pipe(map((data) => data), catchError((err) => this.handleError(err)));
    }
    fetchTaskAuditJsonById(taskId) {
        return from(this.tasksApi.getTaskAuditLog(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    callApiTasksFiltered(requestNode) {
        return this.tasksApi.listTasks(requestNode);
    }
    callApiTaskDetails(taskId) {
        return this.tasksApi.getTask(taskId);
    }
    callApiAddTask(task) {
        return this.checklistsApi.addSubtask(task.parentTaskId, task);
    }
    callApiDeleteTask(taskId) {
        return this.tasksApi.deleteTask(taskId);
    }
    callApiDeleteForm(taskId) {
        return this.taskActionsApi.removeForm(taskId);
    }
    callApiTaskChecklist(taskId) {
        return this.checklistsApi.getChecklist(taskId);
    }
    callApiCreateTask(task) {
        return this.tasksApi.createNewTask(task);
    }
    callApiAssignTask(taskId, requestNode) {
        return this.taskActionsApi.assignTask(taskId, requestNode);
    }
    handleError(error) {
        this.logService.error(error);
        return throwError(error || 'Server error');
    }
}
TaskListService.ɵprov = i0.ɵɵdefineInjectable({ factory: function TaskListService_Factory() { return new TaskListService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i1.LogService)); }, token: TaskListService, providedIn: "root" });
TaskListService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
TaskListService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: LogService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFza2xpc3Quc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL3Byb2Nlc3Mtc2VydmljZXMvc3JjLyIsInNvdXJjZXMiOlsibGliL3Rhc2stbGlzdC9zZXJ2aWNlcy90YXNrbGlzdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsSUFBSSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2xFLE9BQU8sRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0UsT0FBTyxFQUE2QixtQ0FBbUMsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3hHLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUM1QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDMUQsT0FBTyxFQUV1QixTQUFTLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFDN0QsYUFBYSxFQUNoQixNQUFNLGtCQUFrQixDQUFDOzs7QUFLMUIsTUFBTSxPQUFPLGVBQWU7SUEwQnhCLFlBQW9CLFVBQThCLEVBQzlCLFVBQXNCO1FBRHRCLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBQzlCLGVBQVUsR0FBVixVQUFVLENBQVk7SUFDMUMsQ0FBQztJQXpCRCxJQUFJLFNBQVM7O1FBQ1QsSUFBSSxDQUFDLFVBQVUsU0FBRyxJQUFJLENBQUMsVUFBVSxtQ0FBSSxJ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S0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdCLE9BQU8sVUFBVSxDQUFDLEtBQUssSUFBSSxjQUFjLENBQUMsQ0FBQztJQUMvQyxDQUFDOzs7O1lBeGFKLFVBQVUsU0FBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQjs7O1lBaEJRLGtCQUFrQjtZQUFFLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UsIExvZ1NlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbSwgZm9ya0pvaW4sIHRocm93RXJyb3IsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIGNhdGNoRXJyb3IsIHN3aXRjaE1hcCwgZmxhdE1hcCwgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbCwgVGFza1F1ZXJ5UmVxdWVzdFJlcHJlc2VudGF0aW9uTW9kZWwgfSBmcm9tICcuLi9tb2RlbHMvZmlsdGVyLm1vZGVsJztcbmltcG9ydCB7IEZvcm0gfSBmcm9tICcuLi9tb2RlbHMvZm9ybS5tb2RlbCc7XG5pbXBvcnQgeyBUYXNrRGV0YWlsc01vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL3Rhc2stZGV0YWlscy5tb2RlbCc7XG5pbXBvcnQgeyBUYXNrTGlzdE1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL3Rhc2stbGlzdC5tb2RlbCc7XG5pbXBvcnQge1xuICAgIFRhc2tRdWVyeVJlcHJlc2VudGF0aW9uLCBBc3NpZ25lZUlkZW50aWZpZXJSZXByZXNlbnRhdGlvbixcbiAgICBUYXNrVXBkYXRlUmVwcmVzZW50YXRpb24sIE1vZGVsc0FwaSwgVGFza0FjdGlvbnNBcGksIFRhc2tzQXBpLFxuICAgIENoZWNrbGlzdHNBcGlcbn0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgVGFza0xpc3RTZXJ2aWNlIHtcblxuICAgIHByaXZhdGUgX21vZGVsc0FwaTtcbiAgICBnZXQgbW9kZWxzQXBpKCk6IE1vZGVsc0FwaSB7XG4gICAgICAgIHRoaXMuX21vZGVsc0FwaSA9IHRoaXMuX21vZGVsc0FwaSA/PyBuZXcgTW9kZWxzQXBpKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX21vZGVsc0FwaTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF90YXNrc0FwaTtcbiAgICBnZXQgdGFza3NBcGkoKTogVGFza3NBcGkge1xuICAgICAgICB0aGlzLl90YXNrc0FwaSA9IHRoaXMuX3Rhc2tzQXBpID8/IG5ldyBUYXNrc0FwaSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXNrc0FwaTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF90YXNrQWN0aW9uc0FwaTtcbiAgICBnZXQgdGFza0FjdGlvbnNBcGkoKTogVGFza0FjdGlvbnNBcGkge1xuICAgICAgICB0aGlzLl90YXNrQWN0aW9uc0FwaSA9IHRoaXMuX3Rhc2tBY3Rpb25zQXBpID8/IG5ldyBUYXNrQWN0aW9uc0FwaSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXNrQWN0aW9uc0FwaTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9jaGVja2xpc3RzQXBpO1xuICAgIGdldCBjaGVja2xpc3RzQXBpKCk6IENoZWNrbGlzdHNBcGkge1xuICAgICAgICB0aGlzLl9jaGVja2xpc3RzQXBpID0gdGhpcy5fY2hlY2tsaXN0c0FwaSA/PyBuZXcgQ2hlY2tsaXN0c0FwaSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl9jaGVja2xpc3RzQXBpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgbG9nU2VydmljZTogTG9nU2VydmljZSkge1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYWxsIHRoZSBmaWx0ZXJzIGluIHRoZSBsaXN0IHRoYXQgYmVsb25nIHRvIGEgdGFzay5cbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXJnZXQgdGFza1xuICAgICAqIEBwYXJhbSBmaWx0ZXJMaXN0IExpc3Qgb2YgZmlsdGVycyB0byBzZWFyY2ggdGhyb3VnaFxuICAgICAqIEByZXR1cm5zIEZpbHRlcnMgYmVsb25naW5nIHRvIHRoZSB0YXNrXG4gICAgICovXG4gICAgZ2V0RmlsdGVyRm9yVGFza0J5SWQodGFza0lkOiBzdHJpbmcsIGZpbHRlckxpc3Q6IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWxbXSk6IE9ic2VydmFibGU8RmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbD4ge1xuICAgICAgICByZXR1cm4gZnJvbShmaWx0ZXJMaXN0KVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgZmxhdE1hcCgoZGF0YTogRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbCkgPT4gdGhpcy5pc1Rhc2tSZWxhdGVkVG9GaWx0ZXIodGFza0lkLCBkYXRhKSksXG4gICAgICAgICAgICAgICAgZmlsdGVyKChkYXRhOiBGaWx0ZXJSZXByZXNlbnRhdGlvbk1vZGVsKSA9PiBkYXRhICE9IG51bGwpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHNlYXJjaCBxdWVyeSBmb3IgYSB0YXNrIGJhc2VkIG9uIHRoZSBzdXBwbGllZCBmaWx0ZXIuXG4gICAgICogQHBhcmFtIGZpbHRlciBUaGUgZmlsdGVyIHRvIHVzZVxuICAgICAqIEByZXR1cm5zIFRoZSBzZWFyY2ggcXVlcnlcbiAgICAgKi9cbiAgICBwcml2YXRlIGdlbmVyYXRlVGFza1JlcXVlc3ROb2RlRnJvbUZpbHRlcihmaWx0ZXJNb2RlbDogRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbCk6IFRhc2tRdWVyeVJlcXVlc3RSZXByZXNlbnRhdGlvbk1vZGVsIHtcbiAgICAgICAgY29uc3QgcmVxdWVzdE5vZGUgPSB7XG4gICAgICAgICAgICBhcHBEZWZpbml0aW9uSWQ6IGZpbHRlck1vZGVsLmFwcElkLFxuICAgICAgICAgICAgYXNzaWdubWVudDogZmlsdGVyTW9kZWwuZmlsdGVyLmFzc2lnbm1lbnQsXG4gICAgICAgICAgICBzdGF0ZTogZmlsdGVyTW9kZWwuZmlsdGVyLnN0YXRlLFxuICAgICAgICAgICAgc29ydDogZmlsdGVyTW9kZWwuZmlsdGVyLnNvcnRcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIG5ldyBUYXNrUXVlcnlSZXF1ZXN0UmVwcmVzZW50YXRpb25Nb2RlbChyZXF1ZXN0Tm9kZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIGEgdGFza0lkIGlzIGZpbHRlcmVkIHdpdGggdGhlIGdpdmVuIGZpbHRlci5cbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXJnZXQgdGFza1xuICAgICAqIEBwYXJhbSBmaWx0ZXJNb2RlbCBUaGUgZmlsdGVyIHlvdSB3YW50IHRvIGNoZWNrXG4gICAgICogQHJldHVybnMgVGhlIGZpbHRlciBpZiBpdCBpcyByZWxhdGVkIG9yIG51bGwgb3RoZXJ3aXNlXG4gICAgICovXG4gICAgaXNUYXNrUmVsYXRlZFRvRmlsdGVyKHRhc2tJZDogc3RyaW5nLCBmaWx0ZXJNb2RlbDogRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbCk6IE9ic2VydmFibGU8RmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbD4ge1xuICAgICAgICBjb25zdCByZXF1ZXN0Tm9kZUZvckZpbHRlciA9IHRoaXMuZ2VuZXJhdGVUYXNrUmVxdWVzdE5vZGVGcm9tRmlsdGVyKGZpbHRlck1vZGVsKTtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5jYWxsQXBpVGFza3NGaWx0ZXJlZChyZXF1ZXN0Tm9kZUZvckZpbHRlcikpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAocmVzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5kYXRhLmZpbmQoKGVsZW1lbnQpID0+IGVsZW1lbnQuaWQgPT09IHRhc2tJZCkgPyBmaWx0ZXJNb2RlbCA6IG51bGw7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYWxsIHRoZSB0YXNrcyBtYXRjaGluZyB0aGUgc3VwcGxpZWQgcXVlcnkuXG4gICAgICogQHBhcmFtIHJlcXVlc3ROb2RlIFF1ZXJ5IHRvIHNlYXJjaCBmb3IgdGFza3NcbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIHRhc2tzXG4gICAgICovXG4gICAgZ2V0VGFza3MocmVxdWVzdE5vZGU6IFRhc2tRdWVyeVJlcXVlc3RSZXByZXNlbnRhdGlvbk1vZGVsKTogT2JzZXJ2YWJsZTxUYXNrTGlzdE1vZGVsPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaVRhc2tzRmlsdGVyZWQocmVxdWVzdE5vZGUpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGFza3MgbWF0Y2hpbmcgYSBxdWVyeSBhbmQgc3RhdGUgdmFsdWUuXG4gICAgICogQHBhcmFtIHJlcXVlc3ROb2RlIFF1ZXJ5IHRvIHNlYXJjaCBmb3IgdGFza3NcbiAgICAgKiBAcGFyYW0gc3RhdGUgVGFzayBzdGF0ZS4gQ2FuIGJlIFwib3BlblwiIG9yIFwiY29tcGxldGVkXCIuXG4gICAgICogQHJldHVybnMgTGlzdCBvZiB0YXNrc1xuICAgICAqL1xuICAgIGZpbmRUYXNrc0J5U3RhdGUocmVxdWVzdE5vZGU6IFRhc2tRdWVyeVJlcXVlc3RSZXByZXNlbnRhdGlvbk1vZGVsLCBzdGF0ZT86IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0xpc3RNb2RlbD4ge1xuICAgICAgICBpZiAoc3RhdGUpIHtcbiAgICAgICAgICAgIHJlcXVlc3ROb2RlLnN0YXRlID0gc3RhdGU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VGFza3MocmVxdWVzdE5vZGUpXG4gICAgICAgICAgICAucGlwZShjYXRjaEVycm9yKCgpID0+IG9mKG5ldyBUYXNrTGlzdE1vZGVsKCkpKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgdGFza3MgbWF0Y2hpbmcgYSBxdWVyeSBhbmQgc3RhdGUgdmFsdWUuXG4gICAgICogQHBhcmFtIHJlcXVlc3ROb2RlIFF1ZXJ5IHRvIHNlYXJjaCBmb3IgdGFza3MuXG4gICAgICogQHBhcmFtIHN0YXRlIFRhc2sgc3RhdGUuIENhbiBiZSBcIm9wZW5cIiBvciBcImNvbXBsZXRlZFwiLlxuICAgICAqIEByZXR1cm5zIExpc3Qgb2YgdGFza3NcbiAgICAgKi9cbiAgICBmaW5kQWxsVGFza0J5U3RhdGUocmVxdWVzdE5vZGU6IFRhc2tRdWVyeVJlcXVlc3RSZXByZXNlbnRhdGlvbk1vZGVsLCBzdGF0ZT86IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0xpc3RNb2RlbD4ge1xuICAgICAgICBpZiAoc3RhdGUpIHtcbiAgICAgICAgICAgIHJlcXVlc3ROb2RlLnN0YXRlID0gc3RhdGU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VG90YWxUYXNrcyhyZXF1ZXN0Tm9kZSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdE5vZGUuc2l6ZSA9IHJlcy50b3RhbDtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VGFza3MocmVxdWVzdE5vZGUpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYWxsIHRhc2tzIG1hdGNoaW5nIHRoZSBzdXBwbGllZCBxdWVyeSBidXQgaWdub3JpbmcgdGhlIHRhc2sgc3RhdGUuXG4gICAgICogQHBhcmFtIHJlcXVlc3ROb2RlIFF1ZXJ5IHRvIHNlYXJjaCBmb3IgdGFza3NcbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIHRhc2tzXG4gICAgICovXG4gICAgZmluZEFsbFRhc2tzV2l0aG91dFN0YXRlKHJlcXVlc3ROb2RlOiBUYXNrUXVlcnlSZXF1ZXN0UmVwcmVzZW50YXRpb25Nb2RlbCk6IE9ic2VydmFibGU8VGFza0xpc3RNb2RlbD4ge1xuICAgICAgICByZXR1cm4gZm9ya0pvaW4oXG4gICAgICAgICAgICB0aGlzLmZpbmRUYXNrc0J5U3RhdGUocmVxdWVzdE5vZGUsICdvcGVuJyksXG4gICAgICAgICAgICB0aGlzLmZpbmRBbGxUYXNrQnlTdGF0ZShyZXF1ZXN0Tm9kZSwgJ2NvbXBsZXRlZCcpLFxuICAgICAgICAgICAgKGFjdGl2ZVRhc2tzOiBUYXNrTGlzdE1vZGVsLCBjb21wbGV0ZWRUYXNrczogVGFza0xpc3RNb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRhc2tzID0gT2JqZWN0LmFzc2lnbih7fSwgYWN0aXZlVGFza3MpO1xuICAgICAgICAgICAgICAgIHRhc2tzLnRvdGFsICs9IGNvbXBsZXRlZFRhc2tzLnRvdGFsO1xuICAgICAgICAgICAgICAgIHRhc2tzLmRhdGEgPSB0YXNrcy5kYXRhLmNvbmNhdChjb21wbGV0ZWRUYXNrcy5kYXRhKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGFza3M7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBkZXRhaWxzIGZvciBhIHRhc2suXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFyZ2V0IHRhc2suXG4gICAgICogQHJldHVybnMgVGFzayBkZXRhaWxzXG4gICAgICovXG4gICAgZ2V0VGFza0RldGFpbHModGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzTW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5jYWxsQXBpVGFza0RldGFpbHModGFza0lkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcChkZXRhaWxzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBUYXNrRGV0YWlsc01vZGVsKGRldGFpbHMpO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBjaGVja2xpc3QgZm9yIGEgdGFzay5cbiAgICAgKiBAcGFyYW0gaWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgY2hlY2tsaXN0IHRhc2sgZGV0YWlsc1xuICAgICAqL1xuICAgIGdldFRhc2tDaGVja2xpc3QoaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbFtdPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaVRhc2tDaGVja2xpc3QoaWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hlY2tsaXN0czogVGFza0RldGFpbHNNb2RlbFtdID0gW107XG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZm9yRWFjaCgoY2hlY2tsaXN0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaGVja2xpc3RzLnB1c2gobmV3IFRhc2tEZXRhaWxzTW9kZWwoY2hlY2tsaXN0KSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hlY2tsaXN0cztcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgYXZhaWxhYmxlIHJldXNhYmxlIGZvcm1zLlxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIGZvcm0gZGV0YWlsc1xuICAgICAqL1xuICAgIGdldEZvcm1MaXN0KCk6IE9ic2VydmFibGU8Rm9ybVtdPiB7XG4gICAgICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICAgICAgICAnZmlsdGVyJzogJ215UmV1c2FibGVGb3JtcycsIC8vIFN0cmluZyB8IGZpbHRlclxuICAgICAgICAgICAgJ3NvcnQnOiAnbW9kaWZpZWREZXNjJywgLy8gU3RyaW5nIHwgc29ydFxuICAgICAgICAgICAgJ21vZGVsVHlwZSc6IDIgLy8gSW50ZWdlciB8IG1vZGVsVHlwZVxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMubW9kZWxzQXBpLmdldE1vZGVscyhvcHRzKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcChyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcm1zOiBGb3JtW10gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5mb3JFYWNoKChmb3JtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3Jtcy5wdXNoKG5ldyBGb3JtKGZvcm0uaWQsIGZvcm0ubmFtZSkpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvcm1zO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBdHRhY2hlcyBhIGZvcm0gdG8gYSB0YXNrLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHBhcmFtIGZvcm1JZCBJRCBvZiB0aGUgZm9ybSB0byBhZGRcbiAgICAgKiBAcmV0dXJucyBOdWxsIHJlc3BvbnNlIG5vdGlmeWluZyB3aGVuIHRoZSBvcGVyYXRpb24gaXMgY29tcGxldGVcbiAgICAgKi9cbiAgICBhdHRhY2hGb3JtVG9BVGFzayh0YXNrSWQ6IHN0cmluZywgZm9ybUlkOiBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnRhc2tBY3Rpb25zQXBpLmF0dGFjaEZvcm0odGFza0lkLCB7ICdmb3JtSWQnOiBmb3JtSWQgfSkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhIHN1YnRhc2sgKGllLCBhIGNoZWNrbGlzdCB0YXNrKSB0byBhIHBhcmVudCB0YXNrLlxuICAgICAqIEBwYXJhbSB0YXNrIFRoZSB0YXNrIHRvIGFkZFxuICAgICAqIEByZXR1cm5zIFRoZSBzdWJ0YXNrIHRoYXQgd2FzIGFkZGVkXG4gICAgICovXG4gICAgYWRkVGFzayh0YXNrOiBUYXNrRGV0YWlsc01vZGVsKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc01vZGVsPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaUFkZFRhc2sodGFzaykpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlc3BvbnNlOiBUYXNrRGV0YWlsc01vZGVsKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGFza0RldGFpbHNNb2RlbChyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlbGV0ZXMgYSBzdWJ0YXNrIChpZSwgYSBjaGVja2xpc3QgdGFzaykgZnJvbSBhIHBhcmVudCB0YXNrLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgVGhlIHRhc2sgdG8gZGVsZXRlXG4gICAgICogQHJldHVybnMgTnVsbCByZXNwb25zZSBub3RpZnlpbmcgd2hlbiB0aGUgb3BlcmF0aW9uIGlzIGNvbXBsZXRlXG4gICAgICovXG4gICAgZGVsZXRlVGFzayh0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmNhbGxBcGlEZWxldGVUYXNrKHRhc2tJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVsZXRlcyBhIGZvcm0gZnJvbSBhIHRhc2suXG4gICAgICogQHBhcmFtIHRhc2tJZCBUYXNrIGlkIHJlbGF0ZWQgdG8gZm9ybVxuICAgICAqIEByZXR1cm5zIE51bGwgcmVzcG9uc2Ugbm90aWZ5aW5nIHdoZW4gdGhlIG9wZXJhdGlvbiBpcyBjb21wbGV0ZVxuICAgICAqL1xuICAgIGRlbGV0ZUZvcm0odGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzTW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5jYWxsQXBpRGVsZXRlRm9ybSh0YXNrSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdpdmVzIGNvbXBsZXRlZCBzdGF0dXMgdG8gYSB0YXNrLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHJldHVybnMgTnVsbCByZXNwb25zZSBub3RpZnlpbmcgd2hlbiB0aGUgb3BlcmF0aW9uIGlzIGNvbXBsZXRlXG4gICAgICovXG4gICAgY29tcGxldGVUYXNrKHRhc2tJZDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMudGFza0FjdGlvbnNBcGkuY29tcGxldGVUYXNrKHRhc2tJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgdG90YWwgbnVtYmVyIG9mIHRoZSB0YXNrcyBmb3VuZCBieSBhIHF1ZXJ5LlxuICAgICAqIEBwYXJhbSByZXF1ZXN0Tm9kZSBRdWVyeSB0byBzZWFyY2ggZm9yIHRhc2tzXG4gICAgICogQHJldHVybnMgTnVtYmVyIG9mIHRhc2tzXG4gICAgICovXG4gICAgcHVibGljIGdldFRvdGFsVGFza3MocmVxdWVzdE5vZGU6IFRhc2tRdWVyeVJlcXVlc3RSZXByZXNlbnRhdGlvbk1vZGVsKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmVxdWVzdE5vZGUuc2l6ZSA9IDA7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaVRhc2tzRmlsdGVyZWQocmVxdWVzdE5vZGUpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSBuZXcgc3RhbmRhbG9uZSB0YXNrLlxuICAgICAqIEBwYXJhbSB0YXNrIERldGFpbHMgb2YgdGhlIG5ldyB0YXNrXG4gICAgICogQHJldHVybnMgRGV0YWlscyBvZiB0aGUgbmV3bHkgY3JlYXRlZCB0YXNrXG4gICAgICovXG4gICAgY3JlYXRlTmV3VGFzayh0YXNrOiBUYXNrRGV0YWlsc01vZGVsKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc01vZGVsPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaUNyZWF0ZVRhc2sodGFzaykpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlc3BvbnNlOiBUYXNrRGV0YWlsc01vZGVsKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGFza0RldGFpbHNNb2RlbChyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFzc2lnbnMgYSB0YXNrIHRvIGEgdXNlciBvciBncm91cC5cbiAgICAgKiBAcGFyYW0gdGFza0lkIFRoZSB0YXNrIHRvIGFzc2lnblxuICAgICAqIEBwYXJhbSByZXF1ZXN0Tm9kZSBVc2VyIG9yIGdyb3VwIHRvIGFzc2lnbiB0aGUgdGFzayB0b1xuICAgICAqIEByZXR1cm5zIERldGFpbHMgb2YgdGhlIGFzc2lnbmVkIHRhc2tcbiAgICAgKi9cbiAgICBhc3NpZ25UYXNrKHRhc2tJZDogc3RyaW5nLCByZXF1ZXN0Tm9kZTogYW55KTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc01vZGVsPiB7XG4gICAgICAgIGNvbnN0IGFzc2lnbmVlID0geyBhc3NpZ25lZTogcmVxdWVzdE5vZGUuaWQgfTtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5jYWxsQXBpQXNzaWduVGFzayh0YXNrSWQsIGFzc2lnbmVlKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzcG9uc2U6IFRhc2tEZXRhaWxzTW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBUYXNrRGV0YWlsc01vZGVsKHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXNzaWducyBhIHRhc2sgdG8gYSB1c2VyLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhc2sgdG8gYXNzaWduXG4gICAgICogQHBhcmFtIHVzZXJJZCBJRCBvZiB0aGUgdXNlciB0byBhc3NpZ24gdGhlIHRhc2sgdG9cbiAgICAgKiBAcmV0dXJucyBEZXRhaWxzIG9mIHRoZSBhc3NpZ25lZCB0YXNrXG4gICAgICovXG4gICAgYXNzaWduVGFza0J5VXNlcklkKHRhc2tJZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICBjb25zdCBhc3NpZ25lZSA9IDxBc3NpZ25lZUlkZW50aWZpZXJSZXByZXNlbnRhdGlvbj4geyBhc3NpZ25lZTogdXNlcklkIH07XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaUFzc2lnblRhc2sodGFza0lkLCBhc3NpZ25lZSkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlc3BvbnNlOiBUYXNrRGV0YWlsc01vZGVsKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGFza0RldGFpbHNNb2RlbChyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsYWltcyBhIHRhc2sgZm9yIHRoZSBjdXJyZW50IHVzZXIuXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFzayB0byBjbGFpbVxuICAgICAqIEByZXR1cm5zIERldGFpbHMgb2YgdGhlIGNsYWltZWQgdGFza1xuICAgICAqL1xuICAgIGNsYWltVGFzayh0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnRhc2tBY3Rpb25zQXBpLmNsYWltVGFzayh0YXNrSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVuLWNsYWltcyBhIHRhc2sgZm9yIHRoZSBjdXJyZW50IHVzZXIuXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFzayB0byB1bmNsYWltXG4gICAgICogQHJldHVybnMgTnVsbCByZXNwb25zZSBub3RpZnlpbmcgd2hlbiB0aGUgb3BlcmF0aW9uIGlzIGNvbXBsZXRlXG4gICAgICovXG4gICAgdW5jbGFpbVRhc2sodGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzTW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy50YXNrQWN0aW9uc0FwaS51bmNsYWltVGFzayh0YXNrSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZXMgdGhlIGRldGFpbHMgKG5hbWUsIGRlc2NyaXB0aW9uLCBkdWUgZGF0ZSkgZm9yIGEgdGFzay5cbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXNrIHRvIHVwZGF0ZVxuICAgICAqIEBwYXJhbSB1cGRhdGVkIERhdGEgdG8gdXBkYXRlIHRoZSB0YXNrIChhcyBhIGBUYXNrVXBkYXRlUmVwcmVzZW50YXRpb25gIGluc3RhbmNlKS5cbiAgICAgKiBAcmV0dXJucyBVcGRhdGVkIHRhc2sgZGV0YWlsc1xuICAgICAqL1xuICAgIHVwZGF0ZVRhc2sodGFza0lkOiBzdHJpbmcsIHVwZGF0ZWQ6IFRhc2tVcGRhdGVSZXByZXNlbnRhdGlvbik6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnRhc2tzQXBpLnVwZGF0ZVRhc2sodGFza0lkLCB1cGRhdGVkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzdWx0KSA9PiA8VGFza0RldGFpbHNNb2RlbD4gcmVzdWx0KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmV0Y2hlcyB0aGUgVGFzayBBdWRpdCBpbmZvcm1hdGlvbiBpbiBQREYgZm9ybWF0LlxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHJldHVybnMgQmluYXJ5IFBERiBkYXRhXG4gICAgICovXG4gICAgZmV0Y2hUYXNrQXVkaXRQZGZCeUlkKHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxCbG9iPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMudGFza3NBcGkuZ2V0VGFza0F1ZGl0UGRmKHRhc2tJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKGRhdGEpID0+IDxCbG9iPiBkYXRhKSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmV0Y2ggdGhlIFRhc2sgQXVkaXQgaW5mb3JtYXRpb24gaW4gSlNPTiBmb3JtYXRcbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXJnZXQgdGFza1xuICAgICAqIEByZXR1cm5zIEpTT04gZGF0YVxuICAgICAqL1xuICAgIGZldGNoVGFza0F1ZGl0SnNvbkJ5SWQodGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnRhc2tzQXBpLmdldFRhc2tBdWRpdExvZyh0YXNrSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsbEFwaVRhc2tzRmlsdGVyZWQocmVxdWVzdE5vZGU6IFRhc2tRdWVyeVJlcHJlc2VudGF0aW9uKTogUHJvbWlzZTxUYXNrTGlzdE1vZGVsPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnRhc2tzQXBpLmxpc3RUYXNrcyhyZXF1ZXN0Tm9kZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxsQXBpVGFza0RldGFpbHModGFza0lkOiBzdHJpbmcpOiBQcm9taXNlPFRhc2tEZXRhaWxzTW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGFza3NBcGkuZ2V0VGFzayh0YXNrSWQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsbEFwaUFkZFRhc2sodGFzazogVGFza0RldGFpbHNNb2RlbCk6IFByb21pc2U8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jaGVja2xpc3RzQXBpLmFkZFN1YnRhc2sodGFzay5wYXJlbnRUYXNrSWQsIHRhc2spO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsbEFwaURlbGV0ZVRhc2sodGFza0lkOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gdGhpcy50YXNrc0FwaS5kZWxldGVUYXNrKHRhc2tJZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxsQXBpRGVsZXRlRm9ybSh0YXNrSWQ6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnRhc2tBY3Rpb25zQXBpLnJlbW92ZUZvcm0odGFza0lkKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbGxBcGlUYXNrQ2hlY2tsaXN0KHRhc2tJZDogc3RyaW5nKTogUHJvbWlzZTxUYXNrTGlzdE1vZGVsPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNoZWNrbGlzdHNBcGkuZ2V0Q2hlY2tsaXN0KHRhc2tJZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxsQXBpQ3JlYXRlVGFzayh0YXNrOiBUYXNrRGV0YWlsc01vZGVsKTogUHJvbWlzZTxUYXNrRGV0YWlsc01vZGVsPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnRhc2tzQXBpLmNyZWF0ZU5ld1Rhc2sodGFzayk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxsQXBpQXNzaWduVGFzayh0YXNrSWQ6IHN0cmluZywgcmVxdWVzdE5vZGU6IEFzc2lnbmVlSWRlbnRpZmllclJlcHJlc2VudGF0aW9uKTogUHJvbWlzZTxUYXNrRGV0YWlsc01vZGVsPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnRhc2tBY3Rpb25zQXBpLmFzc2lnblRhc2sodGFza0lkLCByZXF1ZXN0Tm9kZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVFcnJvcihlcnJvcjogYW55KSB7XG4gICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcihlcnJvcik7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yIHx8ICdTZXJ2ZXIgZXJyb3InKTtcbiAgICB9XG5cbn1cbiJdfQ==