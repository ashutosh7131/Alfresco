/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Component, Input, Output, EventEmitter, ViewEncapsulation } from '@angular/core';
import { AuthenticationService, TranslationService } from '@alfresco/adf-core';
import { TaskListService } from '../../services/tasklist.service';
export class TaskFormComponent {
    constructor(taskListService, authService, translationService) {
        this.taskListService = taskListService;
        this.authService = authService;
        this.translationService = translationService;
        this.showFormTitle = false;
        this.showFormCompleteButton = true;
        this.showFormSaveButton = true;
        this.showCancelButton = true;
        this.readOnlyForm = false;
        this.showFormRefreshButton = true;
        this.showFormValidationIcon = true;
        this.fieldValidators = [];
        this.formSaved = new EventEmitter();
        this.formCompleted = new EventEmitter();
        this.formContentClicked = new EventEmitter();
        this.formLoaded = new EventEmitter();
        this.showAttachForm = new EventEmitter();
        this.executeOutcome = new EventEmitter();
        this.completed = new EventEmitter();
        this.formError = new EventEmitter();
        this.error = new EventEmitter();
        this.cancel = new EventEmitter();
        this.taskClaimed = new EventEmitter();
        this.taskUnclaimed = new EventEmitter();
        this.loading = false;
        this.internalReadOnlyForm = false;
    }
    ngOnInit() {
        this.authService.getBpmLoggedUser().subscribe(user => {
            this.currentLoggedUser = user;
        });
        this.loadTask(this.taskId);
    }
    ngOnChanges(changes) {
        const taskId = changes['taskId'];
        if (taskId && taskId.currentValue) {
            this.loadTask(this.taskId);
            return;
        }
    }
    loadTask(taskId) {
        this.loading = true;
        if (taskId) {
            this.taskListService.getTaskDetails(taskId).subscribe((res) => {
                this.taskDetails = res;
                if (!this.taskDetails.name) {
                    this.taskDetails.name = 'No name';
                }
                const endDate = res.endDate;
                if (endDate && !isNaN(endDate.getTime())) {
                    this.internalReadOnlyForm = true;
                }
                else {
                    this.internalReadOnlyForm = this.readOnlyForm;
                }
                this.loading = false;
            });
        }
    }
    onFormSaved(savedForm) {
        this.formSaved.emit(savedForm);
    }
    onFormCompleted(form) {
        this.formCompleted.emit(form);
    }
    onFormLoaded(form) {
        this.formLoaded.emit(form);
    }
    onFormContentClick(content) {
        this.formContentClicked.emit(content);
    }
    onFormExecuteOutcome(outcome) {
        this.executeOutcome.emit(outcome);
    }
    onFormError(error) {
        this.formError.emit(error);
    }
    onError(error) {
        this.error.emit(error);
    }
    onCompleteTask() {
        this.taskListService.completeTask(this.taskDetails.id).subscribe(() => this.completed.emit(), (error) => this.error.emit(error));
    }
    onCancel() {
        this.cancel.emit();
    }
    onShowAttachForm() {
        this.showAttachForm.emit();
    }
    hasFormKey() {
        return (this.taskDetails && (!!this.taskDetails.formKey));
    }
    isStandaloneTask() {
        return !(this.taskDetails && (!!this.taskDetails.processDefinitionId));
    }
    isTaskLoaded() {
        return !!this.taskDetails;
    }
    isCompletedTask() {
        return this.taskDetails && this.taskDetails.endDate !== undefined && this.taskDetails.endDate !== null;
    }
    isCompleteButtonVisible() {
        return !this.hasFormKey() && this.isTaskActive() && this.isCompleteButtonEnabled();
    }
    isTaskActive() {
        return this.taskDetails && this.taskDetails.duration === null;
    }
    isAssigned() {
        return !!this.taskDetails.assignee;
    }
    hasEmailAddress() {
        return this.taskDetails.assignee.email ? true : false;
    }
    isAssignedToMe() {
        return this.isAssigned() && this.hasEmailAddress() ?
            this.isEmailEqual() :
            this.isExternalIdEqual();
    }
    isEmailEqual() {
        return (this.taskDetails.assignee && this.currentLoggedUser) && (this.taskDetails.assignee.email.toLocaleLowerCase() === this.currentLoggedUser.email.toLocaleLowerCase());
    }
    isExternalIdEqual() {
        return (this.taskDetails.assignee && this.currentLoggedUser) && (this.taskDetails.assignee.externalId === this.currentLoggedUser.externalId);
    }
    isCompleteButtonEnabled() {
        return this.isAssignedToMe() || this.canInitiatorComplete();
    }
    canInitiatorComplete() {
        return this.taskDetails.initiatorCanCompleteTask;
    }
    isReadOnlyForm() {
        let readOnlyForm;
        if (this.isCandidateMember()) {
            readOnlyForm = this.internalReadOnlyForm || !this.isAssignedToMe();
        }
        else {
            readOnlyForm = this.internalReadOnlyForm || !(this.isAssignedToMe() || this.canCurrentUserAsInitiatorComplete() || this.isCurrentUserInvolved());
        }
        return readOnlyForm;
    }
    isCurrentUserInvolved() {
        var _a, _b;
        let isInvolved = false;
        if (this.taskDetails.involvedPeople && this.currentLoggedUser) {
            const userInvolved = this.taskDetails.involvedPeople.find((involvedUser) => involvedUser.email.toLocaleLowerCase() === this.currentLoggedUser.email.toLocaleLowerCase() ||
                involvedUser.id + '' === this.currentLoggedUser.externalId);
            isInvolved = !!userInvolved;
        }
        if (((_a = this.taskDetails.involvedGroups) === null || _a === void 0 ? void 0 : _a.length) && ((_b = this.currentLoggedUser.groups) === null || _b === void 0 ? void 0 : _b.length) && !isInvolved) {
            const userGroup = this.taskDetails.involvedGroups.find((involvedGroup) => this.currentLoggedUser.groups.find(group => group.name === involvedGroup.name.toLocaleLowerCase() || group.id === involvedGroup.id));
            isInvolved = !!userGroup;
        }
        return isInvolved;
    }
    canCurrentUserAsInitiatorComplete() {
        return this.canInitiatorComplete() && this.isProcessInitiator();
    }
    isProcessInitiator() {
        return this.currentLoggedUser && (this.currentLoggedUser.id === +this.taskDetails.processInstanceStartUserId);
    }
    isSaveButtonVisible() {
        return this.showFormSaveButton && (!this.canInitiatorComplete() || this.isAssignedToMe() || this.isCurrentUserInvolved());
    }
    canCompleteNoFormTask() {
        return this.isReadOnlyForm();
    }
    getCompletedTaskTranslatedMessage() {
        return this.translationService.get('ADF_TASK_FORM.COMPLETED_TASK.TITLE', { taskName: this.taskDetails.name });
    }
    isCandidateMember() {
        return this.taskDetails.managerOfCandidateGroup || this.taskDetails.memberOfCandidateGroup || this.taskDetails.memberOfCandidateUsers;
    }
    isTaskClaimable() {
        return this.isCandidateMember() && !this.isAssigned();
    }
    isTaskClaimedByCandidateMember() {
        return this.isCandidateMember() && this.isAssignedToMe() && !this.isCompletedTask();
    }
    reloadTask() {
        this.loadTask(this.taskId);
    }
    onClaimTask(taskId) {
        this.taskClaimed.emit(taskId);
    }
    onClaimTaskError(error) {
        this.error.emit(error);
    }
    onUnclaimTask(taskId) {
        this.taskUnclaimed.emit(taskId);
    }
    onUnclaimTaskError(error) {
        this.error.emit(error);
    }
}
TaskFormComponent.decorators = [
    { type: Component, args: [{
                selector: 'adf-task-form',
                template: "<ng-container *ngIf=\"!loading; else loadingTemplate\">\n  <adf-form *ngIf=\"hasFormKey(); else withoutForm\"\n    [taskId]=\"taskDetails?.id\"\n    [showTitle]=\"showFormTitle\"\n    [showValidationIcon]=\"showFormValidationIcon\"\n    [showRefreshButton]=\"showFormRefreshButton\"\n    [showCompleteButton]=\"showFormCompleteButton\"\n    [showSaveButton]=\"isSaveButtonVisible()\"\n    [disableCompleteButton]=\"!isCompleteButtonEnabled()\"\n    [readOnly]=\"isReadOnlyForm()\"\n    [fieldValidators]=\"fieldValidators\"\n    (formSaved)='onFormSaved($event)'\n    (formCompleted)='onFormCompleted($event)'\n    (formContentClicked)='onFormContentClick($event)'\n    (formLoaded)='onFormLoaded($event)'\n    (formError)='onFormError($event)'\n    (error)='onError($event)'\n    (executeOutcome)='onFormExecuteOutcome($event)'>\n    <adf-form-custom-outcomes>\n        <ng-template [ngTemplateOutlet]=\"taskFormButtons\">\n        </ng-template>\n    </adf-form-custom-outcomes>\n  </adf-form>\n  <ng-template #withoutForm>\n    <adf-task-standalone *ngIf=\"isStandaloneTask(); else emptyFormMessage\"\n        [taskName]=\"taskDetails.name\"\n        [taskId]=\"taskDetails.id\"\n        [isCompleted]=\"isCompletedTask()\"\n        [hasCompletePermission]=\"isCompleteButtonVisible()\"\n        [hideCancelButton]=\"showCancelButton\"\n        (complete)=\"onCompleteTask()\"\n        (showAttachForm)=\"onShowAttachForm()\">\n    </adf-task-standalone>\n      <ng-template #emptyFormMessage>\n        <mat-card class=\"adf-task-form-container\">\n            <mat-card-header>\n                <mat-card-title>\n                    <h4>\n                        <span class=\"adf-form-title\">\n                            {{taskDetails.name}}\n                            <ng-container *ngIf=\"!taskDetails.name\">\n                                {{'FORM.FORM_RENDERER.NAMELESS_TASK' | translate}}\n                            </ng-container>\n                        </span>\n                    </h4>\n                </mat-card-title>\n            </mat-card-header>\n            <mat-card-content>\n                <adf-empty-content *ngIf=\"isCompletedTask(); else emptyFormTemplate\"\n                    [icon]=\"'description'\"\n                    [title]=\"getCompletedTaskTranslatedMessage() | async\"\n                    [subtitle]=\"'ADF_TASK_FORM.COMPLETED_TASK.SUBTITLE'\">\n                </adf-empty-content>\n                <ng-template #emptyFormTemplate>\n                    <adf-empty-content\n                        [icon]=\"'description'\"\n                        [title]=\"'ADF_TASK_LIST.STANDALONE_TASK.NO_FORM_MESSAGE'\"\n                        [subtitle]=\"'ADF_TASK_FORM.EMPTY_FORM.SUBTITLE'\">\n                    </adf-empty-content>\n                </ng-template>\n            </mat-card-content>\n            <mat-card-actions class=\"adf-task-form-actions\">\n                <ng-template [ngTemplateOutlet]=\"taskFormButtons\"></ng-template>\n                <button mat-button\n                    *ngIf=\"!isCompletedTask()\" id=\"adf-no-form-complete-button\"\n                    color=\"primary\"\n                    [disabled]=\"canCompleteNoFormTask()\"\n                    (click)=\"onCompleteTask()\">\n                    {{'ADF_TASK_FORM.EMPTY_FORM.BUTTONS.COMPLETE' | translate}}\n                </button>\n            </mat-card-actions>\n        </mat-card>\n      </ng-template>\n  </ng-template>\n\n  <ng-template #taskFormButtons>\n        <button mat-button id=\"adf-no-form-cancel-button\"\n            *ngIf=\"showCancelButton\"\n            (click)=\"onCancel()\">\n            {{'ADF_TASK_FORM.EMPTY_FORM.BUTTONS.CANCEL' | translate}}\n        </button>\n        <button mat-button data-automation-id=\"adf-task-form-claim-button\"\n            *ngIf=\"isTaskClaimable()\"\n            adf-claim-task\n            [taskId]=\"taskId\"\n            (success)=\"onClaimTask($event)\"\n            (error)=\"onClaimTaskError($event)\">\n            {{ 'ADF_TASK_FORM.EMPTY_FORM.BUTTONS.CLAIM' | translate }}\n        </button>\n        <button mat-button data-automation-id=\"adf-task-form-unclaim-button\"\n            *ngIf=\"isTaskClaimedByCandidateMember()\"\n            adf-unclaim-task\n            [taskId]=\"taskId\"\n            (success)=\"onUnclaimTask($event)\"\n            (error)=\"onUnclaimTaskError($event)\">\n            {{ 'ADF_TASK_FORM.EMPTY_FORM.BUTTONS.UNCLAIM' | translate }}\n        </button>\n  </ng-template>\n</ng-container>\n<ng-template #loadingTemplate>\n  <div fxLayout=\"row\" fxLayoutAlign=\"center stretch\">\n      <mat-spinner></mat-spinner>\n  </div>\n</ng-template>\n",
                encapsulation: ViewEncapsulation.None,
                styles: [".adf-task-form-container{overflow:hidden}.adf-task-form-actions{float:right;padding-bottom:25px!important;padding-right:25px!important}.adf-task-form-actions .mat-button{border-radius:5px;height:36px}.adf-task-form-actions .mat-button-wrapper{font-size:var(--theme-body-2-font-size);font-weight:700;height:20px;opacity:.54;width:58px}"]
            },] }
];
TaskFormComponent.ctorParameters = () => [
    { type: TaskListService },
    { type: AuthenticationService },
    { type: TranslationService }
];
TaskFormComponent.propDecorators = {
    taskId: [{ type: Input }],
    showFormTitle: [{ type: Input }],
    showFormCompleteButton: [{ type: Input }],
    showFormSaveButton: [{ type: Input }],
    showCancelButton: [{ type: Input }],
    readOnlyForm: [{ type: Input }],
    showFormRefreshButton: [{ type: Input }],
    showFormValidationIcon: [{ type: Input }],
    fieldValidators: [{ type: Input }],
    formSaved: [{ type: Output }],
    formCompleted: [{ type: Output }],
    formContentClicked: [{ type: Output }],
    formLoaded: [{ type: Output }],
    showAttachForm: [{ type: Output }],
    executeOutcome: [{ type: Output }],
    completed: [{ type: Output }],
    formError: [{ type: Output }],
    error: [{ type: Output }],
    cancel: [{ type: Output }],
    taskClaimed: [{ type: Output }],
    taskUnclaimed: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFzay1mb3JtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL3Byb2Nlc3Mtc2VydmljZXMvc3JjLyIsInNvdXJjZXMiOlsibGliL3Rhc2stbGlzdC9jb21wb25lbnRzL3Rhc2stZm9ybS90YXNrLWZvcm0uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7R0FlRztBQUVILE9BQU8sRUFBRSxTQUFTLEVBQVUsS0FBSyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQWlCLGlCQUFpQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pILE9BQU8sRUFLTCxxQkFBcUIsRUFDckIsa0JBQWtCLEVBRW5CLE1BQU0sb0JBQW9CLENBQUM7QUFFNUIsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBVWxFLE1BQU0sT0FBTyxpQkFBaUI7SUFnRzVCLFlBQ1UsZUFBZ0MsRUFDaEMsV0FBa0MsRUFDbEMsa0JBQXNDO1FBRnRDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNoQyxnQkFBVyxHQUFYLFdBQVcsQ0FBdUI7UUFDbEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQTNGaEQsa0JBQWEsR0FBWSxLQUFLLENBQUM7UUFJL0IsMkJBQXNCLEdBQVksSUFBSSxDQUFDO1FBSXZDLHVCQUFrQixHQUFZLElBQUksQ0FBQztRQUluQyxxQkFBZ0IsR0FBWSxJQUFJLENBQUM7UUFNakMsaUJBQVksR0FBWSxLQUFLLENBQUM7UUFJOUIsMEJBQXFCLEdBQVksSUFBSSxDQUFDO1FBSXRDLDJCQUFzQixHQUFZLElBQUksQ0FBQztRQUl2QyxvQkFBZSxHQUF5QixFQUFFLENBQUM7UUFJM0MsY0FBUyxHQUFHLElBQUksWUFBWSxFQUFhLENBQUM7UUFJMUMsa0JBQWEsR0FBRyxJQUFJLFlBQVksRUFBYSxDQUFDO1FBSTlDLHVC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WUF0VUYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxlQUFlO2dCQUN6QixvbEpBQXlDO2dCQUV6QyxhQUFhLEVBQUUsaUJBQWlCLENBQUMsSUFBSTs7YUFDdEM7OztZQVRRLGVBQWU7WUFMdEIscUJBQXFCO1lBQ3JCLGtCQUFrQjs7O3FCQWlCakIsS0FBSzs0QkFJTCxLQUFLO3FDQUlMLEtBQUs7aUNBSUwsS0FBSzsrQkFJTCxLQUFLOzJCQU1MLEtBQUs7b0NBSUwsS0FBSztxQ0FJTCxLQUFLOzhCQUlMLEtBQUs7d0JBSUwsTUFBTTs0QkFJTixNQUFNO2lDQUlOLE1BQU07eUJBSU4sTUFBTTs2QkFJTixNQUFNOzZCQU1OLE1BQU07d0JBSU4sTUFBTTt3QkFJTixNQUFNO29CQUlOLE1BQU07cUJBSU4sTUFBTTswQkFJTixNQUFNOzRCQUlOLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgSW5wdXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyLCBTaW1wbGVDaGFuZ2VzLCBWaWV3RW5jYXBzdWxhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgRm9ybU1vZGVsLFxuICBDb250ZW50TGlua01vZGVsLFxuICBGb3JtRmllbGRWYWxpZGF0b3IsXG4gIEZvcm1PdXRjb21lRXZlbnQsXG4gIEF1dGhlbnRpY2F0aW9uU2VydmljZSxcbiAgVHJhbnNsYXRpb25TZXJ2aWNlLFxuICBGb3JtRmllbGRNb2RlbFxufSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgVGFza0RldGFpbHNNb2RlbCB9IGZyb20gJy4uLy4uL21vZGVscy90YXNrLWRldGFpbHMubW9kZWwnO1xuaW1wb3J0IHsgVGFza0xpc3RTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvdGFza2xpc3Quc2VydmljZSc7XG5pbXBvcnQgeyBVc2VyUmVwcmVzZW50YXRpb24sIExpZ2h0R3JvdXBSZXByZXNlbnRhdGlvbiwgTGlnaHRVc2VyUmVwcmVzZW50YXRpb24gfSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYWRmLXRhc2stZm9ybScsXG4gIHRlbXBsYXRlVXJsOiAnLi90YXNrLWZvcm0uY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi90YXNrLWZvcm0uY29tcG9uZW50LnNjc3MnXSxcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZVxufSlcbmV4cG9ydCBjbGFzcyBUYXNrRm9ybUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG5cbiAgLyoqICgqKnJlcXVpcmVkKiopIFRoZSBpZCBvZiB0aGUgdGFzayB3aG9zZSBkZXRhaWxzIHdlIGFyZSBhc2tpbmcgZm9yLiAqL1xuICBASW5wdXQoKVxuICB0YXNrSWQ6IHN0cmluZztcblxuICAvKiogVG9nZ2xlcyByZW5kZXJpbmcgb2YgdGhlIGZvcm0gdGl0bGUuICovXG4gIEBJbnB1dCgpXG4gIHNob3dGb3JtVGl0bGU6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAvKiogVG9nZ2xlcyByZW5kZXJpbmcgb2YgdGhlIGBDb21wbGV0ZWAgb3V0Y29tZSBidXR0b24uICovXG4gIEBJbnB1dCgpXG4gIHNob3dGb3JtQ29tcGxldGVCdXR0b246IGJvb2xlYW4gPSB0cnVlO1xuXG4gIC8qKiBUb2dnbGVzIHJlbmRlcmluZyBvZiB0aGUgYFNhdmVgIG91dGNvbWUgYnV0dG9uLiAqL1xuICBASW5wdXQoKVxuICBzaG93Rm9ybVNhdmVCdXR0b246IGJvb2xlYW4gPSB0cnVlO1xuXG4gIC8qKiBUb2dnbGUgcmVuZGVyaW5nIG9mIHRoZSBgQ2FuY2VsYCBidXR0b24uICovXG4gIEBJbnB1dCgpXG4gIHNob3dDYW5jZWxCdXR0b246IGJvb2xlYW4gPSB0cnVlO1xuXG4gIC8qKiBUb2dnbGVzIHJlYWQtb25seSBzdGF0ZSBvZiB0aGUgZm9ybS4gQWxsIGZvcm0gd2lkZ2V0cyByZW5kZXIgYXMgcmVhZC1vbmx5XG4gICAqIGlmIGVuYWJsZWQuXG4gICAqL1xuICBASW5wdXQoKVxuICByZWFkT25seUZvcm06IGJvb2xlYW4gPSBmYWxzZTtcblxuICAvKiogVG9nZ2xlcyByZW5kZXJpbmcgb2YgdGhlIGBSZWZyZXNoYCBidXR0b24uICovXG4gIEBJbnB1dCgpXG4gIHNob3dGb3JtUmVmcmVzaEJ1dHRvbjogYm9vbGVhbiA9IHRydWU7XG5cbiAgLyoqIFRvZ2dsZSByZW5kZXJpbmcgb2YgdGhlIHZhbGlkYXRpb24gaWNvbiBuZXh0IHRvIHRoZSBmb3JtIHRpdGxlLiAqL1xuICBASW5wdXQoKVxuICBzaG93Rm9ybVZhbGlkYXRpb25JY29uOiBib29sZWFuID0gdHJ1ZTtcblxuICAvKiogRmllbGQgdmFsaWRhdG9ycyBmb3IgdXNlIHdpdGggdGhlIGZvcm0uICovXG4gIEBJbnB1dCgpXG4gIGZpZWxkVmFsaWRhdG9yczogRm9ybUZpZWxkVmFsaWRhdG9yW10gPSBbXTtcblxuICAvKiogRW1pdHRlZCB3aGVuIHRoZSBmb3JtIGlzIHN1Ym1pdHRlZCB3aXRoIHRoZSBgU2F2ZWAgb3IgY3VzdG9tIG91dGNvbWVzLiAqL1xuICBAT3V0cHV0KClcbiAgZm9ybVNhdmVkID0gbmV3IEV2ZW50RW1pdHRlcjxGb3JtTW9kZWw+KCk7XG5cbiAgLyoqIEVtaXR0ZWQgd2hlbiB0aGUgZm9ybSBpcyBzdWJtaXR0ZWQgd2l0aCB0aGUgYENvbXBsZXRlYCBvdXRjb21lLiAqL1xuICBAT3V0cHV0KClcbiAgZm9ybUNvbXBsZXRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8Rm9ybU1vZGVsPigpO1xuXG4gIC8qKiBFbWl0dGVkIHdoZW4gdGhlIGZvcm0gZmllbGQgY29udGVudCBpcyBjbGlja2VkLiAqL1xuICBAT3V0cHV0KClcbiAgZm9ybUNvbnRlbnRDbGlja2VkID0gbmV3IEV2ZW50RW1pdHRlcjxDb250ZW50TGlua01vZGVsPigpO1xuXG4gIC8qKiBFbWl0dGVkIHdoZW4gdGhlIGZvcm0gaXMgbG9hZGVkIG9yIHJlbG9hZGVkLiAqL1xuICBAT3V0cHV0KClcbiAgZm9ybUxvYWRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8Rm9ybU1vZGVsPigpO1xuXG4gIC8qKiBFbWl0dGVkIHdoZW4gdGhlIGZvcm0gYXNzb2NpYXRlZCB3aXRoIHRoZSBmb3JtIHRhc2sgaXMgYXR0YWNoZWQuICovXG4gIEBPdXRwdXQoKVxuICBzaG93QXR0YWNoRm9ybTogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuXG4gIC8qKiBFbWl0dGVkIHdoZW4gYW55IG91dGNvbWUgaXMgZXhlY3V0ZWQuIERlZmF1bHQgYmVoYXZpb3VyIGNhbiBiZSBwcmV2ZW50ZWRcbiAgICogdmlhIGBldmVudC5wcmV2ZW50RGVmYXVsdCgpYC5cbiAgICovXG4gIEBPdXRwdXQoKVxuICBleGVjdXRlT3V0Y29tZSA9IG5ldyBFdmVudEVtaXR0ZXI8Rm9ybU91dGNvbWVFdmVudD4oKTtcblxuICAvKiogRW1pdHRlZCB3aGVuIHRoZSBmb3JtIGFzc29jaWF0ZWQgd2l0aCB0aGUgdGFzayBpcyBjb21wbGV0ZWQuICovXG4gIEBPdXRwdXQoKVxuICBjb21wbGV0ZWQgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG5cbiAgLyoqIEVtaXR0ZWQgd2hlbiB0aGUgc3VwcGxpZWQgZm9ybSB2YWx1ZXMgaGF2ZSBhIHZhbGlkYXRpb24gZXJyb3IuICovXG4gIEBPdXRwdXQoKVxuICBmb3JtRXJyb3I6IEV2ZW50RW1pdHRlcjxGb3JtRmllbGRNb2RlbFtdPiA9IG5ldyBFdmVudEVtaXR0ZXI8Rm9ybUZpZWxkTW9kZWxbXT4oKTtcblxuICAvKiogRW1pdHRlZCB3aGVuIGFuIGVycm9yIG9jY3Vycy4gKi9cbiAgQE91dHB1dCgpXG4gIGVycm9yID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgLyoqIEVtaXR0ZWQgd2hlbiB0aGUgXCJDYW5jZWxcIiBidXR0b24gaXMgY2xpY2tlZC4gKi9cbiAgQE91dHB1dCgpXG4gIGNhbmNlbCA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcblxuICAvKiogRW1pdHRlZCB3aGVuIHRoZSB0YXNrIGlzIGNsYWltZWQuICovXG4gIEBPdXRwdXQoKVxuICB0YXNrQ2xhaW1lZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xuXG4gIC8qKiBFbWl0dGVkIHdoZW4gdGhlIHRhc2sgaXMgdW5jbGFpbWVkIChpZSwgcmVxdWV1ZWQpLi4gKi9cbiAgQE91dHB1dCgpXG4gIHRhc2tVbmNsYWltZWQgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcblxuICB0YXNrRGV0YWlsczogVGFza0RldGFpbHNNb2RlbDtcbiAgY3VycmVudExvZ2dlZFVzZXI6IFVzZXJSZXByZXNlbnRhdGlvbjtcbiAgbG9hZGluZzogYm9vbGVhbiA9IGZhbHNlO1xuICBjb21wbGV0ZWRUYXNrTWVzc2FnZTogc3RyaW5nO1xuICBpbnRlcm5hbFJlYWRPbmx5Rm9ybTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdGFza0xpc3RTZXJ2aWNlOiBUYXNrTGlzdFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhdXRoU2VydmljZTogQXV0aGVudGljYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgdHJhbnNsYXRpb25TZXJ2aWNlOiBUcmFuc2xhdGlvblNlcnZpY2VcbiAgKSB7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmF1dGhTZXJ2aWNlLmdldEJwbUxvZ2dlZFVzZXIoKS5zdWJzY3JpYmUodXNlciA9PiB7XG4gICAgICB0aGlzLmN1cnJlbnRMb2dnZWRVc2VyID0gdXNlcjtcbiAgICB9KTtcbiAgICB0aGlzLmxvYWRUYXNrKHRoaXMudGFza0lkKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBjb25zdCB0YXNrSWQgPSBjaGFuZ2VzWyd0YXNrSWQnXTtcbiAgICBpZiAodGFza0lkICYmIHRhc2tJZC5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgdGhpcy5sb2FkVGFzayh0aGlzLnRhc2tJZCk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gIH1cblxuICBsb2FkVGFzayh0YXNrSWQ6IHN0cmluZykge1xuICAgIHRoaXMubG9hZGluZyA9IHRydWU7XG4gICAgaWYgKHRhc2tJZCkge1xuICAgICAgdGhpcy50YXNrTGlzdFNlcnZpY2UuZ2V0VGFza0RldGFpbHModGFza0lkKS5zdWJzY3JpYmUoXG4gICAgICAgIChyZXM6IFRhc2tEZXRhaWxzTW9kZWwpID0+IHtcbiAgICAgICAgICAgIHRoaXMudGFza0RldGFpbHMgPSByZXM7XG5cbiAgICAgICAgICAgIGlmICghdGhpcy50YXNrRGV0YWlscy5uYW1lKSB7XG4gICAgICAgICAgICAgICAgdGhpcy50YXNrRGV0YWlscy5uYW1lID0gJ05vIG5hbWUnO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBlbmREYXRlOiBhbnkgPSByZXMuZW5kRGF0ZTtcbiAgICAgICAgICAgIGlmIChlbmREYXRlICYmICFpc05hTihlbmREYXRlLmdldFRpbWUoKSkpIHtcbiAgICAgICAgICAgICAgdGhpcy5pbnRlcm5hbFJlYWRPbmx5Rm9ybSA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuaW50ZXJuYWxSZWFkT25seUZvcm0gPSB0aGlzLnJlYWRPbmx5Rm9ybTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlO1xuICAgICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBvbkZvcm1TYXZlZChzYXZlZEZvcm06IEZvcm1Nb2RlbCkge1xuICAgIHRoaXMuZm9ybVNhdmVkLmVtaXQoc2F2ZWRGb3JtKTtcbiAgfVxuXG4gIG9uRm9ybUNvbXBsZXRlZChmb3JtOiBGb3JtTW9kZWwpIHtcbiAgICAgIHRoaXMuZm9ybUNvbXBsZXRlZC5lbWl0KGZvcm0pO1xuICB9XG5cbiAgb25Gb3JtTG9hZGVkKGZvcm06IEZvcm1Nb2RlbCk6IHZvaWQge1xuICAgIHRoaXMuZm9ybUxvYWRlZC5lbWl0KGZvcm0pO1xuICB9XG5cbiAgb25Gb3JtQ29udGVudENsaWNrKGNvbnRlbnQ6IENvbnRlbnRMaW5rTW9kZWwpOiB2b2lkIHtcbiAgICAgIHRoaXMuZm9ybUNvbnRlbnRDbGlja2VkLmVtaXQoY29udGVudCk7XG4gIH1cblxuICBvbkZvcm1FeGVjdXRlT3V0Y29tZShvdXRjb21lOiBGb3JtT3V0Y29tZUV2ZW50KSB7XG4gICAgdGhpcy5leGVjdXRlT3V0Y29tZS5lbWl0KG91dGNvbWUpO1xuICB9XG5cbiAgb25Gb3JtRXJyb3IoZXJyb3I6IGFueSkge1xuICAgIHRoaXMuZm9ybUVycm9yLmVtaXQoZXJyb3IpO1xuICB9XG5cbiAgb25FcnJvcihlcnJvcjogYW55KSB7XG4gICAgdGhpcy5lcnJvci5lbWl0KGVycm9yKTtcbiAgfVxuXG4gIG9uQ29tcGxldGVUYXNrKCkge1xuICAgIHRoaXMudGFza0xpc3RTZXJ2aWNlLmNvbXBsZXRlVGFzayh0aGlzLnRhc2tEZXRhaWxzLmlkKS5zdWJzY3JpYmUoXG4gICAgICAoKSA9PiB0aGlzLmNvbXBsZXRlZC5lbWl0KCksXG4gICAgICAoZXJyb3IpID0+IHRoaXMuZXJyb3IuZW1pdChlcnJvcikpO1xuICB9XG5cbiAgb25DYW5jZWwoKSB7XG4gICAgdGhpcy5jYW5jZWwuZW1pdCgpO1xuICB9XG5cbiAgb25TaG93QXR0YWNoRm9ybSgpIHtcbiAgICB0aGlzLnNob3dBdHRhY2hGb3JtLmVtaXQoKTtcbiAgfVxuXG4gIGhhc0Zvcm1LZXkoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICh0aGlzLnRhc2tEZXRhaWxzICYmICghIXRoaXMudGFza0RldGFpbHMuZm9ybUtleSkpO1xuICB9XG5cbiAgaXNTdGFuZGFsb25lVGFzaygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISh0aGlzLnRhc2tEZXRhaWxzICYmICghIXRoaXMudGFza0RldGFpbHMucHJvY2Vzc0RlZmluaXRpb25JZCkpO1xuICB9XG5cbiAgaXNUYXNrTG9hZGVkKCk6IGJvb2xlYW4ge1xuICAgICAgcmV0dXJuICEhdGhpcy50YXNrRGV0YWlscztcbiAgfVxuXG4gIGlzQ29tcGxldGVkVGFzaygpOiBib29sZWFuIHtcbiAgICAgIHJldHVybiB0aGlzLnRhc2tEZXRhaWxzICYmIHRoaXMudGFza0RldGFpbHMuZW5kRGF0ZSAhPT0gdW5kZWZpbmVkICYmIHRoaXMudGFza0RldGFpbHMuZW5kRGF0ZSAhPT0gbnVsbDtcbiAgfVxuXG4gIGlzQ29tcGxldGVCdXR0b25WaXNpYmxlKCk6IGJvb2xlYW4ge1xuICAgICAgcmV0dXJuICF0aGlzLmhhc0Zvcm1LZXkoKSAmJiB0aGlzLmlzVGFza0FjdGl2ZSgpICYmIHRoaXMuaXNDb21wbGV0ZUJ1dHRvbkVuYWJsZWQoKTtcbiAgfVxuXG4gIGlzVGFza0FjdGl2ZSgpIHtcbiAgICByZXR1cm4gdGhpcy50YXNrRGV0YWlscyAmJiB0aGlzLnRhc2tEZXRhaWxzLmR1cmF0aW9uID09PSBudWxsO1xuICB9XG5cbiAgaXNBc3NpZ25lZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISF0aGlzLnRhc2tEZXRhaWxzLmFzc2lnbmVlO1xuICB9XG5cbiAgcHJpdmF0ZSBoYXNFbWFpbEFkZHJlc3MoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLnRhc2tEZXRhaWxzLmFzc2lnbmVlLmVtYWlsID8gdHJ1ZSA6IGZhbHNlO1xuICB9XG5cbiAgaXNBc3NpZ25lZFRvTWUoKTogYm9vbGVhbiB7XG4gICAgICByZXR1cm4gdGhpcy5pc0Fzc2lnbmVkKCkgJiYgdGhpcy5oYXNFbWFpbEFkZHJlc3MoKSA/XG4gICAgICAgICAgdGhpcy5pc0VtYWlsRXF1YWwoKSA6XG4gICAgICAgICAgdGhpcy5pc0V4dGVybmFsSWRFcXVhbCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0VtYWlsRXF1YWwoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICh0aGlzLnRhc2tEZXRhaWxzLmFzc2lnbmVlICYmIHRoaXMuY3VycmVudExvZ2dlZFVzZXIpICYmICggdGhpcy50YXNrRGV0YWlscy5hc3NpZ25lZS5lbWFpbC50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSB0aGlzLmN1cnJlbnRMb2dnZWRVc2VyLmVtYWlsLnRvTG9jYWxlTG93ZXJDYXNlKCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0V4dGVybmFsSWRFcXVhbCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKHRoaXMudGFza0RldGFpbHMuYXNzaWduZWUgJiYgdGhpcy5jdXJyZW50TG9nZ2VkVXNlcikgJiYgKHRoaXMudGFza0RldGFpbHMuYXNzaWduZWUuZXh0ZXJuYWxJZCA9PT0gdGhpcy5jdXJyZW50TG9nZ2VkVXNlci5leHRlcm5hbElkKTtcbiAgfVxuXG4gIGlzQ29tcGxldGVCdXR0b25FbmFibGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmlzQXNzaWduZWRUb01lKCkgfHwgdGhpcy5jYW5Jbml0aWF0b3JDb21wbGV0ZSgpO1xuICB9XG5cbiAgY2FuSW5pdGlhdG9yQ29tcGxldGUoKTogYm9vbGVhbiB7XG4gICAgICByZXR1cm4gdGhpcy50YXNrRGV0YWlscy5pbml0aWF0b3JDYW5Db21wbGV0ZVRhc2s7XG4gIH1cblxuICBpc1JlYWRPbmx5Rm9ybSgpOiBib29sZWFuIHtcbiAgICBsZXQgcmVhZE9ubHlGb3JtOiBib29sZWFuO1xuICAgIGlmICh0aGlzLmlzQ2FuZGlkYXRlTWVtYmVyKCkpIHtcbiAgICAgIHJlYWRPbmx5Rm9ybSA9IHRoaXMuaW50ZXJuYWxSZWFkT25seUZvcm0gfHwgIXRoaXMuaXNBc3NpZ25lZFRvTWUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVhZE9ubHlGb3JtID0gdGhpcy5pbnRlcm5hbFJlYWRPbmx5Rm9ybSB8fCAhKHRoaXMuaXNBc3NpZ25lZFRvTWUoKSB8fCB0aGlzLmNhbkN1cnJlbnRVc2VyQXNJbml0aWF0b3JDb21wbGV0ZSgpIHx8IHRoaXMuaXNDdXJyZW50VXNlckludm9sdmVkKCkpO1xuICAgIH1cblxuICAgIHJldHVybiByZWFkT25seUZvcm07XG4gIH1cblxuICBpc0N1cnJlbnRVc2VySW52b2x2ZWQoKTogYm9vbGVhbiB7XG4gICAgbGV0IGlzSW52b2x2ZWQgPSBmYWxzZTtcbiAgICBpZiAodGhpcy50YXNrRGV0YWlscy5pbnZvbHZlZFBlb3BsZSAmJiB0aGlzLmN1cnJlbnRMb2dnZWRVc2VyKSB7XG4gICAgICBjb25zdCB1c2VySW52b2x2ZWQgPSB0aGlzLnRhc2tEZXRhaWxzLmludm9sdmVkUGVvcGxlLmZpbmQoXG4gICAgICAgIChpbnZvbHZlZFVzZXI6IExpZ2h0VXNlclJlcHJlc2VudGF0aW9uKSA9PlxuICAgICAgICAgIGludm9sdmVkVXNlci5lbWFpbC50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSB0aGlzLmN1cnJlbnRMb2dnZWRVc2VyLmVtYWlsLnRvTG9jYWxlTG93ZXJDYXNlKCkgfHxcbiAgICAgICAgICBpbnZvbHZlZFVzZXIuaWQgKyAnJyA9PT0gdGhpcy5jdXJyZW50TG9nZ2VkVXNlci5leHRlcm5hbElkXG4gICAgICAgICk7XG4gICAgICBpc0ludm9sdmVkID0gISF1c2VySW52b2x2ZWQ7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMudGFza0RldGFpbHMuaW52b2x2ZWRHcm91cHM/Lmxlbmd0aCAmJiB0aGlzLmN1cnJlbnRMb2dnZWRVc2VyLmdyb3Vwcz8ubGVuZ3RoICYmICFpc0ludm9sdmVkKSB7XG4gICAgICAgIGNvbnN0IHVzZXJHcm91cCA9IHRoaXMudGFza0RldGFpbHMuaW52b2x2ZWRHcm91cHMuZmluZChcbiAgICAgICAgICAgIChpbnZvbHZlZEdyb3VwOiBMaWdodEdyb3VwUmVwcmVzZW50YXRpb24pID0+XG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50TG9nZ2VkVXNlci5ncm91cHMuZmluZChcbiAgICAgICAgICAgICAgICAgICAgZ3JvdXAgPT4gZ3JvdXAubmFtZSA9PT0gaW52b2x2ZWRHcm91cC5uYW1lLnRvTG9jYWxlTG93ZXJDYXNlKCkgfHwgZ3JvdXAuaWQgPT09IGludm9sdmVkR3JvdXAuaWRcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICAgIGlzSW52b2x2ZWQgPSAhIXVzZXJHcm91cDtcbiAgICB9XG4gICAgcmV0dXJuIGlzSW52b2x2ZWQ7XG4gIH1cblxuICBjYW5DdXJyZW50VXNlckFzSW5pdGlhdG9yQ29tcGxldGUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuY2FuSW5pdGlhdG9yQ29tcGxldGUoKSAmJiB0aGlzLmlzUHJvY2Vzc0luaXRpYXRvcigpO1xuICB9XG5cbiAgaXNQcm9jZXNzSW5pdGlhdG9yKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRMb2dnZWRVc2VyICYmICggdGhpcy5jdXJyZW50TG9nZ2VkVXNlci5pZCA9PT0gK3RoaXMudGFza0RldGFpbHMucHJvY2Vzc0luc3RhbmNlU3RhcnRVc2VySWQpO1xuICB9XG5cbiAgaXNTYXZlQnV0dG9uVmlzaWJsZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5zaG93Rm9ybVNhdmVCdXR0b24gJiYgKCF0aGlzLmNhbkluaXRpYXRvckNvbXBsZXRlKCkgfHwgdGhpcy5pc0Fzc2lnbmVkVG9NZSgpIHx8IHRoaXMuaXNDdXJyZW50VXNlckludm9sdmVkKCkpO1xuICB9XG5cbiAgY2FuQ29tcGxldGVOb0Zvcm1UYXNrKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmlzUmVhZE9ubHlGb3JtKCk7XG4gIH1cblxuICBnZXRDb21wbGV0ZWRUYXNrVHJhbnNsYXRlZE1lc3NhZ2UoKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gdGhpcy50cmFuc2xhdGlvblNlcnZpY2UuZ2V0KCdBREZfVEFTS19GT1JNLkNPTVBMRVRFRF9UQVNLLlRJVExFJywgeyB0YXNrTmFtZTogdGhpcy50YXNrRGV0YWlscy5uYW1lIH0pO1xuICB9XG5cbiAgaXNDYW5kaWRhdGVNZW1iZXIoKTogYm9vbGVhbiB7XG4gICAgICByZXR1cm4gdGhpcy50YXNrRGV0YWlscy5tYW5hZ2VyT2ZDYW5kaWRhdGVHcm91cCB8fCB0aGlzLnRhc2tEZXRhaWxzLm1lbWJlck9mQ2FuZGlkYXRlR3JvdXAgfHwgdGhpcy50YXNrRGV0YWlscy5tZW1iZXJPZkNhbmRpZGF0ZVVzZXJzO1xuICB9XG5cbiAgaXNUYXNrQ2xhaW1hYmxlKCk6IGJvb2xlYW4ge1xuICAgICAgcmV0dXJuIHRoaXMuaXNDYW5kaWRhdGVNZW1iZXIoKSAmJiAhdGhpcy5pc0Fzc2lnbmVkKCk7XG4gIH1cblxuICBpc1Rhc2tDbGFpbWVkQnlDYW5kaWRhdGVNZW1iZXIoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaXNDYW5kaWRhdGVNZW1iZXIoKSAmJiB0aGlzLmlzQXNzaWduZWRUb01lKCkgJiYgIXRoaXMuaXNDb21wbGV0ZWRUYXNrKCk7XG4gIH1cblxuICByZWxvYWRUYXNrKCkge1xuICAgIHRoaXMubG9hZFRhc2sodGhpcy50YXNrSWQpO1xuICB9XG5cbiAgb25DbGFpbVRhc2sodGFza0lkOiBzdHJpbmcpIHtcbiAgICB0aGlzLnRhc2tDbGFpbWVkLmVtaXQodGFza0lkKTtcbiAgfVxuXG4gIG9uQ2xhaW1UYXNrRXJyb3IoZXJyb3I6IGFueSkge1xuICAgIHRoaXMuZXJyb3IuZW1pdChlcnJvcik7XG4gIH1cblxuICBvblVuY2xhaW1UYXNrKHRhc2tJZDogc3RyaW5nKSB7XG4gICAgdGhpcy50YXNrVW5jbGFpbWVkLmVtaXQodGFza0lkKTtcbiAgfVxuXG4gIG9uVW5jbGFpbVRhc2tFcnJvcihlcnJvcjogYW55KSB7XG4gICAgdGhpcy5lcnJvci5lbWl0KGVycm9yKTtcbiAgfVxufVxuIl19