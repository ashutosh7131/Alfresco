import { AlfrescoApiService, LogService } from '@alfresco/adf-core';
import { Injectable } from '@angular/core';
import { from, forkJoin, throwError, of } from 'rxjs';
import { map, catchError, switchMap, flatMap, filter } from 'rxjs/operators';
import { TaskQueryRequestRepresentationModel } from '../models/filter.model';
import { Form } from '../models/form.model';
import { TaskDetailsModel } from '../models/task-details.model';
import { TaskListModel } from '../models/task-list.model';
import { ModelsApi, TaskActionsApi, TasksApi, ChecklistsApi } from '@alfresco/js-api';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
export class TaskListService {
    constructor(apiService, logService) {
        this.apiService = apiService;
        this.logService = logService;
    }
    get modelsApi() {
        var _a;
        this._modelsApi = (_a = this._modelsApi) !== null && _a !== void 0 ? _a : new ModelsApi(this.apiService.getInstance());
        return this._modelsApi;
    }
    get tasksApi() {
        var _a;
        this._tasksApi = (_a = this._tasksApi) !== null && _a !== void 0 ? _a : new TasksApi(this.apiService.getInstance());
        return this._tasksApi;
    }
    get taskActionsApi() {
        var _a;
        this._taskActionsApi = (_a = this._taskActionsApi) !== null && _a !== void 0 ? _a : new TaskActionsApi(this.apiService.getInstance());
        return this._taskActionsApi;
    }
    get checklistsApi() {
        var _a;
        this._checklistsApi = (_a = this._checklistsApi) !== null && _a !== void 0 ? _a : new ChecklistsApi(this.apiService.getInstance());
        return this._checklistsApi;
    }
    getFilterForTaskById(taskId, filterList) {
        return from(filterList)
            .pipe(flatMap((data) => this.isTaskRelatedToFilter(taskId, data)), filter((data) => data != null));
    }
    generateTaskRequestNodeFromFilter(filterModel) {
        const requestNode = {
            appDefinitionId: filterModel.appId,
            assignment: filterModel.filter.assignment,
            state: filterModel.filter.state,
            sort: filterModel.filter.sort
        };
        return new TaskQueryRequestRepresentationModel(requestNode);
    }
    isTaskRelatedToFilter(taskId, filterModel) {
        const requestNodeForFilter = this.generateTaskRequestNodeFromFilter(filterModel);
        return from(this.callApiTasksFiltered(requestNodeForFilter))
            .pipe(map(res => {
            return res.data.find((element) => element.id === taskId) ? filterModel : null;
        }), catchError((err) => this.handleError(err)));
    }
    getTasks(requestNode) {
        return from(this.callApiTasksFiltered(requestNode))
            .pipe(catchError((err) => this.handleError(err)));
    }
    findTasksByState(requestNode, state) {
        if (state) {
            requestNode.state = state;
        }
        return this.getTasks(requestNode)
            .pipe(catchError(() => of(new TaskListModel())));
    }
    findAllTaskByState(requestNode, state) {
        if (state) {
            requestNode.state = state;
        }
        return this.getTotalTasks(requestNode)
            .pipe(switchMap((res) => {
            requestNode.size = res.total;
            return this.getTasks(requestNode);
        }));
    }
    findAllTasksWithoutState(requestNode) {
        return forkJoin(this.findTasksByState(requestNode, 'open'), this.findAllTaskByState(requestNode, 'completed'), (activeTasks, completedTasks) => {
            const tasks = Object.assign({}, activeTasks);
            tasks.total += completedTasks.total;
            tasks.data = tasks.data.concat(completedTasks.data);
            return tasks;
        });
    }
    getTaskDetails(taskId) {
        return from(this.callApiTaskDetails(taskId))
            .pipe(map(details => {
            return new TaskDetailsModel(details);
        }), catchError((err) => this.handleError(err)));
    }
    getTaskChecklist(id) {
        return from(this.callApiTaskChecklist(id))
            .pipe(map(response => {
            const checklists = [];
            response.data.forEach((checklist) => {
                checklists.push(new TaskDetailsModel(checklist));
            });
            return checklists;
        }), catchError((err) => this.handleError(err)));
    }
    getFormList() {
        const opts = {
            'filter': 'myReusableForms',
            'sort': 'modifiedDesc',
            'modelType': 2
        };
        return from(this.modelsApi.getModels(opts))
            .pipe(map(response => {
            const forms = [];
            response.data.forEach((form) => {
                forms.push(new Form(form.id, form.name));
            });
            return forms;
        }), catchError((err) => this.handleError(err)));
    }
    attachFormToATask(taskId, formId) {
        return from(this.taskActionsApi.attachForm(taskId, { 'formId': formId }))
            .pipe(catchError((err) => this.handleError(err)));
    }
    addTask(task) {
        return from(this.callApiAddTask(task))
            .pipe(map((response) => {
            return new TaskDetailsModel(response);
        }), catchError((err) => this.handleError(err)));
    }
    deleteTask(taskId) {
        return from(this.callApiDeleteTask(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    deleteForm(taskId) {
        return from(this.callApiDeleteForm(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    completeTask(taskId) {
        return from(this.taskActionsApi.completeTask(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getTotalTasks(requestNode) {
        requestNode.size = 0;
        return from(this.callApiTasksFiltered(requestNode))
            .pipe(catchError((err) => this.handleError(err)));
    }
    createNewTask(task) {
        return from(this.callApiCreateTask(task))
            .pipe(map((response) => {
            return new TaskDetailsModel(response);
        }), catchError((err) => this.handleError(err)));
    }
    assignTask(taskId, requestNode) {
        const assignee = { assignee: requestNode.id };
        return from(this.callApiAssignTask(taskId, assignee))
            .pipe(map((response) => {
            return new TaskDetailsModel(response);
        }), catchError((err) => this.handleError(err)));
    }
    assignTaskByUserId(taskId, userId) {
        const assignee = { assignee: userId };
        return from(this.callApiAssignTask(taskId, assignee))
            .pipe(map((response) => {
            return new TaskDetailsModel(response);
        }), catchError((err) => this.handleError(err)));
    }
    claimTask(taskId) {
        return from(this.taskActionsApi.claimTask(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    unclaimTask(taskId) {
        return from(this.taskActionsApi.unclaimTask(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    updateTask(taskId, updated) {
        return from(this.tasksApi.updateTask(taskId, updated))
            .pipe(map((result) => result), catchError((err) => this.handleError(err)));
    }
    fetchTaskAuditPdfById(taskId) {
        return from(this.tasksApi.getTaskAuditPdf(taskId))
            .pipe(map((data) => data), catchError((err) => this.handleError(err)));
    }
    fetchTaskAuditJsonById(taskId) {
        return from(this.tasksApi.getTaskAuditLog(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    callApiTasksFiltered(requestNode) {
        return this.tasksApi.listTasks(requestNode);
    }
    callApiTaskDetails(taskId) {
        return this.tasksApi.getTask(taskId);
    }
    callApiAddTask(task) {
        return this.checklistsApi.addSubtask(task.parentTaskId, task);
    }
    callApiDeleteTask(taskId) {
        return this.tasksApi.deleteTask(taskId);
    }
    callApiDeleteForm(taskId) {
        return this.taskActionsApi.removeForm(taskId);
    }
    callApiTaskChecklist(taskId) {
        return this.checklistsApi.getChecklist(taskId);
    }
    callApiCreateTask(task) {
        return this.tasksApi.createNewTask(task);
    }
    callApiAssignTask(taskId, requestNode) {
        return this.taskActionsApi.assignTask(taskId, requestNode);
    }
    handleError(error) {
        this.logService.error(error);
        return throwError(error || 'Server error');
    }
}
TaskListService.ɵfac = function TaskListService_Factory(t) { return new (t || TaskListService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc1.LogService)); };
TaskListService.ɵprov = i0.ɵɵdefineInjectable({ factory: function TaskListService_Factory() { return new TaskListService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i1.LogService)); }, token: TaskListService, providedIn: "root" });
TaskListService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: LogService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(TaskListService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc1.LogService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFza2xpc3Quc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL3Byb2Nlc3Mtc2VydmljZXMvc3JjL2xpYi90YXNrLWxpc3Qvc2VydmljZXMvdGFza2xpc3Quc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFpQkEsT0FBTyxFQUFFLGtCQUFrQixFQUFFLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFjLElBQUksRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdFLE9BQU8sRUFBNkIsbUNBQW1DLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN4RyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDNUMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDaEUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzFELE9BQU8sRUFFdUIsU0FBUyxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQzdELGFBQWEsRUFDaEIsTUFBTSxrQkFBa0IsQ0FBQztBQUMxQjtBQUVzQjs7O0FBRXRCLE1BQU0sT0FBTyxlQUFlO0FBQzVCLElBeUJJLFlBQW9CLFVBQThCLEVBQzlCLFVBQXNCO0FBQzlDLFFBRndCLGVBQVUsR0FBVixVQUFVLENBQW9CO0FBQUMsUUFDL0IsZUFBVSxHQUFWLFVBQVUsQ0FBWTtBQUFDLElBQzNDLENBQUM7QUFDTCxJQTFC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TUFBYyxFQUFFLFdBQTZDO0FBQUksUUFDdkYsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUM7QUFDbkUsSUFBSSxDQUFDO0FBQ0wsSUFDWSxXQUFXLENBQUMsS0FBVTtBQUNsQyxRQUFRLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3JDLFFBQVEsT0FBTyxVQUFVLENBQUMsS0FBSyxJQUFJLGNBQWMsQ0FBQyxDQUFDO0FBQ25ELElBQUksQ0FBQztBQUNMO2tMQUNBO0FBQUMsMk9BdmFJO0FBQUM7RUFITCxVQUFVLFNBQUMsckJBS0csWUFuQk4sa0JBQWtCO0tBZXZCLFVBQVUsRUFBRSxNQUFNLHZCQWZTLFlBQUYsVUFBVTtBQUFHO1NBZ0J6Qzs7Ozs7Z0hBaEIyQztBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlLCBMb2dTZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20sIGZvcmtKb2luLCB0aHJvd0Vycm9yLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBjYXRjaEVycm9yLCBzd2l0Y2hNYXAsIGZsYXRNYXAsIGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwsIFRhc2tRdWVyeVJlcXVlc3RSZXByZXNlbnRhdGlvbk1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL2ZpbHRlci5tb2RlbCc7XG5pbXBvcnQgeyBGb3JtIH0gZnJvbSAnLi4vbW9kZWxzL2Zvcm0ubW9kZWwnO1xuaW1wb3J0IHsgVGFza0RldGFpbHNNb2RlbCB9IGZyb20gJy4uL21vZGVscy90YXNrLWRldGFpbHMubW9kZWwnO1xuaW1wb3J0IHsgVGFza0xpc3RNb2RlbCB9IGZyb20gJy4uL21vZGVscy90YXNrLWxpc3QubW9kZWwnO1xuaW1wb3J0IHtcbiAgICBUYXNrUXVlcnlSZXByZXNlbnRhdGlvbiwgQXNzaWduZWVJZGVudGlmaWVyUmVwcmVzZW50YXRpb24sXG4gICAgVGFza1VwZGF0ZVJlcHJlc2VudGF0aW9uLCBNb2RlbHNBcGksIFRhc2tBY3Rpb25zQXBpLCBUYXNrc0FwaSxcbiAgICBDaGVja2xpc3RzQXBpXG59IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFRhc2tMaXN0U2VydmljZSB7XG5cbiAgICBwcml2YXRlIF9tb2RlbHNBcGk7XG4gICAgZ2V0IG1vZGVsc0FwaSgpOiBNb2RlbHNBcGkge1xuICAgICAgICB0aGlzLl9tb2RlbHNBcGkgPSB0aGlzLl9tb2RlbHNBcGkgPz8gbmV3IE1vZGVsc0FwaSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl9tb2RlbHNBcGk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfdGFza3NBcGk7XG4gICAgZ2V0IHRhc2tzQXBpKCk6IFRhc2tzQXBpIHtcbiAgICAgICAgdGhpcy5fdGFza3NBcGkgPSB0aGlzLl90YXNrc0FwaSA/PyBuZXcgVGFza3NBcGkodGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy5fdGFza3NBcGk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfdGFza0FjdGlvbnNBcGk7XG4gICAgZ2V0IHRhc2tBY3Rpb25zQXBpKCk6IFRhc2tBY3Rpb25zQXBpIHtcbiAgICAgICAgdGhpcy5fdGFza0FjdGlvbnNBcGkgPSB0aGlzLl90YXNrQWN0aW9uc0FwaSA/PyBuZXcgVGFza0FjdGlvbnNBcGkodGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy5fdGFza0FjdGlvbnNBcGk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY2hlY2tsaXN0c0FwaTtcbiAgICBnZXQgY2hlY2tsaXN0c0FwaSgpOiBDaGVja2xpc3RzQXBpIHtcbiAgICAgICAgdGhpcy5fY2hlY2tsaXN0c0FwaSA9IHRoaXMuX2NoZWNrbGlzdHNBcGkgPz8gbmV3IENoZWNrbGlzdHNBcGkodGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy5fY2hlY2tsaXN0c0FwaTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2UpIHtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGFsbCB0aGUgZmlsdGVycyBpbiB0aGUgbGlzdCB0aGF0IGJlbG9uZyB0byBhIHRhc2suXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFyZ2V0IHRhc2tcbiAgICAgKiBAcGFyYW0gZmlsdGVyTGlzdCBMaXN0IG9mIGZpbHRlcnMgdG8gc2VhcmNoIHRocm91Z2hcbiAgICAgKiBAcmV0dXJucyBGaWx0ZXJzIGJlbG9uZ2luZyB0byB0aGUgdGFza1xuICAgICAqL1xuICAgIGdldEZpbHRlckZvclRhc2tCeUlkKHRhc2tJZDogc3RyaW5nLCBmaWx0ZXJMaXN0OiBGaWx0ZXJSZXByZXNlbnRhdGlvbk1vZGVsW10pOiBPYnNlcnZhYmxlPEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZyb20oZmlsdGVyTGlzdClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGZsYXRNYXAoKGRhdGE6IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwpID0+IHRoaXMuaXNUYXNrUmVsYXRlZFRvRmlsdGVyKHRhc2tJZCwgZGF0YSkpLFxuICAgICAgICAgICAgICAgIGZpbHRlcigoZGF0YTogRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbCkgPT4gZGF0YSAhPSBudWxsKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBzZWFyY2ggcXVlcnkgZm9yIGEgdGFzayBiYXNlZCBvbiB0aGUgc3VwcGxpZWQgZmlsdGVyLlxuICAgICAqIEBwYXJhbSBmaWx0ZXIgVGhlIGZpbHRlciB0byB1c2VcbiAgICAgKiBAcmV0dXJucyBUaGUgc2VhcmNoIHF1ZXJ5XG4gICAgICovXG4gICAgcHJpdmF0ZSBnZW5lcmF0ZVRhc2tSZXF1ZXN0Tm9kZUZyb21GaWx0ZXIoZmlsdGVyTW9kZWw6IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwpOiBUYXNrUXVlcnlSZXF1ZXN0UmVwcmVzZW50YXRpb25Nb2RlbCB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3ROb2RlID0ge1xuICAgICAgICAgICAgYXBwRGVmaW5pdGlvbklkOiBmaWx0ZXJNb2RlbC5hcHBJZCxcbiAgICAgICAgICAgIGFzc2lnbm1lbnQ6IGZpbHRlck1vZGVsLmZpbHRlci5hc3NpZ25tZW50LFxuICAgICAgICAgICAgc3RhdGU6IGZpbHRlck1vZGVsLmZpbHRlci5zdGF0ZSxcbiAgICAgICAgICAgIHNvcnQ6IGZpbHRlck1vZGVsLmZpbHRlci5zb3J0XG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBuZXcgVGFza1F1ZXJ5UmVxdWVzdFJlcHJlc2VudGF0aW9uTW9kZWwocmVxdWVzdE5vZGUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBpZiBhIHRhc2tJZCBpcyBmaWx0ZXJlZCB3aXRoIHRoZSBnaXZlbiBmaWx0ZXIuXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFyZ2V0IHRhc2tcbiAgICAgKiBAcGFyYW0gZmlsdGVyTW9kZWwgVGhlIGZpbHRlciB5b3Ugd2FudCB0byBjaGVja1xuICAgICAqIEByZXR1cm5zIFRoZSBmaWx0ZXIgaWYgaXQgaXMgcmVsYXRlZCBvciBudWxsIG90aGVyd2lzZVxuICAgICAqL1xuICAgIGlzVGFza1JlbGF0ZWRUb0ZpbHRlcih0YXNrSWQ6IHN0cmluZywgZmlsdGVyTW9kZWw6IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwpOiBPYnNlcnZhYmxlPEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWw+IHtcbiAgICAgICAgY29uc3QgcmVxdWVzdE5vZGVGb3JGaWx0ZXIgPSB0aGlzLmdlbmVyYXRlVGFza1JlcXVlc3ROb2RlRnJvbUZpbHRlcihmaWx0ZXJNb2RlbCk7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaVRhc2tzRmlsdGVyZWQocmVxdWVzdE5vZGVGb3JGaWx0ZXIpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXMuZGF0YS5maW5kKChlbGVtZW50KSA9PiBlbGVtZW50LmlkID09PSB0YXNrSWQpID8gZmlsdGVyTW9kZWwgOiBudWxsO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGFsbCB0aGUgdGFza3MgbWF0Y2hpbmcgdGhlIHN1cHBsaWVkIHF1ZXJ5LlxuICAgICAqIEBwYXJhbSByZXF1ZXN0Tm9kZSBRdWVyeSB0byBzZWFyY2ggZm9yIHRhc2tzXG4gICAgICogQHJldHVybnMgTGlzdCBvZiB0YXNrc1xuICAgICAqL1xuICAgIGdldFRhc2tzKHJlcXVlc3ROb2RlOiBUYXNrUXVlcnlSZXF1ZXN0UmVwcmVzZW50YXRpb25Nb2RlbCk6IE9ic2VydmFibGU8VGFza0xpc3RNb2RlbD4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmNhbGxBcGlUYXNrc0ZpbHRlcmVkKHJlcXVlc3ROb2RlKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRhc2tzIG1hdGNoaW5nIGEgcXVlcnkgYW5kIHN0YXRlIHZhbHVlLlxuICAgICAqIEBwYXJhbSByZXF1ZXN0Tm9kZSBRdWVyeSB0byBzZWFyY2ggZm9yIHRhc2tzXG4gICAgICogQHBhcmFtIHN0YXRlIFRhc2sgc3RhdGUuIENhbiBiZSBcIm9wZW5cIiBvciBcImNvbXBsZXRlZFwiLlxuICAgICAqIEByZXR1cm5zIExpc3Qgb2YgdGFza3NcbiAgICAgKi9cbiAgICBmaW5kVGFza3NCeVN0YXRlKHJlcXVlc3ROb2RlOiBUYXNrUXVlcnlSZXF1ZXN0UmVwcmVzZW50YXRpb25Nb2RlbCwgc3RhdGU/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tMaXN0TW9kZWw+IHtcbiAgICAgICAgaWYgKHN0YXRlKSB7XG4gICAgICAgICAgICByZXF1ZXN0Tm9kZS5zdGF0ZSA9IHN0YXRlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmdldFRhc2tzKHJlcXVlc3ROb2RlKVxuICAgICAgICAgICAgLnBpcGUoY2F0Y2hFcnJvcigoKSA9PiBvZihuZXcgVGFza0xpc3RNb2RlbCgpKSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYWxsIHRhc2tzIG1hdGNoaW5nIGEgcXVlcnkgYW5kIHN0YXRlIHZhbHVlLlxuICAgICAqIEBwYXJhbSByZXF1ZXN0Tm9kZSBRdWVyeSB0byBzZWFyY2ggZm9yIHRhc2tzLlxuICAgICAqIEBwYXJhbSBzdGF0ZSBUYXNrIHN0YXRlLiBDYW4gYmUgXCJvcGVuXCIgb3IgXCJjb21wbGV0ZWRcIi5cbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIHRhc2tzXG4gICAgICovXG4gICAgZmluZEFsbFRhc2tCeVN0YXRlKHJlcXVlc3ROb2RlOiBUYXNrUXVlcnlSZXF1ZXN0UmVwcmVzZW50YXRpb25Nb2RlbCwgc3RhdGU/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tMaXN0TW9kZWw+IHtcbiAgICAgICAgaWYgKHN0YXRlKSB7XG4gICAgICAgICAgICByZXF1ZXN0Tm9kZS5zdGF0ZSA9IHN0YXRlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmdldFRvdGFsVGFza3MocmVxdWVzdE5vZGUpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKHJlczogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3ROb2RlLnNpemUgPSByZXMudG90YWw7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFRhc2tzKHJlcXVlc3ROb2RlKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGFsbCB0YXNrcyBtYXRjaGluZyB0aGUgc3VwcGxpZWQgcXVlcnkgYnV0IGlnbm9yaW5nIHRoZSB0YXNrIHN0YXRlLlxuICAgICAqIEBwYXJhbSByZXF1ZXN0Tm9kZSBRdWVyeSB0byBzZWFyY2ggZm9yIHRhc2tzXG4gICAgICogQHJldHVybnMgTGlzdCBvZiB0YXNrc1xuICAgICAqL1xuICAgIGZpbmRBbGxUYXNrc1dpdGhvdXRTdGF0ZShyZXF1ZXN0Tm9kZTogVGFza1F1ZXJ5UmVxdWVzdFJlcHJlc2VudGF0aW9uTW9kZWwpOiBPYnNlcnZhYmxlPFRhc2tMaXN0TW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZvcmtKb2luKFxuICAgICAgICAgICAgdGhpcy5maW5kVGFza3NCeVN0YXRlKHJlcXVlc3ROb2RlLCAnb3BlbicpLFxuICAgICAgICAgICAgdGhpcy5maW5kQWxsVGFza0J5U3RhdGUocmVxdWVzdE5vZGUsICdjb21wbGV0ZWQnKSxcbiAgICAgICAgICAgIChhY3RpdmVUYXNrczogVGFza0xpc3RNb2RlbCwgY29tcGxldGVkVGFza3M6IFRhc2tMaXN0TW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB0YXNrcyA9IE9iamVjdC5hc3NpZ24oe30sIGFjdGl2ZVRhc2tzKTtcbiAgICAgICAgICAgICAgICB0YXNrcy50b3RhbCArPSBjb21wbGV0ZWRUYXNrcy50b3RhbDtcbiAgICAgICAgICAgICAgICB0YXNrcy5kYXRhID0gdGFza3MuZGF0YS5jb25jYXQoY29tcGxldGVkVGFza3MuZGF0YSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRhc2tzO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgZGV0YWlscyBmb3IgYSB0YXNrLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrLlxuICAgICAqIEByZXR1cm5zIFRhc2sgZGV0YWlsc1xuICAgICAqL1xuICAgIGdldFRhc2tEZXRhaWxzKHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc01vZGVsPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaVRhc2tEZXRhaWxzKHRhc2tJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoZGV0YWlscyA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGFza0RldGFpbHNNb2RlbChkZXRhaWxzKTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgY2hlY2tsaXN0IGZvciBhIHRhc2suXG4gICAgICogQHBhcmFtIGlkIElEIG9mIHRoZSB0YXJnZXQgdGFza1xuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIGNoZWNrbGlzdCB0YXNrIGRldGFpbHNcbiAgICAgKi9cbiAgICBnZXRUYXNrQ2hlY2tsaXN0KGlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzTW9kZWxbXT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmNhbGxBcGlUYXNrQ2hlY2tsaXN0KGlkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcChyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoZWNrbGlzdHM6IFRhc2tEZXRhaWxzTW9kZWxbXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmZvckVhY2goKGNoZWNrbGlzdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tsaXN0cy5wdXNoKG5ldyBUYXNrRGV0YWlsc01vZGVsKGNoZWNrbGlzdCkpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoZWNrbGlzdHM7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYWxsIGF2YWlsYWJsZSByZXVzYWJsZSBmb3Jtcy5cbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBmb3JtIGRldGFpbHNcbiAgICAgKi9cbiAgICBnZXRGb3JtTGlzdCgpOiBPYnNlcnZhYmxlPEZvcm1bXT4ge1xuICAgICAgICBjb25zdCBvcHRzID0ge1xuICAgICAgICAgICAgJ2ZpbHRlcic6ICdteVJldXNhYmxlRm9ybXMnLCAvLyBTdHJpbmcgfCBmaWx0ZXJcbiAgICAgICAgICAgICdzb3J0JzogJ21vZGlmaWVkRGVzYycsIC8vIFN0cmluZyB8IHNvcnRcbiAgICAgICAgICAgICdtb2RlbFR5cGUnOiAyIC8vIEludGVnZXIgfCBtb2RlbFR5cGVcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLm1vZGVsc0FwaS5nZXRNb2RlbHMob3B0cykpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3JtczogRm9ybVtdID0gW107XG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZm9yRWFjaCgoZm9ybSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9ybXMucHVzaChuZXcgRm9ybShmb3JtLmlkLCBmb3JtLm5hbWUpKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmb3JtcztcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXR0YWNoZXMgYSBmb3JtIHRvIGEgdGFzay5cbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXJnZXQgdGFza1xuICAgICAqIEBwYXJhbSBmb3JtSWQgSUQgb2YgdGhlIGZvcm0gdG8gYWRkXG4gICAgICogQHJldHVybnMgTnVsbCByZXNwb25zZSBub3RpZnlpbmcgd2hlbiB0aGUgb3BlcmF0aW9uIGlzIGNvbXBsZXRlXG4gICAgICovXG4gICAgYXR0YWNoRm9ybVRvQVRhc2sodGFza0lkOiBzdHJpbmcsIGZvcm1JZDogbnVtYmVyKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy50YXNrQWN0aW9uc0FwaS5hdHRhY2hGb3JtKHRhc2tJZCwgeyAnZm9ybUlkJzogZm9ybUlkIH0pKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBzdWJ0YXNrIChpZSwgYSBjaGVja2xpc3QgdGFzaykgdG8gYSBwYXJlbnQgdGFzay5cbiAgICAgKiBAcGFyYW0gdGFzayBUaGUgdGFzayB0byBhZGRcbiAgICAgKiBAcmV0dXJucyBUaGUgc3VidGFzayB0aGF0IHdhcyBhZGRlZFxuICAgICAqL1xuICAgIGFkZFRhc2sodGFzazogVGFza0RldGFpbHNNb2RlbCk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmNhbGxBcGlBZGRUYXNrKHRhc2spKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXNwb25zZTogVGFza0RldGFpbHNNb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRhc2tEZXRhaWxzTW9kZWwocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZWxldGVzIGEgc3VidGFzayAoaWUsIGEgY2hlY2tsaXN0IHRhc2spIGZyb20gYSBwYXJlbnQgdGFzay5cbiAgICAgKiBAcGFyYW0gdGFza0lkIFRoZSB0YXNrIHRvIGRlbGV0ZVxuICAgICAqIEByZXR1cm5zIE51bGwgcmVzcG9uc2Ugbm90aWZ5aW5nIHdoZW4gdGhlIG9wZXJhdGlvbiBpcyBjb21wbGV0ZVxuICAgICAqL1xuICAgIGRlbGV0ZVRhc2sodGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzTW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5jYWxsQXBpRGVsZXRlVGFzayh0YXNrSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlbGV0ZXMgYSBmb3JtIGZyb20gYSB0YXNrLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgVGFzayBpZCByZWxhdGVkIHRvIGZvcm1cbiAgICAgKiBAcmV0dXJucyBOdWxsIHJlc3BvbnNlIG5vdGlmeWluZyB3aGVuIHRoZSBvcGVyYXRpb24gaXMgY29tcGxldGVcbiAgICAgKi9cbiAgICBkZWxldGVGb3JtKHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc01vZGVsPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaURlbGV0ZUZvcm0odGFza0lkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHaXZlcyBjb21wbGV0ZWQgc3RhdHVzIHRvIGEgdGFzay5cbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXJnZXQgdGFza1xuICAgICAqIEByZXR1cm5zIE51bGwgcmVzcG9uc2Ugbm90aWZ5aW5nIHdoZW4gdGhlIG9wZXJhdGlvbiBpcyBjb21wbGV0ZVxuICAgICAqL1xuICAgIGNvbXBsZXRlVGFzayh0YXNrSWQ6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnRhc2tBY3Rpb25zQXBpLmNvbXBsZXRlVGFzayh0YXNrSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHRvdGFsIG51bWJlciBvZiB0aGUgdGFza3MgZm91bmQgYnkgYSBxdWVyeS5cbiAgICAgKiBAcGFyYW0gcmVxdWVzdE5vZGUgUXVlcnkgdG8gc2VhcmNoIGZvciB0YXNrc1xuICAgICAqIEByZXR1cm5zIE51bWJlciBvZiB0YXNrc1xuICAgICAqL1xuICAgIHB1YmxpYyBnZXRUb3RhbFRhc2tzKHJlcXVlc3ROb2RlOiBUYXNrUXVlcnlSZXF1ZXN0UmVwcmVzZW50YXRpb25Nb2RlbCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJlcXVlc3ROb2RlLnNpemUgPSAwO1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmNhbGxBcGlUYXNrc0ZpbHRlcmVkKHJlcXVlc3ROb2RlKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGEgbmV3IHN0YW5kYWxvbmUgdGFzay5cbiAgICAgKiBAcGFyYW0gdGFzayBEZXRhaWxzIG9mIHRoZSBuZXcgdGFza1xuICAgICAqIEByZXR1cm5zIERldGFpbHMgb2YgdGhlIG5ld2x5IGNyZWF0ZWQgdGFza1xuICAgICAqL1xuICAgIGNyZWF0ZU5ld1Rhc2sodGFzazogVGFza0RldGFpbHNNb2RlbCk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmNhbGxBcGlDcmVhdGVUYXNrKHRhc2spKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXNwb25zZTogVGFza0RldGFpbHNNb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRhc2tEZXRhaWxzTW9kZWwocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBc3NpZ25zIGEgdGFzayB0byBhIHVzZXIgb3IgZ3JvdXAuXG4gICAgICogQHBhcmFtIHRhc2tJZCBUaGUgdGFzayB0byBhc3NpZ25cbiAgICAgKiBAcGFyYW0gcmVxdWVzdE5vZGUgVXNlciBvciBncm91cCB0byBhc3NpZ24gdGhlIHRhc2sgdG9cbiAgICAgKiBAcmV0dXJucyBEZXRhaWxzIG9mIHRoZSBhc3NpZ25lZCB0YXNrXG4gICAgICovXG4gICAgYXNzaWduVGFzayh0YXNrSWQ6IHN0cmluZywgcmVxdWVzdE5vZGU6IGFueSk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICBjb25zdCBhc3NpZ25lZSA9IHsgYXNzaWduZWU6IHJlcXVlc3ROb2RlLmlkIH07XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaUFzc2lnblRhc2sodGFza0lkLCBhc3NpZ25lZSkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlc3BvbnNlOiBUYXNrRGV0YWlsc01vZGVsKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGFza0RldGFpbHNNb2RlbChyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFzc2lnbnMgYSB0YXNrIHRvIGEgdXNlci5cbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXNrIHRvIGFzc2lnblxuICAgICAqIEBwYXJhbSB1c2VySWQgSUQgb2YgdGhlIHVzZXIgdG8gYXNzaWduIHRoZSB0YXNrIHRvXG4gICAgICogQHJldHVybnMgRGV0YWlscyBvZiB0aGUgYXNzaWduZWQgdGFza1xuICAgICAqL1xuICAgIGFzc2lnblRhc2tCeVVzZXJJZCh0YXNrSWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzTW9kZWw+IHtcbiAgICAgICAgY29uc3QgYXNzaWduZWUgPSA8QXNzaWduZWVJZGVudGlmaWVyUmVwcmVzZW50YXRpb24+IHsgYXNzaWduZWU6IHVzZXJJZCB9O1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmNhbGxBcGlBc3NpZ25UYXNrKHRhc2tJZCwgYXNzaWduZWUpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXNwb25zZTogVGFza0RldGFpbHNNb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRhc2tEZXRhaWxzTW9kZWwocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbGFpbXMgYSB0YXNrIGZvciB0aGUgY3VycmVudCB1c2VyLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhc2sgdG8gY2xhaW1cbiAgICAgKiBAcmV0dXJucyBEZXRhaWxzIG9mIHRoZSBjbGFpbWVkIHRhc2tcbiAgICAgKi9cbiAgICBjbGFpbVRhc2sodGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzTW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy50YXNrQWN0aW9uc0FwaS5jbGFpbVRhc2sodGFza0lkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVbi1jbGFpbXMgYSB0YXNrIGZvciB0aGUgY3VycmVudCB1c2VyLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhc2sgdG8gdW5jbGFpbVxuICAgICAqIEByZXR1cm5zIE51bGwgcmVzcG9uc2Ugbm90aWZ5aW5nIHdoZW4gdGhlIG9wZXJhdGlvbiBpcyBjb21wbGV0ZVxuICAgICAqL1xuICAgIHVuY2xhaW1UYXNrKHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc01vZGVsPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMudGFza0FjdGlvbnNBcGkudW5jbGFpbVRhc2sodGFza0lkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBkZXRhaWxzIChuYW1lLCBkZXNjcmlwdGlvbiwgZHVlIGRhdGUpIGZvciBhIHRhc2suXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFzayB0byB1cGRhdGVcbiAgICAgKiBAcGFyYW0gdXBkYXRlZCBEYXRhIHRvIHVwZGF0ZSB0aGUgdGFzayAoYXMgYSBgVGFza1VwZGF0ZVJlcHJlc2VudGF0aW9uYCBpbnN0YW5jZSkuXG4gICAgICogQHJldHVybnMgVXBkYXRlZCB0YXNrIGRldGFpbHNcbiAgICAgKi9cbiAgICB1cGRhdGVUYXNrKHRhc2tJZDogc3RyaW5nLCB1cGRhdGVkOiBUYXNrVXBkYXRlUmVwcmVzZW50YXRpb24pOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzTW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy50YXNrc0FwaS51cGRhdGVUYXNrKHRhc2tJZCwgdXBkYXRlZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlc3VsdCkgPT4gPFRhc2tEZXRhaWxzTW9kZWw+IHJlc3VsdCksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZldGNoZXMgdGhlIFRhc2sgQXVkaXQgaW5mb3JtYXRpb24gaW4gUERGIGZvcm1hdC5cbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXJnZXQgdGFza1xuICAgICAqIEByZXR1cm5zIEJpbmFyeSBQREYgZGF0YVxuICAgICAqL1xuICAgIGZldGNoVGFza0F1ZGl0UGRmQnlJZCh0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8QmxvYj4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnRhc2tzQXBpLmdldFRhc2tBdWRpdFBkZih0YXNrSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChkYXRhKSA9PiA8QmxvYj4gZGF0YSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZldGNoIHRoZSBUYXNrIEF1ZGl0IGluZm9ybWF0aW9uIGluIEpTT04gZm9ybWF0XG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFyZ2V0IHRhc2tcbiAgICAgKiBAcmV0dXJucyBKU09OIGRhdGFcbiAgICAgKi9cbiAgICBmZXRjaFRhc2tBdWRpdEpzb25CeUlkKHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy50YXNrc0FwaS5nZXRUYXNrQXVkaXRMb2codGFza0lkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbGxBcGlUYXNrc0ZpbHRlcmVkKHJlcXVlc3ROb2RlOiBUYXNrUXVlcnlSZXByZXNlbnRhdGlvbik6IFByb21pc2U8VGFza0xpc3RNb2RlbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy50YXNrc0FwaS5saXN0VGFza3MocmVxdWVzdE5vZGUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsbEFwaVRhc2tEZXRhaWxzKHRhc2tJZDogc3RyaW5nKTogUHJvbWlzZTxUYXNrRGV0YWlsc01vZGVsPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnRhc2tzQXBpLmdldFRhc2sodGFza0lkKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbGxBcGlBZGRUYXNrKHRhc2s6IFRhc2tEZXRhaWxzTW9kZWwpOiBQcm9taXNlPFRhc2tEZXRhaWxzTW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2tsaXN0c0FwaS5hZGRTdWJ0YXNrKHRhc2sucGFyZW50VGFza0lkLCB0YXNrKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbGxBcGlEZWxldGVUYXNrKHRhc2tJZDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGFza3NBcGkuZGVsZXRlVGFzayh0YXNrSWQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsbEFwaURlbGV0ZUZvcm0odGFza0lkOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gdGhpcy50YXNrQWN0aW9uc0FwaS5yZW1vdmVGb3JtKHRhc2tJZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxsQXBpVGFza0NoZWNrbGlzdCh0YXNrSWQ6IHN0cmluZyk6IFByb21pc2U8VGFza0xpc3RNb2RlbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jaGVja2xpc3RzQXBpLmdldENoZWNrbGlzdCh0YXNrSWQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsbEFwaUNyZWF0ZVRhc2sodGFzazogVGFza0RldGFpbHNNb2RlbCk6IFByb21pc2U8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy50YXNrc0FwaS5jcmVhdGVOZXdUYXNrKHRhc2spO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsbEFwaUFzc2lnblRhc2sodGFza0lkOiBzdHJpbmcsIHJlcXVlc3ROb2RlOiBBc3NpZ25lZUlkZW50aWZpZXJSZXByZXNlbnRhdGlvbik6IFByb21pc2U8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy50YXNrQWN0aW9uc0FwaS5hc3NpZ25UYXNrKHRhc2tJZCwgcmVxdWVzdE5vZGUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlRXJyb3IoZXJyb3I6IGFueSkge1xuICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoZXJyb3IpO1xuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvciB8fCAnU2VydmVyIGVycm9yJyk7XG4gICAgfVxuXG59XG4iXX0=