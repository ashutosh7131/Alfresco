/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { AppsProcessService } from '@alfresco/adf-core';
import { Component, EventEmitter, Input, Output, ViewEncapsulation } from '@angular/core';
import { FilterParamsModel } from '../models/filter.model';
import { TaskFilterService } from './../services/task-filter.service';
import { TaskListService } from './../services/tasklist.service';
import { IconModel } from '../../app-list/icon.model';
export class TaskFiltersComponent {
    constructor(taskFilterService, taskListService, appsProcessService) {
        this.taskFilterService = taskFilterService;
        this.taskListService = taskListService;
        this.appsProcessService = appsProcessService;
        this.filterClicked = new EventEmitter();
        this.filterSelected = new EventEmitter();
        this.success = new EventEmitter();
        this.error = new EventEmitter();
        this.filters = [];
    }
    ngOnInit() {
        this.iconsMDL = new IconModel();
    }
    ngOnChanges(changes) {
        const appName = changes['appName'];
        const appId = changes['appId'];
        const filter = changes['filterParam'];
        if (appName && appName.currentValue) {
            this.getFiltersByAppName(appName.currentValue);
        }
        else if (appId && appId.currentValue !== appId.previousValue) {
            this.getFiltersByAppId(appId.currentValue);
        }
        else if (filter && filter.currentValue !== filter.previousValue) {
            this.selectFilterAndEmit(filter.currentValue);
        }
    }
    getFilters(appId, appName) {
        appName ? this.getFiltersByAppName(appName) : this.getFiltersByAppId(appId);
    }
    getFiltersByAppId(appId) {
        this.taskFilterService.getTaskListFilters(appId).subscribe((res) => {
            if (res.length === 0 && this.isFilterListEmpty()) {
                this.createFiltersByAppId(appId);
            }
            else {
                this.resetFilter();
                this.filters = res;
                this.selectFilter(this.filterParam);
                this.success.emit(res);
            }
        }, (err) => {
            this.error.emit(err);
        });
    }
    getFiltersByAppName(appName) {
        this.appsProcessService.getDeployedApplicationsByName(appName).subscribe((application) => {
            this.getFiltersByAppId(application.id);
        }, (err) => {
            this.error.emit(err);
        });
    }
    createFiltersByAppId(appId) {
        this.taskFilterService.createDefaultFilters(appId).subscribe((resDefault) => {
            this.resetFilter();
            this.filters = resDefault;
            this.selectFilter(this.filterParam);
            this.success.emit(resDefault);
        }, (errDefault) => {
            this.error.emit(errDefault);
        });
    }
    selectFilter(newFilter) {
        if (newFilter) {
            this.currentFilter = this.filters.find((filter, index) => newFilter.index === index ||
                newFilter.id === filter.id ||
                (newFilter.name &&
                    (newFilter.name.toLocaleLowerCase() === filter.name.toLocaleLowerCase())));
        }
    }
    selectFilterAndEmit(newFilter) {
        this.selectFilter(newFilter);
        this.filterSelected.emit(this.currentFilter);
    }
    onFilterClick(filter) {
        this.selectFilter(filter);
        this.filterClicked.emit(this.currentFilter);
    }
    selectFilterWithTask(taskId) {
        const filteredFilterList = [];
        this.taskListService.getFilterForTaskById(taskId, this.filters).subscribe((filter) => {
            filteredFilterList.push(filter);
        }, (err) => {
            this.error.emit(err);
        }, () => {
            if (filteredFilterList.length > 0) {
                this.selectFilter(filteredFilterList[0]);
                this.filterSelected.emit(this.currentFilter);
            }
        });
    }
    selectDefaultTaskFilter() {
        if (!this.isFilterListEmpty()) {
            this.currentFilter = this.filters[0];
        }
    }
    getCurrentFilter() {
        return this.currentFilter;
    }
    isFilterListEmpty() {
        return this.filters === undefined || (this.filters && this.filters.length === 0);
    }
    resetFilter() {
        this.filters = [];
        this.currentFilter = undefined;
    }
    getFilterIcon(icon) {
        return this.iconsMDL.mapGlyphiconToMaterialDesignIcons(icon);
    }
}
TaskFiltersComponent.decorators = [
    { type: Component, args: [{
                selector: 'adf-task-filters',
                template: "<div *ngFor=\"let filter of filters\" class=\"adf-filters__entry\" [class.adf-active]=\"currentFilter === filter\">\n    <button (click)=\"onFilterClick(filter)\"\n      [attr.aria-label]=\"filter.name | translate\"\n      [id]=\"filter.id\"\n      [attr.data-automation-id]=\"filter.name + '_filter'\"\n      mat-button\n      class=\"adf-filter-action-button adf-full-width\" fxLayout=\"row\" fxLayoutAlign=\"space-between center\">\n      <ng-container *ngIf=\"showIcon\">\n        <adf-icon data-automation-id=\"adf-filter-icon\" [value]=\"getFilterIcon(filter.icon)\"></adf-icon>\n      </ng-container>\n      <span data-automation-id=\"adf-filter-label\" class=\"adf-filter-action-button__label\">{{ filter.name | translate }}</span>\n    </button>\n</div>\n",
                encapsulation: ViewEncapsulation.None,
                styles: [".adf-filters__entry{cursor:pointer;font-size:14px!important;font-weight:700;height:24px;opacity:.54;padding:12px 0!important;width:100%}.adf-filters__entry .adf-full-width{display:flex;width:100%}.adf-filters__entry .adf-filter-action-button .adf-filter-action-button__label{margin:0 8px!important;padding-left:20px}.adf-filters__entry.adf-active,.adf-filters__entry:hover{color:var(--theme-primary-color);opacity:1}"]
            },] }
];
TaskFiltersComponent.ctorParameters = () => [
    { type: TaskFilterService },
    { type: TaskListService },
    { type: AppsProcessService }
];
TaskFiltersComponent.propDecorators = {
    filterParam: [{ type: Input }],
    filterClicked: [{ type: Output }],
    filterSelected: [{ type: Output }],
    success: [{ type: Output }],
    error: [{ type: Output }],
    appId: [{ type: Input }],
    appName: [{ type: Input }],
    showIcon: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFzay1maWx0ZXJzLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL3Byb2Nlc3Mtc2VydmljZXMvc3JjLyIsInNvdXJjZXMiOlsibGliL3Rhc2stbGlzdC9jb21wb25lbnRzL3Rhc2stZmlsdGVycy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7OztHQWVHO0FBRUgsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDeEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFxQixNQUFNLEVBQWlCLGlCQUFpQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTVILE9BQU8sRUFBRSxpQkFBaUIsRUFBNkIsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN0RSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDakUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBUXRELE1BQU0sT0FBTyxvQkFBb0I7SUE0QzdCLFlBQW9CLGlCQUFvQyxFQUNwQyxlQUFnQyxFQUNoQyxrQkFBc0M7UUFGdEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQXBDMUQsa0JBQWEsR0FBNEMsSUFBSSxZQUFZLEVBQTZCLENBQUM7UUFJdkcsbUJBQWMsR0FBNEMsSUFBSSxZQUFZLEVBQTZCLENBQUM7UUFJeEcsWUFBTyxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBSXJELFVBQUssR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQWtCbkQsWUFBTyxHQUFpQyxFQUFFLENBQUM7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a0I7Z0JBQzVCLHd3QkFBNEM7Z0JBRTVDLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJOzthQUN4Qzs7O1lBVFEsaUJBQWlCO1lBQ2pCLGVBQWU7WUFMZixrQkFBa0I7OzswQkFtQnRCLEtBQUs7NEJBSUwsTUFBTTs2QkFJTixNQUFNO3NCQUlOLE1BQU07b0JBSU4sTUFBTTtvQkFJTixLQUFLO3NCQUlMLEtBQUs7dUJBSUwsS0FBSyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEFwcHNQcm9jZXNzU2VydmljZSB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE9uQ2hhbmdlcywgT25Jbml0LCBPdXRwdXQsIFNpbXBsZUNoYW5nZXMsIFZpZXdFbmNhcHN1bGF0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBGaWx0ZXJQYXJhbXNNb2RlbCwgRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbCB9IGZyb20gJy4uL21vZGVscy9maWx0ZXIubW9kZWwnO1xuaW1wb3J0IHsgVGFza0ZpbHRlclNlcnZpY2UgfSBmcm9tICcuLy4uL3NlcnZpY2VzL3Rhc2stZmlsdGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgVGFza0xpc3RTZXJ2aWNlIH0gZnJvbSAnLi8uLi9zZXJ2aWNlcy90YXNrbGlzdC5zZXJ2aWNlJztcbmltcG9ydCB7IEljb25Nb2RlbCB9IGZyb20gJy4uLy4uL2FwcC1saXN0L2ljb24ubW9kZWwnO1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ2FkZi10YXNrLWZpbHRlcnMnLFxuICAgIHRlbXBsYXRlVXJsOiAnLi90YXNrLWZpbHRlcnMuY29tcG9uZW50Lmh0bWwnLFxuICAgIHN0eWxlVXJsczogWycuL3Rhc2stZmlsdGVycy5jb21wb25lbnQuc2NzcyddLFxuICAgIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmVcbn0pXG5leHBvcnQgY2xhc3MgVGFza0ZpbHRlcnNDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XG5cbiAgICAvKiogUGFyYW1ldGVycyB0byB1c2UgZm9yIHRoZSB0YXNrIGZpbHRlci4gSWYgdGhlcmUgaXMgbm8gbWF0Y2ggdGhlblxuICAgICAqIHRoZSBkZWZhdWx0IGZpbHRlciAodGhlIGZpcnN0IG9uZSB0aGUgbGlzdCkgaXMgc2VsZWN0ZWQuXG4gICAgICovXG4gICAgQElucHV0KClcbiAgICBmaWx0ZXJQYXJhbTogRmlsdGVyUGFyYW1zTW9kZWw7XG5cbiAgICAvKiogRW1pdHRlZCB3aGVuIGEgZmlsdGVyIGlzIGJlaW5nIGNsaWNrZWQgZnJvbSB0aGUgVUkuICovXG4gICAgQE91dHB1dCgpXG4gICAgZmlsdGVyQ2xpY2tlZDogRXZlbnRFbWl0dGVyPEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWw+ID0gbmV3IEV2ZW50RW1pdHRlcjxGaWx0ZXJSZXByZXNlbnRhdGlvbk1vZGVsPigpO1xuXG4gICAgLyoqIEVtaXR0ZWQgd2hlbiBhIGZpbHRlciBpcyBiZWluZyBzZWxlY3RlZCBiYXNlZCBvbiB0aGUgZmlsdGVyUGFyYW0gaW5wdXQuICovXG4gICAgQE91dHB1dCgpXG4gICAgZmlsdGVyU2VsZWN0ZWQ6IEV2ZW50RW1pdHRlcjxGaWx0ZXJSZXByZXNlbnRhdGlvbk1vZGVsPiA9IG5ldyBFdmVudEVtaXR0ZXI8RmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbD4oKTtcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gdGhlIGxpc3QgaXMgbG9hZGVkLiAqL1xuICAgIEBPdXRwdXQoKVxuICAgIHN1Y2Nlc3M6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgICAvKiogRW1pdHRlZCB3aGVuIGFuIGVycm9yIG9jY3VycyBkdXJpbmcgbG9hZGluZy4gKi9cbiAgICBAT3V0cHV0KClcbiAgICBlcnJvcjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAgIC8qKiBEaXNwbGF5IGZpbHRlcnMgYXZhaWxhYmxlIHRvIHRoZSBjdXJyZW50IHVzZXIgZm9yIHRoZSBhcHBsaWNhdGlvbiB3aXRoIHRoZSBzcGVjaWZpZWQgSUQuICovXG4gICAgQElucHV0KClcbiAgICBhcHBJZDogbnVtYmVyO1xuXG4gICAgLyoqIERpc3BsYXkgZmlsdGVycyBhdmFpbGFibGUgdG8gdGhlIGN1cnJlbnQgdXNlciBmb3IgdGhlIGFwcGxpY2F0aW9uIHdpdGggdGhlIHNwZWNpZmllZCBuYW1lLiAqL1xuICAgIEBJbnB1dCgpXG4gICAgYXBwTmFtZTogc3RyaW5nO1xuXG4gICAgLyoqIFRvZ2dsZXMgZGlzcGxheSBvZiB0aGUgZmlsdGVyJ3MgaWNvbi4gKi9cbiAgICBASW5wdXQoKVxuICAgIHNob3dJY29uOiBib29sZWFuO1xuXG4gICAgZmlsdGVyJDogT2JzZXJ2YWJsZTxGaWx0ZXJSZXByZXNlbnRhdGlvbk1vZGVsPjtcblxuICAgIGN1cnJlbnRGaWx0ZXI6IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWw7XG5cbiAgICBmaWx0ZXJzOiBGaWx0ZXJSZXByZXNlbnRhdGlvbk1vZGVsIFtdID0gW107XG5cbiAgICBwcml2YXRlIGljb25zTURMOiBJY29uTW9kZWw7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRhc2tGaWx0ZXJTZXJ2aWNlOiBUYXNrRmlsdGVyU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRhc2tMaXN0U2VydmljZTogVGFza0xpc3RTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgYXBwc1Byb2Nlc3NTZXJ2aWNlOiBBcHBzUHJvY2Vzc1NlcnZpY2UpIHtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgdGhpcy5pY29uc01ETCA9IG5ldyBJY29uTW9kZWwoKTtcbiAgICB9XG5cbiAgICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgICAgIGNvbnN0IGFwcE5hbWUgPSBjaGFuZ2VzWydhcHBOYW1lJ107XG4gICAgICAgIGNvbnN0IGFwcElkID0gY2hhbmdlc1snYXBwSWQnXTtcbiAgICAgICAgY29uc3QgZmlsdGVyID0gY2hhbmdlc1snZmlsdGVyUGFyYW0nXTtcbiAgICAgICAgaWYgKGFwcE5hbWUgJiYgYXBwTmFtZS5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMuZ2V0RmlsdGVyc0J5QXBwTmFtZShhcHBOYW1lLmN1cnJlbnRWYWx1ZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoYXBwSWQgJiYgYXBwSWQuY3VycmVudFZhbHVlICE9PSBhcHBJZC5wcmV2aW91c1ZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLmdldEZpbHRlcnNCeUFwcElkKGFwcElkLmN1cnJlbnRWYWx1ZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyICYmIGZpbHRlci5jdXJyZW50VmFsdWUgIT09IGZpbHRlci5wcmV2aW91c1ZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdEZpbHRlckFuZEVtaXQoZmlsdGVyLmN1cnJlbnRWYWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gdGhlIHRhc2sgbGlzdCBmaWx0ZXJlZCBieSBhcHBJZCBvciBieSBhcHBOYW1lXG4gICAgICogQHBhcmFtIGFwcElkXG4gICAgICogQHBhcmFtIGFwcE5hbWVcbiAgICAgKi9cbiAgICBnZXRGaWx0ZXJzKGFwcElkPzogbnVtYmVyLCBhcHBOYW1lPzogc3RyaW5nKSB7XG4gICAgICAgIGFwcE5hbWUgPyB0aGlzLmdldEZpbHRlcnNCeUFwcE5hbWUoYXBwTmFtZSkgOiB0aGlzLmdldEZpbHRlcnNCeUFwcElkKGFwcElkKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gdGhlIGZpbHRlciBsaXN0IGZpbHRlcmVkIGJ5IGFwcElkXG4gICAgICogQHBhcmFtIGFwcElkIC0gb3B0aW9uYWxcbiAgICAgKi9cbiAgICBnZXRGaWx0ZXJzQnlBcHBJZChhcHBJZD86IG51bWJlcikge1xuICAgICAgICB0aGlzLnRhc2tGaWx0ZXJTZXJ2aWNlLmdldFRhc2tMaXN0RmlsdGVycyhhcHBJZCkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgKHJlczogRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbFtdKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHJlcy5sZW5ndGggPT09IDAgJiYgdGhpcy5pc0ZpbHRlckxpc3RFbXB0eSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlRmlsdGVyc0J5QXBwSWQoYXBwSWQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVzZXRGaWx0ZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJzID0gcmVzO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdEZpbHRlcih0aGlzLmZpbHRlclBhcmFtKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdWNjZXNzLmVtaXQocmVzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKGVycjogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5lcnJvci5lbWl0KGVycik7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJuIHRoZSBmaWx0ZXIgbGlzdCBmaWx0ZXJlZCBieSBhcHBOYW1lXG4gICAgICogQHBhcmFtIGFwcE5hbWVcbiAgICAgKi9cbiAgICBnZXRGaWx0ZXJzQnlBcHBOYW1lKGFwcE5hbWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLmFwcHNQcm9jZXNzU2VydmljZS5nZXREZXBsb3llZEFwcGxpY2F0aW9uc0J5TmFtZShhcHBOYW1lKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAoYXBwbGljYXRpb24pID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmdldEZpbHRlcnNCeUFwcElkKGFwcGxpY2F0aW9uLmlkKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5lcnJvci5lbWl0KGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgZGVmYXVsdCBmaWx0ZXJzIGJ5IGFwcElkXG4gICAgICogQHBhcmFtIGFwcElkXG4gICAgICovXG4gICAgY3JlYXRlRmlsdGVyc0J5QXBwSWQoYXBwSWQ/OiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy50YXNrRmlsdGVyU2VydmljZS5jcmVhdGVEZWZhdWx0RmlsdGVycyhhcHBJZCkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgKHJlc0RlZmF1bHQ6IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWxbXSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucmVzZXRGaWx0ZXIoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmZpbHRlcnMgPSByZXNEZWZhdWx0O1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0RmlsdGVyKHRoaXMuZmlsdGVyUGFyYW0pO1xuICAgICAgICAgICAgICAgIHRoaXMuc3VjY2Vzcy5lbWl0KHJlc0RlZmF1bHQpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIChlcnJEZWZhdWx0OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmVycm9yLmVtaXQoZXJyRGVmYXVsdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGFzcyB0aGUgc2VsZWN0ZWQgZmlsdGVyIGFzIG5leHRcbiAgICAgKiBAcGFyYW0gbmV3RmlsdGVyXG4gICAgICovXG4gICAgcHVibGljIHNlbGVjdEZpbHRlcihuZXdGaWx0ZXI6IEZpbHRlclBhcmFtc01vZGVsKSB7XG4gICAgICAgIGlmIChuZXdGaWx0ZXIpIHtcbiAgICAgICAgICAgIHRoaXMuY3VycmVudEZpbHRlciA9IHRoaXMuZmlsdGVycy5maW5kKCAoZmlsdGVyLCBpbmRleCkgPT5cbiAgICAgICAgICAgICAgICBuZXdGaWx0ZXIuaW5kZXggPT09IGluZGV4IHx8XG4gICAgICAgICAgICAgICAgbmV3RmlsdGVyLmlkID09PSBmaWx0ZXIuaWQgfHxcbiAgICAgICAgICAgICAgICAobmV3RmlsdGVyLm5hbWUgJiZcbiAgICAgICAgICAgICAgICAgICAgKG5ld0ZpbHRlci5uYW1lLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09IGZpbHRlci5uYW1lLnRvTG9jYWxlTG93ZXJDYXNlKCkpXG4gICAgICAgICAgICAgICAgKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc2VsZWN0RmlsdGVyQW5kRW1pdChuZXdGaWx0ZXI6IEZpbHRlclBhcmFtc01vZGVsKSB7XG4gICAgICAgIHRoaXMuc2VsZWN0RmlsdGVyKG5ld0ZpbHRlcik7XG4gICAgICAgIHRoaXMuZmlsdGVyU2VsZWN0ZWQuZW1pdCh0aGlzLmN1cnJlbnRGaWx0ZXIpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNlbGVjdHMgYW5kIGVtaXRzIHRoZSBjbGlja2VkIGZpbHRlci5cbiAgICAgKi9cbiAgICBvbkZpbHRlckNsaWNrKGZpbHRlcjogRmlsdGVyUGFyYW1zTW9kZWwpIHtcbiAgICAgICAgdGhpcy5zZWxlY3RGaWx0ZXIoZmlsdGVyKTtcbiAgICAgICAgdGhpcy5maWx0ZXJDbGlja2VkLmVtaXQodGhpcy5jdXJyZW50RmlsdGVyKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZWxlY3QgZmlsdGVyIHdpdGggdGFza1xuICAgICAqIEBwYXJhbSB0YXNrSWRcbiAgICAgKi9cbiAgICBwdWJsaWMgc2VsZWN0RmlsdGVyV2l0aFRhc2sodGFza0lkOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgZmlsdGVyZWRGaWx0ZXJMaXN0OiBGaWx0ZXJSZXByZXNlbnRhdGlvbk1vZGVsW10gPSBbXTtcbiAgICAgICAgdGhpcy50YXNrTGlzdFNlcnZpY2UuZ2V0RmlsdGVyRm9yVGFza0J5SWQodGFza0lkLCB0aGlzLmZpbHRlcnMpLnN1YnNjcmliZShcbiAgICAgICAgICAgIChmaWx0ZXI6IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICBmaWx0ZXJlZEZpbHRlckxpc3QucHVzaChmaWx0ZXIpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmVycm9yLmVtaXQoZXJyKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGZpbHRlcmVkRmlsdGVyTGlzdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0RmlsdGVyKGZpbHRlcmVkRmlsdGVyTGlzdFswXSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyU2VsZWN0ZWQuZW1pdCh0aGlzLmN1cnJlbnRGaWx0ZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNlbGVjdCBhcyBkZWZhdWx0IHRhc2sgZmlsdGVyIHRoZSBmaXJzdCBpbiB0aGUgbGlzdFxuICAgICAqIEBwYXJhbSBmaWx0ZXJlZEZpbHRlckxpc3RcbiAgICAgKi9cbiAgICBwdWJsaWMgc2VsZWN0RGVmYXVsdFRhc2tGaWx0ZXIoKSB7XG4gICAgICAgIGlmICghdGhpcy5pc0ZpbHRlckxpc3RFbXB0eSgpKSB7XG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRGaWx0ZXIgPSB0aGlzLmZpbHRlcnNbMF07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gdGhlIGN1cnJlbnQgdGFza1xuICAgICAqL1xuICAgIGdldEN1cnJlbnRGaWx0ZXIoKTogRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbCB7XG4gICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRGaWx0ZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgaWYgdGhlIGZpbHRlciBsaXN0IGlzIGVtcHR5XG4gICAgICovXG4gICAgaXNGaWx0ZXJMaXN0RW1wdHkoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmZpbHRlcnMgPT09IHVuZGVmaW5lZCB8fCAodGhpcy5maWx0ZXJzICYmIHRoaXMuZmlsdGVycy5sZW5ndGggPT09IDApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlc2V0IHRoZSBmaWx0ZXJzIHByb3BlcnRpZXNcbiAgICAgKi9cbiAgICBwcml2YXRlIHJlc2V0RmlsdGVyKCkge1xuICAgICAgICB0aGlzLmZpbHRlcnMgPSBbXTtcbiAgICAgICAgdGhpcy5jdXJyZW50RmlsdGVyID0gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBjdXJyZW50IGZpbHRlciBpY29uXG4gICAgICovXG4gICAgZ2V0RmlsdGVySWNvbihpY29uKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaWNvbnNNREwubWFwR2x5cGhpY29uVG9NYXRlcmlhbERlc2lnbkljb25zKGljb24pO1xuICAgIH1cbn1cbiJdfQ==