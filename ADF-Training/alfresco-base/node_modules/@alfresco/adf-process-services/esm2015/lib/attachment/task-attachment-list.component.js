/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { ContentService, ThumbnailService, EmptyListComponent, ProcessContentService } from '@alfresco/adf-core';
import { ContentChild, Component, EventEmitter, Input, NgZone, Output, ViewEncapsulation } from '@angular/core';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
import * as ɵngcc2 from '@angular/common';
import * as ɵngcc3 from '@angular/material/progress-spinner';
import * as ɵngcc4 from '@ngx-translate/core';

function TaskAttachmentListComponent_ng_template_2_ng_content_0_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵprojection(0, 0, ["*ngIf", "hasCustomTemplate; else defaulEmptyList", "class", "adf-custom-empty-template"]);
} }
function TaskAttachmentListComponent_ng_template_2_ng_template_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "adf-empty-list");
    ɵngcc0.ɵɵelementStart(1, "div", 6);
    ɵngcc0.ɵɵtext(2);
    ɵngcc0.ɵɵpipe(3, "translate");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(3, 1, "ADF_TASK_LIST.ATTACHMENT.EMPTY.HEADER"), " ");
} }
function TaskAttachmentListComponent_ng_template_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵtemplate(0, TaskAttachmentListComponent_ng_template_2_ng_content_0_Template, 1, 0, "ng-content", 4);
    ɵngcc0.ɵɵtemplate(1, TaskAttachmentListComponent_ng_template_2_ng_template_1_Template, 4, 3, "ng-template", null, 5, ɵngcc0.ɵɵtemplateRefExtractor);
} if (rf & 2) {
    const _r3 = ɵngcc0.ɵɵreference(2);
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵproperty("ngIf", ctx_r0.hasCustomTemplate)("ngIfElse", _r3);
} }
function TaskAttachmentListComponent_ng_template_8_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "mat-progress-spinner", 7);
} if (rf & 2) {
    ɵngcc0.ɵɵproperty("color", "primary")("mode", "indeterminate");
} }
const _c0 = ["*"];
export class TaskAttachmentListComponent {
    constructor(activitiContentService, contentService, thumbnailService, ngZone) {
        this.activitiContentService = activitiContentService;
        this.contentService = contentService;
        this.thumbnailService = thumbnailService;
        this.ngZone = ngZone;
        this.disabled = false;
        this.attachmentClick = new EventEmitter();
        this.success = new EventEmitter();
        this.error = new EventEmitter();
        this.hasCustomTemplate = false;
        this.attachments = [];
        this.isLoading = false;
    }
    ngOnChanges(changes) {
        if (changes['taskId'] && changes['taskId'].currentValue) {
            this.loadAttachmentsByTaskId(changes['taskId'].currentValue);
        }
    }
    ngAfterContentInit() {
        if (this.emptyTemplate) {
            this.hasCustomTemplate = true;
        }
    }
    reset() {
        this.attachments = [];
    }
    hasCustomEmptyTemplate() {
        return !!this.emptyTemplate;
    }
    reload() {
        this.ngZone.run(() => {
            this.loadAttachmentsByTaskId(this.taskId);
        });
    }
    add(content) {
        this.ngZone.run(() => {
            this.attachments.push({
                id: content.id,
                name: content.name,
                created: content.created,
                createdBy: content.createdBy.firstName + ' ' + content.createdBy.lastName,
                icon: this.thumbnailService.getMimeTypeIcon(content.mimeType)
            });
        });
    }
    loadAttachmentsByTaskId(taskId) {
        if (taskId) {
            this.isLoading = true;
            this.reset();
            const isRelatedContent = 'true';
            this.activitiContentService.getTaskRelatedContent(taskId, { isRelatedContent }).subscribe((res) => {
                const attachList = [];
                res.data.forEach((content) => {
                    attachList.push({
                        id: content.id,
                        name: content.name,
                        created: content.created,
                        createdBy: content.createdBy.firstName + ' ' + content.createdBy.lastName,
                        icon: this.thumbnailService.getMimeTypeIcon(content.mimeType)
                    });
                });
                this.attachments = attachList;
                this.success.emit(this.attachments);
                this.isLoading = false;
            }, (err) => {
                this.error.emit(err);
                this.isLoading = false;
            });
        }
    }
    deleteAttachmentById(contentId) {
        if (contentId) {
            this.activitiContentService.deleteRelatedContent(contentId).subscribe(() => {
                this.attachments = this.attachments.filter((content) => {
                    return content.id !== contentId;
                });
            }, (err) => {
                this.error.emit(err);
            });
        }
    }
    isEmpty() {
        return this.attachments && this.attachments.length === 0;
    }
    onShowRowActionsMenu(event) {
        const viewAction = {
            title: 'ADF_TASK_LIST.MENU_ACTIONS.VIEW_CONTENT',
            name: 'view'
        };
        const removeAction = {
            title: 'ADF_TASK_LIST.MENU_ACTIONS.REMOVE_CONTENT',
            name: 'remove'
        };
        const downloadAction = {
            title: 'ADF_TASK_LIST.MENU_ACTIONS.DOWNLOAD_CONTENT',
            name: 'download'
        };
        event.value.actions = [
            viewAction,
            downloadAction
        ];
        if (!this.disabled) {
            event.value.actions.splice(1, 0, removeAction);
        }
    }
    onExecuteRowAction(event) {
        const args = event.value;
        const action = args.action;
        if (action.name === 'view') {
            this.emitDocumentContent(args.row.obj);
        }
        else if (action.name === 'remove') {
            this.deleteAttachmentById(args.row.obj.id);
        }
        else if (action.name === 'download') {
            this.downloadContent(args.row.obj);
        }
    }
    openContent(event) {
        const content = event.value.obj;
        this.emitDocumentContent(content);
    }
    emitDocumentContent(content) {
        this.activitiContentService.getContentPreview(content.id).subscribe((blob) => {
            content.contentBlob = blob;
            this.attachmentClick.emit(content);
        }, (err) => {
            this.error.emit(err);
        });
    }
    downloadContent(content) {
        this.activitiContentService.getFileRawContent(content.id).subscribe((blob) => this.contentService.downloadBlob(blob, content.name), (err) => {
            this.error.emit(err);
        });
    }
    isDisabled() {
        return this.disabled;
    }
}
TaskAttachmentListComponent.ɵfac = function TaskAttachmentListComponent_Factory(t) { return new (t || TaskAttachmentListComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ProcessContentService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ContentService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ThumbnailService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone)); };
TaskAttachmentListComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: TaskAttachmentListComponent, selectors: [["adf-task-attachment-list"]], contentQueries: function TaskAttachmentListComponent_ContentQueries(rf, ctx, dirIndex) { if (rf & 1) {
        ɵngcc0.ɵɵcontentQuery(dirIndex, EmptyListComponent, true);
    } if (rf & 2) {
        var _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.emptyTemplate = _t.first);
    } }, inputs: { disabled: "disabled", taskId: "taskId" }, outputs: { attachmentClick: "attachmentClick", success: "success", error: "error" }, features: [ɵngcc0.ɵɵNgOnChangesFeature], ngContentSelectors: _c0, decls: 9, vars: 5, consts: [[3, "rows", "actions", "loading", "rowDblClick", "showRowActionsMenu", "executeRowAction"], ["key", "icon", "type", "image", "srTitle", "ADF_TASK_LIST.PROPERTIES.THUMBNAIL", 3, "sortable"], ["key", "name", "type", "text", "title", "ADF_TASK_LIST.PROPERTIES.NAME", 1, "adf-full-width", "adf-ellipsis-cell", 3, "sortable"], ["key", "created", "type", "date", "format", "shortDate", "title", "ADF_TASK_LIST.PROPERTIES.CREATED"], [4, "ngIf", "ngIfElse"], ["defaulEmptyList", ""], ["adf-empty-list-header", "", 1, "adf-empty-list-header"], [1, "adf-attachment-list-loading-margin", 3, "color", "mode"]], template: function TaskAttachmentListComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵprojectionDef();
        ɵngcc0.ɵɵelementStart(0, "adf-datatable", 0);
        ɵngcc0.ɵɵlistener("rowDblClick", function TaskAttachmentListComponent_Template_adf_datatable_rowDblClick_0_listener($event) { return ctx.openContent($event); })("showRowActionsMenu", function TaskAttachmentListComponent_Template_adf_datatable_showRowActionsMenu_0_listener($event) { return ctx.onShowRowActionsMenu($event); })("executeRowAction", function TaskAttachmentListComponent_Template_adf_datatable_executeRowAction_0_listener($event) { return ctx.onExecuteRowAction($event); });
        ɵngcc0.ɵɵelementStart(1, "adf-no-content-template");
        ɵngcc0.ɵɵtemplate(2, TaskAttachmentListComponent_ng_template_2_Template, 3, 2, "ng-template");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(3, "data-columns");
        ɵngcc0.ɵɵelement(4, "data-column", 1);
        ɵngcc0.ɵɵelement(5, "data-column", 2);
        ɵngcc0.ɵɵelement(6, "data-column", 3);
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(7, "adf-loading-content-template");
        ɵngcc0.ɵɵtemplate(8, TaskAttachmentListComponent_ng_template_8_Template, 1, 2, "ng-template");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("rows", ctx.attachments)("actions", true)("loading", ctx.isLoading);
        ɵngcc0.ɵɵadvance(4);
        ɵngcc0.ɵɵproperty("sortable", false);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("sortable", true);
    } }, directives: [ɵngcc1.DataTableComponent, ɵngcc1.NoContentTemplateDirective, ɵngcc1.DataColumnListComponent, ɵngcc1.DataColumnComponent, ɵngcc1.LoadingContentTemplateDirective, ɵngcc2.NgIf, ɵngcc1.EmptyListComponent, ɵngcc1.EmptyListHeaderDirective, ɵngcc3.MatProgressSpinner], pipes: [ɵngcc4.TranslatePipe], styles: ["adf-datatable .adf-data-cell{cursor:pointer!important}.adf-attachment-list-loading-margin{margin-left:calc(50% - 50px);margin-right:calc(50% - 50px)}.adf-empty-list-header{font-size:24px;height:32px;letter-spacing:-1px;line-height:1.33;opacity:.26}.adf-empty-list-drag_drop{font-size:56px;letter-spacing:-2px;line-height:1;margin-top:40px;min-height:56px;opacity:.54;white-space:pre-line;word-break:break-all}@media screen and (max-width:599px){.adf-empty-list-drag_drop{font-size:40px}}.adf-empty-list__any-files-here-to-add{font-size:16px;letter-spacing:-.4px;line-height:1.5;margin-top:17px;min-height:24px;opacity:.54;white-space:pre-line;word-break:break-all}.adf-empty-list__empty_doc_lib{height:161px;margin-top:17px;max-width:100%;object-fit:contain;width:565px}@media screen and (max-width:599px){.adf-empty-list__empty_doc_lib{width:250px}}"], encapsulation: 2 });
TaskAttachmentListComponent.ctorParameters = () => [
    { type: ProcessContentService },
    { type: ContentService },
    { type: ThumbnailService },
    { type: NgZone }
];
TaskAttachmentListComponent.propDecorators = {
    emptyTemplate: [{ type: ContentChild, args: [EmptyListComponent,] }],
    taskId: [{ type: Input }],
    disabled: [{ type: Input }],
    attachmentClick: [{ type: Output }],
    success: [{ type: Output }],
    error: [{ type: Output }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(TaskAttachmentListComponent, [{
        type: Component,
        args: [{
                selector: 'adf-task-attachment-list',
                template: "<adf-datatable [rows]=\"attachments\"\n               [actions]=\"true\"\n               [loading]=\"isLoading\"\n               (rowDblClick)=\"openContent($event)\"\n               (showRowActionsMenu)=\"onShowRowActionsMenu($event)\"\n               (executeRowAction)=\"onExecuteRowAction($event)\">\n            <adf-no-content-template>\n                <ng-template>\n                    <ng-content *ngIf=\"hasCustomTemplate; else defaulEmptyList\" class=\"adf-custom-empty-template\"></ng-content>\n                    <ng-template #defaulEmptyList>\n                        <adf-empty-list>\n                            <div adf-empty-list-header class=\"adf-empty-list-header\">\n                                {{'ADF_TASK_LIST.ATTACHMENT.EMPTY.HEADER' | translate}}\n                            </div>\n                        </adf-empty-list>\n                    </ng-template>\n                </ng-template>\n            </adf-no-content-template>\n\n            <data-columns>\n                <data-column key=\"icon\" type=\"image\" srTitle=\"ADF_TASK_LIST.PROPERTIES.THUMBNAIL\" [sortable]=\"false\"></data-column>\n                <data-column key=\"name\" type=\"text\" title=\"ADF_TASK_LIST.PROPERTIES.NAME\" class=\"adf-full-width adf-ellipsis-cell\" [sortable]=\"true\"></data-column>\n                <data-column key=\"created\" type=\"date\" format=\"shortDate\" title=\"ADF_TASK_LIST.PROPERTIES.CREATED\"></data-column>\n            </data-columns>\n            <adf-loading-content-template>\n                <ng-template>\n                <!--Add your custom loading template here-->\n                    <mat-progress-spinner class=\"adf-attachment-list-loading-margin\" [color]=\"'primary'\" [mode]=\"'indeterminate'\">\n                    </mat-progress-spinner>\n                </ng-template>\n            </adf-loading-content-template>\n</adf-datatable>\n",
                encapsulation: ViewEncapsulation.None,
                styles: ["adf-datatable .adf-data-cell{cursor:pointer!important}.adf-attachment-list-loading-margin{margin-left:calc(50% - 50px);margin-right:calc(50% - 50px)}.adf-empty-list-header{font-size:24px;height:32px;letter-spacing:-1px;line-height:1.33;opacity:.26}.adf-empty-list-drag_drop{font-size:56px;letter-spacing:-2px;line-height:1;margin-top:40px;min-height:56px;opacity:.54;white-space:pre-line;word-break:break-all}@media screen and (max-width:599px){.adf-empty-list-drag_drop{font-size:40px}}.adf-empty-list__any-files-here-to-add{font-size:16px;letter-spacing:-.4px;line-height:1.5;margin-top:17px;min-height:24px;opacity:.54;white-space:pre-line;word-break:break-all}.adf-empty-list__empty_doc_lib{height:161px;margin-top:17px;max-width:100%;object-fit:contain;width:565px}@media screen and (max-width:599px){.adf-empty-list__empty_doc_lib{width:250px}}"]
            }]
    }], function () { return [{ type: ɵngcc1.ProcessContentService }, { type: ɵngcc1.ContentService }, { type: ɵngcc1.ThumbnailService }, { type: ɵngcc0.NgZone }]; }, { disabled: [{
            type: Input
        }], attachmentClick: [{
            type: Output
        }], success: [{
            type: Output
        }], error: [{
            type: Output
        }], emptyTemplate: [{
            type: ContentChild,
            args: [EmptyListComponent]
        }], taskId: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFzay1hdHRhY2htZW50LWxpc3QuY29tcG9uZW50LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvcHJvY2Vzcy1zZXJ2aWNlcy9zcmMvbGliL2F0dGFjaG1lbnQvdGFzay1hdHRhY2htZW50LWxpc3QuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFFSCxPQUFPLEVBQUUsY0FBYyxFQUFFLGdCQUFnQixFQUFFLGtCQUFrQixFQUFFLHFCQUFxQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDakgsT0FBTyxFQUVILFlBQVksRUFDWixTQUFTLEVBQ1QsWUFBWSxFQUNaLEtBQUssRUFDTCxNQUFNLEVBRU4sTUFBTSxFQUVOLGlCQUFpQixFQUNwQixNQUFNLGVBQWUsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFRdkIsTUFBTSxPQUFPLDJCQUEyQjtBQUFHLElBbUN2QyxZQUFvQixzQkFBNkMsRUFDN0MsY0FBOEIsRUFDOUIsZ0JBQWtDLEVBQ2xDLE1BQWM7QUFDdEMsUUFKd0IsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUF1QjtBQUFDLFFBQzlDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtBQUFDLFFBQy9CLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7QUFBQyxRQUNuQyxXQUFNLEdBQU4sTUFBTSxDQUFRO0FBQUMsUUEzQm5DLGFBQVEsR0FBWSxLQUFLLENBQUM7QUFDOUIsUUFNSSxvQkFBZSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7QUFDekMsUUFLSSxZQUFPLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztBQUNqQyxR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QUFJLENBQUMsc0JBQXNCLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FDL0QsQ0FBQyxJQUFVLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQ3BFLENBQUMsR0FBRyxFQUFFLEVBQUU7QUFDcEIsWUFBZ0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDckMsUUFBWSxDQUFDLENBQ0osQ0FBQztBQUNWLElBQUksQ0FBQztBQUNMLElBQ0ksVUFBVTtBQUFLLFFBQ1gsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO0FBQzdCLElBQUksQ0FBQztBQUNMO3VEQXRNQyxTQUFTLFNBQUMsa0JBQ1AsUUFBUSxFQUFFLDBCQUEwQixrQkFFcEM7Ozs7Ozs7OzttUkFBb0Qsa0JBQ3BELGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJOzs7Ozs7Ozs7Ozs7Ozs0REFDeEM7Ozs7O2dyQ0FDSTtBQUFDO0FBQXFELFlBcEJJLHFCQUFxQjtBQUFJLFlBQS9FLGNBQWM7QUFBSSxZQUFGLGdCQUFnQjtBQUFJLFlBT3pDLE1BQU07QUFDVDtBQUFHO0FBR0MsNEJBV0EsWUFBWSxTQUFDLGtCQUFrQjtBQUMvQixxQkFHQSxLQUFLO0FBQ1IsdUJBR0csS0FBSztBQUNSLDhCQU1HLE1BQU07QUFDVCxzQkFLRyxNQUFNO0FBQ1Qsb0JBR0csTUFBTTtBQUNWOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O29CQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBDb250ZW50U2VydmljZSwgVGh1bWJuYWlsU2VydmljZSwgRW1wdHlMaXN0Q29tcG9uZW50LCBQcm9jZXNzQ29udGVudFNlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHtcbiAgICBBZnRlckNvbnRlbnRJbml0LFxuICAgIENvbnRlbnRDaGlsZCxcbiAgICBDb21wb25lbnQsXG4gICAgRXZlbnRFbWl0dGVyLFxuICAgIElucHV0LFxuICAgIE5nWm9uZSxcbiAgICBPbkNoYW5nZXMsXG4gICAgT3V0cHV0LFxuICAgIFNpbXBsZUNoYW5nZXMsXG4gICAgVmlld0VuY2Fwc3VsYXRpb25cbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAnYWRmLXRhc2stYXR0YWNobWVudC1saXN0JyxcbiAgICBzdHlsZVVybHM6IFsnLi90YXNrLWF0dGFjaG1lbnQtbGlzdC5jb21wb25lbnQuc2NzcyddLFxuICAgIHRlbXBsYXRlVXJsOiAnLi90YXNrLWF0dGFjaG1lbnQtbGlzdC5jb21wb25lbnQuaHRtbCcsXG4gICAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZVxufSlcbmV4cG9ydCBjbGFzcyBUYXNrQXR0YWNobWVudExpc3RDb21wb25lbnQgaW1wbGVtZW50cyBPbkNoYW5nZXMsIEFmdGVyQ29udGVudEluaXQge1xuXG4gICAgQENvbnRlbnRDaGlsZChFbXB0eUxpc3RDb21wb25lbnQpXG4gICAgZW1wdHlUZW1wbGF0ZTogRW1wdHlMaXN0Q29tcG9uZW50O1xuXG4gICAgLyoqICgqKnJlcXVpcmVkKiopIFRoZSBJRCBvZiB0aGUgdGFzayB0byBkaXNwbGF5LiAqL1xuICAgIEBJbnB1dCgpXG4gICAgdGFza0lkOiBzdHJpbmc7XG5cbiAgICAvKiogRGlzYWJsZS9FbmFibGUgcmVhZCBvbmx5IG1vZGUgZm9yIGF0dGFjaG1lbnQgbGlzdC4gKi9cbiAgICBASW5wdXQoKVxuICAgIGRpc2FibGVkOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICAvKiogRW1pdHRlZCB3aGVuIHRoZSBhdHRhY2htZW50IGlzIGRvdWJsZS1jbGlja2VkIG9yIGEgdmlld1xuICAgICAqIG9wdGlvbiBpcyBzZWxlY3RlZCBmcm9tIHRoZSBjb250ZXh0IG1lbnUgYnkgdGhlIHVzZXIgZnJvbSB3aXRoaW4gdGhlIGNvbXBvbmVudC5cbiAgICAgKiBSZXR1cm5zIGEgQmxvYiByZXByZXNlbnRpbmcgdGhlIGNsaWNrZWQgb2JqZWN0LlxuICAgICAqL1xuICAgIEBPdXRwdXQoKVxuICAgIGF0dGFjaG1lbnRDbGljayA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gdGhlIGF0dGFjaG1lbnQgbGlzdCBoYXMgZmV0Y2hlZCBhbGwgdGhlIGF0dGFjaG1lbnRzLlxuICAgICAqIFJldHVybnMgYSBsaXN0IG9mIGF0dGFjaG1lbnRzLlxuICAgICAqL1xuICAgIEBPdXRwdXQoKVxuICAgIHN1Y2Nlc3MgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgICAvKiogRW1pdHRlZCB3aGVuIGFuIGVycm9yIG9jY3VycyB3aGlsZSBmZXRjaGluZyB0aGUgYXR0YWNobWVudHMuICovXG4gICAgQE91dHB1dCgpXG4gICAgZXJyb3IgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAgIGhhc0N1c3RvbVRlbXBsYXRlOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICBhdHRhY2htZW50czogYW55W10gPSBbXTtcbiAgICBpc0xvYWRpbmc6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYWN0aXZpdGlDb250ZW50U2VydmljZTogUHJvY2Vzc0NvbnRlbnRTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgY29udGVudFNlcnZpY2U6IENvbnRlbnRTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdGh1bWJuYWlsU2VydmljZTogVGh1bWJuYWlsU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIG5nWm9uZTogTmdab25lKSB7XG4gICAgfVxuXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgICAgICBpZiAoY2hhbmdlc1sndGFza0lkJ10gJiYgY2hhbmdlc1sndGFza0lkJ10uY3VycmVudFZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLmxvYWRBdHRhY2htZW50c0J5VGFza0lkKGNoYW5nZXNbJ3Rhc2tJZCddLmN1cnJlbnRWYWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBuZ0FmdGVyQ29udGVudEluaXQoKSB7XG4gICAgICAgIGlmICh0aGlzLmVtcHR5VGVtcGxhdGUpIHtcbiAgICAgICAgICAgIHRoaXMuaGFzQ3VzdG9tVGVtcGxhdGUgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVzZXQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuYXR0YWNobWVudHMgPSBbXTtcbiAgICB9XG5cbiAgICBoYXNDdXN0b21FbXB0eVRlbXBsYXRlKCkge1xuICAgICAgICByZXR1cm4gISF0aGlzLmVtcHR5VGVtcGxhdGU7XG4gICAgfVxuXG4gICAgcmVsb2FkKCk6IHZvaWQge1xuICAgICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5sb2FkQXR0YWNobWVudHNCeVRhc2tJZCh0aGlzLnRhc2tJZCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFkZChjb250ZW50OiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuYXR0YWNobWVudHMucHVzaCh7XG4gICAgICAgICAgICAgICAgaWQ6IGNvbnRlbnQuaWQsXG4gICAgICAgICAgICAgICAgbmFtZTogY29udGVudC5uYW1lLFxuICAgICAgICAgICAgICAgIGNyZWF0ZWQ6IGNvbnRlbnQuY3JlYXRlZCxcbiAgICAgICAgICAgICAgICBjcmVhdGVkQnk6IGNvbnRlbnQuY3JlYXRlZEJ5LmZpcnN0TmFtZSArICcgJyArIGNvbnRlbnQuY3JlYXRlZEJ5Lmxhc3ROYW1lLFxuICAgICAgICAgICAgICAgIGljb246IHRoaXMudGh1bWJuYWlsU2VydmljZS5nZXRNaW1lVHlwZUljb24oY29udGVudC5taW1lVHlwZSlcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGxvYWRBdHRhY2htZW50c0J5VGFza0lkKHRhc2tJZDogc3RyaW5nKSB7XG4gICAgICAgIGlmICh0YXNrSWQpIHtcbiAgICAgICAgICAgIHRoaXMuaXNMb2FkaW5nID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMucmVzZXQoKTtcbiAgICAgICAgICAgIGNvbnN0IGlzUmVsYXRlZENvbnRlbnQgPSAndHJ1ZSc7XG4gICAgICAgICAgICB0aGlzLmFjdGl2aXRpQ29udGVudFNlcnZpY2UuZ2V0VGFza1JlbGF0ZWRDb250ZW50KHRhc2tJZCwgeyBpc1JlbGF0ZWRDb250ZW50IH0pLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXR0YWNoTGlzdCA9IFtdO1xuICAgICAgICAgICAgICAgICAgICByZXMuZGF0YS5mb3JFYWNoKChjb250ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhdHRhY2hMaXN0LnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBjb250ZW50LmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGNvbnRlbnQubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVkOiBjb250ZW50LmNyZWF0ZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlZEJ5OiBjb250ZW50LmNyZWF0ZWRCeS5maXJzdE5hbWUgKyAnICcgKyBjb250ZW50LmNyZWF0ZWRCeS5sYXN0TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uOiB0aGlzLnRodW1ibmFpbFNlcnZpY2UuZ2V0TWltZVR5cGVJY29uKGNvbnRlbnQubWltZVR5cGUpXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXR0YWNobWVudHMgPSBhdHRhY2hMaXN0O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN1Y2Nlc3MuZW1pdCh0aGlzLmF0dGFjaG1lbnRzKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lcnJvci5lbWl0KGVycik7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBkZWxldGVBdHRhY2htZW50QnlJZChjb250ZW50SWQ6IG51bWJlcikge1xuICAgICAgICBpZiAoY29udGVudElkKSB7XG4gICAgICAgICAgICB0aGlzLmFjdGl2aXRpQ29udGVudFNlcnZpY2UuZGVsZXRlUmVsYXRlZENvbnRlbnQoY29udGVudElkKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmF0dGFjaG1lbnRzID0gdGhpcy5hdHRhY2htZW50cy5maWx0ZXIoKGNvbnRlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZW50LmlkICE9PSBjb250ZW50SWQ7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVycm9yLmVtaXQoZXJyKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlzRW1wdHkoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmF0dGFjaG1lbnRzICYmIHRoaXMuYXR0YWNobWVudHMubGVuZ3RoID09PSAwO1xuICAgIH1cblxuICAgIG9uU2hvd1Jvd0FjdGlvbnNNZW51KGV2ZW50OiBhbnkpIHtcbiAgICAgICAgY29uc3Qgdmlld0FjdGlvbiA9IHtcbiAgICAgICAgICAgIHRpdGxlOiAnQURGX1RBU0tfTElTVC5NRU5VX0FDVElPTlMuVklFV19DT05URU5UJyxcbiAgICAgICAgICAgIG5hbWU6ICd2aWV3J1xuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHJlbW92ZUFjdGlvbiA9IHtcbiAgICAgICAgICAgIHRpdGxlOiAnQURGX1RBU0tfTElTVC5NRU5VX0FDVElPTlMuUkVNT1ZFX0NPTlRFTlQnLFxuICAgICAgICAgICAgbmFtZTogJ3JlbW92ZSdcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBkb3dubG9hZEFjdGlvbiA9IHtcbiAgICAgICAgICAgIHRpdGxlOiAnQURGX1RBU0tfTElTVC5NRU5VX0FDVElPTlMuRE9XTkxPQURfQ09OVEVOVCcsXG4gICAgICAgICAgICBuYW1lOiAnZG93bmxvYWQnXG4gICAgICAgIH07XG5cbiAgICAgICAgZXZlbnQudmFsdWUuYWN0aW9ucyA9IFtcbiAgICAgICAgICAgIHZpZXdBY3Rpb24sXG4gICAgICAgICAgICBkb3dubG9hZEFjdGlvblxuICAgICAgICBdO1xuXG4gICAgICAgIGlmICghdGhpcy5kaXNhYmxlZCkge1xuICAgICAgICAgICAgZXZlbnQudmFsdWUuYWN0aW9ucy5zcGxpY2UoMSwgMCwgcmVtb3ZlQWN0aW9uKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9uRXhlY3V0ZVJvd0FjdGlvbihldmVudDogYW55KSB7XG4gICAgICAgIGNvbnN0IGFyZ3MgPSBldmVudC52YWx1ZTtcbiAgICAgICAgY29uc3QgYWN0aW9uID0gYXJncy5hY3Rpb247XG4gICAgICAgIGlmIChhY3Rpb24ubmFtZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICB0aGlzLmVtaXREb2N1bWVudENvbnRlbnQoYXJncy5yb3cub2JqKTtcbiAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24ubmFtZSA9PT0gJ3JlbW92ZScpIHtcbiAgICAgICAgICAgIHRoaXMuZGVsZXRlQXR0YWNobWVudEJ5SWQoYXJncy5yb3cub2JqLmlkKTtcbiAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24ubmFtZSA9PT0gJ2Rvd25sb2FkJykge1xuICAgICAgICAgICAgdGhpcy5kb3dubG9hZENvbnRlbnQoYXJncy5yb3cub2JqKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9wZW5Db250ZW50KGV2ZW50OiBhbnkpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGVudCA9IGV2ZW50LnZhbHVlLm9iajtcbiAgICAgICAgdGhpcy5lbWl0RG9jdW1lbnRDb250ZW50KGNvbnRlbnQpO1xuICAgIH1cblxuICAgIGVtaXREb2N1bWVudENvbnRlbnQoY29udGVudDogYW55KSB7XG4gICAgICAgIHRoaXMuYWN0aXZpdGlDb250ZW50U2VydmljZS5nZXRDb250ZW50UHJldmlldyhjb250ZW50LmlkKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAoYmxvYjogQmxvYikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnRlbnQuY29udGVudEJsb2IgPSBibG9iO1xuICAgICAgICAgICAgICAgIHRoaXMuYXR0YWNobWVudENsaWNrLmVtaXQoY29udGVudCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZXJyb3IuZW1pdChlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIGRvd25sb2FkQ29udGVudChjb250ZW50OiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5hY3Rpdml0aUNvbnRlbnRTZXJ2aWNlLmdldEZpbGVSYXdDb250ZW50KGNvbnRlbnQuaWQpLnN1YnNjcmliZShcbiAgICAgICAgICAgIChibG9iOiBCbG9iKSA9PiB0aGlzLmNvbnRlbnRTZXJ2aWNlLmRvd25sb2FkQmxvYihibG9iLCBjb250ZW50Lm5hbWUpLFxuICAgICAgICAgICAgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZXJyb3IuZW1pdChlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIGlzRGlzYWJsZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRpc2FibGVkO1xuICAgIH1cbn1cbiJdfQ==