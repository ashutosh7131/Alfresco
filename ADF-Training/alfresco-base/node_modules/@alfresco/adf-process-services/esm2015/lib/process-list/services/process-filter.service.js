import { AlfrescoApiService } from '@alfresco/adf-core';
import { Injectable } from '@angular/core';
import { Observable, from, forkJoin, throwError } from 'rxjs';
import { FilterProcessRepresentationModel } from '../models/filter-process.model';
import { map, catchError } from 'rxjs/operators';
import { UserFiltersApi } from '@alfresco/js-api';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
export class ProcessFilterService {
    constructor(alfrescoApiService) {
        this.alfrescoApiService = alfrescoApiService;
    }
    get userFiltersApi() {
        var _a;
        this._userFiltersApi = (_a = this._userFiltersApi) !== null && _a !== void 0 ? _a : new UserFiltersApi(this.alfrescoApiService.getInstance());
        return this._userFiltersApi;
    }
    getProcessFilters(appId) {
        return from(this.callApiProcessFilters(appId))
            .pipe(map((response) => {
            const filters = [];
            response.data.forEach((filter) => {
                const filterModel = new FilterProcessRepresentationModel(filter);
                filters.push(filterModel);
            });
            return filters;
        }), catchError((err) => this.handleProcessError(err)));
    }
    getProcessFilterById(filterId, appId) {
        return from(this.callApiProcessFilters(appId))
            .pipe(map((response) => {
            return response.data.find((filter) => filter.id === filterId);
        }), catchError((err) => this.handleProcessError(err)));
    }
    getProcessFilterByName(filterName, appId) {
        return from(this.callApiProcessFilters(appId))
            .pipe(map((response) => {
            return response.data.find((filter) => filter.name === filterName);
        }), catchError((err) => this.handleProcessError(err)));
    }
    createDefaultFilters(appId) {
        const runningFilter = this.getRunningFilterInstance(appId, 0);
        const runningObservable = this.addProcessFilter(runningFilter);
        const completedFilter = this.getCompletedFilterInstance(appId, 1);
        const completedObservable = this.addProcessFilter(completedFilter);
        const allFilter = this.getAllFilterInstance(appId, 2);
        const allObservable = this.addProcessFilter(allFilter);
        return new Observable((observer) => {
            forkJoin([
                runningObservable,
                completedObservable,
                allObservable
            ]).subscribe((res) => {
                const filters = [];
                res.forEach((filter) => {
                    if (filter.name === runningFilter.name) {
                        filters.push(new FilterProcessRepresentationModel(Object.assign(Object.assign({}, filter), { filter: runningFilter.filter, appId })));
                    }
                    else if (filter.name === completedFilter.name) {
                        filters.push(new FilterProcessRepresentationModel(Object.assign(Object.assign({}, filter), { filter: completedFilter.filter, appId })));
                    }
                    else if (filter.name === allFilter.name) {
                        filters.push(new FilterProcessRepresentationModel(Object.assign(Object.assign({}, filter), { filter: allFilter.filter, appId })));
                    }
                });
                observer.next(filters);
                observer.complete();
            }, (err) => {
                this.handleProcessError(err);
            });
        });
    }
    getRunningFilterInstance(appId, index) {
        return new FilterProcessRepresentationModel({
            'name': 'Running',
            'appId': appId,
            'recent': true,
            'icon': 'glyphicon-random',
            'filter': { 'sort': 'created-desc', 'name': '', 'state': 'running' },
            index
        });
    }
    getCompletedFilterInstance(appId, index) {
        return new FilterProcessRepresentationModel({
            'name': 'Completed',
            'appId': appId,
            'recent': false,
            'icon': 'glyphicon-ok-sign',
            'filter': { 'sort': 'created-desc', 'name': '', 'state': 'completed' },
            index
        });
    }
    getAllFilterInstance(appId, index) {
        return new FilterProcessRepresentationModel({
            'name': 'All',
            'appId': appId,
            'recent': true,
            'icon': 'glyphicon-th',
            'filter': { 'sort': 'created-desc', 'name': '', 'state': 'all' },
            index
        });
    }
    addProcessFilter(filter) {
        return from(this.userFiltersApi.createUserProcessInstanceFilter(filter))
            .pipe(map((response) => {
            return response;
        }), catchError((err) => this.handleProcessError(err)));
    }
    callApiProcessFilters(appId) {
        if (appId) {
            return this.userFiltersApi.getUserProcessInstanceFilters({ appId: appId });
        }
        else {
            return this.userFiltersApi.getUserProcessInstanceFilters();
        }
    }
    handleProcessError(error) {
        return throwError(error || 'Server error');
    }
}
ProcessFilterService.ɵfac = function ProcessFilterService_Factory(t) { return new (t || ProcessFilterService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService)); };
ProcessFilterService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ProcessFilterService_Factory() { return new ProcessFilterService(i0.ɵɵinject(i1.AlfrescoApiService)); }, token: ProcessFilterService, providedIn: "root" });
ProcessFilterService.ctorParameters = () => [
    { type: AlfrescoApiService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ProcessFilterService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy1maWx0ZXIuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL3Byb2Nlc3Mtc2VydmljZXMvc3JjL2xpYi9wcm9jZXNzLWxpc3Qvc2VydmljZXMvcHJvY2Vzcy1maWx0ZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFpQkEsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDeEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzlELE9BQU8sRUFBRSxnQ0FBZ0MsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ2xGLE9BQU8sRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDakQsT0FBTyxFQUVILGNBQWMsRUFDakIsTUFBTSxrQkFBa0IsQ0FBQztBQUMxQjtBQUVzQjs7O0FBRXRCLE1BQU0sT0FBTyxvQkFBb0I7QUFDakMsSUFPSSxZQUFvQixrQkFBc0M7QUFDOUQsUUFEd0IsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtBQUFDLElBQzNELENBQUM7QUFDTCxJQVBJLElBQUksY0FBYztBQUFLO0FBQzNCLFFBQVEsSUFBSSxDQUFDLGVBQWUsU0FBRyxJQUFJLENBQUMsZUFBZSxtQ0FBSSxJQUFJLGNBQWMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztBQUNqSCxRQUFRLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQztBQUNwQyxJQUFJLENBQUM7QUFDTCxJQVNJLGlCQUFpQixDQUFDLEtBQWE7QUFBSSxRQUMvQixPQUFPLElBQUks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IENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBmcm9tLCBmb3JrSm9pbiwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgRmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWwgfSBmcm9tICcuLi9tb2RlbHMvZmlsdGVyLXByb2Nlc3MubW9kZWwnO1xuaW1wb3J0IHsgbWFwLCBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtcbiAgICBSZXN1bHRMaXN0RGF0YVJlcHJlc2VudGF0aW9uVXNlclByb2Nlc3NJbnN0YW5jZUZpbHRlclJlcHJlc2VudGF0aW9uLFxuICAgIFVzZXJGaWx0ZXJzQXBpXG59IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFByb2Nlc3NGaWx0ZXJTZXJ2aWNlIHtcblxuICAgIHByaXZhdGUgX3VzZXJGaWx0ZXJzQXBpO1xuICAgIGdldCB1c2VyRmlsdGVyc0FwaSgpOiBVc2VyRmlsdGVyc0FwaSB7XG4gICAgICAgIHRoaXMuX3VzZXJGaWx0ZXJzQXBpID0gdGhpcy5fdXNlckZpbHRlcnNBcGkgPz8gbmV3IFVzZXJGaWx0ZXJzQXBpKHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy5fdXNlckZpbHRlcnNBcGk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhbGZyZXNjb0FwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSkge1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYWxsIGZpbHRlcnMgZGVmaW5lZCBmb3IgYSBQcm9jZXNzIEFwcC5cbiAgICAgKiBAcGFyYW0gYXBwSWQgSUQgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBmaWx0ZXIgZGV0YWlsc1xuICAgICAqL1xuICAgIGdldFByb2Nlc3NGaWx0ZXJzKGFwcElkOiBudW1iZXIpOiBPYnNlcnZhYmxlPEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsW10+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5jYWxsQXBpUHJvY2Vzc0ZpbHRlcnMoYXBwSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXJzOiBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbFtdID0gW107XG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZm9yRWFjaCgoZmlsdGVyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXJNb2RlbCA9IG5ldyBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbChmaWx0ZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVycy5wdXNoKGZpbHRlck1vZGVsKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXJzO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0cmlldmVzIHRoZSBwcm9jZXNzIGZpbHRlciBieSBJRC5cbiAgICAgKiBAcGFyYW0gZmlsdGVySWQgSUQgb2YgdGhlIGZpbHRlclxuICAgICAqIEBwYXJhbSBhcHBJZCBJRCBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIERldGFpbHMgb2YgdGhlIGZpbHRlclxuICAgICAqL1xuICAgIGdldFByb2Nlc3NGaWx0ZXJCeUlkKGZpbHRlcklkOiBudW1iZXIsIGFwcElkPzogbnVtYmVyKTogT2JzZXJ2YWJsZTxGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbD4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmNhbGxBcGlQcm9jZXNzRmlsdGVycyhhcHBJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGEuZmluZCgoZmlsdGVyKSA9PiBmaWx0ZXIuaWQgPT09IGZpbHRlcklkKTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHJpZXZlcyB0aGUgcHJvY2VzcyBmaWx0ZXIgYnkgbmFtZS5cbiAgICAgKiBAcGFyYW0gZmlsdGVyTmFtZSBOYW1lIG9mIHRoZSBmaWx0ZXJcbiAgICAgKiBAcGFyYW0gYXBwSWQgSUQgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcmV0dXJucyBEZXRhaWxzIG9mIHRoZSBmaWx0ZXJcbiAgICAgKi9cbiAgICBnZXRQcm9jZXNzRmlsdGVyQnlOYW1lKGZpbHRlck5hbWU6IHN0cmluZywgYXBwSWQ/OiBudW1iZXIpOiBPYnNlcnZhYmxlPEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaVByb2Nlc3NGaWx0ZXJzKGFwcElkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS5maW5kKChmaWx0ZXIpID0+IGZpbHRlci5uYW1lID09PSBmaWx0ZXJOYW1lKTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYW5kIHJldHVybnMgdGhlIGRlZmF1bHQgZmlsdGVycyBmb3IgYW4gYXBwLlxuICAgICAqIEBwYXJhbSBhcHBJZCBJRCBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIERlZmF1bHQgZmlsdGVycyBqdXN0IGNyZWF0ZWRcbiAgICAgKi9cbiAgICBwdWJsaWMgY3JlYXRlRGVmYXVsdEZpbHRlcnMoYXBwSWQ6IG51bWJlcik6IE9ic2VydmFibGU8RmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWxbXT4ge1xuICAgICAgICBjb25zdCBydW5uaW5nRmlsdGVyID0gdGhpcy5nZXRSdW5uaW5nRmlsdGVySW5zdGFuY2UoYXBwSWQsIDApO1xuICAgICAgICBjb25zdCBydW5uaW5nT2JzZXJ2YWJsZSA9IHRoaXMuYWRkUHJvY2Vzc0ZpbHRlcihydW5uaW5nRmlsdGVyKTtcblxuICAgICAgICBjb25zdCBjb21wbGV0ZWRGaWx0ZXIgPSB0aGlzLmdldENvbXBsZXRlZEZpbHRlckluc3RhbmNlKGFwcElkLCAxKTtcbiAgICAgICAgY29uc3QgY29tcGxldGVkT2JzZXJ2YWJsZSA9IHRoaXMuYWRkUHJvY2Vzc0ZpbHRlcihjb21wbGV0ZWRGaWx0ZXIpO1xuXG4gICAgICAgIGNvbnN0IGFsbEZpbHRlciA9IHRoaXMuZ2V0QWxsRmlsdGVySW5zdGFuY2UoYXBwSWQsIDIpO1xuICAgICAgICBjb25zdCBhbGxPYnNlcnZhYmxlID0gdGhpcy5hZGRQcm9jZXNzRmlsdGVyKGFsbEZpbHRlcik7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKChvYnNlcnZlcikgPT4ge1xuICAgICAgICAgICAgZm9ya0pvaW4oW1xuICAgICAgICAgICAgICAgICAgICBydW5uaW5nT2JzZXJ2YWJsZSxcbiAgICAgICAgICAgICAgICAgICAgY29tcGxldGVkT2JzZXJ2YWJsZSxcbiAgICAgICAgICAgICAgICAgICAgYWxsT2JzZXJ2YWJsZVxuICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIChyZXMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyczogRmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWxbXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICByZXMuZm9yRWFjaCgoZmlsdGVyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyLm5hbWUgPT09IHJ1bm5pbmdGaWx0ZXIubmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcnMucHVzaChuZXcgRmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWwoeyAuLi5maWx0ZXIsIGZpbHRlcjogcnVubmluZ0ZpbHRlci5maWx0ZXIsIGFwcElkIH0pKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyLm5hbWUgPT09IGNvbXBsZXRlZEZpbHRlci5uYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVycy5wdXNoKG5ldyBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbCh7IC4uLmZpbHRlciwgZmlsdGVyOiBjb21wbGV0ZWRGaWx0ZXIuZmlsdGVyLCBhcHBJZCB9KSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZpbHRlci5uYW1lID09PSBhbGxGaWx0ZXIubmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcnMucHVzaChuZXcgRmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWwoeyAuLi5maWx0ZXIsIGZpbHRlcjogYWxsRmlsdGVyLmZpbHRlciwgYXBwSWQgfSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChmaWx0ZXJzKTtcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIChlcnI6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGFuZCByZXR1cm5zIGEgZmlsdGVyIHRoYXQgbWF0Y2hlcyBcInJ1bm5pbmdcIiBwcm9jZXNzIGluc3RhbmNlcy5cbiAgICAgKiBAcGFyYW0gYXBwSWQgSUQgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcGFyYW0gaW5kZXggb2YgdGhlIGZpbHRlciAob3B0aW9uYWwpXG4gICAgICogQHJldHVybnMgRmlsdGVyIGp1c3QgY3JlYXRlZFxuICAgICAqL1xuICAgIHB1YmxpYyBnZXRSdW5uaW5nRmlsdGVySW5zdGFuY2UoYXBwSWQ6IG51bWJlciwgaW5kZXg/OiBudW1iZXIpOiBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbCB7XG4gICAgICAgIHJldHVybiAgbmV3IEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsKHtcbiAgICAgICAgICAgICduYW1lJzogJ1J1bm5pbmcnLFxuICAgICAgICAgICAgJ2FwcElkJzogYXBwSWQsXG4gICAgICAgICAgICAncmVjZW50JzogdHJ1ZSxcbiAgICAgICAgICAgICdpY29uJzogJ2dseXBoaWNvbi1yYW5kb20nLFxuICAgICAgICAgICAgJ2ZpbHRlcic6IHsgJ3NvcnQnOiAnY3JlYXRlZC1kZXNjJywgJ25hbWUnOiAnJywgJ3N0YXRlJzogJ3J1bm5pbmcnIH0sXG4gICAgICAgICAgICBpbmRleFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIGEgc3RhdGljIENvbXBsZXRlZCBmaWx0ZXIgaW5zdGFuY2UuXG4gICAgICogQHBhcmFtIGFwcElkIElEIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHBhcmFtIGluZGV4IG9mIHRoZSBmaWx0ZXIgKG9wdGlvbmFsKVxuICAgICAqIEByZXR1cm5zIERldGFpbHMgb2YgdGhlIGZpbHRlclxuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0Q29tcGxldGVkRmlsdGVySW5zdGFuY2UoYXBwSWQ6IG51bWJlciwgaW5kZXg/OiBudW1iZXIpOiBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbCB7XG4gICAgICAgIHJldHVybiBuZXcgRmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWwoe1xuICAgICAgICAgICAgJ25hbWUnOiAnQ29tcGxldGVkJyxcbiAgICAgICAgICAgICdhcHBJZCc6IGFwcElkLFxuICAgICAgICAgICAgJ3JlY2VudCc6IGZhbHNlLFxuICAgICAgICAgICAgJ2ljb24nOiAnZ2x5cGhpY29uLW9rLXNpZ24nLFxuICAgICAgICAgICAgJ2ZpbHRlcic6IHsgJ3NvcnQnOiAnY3JlYXRlZC1kZXNjJywgJ25hbWUnOiAnJywgJ3N0YXRlJzogJ2NvbXBsZXRlZCcgfSxcbiAgICAgICAgICAgIGluZGV4XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgYSBzdGF0aWMgQWxsIGZpbHRlciBpbnN0YW5jZS5cbiAgICAgKiBAcGFyYW0gYXBwSWQgSUQgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcGFyYW0gaW5kZXggb2YgdGhlIGZpbHRlciAob3B0aW9uYWwpXG4gICAgICogQHJldHVybnMgRGV0YWlscyBvZiB0aGUgZmlsdGVyXG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXRBbGxGaWx0ZXJJbnN0YW5jZShhcHBJZDogbnVtYmVyLCBpbmRleD86IG51bWJlcik6IEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsIHtcbiAgICAgICAgcmV0dXJuIG5ldyBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbCh7XG4gICAgICAgICAgICAnbmFtZSc6ICdBbGwnLFxuICAgICAgICAgICAgJ2FwcElkJzogYXBwSWQsXG4gICAgICAgICAgICAncmVjZW50JzogdHJ1ZSxcbiAgICAgICAgICAgICdpY29uJzogJ2dseXBoaWNvbi10aCcsXG4gICAgICAgICAgICAnZmlsdGVyJzogeyAnc29ydCc6ICdjcmVhdGVkLWRlc2MnLCAnbmFtZSc6ICcnLCAnc3RhdGUnOiAnYWxsJyB9LFxuICAgICAgICAgICAgaW5kZXhcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhIGZpbHRlci5cbiAgICAgKiBAcGFyYW0gZmlsdGVyIFRoZSBmaWx0ZXIgdG8gYWRkXG4gICAgICogQHJldHVybnMgVGhlIGZpbHRlciBqdXN0IGFkZGVkXG4gICAgICovXG4gICAgYWRkUHJvY2Vzc0ZpbHRlcihmaWx0ZXI6IEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsKTogT2JzZXJ2YWJsZTxGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbD4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnVzZXJGaWx0ZXJzQXBpLmNyZWF0ZVVzZXJQcm9jZXNzSW5zdGFuY2VGaWx0ZXIoZmlsdGVyKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzcG9uc2U6IEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGxzIGBnZXRVc2VyUHJvY2Vzc0luc3RhbmNlRmlsdGVyc2AgZnJvbSB0aGUgQWxmcmVzY28gSlMgQVBJLlxuICAgICAqIEBwYXJhbSBhcHBJZCBJRCBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIExpc3Qgb2YgZmlsdGVyIGRldGFpbHNcbiAgICAgKi9cbiAgICBjYWxsQXBpUHJvY2Vzc0ZpbHRlcnMoYXBwSWQ/OiBudW1iZXIpOiBQcm9taXNlPFJlc3VsdExpc3REYXRhUmVwcmVzZW50YXRpb25Vc2VyUHJvY2Vzc0luc3RhbmNlRmlsdGVyUmVwcmVzZW50YXRpb24+IHtcbiAgICAgICAgaWYgKGFwcElkKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy51c2VyRmlsdGVyc0FwaS5nZXRVc2VyUHJvY2Vzc0luc3RhbmNlRmlsdGVycyh7IGFwcElkOiBhcHBJZCB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnVzZXJGaWx0ZXJzQXBpLmdldFVzZXJQcm9jZXNzSW5zdGFuY2VGaWx0ZXJzKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZVByb2Nlc3NFcnJvcihlcnJvcjogYW55KSB7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yIHx8ICdTZXJ2ZXIgZXJyb3InKTtcbiAgICB9XG59XG4iXX0=