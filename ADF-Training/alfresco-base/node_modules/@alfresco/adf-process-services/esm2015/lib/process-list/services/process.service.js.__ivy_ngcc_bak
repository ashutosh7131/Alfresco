import { AlfrescoApiService } from '@alfresco/adf-core';
import { Injectable } from '@angular/core';
import { TasksApi, ProcessDefinitionsApi, ProcessInstancesApi, ProcessInstanceVariablesApi } from '@alfresco/js-api';
import { from, throwError, of } from 'rxjs';
import { ProcessDefinitionRepresentation } from '../models/process-definition.model';
import { ProcessInstanceVariable } from '../models/process-instance-variable.model';
import { ProcessInstance } from '../models/process-instance.model';
import { ProcessListModel } from '../models/process-list.model';
import { map, catchError } from 'rxjs/operators';
import { DatePipe } from '@angular/common';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
export class ProcessService {
    constructor(alfrescoApiService) {
        this.alfrescoApiService = alfrescoApiService;
    }
    get tasksApi() {
        var _a;
        this._tasksApi = (_a = this._tasksApi) !== null && _a !== void 0 ? _a : new TasksApi(this.alfrescoApiService.getInstance());
        return this._tasksApi;
    }
    get processDefinitionsApi() {
        var _a;
        this._processDefinitionsApi = (_a = this._processDefinitionsApi) !== null && _a !== void 0 ? _a : new ProcessDefinitionsApi(this.alfrescoApiService.getInstance());
        return this._processDefinitionsApi;
    }
    get processInstancesApi() {
        var _a;
        this._processInstancesApi = (_a = this._processInstancesApi) !== null && _a !== void 0 ? _a : new ProcessInstancesApi(this.alfrescoApiService.getInstance());
        return this._processInstancesApi;
    }
    get processInstanceVariablesApi() {
        var _a;
        this._processInstanceVariablesApi = (_a = this._processInstanceVariablesApi) !== null && _a !== void 0 ? _a : new ProcessInstanceVariablesApi(this.alfrescoApiService.getInstance());
        return this._processInstanceVariablesApi;
    }
    getProcessInstances(requestNode, processDefinitionKey) {
        return from(this.processInstancesApi.getProcessInstances(requestNode))
            .pipe(map((res) => {
            if (processDefinitionKey) {
                const filtered = res.data.filter((process) => process.processDefinitionKey === processDefinitionKey);
                res.data = filtered;
                return res;
            }
            else {
                return res;
            }
        }), catchError((err) => this.handleProcessError(err)));
    }
    getProcesses(requestNode, processDefinitionKey) {
        return this.getProcessInstances(requestNode, processDefinitionKey)
            .pipe(map(response => {
            return Object.assign(Object.assign({}, response), { data: (response.data || []).map(instance => {
                    instance.name = this.getProcessNameOrDescription(instance, 'medium');
                    return instance;
                }) });
        }), catchError(() => of(new ProcessListModel({}))));
    }
    getProcessNameOrDescription(processInstance, dateFormat) {
        let name = '';
        if (processInstance) {
            name = processInstance.name ||
                processInstance.processDefinitionName + ' - ' + this.getFormatDate(processInstance.started, dateFormat);
        }
        return name;
    }
    getFormatDate(value, format) {
        const datePipe = new DatePipe('en-US');
        try {
            return datePipe.transform(value, format);
        }
        catch (err) {
            return '';
        }
    }
    fetchProcessAuditPdfById(processId) {
        return from(this.processInstancesApi.getProcessAuditPdf(processId))
            .pipe(catchError((err) => this.handleProcessError(err)));
    }
    fetchProcessAuditJsonById(processId) {
        return from(this.processInstancesApi.getTaskAuditLog(processId))
            .pipe(catchError((err) => this.handleProcessError(err)));
    }
    getProcess(processInstanceId) {
        return from(this.processInstancesApi.getProcessInstance(processInstanceId))
            .pipe(catchError((err) => this.handleProcessError(err)));
    }
    getProcessTasks(processInstanceId, state) {
        const taskOpts = state ? {
            processInstanceId: processInstanceId,
            state: state
        } : {
            processInstanceId: processInstanceId
        };
        return from(this.tasksApi.listTasks(taskOpts))
            .pipe(map(this.extractData), map((tasks) => tasks.map((task) => {
            task.created = moment(task.created, 'YYYY-MM-DD').format();
            return task;
        })), catchError((err) => this.handleProcessError(err)));
    }
    getProcessDefinitions(appId) {
        const opts = appId ? {
            latest: true,
            appDefinitionId: appId
        } : {
            latest: true
        };
        return from(this.processDefinitionsApi.getProcessDefinitions(opts))
            .pipe(map(this.extractData), map((processDefs) => processDefs.map((pd) => new ProcessDefinitionRepresentation(pd))), catchError((err) => this.handleProcessError(err)));
    }
    startProcess(processDefinitionId, name, outcome, startFormValues, variables) {
        const startRequest = {
            name: name,
            processDefinitionId: processDefinitionId
        };
        if (outcome) {
            startRequest.outcome = outcome;
        }
        if (startFormValues) {
            startRequest.values = startFormValues;
        }
        if (variables) {
            startRequest.variables = variables;
        }
        return from(this.processInstancesApi.startNewProcessInstance(startRequest))
            .pipe(map((pd) => new ProcessInstance(pd)), catchError((err) => this.handleProcessError(err)));
    }
    cancelProcess(processInstanceId) {
        return from(this.processInstancesApi.deleteProcessInstance(processInstanceId))
            .pipe(catchError((err) => this.handleProcessError(err)));
    }
    getProcessInstanceVariables(processInstanceId) {
        return from(this.processInstanceVariablesApi.getProcessInstanceVariables(processInstanceId))
            .pipe(map((processVars) => processVars.map((currentProcessVar) => new ProcessInstanceVariable(currentProcessVar))), catchError((err) => this.handleProcessError(err)));
    }
    createOrUpdateProcessInstanceVariables(processInstanceId, variables) {
        return from(this.processInstanceVariablesApi.createOrUpdateProcessInstanceVariables(processInstanceId, variables)).pipe(catchError((err) => this.handleProcessError(err)));
    }
    deleteProcessInstanceVariable(processInstanceId, variableName) {
        return from(this.processInstanceVariablesApi.deleteProcessInstanceVariable(processInstanceId, variableName))
            .pipe(catchError((err) => this.handleProcessError(err)));
    }
    extractData(res) {
        return res.data || {};
    }
    handleProcessError(error) {
        return throwError(error || 'Server error');
    }
}
ProcessService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ProcessService_Factory() { return new ProcessService(i0.ɵɵinject(i1.AlfrescoApiService)); }, token: ProcessService, providedIn: "root" });
ProcessService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
ProcessService.ctorParameters = () => [
    { type: AlfrescoApiService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvcHJvY2Vzcy1zZXJ2aWNlcy9zcmMvIiwic291cmNlcyI6WyJsaWIvcHJvY2Vzcy1saXN0L3NlcnZpY2VzL3Byb2Nlc3Muc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFpQkEsT0FBTyxFQUFFLGtCQUFrQixFQUFjLE1BQU0sb0JBQW9CLENBQUM7QUFDcEUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQ0gsUUFBUSxFQUNSLHFCQUFxQixFQUNyQixtQkFBbUIsRUFHbkIsMkJBQTJCLEVBQzlCLE1BQU0sa0JBQWtCLENBQUM7QUFDMUIsT0FBTyxFQUFjLElBQUksRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBR3hELE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQ3JGLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDJDQUEyQyxDQUFDO0FBQ3BGLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUNuRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7O0FBTzNDLE1BQU0sT0FBTyxjQUFjO0lBMEJ2QixZQUFvQixrQkFBc0M7UUFBdEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtJQUMxRCxDQUFDO0lBeEJELElBQUksUUFBUTs7UUFDUixJQUFJLENBQUMsU0FBUyxTQUFHLElBQUksQ0FBQyxTQUFTLG1DQUFJLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxrQkFBa0Is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blJKLFVBQVUsU0FBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQjs7O1lBeEJRLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSwgRm9ybVZhbHVlcyB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICAgIFRhc2tzQXBpLFxuICAgIFByb2Nlc3NEZWZpbml0aW9uc0FwaSxcbiAgICBQcm9jZXNzSW5zdGFuY2VzQXBpLFxuICAgIFJlc3RWYXJpYWJsZSxcbiAgICBQcm9jZXNzSW5zdGFuY2VSZXByZXNlbnRhdGlvbixcbiAgICBQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXNBcGlcbn0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBmcm9tLCB0aHJvd0Vycm9yLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgVGFza0RldGFpbHNNb2RlbCB9IGZyb20gJy4uLy4uL3Rhc2stbGlzdCc7XG5pbXBvcnQgeyBQcm9jZXNzRmlsdGVyUGFyYW1SZXByZXNlbnRhdGlvbk1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL2ZpbHRlci1wcm9jZXNzLm1vZGVsJztcbmltcG9ydCB7IFByb2Nlc3NEZWZpbml0aW9uUmVwcmVzZW50YXRpb24gfSBmcm9tICcuLi9tb2RlbHMvcHJvY2Vzcy1kZWZpbml0aW9uLm1vZGVsJztcbmltcG9ydCB7IFByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlIH0gZnJvbSAnLi4vbW9kZWxzL3Byb2Nlc3MtaW5zdGFuY2UtdmFyaWFibGUubW9kZWwnO1xuaW1wb3J0IHsgUHJvY2Vzc0luc3RhbmNlIH0gZnJvbSAnLi4vbW9kZWxzL3Byb2Nlc3MtaW5zdGFuY2UubW9kZWwnO1xuaW1wb3J0IHsgUHJvY2Vzc0xpc3RNb2RlbCB9IGZyb20gJy4uL21vZGVscy9wcm9jZXNzLWxpc3QubW9kZWwnO1xuaW1wb3J0IHsgbWFwLCBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRGF0ZVBpcGUgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuXG5kZWNsYXJlIGxldCBtb21lbnQ6IGFueTtcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBQcm9jZXNzU2VydmljZSB7XG5cbiAgICBwcml2YXRlIF90YXNrc0FwaTtcbiAgICBnZXQgdGFza3NBcGkoKTogVGFza3NBcGkge1xuICAgICAgICB0aGlzLl90YXNrc0FwaSA9IHRoaXMuX3Rhc2tzQXBpID8/IG5ldyBUYXNrc0FwaSh0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5nZXRJbnN0YW5jZSgpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Rhc2tzQXBpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3Byb2Nlc3NEZWZpbml0aW9uc0FwaTtcbiAgICBnZXQgcHJvY2Vzc0RlZmluaXRpb25zQXBpKCk6IFByb2Nlc3NEZWZpbml0aW9uc0FwaSB7XG4gICAgICAgIHRoaXMuX3Byb2Nlc3NEZWZpbml0aW9uc0FwaSA9IHRoaXMuX3Byb2Nlc3NEZWZpbml0aW9uc0FwaSA/PyBuZXcgUHJvY2Vzc0RlZmluaXRpb25zQXBpKHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy5fcHJvY2Vzc0RlZmluaXRpb25zQXBpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3Byb2Nlc3NJbnN0YW5jZXNBcGk7XG4gICAgZ2V0IHByb2Nlc3NJbnN0YW5jZXNBcGkoKTogUHJvY2Vzc0luc3RhbmNlc0FwaSB7XG4gICAgICAgIHRoaXMuX3Byb2Nlc3NJbnN0YW5jZXNBcGkgPSB0aGlzLl9wcm9jZXNzSW5zdGFuY2VzQXBpID8/IG5ldyBQcm9jZXNzSW5zdGFuY2VzQXBpKHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy5fcHJvY2Vzc0luc3RhbmNlc0FwaTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9wcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXNBcGk7XG4gICAgZ2V0IHByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlc0FwaSgpOiBQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXNBcGkge1xuICAgICAgICB0aGlzLl9wcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXNBcGkgPSB0aGlzLl9wcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXNBcGkgPz8gbmV3IFByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlc0FwaSh0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5nZXRJbnN0YW5jZSgpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2Nlc3NJbnN0YW5jZVZhcmlhYmxlc0FwaTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFsZnJlc2NvQXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBwcm9jZXNzIGluc3RhbmNlcyBmb3IgYSBmaWx0ZXIgYW5kIG9wdGlvbmFsbHkgYSBwcm9jZXNzIGRlZmluaXRpb24uXG4gICAgICogQHBhcmFtIHJlcXVlc3ROb2RlIEZpbHRlciBmb3IgaW5zdGFuY2VzXG4gICAgICogQHBhcmFtIHByb2Nlc3NEZWZpbml0aW9uS2V5IExpbWl0cyByZXR1cm5lZCBpbnN0YW5jZXMgdG8gYSBwcm9jZXNzIGRlZmluaXRpb25cbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIHByb2Nlc3MgaW5zdGFuY2VzXG4gICAgICovXG4gICAgZ2V0UHJvY2Vzc0luc3RhbmNlcyhyZXF1ZXN0Tm9kZTogUHJvY2Vzc0ZpbHRlclBhcmFtUmVwcmVzZW50YXRpb25Nb2RlbCwgcHJvY2Vzc0RlZmluaXRpb25LZXk/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFByb2Nlc3NMaXN0TW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5wcm9jZXNzSW5zdGFuY2VzQXBpLmdldFByb2Nlc3NJbnN0YW5jZXMocmVxdWVzdE5vZGUpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXM6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJvY2Vzc0RlZmluaXRpb25LZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbHRlcmVkID0gcmVzLmRhdGEuZmlsdGVyKChwcm9jZXNzKSA9PiBwcm9jZXNzLnByb2Nlc3NEZWZpbml0aW9uS2V5ID09PSBwcm9jZXNzRGVmaW5pdGlvbktleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXMuZGF0YSA9IGZpbHRlcmVkO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcztcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXM7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgcHJvY2Vzc2VzIGZvciBhIGZpbHRlciBhbmQgb3B0aW9uYWxseSBhIHByb2Nlc3MgZGVmaW5pdGlvbi5cbiAgICAgKiBAcGFyYW0gcmVxdWVzdE5vZGUgRmlsdGVyIGZvciBpbnN0YW5jZXNcbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0RlZmluaXRpb25LZXkgTGltaXRzIHJldHVybmVkIGluc3RhbmNlcyB0byBhIHByb2Nlc3MgZGVmaW5pdGlvblxuICAgICAqIEByZXR1cm5zIExpc3Qgb2YgcHJvY2Vzc2VzXG4gICAgICovXG4gICAgZ2V0UHJvY2Vzc2VzKHJlcXVlc3ROb2RlOiBQcm9jZXNzRmlsdGVyUGFyYW1SZXByZXNlbnRhdGlvbk1vZGVsLCBwcm9jZXNzRGVmaW5pdGlvbktleT86IHN0cmluZyk6IE9ic2VydmFibGU8UHJvY2Vzc0xpc3RNb2RlbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRQcm9jZXNzSW5zdGFuY2VzKHJlcXVlc3ROb2RlLCBwcm9jZXNzRGVmaW5pdGlvbktleSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcChyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5yZXNwb25zZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IChyZXNwb25zZS5kYXRhIHx8IFtdKS5tYXAoaW5zdGFuY2UgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLm5hbWUgPSB0aGlzLmdldFByb2Nlc3NOYW1lT3JEZXNjcmlwdGlvbihpbnN0YW5jZSwgJ21lZGl1bScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBvZihuZXcgUHJvY2Vzc0xpc3RNb2RlbCh7fSkpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFByb2Nlc3NOYW1lT3JEZXNjcmlwdGlvbihwcm9jZXNzSW5zdGFuY2U6IFByb2Nlc3NJbnN0YW5jZVJlcHJlc2VudGF0aW9uLCBkYXRlRm9ybWF0OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBsZXQgbmFtZSA9ICcnO1xuXG4gICAgICAgIGlmIChwcm9jZXNzSW5zdGFuY2UpIHtcbiAgICAgICAgICAgIG5hbWUgPSBwcm9jZXNzSW5zdGFuY2UubmFtZSB8fFxuICAgICAgICAgICAgICAgIHByb2Nlc3NJbnN0YW5jZS5wcm9jZXNzRGVmaW5pdGlvbk5hbWUgKyAnIC0gJyArIHRoaXMuZ2V0Rm9ybWF0RGF0ZShwcm9jZXNzSW5zdGFuY2Uuc3RhcnRlZCwgZGF0ZUZvcm1hdCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmFtZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEZvcm1hdERhdGUodmFsdWU6IERhdGUsIGZvcm1hdDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGRhdGVQaXBlID0gbmV3IERhdGVQaXBlKCdlbi1VUycpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXR1cm4gZGF0ZVBpcGUudHJhbnNmb3JtKHZhbHVlLCBmb3JtYXQpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZldGNoZXMgdGhlIFByb2Nlc3MgQXVkaXQgaW5mb3JtYXRpb24gYXMgYSBQREYuXG4gICAgICogQHBhcmFtIHByb2Nlc3NJZCBJRCBvZiB0aGUgdGFyZ2V0IHByb2Nlc3NcbiAgICAgKiBAcmV0dXJucyBCaW5hcnkgUERGIGRhdGFcbiAgICAgKi9cbiAgICBmZXRjaFByb2Nlc3NBdWRpdFBkZkJ5SWQocHJvY2Vzc0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEJsb2I+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5wcm9jZXNzSW5zdGFuY2VzQXBpLmdldFByb2Nlc3NBdWRpdFBkZihwcm9jZXNzSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGZXRjaGVzIHRoZSBQcm9jZXNzIEF1ZGl0IGluZm9ybWF0aW9uIGluIGEgSlNPTiBmb3JtYXQuXG4gICAgICogQHBhcmFtIHByb2Nlc3NJZCBJRCBvZiB0aGUgdGFyZ2V0IHByb2Nlc3NcbiAgICAgKiBAcmV0dXJucyBKU09OIGRhdGFcbiAgICAgKi9cbiAgICBmZXRjaFByb2Nlc3NBdWRpdEpzb25CeUlkKHByb2Nlc3NJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5wcm9jZXNzSW5zdGFuY2VzQXBpLmdldFRhc2tBdWRpdExvZyhwcm9jZXNzSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIFByb2Nlc3MgSW5zdGFuY2UgbWV0YWRhdGEuXG4gICAgICogQHBhcmFtIHByb2Nlc3NJbnN0YW5jZUlkIElEIG9mIHRoZSB0YXJnZXQgcHJvY2Vzc1xuICAgICAqIEByZXR1cm5zIE1ldGFkYXRhIGZvciB0aGUgaW5zdGFuY2VcbiAgICAgKi9cbiAgICBnZXRQcm9jZXNzKHByb2Nlc3NJbnN0YW5jZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFByb2Nlc3NJbnN0YW5jZT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnByb2Nlc3NJbnN0YW5jZXNBcGkuZ2V0UHJvY2Vzc0luc3RhbmNlKHByb2Nlc3NJbnN0YW5jZUlkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0YXNrIGluc3RhbmNlcyBmb3IgYSBwcm9jZXNzIGluc3RhbmNlLlxuICAgICAqIEBwYXJhbSBwcm9jZXNzSW5zdGFuY2VJZCBJRCBvZiB0aGUgcHJvY2VzcyBpbnN0YW5jZVxuICAgICAqIEBwYXJhbSBzdGF0ZSBUYXNrIHN0YXRlIGZpbHRlciAoY2FuIGJlIFwiYWN0aXZlXCIgb3IgXCJjb21wbGV0ZWRcIilcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiB0YXNrIGluc3RhbmNlIGRldGFpbHNcbiAgICAgKi9cbiAgICBnZXRQcm9jZXNzVGFza3MocHJvY2Vzc0luc3RhbmNlSWQ6IHN0cmluZywgc3RhdGU/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzTW9kZWxbXT4ge1xuICAgICAgICBjb25zdCB0YXNrT3B0cyA9IHN0YXRlID8ge1xuICAgICAgICAgICAgcHJvY2Vzc0luc3RhbmNlSWQ6IHByb2Nlc3NJbnN0YW5jZUlkLFxuICAgICAgICAgICAgc3RhdGU6IHN0YXRlXG4gICAgICAgIH0gOiB7XG4gICAgICAgICAgICBwcm9jZXNzSW5zdGFuY2VJZDogcHJvY2Vzc0luc3RhbmNlSWRcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy50YXNrc0FwaS5saXN0VGFza3ModGFza09wdHMpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKHRoaXMuZXh0cmFjdERhdGEpLFxuICAgICAgICAgICAgICAgIG1hcCgodGFza3MpID0+IHRhc2tzLm1hcCgodGFzazogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRhc2suY3JlYXRlZCA9IG1vbWVudCh0YXNrLmNyZWF0ZWQsICdZWVlZLU1NLUREJykuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXNrO1xuICAgICAgICAgICAgICAgIH0pKSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgcHJvY2VzcyBkZWZpbml0aW9ucyBhc3NvY2lhdGVkIHdpdGggYW4gYXBwLlxuICAgICAqIEBwYXJhbSBhcHBJZCBJRCBvZiBhIHRhcmdldCBhcHBcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBwcm9jZXNzIGRlZmluaXRpb25zXG4gICAgICovXG4gICAgZ2V0UHJvY2Vzc0RlZmluaXRpb25zKGFwcElkPzogbnVtYmVyKTogT2JzZXJ2YWJsZTxQcm9jZXNzRGVmaW5pdGlvblJlcHJlc2VudGF0aW9uW10+IHtcbiAgICAgICAgY29uc3Qgb3B0cyA9IGFwcElkID8ge1xuICAgICAgICAgICAgbGF0ZXN0OiB0cnVlLFxuICAgICAgICAgICAgYXBwRGVmaW5pdGlvbklkOiBhcHBJZFxuICAgICAgICB9IDoge1xuICAgICAgICAgICAgbGF0ZXN0OiB0cnVlXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBmcm9tKFxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzRGVmaW5pdGlvbnNBcGkuZ2V0UHJvY2Vzc0RlZmluaXRpb25zKG9wdHMpXG4gICAgICAgIClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCh0aGlzLmV4dHJhY3REYXRhKSxcbiAgICAgICAgICAgICAgICBtYXAoKHByb2Nlc3NEZWZzKSA9PiBwcm9jZXNzRGVmcy5tYXAoKHBkKSA9PiBuZXcgUHJvY2Vzc0RlZmluaXRpb25SZXByZXNlbnRhdGlvbihwZCkpKSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0cyBhIHByb2Nlc3MgYmFzZWQgb24gYSBwcm9jZXNzIGRlZmluaXRpb24sIG5hbWUsIGZvcm0gdmFsdWVzIG9yIHZhcmlhYmxlcy5cbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0RlZmluaXRpb25JZCBQcm9jZXNzIGRlZmluaXRpb24gSURcbiAgICAgKiBAcGFyYW0gbmFtZSBQcm9jZXNzIG5hbWVcbiAgICAgKiBAcGFyYW0gb3V0Y29tZSBQcm9jZXNzIG91dGNvbWVcbiAgICAgKiBAcGFyYW0gc3RhcnRGb3JtVmFsdWVzIFZhbHVlcyBmb3IgdGhlIHN0YXJ0IGZvcm1cbiAgICAgKiBAcGFyYW0gdmFyaWFibGVzIEFycmF5IG9mIHByb2Nlc3MgaW5zdGFuY2UgdmFyaWFibGVzXG4gICAgICogQHJldHVybnMgRGV0YWlscyBvZiB0aGUgcHJvY2VzcyBpbnN0YW5jZSBqdXN0IHN0YXJ0ZWRcbiAgICAgKi9cbiAgICBzdGFydFByb2Nlc3MocHJvY2Vzc0RlZmluaXRpb25JZDogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIG91dGNvbWU/OiBzdHJpbmcsIHN0YXJ0Rm9ybVZhbHVlcz86IEZvcm1WYWx1ZXMsIHZhcmlhYmxlcz86IFByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlW10pOiBPYnNlcnZhYmxlPFByb2Nlc3NJbnN0YW5jZT4ge1xuICAgICAgICBjb25zdCBzdGFydFJlcXVlc3Q6IGFueSA9IHtcbiAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICBwcm9jZXNzRGVmaW5pdGlvbklkOiBwcm9jZXNzRGVmaW5pdGlvbklkXG4gICAgICAgIH07XG4gICAgICAgIGlmIChvdXRjb21lKSB7XG4gICAgICAgICAgICBzdGFydFJlcXVlc3Qub3V0Y29tZSA9IG91dGNvbWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHN0YXJ0Rm9ybVZhbHVlcykge1xuICAgICAgICAgICAgc3RhcnRSZXF1ZXN0LnZhbHVlcyA9IHN0YXJ0Rm9ybVZhbHVlcztcbiAgICAgICAgfVxuICAgICAgICBpZiAodmFyaWFibGVzKSB7XG4gICAgICAgICAgICBzdGFydFJlcXVlc3QudmFyaWFibGVzID0gdmFyaWFibGVzO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmcm9tKFxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzSW5zdGFuY2VzQXBpLnN0YXJ0TmV3UHJvY2Vzc0luc3RhbmNlKHN0YXJ0UmVxdWVzdClcbiAgICAgICAgKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChwZCkgPT4gbmV3IFByb2Nlc3NJbnN0YW5jZShwZCkpLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FuY2VscyBhIHByb2Nlc3MgaW5zdGFuY2UuXG4gICAgICogQHBhcmFtIHByb2Nlc3NJbnN0YW5jZUlkIElEIG9mIHByb2Nlc3MgdG8gY2FuY2VsXG4gICAgICogQHJldHVybnMgTnVsbCByZXNwb25zZSBub3RpZnlpbmcgd2hlbiB0aGUgb3BlcmF0aW9uIGlzIGNvbXBsZXRlXG4gICAgICovXG4gICAgY2FuY2VsUHJvY2Vzcyhwcm9jZXNzSW5zdGFuY2VJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBmcm9tKFxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzSW5zdGFuY2VzQXBpLmRlbGV0ZVByb2Nlc3NJbnN0YW5jZShwcm9jZXNzSW5zdGFuY2VJZClcbiAgICAgICAgKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSB2YXJpYWJsZXMgZm9yIGEgcHJvY2VzcyBpbnN0YW5jZS5cbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0luc3RhbmNlSWQgSUQgb2YgdGhlIHRhcmdldCBwcm9jZXNzXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgaW5zdGFuY2UgdmFyaWFibGUgaW5mb1xuICAgICAqL1xuICAgIGdldFByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlcyhwcm9jZXNzSW5zdGFuY2VJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZVtdPiB7XG4gICAgICAgIHJldHVybiBmcm9tKFxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXNBcGkuZ2V0UHJvY2Vzc0luc3RhbmNlVmFyaWFibGVzKHByb2Nlc3NJbnN0YW5jZUlkKVxuICAgICAgICApXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHByb2Nlc3NWYXJzOiBhbnlbXSkgPT4gcHJvY2Vzc1ZhcnMubWFwKChjdXJyZW50UHJvY2Vzc1ZhcikgPT4gbmV3IFByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlKGN1cnJlbnRQcm9jZXNzVmFyKSkpLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBvciB1cGRhdGVzIHZhcmlhYmxlcyBmb3IgYSBwcm9jZXNzIGluc3RhbmNlLlxuICAgICAqIEBwYXJhbSBwcm9jZXNzSW5zdGFuY2VJZCBJRCBvZiB0aGUgdGFyZ2V0IHByb2Nlc3NcbiAgICAgKiBAcGFyYW0gdmFyaWFibGVzIFZhcmlhYmxlcyB0byB1cGRhdGVcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBpbnN0YW5jZSB2YXJpYWJsZSBpbmZvXG4gICAgICovXG4gICAgY3JlYXRlT3JVcGRhdGVQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXMocHJvY2Vzc0luc3RhbmNlSWQ6IHN0cmluZywgdmFyaWFibGVzOiBSZXN0VmFyaWFibGVbXSk6IE9ic2VydmFibGU8UHJvY2Vzc0luc3RhbmNlVmFyaWFibGVbXT4ge1xuICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc0luc3RhbmNlVmFyaWFibGVzQXBpLmNyZWF0ZU9yVXBkYXRlUHJvY2Vzc0luc3RhbmNlVmFyaWFibGVzKHByb2Nlc3NJbnN0YW5jZUlkLCB2YXJpYWJsZXMpXG4gICAgICAgICkucGlwZShcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZWxldGVzIGEgdmFyaWFibGUgZm9yIGEgcHJvY2VzcyBpbnN0YW5jZS5cbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0luc3RhbmNlSWQgSUQgb2YgdGhlIHRhcmdldCBwcm9jZXNzXG4gICAgICogQHBhcmFtIHZhcmlhYmxlTmFtZSBOYW1lIG9mIHRoZSB2YXJpYWJsZSB0byBkZWxldGVcbiAgICAgKiBAcmV0dXJucyBOdWxsIHJlc3BvbnNlIG5vdGlmeWluZyB3aGVuIHRoZSBvcGVyYXRpb24gaXMgY29tcGxldGVcbiAgICAgKi9cbiAgICBkZWxldGVQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZShwcm9jZXNzSW5zdGFuY2VJZDogc3RyaW5nLCB2YXJpYWJsZU5hbWU6IHN0cmluZyk6IE9ic2VydmFibGU8dm9pZD4ge1xuICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc0luc3RhbmNlVmFyaWFibGVzQXBpLmRlbGV0ZVByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlKHByb2Nlc3NJbnN0YW5jZUlkLCB2YXJpYWJsZU5hbWUpXG4gICAgICAgIClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBleHRyYWN0RGF0YShyZXM6IGFueSkge1xuICAgICAgICByZXR1cm4gcmVzLmRhdGEgfHwge307XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVQcm9jZXNzRXJyb3IoZXJyb3I6IGFueSkge1xuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvciB8fCAnU2VydmVyIGVycm9yJyk7XG4gICAgfVxufVxuIl19