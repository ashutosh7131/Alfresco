import { AlfrescoApiService } from '@alfresco/adf-core';
import { Injectable } from '@angular/core';
import { TasksApi, ProcessDefinitionsApi, ProcessInstancesApi, ProcessInstanceVariablesApi } from '@alfresco/js-api';
import { from, throwError, of } from 'rxjs';
import { ProcessDefinitionRepresentation } from '../models/process-definition.model';
import { ProcessInstanceVariable } from '../models/process-instance-variable.model';
import { ProcessInstance } from '../models/process-instance.model';
import { ProcessListModel } from '../models/process-list.model';
import { map, catchError } from 'rxjs/operators';
import { DatePipe } from '@angular/common';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
export class ProcessService {
    constructor(alfrescoApiService) {
        this.alfrescoApiService = alfrescoApiService;
    }
    get tasksApi() {
        var _a;
        this._tasksApi = (_a = this._tasksApi) !== null && _a !== void 0 ? _a : new TasksApi(this.alfrescoApiService.getInstance());
        return this._tasksApi;
    }
    get processDefinitionsApi() {
        var _a;
        this._processDefinitionsApi = (_a = this._processDefinitionsApi) !== null && _a !== void 0 ? _a : new ProcessDefinitionsApi(this.alfrescoApiService.getInstance());
        return this._processDefinitionsApi;
    }
    get processInstancesApi() {
        var _a;
        this._processInstancesApi = (_a = this._processInstancesApi) !== null && _a !== void 0 ? _a : new ProcessInstancesApi(this.alfrescoApiService.getInstance());
        return this._processInstancesApi;
    }
    get processInstanceVariablesApi() {
        var _a;
        this._processInstanceVariablesApi = (_a = this._processInstanceVariablesApi) !== null && _a !== void 0 ? _a : new ProcessInstanceVariablesApi(this.alfrescoApiService.getInstance());
        return this._processInstanceVariablesApi;
    }
    getProcessInstances(requestNode, processDefinitionKey) {
        return from(this.processInstancesApi.getProcessInstances(requestNode))
            .pipe(map((res) => {
            if (processDefinitionKey) {
                const filtered = res.data.filter((process) => process.processDefinitionKey === processDefinitionKey);
                res.data = filtered;
                return res;
            }
            else {
                return res;
            }
        }), catchError((err) => this.handleProcessError(err)));
    }
    getProcesses(requestNode, processDefinitionKey) {
        return this.getProcessInstances(requestNode, processDefinitionKey)
            .pipe(map(response => {
            return Object.assign(Object.assign({}, response), { data: (response.data || []).map(instance => {
                    instance.name = this.getProcessNameOrDescription(instance, 'medium');
                    return instance;
                }) });
        }), catchError(() => of(new ProcessListModel({}))));
    }
    getProcessNameOrDescription(processInstance, dateFormat) {
        let name = '';
        if (processInstance) {
            name = processInstance.name ||
                processInstance.processDefinitionName + ' - ' + this.getFormatDate(processInstance.started, dateFormat);
        }
        return name;
    }
    getFormatDate(value, format) {
        const datePipe = new DatePipe('en-US');
        try {
            return datePipe.transform(value, format);
        }
        catch (err) {
            return '';
        }
    }
    fetchProcessAuditPdfById(processId) {
        return from(this.processInstancesApi.getProcessAuditPdf(processId))
            .pipe(catchError((err) => this.handleProcessError(err)));
    }
    fetchProcessAuditJsonById(processId) {
        return from(this.processInstancesApi.getTaskAuditLog(processId))
            .pipe(catchError((err) => this.handleProcessError(err)));
    }
    getProcess(processInstanceId) {
        return from(this.processInstancesApi.getProcessInstance(processInstanceId))
            .pipe(catchError((err) => this.handleProcessError(err)));
    }
    getProcessTasks(processInstanceId, state) {
        const taskOpts = state ? {
            processInstanceId: processInstanceId,
            state: state
        } : {
            processInstanceId: processInstanceId
        };
        return from(this.tasksApi.listTasks(taskOpts))
            .pipe(map(this.extractData), map((tasks) => tasks.map((task) => {
            task.created = moment(task.created, 'YYYY-MM-DD').format();
            return task;
        })), catchError((err) => this.handleProcessError(err)));
    }
    getProcessDefinitions(appId) {
        const opts = appId ? {
            latest: true,
            appDefinitionId: appId
        } : {
            latest: true
        };
        return from(this.processDefinitionsApi.getProcessDefinitions(opts))
            .pipe(map(this.extractData), map((processDefs) => processDefs.map((pd) => new ProcessDefinitionRepresentation(pd))), catchError((err) => this.handleProcessError(err)));
    }
    startProcess(processDefinitionId, name, outcome, startFormValues, variables) {
        const startRequest = {
            name: name,
            processDefinitionId: processDefinitionId
        };
        if (outcome) {
            startRequest.outcome = outcome;
        }
        if (startFormValues) {
            startRequest.values = startFormValues;
        }
        if (variables) {
            startRequest.variables = variables;
        }
        return from(this.processInstancesApi.startNewProcessInstance(startRequest))
            .pipe(map((pd) => new ProcessInstance(pd)), catchError((err) => this.handleProcessError(err)));
    }
    cancelProcess(processInstanceId) {
        return from(this.processInstancesApi.deleteProcessInstance(processInstanceId))
            .pipe(catchError((err) => this.handleProcessError(err)));
    }
    getProcessInstanceVariables(processInstanceId) {
        return from(this.processInstanceVariablesApi.getProcessInstanceVariables(processInstanceId))
            .pipe(map((processVars) => processVars.map((currentProcessVar) => new ProcessInstanceVariable(currentProcessVar))), catchError((err) => this.handleProcessError(err)));
    }
    createOrUpdateProcessInstanceVariables(processInstanceId, variables) {
        return from(this.processInstanceVariablesApi.createOrUpdateProcessInstanceVariables(processInstanceId, variables)).pipe(catchError((err) => this.handleProcessError(err)));
    }
    deleteProcessInstanceVariable(processInstanceId, variableName) {
        return from(this.processInstanceVariablesApi.deleteProcessInstanceVariable(processInstanceId, variableName))
            .pipe(catchError((err) => this.handleProcessError(err)));
    }
    extractData(res) {
        return res.data || {};
    }
    handleProcessError(error) {
        return throwError(error || 'Server error');
    }
}
ProcessService.ɵfac = function ProcessService_Factory(t) { return new (t || ProcessService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService)); };
ProcessService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ProcessService_Factory() { return new ProcessService(i0.ɵɵinject(i1.AlfrescoApiService)); }, token: ProcessService, providedIn: "root" });
ProcessService.ctorParameters = () => [
    { type: AlfrescoApiService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ProcessService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvcHJvY2Vzcy1zZXJ2aWNlcy9zcmMvbGliL3Byb2Nlc3MtbGlzdC9zZXJ2aWNlcy9wcm9jZXNzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBaUJBLE9BQU8sRUFBRSxrQkFBa0IsRUFBYyxNQUFNLG9CQUFvQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUNILFFBQVEsRUFDUixxQkFBcUIsRUFDckIsbUJBQW1CLEVBR25CLDJCQUEyQixFQUM5QixNQUFNLGtCQUFrQixDQUFDO0FBQzFCLE9BQU8sRUFBYyxJQUFJLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUd4RCxPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUNyRixPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQUNwRixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDbkUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDaEUsT0FBTyxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0M7QUFHVTs7O0FBR1YsTUFBTSxPQUFPLGNBQWM7QUFDM0IsSUF5QkksWUFBb0Isa0JBQXNDO0FBQzlELFFBRHdCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7QUFBQyxJQUMzRCxDQUFDO0FBQ0wsSUF6QkksSUFBSSxRQUFRO0FBQUs7QUFDZixRQUFFLElBQUksQ0FBQyxT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MTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlLCBGb3JtVmFsdWVzIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gICAgVGFza3NBcGksXG4gICAgUHJvY2Vzc0RlZmluaXRpb25zQXBpLFxuICAgIFByb2Nlc3NJbnN0YW5jZXNBcGksXG4gICAgUmVzdFZhcmlhYmxlLFxuICAgIFByb2Nlc3NJbnN0YW5jZVJlcHJlc2VudGF0aW9uLFxuICAgIFByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlc0FwaVxufSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20sIHRocm93RXJyb3IsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBUYXNrRGV0YWlsc01vZGVsIH0gZnJvbSAnLi4vLi4vdGFzay1saXN0JztcbmltcG9ydCB7IFByb2Nlc3NGaWx0ZXJQYXJhbVJlcHJlc2VudGF0aW9uTW9kZWwgfSBmcm9tICcuLi9tb2RlbHMvZmlsdGVyLXByb2Nlc3MubW9kZWwnO1xuaW1wb3J0IHsgUHJvY2Vzc0RlZmluaXRpb25SZXByZXNlbnRhdGlvbiB9IGZyb20gJy4uL21vZGVscy9wcm9jZXNzLWRlZmluaXRpb24ubW9kZWwnO1xuaW1wb3J0IHsgUHJvY2Vzc0luc3RhbmNlVmFyaWFibGUgfSBmcm9tICcuLi9tb2RlbHMvcHJvY2Vzcy1pbnN0YW5jZS12YXJpYWJsZS5tb2RlbCc7XG5pbXBvcnQgeyBQcm9jZXNzSW5zdGFuY2UgfSBmcm9tICcuLi9tb2RlbHMvcHJvY2Vzcy1pbnN0YW5jZS5tb2RlbCc7XG5pbXBvcnQgeyBQcm9jZXNzTGlzdE1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL3Byb2Nlc3MtbGlzdC5tb2RlbCc7XG5pbXBvcnQgeyBtYXAsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBEYXRlUGlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5cbmRlY2xhcmUgbGV0IG1vbWVudDogYW55O1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFByb2Nlc3NTZXJ2aWNlIHtcblxuICAgIHByaXZhdGUgX3Rhc2tzQXBpO1xuICAgIGdldCB0YXNrc0FwaSgpOiBUYXNrc0FwaSB7XG4gICAgICAgIHRoaXMuX3Rhc2tzQXBpID0gdGhpcy5fdGFza3NBcGkgPz8gbmV3IFRhc2tzQXBpKHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy5fdGFza3NBcGk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcHJvY2Vzc0RlZmluaXRpb25zQXBpO1xuICAgIGdldCBwcm9jZXNzRGVmaW5pdGlvbnNBcGkoKTogUHJvY2Vzc0RlZmluaXRpb25zQXBpIHtcbiAgICAgICAgdGhpcy5fcHJvY2Vzc0RlZmluaXRpb25zQXBpID0gdGhpcy5fcHJvY2Vzc0RlZmluaXRpb25zQXBpID8/IG5ldyBQcm9jZXNzRGVmaW5pdGlvbnNBcGkodGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl9wcm9jZXNzRGVmaW5pdGlvbnNBcGk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcHJvY2Vzc0luc3RhbmNlc0FwaTtcbiAgICBnZXQgcHJvY2Vzc0luc3RhbmNlc0FwaSgpOiBQcm9jZXNzSW5zdGFuY2VzQXBpIHtcbiAgICAgICAgdGhpcy5fcHJvY2Vzc0luc3RhbmNlc0FwaSA9IHRoaXMuX3Byb2Nlc3NJbnN0YW5jZXNBcGkgPz8gbmV3IFByb2Nlc3NJbnN0YW5jZXNBcGkodGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl9wcm9jZXNzSW5zdGFuY2VzQXBpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3Byb2Nlc3NJbnN0YW5jZVZhcmlhYmxlc0FwaTtcbiAgICBnZXQgcHJvY2Vzc0luc3RhbmNlVmFyaWFibGVzQXBpKCk6IFByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlc0FwaSB7XG4gICAgICAgIHRoaXMuX3Byb2Nlc3NJbnN0YW5jZVZhcmlhYmxlc0FwaSA9IHRoaXMuX3Byb2Nlc3NJbnN0YW5jZVZhcmlhYmxlc0FwaSA/PyBuZXcgUHJvY2Vzc0luc3RhbmNlVmFyaWFibGVzQXBpKHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy5fcHJvY2Vzc0luc3RhbmNlVmFyaWFibGVzQXBpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYWxmcmVzY29BcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UpIHtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHByb2Nlc3MgaW5zdGFuY2VzIGZvciBhIGZpbHRlciBhbmQgb3B0aW9uYWxseSBhIHByb2Nlc3MgZGVmaW5pdGlvbi5cbiAgICAgKiBAcGFyYW0gcmVxdWVzdE5vZGUgRmlsdGVyIGZvciBpbnN0YW5jZXNcbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0RlZmluaXRpb25LZXkgTGltaXRzIHJldHVybmVkIGluc3RhbmNlcyB0byBhIHByb2Nlc3MgZGVmaW5pdGlvblxuICAgICAqIEByZXR1cm5zIExpc3Qgb2YgcHJvY2VzcyBpbnN0YW5jZXNcbiAgICAgKi9cbiAgICBnZXRQcm9jZXNzSW5zdGFuY2VzKHJlcXVlc3ROb2RlOiBQcm9jZXNzRmlsdGVyUGFyYW1SZXByZXNlbnRhdGlvbk1vZGVsLCBwcm9jZXNzRGVmaW5pdGlvbktleT86IHN0cmluZyk6IE9ic2VydmFibGU8UHJvY2Vzc0xpc3RNb2RlbD4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnByb2Nlc3NJbnN0YW5jZXNBcGkuZ2V0UHJvY2Vzc0luc3RhbmNlcyhyZXF1ZXN0Tm9kZSkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlczogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwcm9jZXNzRGVmaW5pdGlvbktleSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyZWQgPSByZXMuZGF0YS5maWx0ZXIoKHByb2Nlc3MpID0+IHByb2Nlc3MucHJvY2Vzc0RlZmluaXRpb25LZXkgPT09IHByb2Nlc3NEZWZpbml0aW9uS2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5kYXRhID0gZmlsdGVyZWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBwcm9jZXNzZXMgZm9yIGEgZmlsdGVyIGFuZCBvcHRpb25hbGx5IGEgcHJvY2VzcyBkZWZpbml0aW9uLlxuICAgICAqIEBwYXJhbSByZXF1ZXN0Tm9kZSBGaWx0ZXIgZm9yIGluc3RhbmNlc1xuICAgICAqIEBwYXJhbSBwcm9jZXNzRGVmaW5pdGlvbktleSBMaW1pdHMgcmV0dXJuZWQgaW5zdGFuY2VzIHRvIGEgcHJvY2VzcyBkZWZpbml0aW9uXG4gICAgICogQHJldHVybnMgTGlzdCBvZiBwcm9jZXNzZXNcbiAgICAgKi9cbiAgICBnZXRQcm9jZXNzZXMocmVxdWVzdE5vZGU6IFByb2Nlc3NGaWx0ZXJQYXJhbVJlcHJlc2VudGF0aW9uTW9kZWwsIHByb2Nlc3NEZWZpbml0aW9uS2V5Pzogc3RyaW5nKTogT2JzZXJ2YWJsZTxQcm9jZXNzTGlzdE1vZGVsPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldFByb2Nlc3NJbnN0YW5jZXMocmVxdWVzdE5vZGUsIHByb2Nlc3NEZWZpbml0aW9uS2V5KVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLnJlc3BvbnNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogKHJlc3BvbnNlLmRhdGEgfHwgW10pLm1hcChpbnN0YW5jZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UubmFtZSA9IHRoaXMuZ2V0UHJvY2Vzc05hbWVPckRlc2NyaXB0aW9uKGluc3RhbmNlLCAnbWVkaXVtJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IG9mKG5ldyBQcm9jZXNzTGlzdE1vZGVsKHt9KSkpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0UHJvY2Vzc05hbWVPckRlc2NyaXB0aW9uKHByb2Nlc3NJbnN0YW5jZTogUHJvY2Vzc0luc3RhbmNlUmVwcmVzZW50YXRpb24sIGRhdGVGb3JtYXQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGxldCBuYW1lID0gJyc7XG5cbiAgICAgICAgaWYgKHByb2Nlc3NJbnN0YW5jZSkge1xuICAgICAgICAgICAgbmFtZSA9IHByb2Nlc3NJbnN0YW5jZS5uYW1lIHx8XG4gICAgICAgICAgICAgICAgcHJvY2Vzc0luc3RhbmNlLnByb2Nlc3NEZWZpbml0aW9uTmFtZSArICcgLSAnICsgdGhpcy5nZXRGb3JtYXREYXRlKHByb2Nlc3NJbnN0YW5jZS5zdGFydGVkLCBkYXRlRm9ybWF0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuYW1lO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Rm9ybWF0RGF0ZSh2YWx1ZTogRGF0ZSwgZm9ybWF0OiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgZGF0ZVBpcGUgPSBuZXcgRGF0ZVBpcGUoJ2VuLVVTJyk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBkYXRlUGlwZS50cmFuc2Zvcm0odmFsdWUsIGZvcm1hdCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmV0Y2hlcyB0aGUgUHJvY2VzcyBBdWRpdCBpbmZvcm1hdGlvbiBhcyBhIFBERi5cbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0lkIElEIG9mIHRoZSB0YXJnZXQgcHJvY2Vzc1xuICAgICAqIEByZXR1cm5zIEJpbmFyeSBQREYgZGF0YVxuICAgICAqL1xuICAgIGZldGNoUHJvY2Vzc0F1ZGl0UGRmQnlJZChwcm9jZXNzSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8QmxvYj4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnByb2Nlc3NJbnN0YW5jZXNBcGkuZ2V0UHJvY2Vzc0F1ZGl0UGRmKHByb2Nlc3NJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZldGNoZXMgdGhlIFByb2Nlc3MgQXVkaXQgaW5mb3JtYXRpb24gaW4gYSBKU09OIGZvcm1hdC5cbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0lkIElEIG9mIHRoZSB0YXJnZXQgcHJvY2Vzc1xuICAgICAqIEByZXR1cm5zIEpTT04gZGF0YVxuICAgICAqL1xuICAgIGZldGNoUHJvY2Vzc0F1ZGl0SnNvbkJ5SWQocHJvY2Vzc0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnByb2Nlc3NJbnN0YW5jZXNBcGkuZ2V0VGFza0F1ZGl0TG9nKHByb2Nlc3NJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgUHJvY2VzcyBJbnN0YW5jZSBtZXRhZGF0YS5cbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0luc3RhbmNlSWQgSUQgb2YgdGhlIHRhcmdldCBwcm9jZXNzXG4gICAgICogQHJldHVybnMgTWV0YWRhdGEgZm9yIHRoZSBpbnN0YW5jZVxuICAgICAqL1xuICAgIGdldFByb2Nlc3MocHJvY2Vzc0luc3RhbmNlSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8UHJvY2Vzc0luc3RhbmNlPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMucHJvY2Vzc0luc3RhbmNlc0FwaS5nZXRQcm9jZXNzSW5zdGFuY2UocHJvY2Vzc0luc3RhbmNlSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRhc2sgaW5zdGFuY2VzIGZvciBhIHByb2Nlc3MgaW5zdGFuY2UuXG4gICAgICogQHBhcmFtIHByb2Nlc3NJbnN0YW5jZUlkIElEIG9mIHRoZSBwcm9jZXNzIGluc3RhbmNlXG4gICAgICogQHBhcmFtIHN0YXRlIFRhc2sgc3RhdGUgZmlsdGVyIChjYW4gYmUgXCJhY3RpdmVcIiBvciBcImNvbXBsZXRlZFwiKVxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIHRhc2sgaW5zdGFuY2UgZGV0YWlsc1xuICAgICAqL1xuICAgIGdldFByb2Nlc3NUYXNrcyhwcm9jZXNzSW5zdGFuY2VJZDogc3RyaW5nLCBzdGF0ZT86IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbFtdPiB7XG4gICAgICAgIGNvbnN0IHRhc2tPcHRzID0gc3RhdGUgPyB7XG4gICAgICAgICAgICBwcm9jZXNzSW5zdGFuY2VJZDogcHJvY2Vzc0luc3RhbmNlSWQsXG4gICAgICAgICAgICBzdGF0ZTogc3RhdGVcbiAgICAgICAgfSA6IHtcbiAgICAgICAgICAgIHByb2Nlc3NJbnN0YW5jZUlkOiBwcm9jZXNzSW5zdGFuY2VJZFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnRhc2tzQXBpLmxpc3RUYXNrcyh0YXNrT3B0cykpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAodGhpcy5leHRyYWN0RGF0YSksXG4gICAgICAgICAgICAgICAgbWFwKCh0YXNrcykgPT4gdGFza3MubWFwKCh0YXNrOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGFzay5jcmVhdGVkID0gbW9tZW50KHRhc2suY3JlYXRlZCwgJ1lZWVktTU0tREQnKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhc2s7XG4gICAgICAgICAgICAgICAgfSkpLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBwcm9jZXNzIGRlZmluaXRpb25zIGFzc29jaWF0ZWQgd2l0aCBhbiBhcHAuXG4gICAgICogQHBhcmFtIGFwcElkIElEIG9mIGEgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIHByb2Nlc3MgZGVmaW5pdGlvbnNcbiAgICAgKi9cbiAgICBnZXRQcm9jZXNzRGVmaW5pdGlvbnMoYXBwSWQ/OiBudW1iZXIpOiBPYnNlcnZhYmxlPFByb2Nlc3NEZWZpbml0aW9uUmVwcmVzZW50YXRpb25bXT4ge1xuICAgICAgICBjb25zdCBvcHRzID0gYXBwSWQgPyB7XG4gICAgICAgICAgICBsYXRlc3Q6IHRydWUsXG4gICAgICAgICAgICBhcHBEZWZpbml0aW9uSWQ6IGFwcElkXG4gICAgICAgIH0gOiB7XG4gICAgICAgICAgICBsYXRlc3Q6IHRydWVcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NEZWZpbml0aW9uc0FwaS5nZXRQcm9jZXNzRGVmaW5pdGlvbnMob3B0cylcbiAgICAgICAgKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKHRoaXMuZXh0cmFjdERhdGEpLFxuICAgICAgICAgICAgICAgIG1hcCgocHJvY2Vzc0RlZnMpID0+IHByb2Nlc3NEZWZzLm1hcCgocGQpID0+IG5ldyBQcm9jZXNzRGVmaW5pdGlvblJlcHJlc2VudGF0aW9uKHBkKSkpLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnRzIGEgcHJvY2VzcyBiYXNlZCBvbiBhIHByb2Nlc3MgZGVmaW5pdGlvbiwgbmFtZSwgZm9ybSB2YWx1ZXMgb3IgdmFyaWFibGVzLlxuICAgICAqIEBwYXJhbSBwcm9jZXNzRGVmaW5pdGlvbklkIFByb2Nlc3MgZGVmaW5pdGlvbiBJRFxuICAgICAqIEBwYXJhbSBuYW1lIFByb2Nlc3MgbmFtZVxuICAgICAqIEBwYXJhbSBvdXRjb21lIFByb2Nlc3Mgb3V0Y29tZVxuICAgICAqIEBwYXJhbSBzdGFydEZvcm1WYWx1ZXMgVmFsdWVzIGZvciB0aGUgc3RhcnQgZm9ybVxuICAgICAqIEBwYXJhbSB2YXJpYWJsZXMgQXJyYXkgb2YgcHJvY2VzcyBpbnN0YW5jZSB2YXJpYWJsZXNcbiAgICAgKiBAcmV0dXJucyBEZXRhaWxzIG9mIHRoZSBwcm9jZXNzIGluc3RhbmNlIGp1c3Qgc3RhcnRlZFxuICAgICAqL1xuICAgIHN0YXJ0UHJvY2Vzcyhwcm9jZXNzRGVmaW5pdGlvbklkOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgb3V0Y29tZT86IHN0cmluZywgc3RhcnRGb3JtVmFsdWVzPzogRm9ybVZhbHVlcywgdmFyaWFibGVzPzogUHJvY2Vzc0luc3RhbmNlVmFyaWFibGVbXSk6IE9ic2VydmFibGU8UHJvY2Vzc0luc3RhbmNlPiB7XG4gICAgICAgIGNvbnN0IHN0YXJ0UmVxdWVzdDogYW55ID0ge1xuICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgIHByb2Nlc3NEZWZpbml0aW9uSWQ6IHByb2Nlc3NEZWZpbml0aW9uSWRcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKG91dGNvbWUpIHtcbiAgICAgICAgICAgIHN0YXJ0UmVxdWVzdC5vdXRjb21lID0gb3V0Y29tZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc3RhcnRGb3JtVmFsdWVzKSB7XG4gICAgICAgICAgICBzdGFydFJlcXVlc3QudmFsdWVzID0gc3RhcnRGb3JtVmFsdWVzO1xuICAgICAgICB9XG4gICAgICAgIGlmICh2YXJpYWJsZXMpIHtcbiAgICAgICAgICAgIHN0YXJ0UmVxdWVzdC52YXJpYWJsZXMgPSB2YXJpYWJsZXM7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NJbnN0YW5jZXNBcGkuc3RhcnROZXdQcm9jZXNzSW5zdGFuY2Uoc3RhcnRSZXF1ZXN0KVxuICAgICAgICApXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHBkKSA9PiBuZXcgUHJvY2Vzc0luc3RhbmNlKHBkKSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYW5jZWxzIGEgcHJvY2VzcyBpbnN0YW5jZS5cbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0luc3RhbmNlSWQgSUQgb2YgcHJvY2VzcyB0byBjYW5jZWxcbiAgICAgKiBAcmV0dXJucyBOdWxsIHJlc3BvbnNlIG5vdGlmeWluZyB3aGVuIHRoZSBvcGVyYXRpb24gaXMgY29tcGxldGVcbiAgICAgKi9cbiAgICBjYW5jZWxQcm9jZXNzKHByb2Nlc3NJbnN0YW5jZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NJbnN0YW5jZXNBcGkuZGVsZXRlUHJvY2Vzc0luc3RhbmNlKHByb2Nlc3NJbnN0YW5jZUlkKVxuICAgICAgICApXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHZhcmlhYmxlcyBmb3IgYSBwcm9jZXNzIGluc3RhbmNlLlxuICAgICAqIEBwYXJhbSBwcm9jZXNzSW5zdGFuY2VJZCBJRCBvZiB0aGUgdGFyZ2V0IHByb2Nlc3NcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBpbnN0YW5jZSB2YXJpYWJsZSBpbmZvXG4gICAgICovXG4gICAgZ2V0UHJvY2Vzc0luc3RhbmNlVmFyaWFibGVzKHByb2Nlc3NJbnN0YW5jZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlW10+IHtcbiAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlc0FwaS5nZXRQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXMocHJvY2Vzc0luc3RhbmNlSWQpXG4gICAgICAgIClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocHJvY2Vzc1ZhcnM6IGFueVtdKSA9PiBwcm9jZXNzVmFycy5tYXAoKGN1cnJlbnRQcm9jZXNzVmFyKSA9PiBuZXcgUHJvY2Vzc0luc3RhbmNlVmFyaWFibGUoY3VycmVudFByb2Nlc3NWYXIpKSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIG9yIHVwZGF0ZXMgdmFyaWFibGVzIGZvciBhIHByb2Nlc3MgaW5zdGFuY2UuXG4gICAgICogQHBhcmFtIHByb2Nlc3NJbnN0YW5jZUlkIElEIG9mIHRoZSB0YXJnZXQgcHJvY2Vzc1xuICAgICAqIEBwYXJhbSB2YXJpYWJsZXMgVmFyaWFibGVzIHRvIHVwZGF0ZVxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIGluc3RhbmNlIHZhcmlhYmxlIGluZm9cbiAgICAgKi9cbiAgICBjcmVhdGVPclVwZGF0ZVByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlcyhwcm9jZXNzSW5zdGFuY2VJZDogc3RyaW5nLCB2YXJpYWJsZXM6IFJlc3RWYXJpYWJsZVtdKTogT2JzZXJ2YWJsZTxQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZVtdPiB7XG4gICAgICAgIHJldHVybiBmcm9tKFxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXNBcGkuY3JlYXRlT3JVcGRhdGVQcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXMocHJvY2Vzc0luc3RhbmNlSWQsIHZhcmlhYmxlcylcbiAgICAgICAgKS5waXBlKFxuICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlbGV0ZXMgYSB2YXJpYWJsZSBmb3IgYSBwcm9jZXNzIGluc3RhbmNlLlxuICAgICAqIEBwYXJhbSBwcm9jZXNzSW5zdGFuY2VJZCBJRCBvZiB0aGUgdGFyZ2V0IHByb2Nlc3NcbiAgICAgKiBAcGFyYW0gdmFyaWFibGVOYW1lIE5hbWUgb2YgdGhlIHZhcmlhYmxlIHRvIGRlbGV0ZVxuICAgICAqIEByZXR1cm5zIE51bGwgcmVzcG9uc2Ugbm90aWZ5aW5nIHdoZW4gdGhlIG9wZXJhdGlvbiBpcyBjb21wbGV0ZVxuICAgICAqL1xuICAgIGRlbGV0ZVByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlKHByb2Nlc3NJbnN0YW5jZUlkOiBzdHJpbmcsIHZhcmlhYmxlTmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBmcm9tKFxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXNBcGkuZGVsZXRlUHJvY2Vzc0luc3RhbmNlVmFyaWFibGUocHJvY2Vzc0luc3RhbmNlSWQsIHZhcmlhYmxlTmFtZSlcbiAgICAgICAgKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGV4dHJhY3REYXRhKHJlczogYW55KSB7XG4gICAgICAgIHJldHVybiByZXMuZGF0YSB8fCB7fTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZVByb2Nlc3NFcnJvcihlcnJvcjogYW55KSB7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yIHx8ICdTZXJ2ZXIgZXJyb3InKTtcbiAgICB9XG59XG4iXX0=