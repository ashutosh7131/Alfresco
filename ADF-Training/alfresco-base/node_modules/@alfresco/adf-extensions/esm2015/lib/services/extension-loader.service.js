import { HttpClient } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { ContentActionType } from '../config/action.extensions';
import { filterEnabled, getValue, mergeObjects, sortByOrder } from '../config/extension-utils';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/common/http';
export class ExtensionLoaderService {
    constructor(http) {
        this.http = http;
    }
    load(configPath, pluginsPath, extensions) {
        return new Promise((resolve) => {
            this.loadConfig(configPath, 0).then((result) => {
                if (result) {
                    let config = result.config;
                    const override = sessionStorage.getItem('app.extension.config');
                    if (override) {
                        config = JSON.parse(override);
                    }
                    if (!config.$references || !config.$references.length) {
                        config.$references = this.filterIgnoredExtensions(extensions || [], config.$ignoreReferenceList);
                    }
                    else {
                        config.$references = this.filterIgnoredExtensions(config.$references, config.$ignoreReferenceList);
                    }
                    if (config.$references && config.$references.length > 0) {
                        const plugins = config.$references.map((name, idx) => this.loadConfig(`${pluginsPath}/${name}`, idx));
                        Promise.all(plugins).then((results) => {
                            const configs = results
                                .filter((entry) => entry)
                                .sort(sortByOrder)
                                .map((entry) => entry.config);
                            if (configs.length > 0) {
                                config = mergeObjects(config, ...configs);
                            }
                            config = Object.assign(Object.assign(Object.assign({}, config), this.getMetadata(result.config)), { $references: configs.map((ext) => this.getMetadata(ext)) });
                            resolve(config);
                        });
                    }
                    else {
                        resolve(config);
                    }
                }
            });
        });
    }
    getMetadata(config) {
        const result = {};
        Object
            .keys(config)
            .filter((key) => key.startsWith('$'))
            .forEach((key) => {
            result[key] = config[key];
        });
        return result;
    }
    loadConfig(url, order) {
        return new Promise((resolve) => {
            this.http.get(url).subscribe((config) => {
                resolve({
                    order,
                    config
                });
            }, () => {
                resolve(null);
            });
        });
    }
    getElements(config, key, fallback = []) {
        const values = getValue(config, key) || fallback || [];
        return values.filter(filterEnabled).sort(sortByOrder);
    }
    getContentActions(config, key) {
        return this.getElements(config, key).map(this.setActionDefaults);
    }
    getRules(config) {
        if (config && config.rules) {
            return config.rules;
        }
        return [];
    }
    getRoutes(config) {
        if (config) {
            return config.routes || [];
        }
        return [];
    }
    getActions(config) {
        if (config) {
            return config.actions || [];
        }
        return [];
    }
    getFeatures(config) {
        if (config) {
            return config.features || [];
        }
        return [];
    }
    setActionDefaults(action) {
        if (action) {
            action.type = action.type || ContentActionType.default;
            action.icon = action.icon || 'extension';
        }
        return action;
    }
    filterIgnoredExtensions(extensions, ignoreReferenceList) {
        if (!ignoreReferenceList || !ignoreReferenceList.length) {
            return extensions;
        }
        return extensions.map((file) => file.match('(?!.*\/).+')[0]).filter((fileName) => !ignoreReferenceList.includes(fileName));
    }
}
ExtensionLoaderService.ɵfac = function ExtensionLoaderService_Factory(t) { return new (t || ExtensionLoaderService)(ɵngcc0.ɵɵinject(ɵngcc1.HttpClient)); };
ExtensionLoaderService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ExtensionLoaderService_Factory() { return new ExtensionLoaderService(i0.ɵɵinject(i1.HttpClient)); }, token: ExtensionLoaderService, providedIn: "root" });
ExtensionLoaderService.ctorParameters = () => [
    { type: HttpClient }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ExtensionLoaderService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.HttpClient }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5zaW9uLWxvYWRlci5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvZXh0ZW5zaW9ucy9zcmMvbGliL3NlcnZpY2VzL2V4dGVuc2lvbi1sb2FkZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFpQkEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUErQixpQkFBaUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRTdGLE9BQU8sRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMvRjtBQUFxQzs7O0FBT3JDLE1BQU0sT0FBTyxzQkFBc0I7QUFDbkMsSUFBSSxZQUFvQixJQUFnQjtBQUN4QyxRQUR3QixTQUFJLEdBQUosSUFBSSxDQUFZO0FBQUMsSUFDckMsQ0FBQztBQUNMLElBQ0ksSUFBSSxDQUFDLFVBQWtCLEVBQUUsV0FBbUIsRUFBRSxVQUFxQjtBQUFJLFFBQ25FLE9BQU8sSUFBSSxPQUFPLENBQU0sQ0FBQyxPQUFPLEVBQUUsRUFBRTtBQUM1QyxZQUFZLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO0FBQzNELGdCQUFnQixJQUFJLE1BQU0sRUFBRTtBQUM1QixvQkFBb0IsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztBQUMvQyxvQkFDb0IsTUFBTSxRQUFRLEdBQUcsY0FBYyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ3BGLG9CQUFvQixJQUFJLFFBQVEsRUFBRTtB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LEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsUUFBZ0IsRUFBRSxFQUFFLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUNuSixJQUFJLENBQUM7QUFDTDsySkFBQztBQUNELG1PQXRKSztBQUFDO0VBSEwsVUFBVSxTQUFDLHJCQUlJLFlBYlAsVUFBVTtBQUFHO1dBVWxCLFVBQVUsRUFBRSxNQUFNLGNBQ3JCOzs7OzsyRUFYdUI7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3Rpb25SZWYsIENvbnRlbnRBY3Rpb25SZWYsIENvbnRlbnRBY3Rpb25UeXBlIH0gZnJvbSAnLi4vY29uZmlnL2FjdGlvbi5leHRlbnNpb25zJztcbmltcG9ydCB7IEV4dGVuc2lvbkVsZW1lbnQgfSBmcm9tICcuLi9jb25maWcvZXh0ZW5zaW9uLWVsZW1lbnQnO1xuaW1wb3J0IHsgZmlsdGVyRW5hYmxlZCwgZ2V0VmFsdWUsIG1lcmdlT2JqZWN0cywgc29ydEJ5T3JkZXIgfSBmcm9tICcuLi9jb25maWcvZXh0ZW5zaW9uLXV0aWxzJztcbmltcG9ydCB7IEV4dGVuc2lvbkNvbmZpZywgRXh0ZW5zaW9uUmVmIH0gZnJvbSAnLi4vY29uZmlnL2V4dGVuc2lvbi5jb25maWcnO1xuaW1wb3J0IHsgUm91dGVSZWYgfSBmcm9tICcuLi9jb25maWcvcm91dGluZy5leHRlbnNpb25zJztcbmltcG9ydCB7IFJ1bGVSZWYgfSBmcm9tICcuLi9jb25maWcvcnVsZS5leHRlbnNpb25zJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBFeHRlbnNpb25Mb2FkZXJTZXJ2aWNlIHtcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHtcbiAgICB9XG5cbiAgICBsb2FkKGNvbmZpZ1BhdGg6IHN0cmluZywgcGx1Z2luc1BhdGg6IHN0cmluZywgZXh0ZW5zaW9ucz86IHN0cmluZ1tdKTogUHJvbWlzZTxFeHRlbnNpb25Db25maWc+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIHRoaXMubG9hZENvbmZpZyhjb25maWdQYXRoLCAwKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBjb25maWcgPSByZXN1bHQuY29uZmlnO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJyaWRlID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgnYXBwLmV4dGVuc2lvbi5jb25maWcnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG92ZXJyaWRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25maWcgPSBKU09OLnBhcnNlKG92ZXJyaWRlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmICghY29uZmlnLiRyZWZlcmVuY2VzIHx8ICFjb25maWcuJHJlZmVyZW5jZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25maWcuJHJlZmVyZW5jZXMgPSB0aGlzLmZpbHRlcklnbm9yZWRFeHRlbnNpb25zKGV4dGVuc2lvbnMgfHwgW10sIGNvbmZpZy4kaWdub3JlUmVmZXJlbmNlTGlzdCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25maWcuJHJlZmVyZW5jZXMgPSB0aGlzLmZpbHRlcklnbm9yZWRFeHRlbnNpb25zKGNvbmZpZy4kcmVmZXJlbmNlcywgY29uZmlnLiRpZ25vcmVSZWZlcmVuY2VMaXN0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcuJHJlZmVyZW5jZXMgJiYgY29uZmlnLiRyZWZlcmVuY2VzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBsdWdpbnMgPSBjb25maWcuJHJlZmVyZW5jZXMubWFwKChuYW1lLCBpZHgpID0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkQ29uZmlnKGAke3BsdWdpbnNQYXRofS8ke25hbWV9YCwgaWR4KVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgUHJvbWlzZS5hbGwocGx1Z2lucykudGhlbigocmVzdWx0cykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbmZpZ3MgPSByZXN1bHRzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoKGVudHJ5KSA9PiBlbnRyeSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnNvcnQoc29ydEJ5T3JkZXIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoKGVudHJ5KSA9PiBlbnRyeS5jb25maWcpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZ3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcgPSBtZXJnZU9iamVjdHMoY29uZmlnLCAuLi5jb25maWdzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLmNvbmZpZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5nZXRNZXRhZGF0YShyZXN1bHQuY29uZmlnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJlZmVyZW5jZXM6IGNvbmZpZ3MubWFwKChleHQpID0+IHRoaXMuZ2V0TWV0YWRhdGEoZXh0KSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShjb25maWcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGNvbmZpZyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldE1ldGFkYXRhKGNvbmZpZzogRXh0ZW5zaW9uQ29uZmlnKTogRXh0ZW5zaW9uUmVmIHtcbiAgICAgICAgY29uc3QgcmVzdWx0OiBhbnkgPSB7fTtcblxuICAgICAgICBPYmplY3RcbiAgICAgICAgICAgIC5rZXlzKGNvbmZpZylcbiAgICAgICAgICAgIC5maWx0ZXIoKGtleSkgPT4ga2V5LnN0YXJ0c1dpdGgoJyQnKSlcbiAgICAgICAgICAgIC5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgICAgICByZXN1bHRba2V5XSA9IGNvbmZpZ1trZXldO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgbG9hZENvbmZpZyhcbiAgICAgICAgdXJsOiBzdHJpbmcsXG4gICAgICAgIG9yZGVyOiBudW1iZXJcbiAgICApOiBQcm9taXNlPHsgb3JkZXI6IG51bWJlcjsgY29uZmlnOiBFeHRlbnNpb25Db25maWcgfT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuaHR0cC5nZXQ8RXh0ZW5zaW9uQ29uZmlnPih1cmwpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoY29uZmlnKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgb3JkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25maWdcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUobnVsbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0cmlldmVzIGNvbmZpZ3VyYXRpb24gZWxlbWVudHMuXG4gICAgICogRmlsdGVycyBlbGVtZW50IGJ5ICoqZW5hYmxlZCoqIGFuZCAqKm9yZGVyKiogYXR0cmlidXRlcy5cbiAgICAgKiBFeGFtcGxlOlxuICAgICAqICBgZ2V0RWxlbWVudHM8Vmlld2VyRXh0ZW5zaW9uUmVmPihjb25maWcsICdmZWF0dXJlcy52aWV3ZXIuY29udGVudCcpYFxuICAgICAqL1xuICAgIGdldEVsZW1lbnRzPFQgZXh0ZW5kcyBFeHRlbnNpb25FbGVtZW50PihcbiAgICAgICAgY29uZmlnOiBFeHRlbnNpb25Db25maWcsXG4gICAgICAgIGtleTogc3RyaW5nLFxuICAgICAgICBmYWxsYmFjazogQXJyYXk8VD4gPSBbXVxuICAgICk6IEFycmF5PFQ+IHtcbiAgICAgICAgY29uc3QgdmFsdWVzID0gZ2V0VmFsdWUoY29uZmlnLCBrZXkpIHx8IGZhbGxiYWNrIHx8IFtdO1xuICAgICAgICByZXR1cm4gdmFsdWVzLmZpbHRlcihmaWx0ZXJFbmFibGVkKS5zb3J0KHNvcnRCeU9yZGVyKTtcbiAgICB9XG5cbiAgICBnZXRDb250ZW50QWN0aW9ucyhcbiAgICAgICAgY29uZmlnOiBFeHRlbnNpb25Db25maWcsXG4gICAgICAgIGtleTogc3RyaW5nXG4gICAgKTogQXJyYXk8Q29udGVudEFjdGlvblJlZj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRFbGVtZW50cyhjb25maWcsIGtleSkubWFwKHRoaXMuc2V0QWN0aW9uRGVmYXVsdHMpO1xuICAgIH1cblxuICAgIGdldFJ1bGVzKGNvbmZpZzogRXh0ZW5zaW9uQ29uZmlnKTogQXJyYXk8UnVsZVJlZj4ge1xuICAgICAgICBpZiAoY29uZmlnICYmIGNvbmZpZy5ydWxlcykge1xuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZy5ydWxlcztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgZ2V0Um91dGVzKGNvbmZpZzogRXh0ZW5zaW9uQ29uZmlnKTogQXJyYXk8Um91dGVSZWY+IHtcbiAgICAgICAgaWYgKGNvbmZpZykge1xuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZy5yb3V0ZXMgfHwgW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIGdldEFjdGlvbnMoY29uZmlnOiBFeHRlbnNpb25Db25maWcpOiBBcnJheTxBY3Rpb25SZWY+IHtcbiAgICAgICAgaWYgKGNvbmZpZykge1xuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZy5hY3Rpb25zIHx8IFtdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBnZXRGZWF0dXJlcyhjb25maWc6IEV4dGVuc2lvbkNvbmZpZyk6IGFueSB7XG4gICAgICAgIGlmIChjb25maWcpIHtcbiAgICAgICAgICAgIHJldHVybiBjb25maWcuZmVhdHVyZXMgfHwgW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBzZXRBY3Rpb25EZWZhdWx0cyhhY3Rpb246IENvbnRlbnRBY3Rpb25SZWYpOiBDb250ZW50QWN0aW9uUmVmIHtcbiAgICAgICAgaWYgKGFjdGlvbikge1xuICAgICAgICAgICAgYWN0aW9uLnR5cGUgPSBhY3Rpb24udHlwZSB8fCBDb250ZW50QWN0aW9uVHlwZS5kZWZhdWx0O1xuICAgICAgICAgICAgYWN0aW9uLmljb24gPSBhY3Rpb24uaWNvbiB8fCAnZXh0ZW5zaW9uJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWN0aW9uO1xuICAgIH1cblxuICAgIHByaXZhdGUgZmlsdGVySWdub3JlZEV4dGVuc2lvbnMoZXh0ZW5zaW9uczogQXJyYXk8c3RyaW5nIHwgRXh0ZW5zaW9uUmVmPiwgaWdub3JlUmVmZXJlbmNlTGlzdDogc3RyaW5nW10pOiBBcnJheTxzdHJpbmcgfCBFeHRlbnNpb25SZWY+IHtcbiAgICAgICAgaWYgKCFpZ25vcmVSZWZlcmVuY2VMaXN0IHx8ICFpZ25vcmVSZWZlcmVuY2VMaXN0Lmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuIGV4dGVuc2lvbnM7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZXh0ZW5zaW9ucy5tYXAoKGZpbGU6IHN0cmluZykgPT4gZmlsZS5tYXRjaCgnKD8hLipcXC8pLisnKVswXSkuZmlsdGVyKChmaWxlTmFtZTogc3RyaW5nKSA9PiAhaWdub3JlUmVmZXJlbmNlTGlzdC5pbmNsdWRlcyhmaWxlTmFtZSkpO1xuICAgIH1cbn1cbiJdfQ==