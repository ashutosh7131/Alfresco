import { __awaiter } from "tslib";
import { Injectable, InjectionToken, Inject } from '@angular/core';
import { ExtensionLoaderService } from './extension-loader.service';
import * as core from '../evaluators/core.evaluators';
import { ComponentRegisterService } from './component-register.service';
import { RuleService } from './rule.service';
import { BehaviorSubject } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "./extension-loader.service";
import * as i2 from "./component-register.service";
import * as i3 from "./rule.service";
export function extensionJsonsFactory() {
    return [];
}
export const EXTENSION_JSONS = new InjectionToken('extension-jsons', {
    providedIn: 'root',
    factory: extensionJsonsFactory
});
export function provideExtensionConfig(jsons) {
    return {
        provide: EXTENSION_JSONS,
        useValue: jsons,
        multi: true
    };
}
export class ExtensionService {
    constructor(loader, componentRegister, ruleService, extensionJsons) {
        this.loader = loader;
        this.componentRegister = componentRegister;
        this.ruleService = ruleService;
        this.extensionJsons = extensionJsons;
        this.config = null;
        this.configPath = 'assets/app.extensions.json';
        this.pluginsPath = 'assets/plugins';
        this.routes = [];
        this.actions = [];
        this.features = [];
        this.authGuards = {};
        this.onSetup$ = new BehaviorSubject(this.config);
        this.setup$ = this.onSetup$.asObservable();
    }
    load() {
        return __awaiter(this, void 0, void 0, function* () {
            const config = yield this.loader.load(this.configPath, this.pluginsPath, this.extensionJsons.flat());
            this.setup(config);
            return config;
        });
    }
    setup(config) {
        if (!config) {
            console.warn('Extension configuration not found');
            return;
        }
        this.config = config;
        this.setEvaluators({
            'core.every': core.every,
            'core.some': core.some,
            'core.not': core.not
        });
        this.actions = this.loader.getActions(config);
        this.routes = this.loader.getRoutes(config);
        this.features = this.loader.getFeatures(config);
        this.ruleService.setup(config);
        this.onSetup$.next(config);
    }
    getFeature(key) {
        const properties = Array.isArray(key) ? [key] : key.split('.');
        return properties.reduce((prev, curr) => prev && prev[curr], this.features) || [];
    }
    getElements(key, fallback = []) {
        return this.loader.getElements(this.config, key, fallback);
    }
    setEvaluators(values) {
        this.ruleService.setEvaluators(values);
    }
    setAuthGuards(values) {
        if (values) {
            this.authGuards = Object.assign({}, this.authGuards, values);
        }
    }
    setComponents(values) {
        this.componentRegister.setComponents(values);
    }
    getRouteById(id) {
        return this.routes.find((route) => route.id === id);
    }
    getAuthGuards(ids) {
        return (ids || [])
            .map((id) => this.authGuards[id])
            .filter((guard) => guard);
    }
    getActionById(id) {
        return this.actions.find((action) => action.id === id);
    }
    getEvaluator(key) {
        return this.ruleService.getEvaluator(key);
    }
    evaluateRule(ruleId, context) {
        return this.ruleService.evaluateRule(ruleId, context);
    }
    getComponentById(id) {
        return this.componentRegister.getComponentById(id);
    }
    getRuleById(id) {
        return this.ruleService.getRuleById(id);
    }
    runExpression(value, context) {
        if (typeof value === 'string') {
            return this.evaluateExpression(value, context);
        }
        else {
            const duplicate = Object.assign({}, value);
            Object.keys(duplicate).forEach((key) => {
                duplicate[key] = this.evaluateExpression(duplicate[key], context);
            });
            return duplicate;
        }
    }
    evaluateExpression(value, context) {
        const pattern = new RegExp(/\$\((.*\)?)\)/g);
        const matches = pattern.exec(value);
        if (matches && matches.length > 1) {
            const expression = matches[1];
            const fn = new Function('context', `return ${expression}`);
            const result = fn(context);
            return result;
        }
        return value;
    }
}
ExtensionService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ExtensionService_Factory() { return new ExtensionService(i0.ɵɵinject(i1.ExtensionLoaderService), i0.ɵɵinject(i2.ComponentRegisterService), i0.ɵɵinject(i3.RuleService), i0.ɵɵinject(EXTENSION_JSONS)); }, token: ExtensionService, providedIn: "root" });
ExtensionService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
ExtensionService.ctorParameters = () => [
    { type: ExtensionLoaderService },
    { type: ComponentRegisterService },
    { type: RuleService },
    { type: Array, decorators: [{ type: Inject, args: [EXTENSION_JSONS,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5zaW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9leHRlbnNpb25zL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9leHRlbnNpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQVEsY0FBYyxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUd6RSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUdwRSxPQUFPLEtBQUssSUFBSSxNQUFNLCtCQUErQixDQUFDO0FBQ3RELE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU3QyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDOzs7OztBQUV2QyxNQUFNLFVBQVUscUJBQXFCO0lBQ2pDLE9BQU8sRUFBRSxDQUFDO0FBQ2QsQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBRyxJQUFJLGNBQWMsQ0FBYSxpQkFBaUIsRUFBRTtJQUM3RSxVQUFVLEVBQUUsTUFBTTtJQUNsQixPQUFPLEVBQUUscUJBQXFCO0NBQ2pDLENBQUMsQ0FBQztBQUVILE1BQU0sVUFBVSxzQkFBc0IsQ0FBQyxLQUFlO0lBQ2xELE9BQU87UUFDSCxPQUFPLEVBQUUsZUFBZTtRQUN4QixRQUFRLEVBQUUsS0FBSztRQUNmLEtBQUssRUFBRSxJQUFJO0tBQ2QsQ0FBQztBQUNOLENBQUM7QUFLRCxNQUFNLE9BQU8sZ0JBQWdCO0lBZXpCLFlBQ2MsTUFBOEIsRUFDOUIsaUJBQTJDLEVBQzNDLFdBQXdCLEVBQ0MsY0FBd0I7UUFIakQsV0FBTSxHQUFOLE1BQU0sQ0FBd0I7UUFDOUIsc0JBQWlCLEdBQWpCLGlCQUFp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SyxDQUFDO0lBQ2pCLENBQUM7Ozs7WUExTUosVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7WUE1QlEsc0JBQXNCO1lBSXRCLHdCQUF3QjtZQUN4QixXQUFXO3dDQTJDWCxNQUFNLFNBQUMsZUFBZSIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUsIFR5cGUsIEluamVjdGlvblRva2VuLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJ1bGVFdmFsdWF0b3IsIFJ1bGVSZWYsIFJ1bGVDb250ZXh0IH0gZnJvbSAnLi4vY29uZmlnL3J1bGUuZXh0ZW5zaW9ucyc7XG5pbXBvcnQgeyBFeHRlbnNpb25Db25maWcgfSBmcm9tICcuLi9jb25maWcvZXh0ZW5zaW9uLmNvbmZpZyc7XG5pbXBvcnQgeyBFeHRlbnNpb25Mb2FkZXJTZXJ2aWNlIH0gZnJvbSAnLi9leHRlbnNpb24tbG9hZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgUm91dGVSZWYgfSBmcm9tICcuLi9jb25maWcvcm91dGluZy5leHRlbnNpb25zJztcbmltcG9ydCB7IEFjdGlvblJlZiB9IGZyb20gJy4uL2NvbmZpZy9hY3Rpb24uZXh0ZW5zaW9ucyc7XG5pbXBvcnQgKiBhcyBjb3JlIGZyb20gJy4uL2V2YWx1YXRvcnMvY29yZS5ldmFsdWF0b3JzJztcbmltcG9ydCB7IENvbXBvbmVudFJlZ2lzdGVyU2VydmljZSB9IGZyb20gJy4vY29tcG9uZW50LXJlZ2lzdGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgUnVsZVNlcnZpY2UgfSBmcm9tICcuL3J1bGUuc2VydmljZSc7XG5pbXBvcnQgeyBFeHRlbnNpb25FbGVtZW50IH0gZnJvbSAnLi4vY29uZmlnL2V4dGVuc2lvbi1lbGVtZW50JztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG5leHBvcnQgZnVuY3Rpb24gZXh0ZW5zaW9uSnNvbnNGYWN0b3J5KCkge1xuICAgIHJldHVybiBbXTtcbn1cblxuZXhwb3J0IGNvbnN0IEVYVEVOU0lPTl9KU09OUyA9IG5ldyBJbmplY3Rpb25Ub2tlbjxzdHJpbmdbXVtdPignZXh0ZW5zaW9uLWpzb25zJywge1xuICAgIHByb3ZpZGVkSW46ICdyb290JyxcbiAgICBmYWN0b3J5OiBleHRlbnNpb25Kc29uc0ZhY3Rvcnlcbn0pO1xuXG5leHBvcnQgZnVuY3Rpb24gcHJvdmlkZUV4dGVuc2lvbkNvbmZpZyhqc29uczogc3RyaW5nW10pIHtcbiAgICByZXR1cm4ge1xuICAgICAgICBwcm92aWRlOiBFWFRFTlNJT05fSlNPTlMsXG4gICAgICAgIHVzZVZhbHVlOiBqc29ucyxcbiAgICAgICAgbXVsdGk6IHRydWVcbiAgICB9O1xufVxuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEV4dGVuc2lvblNlcnZpY2Uge1xuXG4gICAgcHJvdGVjdGVkIGNvbmZpZzogRXh0ZW5zaW9uQ29uZmlnID0gbnVsbDtcblxuICAgIGNvbmZpZ1BhdGggPSAnYXNzZXRzL2FwcC5leHRlbnNpb25zLmpzb24nO1xuICAgIHBsdWdpbnNQYXRoID0gJ2Fzc2V0cy9wbHVnaW5zJztcblxuICAgIHJvdXRlczogQXJyYXk8Um91dGVSZWY+ID0gW107XG4gICAgYWN0aW9uczogQXJyYXk8QWN0aW9uUmVmPiA9IFtdO1xuICAgIGZlYXR1cmVzOiBBcnJheTxhbnk+ID0gW107XG4gICAgYXV0aEd1YXJkczogeyBba2V5OiBzdHJpbmddOiBUeXBlPHt9PiB9ID0ge307XG5cbiAgICBwcm90ZWN0ZWQgb25TZXR1cCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEV4dGVuc2lvbkNvbmZpZz4odGhpcy5jb25maWcpO1xuICAgIHNldHVwJCA9IHRoaXMub25TZXR1cCQuYXNPYnNlcnZhYmxlKCk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJvdGVjdGVkIGxvYWRlcjogRXh0ZW5zaW9uTG9hZGVyU2VydmljZSxcbiAgICAgICAgcHJvdGVjdGVkIGNvbXBvbmVudFJlZ2lzdGVyOiBDb21wb25lbnRSZWdpc3RlclNlcnZpY2UsXG4gICAgICAgIHByb3RlY3RlZCBydWxlU2VydmljZTogUnVsZVNlcnZpY2UsXG4gICAgICAgIEBJbmplY3QoRVhURU5TSU9OX0pTT05TKSBwcm90ZWN0ZWQgZXh0ZW5zaW9uSnNvbnM6IHN0cmluZ1tdXG4gICAgKSB7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9hZHMgYW5kIHJlZ2lzdGVycyBhbiBleHRlbnNpb24gY29uZmlnIGZpbGUgYW5kIHBsdWdpbnMgKHNwZWNpZmllZCBieSBwYXRoIHByb3BlcnRpZXMpLlxuICAgICAqIEByZXR1cm5zIFRoZSBsb2FkZWQgY29uZmlnIGRhdGFcbiAgICAgKi9cbiAgICBhc3luYyBsb2FkKCk6IFByb21pc2U8RXh0ZW5zaW9uQ29uZmlnPiB7XG4gICAgICAgIGNvbnN0IGNvbmZpZyA9IGF3YWl0IHRoaXMubG9hZGVyLmxvYWQoXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ1BhdGgsXG4gICAgICAgICAgICB0aGlzLnBsdWdpbnNQYXRoLFxuICAgICAgICAgICAgdGhpcy5leHRlbnNpb25Kc29ucy5mbGF0KClcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5zZXR1cChjb25maWcpO1xuICAgICAgICByZXR1cm4gY29uZmlnO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlZ2lzdGVycyBleHRlbnNpb25zIGZyb20gYSBjb25maWcgb2JqZWN0LlxuICAgICAqIEBwYXJhbSBjb25maWcgT2JqZWN0IHdpdGggY29uZmlnIGRhdGFcbiAgICAgKi9cbiAgICBzZXR1cChjb25maWc6IEV4dGVuc2lvbkNvbmZpZykge1xuICAgICAgICBpZiAoIWNvbmZpZykge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdFeHRlbnNpb24gY29uZmlndXJhdGlvbiBub3QgZm91bmQnKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuXG4gICAgICAgIHRoaXMuc2V0RXZhbHVhdG9ycyh7XG4gICAgICAgICAgICAnY29yZS5ldmVyeSc6IGNvcmUuZXZlcnksXG4gICAgICAgICAgICAnY29yZS5zb21lJzogY29yZS5zb21lLFxuICAgICAgICAgICAgJ2NvcmUubm90JzogY29yZS5ub3RcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5hY3Rpb25zID0gdGhpcy5sb2FkZXIuZ2V0QWN0aW9ucyhjb25maWcpO1xuICAgICAgICB0aGlzLnJvdXRlcyA9IHRoaXMubG9hZGVyLmdldFJvdXRlcyhjb25maWcpO1xuICAgICAgICB0aGlzLmZlYXR1cmVzID0gdGhpcy5sb2FkZXIuZ2V0RmVhdHVyZXMoY29uZmlnKTtcblxuICAgICAgICB0aGlzLnJ1bGVTZXJ2aWNlLnNldHVwKGNvbmZpZyk7XG4gICAgICAgIHRoaXMub25TZXR1cCQubmV4dChjb25maWcpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgZmVhdHVyZXMgYnkga2V5LlxuICAgICAqIEBwYXJhbSBrZXkgS2V5IHN0cmluZywgdXNpbmcgZG90IG5vdGF0aW9uXG4gICAgICogQHJldHVybnMgRmVhdHVyZXMgYXJyYXkgZm91bmQgYnkga2V5XG4gICAgICovXG4gICAgZ2V0RmVhdHVyZShrZXk6IHN0cmluZyk6IGFueVtdIHtcbiAgICAgICAgY29uc3QgcHJvcGVydGllczogc3RyaW5nW10gPSBBcnJheS5pc0FycmF5KGtleSkgPyBba2V5XSA6IGtleS5zcGxpdCgnLicpO1xuICAgICAgICByZXR1cm4gcHJvcGVydGllcy5yZWR1Y2UoKHByZXYsIGN1cnIpID0+IHByZXYgJiYgcHJldltjdXJyXSwgdGhpcy5mZWF0dXJlcykgfHwgW107XG4gICAgfVxuXG4gICAgZ2V0RWxlbWVudHM8VCBleHRlbmRzIEV4dGVuc2lvbkVsZW1lbnQ+KGtleTogc3RyaW5nLCBmYWxsYmFjazogQXJyYXk8VD4gPSBbXSk6IEFycmF5PFQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZGVyLmdldEVsZW1lbnRzKHRoaXMuY29uZmlnLCBrZXksIGZhbGxiYWNrKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIG9uZSBvciBtb3JlIG5ldyBydWxlIGV2YWx1YXRvcnMgdG8gdGhlIGV4aXN0aW5nIHNldC5cbiAgICAgKiBAcGFyYW0gdmFsdWVzIFRoZSBuZXcgZXZhbHVhdG9ycyB0byBhZGRcbiAgICAgKi9cbiAgICBzZXRFdmFsdWF0b3JzKHZhbHVlczogeyBba2V5OiBzdHJpbmddOiBSdWxlRXZhbHVhdG9yIH0pIHtcbiAgICAgICAgdGhpcy5ydWxlU2VydmljZS5zZXRFdmFsdWF0b3JzKHZhbHVlcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBvbmUgb3IgbW9yZSBuZXcgYXV0aCBndWFyZHMgdG8gdGhlIGV4aXN0aW5nIHNldC5cbiAgICAgKiBAcGFyYW0gdmFsdWVzIFRoZSBuZXcgYXV0aCBndWFyZHMgdG8gYWRkXG4gICAgICovXG4gICAgc2V0QXV0aEd1YXJkcyh2YWx1ZXM6IHsgW2tleTogc3RyaW5nXTogVHlwZTx7fT4gfSkge1xuICAgICAgICBpZiAodmFsdWVzKSB7XG4gICAgICAgICAgICB0aGlzLmF1dGhHdWFyZHMgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmF1dGhHdWFyZHMsIHZhbHVlcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIG9uZSBvciBtb3JlIG5ldyBjb21wb25lbnRzIHRvIHRoZSBleGlzdGluZyBzZXQuXG4gICAgICogQHBhcmFtIHZhbHVlcyBUaGUgbmV3IGNvbXBvbmVudHMgdG8gYWRkXG4gICAgICovXG4gICAgc2V0Q29tcG9uZW50cyh2YWx1ZXM6IHsgW2tleTogc3RyaW5nXTogVHlwZTx7fT4gfSkge1xuICAgICAgICB0aGlzLmNvbXBvbmVudFJlZ2lzdGVyLnNldENvbXBvbmVudHModmFsdWVzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXRyaWV2ZXMgYSByb3V0ZSB1c2luZyBpdHMgSUQgdmFsdWUuXG4gICAgICogQHBhcmFtIGlkIFRoZSBJRCB2YWx1ZSB0byBsb29rIGZvclxuICAgICAqIEByZXR1cm5zIFRoZSByb3V0ZSBvciBudWxsIGlmIG5vdCBmb3VuZFxuICAgICAqL1xuICAgIGdldFJvdXRlQnlJZChpZDogc3RyaW5nKTogUm91dGVSZWYge1xuICAgICAgICByZXR1cm4gdGhpcy5yb3V0ZXMuZmluZCgocm91dGUpID0+IHJvdXRlLmlkID09PSBpZCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0cmlldmVzIG9uZSBvciBtb3JlIGF1dGggZ3VhcmRzIHVzaW5nIGFuIGFycmF5IG9mIElEIHZhbHVlcy5cbiAgICAgKiBAcGFyYW0gaWRzIEFycmF5IG9mIElEIHZhbHVlIHRvIGxvb2sgZm9yXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgYXV0aCBndWFyZHMgb3IgZW1wdHkgYXJyYXkgaWYgbm9uZSB3ZXJlIGZvdW5kXG4gICAgICovXG4gICAgZ2V0QXV0aEd1YXJkcyhpZHM6IHN0cmluZ1tdKTogQXJyYXk8VHlwZTx7fT4+IHtcbiAgICAgICAgcmV0dXJuIChpZHMgfHwgW10pXG4gICAgICAgICAgICAubWFwKChpZCkgPT4gdGhpcy5hdXRoR3VhcmRzW2lkXSlcbiAgICAgICAgICAgIC5maWx0ZXIoKGd1YXJkKSA9PiBndWFyZCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0cmlldmVzIGFuIGFjdGlvbiB1c2luZyBpdHMgSUQgdmFsdWUuXG4gICAgICogQHBhcmFtIGlkIFRoZSBJRCB2YWx1ZSB0byBsb29rIGZvclxuICAgICAqIEByZXR1cm5zIEFjdGlvbiBvciBudWxsIGlmIG5vdCBmb3VuZFxuICAgICAqL1xuICAgIGdldEFjdGlvbkJ5SWQoaWQ6IHN0cmluZyk6IEFjdGlvblJlZiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFjdGlvbnMuZmluZCgoYWN0aW9uKSA9PiBhY3Rpb24uaWQgPT09IGlkKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXRyaWV2ZXMgYSBSdWxlRXZhbHVhdG9yIGZ1bmN0aW9uIHVzaW5nIGl0cyBrZXkgbmFtZS5cbiAgICAgKiBAcGFyYW0ga2V5IEtleSBuYW1lIHRvIGxvb2sgZm9yXG4gICAgICogQHJldHVybnMgUnVsZUV2YWx1YXRvciBvciBudWxsIGlmIG5vdCBmb3VuZFxuICAgICAqL1xuICAgIGdldEV2YWx1YXRvcihrZXk6IHN0cmluZyk6IFJ1bGVFdmFsdWF0b3Ige1xuICAgICAgICByZXR1cm4gdGhpcy5ydWxlU2VydmljZS5nZXRFdmFsdWF0b3Ioa2V5KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBFdmFsdWF0ZXMgYSBydWxlLlxuICAgICAqIEBwYXJhbSBydWxlSWQgSUQgb2YgdGhlIHJ1bGUgdG8gZXZhbHVhdGVcbiAgICAgKiBAcGFyYW0gY29udGV4dCBDdXN0b20gcnVsZSBleGVjdXRpb24gY29udGV4dC5cbiAgICAgKiBAcmV0dXJucyBUcnVlIGlmIHRoZSBydWxlIHBhc3NlZCwgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgZXZhbHVhdGVSdWxlKHJ1bGVJZDogc3RyaW5nLCBjb250ZXh0PzogUnVsZUNvbnRleHQpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucnVsZVNlcnZpY2UuZXZhbHVhdGVSdWxlKHJ1bGVJZCwgY29udGV4dCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0cmlldmVzIGEgcmVnaXN0ZXJlZCBleHRlbnNpb24gY29tcG9uZW50IHVzaW5nIGl0cyBJRCB2YWx1ZS5cbiAgICAgKiBAcGFyYW0gaWQgVGhlIElEIHZhbHVlIHRvIGxvb2sgZm9yXG4gICAgICogQHJldHVybnMgVGhlIGNvbXBvbmVudCBvciBudWxsIGlmIG5vdCBmb3VuZFxuICAgICAqL1xuICAgIGdldENvbXBvbmVudEJ5SWQ8VD4oaWQ6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gdGhpcy5jb21wb25lbnRSZWdpc3Rlci5nZXRDb21wb25lbnRCeUlkPFQ+KGlkKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXRyaWV2ZXMgYSBydWxlIHVzaW5nIGl0cyBJRCB2YWx1ZS5cbiAgICAgKiBAcGFyYW0gaWQgVGhlIElEIHZhbHVlIHRvIGxvb2sgZm9yXG4gICAgICogQHJldHVybnMgVGhlIHJ1bGUgb3IgbnVsbCBpZiBub3QgZm91bmRcbiAgICAgKi9cbiAgICBnZXRSdWxlQnlJZChpZDogc3RyaW5nKTogUnVsZVJlZiB7XG4gICAgICAgIHJldHVybiB0aGlzLnJ1bGVTZXJ2aWNlLmdldFJ1bGVCeUlkKGlkKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSdW5zIGEgbGlnaHR3ZWlnaHQgZXhwcmVzc2lvbiBzdG9yZWQgaW4gYSBzdHJpbmcuXG4gICAgICogQHBhcmFtIHZhbHVlIFN0cmluZyBjb250YWluaW5nIHRoZSBleHByZXNzaW9uIG9yIGxpdGVyYWwgdmFsdWVcbiAgICAgKiBAcGFyYW0gY29udGV4dCBQYXJhbWV0ZXIgb2JqZWN0IGZvciB0aGUgZXhwcmVzc2lvbiB3aXRoIGRldGFpbHMgb2YgYXBwIHN0YXRlXG4gICAgICogQHJldHVybnMgUmVzdWx0IG9mIGV2YWx1YXRlZCBleHByZXNzaW9uLCBpZiBmb3VuZCwgb3IgdGhlIGxpdGVyYWwgdmFsdWUgb3RoZXJ3aXNlXG4gICAgICovXG4gICAgcnVuRXhwcmVzc2lvbih2YWx1ZTogc3RyaW5nIHwge30gLCBjb250ZXh0PzogYW55KSB7XG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZhbHVhdGVFeHByZXNzaW9uKHZhbHVlLCBjb250ZXh0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGR1cGxpY2F0ZSA9IE9iamVjdC5hc3NpZ24oe30sIHZhbHVlKTtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKGR1cGxpY2F0ZSkuZm9yRWFjaCggKGtleSkgPT4ge1xuICAgICAgICAgICAgICAgIGR1cGxpY2F0ZVtrZXldID0gdGhpcy5ldmFsdWF0ZUV4cHJlc3Npb24oZHVwbGljYXRlW2tleV0sIGNvbnRleHQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gZHVwbGljYXRlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBldmFsdWF0ZUV4cHJlc3Npb24odmFsdWU6IHN0cmluZywgY29udGV4dD86IGFueSk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHBhdHRlcm4gPSBuZXcgUmVnRXhwKC9cXCRcXCgoLipcXCk/KVxcKS9nKTtcbiAgICAgICAgY29uc3QgbWF0Y2hlcyA9IHBhdHRlcm4uZXhlYyh2YWx1ZSk7XG5cbiAgICAgICAgaWYgKG1hdGNoZXMgJiYgbWF0Y2hlcy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICBjb25zdCBleHByZXNzaW9uID0gbWF0Y2hlc1sxXTtcbiAgICAgICAgICAgIGNvbnN0IGZuID0gbmV3IEZ1bmN0aW9uKCdjb250ZXh0JywgYHJldHVybiAke2V4cHJlc3Npb259YCk7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBmbihjb250ZXh0KTtcblxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxufVxuIl19