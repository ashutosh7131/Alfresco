import { Injectable } from '@angular/core';
import { from, throwError } from 'rxjs';
import { AlfrescoApiService } from './alfresco-api.service';
import { SitesApi } from '@alfresco/js-api';
import { catchError } from 'rxjs/operators';
import { LogService } from './log.service';
import * as i0 from "@angular/core";
import * as i1 from "./alfresco-api.service";
import * as i2 from "./log.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './alfresco-api.service';
import * as ɵngcc2 from './log.service';
export class SitesService {
    constructor(apiService, logService) {
        this.apiService = apiService;
        this.logService = logService;
    }
    get sitesApi() {
        var _a;
        this._sitesApi = (_a = this._sitesApi) !== null && _a !== void 0 ? _a : new SitesApi(this.apiService.getInstance());
        return this._sitesApi;
    }
    createSite(siteBody) {
        return from(this.sitesApi.createSite(siteBody))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getSites(opts = {}) {
        const defaultOptions = {
            skipCount: 0,
            include: ['properties']
        };
        const queryOptions = Object.assign({}, defaultOptions, opts);
        return from(this.sitesApi.listSites(queryOptions))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getSite(siteId, opts) {
        return from(this.sitesApi.getSite(siteId, opts))
            .pipe(catchError((err) => this.handleError(err)));
    }
    deleteSite(siteId, permanentFlag = true) {
        const options = {};
        options.permanent = permanentFlag;
        return from(this.sitesApi.deleteSite(siteId, options))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getSiteContent(siteId) {
        return this.getSite(siteId, { relations: ['containers'] });
    }
    getSiteMembers(siteId) {
        return this.getSite(siteId, { relations: ['members'] });
    }
    listSiteMemberships(siteId, opts) {
        return from(this.sitesApi.listSiteMemberships(siteId, opts));
    }
    getEcmCurrentLoggedUserName() {
        return this.apiService.getInstance().getEcmUsername();
    }
    getSiteNameFromNodePath(node) {
        let siteName = '';
        if (node.path && node.path.elements) {
            const foundNode = node.path
                .elements.find((pathNode) => pathNode.nodeType === 'st:site' &&
                pathNode.name !== 'Sites');
            siteName = foundNode ? foundNode.name : '';
        }
        return siteName.toLocaleLowerCase();
    }
    getSiteMembershipRequests(opts) {
        return from(this.sitesApi.getSiteMembershipRequests(opts))
            .pipe(catchError((err) => this.handleError(err)));
    }
    createSiteMembership(siteId, siteMembershipBodyCreate, opts) {
        return from(this.sitesApi.createSiteMembership(siteId, siteMembershipBodyCreate, opts))
            .pipe(catchError((err) => this.handleError(err)));
    }
    updateSiteMembership(siteId, personId, siteMembershipBodyUpdate, opts) {
        return from(this.sitesApi.updateSiteMembership(siteId, personId, siteMembershipBodyUpdate, opts))
            .pipe(catchError((err) => this.handleError(err)));
    }
    deleteSiteMembership(siteId, personId) {
        return from(this.sitesApi.deleteSiteMembership(siteId, personId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    approveSiteMembershipRequest(siteId, inviteeId, opts) {
        return from(this.sitesApi.approveSiteMembershipRequest(siteId, inviteeId, opts))
            .pipe(catchError((err) => this.handleError(err)));
    }
    rejectSiteMembershipRequest(siteId, inviteeId, opts) {
        return from(this.sitesApi.rejectSiteMembershipRequest(siteId, inviteeId, opts))
            .pipe(catchError((err) => this.handleError(err)));
    }
    listSiteGroups(siteId, opts) {
        return from(this.sitesApi.listSiteGroups(siteId, opts))
            .pipe(catchError((err) => this.handleError(err)));
    }
    createSiteGroupMembership(siteId, siteMembershipBodyCreate) {
        return from(this.sitesApi.createSiteGroupMembership(siteId, siteMembershipBodyCreate))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getSiteGroupMembership(siteId, groupId) {
        return from(this.sitesApi.getSiteGroupMembership(siteId, groupId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    updateSiteGroupMembership(siteId, groupId, siteMembershipBodyUpdate) {
        return from(this.sitesApi.updateSiteGroupMembership(siteId, groupId, siteMembershipBodyUpdate))
            .pipe(catchError((err) => this.handleError(err)));
    }
    deleteSiteGroupMembership(siteId, groupId) {
        return from(this.sitesApi.deleteSiteGroupMembership(siteId, groupId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    handleError(error) {
        this.logService.error(error);
        return throwError(error || 'Server error');
    }
}
SitesService.ɵfac = function SitesService_Factory(t) { return new (t || SitesService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc2.LogService)); };
SitesService.ɵprov = i0.ɵɵdefineInjectable({ factory: function SitesService_Factory() { return new SitesService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i2.LogService)); }, token: SitesService, providedIn: "root" });
SitesService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: LogService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(SitesService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc2.LogService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2l0ZXMuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvcmUvc2VydmljZXMvc2l0ZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFpQkEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsSUFBSSxFQUFjLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLEVBWUgsUUFBUSxFQUNYLE1BQU0sa0JBQWtCLENBQUM7QUFDMUIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0M7QUFFc0I7QUFJVDs7OztBQUZiLE1BQU0sT0FBTyxZQUFZO0FBQ3pCLElBT0ksWUFBb0IsVUFBOEIsRUFBVSxVQUFzQjtBQUN0RixRQUR3QixlQUFVLEdBQVYsVUFBVSxDQUFvQjtBQUFDLFFBQVMsZUFBVSxHQUFWLFVBQVUsQ0FBWTtBQUFDLElBQ25GLENBQUM7QUFDTCxJQVBJLElBQUksUUFBUTtBQUFLO0FBQ2YsUUFBRSxJQUFJLENBQUMsU0FBUyxTQUFHLElBQUksQ0FBQyxTQUFTLG1DQUFJLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztBQUN2RixRQUFRLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztBQUM5QixJQUFJLENBQUM7QUFDTCxJQVNJLFVBQVUsQ0FBQyxRQUF3QjtBQUFJLFFBQ25DLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3ZELGFB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Q0FBQztBQUNMLElBT0kseUJBQXlCLENBQUMsTUFBYyxFQUFFLE9BQWU7QUFBSSxRQUN6RCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLHlCQUF5QixDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztBQUM3RSxhQUFhLElBQUksQ0FDRCxVQUFVLENBQUMsQ0FBQyxHQUFRLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDbEQsQ0FBQztBQUNkLElBQUksQ0FBQztBQUNMLElBQ1ksV0FBVyxDQUFDLEtBQVU7QUFBSSxRQUM5QixJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNyQyxRQUFRLE9BQU8sVUFBVSxDQUFDLEtBQUssSUFBSSxjQUFjLENBQUMsQ0FBQztBQUNuRCxJQUFJLENBQUM7QUFDTDt5S0FBQztBQUNELCtOQW5SSztBQUFDO0VBSEwsVUFBVSxTQUFDLHJCQUtHLFlBdkJOLGtCQUFrQjtLQW1CdkIsVUFBVSxFQUFFLE1BQU0sdkJBbkJTLFlBZ0J0QixVQUFVO0FBQUc7U0FJckI7Ozs7O2dIQUp1QjtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZnJvbSwgT2JzZXJ2YWJsZSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlIH0gZnJvbSAnLi9hbGZyZXNjby1hcGkuc2VydmljZSc7XG5pbXBvcnQge1xuICAgIE1pbmltYWxOb2RlLFxuICAgIFNpdGVCb2R5Q3JlYXRlLFxuICAgIFNpdGVFbnRyeSxcbiAgICBTaXRlR3JvdXBFbnRyeSxcbiAgICBTaXRlR3JvdXBQYWdpbmcsXG4gICAgU2l0ZU1lbWJlckVudHJ5LFxuICAgIFNpdGVNZW1iZXJQYWdpbmcsXG4gICAgU2l0ZU1lbWJlcnNoaXBCb2R5Q3JlYXRlLFxuICAgIFNpdGVNZW1iZXJzaGlwQm9keVVwZGF0ZSxcbiAgICBTaXRlTWVtYmVyc2hpcFJlcXVlc3RXaXRoUGVyc29uUGFnaW5nLFxuICAgIFNpdGVQYWdpbmcsXG4gICAgU2l0ZXNBcGlcbn0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTG9nU2VydmljZSB9IGZyb20gJy4vbG9nLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFNpdGVzU2VydmljZSB7XG5cbiAgICBfc2l0ZXNBcGk6IFNpdGVzQXBpO1xuICAgIGdldCBzaXRlc0FwaSgpOiBTaXRlc0FwaSB7XG4gICAgICAgIHRoaXMuX3NpdGVzQXBpID0gdGhpcy5fc2l0ZXNBcGkgPz8gbmV3IFNpdGVzQXBpKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NpdGVzQXBpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlLCBwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2UpIHtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBzaXRlXG4gICAgICogQHBhcmFtIHNpdGVCb2R5IFNpdGVCb2R5Q3JlYXRlIHRvIGNyZWF0ZSBzaXRlXG4gICAgICogQHJldHVybnMgc2l0ZSBTaXRlRW50cnlcbiAgICAgKi9cbiAgICBjcmVhdGVTaXRlKHNpdGVCb2R5OiBTaXRlQm9keUNyZWF0ZSk6IE9ic2VydmFibGU8U2l0ZUVudHJ5PiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuc2l0ZXNBcGkuY3JlYXRlU2l0ZShzaXRlQm9keSkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IGFueSkgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGEgbGlzdCBvZiBhbGwgc2l0ZXMgaW4gdGhlIHJlcG9zaXRvcnkuXG4gICAgICogQHBhcmFtIG9wdHMgT3B0aW9ucyBzdXBwb3J0ZWQgYnkgSlMtQVBJXG4gICAgICogQHJldHVybnMgTGlzdCBvZiBzaXRlc1xuICAgICAqL1xuICAgIGdldFNpdGVzKG9wdHM6IGFueSA9IHt9KTogT2JzZXJ2YWJsZTxTaXRlUGFnaW5nPiB7XG4gICAgICAgIGNvbnN0IGRlZmF1bHRPcHRpb25zID0ge1xuICAgICAgICAgICAgc2tpcENvdW50OiAwLFxuICAgICAgICAgICAgaW5jbHVkZTogWydwcm9wZXJ0aWVzJ11cbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgcXVlcnlPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgZGVmYXVsdE9wdGlvbnMsIG9wdHMpO1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnNpdGVzQXBpLmxpc3RTaXRlcyhxdWVyeU9wdGlvbnMpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyOiBhbnkpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgZGV0YWlscyBmb3IgYSBzaXRlLlxuICAgICAqIEBwYXJhbSBzaXRlSWQgSUQgb2YgdGhlIHRhcmdldCBzaXRlXG4gICAgICogQHBhcmFtIG9wdHMgT3B0aW9ucyBzdXBwb3J0ZWQgYnkgSlMtQVBJXG4gICAgICogQHJldHVybnMgSW5mb3JtYXRpb24gYWJvdXQgdGhlIHNpdGVcbiAgICAgKi9cbiAgICBnZXRTaXRlKHNpdGVJZDogc3RyaW5nLCBvcHRzPzogYW55KTogT2JzZXJ2YWJsZTxTaXRlRW50cnkgfCB7fT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnNpdGVzQXBpLmdldFNpdGUoc2l0ZUlkLCBvcHRzKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogYW55KSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlbGV0ZXMgYSBzaXRlLlxuICAgICAqIEBwYXJhbSBzaXRlSWQgU2l0ZSB0byBkZWxldGVcbiAgICAgKiBAcGFyYW0gcGVybWFuZW50RmxhZyBUcnVlOiBkZWxldGlvbiBpcyBwZXJtYW5lbnQ7IEZhbHNlOiBzaXRlIGlzIG1vdmVkIHRvIHRoZSB0cmFzaFxuICAgICAqIEByZXR1cm5zIE51bGwgcmVzcG9uc2Ugbm90aWZ5aW5nIHdoZW4gdGhlIG9wZXJhdGlvbiBpcyBjb21wbGV0ZVxuICAgICAqL1xuICAgIGRlbGV0ZVNpdGUoc2l0ZUlkOiBzdHJpbmcsIHBlcm1hbmVudEZsYWc6IGJvb2xlYW4gPSB0cnVlKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgY29uc3Qgb3B0aW9uczogYW55ID0ge307XG4gICAgICAgIG9wdGlvbnMucGVybWFuZW50ID0gcGVybWFuZW50RmxhZztcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5zaXRlc0FwaS5kZWxldGVTaXRlKHNpdGVJZCwgb3B0aW9ucykpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IGFueSkgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGEgc2l0ZSdzIGNvbnRlbnQuXG4gICAgICogQHBhcmFtIHNpdGVJZCBJRCBvZiB0aGUgdGFyZ2V0IHNpdGVcbiAgICAgKiBAcmV0dXJucyBTaXRlIGNvbnRlbnRcbiAgICAgKi9cbiAgICBnZXRTaXRlQ29udGVudChzaXRlSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8U2l0ZUVudHJ5IHwge30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2l0ZShzaXRlSWQsIHsgcmVsYXRpb25zOiBbJ2NvbnRhaW5lcnMnXSB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGEgbGlzdCBvZiBhbGwgYSBzaXRlJ3MgbWVtYmVycy5cbiAgICAgKiBAcGFyYW0gc2l0ZUlkIElEIG9mIHRoZSB0YXJnZXQgc2l0ZVxuICAgICAqIEByZXR1cm5zIFNpdGUgbWVtYmVyc1xuICAgICAqL1xuICAgIGdldFNpdGVNZW1iZXJzKHNpdGVJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxTaXRlRW50cnkgfCB7fT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRTaXRlKHNpdGVJZCwgeyByZWxhdGlvbnM6IFsnbWVtYmVycyddIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSBsaXN0IG9mIGFsbCBhIHNpdGUncyBtZW1iZXJzLlxuICAgICAqIEBwYXJhbSBzaXRlSWQgSUQgb2YgdGhlIHRhcmdldCBzaXRlXG4gICAgICogQHBhcmFtIG9wdHMgT3B0aW9uYWwgcGFyYW1ldGVycyBzdXBwb3J0ZWQgYnkgSlMtQVBJXG4gICAgICogQHJldHVybnMgT2JzZXJ2YWJsZTxTaXRlTWVtYmVyUGFnaW5nPlxuICAgICAqL1xuICAgIGxpc3RTaXRlTWVtYmVyc2hpcHMoc2l0ZUlkOiBzdHJpbmcsIG9wdHM6IGFueSk6IE9ic2VydmFibGU8U2l0ZU1lbWJlclBhZ2luZz4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnNpdGVzQXBpLmxpc3RTaXRlTWVtYmVyc2hpcHMoc2l0ZUlkLCBvcHRzKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgdXNlcm5hbWUgb2YgdGhlIHVzZXIgY3VycmVudGx5IGxvZ2dlZCBpbnRvIEFDUy5cbiAgICAgKiBAcmV0dXJucyBVc2VybmFtZSBzdHJpbmdcbiAgICAgKi9cbiAgICBnZXRFY21DdXJyZW50TG9nZ2VkVXNlck5hbWUoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmdldEVjbVVzZXJuYW1lKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9va3MgZm9yIGEgc2l0ZSBpbnNpZGUgdGhlIHBhdGggb2YgYSBOb2RlIGFuZCByZXR1cm5zIGl0cyBndWlkIGlmIGl0IGZpbmRzIG9uZS5cbiAgICAgKiAocmV0dXJuIGFuIGVtcHR5IHN0cmluZyBpZiBubyBzaXRlIGlzIGZvdW5kKVxuICAgICAqIEBwYXJhbSBub2RlIE5vZGUgdG8gbG9vayBmb3IgcGFyZW50IHNpdGVcbiAgICAgKiBAcmV0dXJucyBTaXRlIGd1aWRcbiAgICAgKi9cbiAgICBnZXRTaXRlTmFtZUZyb21Ob2RlUGF0aChub2RlOiBNaW5pbWFsTm9kZSk6IHN0cmluZyB7XG4gICAgICAgIGxldCBzaXRlTmFtZSA9ICcnO1xuICAgICAgICBpZiAobm9kZS5wYXRoICYmIG5vZGUucGF0aC5lbGVtZW50cykge1xuICAgICAgICAgICAgY29uc3QgZm91bmROb2RlID0gbm9kZS5wYXRoXG4gICAgICAgICAgICAgICAgLmVsZW1lbnRzLmZpbmQoKHBhdGhOb2RlOiBNaW5pbWFsTm9kZSkgPT5cbiAgICAgICAgICAgICAgICAgICAgcGF0aE5vZGUubm9kZVR5cGUgPT09ICdzdDpzaXRlJyAmJlxuICAgICAgICAgICAgICAgICAgICBwYXRoTm9kZS5uYW1lICE9PSAnU2l0ZXMnKTtcbiAgICAgICAgICAgIHNpdGVOYW1lID0gZm91bmROb2RlID8gZm91bmROb2RlLm5hbWUgOiAnJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc2l0ZU5hbWUudG9Mb2NhbGVMb3dlckNhc2UoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGEgbGlzdCBvZiBzaXRlIG1lbWJlcnNoaXAgcmVxdWVzdHMuXG4gICAgICogQHBhcmFtIG9wdHMgT3B0aW9ucyBzdXBwb3J0ZWQgYnkgSlMtQVBJXG4gICAgICogQHJldHVybnMgU2l0ZSBtZW1iZXJzaGlwIHJlcXVlc3RzXG4gICAgICovXG4gICAgZ2V0U2l0ZU1lbWJlcnNoaXBSZXF1ZXN0cyhvcHRzPzogYW55KTogT2JzZXJ2YWJsZTxTaXRlTWVtYmVyc2hpcFJlcXVlc3RXaXRoUGVyc29uUGFnaW5nPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuc2l0ZXNBcGkuZ2V0U2l0ZU1lbWJlcnNoaXBSZXF1ZXN0cyhvcHRzKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogYW55KSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSBzaXRlIG1lbWJlcnNoaXAgZm9yIHBlcnNvbiAqKnBlcnNvbklkKiogb24gc2l0ZSAqKnNpdGVJZCoqLlxuICAgICAqIEBwYXJhbSBzaXRlSWQgVGhlIGlkZW50aWZpZXIgb2YgYSBzaXRlXG4gICAgICogQHBhcmFtIHNpdGVNZW1iZXJzaGlwQm9keUNyZWF0ZSBUaGUgcGVyc29uIHRvIGFkZCBhbmQgdGhlaXIgcm9sZVxuICAgICAqIEBwYXJhbSBvcHRzIE9wdGlvbmFsIHBhcmFtZXRlcnNcbiAgICAgKiBAcmV0dXJuIE9ic2VydmFibGU8U2l0ZU1lbWJlckVudHJ5PlxuICAgICAqL1xuICAgIGNyZWF0ZVNpdGVNZW1iZXJzaGlwKHNpdGVJZDogc3RyaW5nLCBzaXRlTWVtYmVyc2hpcEJvZHlDcmVhdGU6IFNpdGVNZW1iZXJzaGlwQm9keUNyZWF0ZSwgb3B0cz86IGFueSk6IE9ic2VydmFibGU8U2l0ZU1lbWJlckVudHJ5PiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuc2l0ZXNBcGkuY3JlYXRlU2l0ZU1lbWJlcnNoaXAoc2l0ZUlkLCBzaXRlTWVtYmVyc2hpcEJvZHlDcmVhdGUsIG9wdHMpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyOiBhbnkpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGEgc2l0ZSBtZW1iZXJzaGlwXG4gICAgICogQHBhcmFtIHNpdGVJZCBUaGUgaWRlbnRpZmllciBvZiBhIHNpdGUuXG4gICAgICogQHBhcmFtIHBlcnNvbklkIFRoZSBpZGVudGlmaWVyIG9mIGEgcGVyc29uLlxuICAgICAqIEBwYXJhbSBzaXRlTWVtYmVyc2hpcEJvZHlVcGRhdGUgVGhlIHBlcnNvbnMgbmV3IHJvbGVcbiAgICAgKiBAcGFyYW0gb3B0cyBPcHRpb25hbCBwYXJhbWV0ZXJzXG4gICAgICogQHJldHVybiBPYnNlcnZhYmxlPFNpdGVNZW1iZXJFbnRyeT5cbiAgICAgKi9cbiAgICB1cGRhdGVTaXRlTWVtYmVyc2hpcChzaXRlSWQ6IHN0cmluZywgcGVyc29uSWQ6IHN0cmluZywgc2l0ZU1lbWJlcnNoaXBCb2R5VXBkYXRlOiBTaXRlTWVtYmVyc2hpcEJvZHlVcGRhdGUsIG9wdHM/OiBhbnkpOiBPYnNlcnZhYmxlPFNpdGVNZW1iZXJFbnRyeT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnNpdGVzQXBpLnVwZGF0ZVNpdGVNZW1iZXJzaGlwKHNpdGVJZCwgcGVyc29uSWQsIHNpdGVNZW1iZXJzaGlwQm9keVVwZGF0ZSwgb3B0cykpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IGFueSkgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZWxldGUgYSBzaXRlIG1lbWJlcnNoaXBcbiAgICAgKiBAcGFyYW0gc2l0ZUlkIFRoZSBpZGVudGlmaWVyIG9mIGEgc2l0ZS5cbiAgICAgKiBAcGFyYW0gcGVyc29uSWQgVGhlIGlkZW50aWZpZXIgb2YgYSBwZXJzb24uXG4gICAgICogQHJldHVybiAgTnVsbCByZXNwb25zZSBub3RpZnlpbmcgd2hlbiB0aGUgb3BlcmF0aW9uIGlzIGNvbXBsZXRlXG4gICAgICovXG4gICAgZGVsZXRlU2l0ZU1lbWJlcnNoaXAoc2l0ZUlkOiBzdHJpbmcsIHBlcnNvbklkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5zaXRlc0FwaS5kZWxldGVTaXRlTWVtYmVyc2hpcChzaXRlSWQsIHBlcnNvbklkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogYW55KSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFjY2VwdCBzaXRlIG1lbWJlcnNoaXAgcmVxdWVzdHMuXG4gICAgICogQHBhcmFtIHNpdGVJZCBUaGUgaWRlbnRpZmllciBvZiBhIHNpdGUuXG4gICAgICogQHBhcmFtIGludml0ZWVJZCBUaGUgaW52aXRlZSB1c2VyIG5hbWUuXG4gICAgICogQHBhcmFtIG9wdHMgT3B0aW9ucyBzdXBwb3J0ZWQgYnkgSlMtQVBJXG4gICAgICogQHJldHVybnMgIE51bGwgcmVzcG9uc2Ugbm90aWZ5aW5nIHdoZW4gdGhlIG9wZXJhdGlvbiBpcyBjb21wbGV0ZVxuICAgICAqL1xuICAgIGFwcHJvdmVTaXRlTWVtYmVyc2hpcFJlcXVlc3Qoc2l0ZUlkOiBzdHJpbmcsIGludml0ZWVJZDogc3RyaW5nLCBvcHRzPzogYW55KTogT2JzZXJ2YWJsZTxTaXRlTWVtYmVyc2hpcFJlcXVlc3RXaXRoUGVyc29uUGFnaW5nPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuc2l0ZXNBcGkuYXBwcm92ZVNpdGVNZW1iZXJzaGlwUmVxdWVzdChzaXRlSWQsIGludml0ZWVJZCwgb3B0cykpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IGFueSkgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZWplY3Qgc2l0ZSBtZW1iZXJzaGlwIHJlcXVlc3RzLlxuICAgICAqIEBwYXJhbSBzaXRlSWQgVGhlIGlkZW50aWZpZXIgb2YgYSBzaXRlLlxuICAgICAqIEBwYXJhbSBpbnZpdGVlSWQgVGhlIGludml0ZWUgdXNlciBuYW1lLlxuICAgICAqIEBwYXJhbSBvcHRzIE9wdGlvbnMgc3VwcG9ydGVkIGJ5IEpTLUFQSVxuICAgICAqIEByZXR1cm5zICBOdWxsIHJlc3BvbnNlIG5vdGlmeWluZyB3aGVuIHRoZSBvcGVyYXRpb24gaXMgY29tcGxldGVcbiAgICAgKi9cbiAgICByZWplY3RTaXRlTWVtYmVyc2hpcFJlcXVlc3Qoc2l0ZUlkOiBzdHJpbmcsIGludml0ZWVJZDogc3RyaW5nLCBvcHRzPzogYW55KTogT2JzZXJ2YWJsZTxTaXRlTWVtYmVyc2hpcFJlcXVlc3RXaXRoUGVyc29uUGFnaW5nPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuc2l0ZXNBcGkucmVqZWN0U2l0ZU1lbWJlcnNoaXBSZXF1ZXN0KHNpdGVJZCwgaW52aXRlZUlkLCBvcHRzKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogYW55KSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExpc3QgZ3JvdXAgbWVtYmVyc2hpcCBmb3Igc2l0ZVxuICAgICAqIEBwYXJhbSBzaXRlSWQgVGhlIGlkZW50aWZpZXIgb2YgYSBzaXRlLlxuICAgICAqIEBwYXJhbSBvcHRzIE9wdGlvbnMgc3VwcG9ydGVkIGJ5IEpTLUFQSVxuICAgICAqIEByZXR1cm5zICBPYnNlcnZhYmxlPFNpdGVHcm91cFBhZ2luZz5cbiAgICAgKi9cbiAgICBsaXN0U2l0ZUdyb3VwcyhzaXRlSWQ6IHN0cmluZywgb3B0cz86IGFueSk6IE9ic2VydmFibGU8U2l0ZUdyb3VwUGFnaW5nPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuc2l0ZXNBcGkubGlzdFNpdGVHcm91cHMoc2l0ZUlkLCBvcHRzKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogYW55KSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIHNpdGUgbWVtYmVyc2hpcCBmb3IgZ3JvdXBcbiAgICAgKiBAcGFyYW0gc2l0ZUlkIFRoZSBpZGVudGlmaWVyIG9mIGEgc2l0ZS5cbiAgICAgKiBAcGFyYW0gc2l0ZU1lbWJlcnNoaXBCb2R5Q3JlYXRlIFRoZSBHcm91cCB0byBhZGQgYW5kIGl0cyByb2xlXG4gICAgICogQHJldHVybnMgT2JzZXJ2YWJsZTxTaXRlR3JvdXBFbnRyeT5cbiAgICAgKi9cbiAgICBjcmVhdGVTaXRlR3JvdXBNZW1iZXJzaGlwKHNpdGVJZDogc3RyaW5nLCBzaXRlTWVtYmVyc2hpcEJvZHlDcmVhdGU6IFNpdGVNZW1iZXJzaGlwQm9keUNyZWF0ZSk6IE9ic2VydmFibGU8U2l0ZUdyb3VwRW50cnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5zaXRlc0FwaS5jcmVhdGVTaXRlR3JvdXBNZW1iZXJzaGlwKHNpdGVJZCwgc2l0ZU1lbWJlcnNoaXBCb2R5Q3JlYXRlKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogYW55KSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBpbmZvcm1hdGlvbiBhYm91dCBzaXRlIG1lbWJlcnNoaXAgb2YgZ3JvdXBcbiAgICAgKiBAcGFyYW0gc2l0ZUlkIFRoZSBpZGVudGlmaWVyIG9mIGEgc2l0ZS5cbiAgICAgKiBAcGFyYW0gZ3JvdXBJZCBUaGUgYXV0aG9yaXR5SWQgb2YgYSBncm91cC5cbiAgICAgKiBAcmV0dXJuIE9ic2VydmFibGU8U2l0ZUdyb3VwRW50cnk+XG4gICAgICovXG4gICAgZ2V0U2l0ZUdyb3VwTWVtYmVyc2hpcChzaXRlSWQ6IHN0cmluZywgZ3JvdXBJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxTaXRlR3JvdXBFbnRyeT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnNpdGVzQXBpLmdldFNpdGVHcm91cE1lbWJlcnNoaXAoc2l0ZUlkLCBncm91cElkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogYW55KSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBzaXRlIG1lbWJlcnNoaXAgb2YgZ3JvdXBcbiAgICAgKiBAcGFyYW0gc2l0ZUlkIFRoZSBpZGVudGlmaWVyIG9mIGEgc2l0ZS5cbiAgICAgKiBAcGFyYW0gZ3JvdXBJZCBUaGUgYXV0aG9yaXR5SWQgb2YgYSBncm91cC5cbiAgICAgKiBAcGFyYW0gc2l0ZU1lbWJlcnNoaXBCb2R5VXBkYXRlIFRoZSBncm91cCBuZXcgcm9sZVxuICAgICAqIEByZXR1cm4gT2JzZXJ2YWJsZTxTaXRlR3JvdXBFbnRyeT5cbiAgICAgKi9cbiAgICB1cGRhdGVTaXRlR3JvdXBNZW1iZXJzaGlwKHNpdGVJZDogc3RyaW5nLCBncm91cElkOiBzdHJpbmcsIHNpdGVNZW1iZXJzaGlwQm9keVVwZGF0ZTogU2l0ZU1lbWJlcnNoaXBCb2R5VXBkYXRlKTogT2JzZXJ2YWJsZTxTaXRlR3JvdXBFbnRyeT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnNpdGVzQXBpLnVwZGF0ZVNpdGVHcm91cE1lbWJlcnNoaXAoc2l0ZUlkLCBncm91cElkLCBzaXRlTWVtYmVyc2hpcEJvZHlVcGRhdGUpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyOiBhbnkpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVsZXRlIGEgZ3JvdXAgbWVtYmVyc2hpcCBmb3Igc2l0ZVxuICAgICAqIEBwYXJhbSBzaXRlSWQgVGhlIGlkZW50aWZpZXIgb2YgYSBzaXRlLlxuICAgICAqIEBwYXJhbSBncm91cElkIFRoZSBhdXRob3JpdHlJZCBvZiBhIGdyb3VwLlxuICAgICAqIEByZXR1cm4gT2JzZXJ2YWJsZTx2b2lkPlxuICAgICAqL1xuICAgIGRlbGV0ZVNpdGVHcm91cE1lbWJlcnNoaXAoc2l0ZUlkOiBzdHJpbmcsIGdyb3VwSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8dm9pZD4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnNpdGVzQXBpLmRlbGV0ZVNpdGVHcm91cE1lbWJlcnNoaXAoc2l0ZUlkLCBncm91cElkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogYW55KSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlRXJyb3IoZXJyb3I6IGFueSk6IE9ic2VydmFibGU8bmV2ZXI+IHtcbiAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGVycm9yKTtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IgfHwgJ1NlcnZlciBlcnJvcicpO1xuICAgIH1cbn1cbiJdfQ==