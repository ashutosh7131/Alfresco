import { Injectable } from '@angular/core';
import { Minimatch } from 'minimatch';
import { Subject } from 'rxjs';
import { AppConfigService } from '../app-config/app-config.service';
import { FileUploadCompleteEvent, FileUploadDeleteEvent, FileUploadErrorEvent, FileUploadEvent } from '../events/file.event';
import { FileUploadStatus } from '../models/file.model';
import { AlfrescoApiService } from './alfresco-api.service';
import { DiscoveryApiService } from './discovery-api.service';
import { filter } from 'rxjs/operators';
import { NodesApi, UploadApi, VersionsApi } from '@alfresco/js-api';
import * as i0 from "@angular/core";
import * as i1 from "./alfresco-api.service";
import * as i2 from "../app-config/app-config.service";
import * as i3 from "./discovery-api.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './alfresco-api.service';
import * as ɵngcc2 from '../app-config/app-config.service';
import * as ɵngcc3 from './discovery-api.service';
const MIN_CANCELLABLE_FILE_SIZE = 1000000;
const MAX_CANCELLABLE_FILE_PERCENTAGE = 50;
export class UploadService {
    constructor(apiService, appConfigService, discoveryApiService) {
        this.apiService = apiService;
        this.appConfigService = appConfigService;
        this.discoveryApiService = discoveryApiService;
        this.cache = {};
        this.totalComplete = 0;
        this.totalAborted = 0;
        this.totalError = 0;
        this.excludedFileList = [];
        this.excludedFoldersList = [];
        this.matchingOptions = null;
        this.folderMatchingOptions = null;
        this.activeTask = null;
        this.queue = [];
        this.queueChanged = new Subject();
        this.fileUpload = new Subject();
        this.fileUploadStarting = new Subject();
        this.fileUploadCancelled = new Subject();
        this.fileUploadProgress = new Subject();
        this.fileUploadAborted = new Subject();
        this.fileUploadError = new Subject();
        this.fileUploadComplete = new Subject();
        this.fileUploadDeleted = new Subject();
        this.fileDeleted = new Subject();
        this.discoveryApiService.ecmProductInfo$.pipe(filter(info => !!info))
            .subscribe(({ status }) => {
            this.isThumbnailGenerationEnabled = status.isThumbnailGenerationEnabled;
        });
    }
    get uploadApi() {
        var _a;
        this._uploadApi = (_a = this._uploadApi) !== null && _a !== void 0 ? _a : new UploadApi(this.apiService.getInstance());
        return this._uploadApi;
    }
    get nodesApi() {
        var _a;
        this._nodesApi = (_a = this._nodesApi) !== null && _a !== void 0 ? _a : new NodesApi(this.apiService.getInstance());
        return this._nodesApi;
    }
    get versionsApi() {
        var _a;
        this._versionsApi = (_a = this._versionsApi) !== null && _a !== void 0 ? _a : new VersionsApi(this.apiService.getInstance());
        return this._versionsApi;
    }
    isUploading() {
        const finishedFileStates = [FileUploadStatus.Complete, FileUploadStatus.Cancelled, FileUploadStatus.Aborted, FileUploadStatus.Error, FileUploadStatus.Deleted];
        return this.queue.reduce((stillUploading, currentFile) => {
            return stillUploading || finishedFileStates.indexOf(currentFile.status) === -1;
        }, false);
    }
    getQueue() {
        return this.queue;
    }
    addToQueue(...files) {
        const allowedFiles = files.filter((currentFile) => this.filterElement(currentFile));
        this.queue = this.queue.concat(allowedFiles);
        this.queueChanged.next(this.queue);
        return allowedFiles;
    }
    filterElement(file) {
        this.excludedFileList = this.appConfigService.get('files.excluded');
        this.excludedFoldersList = this.appConfigService.get('folders.excluded');
        let isAllowed = true;
        if (this.excludedFileList) {
            this.matchingOptions = this.appConfigService.get('files.match-options');
            isAllowed = this.isFileNameAllowed(file);
        }
        if (isAllowed && this.excludedFoldersList) {
            this.folderMatchingOptions = this.appConfigService.get('folders.match-options');
            isAllowed = this.isParentFolderAllowed(file);
        }
        return isAllowed;
    }
    isParentFolderAllowed(file) {
        let isAllowed = true;
        const currentFile = file.file;
        const fileRelativePath = currentFile.webkitRelativePath ? currentFile.webkitRelativePath : file.options.path;
        if (currentFile && fileRelativePath) {
            isAllowed =
                this.excludedFoldersList.filter((folderToExclude) => {
                    return fileRelativePath
                        .split('/')
                        .some((pathElement) => {
                        const minimatch = new Minimatch(folderToExclude, this.folderMatchingOptions);
                        return minimatch.match(pathElement);
                    });
                }).length === 0;
        }
        return isAllowed;
    }
    isFileNameAllowed(file) {
        return (this.excludedFileList.filter((pattern) => {
            const minimatch = new Minimatch(pattern, this.matchingOptions);
            return minimatch.match(file.name);
        }).length === 0);
    }
    uploadFilesInTheQueue(successEmitter, errorEmitter) {
        if (!this.activeTask) {
            const file = this.queue.find((currentFile) => currentFile.status === FileUploadStatus.Pending);
            if (file) {
                this.onUploadStarting(file);
                const promise = this.beginUpload(file, successEmitter, errorEmitter);
                this.activeTask = promise;
                this.cache[file.name] = promise;
                const next = () => {
                    this.activeTask = null;
                    setTimeout(() => this.uploadFilesInTheQueue(successEmitter, errorEmitter), 100);
                };
                promise.next = next;
                promise.then(() => next(), () => next());
            }
        }
    }
    cancelUpload(...files) {
        files.forEach((file) => {
            const promise = this.cache[file.name];
            if (promise) {
                if (this.isSaveToAbortFile(file)) {
                    promise.abort();
                }
                this.abortedFile = file.name;
                delete this.cache[file.name];
                promise.next();
            }
            else {
                const performAction = this.getAction(file);
                performAction();
            }
        });
    }
    clearQueue() {
        this.queue = [];
        this.totalComplete = 0;
        this.totalAborted = 0;
        this.totalError = 0;
    }
    getUploadPromise(file) {
        const opts = {
            include: ['allowableOperations']
        };
        if (this.isThumbnailGenerationEnabled) {
            opts.renditions = 'doclib';
        }
        if (file.options && file.options.versioningEnabled !== undefined) {
            opts.versioningEnabled = file.options.versioningEnabled;
        }
        if (file.options.newVersion === true) {
            opts.overwrite = true;
            opts.majorVersion = file.options.majorVersion;
            opts.comment = file.options.comment;
            opts.name = file.name;
        }
        else {
            opts.autoRename = true;
        }
        if (file.options.nodeType) {
            opts.nodeType = file.options.nodeType;
        }
        if (file.id) {
            return this.nodesApi.updateNodeContent(file.id, file.file, opts);
        }
        else {
            const nodeBody = Object.assign({}, file.options);
            delete nodeBody['versioningEnabled'];
            return this.uploadApi.uploadFile(file.file, file.options.path, file.options.parentId, nodeBody, opts);
        }
    }
    beginUpload(file, successEmitter, errorEmitter) {
        const promise = this.getUploadPromise(file);
        promise
            .on('progress', (progress) => {
            this.onUploadProgress(file, progress);
        })
            .on('abort', () => {
            this.onUploadAborted(file);
            if (successEmitter) {
                successEmitter.emit({ value: 'File aborted' });
            }
        })
            .on('error', (err) => {
            this.onUploadError(file, err);
            if (errorEmitter) {
                errorEmitter.emit({ value: 'Error file uploaded' });
            }
        })
            .on('success', (data) => {
            if (this.abortedFile === file.name) {
                this.onUploadAborted(file);
                if (file.id === undefined) {
                    this.deleteAbortedNode(data.entry.id);
                }
                else {
                    this.deleteAbortedNodeVersion(data.entry.id, data.entry.properties['cm:versionLabel']);
                }
                if (successEmitter) {
                    successEmitter.emit({ value: 'File deleted' });
                }
            }
            else {
                this.onUploadComplete(file, data);
                if (successEmitter) {
                    successEmitter.emit({ value: data });
                }
            }
        })
            .catch(() => {
        });
        return promise;
    }
    onUploadStarting(file) {
        if (file) {
            file.status = FileUploadStatus.Starting;
            const event = new FileUploadEvent(file, FileUploadStatus.Starting);
            this.fileUpload.next(event);
            this.fileUploadStarting.next(event);
        }
    }
    onUploadProgress(file, progress) {
        if (file) {
            file.progress = progress;
            file.status = FileUploadStatus.Progress;
            const event = new FileUploadEvent(file, FileUploadStatus.Progress);
            this.fileUpload.next(event);
            this.fileUploadProgress.next(event);
        }
    }
    onUploadError(file, error) {
        if (file) {
            file.errorCode = (error || {}).status;
            file.status = FileUploadStatus.Error;
            this.totalError++;
            const promise = this.cache[file.name];
            if (promise) {
                delete this.cache[file.name];
            }
            const event = new FileUploadErrorEvent(file, error, this.totalError);
            this.fileUpload.next(event);
            this.fileUploadError.next(event);
        }
    }
    onUploadComplete(file, data) {
        if (file) {
            file.status = FileUploadStatus.Complete;
            file.data = data;
            this.totalComplete++;
            const promise = this.cache[file.name];
            if (promise) {
                delete this.cache[file.name];
            }
            const event = new FileUploadCompleteEvent(file, this.totalComplete, data, this.totalAborted);
            this.fileUpload.next(event);
            this.fileUploadComplete.next(event);
        }
    }
    onUploadAborted(file) {
        if (file) {
            file.status = FileUploadStatus.Aborted;
            this.totalAborted++;
            const event = new FileUploadEvent(file, FileUploadStatus.Aborted);
            this.fileUpload.next(event);
            this.fileUploadAborted.next(event);
        }
    }
    onUploadCancelled(file) {
        if (file) {
            file.status = FileUploadStatus.Cancelled;
            const event = new FileUploadEvent(file, FileUploadStatus.Cancelled);
            this.fileUpload.next(event);
            this.fileUploadCancelled.next(event);
        }
    }
    onUploadDeleted(file) {
        if (file) {
            file.status = FileUploadStatus.Deleted;
            this.totalComplete--;
            const event = new FileUploadDeleteEvent(file, this.totalComplete);
            this.fileUpload.next(event);
            this.fileUploadDeleted.next(event);
        }
    }
    getAction(file) {
        const actions = {
            [FileUploadStatus.Pending]: () => this.onUploadCancelled(file),
            [FileUploadStatus.Deleted]: () => this.onUploadDeleted(file),
            [FileUploadStatus.Error]: () => this.onUploadError(file, null)
        };
        return actions[file.status];
    }
    deleteAbortedNode(nodeId) {
        this.nodesApi.deleteNode(nodeId, { permanent: true })
            .then(() => (this.abortedFile = undefined));
    }
    deleteAbortedNodeVersion(nodeId, versionId) {
        this.versionsApi.deleteVersion(nodeId, versionId)
            .then(() => (this.abortedFile = undefined));
    }
    isSaveToAbortFile(file) {
        return (file.size > MIN_CANCELLABLE_FILE_SIZE &&
            file.progress.percent < MAX_CANCELLABLE_FILE_PERCENTAGE);
    }
}
UploadService.ɵfac = function UploadService_Factory(t) { return new (t || UploadService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc2.AppConfigService), ɵngcc0.ɵɵinject(ɵngcc3.DiscoveryApiService)); };
UploadService.ɵprov = i0.ɵɵdefineInjectable({ factory: function UploadService_Factory() { return new UploadService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i2.AppConfigService), i0.ɵɵinject(i3.DiscoveryApiService)); }, token: UploadService, providedIn: "root" });
UploadService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: AppConfigService },
    { type: DiscoveryApiService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(UploadService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc2.AppConfigService }, { type: ɵngcc3.DiscoveryApiService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb3JlL3NlcnZpY2VzL3VwbG9hZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQWdCLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDcEUsT0FBTyxFQUNILHVCQUF1QixFQUN2QixxQkFBcUIsRUFDckIsb0JBQW9CLEVBQ3BCLGVBQWUsRUFDbEIsTUFBTSxzQkFBc0IsQ0FBQztBQUM5QixPQUFPLEVBQWlDLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDdkYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDOUQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3BFO0FBQ29DO0FBQ0c7QUFLN0I7Ozs7O0FBTlYsTUFBTSx5QkFBeUIsR0FBRyxPQUFPLENBQUM7QUFDMUMsTUFBTSwrQkFBK0IsR0FBRyxFQUFFLENBQUM7QUFLM0MsTUFBTSxPQUFPLGFBQWE7QUFDMUIsSUEyQ0ksWUFDYyxVQUE4QixFQUNoQyxnQkFBa0MsRUFDbEMsbUJBQXdDO0FBQ3hELFFBSGtCLGVBQVUsR0FBVixVQUFVLENBQW9CO0FBQUMsUUFDakMscUJB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QUFBRzs7Ozs7OzRKQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE1pbmltYXRjaCB9IGZyb20gJ21pbmltYXRjaCc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBBcHBDb25maWdTZXJ2aWNlIH0gZnJvbSAnLi4vYXBwLWNvbmZpZy9hcHAtY29uZmlnLnNlcnZpY2UnO1xuaW1wb3J0IHtcbiAgICBGaWxlVXBsb2FkQ29tcGxldGVFdmVudCxcbiAgICBGaWxlVXBsb2FkRGVsZXRlRXZlbnQsXG4gICAgRmlsZVVwbG9hZEVycm9yRXZlbnQsXG4gICAgRmlsZVVwbG9hZEV2ZW50XG59IGZyb20gJy4uL2V2ZW50cy9maWxlLmV2ZW50JztcbmltcG9ydCB7IEZpbGVNb2RlbCwgRmlsZVVwbG9hZFByb2dyZXNzLCBGaWxlVXBsb2FkU3RhdHVzIH0gZnJvbSAnLi4vbW9kZWxzL2ZpbGUubW9kZWwnO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlIH0gZnJvbSAnLi9hbGZyZXNjby1hcGkuc2VydmljZSc7XG5pbXBvcnQgeyBEaXNjb3ZlcnlBcGlTZXJ2aWNlIH0gZnJvbSAnLi9kaXNjb3ZlcnktYXBpLnNlcnZpY2UnO1xuaW1wb3J0IHsgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTm9kZXNBcGksIFVwbG9hZEFwaSwgVmVyc2lvbnNBcGkgfSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcblxuY29uc3QgTUlOX0NBTkNFTExBQkxFX0ZJTEVfU0laRSA9IDEwMDAwMDA7XG5jb25zdCBNQVhfQ0FOQ0VMTEFCTEVfRklMRV9QRVJDRU5UQUdFID0gNTA7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgVXBsb2FkU2VydmljZSB7XG4gICAgcHJpdmF0ZSBjYWNoZTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9O1xuICAgIHByaXZhdGUgdG90YWxDb21wbGV0ZTogbnVtYmVyID0gMDtcbiAgICBwcml2YXRlIHRvdGFsQWJvcnRlZDogbnVtYmVyID0gMDtcbiAgICBwcml2YXRlIHRvdGFsRXJyb3I6IG51bWJlciA9IDA7XG4gICAgcHJpdmF0ZSBleGNsdWRlZEZpbGVMaXN0OiBzdHJpbmdbXSA9IFtdO1xuICAgIHByaXZhdGUgZXhjbHVkZWRGb2xkZXJzTGlzdDogc3RyaW5nW10gPSBbXTtcbiAgICBwcml2YXRlIG1hdGNoaW5nT3B0aW9uczogYW55ID0gbnVsbDtcbiAgICBwcml2YXRlIGZvbGRlck1hdGNoaW5nT3B0aW9uczogYW55ID0gbnVsbDtcbiAgICBwcml2YXRlIGFib3J0ZWRGaWxlOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBpc1RodW1ibmFpbEdlbmVyYXRpb25FbmFibGVkOiBib29sZWFuO1xuXG4gICAgYWN0aXZlVGFzazogUHJvbWlzZTxhbnk+ID0gbnVsbDtcbiAgICBxdWV1ZTogRmlsZU1vZGVsW10gPSBbXTtcblxuICAgIHF1ZXVlQ2hhbmdlZDogU3ViamVjdDxGaWxlTW9kZWxbXT4gPSBuZXcgU3ViamVjdDxGaWxlTW9kZWxbXT4oKTtcbiAgICBmaWxlVXBsb2FkOiBTdWJqZWN0PEZpbGVVcGxvYWRFdmVudD4gPSBuZXcgU3ViamVjdDxGaWxlVXBsb2FkRXZlbnQ+KCk7XG4gICAgZmlsZVVwbG9hZFN0YXJ0aW5nOiBTdWJqZWN0PEZpbGVVcGxvYWRFdmVudD4gPSBuZXcgU3ViamVjdDxGaWxlVXBsb2FkRXZlbnQ+KCk7XG4gICAgZmlsZVVwbG9hZENhbmNlbGxlZDogU3ViamVjdDxGaWxlVXBsb2FkRXZlbnQ+ID0gbmV3IFN1YmplY3Q8RmlsZVVwbG9hZEV2ZW50PigpO1xuICAgIGZpbGVVcGxvYWRQcm9ncmVzczogU3ViamVjdDxGaWxlVXBsb2FkRXZlbnQ+ID0gbmV3IFN1YmplY3Q8RmlsZVVwbG9hZEV2ZW50PigpO1xuICAgIGZpbGVVcGxvYWRBYm9ydGVkOiBTdWJqZWN0PEZpbGVVcGxvYWRFdmVudD4gPSBuZXcgU3ViamVjdDxGaWxlVXBsb2FkRXZlbnQ+KCk7XG4gICAgZmlsZVVwbG9hZEVycm9yOiBTdWJqZWN0PEZpbGVVcGxvYWRFcnJvckV2ZW50PiA9IG5ldyBTdWJqZWN0PEZpbGVVcGxvYWRFcnJvckV2ZW50PigpO1xuICAgIGZpbGVVcGxvYWRDb21wbGV0ZTogU3ViamVjdDxGaWxlVXBsb2FkQ29tcGxldGVFdmVudD4gPSBuZXcgU3ViamVjdDxGaWxlVXBsb2FkQ29tcGxldGVFdmVudD4oKTtcbiAgICBmaWxlVXBsb2FkRGVsZXRlZDogU3ViamVjdDxGaWxlVXBsb2FkRGVsZXRlRXZlbnQ+ID0gbmV3IFN1YmplY3Q8RmlsZVVwbG9hZERlbGV0ZUV2ZW50PigpO1xuICAgIGZpbGVEZWxldGVkOiBTdWJqZWN0PHN0cmluZz4gPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XG5cbiAgICBfdXBsb2FkQXBpOiBVcGxvYWRBcGk7XG4gICAgZ2V0IHVwbG9hZEFwaSgpOiBVcGxvYWRBcGkge1xuICAgICAgICB0aGlzLl91cGxvYWRBcGkgPSB0aGlzLl91cGxvYWRBcGkgPz8gbmV3IFVwbG9hZEFwaSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl91cGxvYWRBcGk7XG4gICAgfVxuXG4gICAgX25vZGVzQXBpOiBOb2Rlc0FwaTtcbiAgICBnZXQgbm9kZXNBcGkoKTogTm9kZXNBcGkge1xuICAgICAgICB0aGlzLl9ub2Rlc0FwaSA9IHRoaXMuX25vZGVzQXBpID8/IG5ldyBOb2Rlc0FwaSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl9ub2Rlc0FwaTtcbiAgICB9XG5cbiAgICBfdmVyc2lvbnNBcGk6IFZlcnNpb25zQXBpO1xuICAgIGdldCB2ZXJzaW9uc0FwaSgpOiBWZXJzaW9uc0FwaSB7XG4gICAgICAgIHRoaXMuX3ZlcnNpb25zQXBpID0gdGhpcy5fdmVyc2lvbnNBcGkgPz8gbmV3IFZlcnNpb25zQXBpKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ZlcnNpb25zQXBpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcm90ZWN0ZWQgYXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGFwcENvbmZpZ1NlcnZpY2U6IEFwcENvbmZpZ1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZGlzY292ZXJ5QXBpU2VydmljZTogRGlzY292ZXJ5QXBpU2VydmljZSkge1xuXG4gICAgICAgIHRoaXMuZGlzY292ZXJ5QXBpU2VydmljZS5lY21Qcm9kdWN0SW5mbyQucGlwZShmaWx0ZXIoaW5mbyA9PiAhIWluZm8pKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgoeyBzdGF0dXMgfSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuaXNUaHVtYm5haWxHZW5lcmF0aW9uRW5hYmxlZCA9IHN0YXR1cy5pc1RodW1ibmFpbEdlbmVyYXRpb25FbmFibGVkO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIHdoZXRoZXIgdGhlIHNlcnZpY2Ugc3RpbGwgaGFzIGZpbGVzIHVwbG9hZGluZyBvciBhd2FpdGluZyB1cGxvYWQuXG4gICAgICogQHJldHVybnMgVHJ1ZSBpZiBmaWxlcyBpbiB0aGUgcXVldWUgYXJlIHN0aWxsIHVwbG9hZGluZywgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgaXNVcGxvYWRpbmcoKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGZpbmlzaGVkRmlsZVN0YXRlcyA9IFtGaWxlVXBsb2FkU3RhdHVzLkNvbXBsZXRlLCBGaWxlVXBsb2FkU3RhdHVzLkNhbmNlbGxlZCwgRmlsZVVwbG9hZFN0YXR1cy5BYm9ydGVkLCBGaWxlVXBsb2FkU3RhdHVzLkVycm9yLCBGaWxlVXBsb2FkU3RhdHVzLkRlbGV0ZWRdO1xuICAgICAgICByZXR1cm4gdGhpcy5xdWV1ZS5yZWR1Y2UoKHN0aWxsVXBsb2FkaW5nOiBib29sZWFuLCBjdXJyZW50RmlsZTogRmlsZU1vZGVsKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gc3RpbGxVcGxvYWRpbmcgfHwgZmluaXNoZWRGaWxlU3RhdGVzLmluZGV4T2YoY3VycmVudEZpbGUuc3RhdHVzKSA9PT0gLTE7XG4gICAgICAgIH0sIGZhbHNlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBmaWxlIFF1ZXVlXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgZmlsZXMgdGhhdCBmb3JtIHRoZSBxdWV1ZVxuICAgICAqL1xuICAgIGdldFF1ZXVlKCk6IEZpbGVNb2RlbFtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucXVldWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBmaWxlcyB0byB0aGUgdXBsb2FkaW5nIHF1ZXVlIHRvIGJlIHVwbG9hZGVkXG4gICAgICogQHBhcmFtIGZpbGVzIE9uZSBvciBtb3JlIHNlcGFyYXRlIHBhcmFtZXRlcnMgb3IgYW4gYXJyYXkgb2YgZmlsZXMgdG8gcXVldWVcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBmaWxlcyB0aGF0IHdlcmUgbm90IGJsb2NrZWQgZnJvbSB1cGxvYWQgYnkgdGhlIGlnbm9yZSBsaXN0XG4gICAgICovXG4gICAgYWRkVG9RdWV1ZSguLi5maWxlczogRmlsZU1vZGVsW10pOiBGaWxlTW9kZWxbXSB7XG4gICAgICAgIGNvbnN0IGFsbG93ZWRGaWxlcyA9IGZpbGVzLmZpbHRlcigoY3VycmVudEZpbGUpID0+XG4gICAgICAgICAgICB0aGlzLmZpbHRlckVsZW1lbnQoY3VycmVudEZpbGUpXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMucXVldWUgPSB0aGlzLnF1ZXVlLmNvbmNhdChhbGxvd2VkRmlsZXMpO1xuICAgICAgICB0aGlzLnF1ZXVlQ2hhbmdlZC5uZXh0KHRoaXMucXVldWUpO1xuICAgICAgICByZXR1cm4gYWxsb3dlZEZpbGVzO1xuICAgIH1cblxuICAgIHByaXZhdGUgZmlsdGVyRWxlbWVudChmaWxlOiBGaWxlTW9kZWwpIHtcbiAgICAgICAgdGhpcy5leGNsdWRlZEZpbGVMaXN0ID0gPHN0cmluZ1tdPiB0aGlzLmFwcENvbmZpZ1NlcnZpY2UuZ2V0KCdmaWxlcy5leGNsdWRlZCcpO1xuICAgICAgICB0aGlzLmV4Y2x1ZGVkRm9sZGVyc0xpc3QgPSA8c3RyaW5nW10+IHRoaXMuYXBwQ29uZmlnU2VydmljZS5nZXQoJ2ZvbGRlcnMuZXhjbHVkZWQnKTtcbiAgICAgICAgbGV0IGlzQWxsb3dlZCA9IHRydWU7XG5cbiAgICAgICAgaWYgKHRoaXMuZXhjbHVkZWRGaWxlTGlzdCkge1xuICAgICAgICAgICAgdGhpcy5tYXRjaGluZ09wdGlvbnMgPSB0aGlzLmFwcENvbmZpZ1NlcnZpY2UuZ2V0KCdmaWxlcy5tYXRjaC1vcHRpb25zJyk7XG4gICAgICAgICAgICBpc0FsbG93ZWQgPSB0aGlzLmlzRmlsZU5hbWVBbGxvd2VkKGZpbGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGlzQWxsb3dlZCAmJiB0aGlzLmV4Y2x1ZGVkRm9sZGVyc0xpc3QpIHtcbiAgICAgICAgICAgIHRoaXMuZm9sZGVyTWF0Y2hpbmdPcHRpb25zID0gdGhpcy5hcHBDb25maWdTZXJ2aWNlLmdldCgnZm9sZGVycy5tYXRjaC1vcHRpb25zJyk7XG4gICAgICAgICAgICBpc0FsbG93ZWQgPSB0aGlzLmlzUGFyZW50Rm9sZGVyQWxsb3dlZChmaWxlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaXNBbGxvd2VkO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNQYXJlbnRGb2xkZXJBbGxvd2VkKGZpbGU6IEZpbGVNb2RlbCk6IGJvb2xlYW4ge1xuICAgICAgICBsZXQgaXNBbGxvd2VkOiBib29sZWFuID0gdHJ1ZTtcbiAgICAgICAgY29uc3QgY3VycmVudEZpbGU6IGFueSA9IGZpbGUuZmlsZTtcbiAgICAgICAgY29uc3QgZmlsZVJlbGF0aXZlUGF0aCA9IGN1cnJlbnRGaWxlLndlYmtpdFJlbGF0aXZlUGF0aCA/IGN1cnJlbnRGaWxlLndlYmtpdFJlbGF0aXZlUGF0aCA6IGZpbGUub3B0aW9ucy5wYXRoO1xuICAgICAgICBpZiAoY3VycmVudEZpbGUgJiYgZmlsZVJlbGF0aXZlUGF0aCkge1xuICAgICAgICAgICAgaXNBbGxvd2VkID1cbiAgICAgICAgICAgICAgICB0aGlzLmV4Y2x1ZGVkRm9sZGVyc0xpc3QuZmlsdGVyKChmb2xkZXJUb0V4Y2x1ZGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpbGVSZWxhdGl2ZVBhdGhcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zcGxpdCgnLycpXG4gICAgICAgICAgICAgICAgICAgICAgICAuc29tZSgocGF0aEVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtaW5pbWF0Y2ggPSBuZXcgTWluaW1hdGNoKGZvbGRlclRvRXhjbHVkZSwgdGhpcy5mb2xkZXJNYXRjaGluZ09wdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtaW5pbWF0Y2gubWF0Y2gocGF0aEVsZW1lbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSkubGVuZ3RoID09PSAwO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpc0FsbG93ZWQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc0ZpbGVOYW1lQWxsb3dlZChmaWxlOiBGaWxlTW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMuZXhjbHVkZWRGaWxlTGlzdC5maWx0ZXIoKHBhdHRlcm4pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBtaW5pbWF0Y2ggPSBuZXcgTWluaW1hdGNoKHBhdHRlcm4sIHRoaXMubWF0Y2hpbmdPcHRpb25zKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gbWluaW1hdGNoLm1hdGNoKGZpbGUubmFtZSk7XG4gICAgICAgICAgICB9KS5sZW5ndGggPT09IDBcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kcyBhbGwgdGhlIGZpbGVzIGluIHRoZSBxdWV1ZSB0aGF0IGFyZSBub3QgeWV0IHVwbG9hZGVkIGFuZCB1cGxvYWRzIHRoZW0gaW50byB0aGUgZGlyZWN0b3J5IGZvbGRlci5cbiAgICAgKiBAcGFyYW0gc3VjY2Vzc0VtaXR0ZXIgRW1pdHRlciB0byBpbnZva2Ugb24gZmlsZSBzdWNjZXNzIHN0YXR1cyBjaGFuZ2VcbiAgICAgKiBAcGFyYW0gZXJyb3JFbWl0dGVyIEVtaXR0ZXIgdG8gaW52b2tlIG9uIGZpbGUgZXJyb3Igc3RhdHVzIGNoYW5nZVxuICAgICAqL1xuICAgIHVwbG9hZEZpbGVzSW5UaGVRdWV1ZShzdWNjZXNzRW1pdHRlcj86IEV2ZW50RW1pdHRlcjxhbnk+LCBlcnJvckVtaXR0ZXI/OiBFdmVudEVtaXR0ZXI8YW55Pik6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMuYWN0aXZlVGFzaykge1xuICAgICAgICAgICAgY29uc3QgZmlsZSA9IHRoaXMucXVldWUuZmluZChcbiAgICAgICAgICAgICAgICAoY3VycmVudEZpbGUpID0+IGN1cnJlbnRGaWxlLnN0YXR1cyA9PT0gRmlsZVVwbG9hZFN0YXR1cy5QZW5kaW5nXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgaWYgKGZpbGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uVXBsb2FkU3RhcnRpbmcoZmlsZSk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBwcm9taXNlID0gdGhpcy5iZWdpblVwbG9hZChmaWxlLCBzdWNjZXNzRW1pdHRlciwgZXJyb3JFbWl0dGVyKTtcbiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZVRhc2sgPSBwcm9taXNlO1xuICAgICAgICAgICAgICAgIHRoaXMuY2FjaGVbZmlsZS5uYW1lXSA9IHByb21pc2U7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBuZXh0ID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZVRhc2sgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMudXBsb2FkRmlsZXNJblRoZVF1ZXVlKHN1Y2Nlc3NFbWl0dGVyLCBlcnJvckVtaXR0ZXIpLCAxMDApO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBwcm9taXNlLm5leHQgPSBuZXh0O1xuXG4gICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiBuZXh0KCksXG4gICAgICAgICAgICAgICAgICAgICgpID0+IG5leHQoKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYW5jZWxzIHVwbG9hZGluZyBvZiBmaWxlcy5cbiAgICAgKiBJZiB0aGUgZmlsZSBpcyBzbWFsbGVyIHRoYW4gMSBNQiB0aGUgZmlsZSB3aWxsIGJlIHVwbG9hZGVkIGFuZCB0aGVuIHRoZSBub2RlIGRlbGV0ZWRcbiAgICAgKiB0byBwcmV2ZW50IGhhdmluZyBmaWxlcyB0aGF0IHdlcmUgYWJvcnRlZCBidXQgc3RpbGwgdXBsb2FkZWQuXG4gICAgICogQHBhcmFtIGZpbGVzIE9uZSBvciBtb3JlIHNlcGFyYXRlIHBhcmFtZXRlcnMgb3IgYW4gYXJyYXkgb2YgZmlsZXMgc3BlY2lmeWluZyB1cGxvYWRzIHRvIGNhbmNlbFxuICAgICAqL1xuICAgIGNhbmNlbFVwbG9hZCguLi5maWxlczogRmlsZU1vZGVsW10pIHtcbiAgICAgICAgZmlsZXMuZm9yRWFjaCgoZmlsZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcHJvbWlzZSA9IHRoaXMuY2FjaGVbZmlsZS5uYW1lXTtcbiAgICAgICAgICAgIGlmIChwcm9taXNlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNTYXZlVG9BYm9ydEZpbGUoZmlsZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS5hYm9ydCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmFib3J0ZWRGaWxlID0gZmlsZS5uYW1lO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhY2hlW2ZpbGUubmFtZV07XG4gICAgICAgICAgICAgICAgcHJvbWlzZS5uZXh0KCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBlcmZvcm1BY3Rpb24gPSB0aGlzLmdldEFjdGlvbihmaWxlKTtcbiAgICAgICAgICAgICAgICBwZXJmb3JtQWN0aW9uKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKiBDbGVhcnMgdGhlIHVwbG9hZCBxdWV1ZSAqL1xuICAgIGNsZWFyUXVldWUoKSB7XG4gICAgICAgIHRoaXMucXVldWUgPSBbXTtcbiAgICAgICAgdGhpcy50b3RhbENvbXBsZXRlID0gMDtcbiAgICAgICAgdGhpcy50b3RhbEFib3J0ZWQgPSAwO1xuICAgICAgICB0aGlzLnRvdGFsRXJyb3IgPSAwO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYW4gdXBsb2FkIHByb21pc2UgZm9yIGEgZmlsZS5cbiAgICAgKiBAcGFyYW0gZmlsZSBUaGUgdGFyZ2V0IGZpbGVcbiAgICAgKiBAcmV0dXJucyBQcm9taXNlIHRoYXQgaXMgcmVzb2x2ZWQgaWYgdGhlIHVwbG9hZCBpcyBzdWNjZXNzZnVsIG9yIGVycm9yIG90aGVyd2lzZVxuICAgICAqL1xuICAgIGdldFVwbG9hZFByb21pc2UoZmlsZTogRmlsZU1vZGVsKTogYW55IHtcbiAgICAgICAgY29uc3Qgb3B0czogYW55ID0ge1xuICAgICAgICAgICAgaW5jbHVkZTogWydhbGxvd2FibGVPcGVyYXRpb25zJ11cbiAgICAgICAgfTtcblxuICAgICAgICBpZiAodGhpcy5pc1RodW1ibmFpbEdlbmVyYXRpb25FbmFibGVkKSB7XG4gICAgICAgICAgICBvcHRzLnJlbmRpdGlvbnMgPSAnZG9jbGliJztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChmaWxlLm9wdGlvbnMgJiYgZmlsZS5vcHRpb25zLnZlcnNpb25pbmdFbmFibGVkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIG9wdHMudmVyc2lvbmluZ0VuYWJsZWQgPSBmaWxlLm9wdGlvbnMudmVyc2lvbmluZ0VuYWJsZWQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZmlsZS5vcHRpb25zLm5ld1ZlcnNpb24gPT09IHRydWUpIHtcbiAgICAgICAgICAgIG9wdHMub3ZlcndyaXRlID0gdHJ1ZTtcbiAgICAgICAgICAgIG9wdHMubWFqb3JWZXJzaW9uID0gZmlsZS5vcHRpb25zLm1ham9yVmVyc2lvbjtcbiAgICAgICAgICAgIG9wdHMuY29tbWVudCA9IGZpbGUub3B0aW9ucy5jb21tZW50O1xuICAgICAgICAgICAgb3B0cy5uYW1lID0gZmlsZS5uYW1lO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb3B0cy5hdXRvUmVuYW1lID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChmaWxlLm9wdGlvbnMubm9kZVR5cGUpIHtcbiAgICAgICAgICAgIG9wdHMubm9kZVR5cGUgPSBmaWxlLm9wdGlvbnMubm9kZVR5cGU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZmlsZS5pZCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubm9kZXNBcGkudXBkYXRlTm9kZUNvbnRlbnQoZmlsZS5pZCwgPGFueT4gZmlsZS5maWxlLCBvcHRzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IG5vZGVCb2R5ID0geyAuLi4gZmlsZS5vcHRpb25zIH07XG4gICAgICAgICAgICBkZWxldGUgbm9kZUJvZHlbJ3ZlcnNpb25pbmdFbmFibGVkJ107XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLnVwbG9hZEFwaS51cGxvYWRGaWxlKFxuICAgICAgICAgICAgICAgIGZpbGUuZmlsZSxcbiAgICAgICAgICAgICAgICBmaWxlLm9wdGlvbnMucGF0aCxcbiAgICAgICAgICAgICAgICBmaWxlLm9wdGlvbnMucGFyZW50SWQsXG4gICAgICAgICAgICAgICAgbm9kZUJvZHksXG4gICAgICAgICAgICAgICAgb3B0c1xuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYmVnaW5VcGxvYWQoZmlsZTogRmlsZU1vZGVsLCBzdWNjZXNzRW1pdHRlcj86IEV2ZW50RW1pdHRlcjxhbnk+LCBlcnJvckVtaXR0ZXI/OiBFdmVudEVtaXR0ZXI8YW55Pik6IGFueSB7XG4gICAgICAgIGNvbnN0IHByb21pc2UgPSB0aGlzLmdldFVwbG9hZFByb21pc2UoZmlsZSk7XG4gICAgICAgIHByb21pc2VcbiAgICAgICAgICAgIC5vbigncHJvZ3Jlc3MnLCAocHJvZ3Jlc3M6IEZpbGVVcGxvYWRQcm9ncmVzcykgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMub25VcGxvYWRQcm9ncmVzcyhmaWxlLCBwcm9ncmVzcyk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLm9uKCdhYm9ydCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uVXBsb2FkQWJvcnRlZChmaWxlKTtcbiAgICAgICAgICAgICAgICBpZiAoc3VjY2Vzc0VtaXR0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc0VtaXR0ZXIuZW1pdCh7IHZhbHVlOiAnRmlsZSBhYm9ydGVkJyB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uVXBsb2FkRXJyb3IoZmlsZSwgZXJyKTtcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3JFbWl0dGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIGVycm9yRW1pdHRlci5lbWl0KHsgdmFsdWU6ICdFcnJvciBmaWxlIHVwbG9hZGVkJyB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLm9uKCdzdWNjZXNzJywgKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5hYm9ydGVkRmlsZSA9PT0gZmlsZS5uYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25VcGxvYWRBYm9ydGVkKGZpbGUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZS5pZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlbGV0ZUFib3J0ZWROb2RlKGRhdGEuZW50cnkuaWQpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWxldGVBYm9ydGVkTm9kZVZlcnNpb24oZGF0YS5lbnRyeS5pZCwgZGF0YS5lbnRyeS5wcm9wZXJ0aWVzWydjbTp2ZXJzaW9uTGFiZWwnXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3NFbWl0dGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzRW1pdHRlci5lbWl0KHsgdmFsdWU6ICdGaWxlIGRlbGV0ZWQnIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vblVwbG9hZENvbXBsZXRlKGZpbGUsIGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3VjY2Vzc0VtaXR0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3NFbWl0dGVyLmVtaXQoeyB2YWx1ZTogZGF0YSB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goKCkgPT4ge1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHByb21pc2U7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblVwbG9hZFN0YXJ0aW5nKGZpbGU6IEZpbGVNb2RlbCk6IHZvaWQge1xuICAgICAgICBpZiAoZmlsZSkge1xuICAgICAgICAgICAgZmlsZS5zdGF0dXMgPSBGaWxlVXBsb2FkU3RhdHVzLlN0YXJ0aW5nO1xuICAgICAgICAgICAgY29uc3QgZXZlbnQgPSBuZXcgRmlsZVVwbG9hZEV2ZW50KGZpbGUsIEZpbGVVcGxvYWRTdGF0dXMuU3RhcnRpbmcpO1xuICAgICAgICAgICAgdGhpcy5maWxlVXBsb2FkLm5leHQoZXZlbnQpO1xuICAgICAgICAgICAgdGhpcy5maWxlVXBsb2FkU3RhcnRpbmcubmV4dChldmVudCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uVXBsb2FkUHJvZ3Jlc3MoXG4gICAgICAgIGZpbGU6IEZpbGVNb2RlbCxcbiAgICAgICAgcHJvZ3Jlc3M6IEZpbGVVcGxvYWRQcm9ncmVzc1xuICAgICk6IHZvaWQge1xuICAgICAgICBpZiAoZmlsZSkge1xuICAgICAgICAgICAgZmlsZS5wcm9ncmVzcyA9IHByb2dyZXNzO1xuICAgICAgICAgICAgZmlsZS5zdGF0dXMgPSBGaWxlVXBsb2FkU3RhdHVzLlByb2dyZXNzO1xuXG4gICAgICAgICAgICBjb25zdCBldmVudCA9IG5ldyBGaWxlVXBsb2FkRXZlbnQoZmlsZSwgRmlsZVVwbG9hZFN0YXR1cy5Qcm9ncmVzcyk7XG4gICAgICAgICAgICB0aGlzLmZpbGVVcGxvYWQubmV4dChldmVudCk7XG4gICAgICAgICAgICB0aGlzLmZpbGVVcGxvYWRQcm9ncmVzcy5uZXh0KGV2ZW50KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgb25VcGxvYWRFcnJvcihmaWxlOiBGaWxlTW9kZWwsIGVycm9yOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgaWYgKGZpbGUpIHtcbiAgICAgICAgICAgIGZpbGUuZXJyb3JDb2RlID0gKGVycm9yIHx8IHt9KS5zdGF0dXM7XG4gICAgICAgICAgICBmaWxlLnN0YXR1cyA9IEZpbGVVcGxvYWRTdGF0dXMuRXJyb3I7XG4gICAgICAgICAgICB0aGlzLnRvdGFsRXJyb3IrKztcblxuICAgICAgICAgICAgY29uc3QgcHJvbWlzZSA9IHRoaXMuY2FjaGVbZmlsZS5uYW1lXTtcbiAgICAgICAgICAgIGlmIChwcm9taXNlKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2FjaGVbZmlsZS5uYW1lXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgZXZlbnQgPSBuZXcgRmlsZVVwbG9hZEVycm9yRXZlbnQoXG4gICAgICAgICAgICAgICAgZmlsZSxcbiAgICAgICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICAgICAgICB0aGlzLnRvdGFsRXJyb3JcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICB0aGlzLmZpbGVVcGxvYWQubmV4dChldmVudCk7XG4gICAgICAgICAgICB0aGlzLmZpbGVVcGxvYWRFcnJvci5uZXh0KGV2ZW50KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgb25VcGxvYWRDb21wbGV0ZShmaWxlOiBGaWxlTW9kZWwsIGRhdGE6IGFueSk6IHZvaWQge1xuICAgICAgICBpZiAoZmlsZSkge1xuICAgICAgICAgICAgZmlsZS5zdGF0dXMgPSBGaWxlVXBsb2FkU3RhdHVzLkNvbXBsZXRlO1xuICAgICAgICAgICAgZmlsZS5kYXRhID0gZGF0YTtcbiAgICAgICAgICAgIHRoaXMudG90YWxDb21wbGV0ZSsrO1xuICAgICAgICAgICAgY29uc3QgcHJvbWlzZSA9IHRoaXMuY2FjaGVbZmlsZS5uYW1lXTtcbiAgICAgICAgICAgIGlmIChwcm9taXNlKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2FjaGVbZmlsZS5uYW1lXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgZXZlbnQgPSBuZXcgRmlsZVVwbG9hZENvbXBsZXRlRXZlbnQoXG4gICAgICAgICAgICAgICAgZmlsZSxcbiAgICAgICAgICAgICAgICB0aGlzLnRvdGFsQ29tcGxldGUsXG4gICAgICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgICAgICB0aGlzLnRvdGFsQWJvcnRlZFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHRoaXMuZmlsZVVwbG9hZC5uZXh0KGV2ZW50KTtcbiAgICAgICAgICAgIHRoaXMuZmlsZVVwbG9hZENvbXBsZXRlLm5leHQoZXZlbnQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblVwbG9hZEFib3J0ZWQoZmlsZTogRmlsZU1vZGVsKTogdm9pZCB7XG4gICAgICAgIGlmIChmaWxlKSB7XG4gICAgICAgICAgICBmaWxlLnN0YXR1cyA9IEZpbGVVcGxvYWRTdGF0dXMuQWJvcnRlZDtcbiAgICAgICAgICAgIHRoaXMudG90YWxBYm9ydGVkKys7XG5cbiAgICAgICAgICAgIGNvbnN0IGV2ZW50ID0gbmV3IEZpbGVVcGxvYWRFdmVudChmaWxlLCBGaWxlVXBsb2FkU3RhdHVzLkFib3J0ZWQpO1xuICAgICAgICAgICAgdGhpcy5maWxlVXBsb2FkLm5leHQoZXZlbnQpO1xuICAgICAgICAgICAgdGhpcy5maWxlVXBsb2FkQWJvcnRlZC5uZXh0KGV2ZW50KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgb25VcGxvYWRDYW5jZWxsZWQoZmlsZTogRmlsZU1vZGVsKTogdm9pZCB7XG4gICAgICAgIGlmIChmaWxlKSB7XG4gICAgICAgICAgICBmaWxlLnN0YXR1cyA9IEZpbGVVcGxvYWRTdGF0dXMuQ2FuY2VsbGVkO1xuXG4gICAgICAgICAgICBjb25zdCBldmVudCA9IG5ldyBGaWxlVXBsb2FkRXZlbnQoZmlsZSwgRmlsZVVwbG9hZFN0YXR1cy5DYW5jZWxsZWQpO1xuICAgICAgICAgICAgdGhpcy5maWxlVXBsb2FkLm5leHQoZXZlbnQpO1xuICAgICAgICAgICAgdGhpcy5maWxlVXBsb2FkQ2FuY2VsbGVkLm5leHQoZXZlbnQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblVwbG9hZERlbGV0ZWQoZmlsZTogRmlsZU1vZGVsKTogdm9pZCB7XG4gICAgICAgIGlmIChmaWxlKSB7XG4gICAgICAgICAgICBmaWxlLnN0YXR1cyA9IEZpbGVVcGxvYWRTdGF0dXMuRGVsZXRlZDtcbiAgICAgICAgICAgIHRoaXMudG90YWxDb21wbGV0ZS0tO1xuXG4gICAgICAgICAgICBjb25zdCBldmVudCA9IG5ldyBGaWxlVXBsb2FkRGVsZXRlRXZlbnQoZmlsZSwgdGhpcy50b3RhbENvbXBsZXRlKTtcbiAgICAgICAgICAgIHRoaXMuZmlsZVVwbG9hZC5uZXh0KGV2ZW50KTtcbiAgICAgICAgICAgIHRoaXMuZmlsZVVwbG9hZERlbGV0ZWQubmV4dChldmVudCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEFjdGlvbihmaWxlOiBGaWxlTW9kZWwpIHtcbiAgICAgICAgY29uc3QgYWN0aW9ucyA9IHtcbiAgICAgICAgICAgIFtGaWxlVXBsb2FkU3RhdHVzLlBlbmRpbmddOiAoKSA9PiB0aGlzLm9uVXBsb2FkQ2FuY2VsbGVkKGZpbGUpLFxuICAgICAgICAgICAgW0ZpbGVVcGxvYWRTdGF0dXMuRGVsZXRlZF06ICgpID0+IHRoaXMub25VcGxvYWREZWxldGVkKGZpbGUpLFxuICAgICAgICAgICAgW0ZpbGVVcGxvYWRTdGF0dXMuRXJyb3JdOiAoKSA9PiB0aGlzLm9uVXBsb2FkRXJyb3IoZmlsZSwgbnVsbClcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gYWN0aW9uc1tmaWxlLnN0YXR1c107XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZWxldGVBYm9ydGVkTm9kZShub2RlSWQ6IHN0cmluZykge1xuICAgICAgICB0aGlzLm5vZGVzQXBpLmRlbGV0ZU5vZGUobm9kZUlkLCB7IHBlcm1hbmVudDogdHJ1ZSB9KVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gKHRoaXMuYWJvcnRlZEZpbGUgPSB1bmRlZmluZWQpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRlbGV0ZUFib3J0ZWROb2RlVmVyc2lvbihub2RlSWQ6IHN0cmluZywgdmVyc2lvbklkOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy52ZXJzaW9uc0FwaS5kZWxldGVWZXJzaW9uKG5vZGVJZCwgdmVyc2lvbklkKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gKHRoaXMuYWJvcnRlZEZpbGUgPSB1bmRlZmluZWQpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzU2F2ZVRvQWJvcnRGaWxlKGZpbGU6IEZpbGVNb2RlbCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgZmlsZS5zaXplID4gTUlOX0NBTkNFTExBQkxFX0ZJTEVfU0laRSAmJlxuICAgICAgICAgICAgZmlsZS5wcm9ncmVzcy5wZXJjZW50IDwgTUFYX0NBTkNFTExBQkxFX0ZJTEVfUEVSQ0VOVEFHRVxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==