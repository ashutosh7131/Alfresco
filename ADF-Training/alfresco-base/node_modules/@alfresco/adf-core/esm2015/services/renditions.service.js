import { Injectable } from '@angular/core';
import { RenditionsApi, ContentApi } from '@alfresco/js-api';
import { Observable, from, interval, empty } from 'rxjs';
import { AlfrescoApiService } from './alfresco-api.service';
import { concatMap, switchMap, takeWhile, map } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "./alfresco-api.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './alfresco-api.service';
export class RenditionsService {
    constructor(apiService) {
        this.apiService = apiService;
    }
    get renditionsApi() {
        var _a;
        this._renditionsApi = (_a = this._renditionsApi) !== null && _a !== void 0 ? _a : new RenditionsApi(this.apiService.getInstance());
        return this._renditionsApi;
    }
    get contentApi() {
        var _a;
        this._contentApi = (_a = this._contentApi) !== null && _a !== void 0 ? _a : new ContentApi(this.apiService.getInstance());
        return this._contentApi;
    }
    getAvailableRenditionForNode(nodeId) {
        return from(this.renditionsApi.listRenditions(nodeId)).pipe(map((availableRenditions) => {
            const renditionsAvailable = availableRenditions.list.entries.filter((rendition) => (rendition.entry.id === 'pdf' || rendition.entry.id === 'imgpreview'));
            const existingRendition = renditionsAvailable.find((rend) => rend.entry.status === 'CREATED');
            return existingRendition ? existingRendition : renditionsAvailable[0];
        }));
    }
    generateRenditionForNode(nodeId) {
        return this.getAvailableRenditionForNode(nodeId).pipe(map((rendition) => {
            if (rendition.entry.status !== 'CREATED') {
                return from(this.renditionsApi.createRendition(nodeId, { id: rendition.entry.id }));
            }
            else {
                return empty();
            }
        }));
    }
    isRenditionAvailable(nodeId, encoding) {
        return new Observable((observer) => {
            this.getRendition(nodeId, encoding).subscribe((res) => {
                let isAvailable = true;
                if (res.entry.status.toString() === 'NOT_CREATED') {
                    isAvailable = false;
                }
                observer.next(isAvailable);
                observer.complete();
            }, () => {
                observer.next(false);
                observer.complete();
            });
        });
    }
    isConversionPossible(nodeId, encoding) {
        return new Observable((observer) => {
            this.getRendition(nodeId, encoding).subscribe(() => {
                observer.next(true);
                observer.complete();
            }, () => {
                observer.next(false);
                observer.complete();
            });
        });
    }
    getRenditionUrl(nodeId, encoding) {
        return this.contentApi.getRenditionUrl(nodeId, encoding);
    }
    getRendition(nodeId, encoding) {
        return from(this.renditionsApi.getRendition(nodeId, encoding));
    }
    getRenditionsListByNodeId(nodeId) {
        return from(this.renditionsApi.listRenditions(nodeId));
    }
    createRendition(nodeId, encoding) {
        return from(this.renditionsApi.createRendition(nodeId, { id: encoding }));
    }
    convert(nodeId, encoding, pollingInterval = 1000, retries = 5) {
        return this.createRendition(nodeId, encoding)
            .pipe(concatMap(() => this.pollRendition(nodeId, encoding, pollingInterval, retries)));
    }
    pollRendition(nodeId, encoding, intervalSize = 1000, retries = 5) {
        let attempts = 0;
        return interval(intervalSize)
            .pipe(switchMap(() => this.getRendition(nodeId, encoding)), takeWhile((renditionEntry) => {
            attempts += 1;
            if (attempts > retries) {
                return false;
            }
            return (renditionEntry.entry.status.toString() !== 'CREATED');
        }));
    }
}
RenditionsService.ɵfac = function RenditionsService_Factory(t) { return new (t || RenditionsService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService)); };
RenditionsService.ɵprov = i0.ɵɵdefineInjectable({ factory: function RenditionsService_Factory() { return new RenditionsService(i0.ɵɵinject(i1.AlfrescoApiService)); }, token: RenditionsService, providedIn: "root" });
RenditionsService.ctorParameters = () => [
    { type: AlfrescoApiService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(RenditionsService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGl0aW9ucy5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvY29yZS9zZXJ2aWNlcy9yZW5kaXRpb25zLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFtQyxhQUFhLEVBQUUsVUFBVSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDOUYsT0FBTyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN6RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEU7QUFFc0I7OztBQUV0QixNQUFNLE9BQU8saUJBQWlCO0FBQzlCLElBYUksWUFBb0IsVUFBOEI7QUFDdEQsUUFEd0IsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7QUFBQyxJQUNuRCxDQUFDO0FBQ0wsSUFiSSxJQUFJLGFBQWE7QUFBSztBQUN6QixRQUFPLElBQUksQ0FBQyxjQUFjLFNBQUcsSUFBSSxDQUFDLGNBQWMsbUNBQUksSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0FBQ3RHLFFBQVEsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDO0FBQ25DLElBQUksQ0FBQztBQUNMLElBRUksSUFBSSxVQUFVO0FBQUs7QUFDbkIsUUFBSSxJQUFJLENBQUMsV0FBVyxTQUFHLElBQUksQ0FBQyxXQUFXLG1DQUFJLElBQUksVUFBVSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztBQUM3RixRQUFRLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztBQUNoQyxJQUFJLENBQUM7QUFDTCxJQVNJLDRCQUE0QixDQUFDLE1BQWM7QUFBSSxRQUMzQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FDdkQsR0FBRyxDQUFDLENBQUMsbUJBQW9DLEVBQUUsRUFBRTtBQUN6RCxZQUFnQixNQUFNLG1CQUFtQixHQUFxQixtQkFBbUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FDakYsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFLEtBQUssS0FBSyxJQUFJLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRSxLQUFLLFlBQVksQ0FBQyxDQUFDLENBQUM7QUFDMUcsWUFBZ0IsTUFBTSxpQkFBaUIsR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxDQUFDO0FBQzlHLFlBQWdCLE9BQU8saUJBQWlCLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN0RixRQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDaEIsSUFBSSxDQUFDO0FBQ0wsSUFNSSx3QkFBd0IsQ0FBQyxNQUFjO0FBQUksUUFDdkMsT0FBTyxJQUFJLENBQUMsNEJBQTRCLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUNqRCxHQUFHLENBQUMsQ0FBQyxTQUF5QixFQUFFLEVBQUU7QUFDOUMsWUFBZ0IsSUFBSSxTQUFTLENBQUMsS0FBSyxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7QUFDMUQsZ0JBQW9CLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRSxFQUFFLEVBQUUsRUFBRSxTQUFTLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUN4RyxhQUFpQjtBQUFDLGlCQUFLO0FBQ3ZCLGdCQUFvQixPQUFPLEtBQUssRUFBRSxDQUFDO0FBQ25DLGFBQWlCO0FBQ2pCLFFBQVksQ0FBQyxDQUFDLENBQ0wsQ0FBQztBQUNWLElBQUksQ0FBQztBQUNMLElBT0ksb0JBQW9CLENBQUMsTUFBYyxFQUFFLFFBQWdCO0FBQUksUUFDckQsT0FBTyxJQUFJLFVBQVUsQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFO0FBQzNDLFlBQVksSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUMsU0FBUyxDQUN6QyxDQUFDLEdBQUcsRUFBRSxFQUFFO0FBQ3hCLGdCQUFvQixJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUM7QUFDM0MsZ0JBQW9CLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLEtBQUssYUFBYSxFQUFFO0FBQ3ZFLG9CQUF3QixXQUFXLEdBQUcsS0FBSyxDQUFDO0FBQzVDLGlCQUFxQjtBQUNyQixnQkFBb0IsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUMvQyxnQkFBb0IsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQ3hDLFlBQWdCLENBQUMsRUFDRCxHQUFHLEVBQUU7QUFDckIsZ0JBQW9CLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDekMsZ0JBQW9CLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUN4QyxZQUFnQixDQUFDLENBQ0osQ0FBQztBQUNkLFFBQVEsQ0FBQyxDQUFDLENBQUM7QUFDWCxJQUFJLENBQUM7QUFDTCxJQU9JLG9CQUFvQixDQUFDLE1BQWMsRUFBRSxRQUFnQjtBQUFJLFFBQ3JELE9BQU8sSUFBSSxVQUFVLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtBQUMzQyxZQUFZLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FDekMsR0FBRyxFQUFFO0FBQ3JCLGdCQUFvQixRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3hDLGdCQUFvQixRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7QUFDeEMsWUFBZ0IsQ0FBQyxFQUNELEdBQUcsRUFBRTtBQUNyQixnQkFBb0IsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN6QyxnQkFBb0IsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQ3hDLFlBQWdCLENBQUMsQ0FDSixDQUFDO0FBQ2QsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUNYLElBQUksQ0FBQztBQUNMLElBT0ksZUFBZSxDQUFDLE1BQWMsRUFBRSxRQUFnQjtBQUFJLFFBQ2hELE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQ2pFLElBQUksQ0FBQztBQUNMLElBT0ksWUFBWSxDQUFDLE1BQWMsRUFBRSxRQUFnQjtBQUFJLFFBQzdDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO0FBQ3ZFLElBQUksQ0FBQztBQUNMLElBTUkseUJBQXlCLENBQUMsTUFBYztBQUFJLFFBQ3hDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7QUFDL0QsSUFBSSxDQUFDO0FBQ0wsSUFPSSxlQUFlLENBQUMsTUFBYyxFQUFFLFFBQWdCO0FBQUksUUFDaEQsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUNsRixJQUFJLENBQUM7QUFDTCxJQVNJLE9BQU8sQ0FBQyxNQUFjLEVBQUUsUUFBZ0IsRUFBRSxrQkFBMEIsSUFBSSxFQUFFLFVBQWtCLENBQUM7QUFDakcsUUFBUSxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQztBQUNyRCxhQUFhLElBQUksQ0FDRCxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLGVBQWUsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUNsRixDQUFDO0FBQ2QsSUFBSSxDQUFDO0FBQ0wsSUFDWSxhQUFhLENBQUMsTUFBYyxFQUFFLFFBQWdCLEVBQUUsZUFBdUIsSUFBSSxFQUFFLFVBQWtCLENBQUM7QUFDNUcsUUFBUSxJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUM7QUFDekIsUUFBUSxPQUFPLFFBQVEsQ0FBQyxZQUFZLENBQUM7QUFDckMsYUFBYSxJQUFJLENBQ0QsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDLEVBQ3BELFNBQVMsQ0FBQyxDQUFDLGNBQThCLEVBQUUsRUFBRTtBQUM3RCxZQUFvQixRQUFRLElBQUksQ0FBQyxDQUFDO0FBQ2xDLFlBQW9CLElBQUksUUFBUSxHQUFHLE9BQU8sRUFBRTtBQUM1QyxnQkFBd0IsT0FBTyxLQUFLLENBQUM7QUFDckMsYUFBcUI7QUFDckIsWUFBb0IsT0FBTyxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxLQUFLLFNBQVMsQ0FBQyxDQUFDO0FBQ2xGLFFBQWdCLENBQUMsQ0FBQyxDQUNMLENBQUM7QUFDZCxJQUFJLENBQUM7QUFDTDtvSkFBQztBQUNELHVOQXBLSztBQUFDO0VBSEwsVUFBVSxTQUFDLHJCQUtHLFlBUk4sa0JBQWtCO0FBQUc7R0FJMUIsVUFBVSxFQUFFLE1BQU0sY0FDckI7Ozs7O21GQUwrQjtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUmVuZGl0aW9uRW50cnksIFJlbmRpdGlvblBhZ2luZywgUmVuZGl0aW9uc0FwaSwgQ29udGVudEFwaSB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbSwgaW50ZXJ2YWwsIGVtcHR5IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UgfSBmcm9tICcuL2FsZnJlc2NvLWFwaS5zZXJ2aWNlJztcbmltcG9ydCB7IGNvbmNhdE1hcCwgc3dpdGNoTWFwLCB0YWtlV2hpbGUsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBSZW5kaXRpb25zU2VydmljZSB7XG5cbiAgICBfcmVuZGl0aW9uc0FwaTogUmVuZGl0aW9uc0FwaTtcbiAgICBnZXQgcmVuZGl0aW9uc0FwaSgpOiBSZW5kaXRpb25zQXBpIHtcbiAgICAgICAgdGhpcy5fcmVuZGl0aW9uc0FwaSA9IHRoaXMuX3JlbmRpdGlvbnNBcGkgPz8gbmV3IFJlbmRpdGlvbnNBcGkodGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy5fcmVuZGl0aW9uc0FwaTtcbiAgICB9XG5cbiAgICBfY29udGVudEFwaTogQ29udGVudEFwaTtcbiAgICBnZXQgY29udGVudEFwaSgpOiBDb250ZW50QXBpIHtcbiAgICAgICAgdGhpcy5fY29udGVudEFwaSA9IHRoaXMuX2NvbnRlbnRBcGkgPz8gbmV3IENvbnRlbnRBcGkodGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy5fY29udGVudEFwaTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSkge1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIGZpcnN0IGF2YWlsYWJsZSByZW5kaXRpb24gZm91bmQgZm9yIGEgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZUlkIElEIG9mIHRoZSB0YXJnZXQgbm9kZVxuICAgICAqIEByZXR1cm5zIEluZm9ybWF0aW9uIG9iamVjdCBmb3IgdGhlIHJlbmRpdGlvblxuICAgICAqL1xuICAgIGdldEF2YWlsYWJsZVJlbmRpdGlvbkZvck5vZGUobm9kZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFJlbmRpdGlvbkVudHJ5PiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMucmVuZGl0aW9uc0FwaS5saXN0UmVuZGl0aW9ucyhub2RlSWQpKS5waXBlKFxuICAgICAgICAgICAgbWFwKChhdmFpbGFibGVSZW5kaXRpb25zOiBSZW5kaXRpb25QYWdpbmcpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZW5kaXRpb25zQXZhaWxhYmxlOiBSZW5kaXRpb25FbnRyeVtdID0gYXZhaWxhYmxlUmVuZGl0aW9ucy5saXN0LmVudHJpZXMuZmlsdGVyKFxuICAgICAgICAgICAgICAgICAgICAocmVuZGl0aW9uKSA9PiAocmVuZGl0aW9uLmVudHJ5LmlkID09PSAncGRmJyB8fCByZW5kaXRpb24uZW50cnkuaWQgPT09ICdpbWdwcmV2aWV3JykpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nUmVuZGl0aW9uID0gcmVuZGl0aW9uc0F2YWlsYWJsZS5maW5kKChyZW5kKSA9PiByZW5kLmVudHJ5LnN0YXR1cyA9PT0gJ0NSRUFURUQnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3RpbmdSZW5kaXRpb24gPyBleGlzdGluZ1JlbmRpdGlvbiA6IHJlbmRpdGlvbnNBdmFpbGFibGVbMF07XG4gICAgICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2VuZXJhdGVzIGEgcmVuZGl0aW9uIGZvciBhIG5vZGUgdXNpbmcgdGhlIGZpcnN0IGF2YWlsYWJsZSBlbmNvZGluZy5cbiAgICAgKiBAcGFyYW0gbm9kZUlkIElEIG9mIHRoZSB0YXJnZXQgbm9kZVxuICAgICAqIEByZXR1cm5zIE51bGwgcmVzcG9uc2UgdG8gaW5kaWNhdGUgY29tcGxldGlvblxuICAgICAqL1xuICAgIGdlbmVyYXRlUmVuZGl0aW9uRm9yTm9kZShub2RlSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEF2YWlsYWJsZVJlbmRpdGlvbkZvck5vZGUobm9kZUlkKS5waXBlKFxuICAgICAgICAgICAgbWFwKChyZW5kaXRpb246IFJlbmRpdGlvbkVudHJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHJlbmRpdGlvbi5lbnRyeS5zdGF0dXMgIT09ICdDUkVBVEVEJykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnJlbmRpdGlvbnNBcGkuY3JlYXRlUmVuZGl0aW9uKG5vZGVJZCwgeyBpZDogcmVuZGl0aW9uLmVudHJ5LmlkIH0pKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW1wdHkoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBpZiB0aGUgc3BlY2lmaWVkIHJlbmRpdGlvbiBpcyBhdmFpbGFibGUgZm9yIGEgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZUlkIElEIG9mIHRoZSB0YXJnZXQgbm9kZVxuICAgICAqIEBwYXJhbSBlbmNvZGluZyBOYW1lIG9mIHRoZSByZW5kaXRpb24gZW5jb2RpbmdcbiAgICAgKiBAcmV0dXJucyBUcnVlIGlmIHRoZSByZW5kaXRpb24gaXMgYXZhaWxhYmxlLCBmYWxzZSBvdGhlcndpc2VcbiAgICAgKi9cbiAgICBpc1JlbmRpdGlvbkF2YWlsYWJsZShub2RlSWQ6IHN0cmluZywgZW5jb2Rpbmc6IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gbmV3IE9ic2VydmFibGUoKG9ic2VydmVyKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmdldFJlbmRpdGlvbihub2RlSWQsIGVuY29kaW5nKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgaXNBdmFpbGFibGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmVudHJ5LnN0YXR1cy50b1N0cmluZygpID09PSAnTk9UX0NSRUFURUQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpc0F2YWlsYWJsZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoaXNBdmFpbGFibGUpO1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3MgaWYgdGhlIG5vZGUgY2FuIGJlIGNvbnZlcnRlZCB1c2luZyB0aGUgc3BlY2lmaWVkIHJlbmRpdGlvbi5cbiAgICAgKiBAcGFyYW0gbm9kZUlkIElEIG9mIHRoZSB0YXJnZXQgbm9kZVxuICAgICAqIEBwYXJhbSBlbmNvZGluZyBOYW1lIG9mIHRoZSByZW5kaXRpb24gZW5jb2RpbmdcbiAgICAgKiBAcmV0dXJucyBUcnVlIGlmIHRoZSBub2RlIGNhbiBiZSBjb252ZXJ0ZWQsIGZhbHNlIG90aGVyd2lzZVxuICAgICAqL1xuICAgIGlzQ29udmVyc2lvblBvc3NpYmxlKG5vZGVJZDogc3RyaW5nLCBlbmNvZGluZzogc3RyaW5nKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZSgob2JzZXJ2ZXIpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZ2V0UmVuZGl0aW9uKG5vZGVJZCwgZW5jb2RpbmcpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSBVUkwgbGlua2luZyB0byB0aGUgc3BlY2lmaWVkIHJlbmRpdGlvbiBvZiBhIG5vZGUuXG4gICAgICogQHBhcmFtIG5vZGVJZCBJRCBvZiB0aGUgdGFyZ2V0IG5vZGVcbiAgICAgKiBAcGFyYW0gZW5jb2RpbmcgTmFtZSBvZiB0aGUgcmVuZGl0aW9uIGVuY29kaW5nXG4gICAgICogQHJldHVybnMgVVJMIHN0cmluZ1xuICAgICAqL1xuICAgIGdldFJlbmRpdGlvblVybChub2RlSWQ6IHN0cmluZywgZW5jb2Rpbmc6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbnRlbnRBcGkuZ2V0UmVuZGl0aW9uVXJsKG5vZGVJZCwgZW5jb2RpbmcpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgaW5mb3JtYXRpb24gYWJvdXQgYSByZW5kaXRpb24gb2YgYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlSWQgSUQgb2YgdGhlIHRhcmdldCBub2RlXG4gICAgICogQHBhcmFtIGVuY29kaW5nIE5hbWUgb2YgdGhlIHJlbmRpdGlvbiBlbmNvZGluZ1xuICAgICAqIEByZXR1cm5zIEluZm9ybWF0aW9uIG9iamVjdCBhYm91dCB0aGUgcmVuZGl0aW9uXG4gICAgICovXG4gICAgZ2V0UmVuZGl0aW9uKG5vZGVJZDogc3RyaW5nLCBlbmNvZGluZzogc3RyaW5nKTogT2JzZXJ2YWJsZTxSZW5kaXRpb25FbnRyeT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnJlbmRpdGlvbnNBcGkuZ2V0UmVuZGl0aW9uKG5vZGVJZCwgZW5jb2RpbmcpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGEgbGlzdCBvZiBhbGwgcmVuZGl0aW9ucyBmb3IgYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlSWQgSUQgb2YgdGhlIHRhcmdldCBub2RlXG4gICAgICogQHJldHVybnMgUGFnZWQgbGlzdCBvZiByZW5kaXRpb24gZGV0YWlsc1xuICAgICAqL1xuICAgIGdldFJlbmRpdGlvbnNMaXN0QnlOb2RlSWQobm9kZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFJlbmRpdGlvblBhZ2luZz4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnJlbmRpdGlvbnNBcGkubGlzdFJlbmRpdGlvbnMobm9kZUlkKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBhIHJlbmRpdGlvbiBmb3IgYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlSWQgSUQgb2YgdGhlIHRhcmdldCBub2RlXG4gICAgICogQHBhcmFtIGVuY29kaW5nIE5hbWUgb2YgdGhlIHJlbmRpdGlvbiBlbmNvZGluZ1xuICAgICAqIEByZXR1cm5zIE51bGwgcmVzcG9uc2UgdG8gaW5kaWNhdGUgY29tcGxldGlvblxuICAgICAqL1xuICAgIGNyZWF0ZVJlbmRpdGlvbihub2RlSWQ6IHN0cmluZywgZW5jb2Rpbmc6IHN0cmluZyk6IE9ic2VydmFibGU8e30+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5yZW5kaXRpb25zQXBpLmNyZWF0ZVJlbmRpdGlvbihub2RlSWQsIHsgaWQ6IGVuY29kaW5nIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBlYXRlZGx5IGF0dGVtcHRzIHRvIGNyZWF0ZSBhIHJlbmRpdGlvbiwgdGhyb3VnaCB0byBzdWNjZXNzIG9yIGZhaWx1cmUuXG4gICAgICogQHBhcmFtIG5vZGVJZCBJRCBvZiB0aGUgdGFyZ2V0IG5vZGVcbiAgICAgKiBAcGFyYW0gZW5jb2RpbmcgTmFtZSBvZiB0aGUgcmVuZGl0aW9uIGVuY29kaW5nXG4gICAgICogQHBhcmFtIHBvbGxpbmdJbnRlcnZhbCBUaW1lIGludGVydmFsIChpbiBtaWxsaXNlY29uZHMpIGJldHdlZW4gY2hlY2tzIGZvciBjb21wbGV0aW9uXG4gICAgICogQHBhcmFtIHJldHJpZXMgTnVtYmVyIG9mIGF0dGVtcHRzIHRvIG1ha2UgYmVmb3JlIGRlY2xhcmluZyBmYWlsdXJlXG4gICAgICogQHJldHVybnMgVHJ1ZSBpZiB0aGUgcmVuZGl0aW9uIHdhcyBjcmVhdGVkLCBmYWxzZSBvdGhlcndpc2VcbiAgICAgKi9cbiAgICBjb252ZXJ0KG5vZGVJZDogc3RyaW5nLCBlbmNvZGluZzogc3RyaW5nLCBwb2xsaW5nSW50ZXJ2YWw6IG51bWJlciA9IDEwMDAsIHJldHJpZXM6IG51bWJlciA9IDUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlUmVuZGl0aW9uKG5vZGVJZCwgZW5jb2RpbmcpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjb25jYXRNYXAoKCkgPT4gdGhpcy5wb2xsUmVuZGl0aW9uKG5vZGVJZCwgZW5jb2RpbmcsIHBvbGxpbmdJbnRlcnZhbCwgcmV0cmllcykpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgcG9sbFJlbmRpdGlvbihub2RlSWQ6IHN0cmluZywgZW5jb2Rpbmc6IHN0cmluZywgaW50ZXJ2YWxTaXplOiBudW1iZXIgPSAxMDAwLCByZXRyaWVzOiBudW1iZXIgPSA1KSB7XG4gICAgICAgIGxldCBhdHRlbXB0cyA9IDA7XG4gICAgICAgIHJldHVybiBpbnRlcnZhbChpbnRlcnZhbFNpemUpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5nZXRSZW5kaXRpb24obm9kZUlkLCBlbmNvZGluZykpLFxuICAgICAgICAgICAgICAgIHRha2VXaGlsZSgocmVuZGl0aW9uRW50cnk6IFJlbmRpdGlvbkVudHJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGF0dGVtcHRzICs9IDE7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhdHRlbXB0cyA+IHJldHJpZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHJlbmRpdGlvbkVudHJ5LmVudHJ5LnN0YXR1cy50b1N0cmluZygpICE9PSAnQ1JFQVRFRCcpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==