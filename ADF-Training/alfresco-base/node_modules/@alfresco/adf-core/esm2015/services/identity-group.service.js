import { Injectable } from '@angular/core';
import { of } from 'rxjs';
import { map, switchMap } from 'rxjs/operators';
import { AppConfigService } from '../app-config/app-config.service';
import { OAuth2Service } from './oauth2.service';
import * as i0 from "@angular/core";
import * as i1 from "./oauth2.service";
import * as i2 from "../app-config/app-config.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './oauth2.service';
import * as ɵngcc2 from '../app-config/app-config.service';
export class IdentityGroupService {
    constructor(oAuth2Service, appConfigService) {
        this.oAuth2Service = oAuth2Service;
        this.appConfigService = appConfigService;
    }
    get identityHost() {
        return `${this.appConfigService.get('identityHost')}`;
    }
    getGroups() {
        const url = `${this.identityHost}/groups`;
        return this.oAuth2Service.get({ url });
    }
    getAvailableRoles(groupId) {
        const url = `${this.identityHost}/groups/${groupId}/role-mappings/realm/available`;
        return this.oAuth2Service.get({ url });
    }
    getAssignedRoles(groupId) {
        const url = `${this.identityHost}/groups/${groupId}/role-mappings/realm`;
        return this.oAuth2Service.get({ url });
    }
    assignRoles(groupId, roles) {
        const url = `${this.identityHost}/groups/${groupId}/role-mappings/realm`;
        const bodyParam = JSON.stringify(roles);
        return this.oAuth2Service.post({ url, bodyParam });
    }
    removeRoles(groupId, roles) {
        const url = `${this.identityHost}/groups/${groupId}/role-mappings/realm`;
        const bodyParam = JSON.stringify(roles);
        return this.oAuth2Service.delete({ url, bodyParam });
    }
    getEffectiveRoles(groupId) {
        const url = `${this.identityHost}/groups/${groupId}/role-mappings/realm/composite`;
        return this.oAuth2Service.get({ url });
    }
    queryGroups(requestQuery) {
        const url = `${this.identityHost}/groups`;
        const queryParams = { first: requestQuery.first || 0, max: requestQuery.max || 5 };
        return this.getTotalGroupsCount().pipe(switchMap((totalCount) => this.oAuth2Service.get({ url, queryParams }).pipe(map((response) => {
            return {
                entries: response,
                pagination: {
                    skipCount: requestQuery.first,
                    maxItems: requestQuery.max,
                    count: totalCount.count,
                    hasMoreItems: false,
                    totalItems: totalCount.count
                }
            };
        }))));
    }
    getTotalGroupsCount() {
        const url = `${this.identityHost}/groups/count`;
        return this.oAuth2Service.get({ url });
    }
    createGroup(newGroup) {
        const url = `${this.identityHost}/groups`;
        const bodyParam = newGroup;
        return this.oAuth2Service.post({ url, bodyParam });
    }
    updateGroup(groupId, updatedGroup) {
        const url = `${this.identityHost}/groups/${groupId}`;
        const bodyParam = JSON.stringify(updatedGroup);
        return this.oAuth2Service.put({ url, bodyParam });
    }
    deleteGroup(groupId) {
        const url = `${this.identityHost}/groups/${groupId}`;
        return this.oAuth2Service.delete({ url });
    }
    findGroupsByName(searchParams) {
        if (searchParams.name === '') {
            return of([]);
        }
        const url = `${this.identityHost}/groups`;
        const queryParams = { search: searchParams.name };
        return this.oAuth2Service.get({ url, queryParams });
    }
    getGroupRoles(groupId) {
        const url = this.buildRolesUrl(groupId);
        return this.oAuth2Service.get({ url });
    }
    checkGroupHasRole(groupId, roleNames) {
        return this.getGroupRoles(groupId).pipe(map((groupRoles) => {
            let hasRole = false;
            if (groupRoles && groupRoles.length > 0) {
                roleNames.forEach((roleName) => {
                    const role = groupRoles.find(({ name }) => roleName === name);
                    if (role) {
                        hasRole = true;
                        return;
                    }
                });
            }
            return hasRole;
        }));
    }
    getClientIdByApplicationName(applicationName) {
        const url = `${this.identityHost}/clients`;
        const queryParams = { clientId: applicationName };
        return this.oAuth2Service.get({ url, queryParams }).pipe(map((response) => response && response.length > 0 ? response[0].id : ''));
    }
    getClientRoles(groupId, clientId) {
        const url = `${this.identityHost}/groups/${groupId}/role-mappings/clients/${clientId}`;
        return this.oAuth2Service.get({ url });
    }
    checkGroupHasClientApp(groupId, clientId) {
        return this.getClientRoles(groupId, clientId).pipe(map((response) => response && response.length > 0));
    }
    checkGroupHasAnyClientAppRole(groupId, clientId, roleNames) {
        return this.getClientRoles(groupId, clientId).pipe(map((clientRoles) => {
            let hasRole = false;
            if (clientRoles.length > 0) {
                roleNames.forEach((roleName) => {
                    const role = clientRoles.find(({ name }) => name === roleName);
                    if (role) {
                        hasRole = true;
                        return;
                    }
                });
            }
            return hasRole;
        }));
    }
    buildRolesUrl(groupId) {
        return `${this.identityHost}/groups/${groupId}/role-mappings/realm/composite`;
    }
}
IdentityGroupService.ɵfac = function IdentityGroupService_Factory(t) { return new (t || IdentityGroupService)(ɵngcc0.ɵɵinject(ɵngcc1.OAuth2Service), ɵngcc0.ɵɵinject(ɵngcc2.AppConfigService)); };
IdentityGroupService.ɵprov = i0.ɵɵdefineInjectable({ factory: function IdentityGroupService_Factory() { return new IdentityGroupService(i0.ɵɵinject(i1.OAuth2Service), i0.ɵɵinject(i2.AppConfigService)); }, token: IdentityGroupService, providedIn: "root" });
IdentityGroupService.ctorParameters = () => [
    { type: OAuth2Service },
    { type: AppConfigService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(IdentityGroupService, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], function () { return [{ type: ɵngcc1.OAuth2Service }, { type: ɵngcc2.AppConfigService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlbnRpdHktZ3JvdXAuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvcmUvc2VydmljZXMvaWRlbnRpdHktZ3JvdXAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFpQkEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDaEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFVcEUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pEO0FBRUE7QUFBd0M7Ozs7QUFBeEMsTUFBTSxPQUFPLG9CQUFvQjtBQUFHLElBRWhDLFlBQ1ksYUFBNEIsRUFDNUIsZ0JBQWtDO0FBQy9DLFFBRmEsa0JBQWEsR0FBYixhQUFhLENBQWU7QUFBQyxRQUM3QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO0FBQ2xELElBQU8sQ0FBQztBQUNSLElBQ0ksSUFBWSxZQUFZO0FBQUssUUFDekIsT0FBTyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQztBQUM5RCxJQUFJLENBQUM7QUFDTCxJQUtJLFNBQVM7QUFBSyxRQUNWLE1BQU0sR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFlBQVksU0FBUyxDQUFDO0FBQ2xELFFBQVEsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7QUFDL0MsSUFBSSxDQUFDO0FBQ0wsSUFNSSxpQkFBaUIsQ0FBQyxPQUFlO0FBQUksUUFD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LDZCQUE2QixDQUFDLE9BQWUsRUFBRSxRQUFnQixFQUFFLFNBQW1CO0FBQUksUUFDcEYsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQzlDLEdBQUcsQ0FBQyxDQUFDLFdBQWtCLEVBQUUsRUFBRTtBQUN2QyxZQUFnQixJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7QUFDcEMsWUFBZ0IsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtBQUM1QyxnQkFBb0IsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFO0FBQ25ELG9CQUF3QixNQUFNLElBQUksR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQyxDQUFDO0FBQ3ZGLG9CQUN3QixJQUFJLElBQUksRUFBRTtBQUNsQyx3QkFBNEIsT0FBTyxHQUFHLElBQUksQ0FBQztBQUMzQyx3QkFBNEIsT0FBTztBQUNuQyxxQkFBeUI7QUFDekIsZ0JBQW9CLENBQUMsQ0FBQyxDQUFDO0FBQ3ZCLGFBQWlCO0FBQ2pCLFlBQWdCLE9BQU8sT0FBTyxDQUFDO0FBQy9CLFFBQVksQ0FBQyxDQUFDLENBQ0wsQ0FBQztBQUNWLElBQUksQ0FBQztBQUNMLElBQ1ksYUFBYSxDQUFDLE9BQWU7QUFBSSxRQUNyQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFlBQVksV0FBVyxPQUFPLGdDQUFnQyxDQUFDO0FBQ3RGLElBQUksQ0FBQztBQUNMO2tNQUFDO0FBQ0QsZ1FBblFLO0FBQUM7RUFETCxVQUFVLFNBQUMsRUFBRSx2QkFDc0MsWUFIM0MsYUFBYTtJQUVFLEVBQUUsTUFBTSxFQUFFLGRBRlIsWUFWakIsZ0JBQWdCO0FBQUc7Ozs7aUhBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEFwcENvbmZpZ1NlcnZpY2UgfSBmcm9tICcuLi9hcHAtY29uZmlnL2FwcC1jb25maWcuc2VydmljZSc7XG5pbXBvcnQge1xuICAgIElkZW50aXR5R3JvdXBTZWFyY2hQYXJhbSxcbiAgICBJZGVudGl0eUdyb3VwUXVlcnlDbG91ZFJlcXVlc3RNb2RlbCxcbiAgICBJZGVudGl0eUdyb3VwTW9kZWwsXG4gICAgSWRlbnRpdHlHcm91cFF1ZXJ5UmVzcG9uc2UsXG4gICAgSWRlbnRpdHlHcm91cENvdW50TW9kZWxcbn0gZnJvbSAnLi4vbW9kZWxzL2lkZW50aXR5LWdyb3VwLm1vZGVsJztcbmltcG9ydCB7IElkZW50aXR5Um9sZU1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL2lkZW50aXR5LXJvbGUubW9kZWwnO1xuaW1wb3J0IHsgSWRlbnRpdHlHcm91cFNlcnZpY2VJbnRlcmZhY2UgfSBmcm9tICcuL2lkZW50aXR5LWdyb3VwLmludGVyZmFjZSc7XG5pbXBvcnQgeyBPQXV0aDJTZXJ2aWNlIH0gZnJvbSAnLi9vYXV0aDIuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgSWRlbnRpdHlHcm91cFNlcnZpY2UgaW1wbGVtZW50cyBJZGVudGl0eUdyb3VwU2VydmljZUludGVyZmFjZSB7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBvQXV0aDJTZXJ2aWNlOiBPQXV0aDJTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGFwcENvbmZpZ1NlcnZpY2U6IEFwcENvbmZpZ1NlcnZpY2VcbiAgICApIHt9XG5cbiAgICBwcml2YXRlIGdldCBpZGVudGl0eUhvc3QoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGAke3RoaXMuYXBwQ29uZmlnU2VydmljZS5nZXQoJ2lkZW50aXR5SG9zdCcpfWA7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgZ3JvdXBzLlxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIGdyb3VwIGluZm9ybWF0aW9uIG9iamVjdHNcbiAgICAgKi9cbiAgICBnZXRHcm91cHMoKTogT2JzZXJ2YWJsZTxJZGVudGl0eUdyb3VwTW9kZWxbXT4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmlkZW50aXR5SG9zdH0vZ3JvdXBzYDtcbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5nZXQoeyB1cmwgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhdmFpbGFibGUgcm9sZXNcbiAgICAgKiBAcGFyYW0gZ3JvdXBJZCBJZCBvZiB0aGUgZ3JvdXAuXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgYXZhaWxhYmxlIHJvbGVzIGluZm9ybWF0aW9uIG9iamVjdHNcbiAgICAgKi9cbiAgICBnZXRBdmFpbGFibGVSb2xlcyhncm91cElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPElkZW50aXR5Um9sZU1vZGVsW10+IHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5pZGVudGl0eUhvc3R9L2dyb3Vwcy8ke2dyb3VwSWR9L3JvbGUtbWFwcGluZ3MvcmVhbG0vYXZhaWxhYmxlYDtcbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5nZXQoeyB1cmwgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhc3NpZ25lZCByb2xlc1xuICAgICAqIEBwYXJhbSBncm91cElkIElkIG9mIHRoZSBncm91cC5cbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBhdmFpbGFibGUgcm9sZXNcbiAgICAgKi9cbiAgICBnZXRBc3NpZ25lZFJvbGVzKGdyb3VwSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8SWRlbnRpdHlSb2xlTW9kZWxbXT4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmlkZW50aXR5SG9zdH0vZ3JvdXBzLyR7Z3JvdXBJZH0vcm9sZS1tYXBwaW5ncy9yZWFsbWA7XG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UuZ2V0KHsgdXJsIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFzc2lnbnMgcm9sZXMgdG8gdGhlIGdyb3VwXG4gICAgICogQHBhcmFtIGdyb3VwSWQgVGhlIElEIG9mIHRoZSBncm91cFxuICAgICAqIEBwYXJhbSByb2xlcyBBcnJheSBvZiByb2xlcyB0byBhc3NpZ25cbiAgICAgKi9cbiAgICBhc3NpZ25Sb2xlcyhncm91cElkOiBzdHJpbmcsIHJvbGVzOiBJZGVudGl0eVJvbGVNb2RlbFtdKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5pZGVudGl0eUhvc3R9L2dyb3Vwcy8ke2dyb3VwSWR9L3JvbGUtbWFwcGluZ3MvcmVhbG1gO1xuICAgICAgICBjb25zdCBib2R5UGFyYW0gPSBKU09OLnN0cmluZ2lmeShyb2xlcyk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5wb3N0KHsgdXJsLCBib2R5UGFyYW0gfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlcyByb2xlcyBmcm9tIHRoZSBncm91cFxuICAgICAqIEBwYXJhbSBncm91cElkIFRoZSBJRCBvZiB0aGUgZ3JvdXBcbiAgICAgKiBAcGFyYW0gcm9sZXMgQXJyYXkgb2Ygcm9sZXMgdG8gcmVtb3ZlXG4gICAgICovXG4gICAgcmVtb3ZlUm9sZXMoZ3JvdXBJZDogc3RyaW5nLCByb2xlczogSWRlbnRpdHlSb2xlTW9kZWxbXSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke3RoaXMuaWRlbnRpdHlIb3N0fS9ncm91cHMvJHtncm91cElkfS9yb2xlLW1hcHBpbmdzL3JlYWxtYDtcbiAgICAgICAgY29uc3QgYm9keVBhcmFtID0gSlNPTi5zdHJpbmdpZnkocm9sZXMpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UuZGVsZXRlKHsgdXJsLCBib2R5UGFyYW0gfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGVmZmVjdGl2ZSByb2xlc1xuICAgICAqIEBwYXJhbSBncm91cElkIElkIG9mIHRoZSBncm91cFxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIGVmZmVjdGl2ZSByb2xlc1xuICAgICAqL1xuICAgIGdldEVmZmVjdGl2ZVJvbGVzKGdyb3VwSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8SWRlbnRpdHlSb2xlTW9kZWxbXT4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmlkZW50aXR5SG9zdH0vZ3JvdXBzLyR7Z3JvdXBJZH0vcm9sZS1tYXBwaW5ncy9yZWFsbS9jb21wb3NpdGVgO1xuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLmdldCh7IHVybCB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBRdWVyaWVzIGdyb3Vwcy5cbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiB1c2VyIGluZm9ybWF0aW9uIG9iamVjdHNcbiAgICAgKi9cbiAgICBxdWVyeUdyb3VwcyhyZXF1ZXN0UXVlcnk6IElkZW50aXR5R3JvdXBRdWVyeUNsb3VkUmVxdWVzdE1vZGVsKTogT2JzZXJ2YWJsZTxJZGVudGl0eUdyb3VwUXVlcnlSZXNwb25zZT4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmlkZW50aXR5SG9zdH0vZ3JvdXBzYDtcbiAgICAgICAgY29uc3QgcXVlcnlQYXJhbXMgPSB7IGZpcnN0OiByZXF1ZXN0UXVlcnkuZmlyc3QgfHwgMCwgbWF4OiByZXF1ZXN0UXVlcnkubWF4IHx8IDUgfTtcblxuICAgICAgICByZXR1cm4gdGhpcy5nZXRUb3RhbEdyb3Vwc0NvdW50KCkucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgodG90YWxDb3VudDogSWRlbnRpdHlHcm91cENvdW50TW9kZWwpID0+XG4gICAgICAgICAgICB0aGlzLm9BdXRoMlNlcnZpY2UuZ2V0PGFueVtdPih7IHVybCwgcXVlcnlQYXJhbXMgfSkucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiA8SWRlbnRpdHlHcm91cFF1ZXJ5UmVzcG9uc2U+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudHJpZXM6IHJlc3BvbnNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnaW5hdGlvbjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNraXBDb3VudDogcmVxdWVzdFF1ZXJ5LmZpcnN0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heEl0ZW1zOiByZXF1ZXN0UXVlcnkubWF4LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50OiB0b3RhbENvdW50LmNvdW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc01vcmVJdGVtczogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxJdGVtczogdG90YWxDb3VudC5jb3VudFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgZ3JvdXBzIHRvdGFsIGNvdW50LlxuICAgICAqIEByZXR1cm5zIE51bWJlciBvZiBncm91cHMgY291bnQuXG4gICAgICovXG4gICAgZ2V0VG90YWxHcm91cHNDb3VudCgpOiBPYnNlcnZhYmxlPElkZW50aXR5R3JvdXBDb3VudE1vZGVsPiB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke3RoaXMuaWRlbnRpdHlIb3N0fS9ncm91cHMvY291bnRgO1xuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLmdldCh7IHVybCB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIG5ldyBncm91cC5cbiAgICAgKiBAcGFyYW0gbmV3R3JvdXAgT2JqZWN0IG9mIGNvbnRhaW5pbmcgdGhlIG5ldyBncm91cCBkZXRhaWxzLlxuICAgICAqIEByZXR1cm5zIEVtcHR5IHJlc3BvbnNlIHdoZW4gdGhlIGdyb3VwIGNyZWF0ZWQuXG4gICAgICovXG4gICAgY3JlYXRlR3JvdXAobmV3R3JvdXA6IElkZW50aXR5R3JvdXBNb2RlbCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke3RoaXMuaWRlbnRpdHlIb3N0fS9ncm91cHNgO1xuICAgICAgICBjb25zdCBib2R5UGFyYW0gPSBuZXdHcm91cDtcblxuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLnBvc3QoeyB1cmwsIGJvZHlQYXJhbSB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIGdyb3VwIGRldGFpbHMuXG4gICAgICogQHBhcmFtIGdyb3VwSWQgSWQgb2YgdGhlIHRhcmdldGVkIGdyb3VwLlxuICAgICAqIEBwYXJhbSB1cGRhdGVkR3JvdXAgT2JqZWN0IG9mIGNvbnRhaW5pbmcgdGhlIGdyb3VwIGRldGFpbHNcbiAgICAgKiBAcmV0dXJucyBFbXB0eSByZXNwb25zZSB3aGVuIHRoZSBncm91cCB1cGRhdGVkLlxuICAgICAqL1xuICAgIHVwZGF0ZUdyb3VwKGdyb3VwSWQ6IHN0cmluZywgdXBkYXRlZEdyb3VwOiBJZGVudGl0eUdyb3VwTW9kZWwpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmlkZW50aXR5SG9zdH0vZ3JvdXBzLyR7Z3JvdXBJZH1gO1xuICAgICAgICBjb25zdCBib2R5UGFyYW0gPSBKU09OLnN0cmluZ2lmeSh1cGRhdGVkR3JvdXApO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UucHV0KHsgdXJsLCBib2R5UGFyYW0gfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVsZXRlcyBHcm91cC5cbiAgICAgKiBAcGFyYW0gZ3JvdXBJZCBJZCBvZiB0aGUgZ3JvdXAuXG4gICAgICogQHJldHVybnMgRW1wdHkgcmVzcG9uc2Ugd2hlbiB0aGUgZ3JvdXAgZGVsZXRlZC5cbiAgICAgKi9cbiAgICBkZWxldGVHcm91cChncm91cElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmlkZW50aXR5SG9zdH0vZ3JvdXBzLyR7Z3JvdXBJZH1gO1xuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLmRlbGV0ZSh7IHVybCB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kcyBncm91cHMgZmlsdGVyZWQgYnkgbmFtZS5cbiAgICAgKiBAcGFyYW0gc2VhcmNoUGFyYW1zIE9iamVjdCBjb250YWluaW5nIHRoZSBuYW1lIGZpbHRlciBzdHJpbmdcbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIGdyb3VwIGluZm9ybWF0aW9uXG4gICAgICovXG4gICAgZmluZEdyb3Vwc0J5TmFtZShzZWFyY2hQYXJhbXM6IElkZW50aXR5R3JvdXBTZWFyY2hQYXJhbSk6IE9ic2VydmFibGU8SWRlbnRpdHlHcm91cE1vZGVsW10+IHtcbiAgICAgICAgaWYgKHNlYXJjaFBhcmFtcy5uYW1lID09PSAnJykge1xuICAgICAgICAgICAgcmV0dXJuIG9mKFtdKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmlkZW50aXR5SG9zdH0vZ3JvdXBzYDtcbiAgICAgICAgY29uc3QgcXVlcnlQYXJhbXMgPSB7IHNlYXJjaDogc2VhcmNoUGFyYW1zLm5hbWUgfTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLmdldCh7IHVybCwgcXVlcnlQYXJhbXMgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBkZXRhaWxzIGZvciBhIHNwZWNpZmllZCBncm91cC5cbiAgICAgKiBAcGFyYW0gZ3JvdXBJZCBJZCBvZiB0aGUgdGFyZ2V0IGdyb3VwXG4gICAgICogQHJldHVybnMgR3JvdXAgZGV0YWlsc1xuICAgICAqL1xuICAgIGdldEdyb3VwUm9sZXMoZ3JvdXBJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxJZGVudGl0eVJvbGVNb2RlbFtdPiB7XG4gICAgICAgIGNvbnN0IHVybCA9IHRoaXMuYnVpbGRSb2xlc1VybChncm91cElkKTtcbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5nZXQoeyB1cmwgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgdGhhdCBhIGdyb3VwIGhhcyBvbmUgb3IgbW9yZSByb2xlcyBmcm9tIHRoZSBzdXBwbGllZCBsaXN0LlxuICAgICAqIEBwYXJhbSBncm91cElkIElkIG9mIHRoZSB0YXJnZXQgZ3JvdXBcbiAgICAgKiBAcGFyYW0gcm9sZU5hbWVzIEFycmF5IG9mIHJvbGUgbmFtZXNcbiAgICAgKiBAcmV0dXJucyBUcnVlIGlmIHRoZSBncm91cCBoYXMgb25lIG9yIG1vcmUgb2YgdGhlIHJvbGVzLCBmYWxzZSBvdGhlcndpc2VcbiAgICAgKi9cbiAgICBjaGVja0dyb3VwSGFzUm9sZShncm91cElkOiBzdHJpbmcsIHJvbGVOYW1lczogc3RyaW5nW10pOiBPYnNlcnZhYmxlPGJvb2xlYW4+ICB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEdyb3VwUm9sZXMoZ3JvdXBJZCkucGlwZShtYXAoKGdyb3VwUm9sZXMpID0+IHtcbiAgICAgICAgICAgIGxldCBoYXNSb2xlID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAoZ3JvdXBSb2xlcyAmJiBncm91cFJvbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICByb2xlTmFtZXMuZm9yRWFjaCgocm9sZU5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByb2xlID0gZ3JvdXBSb2xlcy5maW5kKCh7IG5hbWUgfSkgPT4gcm9sZU5hbWUgPT09IG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocm9sZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaGFzUm9sZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBoYXNSb2xlO1xuICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgY2xpZW50IElkIHVzaW5nIHRoZSBhcHAgbmFtZS5cbiAgICAgKiBAcGFyYW0gYXBwbGljYXRpb25OYW1lIE5hbWUgb2YgdGhlIGFwcFxuICAgICAqIEByZXR1cm5zIGNsaWVudCBJZCBzdHJpbmdcbiAgICAgKi9cbiAgICBnZXRDbGllbnRJZEJ5QXBwbGljYXRpb25OYW1lKGFwcGxpY2F0aW9uTmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5pZGVudGl0eUhvc3R9L2NsaWVudHNgO1xuICAgICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IHtjbGllbnRJZDogYXBwbGljYXRpb25OYW1lfTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLmdldDxhbnlbXT4oeyB1cmwsIHF1ZXJ5UGFyYW1zIH0pLnBpcGUoXG4gICAgICAgICAgICBtYXAoKHJlc3BvbnNlKSA9PiByZXNwb25zZSAmJiByZXNwb25zZS5sZW5ndGggPiAwID8gcmVzcG9uc2VbMF0uaWQgOiAnJylcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGNsaWVudCByb2xlcy5cbiAgICAgKiBAcGFyYW0gZ3JvdXBJZCBJZCBvZiB0aGUgdGFyZ2V0IGdyb3VwXG4gICAgICogQHBhcmFtIGNsaWVudElkIElkIG9mIHRoZSBjbGllbnRcbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIHJvbGVzXG4gICAgICovXG4gICAgZ2V0Q2xpZW50Um9sZXMoZ3JvdXBJZDogc3RyaW5nLCBjbGllbnRJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxJZGVudGl0eVJvbGVNb2RlbFtdPiB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke3RoaXMuaWRlbnRpdHlIb3N0fS9ncm91cHMvJHtncm91cElkfS9yb2xlLW1hcHBpbmdzL2NsaWVudHMvJHtjbGllbnRJZH1gO1xuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLmdldCh7IHVybCB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3MgaWYgYSBncm91cCBoYXMgYSBjbGllbnQgYXBwLlxuICAgICAqIEBwYXJhbSBncm91cElkIElkIG9mIHRoZSB0YXJnZXQgZ3JvdXBcbiAgICAgKiBAcGFyYW0gY2xpZW50SWQgSWQgb2YgdGhlIGNsaWVudFxuICAgICAqIEByZXR1cm5zIFRydWUgaWYgdGhlIGdyb3VwIGhhcyB0aGUgY2xpZW50IGFwcCwgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgY2hlY2tHcm91cEhhc0NsaWVudEFwcChncm91cElkOiBzdHJpbmcsIGNsaWVudElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q2xpZW50Um9sZXMoZ3JvdXBJZCwgY2xpZW50SWQpLnBpcGUoXG4gICAgICAgICAgICBtYXAoKHJlc3BvbnNlKSA9PiByZXNwb25zZSAmJiByZXNwb25zZS5sZW5ndGggPiAwKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIGEgZ3JvdXAgaGFzIGFueSBvZiB0aGUgY2xpZW50IGFwcCByb2xlcyBpbiB0aGUgc3VwcGxpZWQgbGlzdC5cbiAgICAgKiBAcGFyYW0gZ3JvdXBJZCBJZCBvZiB0aGUgdGFyZ2V0IGdyb3VwXG4gICAgICogQHBhcmFtIGNsaWVudElkIElkIG9mIHRoZSBjbGllbnRcbiAgICAgKiBAcGFyYW0gcm9sZU5hbWVzIEFycmF5IG9mIHJvbGUgbmFtZXMgdG8gY2hlY2tcbiAgICAgKiBAcmV0dXJucyBUcnVlIGlmIHRoZSBncm91cCBoYXMgb25lIG9yIG1vcmUgb2YgdGhlIHJvbGVzLCBmYWxzZSBvdGhlcndpc2VcbiAgICAgKi9cbiAgICBjaGVja0dyb3VwSGFzQW55Q2xpZW50QXBwUm9sZShncm91cElkOiBzdHJpbmcsIGNsaWVudElkOiBzdHJpbmcsIHJvbGVOYW1lczogc3RyaW5nW10pOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q2xpZW50Um9sZXMoZ3JvdXBJZCwgY2xpZW50SWQpLnBpcGUoXG4gICAgICAgICAgICBtYXAoKGNsaWVudFJvbGVzOiBhbnlbXSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBoYXNSb2xlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKGNsaWVudFJvbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcm9sZU5hbWVzLmZvckVhY2goKHJvbGVOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByb2xlID0gY2xpZW50Um9sZXMuZmluZCgoeyBuYW1lIH0pID0+IG5hbWUgPT09IHJvbGVOYW1lKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJvbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNSb2xlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gaGFzUm9sZTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBidWlsZFJvbGVzVXJsKGdyb3VwSWQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBgJHt0aGlzLmlkZW50aXR5SG9zdH0vZ3JvdXBzLyR7Z3JvdXBJZH0vcm9sZS1tYXBwaW5ncy9yZWFsbS9jb21wb3NpdGVgO1xuICAgIH1cbn1cbiJdfQ==