/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { __awaiter } from "tslib";
import { AppConfigValues } from '../app-config/app-config.service';
export class AuthGuardBase {
    constructor(authenticationService, router, appConfigService, dialog, storageService) {
        this.authenticationService = authenticationService;
        this.router = router;
        this.appConfigService = appConfigService;
        this.dialog = dialog;
        this.storageService = storageService;
    }
    get withCredentials() {
        return this.appConfigService.get('auth.withCredentials', false);
    }
    canActivate(route, state) {
        if (this.authenticationService.isLoggedIn() && this.authenticationService.isOauth() && this.isLoginFragmentPresent()) {
            return this.redirectSSOSuccessURL();
        }
        return this.checkLogin(route, state.url);
    }
    canActivateChild(route, state) {
        return this.canActivate(route, state);
    }
    redirectSSOSuccessURL() {
        return __awaiter(this, void 0, void 0, function* () {
            const redirectFragment = this.storageService.getItem('loginFragment');
            if (redirectFragment && this.getLoginRoute() !== redirectFragment) {
                yield this.navigate(redirectFragment);
                this.storageService.removeItem('loginFragment');
                return false;
            }
            return true;
        });
    }
    isLoginFragmentPresent() {
        return !!this.storageService.getItem('loginFragment');
    }
    redirectToUrl(url) {
        return __awaiter(this, void 0, void 0, function* () {
            let urlToRedirect = `/${this.getLoginRoute()}`;
            if (!this.authenticationService.isOauth()) {
                this.authenticationService.setRedirect({
                    provider: this.getProvider(),
                    url
                });
                urlToRedirect = `${urlToRedirect}?redirectUrl=${url}`;
                return this.navigate(urlToRedirect);
            }
            else if (this.getOauthConfig().silentLogin && !this.authenticationService.isPublicUrl()) {
                this.authenticationService.ssoImplicitLogin();
            }
            else {
                return this.navigate(urlToRedirect);
            }
            return false;
        });
    }
    navigate(url) {
        return __awaiter(this, void 0, void 0, function* () {
            this.dialog.closeAll();
            yield this.router.navigateByUrl(this.router.parseUrl(url));
            return false;
        });
    }
    getOauthConfig() {
        return (this.appConfigService &&
            this.appConfigService.get(AppConfigValues.OAUTHCONFIG, null));
    }
    getLoginRoute() {
        return (this.appConfigService &&
            this.appConfigService.get(AppConfigValues.LOGIN_ROUTE, 'login'));
    }
    getProvider() {
        return (this.appConfigService &&
            this.appConfigService.get(AppConfigValues.PROVIDERS, 'ALL'));
    }
    isOAuthWithoutSilentLogin() {
        const oauth = this.appConfigService.get(AppConfigValues.OAUTHCONFIG, null);
        return (this.authenticationService.isOauth() && !!oauth && !oauth.silentLogin);
    }
    isSilentLogin() {
        const oauth = this.appConfigService.get(AppConfigValues.OAUTHCONFIG, null);
        return this.authenticationService.isOauth() && oauth && oauth.silentLogin;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1ndWFyZC1iYXNlLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvY29yZS8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL2F1dGgtZ3VhcmQtYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7O0FBV0gsT0FBTyxFQUVILGVBQWUsRUFDbEIsTUFBTSxrQ0FBa0MsQ0FBQztBQU0xQyxNQUFNLE9BQWdCLGFBQWE7SUFTL0IsWUFDYyxxQkFBNEMsRUFDNUMsTUFBYyxFQUNkLGdCQUFrQyxFQUNsQyxNQUFpQixFQUNuQixjQUE4QjtRQUo1QiwwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO1FBQzVDLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLFdBQU0sR0FBTixNQUFNLENBQVc7UUFDbkIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO0lBRTFDLENBQUM7SUFkRCxJQUFjLGVBQWU7UUFDekIsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUM1QixzQkFBc0IsRUFDdEIsS0FBSyxDQUNSLENBQUM7SUFDTixDQUFDO0lBZ0JELFdBQVcsQ0FDUCxLQUE2QixFQUM3QixLQUEwQjtRQUcxQixJQUFJLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLEVBQUUsSUFBSSxJQUFJLENBQUMscUJBQXFCLENBQUMsT0FBTyxFQUFFLElBQUksSUFBSSxDQUFDLHNCQUFzQixFQUFFLEVBQUU7WUFDbEgsT0FBTyxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztTQUN2QztRQUVELE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxnQkFBZ0IsQ0FDWixLQUE2QixFQUM3QixLQUEwQjtRQUUxQixPQUFP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QUFXLENBQ3hFLENBQUM7SUFDTixDQUFDO0lBRVMsYUFBYTtRQUNuQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUNuQyxlQUFlLENBQUMsV0FBVyxFQUMzQixJQUFJLENBQ1AsQ0FBQztRQUVGLE9BQU8sSUFBSSxDQUFDLHFCQUFxQixDQUFDLE9BQU8sRUFBRSxJQUFJLEtBQUssSUFBSSxLQUFLLENBQUMsV0FBVyxDQUFDO0lBQzlFLENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7XG4gICAgUm91dGVyLFxuICAgIENhbkFjdGl2YXRlLFxuICAgIEFjdGl2YXRlZFJvdXRlU25hcHNob3QsXG4gICAgUm91dGVyU3RhdGVTbmFwc2hvdCxcbiAgICBDYW5BY3RpdmF0ZUNoaWxkLFxuICAgIFVybFRyZWVcbn0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IEF1dGhlbnRpY2F0aW9uU2VydmljZSB9IGZyb20gJy4vYXV0aGVudGljYXRpb24uc2VydmljZSc7XG5pbXBvcnQge1xuICAgIEFwcENvbmZpZ1NlcnZpY2UsXG4gICAgQXBwQ29uZmlnVmFsdWVzXG59IGZyb20gJy4uL2FwcC1jb25maWcvYXBwLWNvbmZpZy5zZXJ2aWNlJztcbmltcG9ydCB7IE9hdXRoQ29uZmlnTW9kZWwgfSBmcm9tICcuLi9tb2RlbHMvb2F1dGgtY29uZmlnLm1vZGVsJztcbmltcG9ydCB7IE1hdERpYWxvZyB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2RpYWxvZyc7XG5pbXBvcnQgeyBTdG9yYWdlU2VydmljZSB9IGZyb20gJy4vc3RvcmFnZS5zZXJ2aWNlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEF1dGhHdWFyZEJhc2UgaW1wbGVtZW50cyBDYW5BY3RpdmF0ZSwgQ2FuQWN0aXZhdGVDaGlsZCB7XG5cbiAgICBwcm90ZWN0ZWQgZ2V0IHdpdGhDcmVkZW50aWFscygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwQ29uZmlnU2VydmljZS5nZXQ8Ym9vbGVhbj4oXG4gICAgICAgICAgICAnYXV0aC53aXRoQ3JlZGVudGlhbHMnLFxuICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJvdGVjdGVkIGF1dGhlbnRpY2F0aW9uU2VydmljZTogQXV0aGVudGljYXRpb25TZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgcm91dGVyOiBSb3V0ZXIsXG4gICAgICAgIHByb3RlY3RlZCBhcHBDb25maWdTZXJ2aWNlOiBBcHBDb25maWdTZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgZGlhbG9nOiBNYXREaWFsb2csXG4gICAgICAgIHByaXZhdGUgc3RvcmFnZVNlcnZpY2U6IFN0b3JhZ2VTZXJ2aWNlXG4gICAgKSB7XG4gICAgfVxuXG4gICAgYWJzdHJhY3QgY2hlY2tMb2dpbihcbiAgICAgICAgYWN0aXZlUm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsXG4gICAgICAgIHJlZGlyZWN0VXJsOiBzdHJpbmdcbiAgICApOiBPYnNlcnZhYmxlPGJvb2xlYW4gfCBVcmxUcmVlPiB8IFByb21pc2U8Ym9vbGVhbiB8IFVybFRyZWU+IHwgYm9vbGVhbiB8IFVybFRyZWU7XG5cbiAgICBjYW5BY3RpdmF0ZShcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsXG4gICAgICAgIHN0YXRlOiBSb3V0ZXJTdGF0ZVNuYXBzaG90XG4gICAgKTogT2JzZXJ2YWJsZTxib29sZWFuIHwgVXJsVHJlZT4gfCBQcm9taXNlPGJvb2xlYW4gfCBVcmxUcmVlPiB8IGJvb2xlYW4gfCBVcmxUcmVlIHtcblxuICAgICAgICBpZiAodGhpcy5hdXRoZW50aWNhdGlvblNlcnZpY2UuaXNMb2dnZWRJbigpICYmIHRoaXMuYXV0aGVudGljYXRpb25TZXJ2aWNlLmlzT2F1dGgoKSAmJiB0aGlzLmlzTG9naW5GcmFnbWVudFByZXNlbnQoKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVkaXJlY3RTU09TdWNjZXNzVVJMKCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5jaGVja0xvZ2luKHJvdXRlLCBzdGF0ZS51cmwpO1xuICAgIH1cblxuICAgIGNhbkFjdGl2YXRlQ2hpbGQoXG4gICAgICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LFxuICAgICAgICBzdGF0ZTogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICk6IE9ic2VydmFibGU8Ym9vbGVhbiB8IFVybFRyZWU+IHwgUHJvbWlzZTxib29sZWFuIHwgVXJsVHJlZT4gfCBib29sZWFuIHwgVXJsVHJlZSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhbkFjdGl2YXRlKHJvdXRlLCBzdGF0ZSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGFzeW5jIHJlZGlyZWN0U1NPU3VjY2Vzc1VSTCgpOiBQcm9taXNlPGJvb2xlYW4gfCBVcmxUcmVlPiB7XG4gICAgICAgIGNvbnN0IHJlZGlyZWN0RnJhZ21lbnQgPSB0aGlzLnN0b3JhZ2VTZXJ2aWNlLmdldEl0ZW0oJ2xvZ2luRnJhZ21lbnQnKTtcblxuICAgICAgICBpZiAocmVkaXJlY3RGcmFnbWVudCAmJiB0aGlzLmdldExvZ2luUm91dGUoKSAhPT0gcmVkaXJlY3RGcmFnbWVudCkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5uYXZpZ2F0ZShyZWRpcmVjdEZyYWdtZW50KTtcbiAgICAgICAgICAgIHRoaXMuc3RvcmFnZVNlcnZpY2UucmVtb3ZlSXRlbSgnbG9naW5GcmFnbWVudCcpO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGlzTG9naW5GcmFnbWVudFByZXNlbnQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAhIXRoaXMuc3RvcmFnZVNlcnZpY2UuZ2V0SXRlbSgnbG9naW5GcmFnbWVudCcpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyByZWRpcmVjdFRvVXJsKHVybDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuIHwgVXJsVHJlZT4ge1xuICAgICAgICBsZXQgdXJsVG9SZWRpcmVjdCA9IGAvJHt0aGlzLmdldExvZ2luUm91dGUoKX1gO1xuXG4gICAgICAgIGlmICghdGhpcy5hdXRoZW50aWNhdGlvblNlcnZpY2UuaXNPYXV0aCgpKSB7XG4gICAgICAgICAgICB0aGlzLmF1dGhlbnRpY2F0aW9uU2VydmljZS5zZXRSZWRpcmVjdCh7XG4gICAgICAgICAgICAgICAgcHJvdmlkZXI6IHRoaXMuZ2V0UHJvdmlkZXIoKSxcbiAgICAgICAgICAgICAgICB1cmxcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB1cmxUb1JlZGlyZWN0ID0gYCR7dXJsVG9SZWRpcmVjdH0/cmVkaXJlY3RVcmw9JHt1cmx9YDtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm5hdmlnYXRlKHVybFRvUmVkaXJlY3QpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZ2V0T2F1dGhDb25maWcoKS5zaWxlbnRMb2dpbiAmJiAhdGhpcy5hdXRoZW50aWNhdGlvblNlcnZpY2UuaXNQdWJsaWNVcmwoKSkge1xuICAgICAgICAgICAgdGhpcy5hdXRoZW50aWNhdGlvblNlcnZpY2Uuc3NvSW1wbGljaXRMb2dpbigpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubmF2aWdhdGUodXJsVG9SZWRpcmVjdCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGFzeW5jIG5hdmlnYXRlKHVybDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHRoaXMuZGlhbG9nLmNsb3NlQWxsKCk7XG4gICAgICAgIGF3YWl0IHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwodGhpcy5yb3V0ZXIucGFyc2VVcmwodXJsKSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0T2F1dGhDb25maWcoKTogT2F1dGhDb25maWdNb2RlbCB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICB0aGlzLmFwcENvbmZpZ1NlcnZpY2UgJiZcbiAgICAgICAgICAgIHRoaXMuYXBwQ29uZmlnU2VydmljZS5nZXQ8T2F1dGhDb25maWdNb2RlbD4oXG4gICAgICAgICAgICAgICAgQXBwQ29uZmlnVmFsdWVzLk9BVVRIQ09ORklHLFxuICAgICAgICAgICAgICAgIG51bGxcbiAgICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0TG9naW5Sb3V0ZSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgdGhpcy5hcHBDb25maWdTZXJ2aWNlICYmXG4gICAgICAgICAgICB0aGlzLmFwcENvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oXG4gICAgICAgICAgICAgICAgQXBwQ29uZmlnVmFsdWVzLkxPR0lOX1JPVVRFLFxuICAgICAgICAgICAgICAgICdsb2dpbidcbiAgICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0UHJvdmlkZXIoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMuYXBwQ29uZmlnU2VydmljZSAmJlxuICAgICAgICAgICAgdGhpcy5hcHBDb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KFxuICAgICAgICAgICAgICAgIEFwcENvbmZpZ1ZhbHVlcy5QUk9WSURFUlMsXG4gICAgICAgICAgICAgICAgJ0FMTCdcbiAgICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgaXNPQXV0aFdpdGhvdXRTaWxlbnRMb2dpbigpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3Qgb2F1dGggPSB0aGlzLmFwcENvbmZpZ1NlcnZpY2UuZ2V0PE9hdXRoQ29uZmlnTW9kZWw+KFxuICAgICAgICAgICAgQXBwQ29uZmlnVmFsdWVzLk9BVVRIQ09ORklHLFxuICAgICAgICAgICAgbnVsbFxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgdGhpcy5hdXRoZW50aWNhdGlvblNlcnZpY2UuaXNPYXV0aCgpICYmICEhb2F1dGggJiYgIW9hdXRoLnNpbGVudExvZ2luXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGlzU2lsZW50TG9naW4oKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IG9hdXRoID0gdGhpcy5hcHBDb25maWdTZXJ2aWNlLmdldDxPYXV0aENvbmZpZ01vZGVsPihcbiAgICAgICAgICAgIEFwcENvbmZpZ1ZhbHVlcy5PQVVUSENPTkZJRyxcbiAgICAgICAgICAgIG51bGxcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5hdXRoZW50aWNhdGlvblNlcnZpY2UuaXNPYXV0aCgpICYmIG9hdXRoICYmIG9hdXRoLnNpbGVudExvZ2luO1xuICAgIH1cblxufVxuIl19