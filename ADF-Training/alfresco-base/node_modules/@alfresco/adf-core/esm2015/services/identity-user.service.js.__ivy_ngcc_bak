import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { of } from 'rxjs';
import { map, switchMap } from 'rxjs/operators';
import { AppConfigService } from '../app-config/app-config.service';
import { JwtHelperService } from './jwt-helper.service';
import { OAuth2Service } from './oauth2.service';
import * as i0 from "@angular/core";
import * as i1 from "./jwt-helper.service";
import * as i2 from "./oauth2.service";
import * as i3 from "../app-config/app-config.service";
export class IdentityUserService {
    constructor(jwtHelperService, oAuth2Service, appConfigService) {
        this.jwtHelperService = jwtHelperService;
        this.oAuth2Service = oAuth2Service;
        this.appConfigService = appConfigService;
    }
    get identityHost() {
        return `${this.appConfigService.get('identityHost')}`;
    }
    buildUserUrl() {
        return `${this.identityHost}/users`;
    }
    getCurrentUserInfo() {
        const familyName = this.jwtHelperService.getValueFromLocalAccessToken(JwtHelperService.FAMILY_NAME);
        const givenName = this.jwtHelperService.getValueFromLocalAccessToken(JwtHelperService.GIVEN_NAME);
        const email = this.jwtHelperService.getValueFromLocalAccessToken(JwtHelperService.USER_EMAIL);
        const username = this.jwtHelperService.getValueFromLocalAccessToken(JwtHelperService.USER_PREFERRED_USERNAME);
        return { firstName: givenName, lastName: familyName, email: email, username: username };
    }
    findUsersByName(search) {
        if (search === '') {
            return of([]);
        }
        const url = this.buildUserUrl();
        const queryParams = { search: search };
        return this.oAuth2Service.get({ url, queryParams });
    }
    findUserByUsername(username) {
        if (username === '') {
            return of([]);
        }
        const url = this.buildUserUrl();
        const queryParams = { username: username };
        return this.oAuth2Service.get({ url, queryParams });
    }
    findUserByEmail(email) {
        if (email === '') {
            return of([]);
        }
        const url = this.buildUserUrl();
        const queryParams = { email: email };
        return this.oAuth2Service.get({ url, queryParams });
    }
    findUserById(id) {
        if (id === '') {
            return of([]);
        }
        const url = this.buildUserUrl() + '/' + id;
        return this.oAuth2Service.get({ url });
    }
    getClientRoles(userId, clientId) {
        const url = `${this.identityHost}/users/${userId}/role-mappings/clients/${clientId}/composite`;
        return this.oAuth2Service.get({ url });
    }
    checkUserHasClientApp(userId, clientId) {
        return this.getClientRoles(userId, clientId).pipe(map((clientRoles) => clientRoles.length > 0));
    }
    checkUserHasAnyClientAppRole(userId, clientId, roleNames) {
        return this.getClientRoles(userId, clientId).pipe(map((clientRoles) => {
            let hasRole = false;
            if (clientRoles.length > 0) {
                roleNames.forEach((roleName) => {
                    const role = clientRoles.find(({ name }) => name === roleName);
                    if (role) {
                        hasRole = true;
                        return;
                    }
                });
            }
            return hasRole;
        }));
    }
    getClientIdByApplicationName(applicationName) {
        const url = `${this.identityHost}/clients`;
        const queryParams = { clientId: applicationName };
        return this.oAuth2Service
            .get({ url, queryParams })
            .pipe(map((response) => response && response.length > 0 ? response[0].id : ''));
    }
    checkUserHasApplicationAccess(userId, applicationName) {
        return this.getClientIdByApplicationName(applicationName).pipe(switchMap((clientId) => {
            return this.checkUserHasClientApp(userId, clientId);
        }));
    }
    checkUserHasAnyApplicationRole(userId, applicationName, roleNames) {
        return this.getClientIdByApplicationName(applicationName).pipe(switchMap((clientId) => {
            return this.checkUserHasAnyClientAppRole(userId, clientId, roleNames);
        }));
    }
    getUsers() {
        const url = this.buildUserUrl();
        return this.oAuth2Service.get({ url });
    }
    getUserRoles(userId) {
        const url = `${this.identityHost}/users/${userId}/role-mappings/realm/composite`;
        return this.oAuth2Service.get({ url });
    }
    getUsersByRolesWithCurrentUser(roleNames) {
        return __awaiter(this, void 0, void 0, function* () {
            const filteredUsers = [];
            if (roleNames && roleNames.length > 0) {
                const users = yield this.getUsers().toPromise();
                for (let i = 0; i < users.length; i++) {
                    const hasAnyRole = yield this.userHasAnyRole(users[i].id, roleNames);
                    if (hasAnyRole) {
                        filteredUsers.push(users[i]);
                    }
                }
            }
            return filteredUsers;
        });
    }
    getUsersByRolesWithoutCurrentUser(roleNames) {
        return __awaiter(this, void 0, void 0, function* () {
            const filteredUsers = [];
            if (roleNames && roleNames.length > 0) {
                const currentUser = this.getCurrentUserInfo();
                let users = yield this.getUsers().toPromise();
                users = users.filter(({ username }) => username !== currentUser.username);
                for (let i = 0; i < users.length; i++) {
                    const hasAnyRole = yield this.userHasAnyRole(users[i].id, roleNames);
                    if (hasAnyRole) {
                        filteredUsers.push(users[i]);
                    }
                }
            }
            return filteredUsers;
        });
    }
    userHasAnyRole(userId, roleNames) {
        return __awaiter(this, void 0, void 0, function* () {
            const userRoles = yield this.getUserRoles(userId).toPromise();
            const hasAnyRole = roleNames.some((roleName) => {
                const filteredRoles = userRoles.filter((userRole) => {
                    return userRole.name.toLocaleLowerCase() === roleName.toLocaleLowerCase();
                });
                return filteredRoles.length > 0;
            });
            return hasAnyRole;
        });
    }
    checkUserHasRole(userId, roleNames) {
        return this.getUserRoles(userId).pipe(map((userRoles) => {
            let hasRole = false;
            if (userRoles && userRoles.length > 0) {
                roleNames.forEach((roleName) => {
                    const role = userRoles.find(({ name }) => roleName === name);
                    if (role) {
                        hasRole = true;
                        return;
                    }
                });
            }
            return hasRole;
        }));
    }
    queryUsers(requestQuery) {
        const url = this.buildUserUrl();
        const queryParams = { first: requestQuery.first, max: requestQuery.max };
        return this.getTotalUsersCount().pipe(switchMap((totalCount) => this.oAuth2Service.get({ url, queryParams }).pipe(map((response) => {
            return {
                entries: response,
                pagination: {
                    skipCount: requestQuery.first,
                    maxItems: requestQuery.max,
                    count: totalCount,
                    hasMoreItems: false,
                    totalItems: totalCount
                }
            };
        }))));
    }
    getTotalUsersCount() {
        const url = this.buildUserUrl() + `/count`;
        return this.oAuth2Service.get({ url });
    }
    createUser(newUser) {
        const url = this.buildUserUrl();
        const bodyParam = JSON.stringify(newUser);
        return this.oAuth2Service.post({ url, bodyParam });
    }
    updateUser(userId, updatedUser) {
        const url = this.buildUserUrl() + '/' + userId;
        const bodyParam = JSON.stringify(updatedUser);
        return this.oAuth2Service.put({ url, bodyParam });
    }
    deleteUser(userId) {
        const url = this.buildUserUrl() + '/' + userId;
        return this.oAuth2Service.delete({ url });
    }
    changePassword(userId, newPassword) {
        const url = this.buildUserUrl() + '/' + userId + '/reset-password';
        const bodyParam = JSON.stringify(newPassword);
        return this.oAuth2Service.put({ url, bodyParam });
    }
    getInvolvedGroups(userId) {
        const url = this.buildUserUrl() + '/' + userId + '/groups/';
        const pathParams = { id: userId };
        return this.oAuth2Service.get({ url, pathParams });
    }
    joinGroup(joinGroupRequest) {
        const url = this.buildUserUrl() + '/' + joinGroupRequest.userId + '/groups/' + joinGroupRequest.groupId;
        const bodyParam = JSON.stringify(joinGroupRequest);
        return this.oAuth2Service.put({ url, bodyParam });
    }
    leaveGroup(userId, groupId) {
        const url = this.buildUserUrl() + '/' + userId + '/groups/' + groupId;
        return this.oAuth2Service.delete({ url });
    }
    getAvailableRoles(userId) {
        const url = this.buildUserUrl() + '/' + userId + '/role-mappings/realm/available';
        return this.oAuth2Service.get({ url });
    }
    getAssignedRoles(userId) {
        const url = this.buildUserUrl() + '/' + userId + '/role-mappings/realm';
        const pathParams = { id: userId };
        return this.oAuth2Service.get({ url, pathParams });
    }
    getEffectiveRoles(userId) {
        const url = this.buildUserUrl() + '/' + userId + '/role-mappings/realm/composite';
        const pathParams = { id: userId };
        return this.oAuth2Service.get({ url, pathParams });
    }
    assignRoles(userId, roles) {
        const url = this.buildUserUrl() + '/' + userId + '/role-mappings/realm';
        const bodyParam = JSON.stringify(roles);
        return this.oAuth2Service.post({ url, bodyParam });
    }
    removeRoles(userId, removedRoles) {
        const url = this.buildUserUrl() + '/' + userId + '/role-mappings/realm';
        const bodyParam = JSON.stringify(removedRoles);
        return this.oAuth2Service.delete({ url, bodyParam });
    }
}
IdentityUserService.ɵprov = i0.ɵɵdefineInjectable({ factory: function IdentityUserService_Factory() { return new IdentityUserService(i0.ɵɵinject(i1.JwtHelperService), i0.ɵɵinject(i2.OAuth2Service), i0.ɵɵinject(i3.AppConfigService)); }, token: IdentityUserService, providedIn: "root" });
IdentityUserService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
IdentityUserService.ctorParameters = () => [
    { type: JwtHelperService },
    { type: OAuth2Service },
    { type: AppConfigService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlbnRpdHktdXNlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvY29yZS8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL2lkZW50aXR5LXVzZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0QyxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBS3BFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQzs7Ozs7QUFLakQsTUFBTSxPQUFPLG1CQUFtQjtJQUU1QixZQUNZLGdCQUFrQyxFQUNsQyxhQUE0QixFQUM1QixnQkFBa0M7UUFGbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO0lBQUksQ0FBQztJQUVuRCxJQUFZLFlBQVk7UUFDcEIsT0FBTyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQztJQUMxRCxDQUFDO0lBRU8sWUFBWTtRQUNoQixPQUFPLEdBQUcsSUFBSSxDQUFDLFlBQVksUUFBUSxDQUFDO0lBQ3hDLENBQUM7SUFNRCxrQkFBa0I7UUFDZCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsNEJBQTRCLENBQVMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDNUcsTUFBTSxTQUFT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QWdCIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQXBwQ29uZmlnU2VydmljZSB9IGZyb20gJy4uL2FwcC1jb25maWcvYXBwLWNvbmZpZy5zZXJ2aWNlJztcbmltcG9ydCB7IElkZW50aXR5R3JvdXBNb2RlbCB9IGZyb20gJy4uL21vZGVscy9pZGVudGl0eS1ncm91cC5tb2RlbCc7XG5pbXBvcnQgeyBJZGVudGl0eVJvbGVNb2RlbCB9IGZyb20gJy4uL21vZGVscy9pZGVudGl0eS1yb2xlLm1vZGVsJztcbmltcG9ydCB7IElkZW50aXR5VXNlck1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL2lkZW50aXR5LXVzZXIubW9kZWwnO1xuaW1wb3J0IHsgSWRlbnRpdHlKb2luR3JvdXBSZXF1ZXN0TW9kZWwsIElkZW50aXR5VXNlclNlcnZpY2VJbnRlcmZhY2UsIElkZW50aXR5VXNlclBhc3N3b3JkTW9kZWwsIElkZW50aXR5VXNlclF1ZXJ5Q2xvdWRSZXF1ZXN0TW9kZWwsIElkZW50aXR5VXNlclF1ZXJ5UmVzcG9uc2UgfSBmcm9tICcuL2lkZW50aXR5LXVzZXIuc2VydmljZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSnd0SGVscGVyU2VydmljZSB9IGZyb20gJy4vand0LWhlbHBlci5zZXJ2aWNlJztcbmltcG9ydCB7IE9BdXRoMlNlcnZpY2UgfSBmcm9tICcuL29hdXRoMi5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBJZGVudGl0eVVzZXJTZXJ2aWNlIGltcGxlbWVudHMgSWRlbnRpdHlVc2VyU2VydmljZUludGVyZmFjZSB7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBqd3RIZWxwZXJTZXJ2aWNlOiBKd3RIZWxwZXJTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIG9BdXRoMlNlcnZpY2U6IE9BdXRoMlNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgYXBwQ29uZmlnU2VydmljZTogQXBwQ29uZmlnU2VydmljZSkgeyB9XG5cbiAgICBwcml2YXRlIGdldCBpZGVudGl0eUhvc3QoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGAke3RoaXMuYXBwQ29uZmlnU2VydmljZS5nZXQoJ2lkZW50aXR5SG9zdCcpfWA7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBidWlsZFVzZXJVcmwoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGAke3RoaXMuaWRlbnRpdHlIb3N0fS91c2Vyc2A7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgbmFtZSBhbmQgb3RoZXIgYmFzaWMgZGV0YWlscyBvZiB0aGUgY3VycmVudCB1c2VyLlxuICAgICAqIEByZXR1cm5zIFRoZSB1c2VyJ3MgZGV0YWlsc1xuICAgICAqL1xuICAgIGdldEN1cnJlbnRVc2VySW5mbygpOiBJZGVudGl0eVVzZXJNb2RlbCB7XG4gICAgICAgIGNvbnN0IGZhbWlseU5hbWUgPSB0aGlzLmp3dEhlbHBlclNlcnZpY2UuZ2V0VmFsdWVGcm9tTG9jYWxBY2Nlc3NUb2tlbjxzdHJpbmc+KEp3dEhlbHBlclNlcnZpY2UuRkFNSUxZX05BTUUpO1xuICAgICAgICBjb25zdCBnaXZlbk5hbWUgPSB0aGlzLmp3dEhlbHBlclNlcnZpY2UuZ2V0VmFsdWVGcm9tTG9jYWxBY2Nlc3NUb2tlbjxzdHJpbmc+KEp3dEhlbHBlclNlcnZpY2UuR0lWRU5fTkFNRSk7XG4gICAgICAgIGNvbnN0IGVtYWlsID0gdGhpcy5qd3RIZWxwZXJTZXJ2aWNlLmdldFZhbHVlRnJvbUxvY2FsQWNjZXNzVG9rZW48c3RyaW5nPihKd3RIZWxwZXJTZXJ2aWNlLlVTRVJfRU1BSUwpO1xuICAgICAgICBjb25zdCB1c2VybmFtZSA9IHRoaXMuand0SGVscGVyU2VydmljZS5nZXRWYWx1ZUZyb21Mb2NhbEFjY2Vzc1Rva2VuPHN0cmluZz4oSnd0SGVscGVyU2VydmljZS5VU0VSX1BSRUZFUlJFRF9VU0VSTkFNRSk7XG4gICAgICAgIHJldHVybiB7IGZpcnN0TmFtZTogZ2l2ZW5OYW1lLCBsYXN0TmFtZTogZmFtaWx5TmFtZSwgZW1haWw6IGVtYWlsLCB1c2VybmFtZTogdXNlcm5hbWUgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kIHVzZXJzIGJhc2VkIG9uIHNlYXJjaCBpbnB1dC5cbiAgICAgKiBAcGFyYW0gc2VhcmNoIFNlYXJjaCBxdWVyeSBzdHJpbmdcbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIHVzZXJzXG4gICAgICovXG4gICAgZmluZFVzZXJzQnlOYW1lKHNlYXJjaDogc3RyaW5nKTogT2JzZXJ2YWJsZTxJZGVudGl0eVVzZXJNb2RlbFtdPiB7XG4gICAgICAgIGlmIChzZWFyY2ggPT09ICcnKSB7XG4gICAgICAgICAgICByZXR1cm4gb2YoW10pO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHVybCA9IHRoaXMuYnVpbGRVc2VyVXJsKCk7XG4gICAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1zID0geyBzZWFyY2g6IHNlYXJjaCB9O1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UuZ2V0KHsgdXJsLCBxdWVyeVBhcmFtcyB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kIHVzZXJzIGJhc2VkIG9uIHVzZXJuYW1lIGlucHV0LlxuICAgICAqIEBwYXJhbSB1c2VybmFtZSBTZWFyY2ggcXVlcnkgc3RyaW5nXG4gICAgICogQHJldHVybnMgTGlzdCBvZiB1c2Vyc1xuICAgICAqL1xuICAgIGZpbmRVc2VyQnlVc2VybmFtZSh1c2VybmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxJZGVudGl0eVVzZXJNb2RlbFtdPiB7XG4gICAgICAgIGlmICh1c2VybmFtZSA9PT0gJycpIHtcbiAgICAgICAgICAgIHJldHVybiBvZihbXSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdXJsID0gdGhpcy5idWlsZFVzZXJVcmwoKTtcbiAgICAgICAgY29uc3QgcXVlcnlQYXJhbXMgPSB7IHVzZXJuYW1lOiB1c2VybmFtZSB9O1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UuZ2V0KHt1cmwsIHF1ZXJ5UGFyYW1zIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZpbmQgdXNlcnMgYmFzZWQgb24gZW1haWwgaW5wdXQuXG4gICAgICogQHBhcmFtIGVtYWlsIFNlYXJjaCBxdWVyeSBzdHJpbmdcbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIHVzZXJzXG4gICAgICovXG4gICAgZmluZFVzZXJCeUVtYWlsKGVtYWlsOiBzdHJpbmcpOiBPYnNlcnZhYmxlPElkZW50aXR5VXNlck1vZGVsW10+IHtcbiAgICAgICAgaWYgKGVtYWlsID09PSAnJykge1xuICAgICAgICAgICAgcmV0dXJuIG9mKFtdKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB1cmwgPSB0aGlzLmJ1aWxkVXNlclVybCgpO1xuICAgICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IHsgZW1haWw6IGVtYWlsIH07XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5nZXQoeyB1cmwsIHF1ZXJ5UGFyYW1zIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZpbmQgdXNlcnMgYmFzZWQgb24gaWQgaW5wdXQuXG4gICAgICogQHBhcmFtIGlkIFNlYXJjaCBxdWVyeSBzdHJpbmdcbiAgICAgKiBAcmV0dXJucyB1c2VycyBvYmplY3RcbiAgICAgKi9cbiAgICBmaW5kVXNlckJ5SWQoaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGlmIChpZCA9PT0gJycpIHtcbiAgICAgICAgICAgIHJldHVybiBvZihbXSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdXJsID0gdGhpcy5idWlsZFVzZXJVcmwoKSArICcvJyArIGlkO1xuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLmdldCh7IHVybCB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgY2xpZW50IHJvbGVzIG9mIGEgdXNlciBmb3IgYSBwYXJ0aWN1bGFyIGNsaWVudC5cbiAgICAgKiBAcGFyYW0gdXNlcklkIElEIG9mIHRoZSB0YXJnZXQgdXNlclxuICAgICAqIEBwYXJhbSBjbGllbnRJZCBJRCBvZiB0aGUgY2xpZW50IGFwcFxuICAgICAqIEByZXR1cm5zIExpc3Qgb2YgY2xpZW50IHJvbGVzXG4gICAgICovXG4gICAgZ2V0Q2xpZW50Um9sZXModXNlcklkOiBzdHJpbmcsIGNsaWVudElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueVtdPiB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke3RoaXMuaWRlbnRpdHlIb3N0fS91c2Vycy8ke3VzZXJJZH0vcm9sZS1tYXBwaW5ncy9jbGllbnRzLyR7Y2xpZW50SWR9L2NvbXBvc2l0ZWA7XG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UuZ2V0KHsgdXJsIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyB3aGV0aGVyIHVzZXIgaGFzIGFjY2VzcyB0byBhIGNsaWVudCBhcHAuXG4gICAgICogQHBhcmFtIHVzZXJJZCBJRCBvZiB0aGUgdGFyZ2V0IHVzZXJcbiAgICAgKiBAcGFyYW0gY2xpZW50SWQgSUQgb2YgdGhlIGNsaWVudCBhcHBcbiAgICAgKiBAcmV0dXJucyBUcnVlIGlmIHRoZSB1c2VyIGhhcyBhY2Nlc3MsIGZhbHNlIG90aGVyd2lzZVxuICAgICAqL1xuICAgIGNoZWNrVXNlckhhc0NsaWVudEFwcCh1c2VySWQ6IHN0cmluZywgY2xpZW50SWQ6IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRDbGllbnRSb2xlcyh1c2VySWQsIGNsaWVudElkKS5waXBlKFxuICAgICAgICAgICAgbWFwKChjbGllbnRSb2xlcykgPT4gY2xpZW50Um9sZXMubGVuZ3RoID4gMClcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3Mgd2hldGhlciBhIHVzZXIgaGFzIGFueSBvZiB0aGUgY2xpZW50IGFwcCByb2xlcy5cbiAgICAgKiBAcGFyYW0gdXNlcklkIElEIG9mIHRoZSB0YXJnZXQgdXNlclxuICAgICAqIEBwYXJhbSBjbGllbnRJZCBJRCBvZiB0aGUgY2xpZW50IGFwcFxuICAgICAqIEBwYXJhbSByb2xlTmFtZXMgTGlzdCBvZiByb2xlIG5hbWVzIHRvIGNoZWNrIGZvclxuICAgICAqIEByZXR1cm5zIFRydWUgaWYgdGhlIHVzZXIgaGFzIG9uZSBvciBtb3JlIG9mIHRoZSByb2xlcywgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgY2hlY2tVc2VySGFzQW55Q2xpZW50QXBwUm9sZSh1c2VySWQ6IHN0cmluZywgY2xpZW50SWQ6IHN0cmluZywgcm9sZU5hbWVzOiBzdHJpbmdbXSk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRDbGllbnRSb2xlcyh1c2VySWQsIGNsaWVudElkKS5waXBlKFxuICAgICAgICAgICAgbWFwKChjbGllbnRSb2xlczogYW55W10pID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgaGFzUm9sZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChjbGllbnRSb2xlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJvbGVOYW1lcy5mb3JFYWNoKChyb2xlTmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm9sZSA9IGNsaWVudFJvbGVzLmZpbmQoKHsgbmFtZSB9KSA9PiBuYW1lID09PSByb2xlTmFtZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyb2xlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzUm9sZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGhhc1JvbGU7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIGNsaWVudCBJRCBmb3IgYW4gYXBwbGljYXRpb24uXG4gICAgICogQHBhcmFtIGFwcGxpY2F0aW9uTmFtZSBOYW1lIG9mIHRoZSBhcHBsaWNhdGlvblxuICAgICAqIEByZXR1cm5zIENsaWVudCBJRCBzdHJpbmdcbiAgICAgKi9cbiAgICBnZXRDbGllbnRJZEJ5QXBwbGljYXRpb25OYW1lKGFwcGxpY2F0aW9uTmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5pZGVudGl0eUhvc3R9L2NsaWVudHNgO1xuICAgICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IHsgY2xpZW50SWQ6IGFwcGxpY2F0aW9uTmFtZSB9O1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2VcbiAgICAgICAgICAgIC5nZXQ8YW55W10+KHt1cmwsIHF1ZXJ5UGFyYW1zIH0pXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlc3BvbnNlKSA9PiByZXNwb25zZSAmJiByZXNwb25zZS5sZW5ndGggPiAwID8gcmVzcG9uc2VbMF0uaWQgOiAnJylcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIGEgdXNlciBoYXMgYWNjZXNzIHRvIGFuIGFwcGxpY2F0aW9uLlxuICAgICAqIEBwYXJhbSB1c2VySWQgSUQgb2YgdGhlIHVzZXJcbiAgICAgKiBAcGFyYW0gYXBwbGljYXRpb25OYW1lIE5hbWUgb2YgdGhlIGFwcGxpY2F0aW9uXG4gICAgICogQHJldHVybnMgVHJ1ZSBpZiB0aGUgdXNlciBoYXMgYWNjZXNzLCBmYWxzZSBvdGhlcndpc2VcbiAgICAgKi9cbiAgICBjaGVja1VzZXJIYXNBcHBsaWNhdGlvbkFjY2Vzcyh1c2VySWQ6IHN0cmluZywgYXBwbGljYXRpb25OYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q2xpZW50SWRCeUFwcGxpY2F0aW9uTmFtZShhcHBsaWNhdGlvbk5hbWUpLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKGNsaWVudElkOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGVja1VzZXJIYXNDbGllbnRBcHAodXNlcklkLCBjbGllbnRJZCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBpZiBhIHVzZXIgaGFzIGFueSBhcHBsaWNhdGlvbiByb2xlLlxuICAgICAqIEBwYXJhbSB1c2VySWQgSUQgb2YgdGhlIHRhcmdldCB1c2VyXG4gICAgICogQHBhcmFtIGFwcGxpY2F0aW9uTmFtZSBOYW1lIG9mIHRoZSBhcHBsaWNhdGlvblxuICAgICAqIEBwYXJhbSByb2xlTmFtZXMgTGlzdCBvZiByb2xlIG5hbWVzIHRvIGNoZWNrIGZvclxuICAgICAqIEByZXR1cm5zIFRydWUgaWYgdGhlIHVzZXIgaGFzIG9uZSBvciBtb3JlIG9mIHRoZSByb2xlcywgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgY2hlY2tVc2VySGFzQW55QXBwbGljYXRpb25Sb2xlKHVzZXJJZDogc3RyaW5nLCBhcHBsaWNhdGlvbk5hbWU6IHN0cmluZywgcm9sZU5hbWVzOiBzdHJpbmdbXSk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRDbGllbnRJZEJ5QXBwbGljYXRpb25OYW1lKGFwcGxpY2F0aW9uTmFtZSkucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoY2xpZW50SWQ6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNoZWNrVXNlckhhc0FueUNsaWVudEFwcFJvbGUodXNlcklkLCBjbGllbnRJZCwgcm9sZU5hbWVzKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBkZXRhaWxzIGZvciBhbGwgdXNlcnMuXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgdXNlciBpbmZvIG9iamVjdHNcbiAgICAgKi9cbiAgICBnZXRVc2VycygpOiBPYnNlcnZhYmxlPElkZW50aXR5VXNlck1vZGVsW10+IHtcbiAgICAgICAgY29uc3QgdXJsID0gdGhpcy5idWlsZFVzZXJVcmwoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5nZXQoeyB1cmwgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhIGxpc3Qgb2Ygcm9sZXMgZm9yIGEgdXNlci5cbiAgICAgKiBAcGFyYW0gdXNlcklkIElEIG9mIHRoZSB1c2VyXG4gICAgICogQHJldHVybnMgQXJyYXkgb2Ygcm9sZSBpbmZvIG9iamVjdHNcbiAgICAgKi9cbiAgICBnZXRVc2VyUm9sZXModXNlcklkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPElkZW50aXR5Um9sZU1vZGVsW10+IHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5pZGVudGl0eUhvc3R9L3VzZXJzLyR7dXNlcklkfS9yb2xlLW1hcHBpbmdzL3JlYWxtL2NvbXBvc2l0ZWA7XG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UuZ2V0KHsgdXJsIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYW4gYXJyYXkgb2YgdXNlcnMgKGluY2x1ZGluZyB0aGUgY3VycmVudCB1c2VyKSB3aG8gaGF2ZSBhbnkgb2YgdGhlIHJvbGVzIGluIHRoZSBzdXBwbGllZCBsaXN0LlxuICAgICAqIEBwYXJhbSByb2xlTmFtZXMgTGlzdCBvZiByb2xlIG5hbWVzIHRvIGxvb2sgZm9yXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgdXNlciBpbmZvIG9iamVjdHNcbiAgICAgKi9cbiAgICBhc3luYyBnZXRVc2Vyc0J5Um9sZXNXaXRoQ3VycmVudFVzZXIocm9sZU5hbWVzOiBzdHJpbmdbXSk6IFByb21pc2U8SWRlbnRpdHlVc2VyTW9kZWxbXT4ge1xuICAgICAgICBjb25zdCBmaWx0ZXJlZFVzZXJzOiBJZGVudGl0eVVzZXJNb2RlbFtdID0gW107XG4gICAgICAgIGlmIChyb2xlTmFtZXMgJiYgcm9sZU5hbWVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHVzZXJzID0gYXdhaXQgdGhpcy5nZXRVc2VycygpLnRvUHJvbWlzZSgpO1xuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHVzZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaGFzQW55Um9sZSA9IGF3YWl0IHRoaXMudXNlckhhc0FueVJvbGUodXNlcnNbaV0uaWQsIHJvbGVOYW1lcyk7XG4gICAgICAgICAgICAgICAgaWYgKGhhc0FueVJvbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWRVc2Vycy5wdXNoKHVzZXJzW2ldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZmlsdGVyZWRVc2VycztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGFuIGFycmF5IG9mIHVzZXJzIChub3QgaW5jbHVkaW5nIHRoZSBjdXJyZW50IHVzZXIpIHdobyBoYXZlIGFueSBvZiB0aGUgcm9sZXMgaW4gdGhlIHN1cHBsaWVkIGxpc3QuXG4gICAgICogQHBhcmFtIHJvbGVOYW1lcyBMaXN0IG9mIHJvbGUgbmFtZXMgdG8gbG9vayBmb3JcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiB1c2VyIGluZm8gb2JqZWN0c1xuICAgICAqL1xuICAgIGFzeW5jIGdldFVzZXJzQnlSb2xlc1dpdGhvdXRDdXJyZW50VXNlcihyb2xlTmFtZXM6IHN0cmluZ1tdKTogUHJvbWlzZTxJZGVudGl0eVVzZXJNb2RlbFtdPiB7XG4gICAgICAgIGNvbnN0IGZpbHRlcmVkVXNlcnM6IElkZW50aXR5VXNlck1vZGVsW10gPSBbXTtcbiAgICAgICAgaWYgKHJvbGVOYW1lcyAmJiByb2xlTmFtZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3QgY3VycmVudFVzZXIgPSB0aGlzLmdldEN1cnJlbnRVc2VySW5mbygpO1xuICAgICAgICAgICAgbGV0IHVzZXJzID0gYXdhaXQgdGhpcy5nZXRVc2VycygpLnRvUHJvbWlzZSgpO1xuXG4gICAgICAgICAgICB1c2VycyA9IHVzZXJzLmZpbHRlcigoeyB1c2VybmFtZSB9KSA9PiB1c2VybmFtZSAhPT0gY3VycmVudFVzZXIudXNlcm5hbWUpO1xuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHVzZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaGFzQW55Um9sZSA9IGF3YWl0IHRoaXMudXNlckhhc0FueVJvbGUodXNlcnNbaV0uaWQsIHJvbGVOYW1lcyk7XG4gICAgICAgICAgICAgICAgaWYgKGhhc0FueVJvbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWRVc2Vycy5wdXNoKHVzZXJzW2ldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZmlsdGVyZWRVc2VycztcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIHVzZXJIYXNBbnlSb2xlKHVzZXJJZDogc3RyaW5nLCByb2xlTmFtZXM6IHN0cmluZ1tdKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGNvbnN0IHVzZXJSb2xlcyA9IGF3YWl0IHRoaXMuZ2V0VXNlclJvbGVzKHVzZXJJZCkudG9Qcm9taXNlKCk7XG4gICAgICAgIGNvbnN0IGhhc0FueVJvbGUgPSByb2xlTmFtZXMuc29tZSgocm9sZU5hbWUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGZpbHRlcmVkUm9sZXMgPSB1c2VyUm9sZXMuZmlsdGVyKCh1c2VyUm9sZSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB1c2VyUm9sZS5uYW1lLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09IHJvbGVOYW1lLnRvTG9jYWxlTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcmV0dXJuIGZpbHRlcmVkUm9sZXMubGVuZ3RoID4gMDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGhhc0FueVJvbGU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIGEgdXNlciBoYXMgb25lIG9mIHRoZSByb2xlcyBmcm9tIGEgbGlzdC5cbiAgICAgKiBAcGFyYW0gdXNlcklkIElEIG9mIHRoZSB0YXJnZXQgdXNlclxuICAgICAqIEBwYXJhbSByb2xlTmFtZXMgQXJyYXkgb2Ygcm9sZXMgdG8gY2hlY2sgZm9yXG4gICAgICogQHJldHVybnMgVHJ1ZSBpZiB0aGUgdXNlciBoYXMgb25lIG9mIHRoZSByb2xlcywgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgY2hlY2tVc2VySGFzUm9sZSh1c2VySWQ6IHN0cmluZywgcm9sZU5hbWVzOiBzdHJpbmdbXSk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRVc2VyUm9sZXModXNlcklkKS5waXBlKG1hcCgodXNlclJvbGVzOiBJZGVudGl0eVJvbGVNb2RlbFtdKSA9PiB7XG4gICAgICAgICAgICBsZXQgaGFzUm9sZSA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHVzZXJSb2xlcyAmJiB1c2VyUm9sZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHJvbGVOYW1lcy5mb3JFYWNoKChyb2xlTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJvbGUgPSB1c2VyUm9sZXMuZmluZCgoeyBuYW1lIH0pID0+IHJvbGVOYW1lID09PSBuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJvbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhc1JvbGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gaGFzUm9sZTtcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgZGV0YWlscyBmb3IgYWxsIHVzZXJzLlxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIHVzZXIgaW5mb3JtYXRpb24gb2JqZWN0cy5cbiAgICAgKi9cbiAgICBxdWVyeVVzZXJzKHJlcXVlc3RRdWVyeTogSWRlbnRpdHlVc2VyUXVlcnlDbG91ZFJlcXVlc3RNb2RlbCk6IE9ic2VydmFibGU8SWRlbnRpdHlVc2VyUXVlcnlSZXNwb25zZT4ge1xuICAgICAgICBjb25zdCB1cmwgPSB0aGlzLmJ1aWxkVXNlclVybCgpO1xuICAgICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IHsgZmlyc3Q6IHJlcXVlc3RRdWVyeS5maXJzdCwgbWF4OiByZXF1ZXN0UXVlcnkubWF4IH07XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VG90YWxVc2Vyc0NvdW50KCkucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgodG90YWxDb3VudCkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLm9BdXRoMlNlcnZpY2UuZ2V0PElkZW50aXR5VXNlck1vZGVsW10+KHsgdXJsLCBxdWVyeVBhcmFtcyB9KS5waXBlKFxuICAgICAgICAgICAgICAgICAgICBtYXAoKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gPElkZW50aXR5VXNlclF1ZXJ5UmVzcG9uc2U+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyaWVzOiByZXNwb25zZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lwQ291bnQ6IHJlcXVlc3RRdWVyeS5maXJzdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heEl0ZW1zOiByZXF1ZXN0UXVlcnkubWF4LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnQ6IHRvdGFsQ291bnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNNb3JlSXRlbXM6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxJdGVtczogdG90YWxDb3VudFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdXNlcnMgdG90YWwgY291bnQuXG4gICAgICogQHJldHVybnMgTnVtYmVyIG9mIHVzZXJzIGNvdW50LlxuICAgICAqL1xuICAgIGdldFRvdGFsVXNlcnNDb3VudCgpOiBPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgICAgICBjb25zdCB1cmwgPSB0aGlzLmJ1aWxkVXNlclVybCgpICsgYC9jb3VudGA7XG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UuZ2V0KHsgdXJsIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgbmV3IHVzZXIuXG4gICAgICogQHBhcmFtIG5ld1VzZXIgT2JqZWN0IGNvbnRhaW5pbmcgdGhlIG5ldyB1c2VyIGRldGFpbHMuXG4gICAgICogQHJldHVybnMgRW1wdHkgcmVzcG9uc2Ugd2hlbiB0aGUgdXNlciBjcmVhdGVkLlxuICAgICAqL1xuICAgIGNyZWF0ZVVzZXIobmV3VXNlcjogSWRlbnRpdHlVc2VyTW9kZWwpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCB1cmwgPSB0aGlzLmJ1aWxkVXNlclVybCgpO1xuICAgICAgICBjb25zdCBib2R5UGFyYW0gPSBKU09OLnN0cmluZ2lmeShuZXdVc2VyKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLnBvc3QoeyB1cmwsIGJvZHlQYXJhbSB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHVzZXIgZGV0YWlscy5cbiAgICAgKiBAcGFyYW0gdXNlcklkIElkIG9mIHRoZSB1c2VyLlxuICAgICAqIEBwYXJhbSB1cGRhdGVkVXNlciBPYmplY3QgY29udGFpbmluZyB0aGUgdXNlciBkZXRhaWxzLlxuICAgICAqIEByZXR1cm5zIEVtcHR5IHJlc3BvbnNlIHdoZW4gdGhlIHVzZXIgdXBkYXRlZC5cbiAgICAgKi9cbiAgICB1cGRhdGVVc2VyKHVzZXJJZDogc3RyaW5nLCB1cGRhdGVkVXNlcjogSWRlbnRpdHlVc2VyTW9kZWwpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCB1cmwgPSB0aGlzLmJ1aWxkVXNlclVybCgpICsgJy8nICsgdXNlcklkO1xuICAgICAgICBjb25zdCBib2R5UGFyYW0gPSBKU09OLnN0cmluZ2lmeSh1cGRhdGVkVXNlcik7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5wdXQoeyB1cmwsIGJvZHlQYXJhbSB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZWxldGVzIFVzZXIuXG4gICAgICogQHBhcmFtIHVzZXJJZCBJZCBvZiB0aGUgIHVzZXIuXG4gICAgICogQHJldHVybnMgRW1wdHkgcmVzcG9uc2Ugd2hlbiB0aGUgdXNlciBkZWxldGVkLlxuICAgICAqL1xuICAgIGRlbGV0ZVVzZXIodXNlcklkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCB1cmwgPSB0aGlzLmJ1aWxkVXNlclVybCgpICsgJy8nICsgdXNlcklkO1xuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLmRlbGV0ZSh7IHVybCB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGFuZ2VzIHVzZXIgcGFzc3dvcmQuXG4gICAgICogQHBhcmFtIHVzZXJJZCBJZCBvZiB0aGUgdXNlci5cbiAgICAgKiBAcGFyYW0gY3JlZGVudGlhbHMgRGV0YWlscyBvZiB1c2VyIENyZWRlbnRpYWxzLlxuICAgICAqIEByZXR1cm5zIEVtcHR5IHJlc3BvbnNlIHdoZW4gdGhlIHBhc3N3b3JkIGNoYW5nZWQuXG4gICAgICovXG4gICAgY2hhbmdlUGFzc3dvcmQodXNlcklkOiBzdHJpbmcsIG5ld1Bhc3N3b3JkOiBJZGVudGl0eVVzZXJQYXNzd29yZE1vZGVsKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgY29uc3QgdXJsID0gdGhpcy5idWlsZFVzZXJVcmwoKSArICcvJyArIHVzZXJJZCArICcvcmVzZXQtcGFzc3dvcmQnO1xuICAgICAgICBjb25zdCBib2R5UGFyYW0gPSBKU09OLnN0cmluZ2lmeShuZXdQYXNzd29yZCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5wdXQoeyB1cmwsIGJvZHlQYXJhbSB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGludm9sdmVkIGdyb3Vwcy5cbiAgICAgKiBAcGFyYW0gdXNlcklkIElkIG9mIHRoZSB1c2VyLlxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIGludm9sdmVkIGdyb3VwcyBpbmZvcm1hdGlvbiBvYmplY3RzLlxuICAgICAqL1xuICAgIGdldEludm9sdmVkR3JvdXBzKHVzZXJJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxJZGVudGl0eUdyb3VwTW9kZWxbXT4ge1xuICAgICAgICBjb25zdCB1cmwgPSB0aGlzLmJ1aWxkVXNlclVybCgpICsgJy8nICsgdXNlcklkICsgJy9ncm91cHMvJztcbiAgICAgICAgY29uc3QgcGF0aFBhcmFtcyA9IHsgaWQ6IHVzZXJJZCB9O1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UuZ2V0KHsgdXJsLCBwYXRoUGFyYW1zIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEpvaW5zIGdyb3VwLlxuICAgICAqIEBwYXJhbSBqb2luR3JvdXBSZXF1ZXN0IERldGFpbHMgb2Ygam9pbiBncm91cCByZXF1ZXN0IChJZGVudGl0eUpvaW5Hcm91cFJlcXVlc3RNb2RlbCkuXG4gICAgICogQHJldHVybnMgRW1wdHkgcmVzcG9uc2Ugd2hlbiB0aGUgdXNlciBqb2luZWQgdGhlIGdyb3VwLlxuICAgICAqL1xuICAgIGpvaW5Hcm91cChqb2luR3JvdXBSZXF1ZXN0OiBJZGVudGl0eUpvaW5Hcm91cFJlcXVlc3RNb2RlbCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IHRoaXMuYnVpbGRVc2VyVXJsKCkgKyAnLycgKyBqb2luR3JvdXBSZXF1ZXN0LnVzZXJJZCArICcvZ3JvdXBzLycgKyBqb2luR3JvdXBSZXF1ZXN0Lmdyb3VwSWQ7XG4gICAgICAgIGNvbnN0IGJvZHlQYXJhbSA9IEpTT04uc3RyaW5naWZ5KGpvaW5Hcm91cFJlcXVlc3QpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UucHV0KHsgdXJsLCBib2R5UGFyYW0gfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTGVhdmVzIGdyb3VwLlxuICAgICAqIEBwYXJhbSB1c2VySWQgSWQgb2YgdGhlIHVzZXIuXG4gICAgICogQHBhcmFtIGdyb3VwSWQgSWQgb2YgdGhlICBncm91cC5cbiAgICAgKiBAcmV0dXJucyBFbXB0eSByZXNwb25zZSB3aGVuIHRoZSB1c2VyIGxlZnQgdGhlIGdyb3VwLlxuICAgICAqL1xuICAgIGxlYXZlR3JvdXAodXNlcklkOiBhbnksIGdyb3VwSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IHRoaXMuYnVpbGRVc2VyVXJsKCkgKyAnLycgKyB1c2VySWQgKyAnL2dyb3Vwcy8nICsgZ3JvdXBJZDtcbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5kZWxldGUoeyB1cmwgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhdmFpbGFibGUgcm9sZXNcbiAgICAgKiBAcGFyYW0gdXNlcklkIElkIG9mIHRoZSB1c2VyLlxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIGF2YWlsYWJsZSByb2xlcyBpbmZvcm1hdGlvbiBvYmplY3RzXG4gICAgICovXG4gICAgZ2V0QXZhaWxhYmxlUm9sZXModXNlcklkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPElkZW50aXR5Um9sZU1vZGVsW10+IHtcbiAgICAgICAgY29uc3QgdXJsID0gdGhpcy5idWlsZFVzZXJVcmwoKSArICcvJyArIHVzZXJJZCArICcvcm9sZS1tYXBwaW5ncy9yZWFsbS9hdmFpbGFibGUnO1xuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLmdldCh7IHVybCB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGFzc2lnbmVkIHJvbGVzLlxuICAgICAqIEBwYXJhbSB1c2VySWQgSWQgb2YgdGhlIHVzZXIuXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgYXNzaWduZWQgcm9sZXMgaW5mb3JtYXRpb24gb2JqZWN0c1xuICAgICAqL1xuICAgIGdldEFzc2lnbmVkUm9sZXModXNlcklkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPElkZW50aXR5Um9sZU1vZGVsW10+IHtcbiAgICAgICAgY29uc3QgdXJsID0gdGhpcy5idWlsZFVzZXJVcmwoKSArICcvJyArIHVzZXJJZCArICcvcm9sZS1tYXBwaW5ncy9yZWFsbSc7XG4gICAgICAgIGNvbnN0IHBhdGhQYXJhbXMgPSB7IGlkOiB1c2VySWQgfTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLmdldCh7IHVybCwgcGF0aFBhcmFtcyB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGVmZmVjdGl2ZSByb2xlcy5cbiAgICAgKiBAcGFyYW0gdXNlcklkIElkIG9mIHRoZSB1c2VyLlxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIGNvbXBvc2l0ZSByb2xlcyBpbmZvcm1hdGlvbiBvYmplY3RzXG4gICAgICovXG4gICAgZ2V0RWZmZWN0aXZlUm9sZXModXNlcklkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPElkZW50aXR5Um9sZU1vZGVsW10+IHtcbiAgICAgICAgY29uc3QgdXJsID0gdGhpcy5idWlsZFVzZXJVcmwoKSArICcvJyArIHVzZXJJZCArICcvcm9sZS1tYXBwaW5ncy9yZWFsbS9jb21wb3NpdGUnO1xuICAgICAgICBjb25zdCBwYXRoUGFyYW1zID0geyBpZDogdXNlcklkIH07XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5nZXQoeyB1cmwsIHBhdGhQYXJhbXMgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXNzaWducyByb2xlcyB0byB0aGUgdXNlci5cbiAgICAgKiBAcGFyYW0gdXNlcklkIElkIG9mIHRoZSB1c2VyLlxuICAgICAqIEBwYXJhbSByb2xlcyBBcnJheSBvZiByb2xlcy5cbiAgICAgKiBAcmV0dXJucyBFbXB0eSByZXNwb25zZSB3aGVuIHRoZSByb2xlIGFzc2lnbmVkLlxuICAgICAqL1xuICAgIGFzc2lnblJvbGVzKHVzZXJJZDogc3RyaW5nLCByb2xlczogSWRlbnRpdHlSb2xlTW9kZWxbXSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IHRoaXMuYnVpbGRVc2VyVXJsKCkgKyAnLycgKyB1c2VySWQgKyAnL3JvbGUtbWFwcGluZ3MvcmVhbG0nO1xuICAgICAgICBjb25zdCBib2R5UGFyYW0gPSBKU09OLnN0cmluZ2lmeShyb2xlcyk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5wb3N0KHsgdXJsLCBib2R5UGFyYW0gfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlcyBhc3NpZ25lZCByb2xlcy5cbiAgICAgKiBAcGFyYW0gdXNlcklkIElkIG9mIHRoZSB1c2VyLlxuICAgICAqIEBwYXJhbSByb2xlcyBBcnJheSBvZiByb2xlcy5cbiAgICAgKiBAcmV0dXJucyBFbXB0eSByZXNwb25zZSB3aGVuIHRoZSByb2xlIHJlbW92ZWQuXG4gICAgICovXG4gICAgcmVtb3ZlUm9sZXModXNlcklkOiBzdHJpbmcsIHJlbW92ZWRSb2xlczogSWRlbnRpdHlSb2xlTW9kZWxbXSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IHRoaXMuYnVpbGRVc2VyVXJsKCkgKyAnLycgKyB1c2VySWQgKyAnL3JvbGUtbWFwcGluZ3MvcmVhbG0nO1xuICAgICAgICBjb25zdCBib2R5UGFyYW0gPSBKU09OLnN0cmluZ2lmeShyZW1vdmVkUm9sZXMpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UuZGVsZXRlKHsgdXJsLCBib2R5UGFyYW0gfSk7XG4gICAgfVxufVxuIl19