import { Injectable } from '@angular/core';
import { of } from 'rxjs';
import { map, switchMap } from 'rxjs/operators';
import { AppConfigService } from '../app-config/app-config.service';
import { OAuth2Service } from './oauth2.service';
import * as i0 from "@angular/core";
import * as i1 from "./oauth2.service";
import * as i2 from "../app-config/app-config.service";
export class IdentityGroupService {
    constructor(oAuth2Service, appConfigService) {
        this.oAuth2Service = oAuth2Service;
        this.appConfigService = appConfigService;
    }
    get identityHost() {
        return `${this.appConfigService.get('identityHost')}`;
    }
    getGroups() {
        const url = `${this.identityHost}/groups`;
        return this.oAuth2Service.get({ url });
    }
    getAvailableRoles(groupId) {
        const url = `${this.identityHost}/groups/${groupId}/role-mappings/realm/available`;
        return this.oAuth2Service.get({ url });
    }
    getAssignedRoles(groupId) {
        const url = `${this.identityHost}/groups/${groupId}/role-mappings/realm`;
        return this.oAuth2Service.get({ url });
    }
    assignRoles(groupId, roles) {
        const url = `${this.identityHost}/groups/${groupId}/role-mappings/realm`;
        const bodyParam = JSON.stringify(roles);
        return this.oAuth2Service.post({ url, bodyParam });
    }
    removeRoles(groupId, roles) {
        const url = `${this.identityHost}/groups/${groupId}/role-mappings/realm`;
        const bodyParam = JSON.stringify(roles);
        return this.oAuth2Service.delete({ url, bodyParam });
    }
    getEffectiveRoles(groupId) {
        const url = `${this.identityHost}/groups/${groupId}/role-mappings/realm/composite`;
        return this.oAuth2Service.get({ url });
    }
    queryGroups(requestQuery) {
        const url = `${this.identityHost}/groups`;
        const queryParams = { first: requestQuery.first || 0, max: requestQuery.max || 5 };
        return this.getTotalGroupsCount().pipe(switchMap((totalCount) => this.oAuth2Service.get({ url, queryParams }).pipe(map((response) => {
            return {
                entries: response,
                pagination: {
                    skipCount: requestQuery.first,
                    maxItems: requestQuery.max,
                    count: totalCount.count,
                    hasMoreItems: false,
                    totalItems: totalCount.count
                }
            };
        }))));
    }
    getTotalGroupsCount() {
        const url = `${this.identityHost}/groups/count`;
        return this.oAuth2Service.get({ url });
    }
    createGroup(newGroup) {
        const url = `${this.identityHost}/groups`;
        const bodyParam = newGroup;
        return this.oAuth2Service.post({ url, bodyParam });
    }
    updateGroup(groupId, updatedGroup) {
        const url = `${this.identityHost}/groups/${groupId}`;
        const bodyParam = JSON.stringify(updatedGroup);
        return this.oAuth2Service.put({ url, bodyParam });
    }
    deleteGroup(groupId) {
        const url = `${this.identityHost}/groups/${groupId}`;
        return this.oAuth2Service.delete({ url });
    }
    findGroupsByName(searchParams) {
        if (searchParams.name === '') {
            return of([]);
        }
        const url = `${this.identityHost}/groups`;
        const queryParams = { search: searchParams.name };
        return this.oAuth2Service.get({ url, queryParams });
    }
    getGroupRoles(groupId) {
        const url = this.buildRolesUrl(groupId);
        return this.oAuth2Service.get({ url });
    }
    checkGroupHasRole(groupId, roleNames) {
        return this.getGroupRoles(groupId).pipe(map((groupRoles) => {
            let hasRole = false;
            if (groupRoles && groupRoles.length > 0) {
                roleNames.forEach((roleName) => {
                    const role = groupRoles.find(({ name }) => roleName === name);
                    if (role) {
                        hasRole = true;
                        return;
                    }
                });
            }
            return hasRole;
        }));
    }
    getClientIdByApplicationName(applicationName) {
        const url = `${this.identityHost}/clients`;
        const queryParams = { clientId: applicationName };
        return this.oAuth2Service.get({ url, queryParams }).pipe(map((response) => response && response.length > 0 ? response[0].id : ''));
    }
    getClientRoles(groupId, clientId) {
        const url = `${this.identityHost}/groups/${groupId}/role-mappings/clients/${clientId}`;
        return this.oAuth2Service.get({ url });
    }
    checkGroupHasClientApp(groupId, clientId) {
        return this.getClientRoles(groupId, clientId).pipe(map((response) => response && response.length > 0));
    }
    checkGroupHasAnyClientAppRole(groupId, clientId, roleNames) {
        return this.getClientRoles(groupId, clientId).pipe(map((clientRoles) => {
            let hasRole = false;
            if (clientRoles.length > 0) {
                roleNames.forEach((roleName) => {
                    const role = clientRoles.find(({ name }) => name === roleName);
                    if (role) {
                        hasRole = true;
                        return;
                    }
                });
            }
            return hasRole;
        }));
    }
    buildRolesUrl(groupId) {
        return `${this.identityHost}/groups/${groupId}/role-mappings/realm/composite`;
    }
}
IdentityGroupService.ɵprov = i0.ɵɵdefineInjectable({ factory: function IdentityGroupService_Factory() { return new IdentityGroupService(i0.ɵɵinject(i1.OAuth2Service), i0.ɵɵinject(i2.AppConfigService)); }, token: IdentityGroupService, providedIn: "root" });
IdentityGroupService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
IdentityGroupService.ctorParameters = () => [
    { type: OAuth2Service },
    { type: AppConfigService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlbnRpdHktZ3JvdXAuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvcmUvIiwic291cmNlcyI6WyJzZXJ2aWNlcy9pZGVudGl0eS1ncm91cC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQVVwRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7Ozs7QUFHakQsTUFBTSxPQUFPLG9CQUFvQjtJQUU3QixZQUNZLGFBQTRCLEVBQzVCLGdCQUFrQztRQURsQyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO0lBQzNDLENBQUM7SUFFSixJQUFZLFlBQVk7UUFDcEIsT0FBTyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQztJQUMxRCxDQUFDO0lBTUQsU0FBUztRQUNMLE1BQU0sR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFlBQVksU0FBUyxDQUFDO1FBQzFDLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQzNDLENBQUM7SUFPRCxpQkFBaUIsQ0FBQyxPQUFlO1FBQzdCLE1BQU0sR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFlBQVksV0FBVyxPQUFPLGdDQUFnQyxDQUFDO1FBQ25GLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENB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UUosVUFBVSxTQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTs7O1lBRnpCLGFBQWE7WUFWYixnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBBcHBDb25maWdTZXJ2aWNlIH0gZnJvbSAnLi4vYXBwLWNvbmZpZy9hcHAtY29uZmlnLnNlcnZpY2UnO1xuaW1wb3J0IHtcbiAgICBJZGVudGl0eUdyb3VwU2VhcmNoUGFyYW0sXG4gICAgSWRlbnRpdHlHcm91cFF1ZXJ5Q2xvdWRSZXF1ZXN0TW9kZWwsXG4gICAgSWRlbnRpdHlHcm91cE1vZGVsLFxuICAgIElkZW50aXR5R3JvdXBRdWVyeVJlc3BvbnNlLFxuICAgIElkZW50aXR5R3JvdXBDb3VudE1vZGVsXG59IGZyb20gJy4uL21vZGVscy9pZGVudGl0eS1ncm91cC5tb2RlbCc7XG5pbXBvcnQgeyBJZGVudGl0eVJvbGVNb2RlbCB9IGZyb20gJy4uL21vZGVscy9pZGVudGl0eS1yb2xlLm1vZGVsJztcbmltcG9ydCB7IElkZW50aXR5R3JvdXBTZXJ2aWNlSW50ZXJmYWNlIH0gZnJvbSAnLi9pZGVudGl0eS1ncm91cC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgT0F1dGgyU2VydmljZSB9IGZyb20gJy4vb2F1dGgyLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIElkZW50aXR5R3JvdXBTZXJ2aWNlIGltcGxlbWVudHMgSWRlbnRpdHlHcm91cFNlcnZpY2VJbnRlcmZhY2Uge1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgb0F1dGgyU2VydmljZTogT0F1dGgyU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBhcHBDb25maWdTZXJ2aWNlOiBBcHBDb25maWdTZXJ2aWNlXG4gICAgKSB7fVxuXG4gICAgcHJpdmF0ZSBnZXQgaWRlbnRpdHlIb3N0KCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBgJHt0aGlzLmFwcENvbmZpZ1NlcnZpY2UuZ2V0KCdpZGVudGl0eUhvc3QnKX1gO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYWxsIGdyb3Vwcy5cbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBncm91cCBpbmZvcm1hdGlvbiBvYmplY3RzXG4gICAgICovXG4gICAgZ2V0R3JvdXBzKCk6IE9ic2VydmFibGU8SWRlbnRpdHlHcm91cE1vZGVsW10+IHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5pZGVudGl0eUhvc3R9L2dyb3Vwc2A7XG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UuZ2V0KHsgdXJsIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYXZhaWxhYmxlIHJvbGVzXG4gICAgICogQHBhcmFtIGdyb3VwSWQgSWQgb2YgdGhlIGdyb3VwLlxuICAgICAqIEByZXR1cm5zIEFycmF5IG9mIGF2YWlsYWJsZSByb2xlcyBpbmZvcm1hdGlvbiBvYmplY3RzXG4gICAgICovXG4gICAgZ2V0QXZhaWxhYmxlUm9sZXMoZ3JvdXBJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxJZGVudGl0eVJvbGVNb2RlbFtdPiB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke3RoaXMuaWRlbnRpdHlIb3N0fS9ncm91cHMvJHtncm91cElkfS9yb2xlLW1hcHBpbmdzL3JlYWxtL2F2YWlsYWJsZWA7XG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UuZ2V0KHsgdXJsIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYXNzaWduZWQgcm9sZXNcbiAgICAgKiBAcGFyYW0gZ3JvdXBJZCBJZCBvZiB0aGUgZ3JvdXAuXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgYXZhaWxhYmxlIHJvbGVzXG4gICAgICovXG4gICAgZ2V0QXNzaWduZWRSb2xlcyhncm91cElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPElkZW50aXR5Um9sZU1vZGVsW10+IHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5pZGVudGl0eUhvc3R9L2dyb3Vwcy8ke2dyb3VwSWR9L3JvbGUtbWFwcGluZ3MvcmVhbG1gO1xuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLmdldCh7IHVybCB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBc3NpZ25zIHJvbGVzIHRvIHRoZSBncm91cFxuICAgICAqIEBwYXJhbSBncm91cElkIFRoZSBJRCBvZiB0aGUgZ3JvdXBcbiAgICAgKiBAcGFyYW0gcm9sZXMgQXJyYXkgb2Ygcm9sZXMgdG8gYXNzaWduXG4gICAgICovXG4gICAgYXNzaWduUm9sZXMoZ3JvdXBJZDogc3RyaW5nLCByb2xlczogSWRlbnRpdHlSb2xlTW9kZWxbXSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke3RoaXMuaWRlbnRpdHlIb3N0fS9ncm91cHMvJHtncm91cElkfS9yb2xlLW1hcHBpbmdzL3JlYWxtYDtcbiAgICAgICAgY29uc3QgYm9keVBhcmFtID0gSlNPTi5zdHJpbmdpZnkocm9sZXMpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UucG9zdCh7IHVybCwgYm9keVBhcmFtIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZXMgcm9sZXMgZnJvbSB0aGUgZ3JvdXBcbiAgICAgKiBAcGFyYW0gZ3JvdXBJZCBUaGUgSUQgb2YgdGhlIGdyb3VwXG4gICAgICogQHBhcmFtIHJvbGVzIEFycmF5IG9mIHJvbGVzIHRvIHJlbW92ZVxuICAgICAqL1xuICAgIHJlbW92ZVJvbGVzKGdyb3VwSWQ6IHN0cmluZywgcm9sZXM6IElkZW50aXR5Um9sZU1vZGVsW10pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmlkZW50aXR5SG9zdH0vZ3JvdXBzLyR7Z3JvdXBJZH0vcm9sZS1tYXBwaW5ncy9yZWFsbWA7XG4gICAgICAgIGNvbnN0IGJvZHlQYXJhbSA9IEpTT04uc3RyaW5naWZ5KHJvbGVzKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLmRlbGV0ZSh7IHVybCwgYm9keVBhcmFtIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBlZmZlY3RpdmUgcm9sZXNcbiAgICAgKiBAcGFyYW0gZ3JvdXBJZCBJZCBvZiB0aGUgZ3JvdXBcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBlZmZlY3RpdmUgcm9sZXNcbiAgICAgKi9cbiAgICBnZXRFZmZlY3RpdmVSb2xlcyhncm91cElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPElkZW50aXR5Um9sZU1vZGVsW10+IHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5pZGVudGl0eUhvc3R9L2dyb3Vwcy8ke2dyb3VwSWR9L3JvbGUtbWFwcGluZ3MvcmVhbG0vY29tcG9zaXRlYDtcbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5nZXQoeyB1cmwgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUXVlcmllcyBncm91cHMuXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgdXNlciBpbmZvcm1hdGlvbiBvYmplY3RzXG4gICAgICovXG4gICAgcXVlcnlHcm91cHMocmVxdWVzdFF1ZXJ5OiBJZGVudGl0eUdyb3VwUXVlcnlDbG91ZFJlcXVlc3RNb2RlbCk6IE9ic2VydmFibGU8SWRlbnRpdHlHcm91cFF1ZXJ5UmVzcG9uc2U+IHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5pZGVudGl0eUhvc3R9L2dyb3Vwc2A7XG4gICAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1zID0geyBmaXJzdDogcmVxdWVzdFF1ZXJ5LmZpcnN0IHx8IDAsIG1heDogcmVxdWVzdFF1ZXJ5Lm1heCB8fCA1IH07XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VG90YWxHcm91cHNDb3VudCgpLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKHRvdGFsQ291bnQ6IElkZW50aXR5R3JvdXBDb3VudE1vZGVsKSA9PlxuICAgICAgICAgICAgdGhpcy5vQXV0aDJTZXJ2aWNlLmdldDxhbnlbXT4oeyB1cmwsIHF1ZXJ5UGFyYW1zIH0pLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gPElkZW50aXR5R3JvdXBRdWVyeVJlc3BvbnNlPiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbnRyaWVzOiByZXNwb25zZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2luYXRpb246IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lwQ291bnQ6IHJlcXVlc3RRdWVyeS5maXJzdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhJdGVtczogcmVxdWVzdFF1ZXJ5Lm1heCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3VudDogdG90YWxDb3VudC5jb3VudCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNNb3JlSXRlbXM6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsSXRlbXM6IHRvdGFsQ291bnQuY291bnRcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGdyb3VwcyB0b3RhbCBjb3VudC5cbiAgICAgKiBAcmV0dXJucyBOdW1iZXIgb2YgZ3JvdXBzIGNvdW50LlxuICAgICAqL1xuICAgIGdldFRvdGFsR3JvdXBzQ291bnQoKTogT2JzZXJ2YWJsZTxJZGVudGl0eUdyb3VwQ291bnRNb2RlbD4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmlkZW50aXR5SG9zdH0vZ3JvdXBzL2NvdW50YDtcbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5nZXQoeyB1cmwgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBuZXcgZ3JvdXAuXG4gICAgICogQHBhcmFtIG5ld0dyb3VwIE9iamVjdCBvZiBjb250YWluaW5nIHRoZSBuZXcgZ3JvdXAgZGV0YWlscy5cbiAgICAgKiBAcmV0dXJucyBFbXB0eSByZXNwb25zZSB3aGVuIHRoZSBncm91cCBjcmVhdGVkLlxuICAgICAqL1xuICAgIGNyZWF0ZUdyb3VwKG5ld0dyb3VwOiBJZGVudGl0eUdyb3VwTW9kZWwpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmlkZW50aXR5SG9zdH0vZ3JvdXBzYDtcbiAgICAgICAgY29uc3QgYm9keVBhcmFtID0gbmV3R3JvdXA7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5wb3N0KHsgdXJsLCBib2R5UGFyYW0gfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlcyBncm91cCBkZXRhaWxzLlxuICAgICAqIEBwYXJhbSBncm91cElkIElkIG9mIHRoZSB0YXJnZXRlZCBncm91cC5cbiAgICAgKiBAcGFyYW0gdXBkYXRlZEdyb3VwIE9iamVjdCBvZiBjb250YWluaW5nIHRoZSBncm91cCBkZXRhaWxzXG4gICAgICogQHJldHVybnMgRW1wdHkgcmVzcG9uc2Ugd2hlbiB0aGUgZ3JvdXAgdXBkYXRlZC5cbiAgICAgKi9cbiAgICB1cGRhdGVHcm91cChncm91cElkOiBzdHJpbmcsIHVwZGF0ZWRHcm91cDogSWRlbnRpdHlHcm91cE1vZGVsKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5pZGVudGl0eUhvc3R9L2dyb3Vwcy8ke2dyb3VwSWR9YDtcbiAgICAgICAgY29uc3QgYm9keVBhcmFtID0gSlNPTi5zdHJpbmdpZnkodXBkYXRlZEdyb3VwKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vQXV0aDJTZXJ2aWNlLnB1dCh7IHVybCwgYm9keVBhcmFtIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlbGV0ZXMgR3JvdXAuXG4gICAgICogQHBhcmFtIGdyb3VwSWQgSWQgb2YgdGhlIGdyb3VwLlxuICAgICAqIEByZXR1cm5zIEVtcHR5IHJlc3BvbnNlIHdoZW4gdGhlIGdyb3VwIGRlbGV0ZWQuXG4gICAgICovXG4gICAgZGVsZXRlR3JvdXAoZ3JvdXBJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5pZGVudGl0eUhvc3R9L2dyb3Vwcy8ke2dyb3VwSWR9YDtcbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5kZWxldGUoeyB1cmwgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmluZHMgZ3JvdXBzIGZpbHRlcmVkIGJ5IG5hbWUuXG4gICAgICogQHBhcmFtIHNlYXJjaFBhcmFtcyBPYmplY3QgY29udGFpbmluZyB0aGUgbmFtZSBmaWx0ZXIgc3RyaW5nXG4gICAgICogQHJldHVybnMgTGlzdCBvZiBncm91cCBpbmZvcm1hdGlvblxuICAgICAqL1xuICAgIGZpbmRHcm91cHNCeU5hbWUoc2VhcmNoUGFyYW1zOiBJZGVudGl0eUdyb3VwU2VhcmNoUGFyYW0pOiBPYnNlcnZhYmxlPElkZW50aXR5R3JvdXBNb2RlbFtdPiB7XG4gICAgICAgIGlmIChzZWFyY2hQYXJhbXMubmFtZSA9PT0gJycpIHtcbiAgICAgICAgICAgIHJldHVybiBvZihbXSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5pZGVudGl0eUhvc3R9L2dyb3Vwc2A7XG4gICAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1zID0geyBzZWFyY2g6IHNlYXJjaFBhcmFtcy5uYW1lIH07XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5nZXQoeyB1cmwsIHF1ZXJ5UGFyYW1zIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgZGV0YWlscyBmb3IgYSBzcGVjaWZpZWQgZ3JvdXAuXG4gICAgICogQHBhcmFtIGdyb3VwSWQgSWQgb2YgdGhlIHRhcmdldCBncm91cFxuICAgICAqIEByZXR1cm5zIEdyb3VwIGRldGFpbHNcbiAgICAgKi9cbiAgICBnZXRHcm91cFJvbGVzKGdyb3VwSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8SWRlbnRpdHlSb2xlTW9kZWxbXT4ge1xuICAgICAgICBjb25zdCB1cmwgPSB0aGlzLmJ1aWxkUm9sZXNVcmwoZ3JvdXBJZCk7XG4gICAgICAgIHJldHVybiB0aGlzLm9BdXRoMlNlcnZpY2UuZ2V0KHsgdXJsIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIHRoYXQgYSBncm91cCBoYXMgb25lIG9yIG1vcmUgcm9sZXMgZnJvbSB0aGUgc3VwcGxpZWQgbGlzdC5cbiAgICAgKiBAcGFyYW0gZ3JvdXBJZCBJZCBvZiB0aGUgdGFyZ2V0IGdyb3VwXG4gICAgICogQHBhcmFtIHJvbGVOYW1lcyBBcnJheSBvZiByb2xlIG5hbWVzXG4gICAgICogQHJldHVybnMgVHJ1ZSBpZiB0aGUgZ3JvdXAgaGFzIG9uZSBvciBtb3JlIG9mIHRoZSByb2xlcywgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgY2hlY2tHcm91cEhhc1JvbGUoZ3JvdXBJZDogc3RyaW5nLCByb2xlTmFtZXM6IHN0cmluZ1tdKTogT2JzZXJ2YWJsZTxib29sZWFuPiAge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRHcm91cFJvbGVzKGdyb3VwSWQpLnBpcGUobWFwKChncm91cFJvbGVzKSA9PiB7XG4gICAgICAgICAgICBsZXQgaGFzUm9sZSA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKGdyb3VwUm9sZXMgJiYgZ3JvdXBSb2xlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcm9sZU5hbWVzLmZvckVhY2goKHJvbGVOYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm9sZSA9IGdyb3VwUm9sZXMuZmluZCgoeyBuYW1lIH0pID0+IHJvbGVOYW1lID09PSBuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJvbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhc1JvbGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gaGFzUm9sZTtcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIGNsaWVudCBJZCB1c2luZyB0aGUgYXBwIG5hbWUuXG4gICAgICogQHBhcmFtIGFwcGxpY2F0aW9uTmFtZSBOYW1lIG9mIHRoZSBhcHBcbiAgICAgKiBAcmV0dXJucyBjbGllbnQgSWQgc3RyaW5nXG4gICAgICovXG4gICAgZ2V0Q2xpZW50SWRCeUFwcGxpY2F0aW9uTmFtZShhcHBsaWNhdGlvbk5hbWU6IHN0cmluZyk6IE9ic2VydmFibGU8c3RyaW5nPiB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke3RoaXMuaWRlbnRpdHlIb3N0fS9jbGllbnRzYDtcbiAgICAgICAgY29uc3QgcXVlcnlQYXJhbXMgPSB7Y2xpZW50SWQ6IGFwcGxpY2F0aW9uTmFtZX07XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5nZXQ8YW55W10+KHsgdXJsLCBxdWVyeVBhcmFtcyB9KS5waXBlKFxuICAgICAgICAgICAgbWFwKChyZXNwb25zZSkgPT4gcmVzcG9uc2UgJiYgcmVzcG9uc2UubGVuZ3RoID4gMCA/IHJlc3BvbnNlWzBdLmlkIDogJycpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBjbGllbnQgcm9sZXMuXG4gICAgICogQHBhcmFtIGdyb3VwSWQgSWQgb2YgdGhlIHRhcmdldCBncm91cFxuICAgICAqIEBwYXJhbSBjbGllbnRJZCBJZCBvZiB0aGUgY2xpZW50XG4gICAgICogQHJldHVybnMgTGlzdCBvZiByb2xlc1xuICAgICAqL1xuICAgIGdldENsaWVudFJvbGVzKGdyb3VwSWQ6IHN0cmluZywgY2xpZW50SWQ6IHN0cmluZyk6IE9ic2VydmFibGU8SWRlbnRpdHlSb2xlTW9kZWxbXT4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmlkZW50aXR5SG9zdH0vZ3JvdXBzLyR7Z3JvdXBJZH0vcm9sZS1tYXBwaW5ncy9jbGllbnRzLyR7Y2xpZW50SWR9YDtcbiAgICAgICAgcmV0dXJuIHRoaXMub0F1dGgyU2VydmljZS5nZXQoeyB1cmwgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIGEgZ3JvdXAgaGFzIGEgY2xpZW50IGFwcC5cbiAgICAgKiBAcGFyYW0gZ3JvdXBJZCBJZCBvZiB0aGUgdGFyZ2V0IGdyb3VwXG4gICAgICogQHBhcmFtIGNsaWVudElkIElkIG9mIHRoZSBjbGllbnRcbiAgICAgKiBAcmV0dXJucyBUcnVlIGlmIHRoZSBncm91cCBoYXMgdGhlIGNsaWVudCBhcHAsIGZhbHNlIG90aGVyd2lzZVxuICAgICAqL1xuICAgIGNoZWNrR3JvdXBIYXNDbGllbnRBcHAoZ3JvdXBJZDogc3RyaW5nLCBjbGllbnRJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldENsaWVudFJvbGVzKGdyb3VwSWQsIGNsaWVudElkKS5waXBlKFxuICAgICAgICAgICAgbWFwKChyZXNwb25zZSkgPT4gcmVzcG9uc2UgJiYgcmVzcG9uc2UubGVuZ3RoID4gMClcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiBhIGdyb3VwIGhhcyBhbnkgb2YgdGhlIGNsaWVudCBhcHAgcm9sZXMgaW4gdGhlIHN1cHBsaWVkIGxpc3QuXG4gICAgICogQHBhcmFtIGdyb3VwSWQgSWQgb2YgdGhlIHRhcmdldCBncm91cFxuICAgICAqIEBwYXJhbSBjbGllbnRJZCBJZCBvZiB0aGUgY2xpZW50XG4gICAgICogQHBhcmFtIHJvbGVOYW1lcyBBcnJheSBvZiByb2xlIG5hbWVzIHRvIGNoZWNrXG4gICAgICogQHJldHVybnMgVHJ1ZSBpZiB0aGUgZ3JvdXAgaGFzIG9uZSBvciBtb3JlIG9mIHRoZSByb2xlcywgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgY2hlY2tHcm91cEhhc0FueUNsaWVudEFwcFJvbGUoZ3JvdXBJZDogc3RyaW5nLCBjbGllbnRJZDogc3RyaW5nLCByb2xlTmFtZXM6IHN0cmluZ1tdKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldENsaWVudFJvbGVzKGdyb3VwSWQsIGNsaWVudElkKS5waXBlKFxuICAgICAgICAgICAgbWFwKChjbGllbnRSb2xlczogYW55W10pID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgaGFzUm9sZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChjbGllbnRSb2xlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJvbGVOYW1lcy5mb3JFYWNoKChyb2xlTmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm9sZSA9IGNsaWVudFJvbGVzLmZpbmQoKHsgbmFtZSB9KSA9PiBuYW1lID09PSByb2xlTmFtZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyb2xlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzUm9sZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGhhc1JvbGU7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgYnVpbGRSb2xlc1VybChncm91cElkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gYCR7dGhpcy5pZGVudGl0eUhvc3R9L2dyb3Vwcy8ke2dyb3VwSWR9L3JvbGUtbWFwcGluZ3MvcmVhbG0vY29tcG9zaXRlYDtcbiAgICB9XG59XG4iXX0=