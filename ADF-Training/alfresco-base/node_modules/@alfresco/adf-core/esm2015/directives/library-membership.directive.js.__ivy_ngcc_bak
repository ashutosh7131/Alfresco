/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Directive, EventEmitter, HostListener, Input, Output } from '@angular/core';
import { SiteEntry, SitesApi } from '@alfresco/js-api';
import { BehaviorSubject, from } from 'rxjs';
import { AlfrescoApiService } from '../services/alfresco-api.service';
import { SitesService } from '../services/sites.service';
import { VersionCompatibilityService } from '../services/version-compatibility.service';
export class LibraryMembershipDirective {
    constructor(alfrescoApiService, sitesService, versionCompatibilityService) {
        this.alfrescoApiService = alfrescoApiService;
        this.sitesService = sitesService;
        this.versionCompatibilityService = versionCompatibilityService;
        this.targetSite = null;
        this.isJoinRequested = new BehaviorSubject(false);
        this.selection = null;
        this.isAdmin = false;
        this.toggle = new EventEmitter();
        this.error = new EventEmitter();
    }
    get sitesApi() {
        var _a;
        this._sitesApi = (_a = this._sitesApi) !== null && _a !== void 0 ? _a : new SitesApi(this.alfrescoApiService.getInstance());
        return this._sitesApi;
    }
    onClick() {
        this.toggleMembershipRequest();
    }
    ngOnChanges(changes) {
        if (!changes.selection.currentValue || !changes.selection.currentValue.entry) {
            this.targetSite = null;
            return;
        }
        this.targetSite = changes.selection.currentValue.entry;
        this.markMembershipRequest();
    }
    toggleMembershipRequest() {
        if (!this.targetSite) {
            return;
        }
        if (this.targetSite.joinRequested) {
            this.cancelJoinRequest().subscribe(() => {
                this.targetSite.joinRequested = false;
                this.isJoinRequested.next(false);
                const info = {
                    updatedEntry: this.targetSite,
                    shouldReload: false,
                    i18nKey: 'APP.MESSAGES.INFO.JOIN_CANCELED'
                };
                this.toggle.emit(info);
            }, (error) => {
                const errWithMessage = {
                    error,
                    i18nKey: 'APP.MESSAGES.ERRORS.JOIN_CANCEL_FAILED'
                };
                this.error.emit(errWithMessage);
            });
        }
        if (!this.targetSite.joinRequested && !this.isAdmin) {
            this.joinLibraryRequest().subscribe((createdMembership) => {
                this.targetSite.joinRequested = true;
                this.isJoinRequested.next(true);
                if (createdMembership.entry && createdMembership.entry.site && createdMembership.entry.site.role) {
                    const info = {
                        shouldReload: true,
                        i18nKey: 'APP.MESSAGES.INFO.JOINED'
                    };
                    this.toggle.emit(info);
                }
                else {
                    const info = {
                        updatedEntry: this.targetSite,
                        shouldReload: false,
                        i18nKey: 'APP.MESSAGES.INFO.JOIN_REQUESTED'
                    };
                    this.toggle.emit(info);
                }
            }, (error) => {
                const errWithMessage = {
                    error,
                    i18nKey: 'APP.MESSAGES.ERRORS.JOIN_REQUEST_FAILED'
                };
                const senderEmailCheck = 'Failed to resolve sender mail address';
                const receiverEmailCheck = 'All recipients for the mail action were invalid';
                if (error.message) {
                    if (error.message.includes(senderEmailCheck)) {
                        errWithMessage.i18nKey = 'APP.MESSAGES.ERRORS.INVALID_SENDER_EMAIL';
                    }
                    else if (error.message.includes(receiverEmailCheck)) {
                        errWithMessage.i18nKey = 'APP.MESSAGES.ERRORS.INVALID_RECEIVER_EMAIL';
                    }
                }
                this.error.emit(errWithMessage);
            });
        }
        if (this.isAdmin) {
            this.joinLibrary().subscribe((createdMembership) => {
                if (createdMembership.entry && createdMembership.entry.role) {
                    const info = {
                        shouldReload: true,
                        i18nKey: 'APP.MESSAGES.INFO.JOINED'
                    };
                    this.toggle.emit(info);
                }
            }, (error) => {
                const errWithMessage = {
                    error,
                    i18nKey: 'APP.MESSAGES.ERRORS.JOIN_REQUEST_FAILED'
                };
                const senderEmailCheck = 'Failed to resolve sender mail address';
                const receiverEmailCheck = 'All recipients for the mail action were invalid';
                if (error.message) {
                    if (error.message.includes(senderEmailCheck)) {
                        errWithMessage.i18nKey = 'APP.MESSAGES.ERRORS.INVALID_SENDER_EMAIL';
                    }
                    else if (error.message.includes(receiverEmailCheck)) {
                        errWithMessage.i18nKey = 'APP.MESSAGES.ERRORS.INVALID_RECEIVER_EMAIL';
                    }
                }
                this.error.emit(errWithMessage);
            });
        }
    }
    markMembershipRequest() {
        if (!this.targetSite) {
            return;
        }
        this.getMembershipRequest().subscribe((data) => {
            if (data.entry.id === this.targetSite.id) {
                this.targetSite.joinRequested = true;
                this.isJoinRequested.next(true);
            }
        }, () => {
            this.targetSite.joinRequested = false;
            this.isJoinRequested.next(false);
        });
    }
    joinLibraryRequest() {
        const memberBody = {
            id: this.targetSite.id
        };
        if (this.versionCompatibilityService.isVersionSupported('7.0.0')) {
            memberBody.client = 'workspace';
        }
        return from(this.sitesApi.createSiteMembershipRequestForPerson('-me-', memberBody));
    }
    joinLibrary() {
        return this.sitesService.createSiteMembership(this.targetSite.id, {
            role: 'SiteConsumer',
            id: '-me-'
        });
    }
    cancelJoinRequest() {
        return from(this.sitesApi.deleteSiteMembershipRequestForPerson('-me-', this.targetSite.id));
    }
    getMembershipRequest() {
        return from(this.sitesApi.getSiteMembershipRequestForPerson('-me-', this.targetSite.id));
    }
}
LibraryMembershipDirective.decorators = [
    { type: Directive, args: [{
                selector: '[adf-library-membership]',
                exportAs: 'libraryMembership'
            },] }
];
LibraryMembershipDirective.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: SitesService },
    { type: VersionCompatibilityService }
];
LibraryMembershipDirective.propDecorators = {
    selection: [{ type: Input, args: ['adf-library-membership',] }],
    isAdmin: [{ type: Input }],
    toggle: [{ type: Output }],
    error: [{ type: Output }],
    onClick: [{ type: HostListener, args: ['click',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlicmFyeS1tZW1iZXJzaGlwLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvcmUvIiwic291cmNlcyI6WyJkaXJlY3RpdmVzL2xpYnJhcnktbWVtYmVyc2hpcC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7OztHQWVHO0FBRUgsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBYSxNQUFNLEVBQWlCLE1BQU0sZUFBZSxDQUFDO0FBQy9HLE9BQU8sRUFDSCxTQUFTLEVBSVQsUUFBUSxFQUNYLE1BQU0sa0JBQWtCLENBQUM7QUFDMUIsT0FBTyxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDekQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDdEUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3pELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLDJDQUEyQyxDQUFDO0FBaUJ4RixNQUFNLE9BQU8sMEJBQTBCO0lBK0JuQyxZQUNZLGtCQUFzQyxFQUN0QyxZQUEwQixFQUMxQiwyQkFBd0Q7UUFGeEQsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixnQ0FBMkIsR0FBM0IsMkJBQTJCLENBQTZCO1FBakNwRSxlQUFVLEdBQVEsSUFBSSxDQUFDO1FBRXZCLG9CQUFlLEdBQTZCLElBQUksZUFBZSxDQUFVLEtBQUssQ0FBQyxDQUFDO1FBVWhGLGNBQVMsR0FBYyxJQUFJLENBQUM7UUFJNUIsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUdoQixXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQWdDLENBQUM7UUFJMUQsVUFBSyxHQUFHLElBQUksWUFB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QUM7UUFFL0IsSUFBSSxJQUFJLENBQUMsMkJBQTJCLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDOUQsVUFBVSxDQUFDLE1BQU0sR0FBRyxXQUFXLENBQUM7U0FDbkM7UUFDRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLG9DQUFvQyxDQUFDLE1BQU0sRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQ3hGLENBQUM7SUFFTyxXQUFXO1FBQ2YsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxFQUFFO1lBQzlELElBQUksRUFBRSxjQUFjO1lBQ3BCLEVBQUUsRUFBRSxNQUFNO1NBQ2IsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVPLGlCQUFpQjtRQUNyQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLG9DQUFvQyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDaEcsQ0FBQztJQUVPLG9CQUFvQjtRQUN4QixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGlDQUFpQyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDN0YsQ0FBQzs7O1lBdk1KLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsMEJBQTBCO2dCQUNwQyxRQUFRLEVBQUUsbUJBQW1CO2FBQ2hDOzs7WUFsQlEsa0JBQWtCO1lBQ2xCLFlBQVk7WUFDWiwyQkFBMkI7Ozt3QkE2Qi9CLEtBQUssU0FBQyx3QkFBd0I7c0JBSTlCLEtBQUs7cUJBR0wsTUFBTTtvQkFJTixNQUFNO3NCQUdOLFlBQVksU0FBQyxPQUFPIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgRGlyZWN0aXZlLCBFdmVudEVtaXR0ZXIsIEhvc3RMaXN0ZW5lciwgSW5wdXQsIE9uQ2hhbmdlcywgT3V0cHV0LCBTaW1wbGVDaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICAgIFNpdGVFbnRyeSxcbiAgICBTaXRlTWVtYmVyc2hpcFJlcXVlc3RCb2R5LFxuICAgIFNpdGVNZW1iZXJFbnRyeSxcbiAgICBTaXRlTWVtYmVyc2hpcFJlcXVlc3RFbnRyeSxcbiAgICBTaXRlc0FwaVxufSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgZnJvbSwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvYWxmcmVzY28tYXBpLnNlcnZpY2UnO1xuaW1wb3J0IHsgU2l0ZXNTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvc2l0ZXMuc2VydmljZSc7XG5pbXBvcnQgeyBWZXJzaW9uQ29tcGF0aWJpbGl0eVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy92ZXJzaW9uLWNvbXBhdGliaWxpdHkuc2VydmljZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTGlicmFyeU1lbWJlcnNoaXBUb2dnbGVFdmVudCB7XG4gICAgdXBkYXRlZEVudHJ5PzogYW55O1xuICAgIHNob3VsZFJlbG9hZDogYm9vbGVhbjtcbiAgICBpMThuS2V5OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTGlicmFyeU1lbWJlcnNoaXBFcnJvckV2ZW50IHtcbiAgICBlcnJvcjogYW55O1xuICAgIGkxOG5LZXk6IHN0cmluZztcbn1cblxuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICdbYWRmLWxpYnJhcnktbWVtYmVyc2hpcF0nLFxuICAgIGV4cG9ydEFzOiAnbGlicmFyeU1lbWJlcnNoaXAnXG59KVxuZXhwb3J0IGNsYXNzIExpYnJhcnlNZW1iZXJzaGlwRGlyZWN0aXZlIGltcGxlbWVudHMgT25DaGFuZ2VzIHtcbiAgICB0YXJnZXRTaXRlOiBhbnkgPSBudWxsO1xuXG4gICAgaXNKb2luUmVxdWVzdGVkOiBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKTtcblxuICAgIF9zaXRlc0FwaTogU2l0ZXNBcGk7XG4gICAgZ2V0IHNpdGVzQXBpKCk6IFNpdGVzQXBpIHtcbiAgICAgICAgdGhpcy5fc2l0ZXNBcGkgPSB0aGlzLl9zaXRlc0FwaSA/PyBuZXcgU2l0ZXNBcGkodGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl9zaXRlc0FwaTtcbiAgICB9XG5cbiAgICAvKiogU2l0ZSBmb3Igd2hpY2ggdG8gdG9nZ2xlIHRoZSBtZW1iZXJzaGlwIHJlcXVlc3QuICovXG4gICAgQElucHV0KCdhZGYtbGlicmFyeS1tZW1iZXJzaGlwJylcbiAgICBzZWxlY3Rpb246IFNpdGVFbnRyeSA9IG51bGw7XG5cbiAgICAvKiogU2l0ZSBmb3Igd2hpY2ggdG8gdG9nZ2xlIHRoZSBtZW1iZXJzaGlwIHJlcXVlc3QuICovXG4gICAgQElucHV0KClcbiAgICBpc0FkbWluID0gZmFsc2U7XG5cbiAgICBAT3V0cHV0KClcbiAgICB0b2dnbGUgPSBuZXcgRXZlbnRFbWl0dGVyPExpYnJhcnlNZW1iZXJzaGlwVG9nZ2xlRXZlbnQ+KCk7XG5cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLW91dHB1dC1uYXRpdmVcbiAgICBAT3V0cHV0KClcbiAgICBlcnJvciA9IG5ldyBFdmVudEVtaXR0ZXI8TGlicmFyeU1lbWJlcnNoaXBFcnJvckV2ZW50PigpO1xuXG4gICAgQEhvc3RMaXN0ZW5lcignY2xpY2snKVxuICAgIG9uQ2xpY2soKSB7XG4gICAgICAgIHRoaXMudG9nZ2xlTWVtYmVyc2hpcFJlcXVlc3QoKTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBhbGZyZXNjb0FwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBzaXRlc1NlcnZpY2U6IFNpdGVzU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSB2ZXJzaW9uQ29tcGF0aWJpbGl0eVNlcnZpY2U6IFZlcnNpb25Db21wYXRpYmlsaXR5U2VydmljZVxuICAgICkge1xuICAgIH1cblxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICAgICAgaWYgKCFjaGFuZ2VzLnNlbGVjdGlvbi5jdXJyZW50VmFsdWUgfHwgIWNoYW5nZXMuc2VsZWN0aW9uLmN1cnJlbnRWYWx1ZS5lbnRyeSkge1xuICAgICAgICAgICAgdGhpcy50YXJnZXRTaXRlID0gbnVsbDtcblxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudGFyZ2V0U2l0ZSA9IGNoYW5nZXMuc2VsZWN0aW9uLmN1cnJlbnRWYWx1ZS5lbnRyeTtcbiAgICAgICAgdGhpcy5tYXJrTWVtYmVyc2hpcFJlcXVlc3QoKTtcbiAgICB9XG5cbiAgICB0b2dnbGVNZW1iZXJzaGlwUmVxdWVzdCgpIHtcbiAgICAgICAgaWYgKCF0aGlzLnRhcmdldFNpdGUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnRhcmdldFNpdGUuam9pblJlcXVlc3RlZCkge1xuICAgICAgICAgICAgdGhpcy5jYW5jZWxKb2luUmVxdWVzdCgpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0U2l0ZS5qb2luUmVxdWVzdGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaXNKb2luUmVxdWVzdGVkLm5leHQoZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZEVudHJ5OiB0aGlzLnRhcmdldFNpdGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRSZWxvYWQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgaTE4bktleTogJ0FQUC5NRVNTQUdFUy5JTkZPLkpPSU5fQ0FOQ0VMRUQnXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xlLmVtaXQoaW5mbyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyV2l0aE1lc3NhZ2UgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICAgICAgICAgICAgICAgIGkxOG5LZXk6ICdBUFAuTUVTU0FHRVMuRVJST1JTLkpPSU5fQ0FOQ0VMX0ZBSUxFRCdcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lcnJvci5lbWl0KGVycldpdGhNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0aGlzLnRhcmdldFNpdGUuam9pblJlcXVlc3RlZCAmJiAhdGhpcy5pc0FkbWluKSB7XG4gICAgICAgICAgICB0aGlzLmpvaW5MaWJyYXJ5UmVxdWVzdCgpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoY3JlYXRlZE1lbWJlcnNoaXApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50YXJnZXRTaXRlLmpvaW5SZXF1ZXN0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmlzSm9pblJlcXVlc3RlZC5uZXh0KHRydWUpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChjcmVhdGVkTWVtYmVyc2hpcC5lbnRyeSAmJiBjcmVhdGVkTWVtYmVyc2hpcC5lbnRyeS5zaXRlICYmIGNyZWF0ZWRNZW1iZXJzaGlwLmVudHJ5LnNpdGUucm9sZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5mbyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRSZWxvYWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaTE4bktleTogJ0FQUC5NRVNTQUdFUy5JTkZPLkpPSU5FRCdcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZS5lbWl0KGluZm8pO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5mbyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkRW50cnk6IHRoaXMudGFyZ2V0U2l0ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRSZWxvYWQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkxOG5LZXk6ICdBUFAuTUVTU0FHRVMuSU5GTy5KT0lOX1JFUVVFU1RFRCdcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZS5lbWl0KGluZm8pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyV2l0aE1lc3NhZ2UgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICAgICAgICAgICAgICAgIGkxOG5LZXk6ICdBUFAuTUVTU0FHRVMuRVJST1JTLkpPSU5fUkVRVUVTVF9GQUlMRUQnXG4gICAgICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VuZGVyRW1haWxDaGVjayA9ICdGYWlsZWQgdG8gcmVzb2x2ZSBzZW5kZXIgbWFpbCBhZGRyZXNzJztcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVjZWl2ZXJFbWFpbENoZWNrID0gJ0FsbCByZWNpcGllbnRzIGZvciB0aGUgbWFpbCBhY3Rpb24gd2VyZSBpbnZhbGlkJztcblxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoc2VuZGVyRW1haWxDaGVjaykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJXaXRoTWVzc2FnZS5pMThuS2V5ID0gJ0FQUC5NRVNTQUdFUy5FUlJPUlMuSU5WQUxJRF9TRU5ERVJfRU1BSUwnO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKHJlY2VpdmVyRW1haWxDaGVjaykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJXaXRoTWVzc2FnZS5pMThuS2V5ID0gJ0FQUC5NRVNTQUdFUy5FUlJPUlMuSU5WQUxJRF9SRUNFSVZFUl9FTUFJTCc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVycm9yLmVtaXQoZXJyV2l0aE1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5pc0FkbWluKSB7XG4gICAgICAgICAgICB0aGlzLmpvaW5MaWJyYXJ5KCkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIChjcmVhdGVkTWVtYmVyc2hpcDogU2l0ZU1lbWJlckVudHJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjcmVhdGVkTWVtYmVyc2hpcC5lbnRyeSAmJiBjcmVhdGVkTWVtYmVyc2hpcC5lbnRyeS5yb2xlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZFJlbG9hZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpMThuS2V5OiAnQVBQLk1FU1NBR0VTLklORk8uSk9JTkVEJ1xuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xlLmVtaXQoaW5mbyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJXaXRoTWVzc2FnZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgaTE4bktleTogJ0FQUC5NRVNTQUdFUy5FUlJPUlMuSk9JTl9SRVFVRVNUX0ZBSUxFRCdcbiAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzZW5kZXJFbWFpbENoZWNrID0gJ0ZhaWxlZCB0byByZXNvbHZlIHNlbmRlciBtYWlsIGFkZHJlc3MnO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByZWNlaXZlckVtYWlsQ2hlY2sgPSAnQWxsIHJlY2lwaWVudHMgZm9yIHRoZSBtYWlsIGFjdGlvbiB3ZXJlIGludmFsaWQnO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnJvci5tZXNzYWdlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcyhzZW5kZXJFbWFpbENoZWNrKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycldpdGhNZXNzYWdlLmkxOG5LZXkgPSAnQVBQLk1FU1NBR0VTLkVSUk9SUy5JTlZBTElEX1NFTkRFUl9FTUFJTCc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMocmVjZWl2ZXJFbWFpbENoZWNrKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycldpdGhNZXNzYWdlLmkxOG5LZXkgPSAnQVBQLk1FU1NBR0VTLkVSUk9SUy5JTlZBTElEX1JFQ0VJVkVSX0VNQUlMJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXJyb3IuZW1pdChlcnJXaXRoTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG1hcmtNZW1iZXJzaGlwUmVxdWVzdCgpIHtcbiAgICAgICAgaWYgKCF0aGlzLnRhcmdldFNpdGUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZ2V0TWVtYmVyc2hpcFJlcXVlc3QoKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChkYXRhLmVudHJ5LmlkID09PSB0aGlzLnRhcmdldFNpdGUuaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50YXJnZXRTaXRlLmpvaW5SZXF1ZXN0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmlzSm9pblJlcXVlc3RlZC5uZXh0KHRydWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy50YXJnZXRTaXRlLmpvaW5SZXF1ZXN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLmlzSm9pblJlcXVlc3RlZC5uZXh0KGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGpvaW5MaWJyYXJ5UmVxdWVzdCgpOiBPYnNlcnZhYmxlPFNpdGVNZW1iZXJzaGlwUmVxdWVzdEVudHJ5PiB7XG4gICAgICAgIGNvbnN0IG1lbWJlckJvZHkgPSB7XG4gICAgICAgICAgICBpZDogdGhpcy50YXJnZXRTaXRlLmlkXG4gICAgICAgIH0gYXMgU2l0ZU1lbWJlcnNoaXBSZXF1ZXN0Qm9keTtcblxuICAgICAgICBpZiAodGhpcy52ZXJzaW9uQ29tcGF0aWJpbGl0eVNlcnZpY2UuaXNWZXJzaW9uU3VwcG9ydGVkKCc3LjAuMCcpKSB7XG4gICAgICAgICAgICBtZW1iZXJCb2R5LmNsaWVudCA9ICd3b3Jrc3BhY2UnO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuc2l0ZXNBcGkuY3JlYXRlU2l0ZU1lbWJlcnNoaXBSZXF1ZXN0Rm9yUGVyc29uKCctbWUtJywgbWVtYmVyQm9keSkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgam9pbkxpYnJhcnkoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNpdGVzU2VydmljZS5jcmVhdGVTaXRlTWVtYmVyc2hpcCh0aGlzLnRhcmdldFNpdGUuaWQsIHtcbiAgICAgICAgICAgIHJvbGU6ICdTaXRlQ29uc3VtZXInLFxuICAgICAgICAgICAgaWQ6ICctbWUtJ1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbmNlbEpvaW5SZXF1ZXN0KCkge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnNpdGVzQXBpLmRlbGV0ZVNpdGVNZW1iZXJzaGlwUmVxdWVzdEZvclBlcnNvbignLW1lLScsIHRoaXMudGFyZ2V0U2l0ZS5pZCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TWVtYmVyc2hpcFJlcXVlc3QoKSB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuc2l0ZXNBcGkuZ2V0U2l0ZU1lbWJlcnNoaXBSZXF1ZXN0Rm9yUGVyc29uKCctbWUtJywgdGhpcy50YXJnZXRTaXRlLmlkKSk7XG4gICAgfVxufVxuIl19