import { AlfrescoApiService } from '../../services/alfresco-api.service';
import { LogService } from '../../services/log.service';
import { Injectable } from '@angular/core';
import moment from 'moment-es6';
import { from, throwError } from 'rxjs';
import { WidgetTypeEnum } from '../models/widget-visibility.model';
import { map, catchError } from 'rxjs/operators';
import { TaskFormsApi } from '@alfresco/js-api';
import * as i0 from "@angular/core";
import * as i1 from "../../services/alfresco-api.service";
import * as i2 from "../../services/log.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../../services/alfresco-api.service';
import * as ɵngcc2 from '../../services/log.service';
export class WidgetVisibilityService {
    constructor(apiService, logService) {
        this.apiService = apiService;
        this.logService = logService;
    }
    get taskFormsApi() {
        var _a;
        this._taskFormsApi = (_a = this._taskFormsApi) !== null && _a !== void 0 ? _a : new TaskFormsApi(this.apiService.getInstance());
        return this._taskFormsApi;
    }
    refreshVisibility(form, processVarList) {
        this.form = form;
        if (processVarList) {
            this.processVarList = processVarList;
        }
        if (form && form.tabs && form.tabs.length > 0) {
            form.tabs.map((tabModel) => this.refreshEntityVisibility(tabModel));
        }
        if (form && form.outcomes && form.outcomes.length > 0) {
            form.outcomes.map((outcomeModel) => this.refreshOutcomeVisibility(outcomeModel));
        }
        if (form) {
            form.getFormFields().map((field) => this.refreshEntityVisibility(field));
        }
    }
    refreshEntityVisibility(element) {
        const visible = this.evaluateVisibility(element.form, element.visibilityCondition);
        element.isVisible = visible && this.isParentTabVisible(this.form, element);
    }
    refreshOutcomeVisibility(element) {
        element.isVisible = this.evaluateVisibility(element.form, element.visibilityCondition);
    }
    evaluateVisibility(form, visibilityObj) {
        const isLeftFieldPresent = visibilityObj && (visibilityObj.leftType || visibilityObj.leftValue);
        if (!isLeftFieldPresent || isLeftFieldPresent === 'null') {
            return true;
        }
        else {
            return this.isFieldVisible(form, visibilityObj);
        }
    }
    isFieldVisible(form, visibilityObj, accumulator = [], result = false) {
        const leftValue = this.getLeftValue(form, visibilityObj);
        const rightValue = this.getRightValue(form, visibilityObj);
        const actualResult = this.evaluateCondition(leftValue, rightValue, visibilityObj.operator);
        accumulator.push({ value: actualResult, operator: visibilityObj.nextConditionOperator });
        if (this.isValidCondition(visibilityObj.nextCondition)) {
            result = this.isFieldVisible(form, visibilityObj.nextCondition, accumulator);
        }
        else if (accumulator[0] !== undefined) {
            result = Function('"use strict";return (' +
                accumulator.map((expression) => this.transformToLiteralExpression(expression)).join('') +
                ')')();
        }
        else {
            result = actualResult;
        }
        return !!result;
    }
    transformToLiteralExpression(currentExpression) {
        const currentTransformedValue = !!currentExpression.value ? 'true' : 'false';
        return currentTransformedValue.concat(this.transformToLiteralOperator(currentExpression.operator));
    }
    transformToLiteralOperator(currentOperator) {
        switch (currentOperator) {
            case 'and':
                return '&&';
            case 'or':
                return '||';
            case 'and-not':
                return '&& !';
            case 'or-not':
                return '|| !';
            default:
                return '';
        }
    }
    getLeftValue(form, visibilityObj) {
        let leftValue = '';
        if (visibilityObj.leftType && visibilityObj.leftType === WidgetTypeEnum.variable) {
            leftValue = this.getVariableValue(form, visibilityObj.leftValue, this.processVarList);
        }
        else if (visibilityObj.leftType && visibilityObj.leftType === WidgetTypeEnum.field) {
            leftValue = this.getFormValue(form, visibilityObj.leftValue);
            if (leftValue === undefined || leftValue === '') {
                const variableValue = this.getVariableValue(form, visibilityObj.leftValue, this.processVarList);
                leftValue = !this.isInvalidValue(variableValue) ? variableValue : leftValue;
            }
        }
        return leftValue;
    }
    getRightValue(form, visibilityObj) {
        let valueFound = '';
        if (visibilityObj.rightType === WidgetTypeEnum.variable) {
            valueFound = this.getVariableValue(form, visibilityObj.rightValue, this.processVarList);
        }
        else if (visibilityObj.rightType === WidgetTypeEnum.field) {
            valueFound = this.getFormValue(form, visibilityObj.rightValue);
        }
        else {
            if (moment(visibilityObj.rightValue, 'YYYY-MM-DD', true).isValid()) {
                valueFound = visibilityObj.rightValue + 'T00:00:00.000Z';
            }
            else {
                valueFound = visibilityObj.rightValue;
            }
        }
        return valueFound;
    }
    getFormValue(form, fieldId) {
        const formField = this.getFormFieldById(form, fieldId);
        let value = undefined;
        if (this.isFormFieldValid(formField)) {
            value = this.getFieldValue(form.values, fieldId);
            if (this.isInvalidValue(value)) {
                value = this.searchValueInForm(formField, fieldId);
            }
        }
        return value;
    }
    isFormFieldValid(formField) {
        return formField && formField.isValid;
    }
    getFieldValue(valueList, fieldId) {
        let labelFilterByName, valueFound;
        if (fieldId && fieldId.indexOf('_LABEL') > 0) {
            labelFilterByName = fieldId.substring(0, fieldId.length - 6);
            if (valueList[labelFilterByName]) {
                if (Array.isArray(valueList[labelFilterByName])) {
                    valueFound = valueList[labelFilterByName].map(({ name }) => name);
                }
                else {
                    valueFound = valueList[labelFilterByName].name;
                }
            }
        }
        else if (valueList[fieldId] && valueList[fieldId].id) {
            valueFound = valueList[fieldId].id;
        }
        else if (valueList[fieldId] && Array.isArray(valueList[fieldId])) {
            valueFound = valueList[fieldId].map(({ id }) => id);
        }
        else {
            valueFound = valueList[fieldId];
        }
        return valueFound;
    }
    isInvalidValue(value) {
        return value === undefined || value === null;
    }
    getFormFieldById(form, fieldId) {
        return form.getFormFields().find((formField) => this.isSearchedField(formField, fieldId));
    }
    searchValueInForm(formField, fieldId) {
        let fieldValue = '';
        if (formField) {
            fieldValue = this.getObjectValue(formField, fieldId);
            if (!fieldValue) {
                if (formField.value && formField.value.id) {
                    fieldValue = formField.value.id;
                }
                else if (!this.isInvalidValue(formField.value)) {
                    fieldValue = formField.value;
                }
            }
        }
        return fieldValue;
    }
    isParentTabVisible(form, currentFormField) {
        const containers = this.getFormTabContainers(form);
        let isVisible = true;
        containers.map((container) => {
            if (!!this.getCurrentFieldFromTabById(container, currentFormField.id)) {
                const currentTab = form.tabs.find((tab) => tab.id === container.tab);
                if (!!currentTab) {
                    isVisible = currentTab.isVisible;
                }
            }
        });
        return isVisible;
    }
    getCurrentFieldFromTabById(container, fieldId) {
        const tabFields = Object.keys(container.field.fields).map(key => container.field.fields[key]);
        let currentField;
        for (const tabField of tabFields) {
            currentField = tabField.find((tab) => tab.id === fieldId);
            if (currentField) {
                return currentField;
            }
        }
        return null;
    }
    getFormTabContainers(form) {
        if (!!form) {
            return form.fields.filter(field => field.type === 'container' && field.tab);
        }
        return [];
    }
    getObjectValue(field, fieldId) {
        let value = '';
        if (field.value && field.value.name) {
            value = field.value.name;
        }
        else if (field.options) {
            const option = field.options.find((opt) => opt.id === field.value);
            if (option) {
                value = this.getValueFromOption(fieldId, option);
            }
        }
        return value;
    }
    getValueFromOption(fieldId, option) {
        let optionValue = '';
        if (fieldId && fieldId.indexOf('_LABEL') > 0) {
            optionValue = option.name;
        }
        else {
            optionValue = option.id;
        }
        return optionValue;
    }
    isSearchedField(field, fieldId) {
        const fieldToFind = (fieldId === null || fieldId === void 0 ? void 0 : fieldId.indexOf('_LABEL')) > 0 ? fieldId.replace('_LABEL', '') : fieldId;
        return (field.id && fieldToFind) ? field.id.toUpperCase() === fieldToFind.toUpperCase() : false;
    }
    getVariableValue(form, name, processVarList) {
        const processVariableValue = this.getProcessVariableValue(name, processVarList);
        const variableDefaultValue = form.getFormVariableValue(name);
        return (processVariableValue === undefined) ? variableDefaultValue : processVariableValue;
    }
    getProcessVariableValue(name, processVarList) {
        if (processVarList) {
            const processVariable = processVarList.find(variable => variable.id === name ||
                variable.id === `variables.${name}`);
            if (processVariable) {
                return processVariable.value;
            }
        }
        return undefined;
    }
    evaluateCondition(leftValue, rightValue, operator) {
        switch (operator) {
            case '==':
                return leftValue + '' === rightValue + '';
            case '<':
                return leftValue < rightValue;
            case '!=':
                return leftValue + '' !== rightValue + '';
            case '>':
                return leftValue > rightValue;
            case '>=':
                return leftValue >= rightValue;
            case '<=':
                return leftValue <= rightValue;
            case 'empty':
                return leftValue ? leftValue === '' : true;
            case '!empty':
                return leftValue ? leftValue !== '' : false;
            case 'contains':
                return this.contains(leftValue, rightValue);
            case '!contains':
                return !this.contains(leftValue, rightValue);
            default:
                this.logService.error(`Invalid operator: ${operator}`);
                return undefined;
        }
    }
    contains(leftValue, rightValue) {
        return Array.isArray(leftValue) && Array.isArray(rightValue) && rightValue.every((element) => leftValue.includes(element));
    }
    cleanProcessVariable() {
        this.processVarList = [];
    }
    getTaskProcessVariable(taskId) {
        return from(this.taskFormsApi.getTaskFormVariables(taskId))
            .pipe(map((res) => {
            const jsonRes = this.toJson(res);
            this.processVarList = jsonRes;
            return jsonRes;
        }), catchError(() => this.handleError()));
    }
    toJson(res) {
        return res || {};
    }
    isValidCondition(condition) {
        return !!(condition && condition.operator);
    }
    handleError() {
        this.logService.error('Error while performing a call');
        return throwError('Error while performing a call - Server error');
    }
}
WidgetVisibilityService.ɵfac = function WidgetVisibilityService_Factory(t) { return new (t || WidgetVisibilityService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc2.LogService)); };
WidgetVisibilityService.ɵprov = i0.ɵɵdefineInjectable({ factory: function WidgetVisibilityService_Factory() { return new WidgetVisibilityService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i2.LogService)); }, token: WidgetVisibilityService, providedIn: "root" });
WidgetVisibilityService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: LogService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(WidgetVisibilityService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc2.LogService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0LXZpc2liaWxpdHkuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvcmUvZm9ybS9zZXJ2aWNlcy93aWRnZXQtdmlzaWJpbGl0eS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUN6RSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLE1BQU0sTUFBTSxZQUFZLENBQUM7QUFDaEMsT0FBTyxFQUFjLElBQUksRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFTcEQsT0FBTyxFQUF5QixjQUFjLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUMxRixPQUFPLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNoRDtBQUVzQjtBQUlQOzs7O0FBRmYsTUFBTSxPQUFPLHVCQUF1QjtBQUNwQyxJQVVJLFlBQW9CLFVBQThCLEVBQzlCLFVBQXNCO0FBQzlDLFFBRndCLGVBQVUsR0FBVixVQUFVLENBQW9CO0FBQUMsUUFDL0IsZUFBVSxHQUFWLFVBQVUsQ0FBWTtBQUFDLElBQzNDLENBQUM7QUFDTCxJQVhJLElBQUksWUFBWTtBQUFLO0FBQ3ZCLFFBQU0sSUFBSSxDQUFDLGFBQWEsU0FBRyxJQUFJLENBQUMsYUFBYSxtQ0FBSSxJQUFJLFlBQVksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7QUFDbkcsUUFBUSxPQUFPLElBQUksQ0FBQyxhQUFhLENB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QVEsT0FBTyxVQUFVLENBQUMsOENBQThDLENBQUMsQ0FBQztBQUMxRSxJQUFJLENBQUM7QUFDTDswTUFBQztBQUNELDJRQXpVSztBQUFDO0VBSEwsVUFBVSxTQUFDLHJCQUtHLFlBdEJOLGtCQUFrQjtLQWtCdkIsVUFBVSxFQUFFLE1BQU0sdkJBbEJTLFlBQ3RCLFVBQVU7QUFBRztTQWtCckI7Ozs7O2dIQWxCdUI7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2FsZnJlc2NvLWFwaS5zZXJ2aWNlJztcbmltcG9ydCB7IExvZ1NlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9sb2cuc2VydmljZSc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudC1lczYnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgICBGb3JtRmllbGRNb2RlbCxcbiAgICBGb3JtTW9kZWwsXG4gICAgVGFiTW9kZWwsXG4gICAgQ29udGFpbmVyTW9kZWwsXG4gICAgRm9ybU91dGNvbWVNb2RlbFxufSBmcm9tICcuLi9jb21wb25lbnRzL3dpZGdldHMvY29yZS9pbmRleCc7XG5pbXBvcnQgeyBUYXNrUHJvY2Vzc1ZhcmlhYmxlTW9kZWwgfSBmcm9tICcuLi9tb2RlbHMvdGFzay1wcm9jZXNzLXZhcmlhYmxlLm1vZGVsJztcbmltcG9ydCB7IFdpZGdldFZpc2liaWxpdHlNb2RlbCwgV2lkZ2V0VHlwZUVudW0gfSBmcm9tICcuLi9tb2RlbHMvd2lkZ2V0LXZpc2liaWxpdHkubW9kZWwnO1xuaW1wb3J0IHsgbWFwLCBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgVGFza0Zvcm1zQXBpIH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgV2lkZ2V0VmlzaWJpbGl0eVNlcnZpY2Uge1xuXG4gICAgX3Rhc2tGb3Jtc0FwaTogVGFza0Zvcm1zQXBpO1xuICAgIGdldCB0YXNrRm9ybXNBcGkoKTogVGFza0Zvcm1zQXBpIHtcbiAgICAgICAgdGhpcy5fdGFza0Zvcm1zQXBpID0gdGhpcy5fdGFza0Zvcm1zQXBpID8/IG5ldyBUYXNrRm9ybXNBcGkodGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy5fdGFza0Zvcm1zQXBpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcHJvY2Vzc1Zhckxpc3Q6IFRhc2tQcm9jZXNzVmFyaWFibGVNb2RlbFtdO1xuICAgIHByaXZhdGUgZm9ybTogRm9ybU1vZGVsO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgcHVibGljIHJlZnJlc2hWaXNpYmlsaXR5KGZvcm06IEZvcm1Nb2RlbCwgcHJvY2Vzc1Zhckxpc3Q/OiBUYXNrUHJvY2Vzc1ZhcmlhYmxlTW9kZWxbXSkge1xuICAgICAgICB0aGlzLmZvcm0gPSBmb3JtO1xuICAgICAgICBpZiAocHJvY2Vzc1Zhckxpc3QpIHtcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1Zhckxpc3QgPSBwcm9jZXNzVmFyTGlzdDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZm9ybSAmJiBmb3JtLnRhYnMgJiYgZm9ybS50YWJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGZvcm0udGFicy5tYXAoKHRhYk1vZGVsKSA9PiB0aGlzLnJlZnJlc2hFbnRpdHlWaXNpYmlsaXR5KHRhYk1vZGVsKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZm9ybSAmJiBmb3JtLm91dGNvbWVzICYmIGZvcm0ub3V0Y29tZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgZm9ybS5vdXRjb21lcy5tYXAoKG91dGNvbWVNb2RlbCkgPT4gdGhpcy5yZWZyZXNoT3V0Y29tZVZpc2liaWxpdHkob3V0Y29tZU1vZGVsKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZm9ybSkge1xuICAgICAgICAgICAgZm9ybS5nZXRGb3JtRmllbGRzKCkubWFwKChmaWVsZCkgPT4gdGhpcy5yZWZyZXNoRW50aXR5VmlzaWJpbGl0eShmaWVsZCkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVmcmVzaEVudGl0eVZpc2liaWxpdHkoZWxlbWVudDogRm9ybUZpZWxkTW9kZWwgfCBUYWJNb2RlbCkge1xuICAgICAgICBjb25zdCB2aXNpYmxlID0gdGhpcy5ldmFsdWF0ZVZpc2liaWxpdHkoZWxlbWVudC5mb3JtLCBlbGVtZW50LnZpc2liaWxpdHlDb25kaXRpb24pO1xuICAgICAgICBlbGVtZW50LmlzVmlzaWJsZSA9IHZpc2libGUgJiYgdGhpcy5pc1BhcmVudFRhYlZpc2libGUodGhpcy5mb3JtLCBlbGVtZW50KTtcbiAgICB9XG5cbiAgICByZWZyZXNoT3V0Y29tZVZpc2liaWxpdHkoZWxlbWVudDogRm9ybU91dGNvbWVNb2RlbCkge1xuICAgICAgICBlbGVtZW50LmlzVmlzaWJsZSA9IHRoaXMuZXZhbHVhdGVWaXNpYmlsaXR5KGVsZW1lbnQuZm9ybSwgZWxlbWVudC52aXNpYmlsaXR5Q29uZGl0aW9uKTtcbiAgICB9XG5cbiAgICBldmFsdWF0ZVZpc2liaWxpdHkoZm9ybTogRm9ybU1vZGVsLCB2aXNpYmlsaXR5T2JqOiBXaWRnZXRWaXNpYmlsaXR5TW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgaXNMZWZ0RmllbGRQcmVzZW50ID0gdmlzaWJpbGl0eU9iaiAmJiAodmlzaWJpbGl0eU9iai5sZWZ0VHlwZSB8fCB2aXNpYmlsaXR5T2JqLmxlZnRWYWx1ZSk7XG4gICAgICAgIGlmICghaXNMZWZ0RmllbGRQcmVzZW50IHx8IGlzTGVmdEZpZWxkUHJlc2VudCA9PT0gJ251bGwnKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmlzRmllbGRWaXNpYmxlKGZvcm0sIHZpc2liaWxpdHlPYmopO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaXNGaWVsZFZpc2libGUoZm9ybTogRm9ybU1vZGVsLCB2aXNpYmlsaXR5T2JqOiBXaWRnZXRWaXNpYmlsaXR5TW9kZWwsIGFjY3VtdWxhdG9yOiBhbnlbXSA9IFtdLCByZXN1bHQ6IGJvb2xlYW4gPSBmYWxzZSk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBsZWZ0VmFsdWUgPSB0aGlzLmdldExlZnRWYWx1ZShmb3JtLCB2aXNpYmlsaXR5T2JqKTtcbiAgICAgICAgY29uc3QgcmlnaHRWYWx1ZSA9IHRoaXMuZ2V0UmlnaHRWYWx1ZShmb3JtLCB2aXNpYmlsaXR5T2JqKTtcbiAgICAgICAgY29uc3QgYWN0dWFsUmVzdWx0ID0gdGhpcy5ldmFsdWF0ZUNvbmRpdGlvbihsZWZ0VmFsdWUsIHJpZ2h0VmFsdWUsIHZpc2liaWxpdHlPYmoub3BlcmF0b3IpO1xuXG4gICAgICAgIGFjY3VtdWxhdG9yLnB1c2goeyB2YWx1ZTogYWN0dWFsUmVzdWx0LCBvcGVyYXRvcjogdmlzaWJpbGl0eU9iai5uZXh0Q29uZGl0aW9uT3BlcmF0b3IgfSk7XG5cbiAgICAgICAgaWYgKHRoaXMuaXNWYWxpZENvbmRpdGlvbih2aXNpYmlsaXR5T2JqLm5leHRDb25kaXRpb24pKSB7XG4gICAgICAgICAgICByZXN1bHQgPSB0aGlzLmlzRmllbGRWaXNpYmxlKGZvcm0sIHZpc2liaWxpdHlPYmoubmV4dENvbmRpdGlvbiwgYWNjdW11bGF0b3IpO1xuICAgICAgICB9IGVsc2UgaWYgKGFjY3VtdWxhdG9yWzBdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IEZ1bmN0aW9uKCdcInVzZSBzdHJpY3RcIjtyZXR1cm4gKCcgK1xuICAgICAgICAgICAgICAgICBhY2N1bXVsYXRvci5tYXAoKGV4cHJlc3Npb24pID0+IHRoaXMudHJhbnNmb3JtVG9MaXRlcmFsRXhwcmVzc2lvbihleHByZXNzaW9uKSkuam9pbignJykgK1xuICAgICAgICAgICAgICAgICcpJykoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IGFjdHVhbFJlc3VsdDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gISFyZXN1bHQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0cmFuc2Zvcm1Ub0xpdGVyYWxFeHByZXNzaW9uKGN1cnJlbnRFeHByZXNzaW9uOiBhbnkpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBjdXJyZW50VHJhbnNmb3JtZWRWYWx1ZSA9ICEhY3VycmVudEV4cHJlc3Npb24udmFsdWUgPyAndHJ1ZScgOiAnZmFsc2UnO1xuICAgICAgICByZXR1cm4gY3VycmVudFRyYW5zZm9ybWVkVmFsdWUuY29uY2F0KHRoaXMudHJhbnNmb3JtVG9MaXRlcmFsT3BlcmF0b3IoY3VycmVudEV4cHJlc3Npb24ub3BlcmF0b3IpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHRyYW5zZm9ybVRvTGl0ZXJhbE9wZXJhdG9yKGN1cnJlbnRPcGVyYXRvcik6IHN0cmluZyB7XG4gICAgICAgIHN3aXRjaCAoY3VycmVudE9wZXJhdG9yKSB7XG4gICAgICAgICAgICBjYXNlICdhbmQnOlxuICAgICAgICAgICAgICAgIHJldHVybiAnJiYnO1xuICAgICAgICAgICAgY2FzZSAnb3InIDpcbiAgICAgICAgICAgICAgICByZXR1cm4gJ3x8JztcbiAgICAgICAgICAgIGNhc2UgJ2FuZC1ub3QnOlxuICAgICAgICAgICAgICAgIHJldHVybiAnJiYgISc7XG4gICAgICAgICAgICBjYXNlICdvci1ub3QnOlxuICAgICAgICAgICAgICAgIHJldHVybiAnfHwgISc7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldExlZnRWYWx1ZShmb3JtOiBGb3JtTW9kZWwsIHZpc2liaWxpdHlPYmo6IFdpZGdldFZpc2liaWxpdHlNb2RlbCk6IHN0cmluZyB7XG4gICAgICAgIGxldCBsZWZ0VmFsdWUgPSAnJztcbiAgICAgICAgaWYgKHZpc2liaWxpdHlPYmoubGVmdFR5cGUgJiYgdmlzaWJpbGl0eU9iai5sZWZ0VHlwZSA9PT0gV2lkZ2V0VHlwZUVudW0udmFyaWFibGUpIHtcbiAgICAgICAgICAgIGxlZnRWYWx1ZSA9IHRoaXMuZ2V0VmFyaWFibGVWYWx1ZShmb3JtLCB2aXNpYmlsaXR5T2JqLmxlZnRWYWx1ZSwgdGhpcy5wcm9jZXNzVmFyTGlzdCk7XG4gICAgICAgIH0gZWxzZSBpZiAodmlzaWJpbGl0eU9iai5sZWZ0VHlwZSAmJiB2aXNpYmlsaXR5T2JqLmxlZnRUeXBlID09PSBXaWRnZXRUeXBlRW51bS5maWVsZCkge1xuICAgICAgICAgICAgbGVmdFZhbHVlID0gdGhpcy5nZXRGb3JtVmFsdWUoZm9ybSwgdmlzaWJpbGl0eU9iai5sZWZ0VmFsdWUpO1xuICAgICAgICAgICAgaWYgKGxlZnRWYWx1ZSA9PT0gdW5kZWZpbmVkIHx8IGxlZnRWYWx1ZSA9PT0gJycpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB2YXJpYWJsZVZhbHVlID0gdGhpcy5nZXRWYXJpYWJsZVZhbHVlKGZvcm0sIHZpc2liaWxpdHlPYmoubGVmdFZhbHVlLCB0aGlzLnByb2Nlc3NWYXJMaXN0KTtcbiAgICAgICAgICAgICAgICBsZWZ0VmFsdWUgPSAhdGhpcy5pc0ludmFsaWRWYWx1ZSh2YXJpYWJsZVZhbHVlKSA/IHZhcmlhYmxlVmFsdWUgOiBsZWZ0VmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGxlZnRWYWx1ZTtcbiAgICB9XG5cbiAgICBnZXRSaWdodFZhbHVlKGZvcm06IEZvcm1Nb2RlbCwgdmlzaWJpbGl0eU9iajogV2lkZ2V0VmlzaWJpbGl0eU1vZGVsKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IHZhbHVlRm91bmQgPSAnJztcbiAgICAgICAgaWYgKHZpc2liaWxpdHlPYmoucmlnaHRUeXBlID09PSBXaWRnZXRUeXBlRW51bS52YXJpYWJsZSkge1xuICAgICAgICAgICAgdmFsdWVGb3VuZCA9IHRoaXMuZ2V0VmFyaWFibGVWYWx1ZShmb3JtLCB2aXNpYmlsaXR5T2JqLnJpZ2h0VmFsdWUsIHRoaXMucHJvY2Vzc1Zhckxpc3QpO1xuICAgICAgICB9IGVsc2UgaWYgKHZpc2liaWxpdHlPYmoucmlnaHRUeXBlID09PSBXaWRnZXRUeXBlRW51bS5maWVsZCkge1xuICAgICAgICAgICAgdmFsdWVGb3VuZCA9IHRoaXMuZ2V0Rm9ybVZhbHVlKGZvcm0sIHZpc2liaWxpdHlPYmoucmlnaHRWYWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAobW9tZW50KHZpc2liaWxpdHlPYmoucmlnaHRWYWx1ZSwgJ1lZWVktTU0tREQnLCB0cnVlKS5pc1ZhbGlkKCkpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZUZvdW5kID0gdmlzaWJpbGl0eU9iai5yaWdodFZhbHVlICsgJ1QwMDowMDowMC4wMDBaJztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFsdWVGb3VuZCA9IHZpc2liaWxpdHlPYmoucmlnaHRWYWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdmFsdWVGb3VuZDtcbiAgICB9XG5cbiAgICBnZXRGb3JtVmFsdWUoZm9ybTogRm9ybU1vZGVsLCBmaWVsZElkOiBzdHJpbmcpOiBhbnkge1xuICAgICAgICBjb25zdCBmb3JtRmllbGQgPSB0aGlzLmdldEZvcm1GaWVsZEJ5SWQoZm9ybSwgZmllbGRJZCk7XG4gICAgICAgIGxldCB2YWx1ZSA9IHVuZGVmaW5lZDtcblxuICAgICAgICBpZiAodGhpcy5pc0Zvcm1GaWVsZFZhbGlkKGZvcm1GaWVsZCkpIHtcbiAgICAgICAgICAgIHZhbHVlID0gdGhpcy5nZXRGaWVsZFZhbHVlKGZvcm0udmFsdWVzLCBmaWVsZElkKTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuaXNJbnZhbGlkVmFsdWUodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLnNlYXJjaFZhbHVlSW5Gb3JtKGZvcm1GaWVsZCwgZmllbGRJZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIGlzRm9ybUZpZWxkVmFsaWQoZm9ybUZpZWxkOiBGb3JtRmllbGRNb2RlbCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gZm9ybUZpZWxkICYmIGZvcm1GaWVsZC5pc1ZhbGlkO1xuICAgIH1cblxuICAgIGdldEZpZWxkVmFsdWUodmFsdWVMaXN0OiBhbnksIGZpZWxkSWQ6IHN0cmluZyk6IGFueSB7XG4gICAgICAgIGxldCBsYWJlbEZpbHRlckJ5TmFtZSwgdmFsdWVGb3VuZDtcbiAgICAgICAgaWYgKGZpZWxkSWQgJiYgZmllbGRJZC5pbmRleE9mKCdfTEFCRUwnKSA+IDApIHtcbiAgICAgICAgICAgIGxhYmVsRmlsdGVyQnlOYW1lID0gZmllbGRJZC5zdWJzdHJpbmcoMCwgZmllbGRJZC5sZW5ndGggLSA2KTtcbiAgICAgICAgICAgIGlmICh2YWx1ZUxpc3RbbGFiZWxGaWx0ZXJCeU5hbWVdKSB7XG4gICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWVMaXN0W2xhYmVsRmlsdGVyQnlOYW1lXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVGb3VuZCA9IHZhbHVlTGlzdFtsYWJlbEZpbHRlckJ5TmFtZV0ubWFwKCh7bmFtZX0pID0+IG5hbWUpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2YWx1ZUxpc3RbbGFiZWxGaWx0ZXJCeU5hbWVdLm5hbWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHZhbHVlTGlzdFtmaWVsZElkXSAmJiB2YWx1ZUxpc3RbZmllbGRJZF0uaWQpIHtcbiAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2YWx1ZUxpc3RbZmllbGRJZF0uaWQ7XG4gICAgICAgIH0gZWxzZSBpZiAodmFsdWVMaXN0W2ZpZWxkSWRdICYmIEFycmF5LmlzQXJyYXkodmFsdWVMaXN0W2ZpZWxkSWRdKSkge1xuICAgICAgICAgICAgdmFsdWVGb3VuZCA9IHZhbHVlTGlzdFtmaWVsZElkXS5tYXAoKHtpZH0pID0+IGlkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2YWx1ZUxpc3RbZmllbGRJZF07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlRm91bmQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc0ludmFsaWRWYWx1ZSh2YWx1ZTogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsO1xuICAgIH1cblxuICAgIGdldEZvcm1GaWVsZEJ5SWQoZm9ybTogRm9ybU1vZGVsLCBmaWVsZElkOiBzdHJpbmcpOiBGb3JtRmllbGRNb2RlbCB7XG4gICAgICAgIHJldHVybiBmb3JtLmdldEZvcm1GaWVsZHMoKS5maW5kKChmb3JtRmllbGQ6IEZvcm1GaWVsZE1vZGVsKSA9PiB0aGlzLmlzU2VhcmNoZWRGaWVsZChmb3JtRmllbGQsIGZpZWxkSWQpKTtcbiAgICB9XG5cbiAgICBzZWFyY2hWYWx1ZUluRm9ybShmb3JtRmllbGQ6IEZvcm1GaWVsZE1vZGVsLCBmaWVsZElkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBsZXQgZmllbGRWYWx1ZSA9ICcnO1xuXG4gICAgICAgIGlmIChmb3JtRmllbGQpIHtcbiAgICAgICAgICAgIGZpZWxkVmFsdWUgPSB0aGlzLmdldE9iamVjdFZhbHVlKGZvcm1GaWVsZCwgZmllbGRJZCk7XG5cbiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZSkge1xuICAgICAgICAgICAgICAgIGlmIChmb3JtRmllbGQudmFsdWUgJiYgZm9ybUZpZWxkLnZhbHVlLmlkKSB7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkVmFsdWUgPSBmb3JtRmllbGQudmFsdWUuaWQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5pc0ludmFsaWRWYWx1ZShmb3JtRmllbGQudmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkVmFsdWUgPSBmb3JtRmllbGQudmFsdWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmaWVsZFZhbHVlO1xuICAgIH1cblxuICAgIGlzUGFyZW50VGFiVmlzaWJsZShmb3JtOiBGb3JtTW9kZWwsIGN1cnJlbnRGb3JtRmllbGQ6IEZvcm1GaWVsZE1vZGVsIHwgVGFiTW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgY29udGFpbmVycyA9IHRoaXMuZ2V0Rm9ybVRhYkNvbnRhaW5lcnMoZm9ybSk7XG4gICAgICAgIGxldCBpc1Zpc2libGU6IGJvb2xlYW4gPSB0cnVlO1xuICAgICAgICBjb250YWluZXJzLm1hcCgoY29udGFpbmVyOiBDb250YWluZXJNb2RlbCkgPT4ge1xuICAgICAgICAgICAgaWYgKCEhdGhpcy5nZXRDdXJyZW50RmllbGRGcm9tVGFiQnlJZChjb250YWluZXIsIGN1cnJlbnRGb3JtRmllbGQuaWQpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFRhYiA9IGZvcm0udGFicy5maW5kKCh0YWI6IFRhYk1vZGVsKSA9PiB0YWIuaWQgPT09IGNvbnRhaW5lci50YWIpO1xuICAgICAgICAgICAgICAgIGlmICghIWN1cnJlbnRUYWIpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNWaXNpYmxlID0gY3VycmVudFRhYi5pc1Zpc2libGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGlzVmlzaWJsZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEN1cnJlbnRGaWVsZEZyb21UYWJCeUlkKGNvbnRhaW5lcjogQ29udGFpbmVyTW9kZWwsIGZpZWxkSWQ6IHN0cmluZyk6IEZvcm1GaWVsZE1vZGVsIHtcbiAgICAgICAgY29uc3QgdGFiRmllbGRzOiBGb3JtRmllbGRNb2RlbFtdW10gPSBPYmplY3Qua2V5cyhjb250YWluZXIuZmllbGQuZmllbGRzKS5tYXAoa2V5ID0+IGNvbnRhaW5lci5maWVsZC5maWVsZHNba2V5XSk7XG4gICAgICAgIGxldCBjdXJyZW50RmllbGQ6IEZvcm1GaWVsZE1vZGVsO1xuXG4gICAgICAgIGZvciAoY29uc3QgdGFiRmllbGQgb2YgdGFiRmllbGRzKSB7XG4gICAgICAgICAgICBjdXJyZW50RmllbGQgPSB0YWJGaWVsZC5maW5kKCh0YWI6IEZvcm1GaWVsZE1vZGVsKSA9PiB0YWIuaWQgPT09IGZpZWxkSWQpO1xuICAgICAgICAgICAgaWYgKGN1cnJlbnRGaWVsZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50RmllbGQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRGb3JtVGFiQ29udGFpbmVycyhmb3JtOiBGb3JtTW9kZWwpOiBDb250YWluZXJNb2RlbFtdIHtcbiAgICAgICAgaWYgKCEhZm9ybSkge1xuICAgICAgICAgICAgcmV0dXJuIDxDb250YWluZXJNb2RlbFtdPiBmb3JtLmZpZWxkcy5maWx0ZXIoZmllbGQgPT4gZmllbGQudHlwZSA9PT0gJ2NvbnRhaW5lcicgJiYgZmllbGQudGFiKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRPYmplY3RWYWx1ZShmaWVsZDogRm9ybUZpZWxkTW9kZWwsIGZpZWxkSWQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGxldCB2YWx1ZSA9ICcnO1xuICAgICAgICBpZiAoZmllbGQudmFsdWUgJiYgZmllbGQudmFsdWUubmFtZSkge1xuICAgICAgICAgICAgdmFsdWUgPSBmaWVsZC52YWx1ZS5uYW1lO1xuICAgICAgICB9IGVsc2UgaWYgKGZpZWxkLm9wdGlvbnMpIHtcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbiA9IGZpZWxkLm9wdGlvbnMuZmluZCgob3B0KSA9PiBvcHQuaWQgPT09IGZpZWxkLnZhbHVlKTtcbiAgICAgICAgICAgIGlmIChvcHRpb24pIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWVGcm9tT3B0aW9uKGZpZWxkSWQsIG9wdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0VmFsdWVGcm9tT3B0aW9uKGZpZWxkSWQ6IHN0cmluZywgb3B0aW9uKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IG9wdGlvblZhbHVlID0gJyc7XG4gICAgICAgIGlmIChmaWVsZElkICYmIGZpZWxkSWQuaW5kZXhPZignX0xBQkVMJykgPiAwKSB7XG4gICAgICAgICAgICBvcHRpb25WYWx1ZSA9IG9wdGlvbi5uYW1lO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb3B0aW9uVmFsdWUgPSBvcHRpb24uaWQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG9wdGlvblZhbHVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNTZWFyY2hlZEZpZWxkKGZpZWxkOiBGb3JtRmllbGRNb2RlbCwgZmllbGRJZDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGZpZWxkVG9GaW5kID0gZmllbGRJZD8uaW5kZXhPZignX0xBQkVMJykgPiAwID8gZmllbGRJZC5yZXBsYWNlKCdfTEFCRUwnLCAnJykgOiBmaWVsZElkO1xuICAgICAgICByZXR1cm4gKGZpZWxkLmlkICYmIGZpZWxkVG9GaW5kKSA/IGZpZWxkLmlkLnRvVXBwZXJDYXNlKCkgPT09IGZpZWxkVG9GaW5kLnRvVXBwZXJDYXNlKCkgOiBmYWxzZTtcbiAgICB9XG5cbiAgICBnZXRWYXJpYWJsZVZhbHVlKGZvcm06IEZvcm1Nb2RlbCwgbmFtZTogc3RyaW5nLCBwcm9jZXNzVmFyTGlzdDogVGFza1Byb2Nlc3NWYXJpYWJsZU1vZGVsW10pOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBwcm9jZXNzVmFyaWFibGVWYWx1ZSA9IHRoaXMuZ2V0UHJvY2Vzc1ZhcmlhYmxlVmFsdWUobmFtZSwgcHJvY2Vzc1Zhckxpc3QpO1xuICAgICAgICBjb25zdCB2YXJpYWJsZURlZmF1bHRWYWx1ZSA9IGZvcm0uZ2V0Rm9ybVZhcmlhYmxlVmFsdWUobmFtZSk7XG5cbiAgICAgICAgcmV0dXJuIChwcm9jZXNzVmFyaWFibGVWYWx1ZSA9PT0gdW5kZWZpbmVkKSA/IHZhcmlhYmxlRGVmYXVsdFZhbHVlIDogcHJvY2Vzc1ZhcmlhYmxlVmFsdWU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRQcm9jZXNzVmFyaWFibGVWYWx1ZShuYW1lOiBzdHJpbmcsIHByb2Nlc3NWYXJMaXN0OiBUYXNrUHJvY2Vzc1ZhcmlhYmxlTW9kZWxbXSk6IHN0cmluZyB7XG4gICAgICAgIGlmIChwcm9jZXNzVmFyTGlzdCkge1xuICAgICAgICAgICAgY29uc3QgcHJvY2Vzc1ZhcmlhYmxlID0gcHJvY2Vzc1Zhckxpc3QuZmluZChcbiAgICAgICAgICAgICAgICB2YXJpYWJsZSA9PlxuICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZS5pZCA9PT0gbmFtZSB8fFxuICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZS5pZCA9PT0gYHZhcmlhYmxlcy4ke25hbWV9YFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgaWYgKHByb2Nlc3NWYXJpYWJsZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBwcm9jZXNzVmFyaWFibGUudmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBldmFsdWF0ZUNvbmRpdGlvbihsZWZ0VmFsdWU6IGFueSwgcmlnaHRWYWx1ZTogYW55LCBvcGVyYXRvcjogc3RyaW5nKTogYm9vbGVhbiB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHN3aXRjaCAob3BlcmF0b3IpIHtcbiAgICAgICAgICAgIGNhc2UgJz09JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFZhbHVlICsgJycgPT09IHJpZ2h0VmFsdWUgKyAnJztcbiAgICAgICAgICAgIGNhc2UgJzwnOlxuICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0VmFsdWUgPCByaWdodFZhbHVlO1xuICAgICAgICAgICAgY2FzZSAnIT0nOlxuICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0VmFsdWUgKyAnJyAhPT0gcmlnaHRWYWx1ZSArICcnO1xuICAgICAgICAgICAgY2FzZSAnPic6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRWYWx1ZSA+IHJpZ2h0VmFsdWU7XG4gICAgICAgICAgICBjYXNlICc+PSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRWYWx1ZSA+PSByaWdodFZhbHVlO1xuICAgICAgICAgICAgY2FzZSAnPD0nOlxuICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0VmFsdWUgPD0gcmlnaHRWYWx1ZTtcbiAgICAgICAgICAgIGNhc2UgJ2VtcHR5JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFZhbHVlID8gbGVmdFZhbHVlID09PSAnJyA6IHRydWU7XG4gICAgICAgICAgICBjYXNlICchZW1wdHknOlxuICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0VmFsdWUgPyBsZWZ0VmFsdWUgIT09ICcnIDogZmFsc2U7XG4gICAgICAgICAgICBjYXNlICdjb250YWlucyc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29udGFpbnMobGVmdFZhbHVlLCByaWdodFZhbHVlKTtcbiAgICAgICAgICAgIGNhc2UgJyFjb250YWlucyc6XG4gICAgICAgICAgICAgICAgcmV0dXJuICF0aGlzLmNvbnRhaW5zKGxlZnRWYWx1ZSwgcmlnaHRWYWx1ZSk7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcihgSW52YWxpZCBvcGVyYXRvcjogJHtvcGVyYXRvcn1gKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb250YWlucyhsZWZ0VmFsdWU6IGFueSwgcmlnaHRWYWx1ZTogYW55KSB7XG4gICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KGxlZnRWYWx1ZSkgJiYgQXJyYXkuaXNBcnJheShyaWdodFZhbHVlKSAmJiByaWdodFZhbHVlLmV2ZXJ5KChlbGVtZW50KSA9PiBsZWZ0VmFsdWUuaW5jbHVkZXMoZWxlbWVudCkpO1xuICAgIH1cblxuICAgIGNsZWFuUHJvY2Vzc1ZhcmlhYmxlKCkge1xuICAgICAgICB0aGlzLnByb2Nlc3NWYXJMaXN0ID0gW107XG4gICAgfVxuXG4gICAgZ2V0VGFza1Byb2Nlc3NWYXJpYWJsZSh0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza1Byb2Nlc3NWYXJpYWJsZU1vZGVsW10+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy50YXNrRm9ybXNBcGkuZ2V0VGFza0Zvcm1WYXJpYWJsZXModGFza0lkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGpzb25SZXMgPSB0aGlzLnRvSnNvbihyZXMpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NWYXJMaXN0ID0gPFRhc2tQcm9jZXNzVmFyaWFibGVNb2RlbFtdPiBqc29uUmVzO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ganNvblJlcztcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IHRoaXMuaGFuZGxlRXJyb3IoKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgdG9Kc29uKHJlczogYW55KTogYW55IHtcbiAgICAgICAgcmV0dXJuIHJlcyB8fCB7fTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzVmFsaWRDb25kaXRpb24oY29uZGl0aW9uOiBXaWRnZXRWaXNpYmlsaXR5TW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICEhKGNvbmRpdGlvbiAmJiBjb25kaXRpb24ub3BlcmF0b3IpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlRXJyb3IoKSB7XG4gICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcignRXJyb3Igd2hpbGUgcGVyZm9ybWluZyBhIGNhbGwnKTtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ0Vycm9yIHdoaWxlIHBlcmZvcm1pbmcgYSBjYWxsIC0gU2VydmVyIGVycm9yJyk7XG4gICAgfVxufVxuIl19