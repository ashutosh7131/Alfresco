import { AlfrescoApiService } from '../../services/alfresco-api.service';
import { LogService } from '../../services/log.service';
import { Injectable } from '@angular/core';
import moment from 'moment-es6';
import { from, throwError } from 'rxjs';
import { WidgetTypeEnum } from '../models/widget-visibility.model';
import { map, catchError } from 'rxjs/operators';
import { TaskFormsApi } from '@alfresco/js-api';
import * as i0 from "@angular/core";
import * as i1 from "../../services/alfresco-api.service";
import * as i2 from "../../services/log.service";
export class WidgetVisibilityService {
    constructor(apiService, logService) {
        this.apiService = apiService;
        this.logService = logService;
    }
    get taskFormsApi() {
        var _a;
        this._taskFormsApi = (_a = this._taskFormsApi) !== null && _a !== void 0 ? _a : new TaskFormsApi(this.apiService.getInstance());
        return this._taskFormsApi;
    }
    refreshVisibility(form, processVarList) {
        this.form = form;
        if (processVarList) {
            this.processVarList = processVarList;
        }
        if (form && form.tabs && form.tabs.length > 0) {
            form.tabs.map((tabModel) => this.refreshEntityVisibility(tabModel));
        }
        if (form && form.outcomes && form.outcomes.length > 0) {
            form.outcomes.map((outcomeModel) => this.refreshOutcomeVisibility(outcomeModel));
        }
        if (form) {
            form.getFormFields().map((field) => this.refreshEntityVisibility(field));
        }
    }
    refreshEntityVisibility(element) {
        const visible = this.evaluateVisibility(element.form, element.visibilityCondition);
        element.isVisible = visible && this.isParentTabVisible(this.form, element);
    }
    refreshOutcomeVisibility(element) {
        element.isVisible = this.evaluateVisibility(element.form, element.visibilityCondition);
    }
    evaluateVisibility(form, visibilityObj) {
        const isLeftFieldPresent = visibilityObj && (visibilityObj.leftType || visibilityObj.leftValue);
        if (!isLeftFieldPresent || isLeftFieldPresent === 'null') {
            return true;
        }
        else {
            return this.isFieldVisible(form, visibilityObj);
        }
    }
    isFieldVisible(form, visibilityObj, accumulator = [], result = false) {
        const leftValue = this.getLeftValue(form, visibilityObj);
        const rightValue = this.getRightValue(form, visibilityObj);
        const actualResult = this.evaluateCondition(leftValue, rightValue, visibilityObj.operator);
        accumulator.push({ value: actualResult, operator: visibilityObj.nextConditionOperator });
        if (this.isValidCondition(visibilityObj.nextCondition)) {
            result = this.isFieldVisible(form, visibilityObj.nextCondition, accumulator);
        }
        else if (accumulator[0] !== undefined) {
            result = Function('"use strict";return (' +
                accumulator.map((expression) => this.transformToLiteralExpression(expression)).join('') +
                ')')();
        }
        else {
            result = actualResult;
        }
        return !!result;
    }
    transformToLiteralExpression(currentExpression) {
        const currentTransformedValue = !!currentExpression.value ? 'true' : 'false';
        return currentTransformedValue.concat(this.transformToLiteralOperator(currentExpression.operator));
    }
    transformToLiteralOperator(currentOperator) {
        switch (currentOperator) {
            case 'and':
                return '&&';
            case 'or':
                return '||';
            case 'and-not':
                return '&& !';
            case 'or-not':
                return '|| !';
            default:
                return '';
        }
    }
    getLeftValue(form, visibilityObj) {
        let leftValue = '';
        if (visibilityObj.leftType && visibilityObj.leftType === WidgetTypeEnum.variable) {
            leftValue = this.getVariableValue(form, visibilityObj.leftValue, this.processVarList);
        }
        else if (visibilityObj.leftType && visibilityObj.leftType === WidgetTypeEnum.field) {
            leftValue = this.getFormValue(form, visibilityObj.leftValue);
            if (leftValue === undefined || leftValue === '') {
                const variableValue = this.getVariableValue(form, visibilityObj.leftValue, this.processVarList);
                leftValue = !this.isInvalidValue(variableValue) ? variableValue : leftValue;
            }
        }
        return leftValue;
    }
    getRightValue(form, visibilityObj) {
        let valueFound = '';
        if (visibilityObj.rightType === WidgetTypeEnum.variable) {
            valueFound = this.getVariableValue(form, visibilityObj.rightValue, this.processVarList);
        }
        else if (visibilityObj.rightType === WidgetTypeEnum.field) {
            valueFound = this.getFormValue(form, visibilityObj.rightValue);
        }
        else {
            if (moment(visibilityObj.rightValue, 'YYYY-MM-DD', true).isValid()) {
                valueFound = visibilityObj.rightValue + 'T00:00:00.000Z';
            }
            else {
                valueFound = visibilityObj.rightValue;
            }
        }
        return valueFound;
    }
    getFormValue(form, fieldId) {
        const formField = this.getFormFieldById(form, fieldId);
        let value = undefined;
        if (this.isFormFieldValid(formField)) {
            value = this.getFieldValue(form.values, fieldId);
            if (this.isInvalidValue(value)) {
                value = this.searchValueInForm(formField, fieldId);
            }
        }
        return value;
    }
    isFormFieldValid(formField) {
        return formField && formField.isValid;
    }
    getFieldValue(valueList, fieldId) {
        let labelFilterByName, valueFound;
        if (fieldId && fieldId.indexOf('_LABEL') > 0) {
            labelFilterByName = fieldId.substring(0, fieldId.length - 6);
            if (valueList[labelFilterByName]) {
                if (Array.isArray(valueList[labelFilterByName])) {
                    valueFound = valueList[labelFilterByName].map(({ name }) => name);
                }
                else {
                    valueFound = valueList[labelFilterByName].name;
                }
            }
        }
        else if (valueList[fieldId] && valueList[fieldId].id) {
            valueFound = valueList[fieldId].id;
        }
        else if (valueList[fieldId] && Array.isArray(valueList[fieldId])) {
            valueFound = valueList[fieldId].map(({ id }) => id);
        }
        else {
            valueFound = valueList[fieldId];
        }
        return valueFound;
    }
    isInvalidValue(value) {
        return value === undefined || value === null;
    }
    getFormFieldById(form, fieldId) {
        return form.getFormFields().find((formField) => this.isSearchedField(formField, fieldId));
    }
    searchValueInForm(formField, fieldId) {
        let fieldValue = '';
        if (formField) {
            fieldValue = this.getObjectValue(formField, fieldId);
            if (!fieldValue) {
                if (formField.value && formField.value.id) {
                    fieldValue = formField.value.id;
                }
                else if (!this.isInvalidValue(formField.value)) {
                    fieldValue = formField.value;
                }
            }
        }
        return fieldValue;
    }
    isParentTabVisible(form, currentFormField) {
        const containers = this.getFormTabContainers(form);
        let isVisible = true;
        containers.map((container) => {
            if (!!this.getCurrentFieldFromTabById(container, currentFormField.id)) {
                const currentTab = form.tabs.find((tab) => tab.id === container.tab);
                if (!!currentTab) {
                    isVisible = currentTab.isVisible;
                }
            }
        });
        return isVisible;
    }
    getCurrentFieldFromTabById(container, fieldId) {
        const tabFields = Object.keys(container.field.fields).map(key => container.field.fields[key]);
        let currentField;
        for (const tabField of tabFields) {
            currentField = tabField.find((tab) => tab.id === fieldId);
            if (currentField) {
                return currentField;
            }
        }
        return null;
    }
    getFormTabContainers(form) {
        if (!!form) {
            return form.fields.filter(field => field.type === 'container' && field.tab);
        }
        return [];
    }
    getObjectValue(field, fieldId) {
        let value = '';
        if (field.value && field.value.name) {
            value = field.value.name;
        }
        else if (field.options) {
            const option = field.options.find((opt) => opt.id === field.value);
            if (option) {
                value = this.getValueFromOption(fieldId, option);
            }
        }
        return value;
    }
    getValueFromOption(fieldId, option) {
        let optionValue = '';
        if (fieldId && fieldId.indexOf('_LABEL') > 0) {
            optionValue = option.name;
        }
        else {
            optionValue = option.id;
        }
        return optionValue;
    }
    isSearchedField(field, fieldId) {
        const fieldToFind = (fieldId === null || fieldId === void 0 ? void 0 : fieldId.indexOf('_LABEL')) > 0 ? fieldId.replace('_LABEL', '') : fieldId;
        return (field.id && fieldToFind) ? field.id.toUpperCase() === fieldToFind.toUpperCase() : false;
    }
    getVariableValue(form, name, processVarList) {
        const processVariableValue = this.getProcessVariableValue(name, processVarList);
        const variableDefaultValue = form.getFormVariableValue(name);
        return (processVariableValue === undefined) ? variableDefaultValue : processVariableValue;
    }
    getProcessVariableValue(name, processVarList) {
        if (processVarList) {
            const processVariable = processVarList.find(variable => variable.id === name ||
                variable.id === `variables.${name}`);
            if (processVariable) {
                return processVariable.value;
            }
        }
        return undefined;
    }
    evaluateCondition(leftValue, rightValue, operator) {
        switch (operator) {
            case '==':
                return leftValue + '' === rightValue + '';
            case '<':
                return leftValue < rightValue;
            case '!=':
                return leftValue + '' !== rightValue + '';
            case '>':
                return leftValue > rightValue;
            case '>=':
                return leftValue >= rightValue;
            case '<=':
                return leftValue <= rightValue;
            case 'empty':
                return leftValue ? leftValue === '' : true;
            case '!empty':
                return leftValue ? leftValue !== '' : false;
            case 'contains':
                return this.contains(leftValue, rightValue);
            case '!contains':
                return !this.contains(leftValue, rightValue);
            default:
                this.logService.error(`Invalid operator: ${operator}`);
                return undefined;
        }
    }
    contains(leftValue, rightValue) {
        return Array.isArray(leftValue) && Array.isArray(rightValue) && rightValue.every((element) => leftValue.includes(element));
    }
    cleanProcessVariable() {
        this.processVarList = [];
    }
    getTaskProcessVariable(taskId) {
        return from(this.taskFormsApi.getTaskFormVariables(taskId))
            .pipe(map((res) => {
            const jsonRes = this.toJson(res);
            this.processVarList = jsonRes;
            return jsonRes;
        }), catchError(() => this.handleError()));
    }
    toJson(res) {
        return res || {};
    }
    isValidCondition(condition) {
        return !!(condition && condition.operator);
    }
    handleError() {
        this.logService.error('Error while performing a call');
        return throwError('Error while performing a call - Server error');
    }
}
WidgetVisibilityService.ɵprov = i0.ɵɵdefineInjectable({ factory: function WidgetVisibilityService_Factory() { return new WidgetVisibilityService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i2.LogService)); }, token: WidgetVisibilityService, providedIn: "root" });
WidgetVisibilityService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
WidgetVisibilityService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: LogService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0LXZpc2liaWxpdHkuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvcmUvIiwic291cmNlcyI6WyJmb3JtL3NlcnZpY2VzL3dpZGdldC12aXNpYmlsaXR5LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBaUJBLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sTUFBTSxNQUFNLFlBQVksQ0FBQztBQUNoQyxPQUFPLEVBQWMsSUFBSSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQVNwRCxPQUFPLEVBQXlCLGNBQWMsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQzFGLE9BQU8sRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDakQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGtCQUFrQixDQUFDOzs7O0FBS2hELE1BQU0sT0FBTyx1QkFBdUI7SUFXaEMsWUFBb0IsVUFBOEIsRUFDOUIsVUFBc0I7UUFEdEIsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7UUFDOUIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtJQUMxQyxDQUFDO0lBVkQsSUFBSSxZQUFZOztRQUNaLElBQUksQ0FBQyxhQUFhLFNBQUcsSUFBSSxDQUFDLGFBQWEsbUNBQUksSUFBSSxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQzNGLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztJQUM5QixDQUFDO0lBU00saUJBQWlCLENBQUMsSUFBZSxFQUFFLGNBQTJDO1FBQ2pGLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFB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Q0FDdkMsQ0FBQztJQUNWLENBQUM7SUFFRCxNQUFNLENBQUMsR0FBUTtRQUNYLE9BQU8sR0FBRyxJQUFJLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRU8sZ0JBQWdCLENBQUMsU0FBZ0M7UUFDckQsT0FBTyxDQUFDLENBQUMsQ0FBQyxTQUFTLElBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFTyxXQUFXO1FBQ2YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztRQUN2RCxPQUFPLFVBQVUsQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO0lBQ3RFLENBQUM7Ozs7WUExVUosVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7WUFuQlEsa0JBQWtCO1lBQ2xCLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9hbGZyZXNjby1hcGkuc2VydmljZSc7XG5pbXBvcnQgeyBMb2dTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvbG9nLnNlcnZpY2UnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQtZXM2JztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20sIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gICAgRm9ybUZpZWxkTW9kZWwsXG4gICAgRm9ybU1vZGVsLFxuICAgIFRhYk1vZGVsLFxuICAgIENvbnRhaW5lck1vZGVsLFxuICAgIEZvcm1PdXRjb21lTW9kZWxcbn0gZnJvbSAnLi4vY29tcG9uZW50cy93aWRnZXRzL2NvcmUvaW5kZXgnO1xuaW1wb3J0IHsgVGFza1Byb2Nlc3NWYXJpYWJsZU1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL3Rhc2stcHJvY2Vzcy12YXJpYWJsZS5tb2RlbCc7XG5pbXBvcnQgeyBXaWRnZXRWaXNpYmlsaXR5TW9kZWwsIFdpZGdldFR5cGVFbnVtIH0gZnJvbSAnLi4vbW9kZWxzL3dpZGdldC12aXNpYmlsaXR5Lm1vZGVsJztcbmltcG9ydCB7IG1hcCwgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFRhc2tGb3Jtc0FwaSB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFdpZGdldFZpc2liaWxpdHlTZXJ2aWNlIHtcblxuICAgIF90YXNrRm9ybXNBcGk6IFRhc2tGb3Jtc0FwaTtcbiAgICBnZXQgdGFza0Zvcm1zQXBpKCk6IFRhc2tGb3Jtc0FwaSB7XG4gICAgICAgIHRoaXMuX3Rhc2tGb3Jtc0FwaSA9IHRoaXMuX3Rhc2tGb3Jtc0FwaSA/PyBuZXcgVGFza0Zvcm1zQXBpKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Rhc2tGb3Jtc0FwaTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHByb2Nlc3NWYXJMaXN0OiBUYXNrUHJvY2Vzc1ZhcmlhYmxlTW9kZWxbXTtcbiAgICBwcml2YXRlIGZvcm06IEZvcm1Nb2RlbDtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgbG9nU2VydmljZTogTG9nU2VydmljZSkge1xuICAgIH1cblxuICAgIHB1YmxpYyByZWZyZXNoVmlzaWJpbGl0eShmb3JtOiBGb3JtTW9kZWwsIHByb2Nlc3NWYXJMaXN0PzogVGFza1Byb2Nlc3NWYXJpYWJsZU1vZGVsW10pIHtcbiAgICAgICAgdGhpcy5mb3JtID0gZm9ybTtcbiAgICAgICAgaWYgKHByb2Nlc3NWYXJMaXN0KSB7XG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NWYXJMaXN0ID0gcHJvY2Vzc1Zhckxpc3Q7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZvcm0gJiYgZm9ybS50YWJzICYmIGZvcm0udGFicy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBmb3JtLnRhYnMubWFwKCh0YWJNb2RlbCkgPT4gdGhpcy5yZWZyZXNoRW50aXR5VmlzaWJpbGl0eSh0YWJNb2RlbCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZvcm0gJiYgZm9ybS5vdXRjb21lcyAmJiBmb3JtLm91dGNvbWVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGZvcm0ub3V0Y29tZXMubWFwKChvdXRjb21lTW9kZWwpID0+IHRoaXMucmVmcmVzaE91dGNvbWVWaXNpYmlsaXR5KG91dGNvbWVNb2RlbCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZvcm0pIHtcbiAgICAgICAgICAgIGZvcm0uZ2V0Rm9ybUZpZWxkcygpLm1hcCgoZmllbGQpID0+IHRoaXMucmVmcmVzaEVudGl0eVZpc2liaWxpdHkoZmllbGQpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJlZnJlc2hFbnRpdHlWaXNpYmlsaXR5KGVsZW1lbnQ6IEZvcm1GaWVsZE1vZGVsIHwgVGFiTW9kZWwpIHtcbiAgICAgICAgY29uc3QgdmlzaWJsZSA9IHRoaXMuZXZhbHVhdGVWaXNpYmlsaXR5KGVsZW1lbnQuZm9ybSwgZWxlbWVudC52aXNpYmlsaXR5Q29uZGl0aW9uKTtcbiAgICAgICAgZWxlbWVudC5pc1Zpc2libGUgPSB2aXNpYmxlICYmIHRoaXMuaXNQYXJlbnRUYWJWaXNpYmxlKHRoaXMuZm9ybSwgZWxlbWVudCk7XG4gICAgfVxuXG4gICAgcmVmcmVzaE91dGNvbWVWaXNpYmlsaXR5KGVsZW1lbnQ6IEZvcm1PdXRjb21lTW9kZWwpIHtcbiAgICAgICAgZWxlbWVudC5pc1Zpc2libGUgPSB0aGlzLmV2YWx1YXRlVmlzaWJpbGl0eShlbGVtZW50LmZvcm0sIGVsZW1lbnQudmlzaWJpbGl0eUNvbmRpdGlvbik7XG4gICAgfVxuXG4gICAgZXZhbHVhdGVWaXNpYmlsaXR5KGZvcm06IEZvcm1Nb2RlbCwgdmlzaWJpbGl0eU9iajogV2lkZ2V0VmlzaWJpbGl0eU1vZGVsKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGlzTGVmdEZpZWxkUHJlc2VudCA9IHZpc2liaWxpdHlPYmogJiYgKHZpc2liaWxpdHlPYmoubGVmdFR5cGUgfHwgdmlzaWJpbGl0eU9iai5sZWZ0VmFsdWUpO1xuICAgICAgICBpZiAoIWlzTGVmdEZpZWxkUHJlc2VudCB8fCBpc0xlZnRGaWVsZFByZXNlbnQgPT09ICdudWxsJykge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pc0ZpZWxkVmlzaWJsZShmb3JtLCB2aXNpYmlsaXR5T2JqKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlzRmllbGRWaXNpYmxlKGZvcm06IEZvcm1Nb2RlbCwgdmlzaWJpbGl0eU9iajogV2lkZ2V0VmlzaWJpbGl0eU1vZGVsLCBhY2N1bXVsYXRvcjogYW55W10gPSBbXSwgcmVzdWx0OiBib29sZWFuID0gZmFsc2UpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgbGVmdFZhbHVlID0gdGhpcy5nZXRMZWZ0VmFsdWUoZm9ybSwgdmlzaWJpbGl0eU9iaik7XG4gICAgICAgIGNvbnN0IHJpZ2h0VmFsdWUgPSB0aGlzLmdldFJpZ2h0VmFsdWUoZm9ybSwgdmlzaWJpbGl0eU9iaik7XG4gICAgICAgIGNvbnN0IGFjdHVhbFJlc3VsdCA9IHRoaXMuZXZhbHVhdGVDb25kaXRpb24obGVmdFZhbHVlLCByaWdodFZhbHVlLCB2aXNpYmlsaXR5T2JqLm9wZXJhdG9yKTtcblxuICAgICAgICBhY2N1bXVsYXRvci5wdXNoKHsgdmFsdWU6IGFjdHVhbFJlc3VsdCwgb3BlcmF0b3I6IHZpc2liaWxpdHlPYmoubmV4dENvbmRpdGlvbk9wZXJhdG9yIH0pO1xuXG4gICAgICAgIGlmICh0aGlzLmlzVmFsaWRDb25kaXRpb24odmlzaWJpbGl0eU9iai5uZXh0Q29uZGl0aW9uKSkge1xuICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy5pc0ZpZWxkVmlzaWJsZShmb3JtLCB2aXNpYmlsaXR5T2JqLm5leHRDb25kaXRpb24sIGFjY3VtdWxhdG9yKTtcbiAgICAgICAgfSBlbHNlIGlmIChhY2N1bXVsYXRvclswXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXN1bHQgPSBGdW5jdGlvbignXCJ1c2Ugc3RyaWN0XCI7cmV0dXJuICgnICtcbiAgICAgICAgICAgICAgICAgYWNjdW11bGF0b3IubWFwKChleHByZXNzaW9uKSA9PiB0aGlzLnRyYW5zZm9ybVRvTGl0ZXJhbEV4cHJlc3Npb24oZXhwcmVzc2lvbikpLmpvaW4oJycpICtcbiAgICAgICAgICAgICAgICAnKScpKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQgPSBhY3R1YWxSZXN1bHQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICEhcmVzdWx0O1xuICAgIH1cblxuICAgIHByaXZhdGUgdHJhbnNmb3JtVG9MaXRlcmFsRXhwcmVzc2lvbihjdXJyZW50RXhwcmVzc2lvbjogYW55KTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgY3VycmVudFRyYW5zZm9ybWVkVmFsdWUgPSAhIWN1cnJlbnRFeHByZXNzaW9uLnZhbHVlID8gJ3RydWUnIDogJ2ZhbHNlJztcbiAgICAgICAgcmV0dXJuIGN1cnJlbnRUcmFuc2Zvcm1lZFZhbHVlLmNvbmNhdCh0aGlzLnRyYW5zZm9ybVRvTGl0ZXJhbE9wZXJhdG9yKGN1cnJlbnRFeHByZXNzaW9uLm9wZXJhdG9yKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0cmFuc2Zvcm1Ub0xpdGVyYWxPcGVyYXRvcihjdXJyZW50T3BlcmF0b3IpOiBzdHJpbmcge1xuICAgICAgICBzd2l0Y2ggKGN1cnJlbnRPcGVyYXRvcikge1xuICAgICAgICAgICAgY2FzZSAnYW5kJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gJyYmJztcbiAgICAgICAgICAgIGNhc2UgJ29yJyA6XG4gICAgICAgICAgICAgICAgcmV0dXJuICd8fCc7XG4gICAgICAgICAgICBjYXNlICdhbmQtbm90JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gJyYmICEnO1xuICAgICAgICAgICAgY2FzZSAnb3Itbm90JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gJ3x8ICEnO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRMZWZ0VmFsdWUoZm9ybTogRm9ybU1vZGVsLCB2aXNpYmlsaXR5T2JqOiBXaWRnZXRWaXNpYmlsaXR5TW9kZWwpOiBzdHJpbmcge1xuICAgICAgICBsZXQgbGVmdFZhbHVlID0gJyc7XG4gICAgICAgIGlmICh2aXNpYmlsaXR5T2JqLmxlZnRUeXBlICYmIHZpc2liaWxpdHlPYmoubGVmdFR5cGUgPT09IFdpZGdldFR5cGVFbnVtLnZhcmlhYmxlKSB7XG4gICAgICAgICAgICBsZWZ0VmFsdWUgPSB0aGlzLmdldFZhcmlhYmxlVmFsdWUoZm9ybSwgdmlzaWJpbGl0eU9iai5sZWZ0VmFsdWUsIHRoaXMucHJvY2Vzc1Zhckxpc3QpO1xuICAgICAgICB9IGVsc2UgaWYgKHZpc2liaWxpdHlPYmoubGVmdFR5cGUgJiYgdmlzaWJpbGl0eU9iai5sZWZ0VHlwZSA9PT0gV2lkZ2V0VHlwZUVudW0uZmllbGQpIHtcbiAgICAgICAgICAgIGxlZnRWYWx1ZSA9IHRoaXMuZ2V0Rm9ybVZhbHVlKGZvcm0sIHZpc2liaWxpdHlPYmoubGVmdFZhbHVlKTtcbiAgICAgICAgICAgIGlmIChsZWZ0VmFsdWUgPT09IHVuZGVmaW5lZCB8fCBsZWZ0VmFsdWUgPT09ICcnKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFyaWFibGVWYWx1ZSA9IHRoaXMuZ2V0VmFyaWFibGVWYWx1ZShmb3JtLCB2aXNpYmlsaXR5T2JqLmxlZnRWYWx1ZSwgdGhpcy5wcm9jZXNzVmFyTGlzdCk7XG4gICAgICAgICAgICAgICAgbGVmdFZhbHVlID0gIXRoaXMuaXNJbnZhbGlkVmFsdWUodmFyaWFibGVWYWx1ZSkgPyB2YXJpYWJsZVZhbHVlIDogbGVmdFZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsZWZ0VmFsdWU7XG4gICAgfVxuXG4gICAgZ2V0UmlnaHRWYWx1ZShmb3JtOiBGb3JtTW9kZWwsIHZpc2liaWxpdHlPYmo6IFdpZGdldFZpc2liaWxpdHlNb2RlbCk6IHN0cmluZyB7XG4gICAgICAgIGxldCB2YWx1ZUZvdW5kID0gJyc7XG4gICAgICAgIGlmICh2aXNpYmlsaXR5T2JqLnJpZ2h0VHlwZSA9PT0gV2lkZ2V0VHlwZUVudW0udmFyaWFibGUpIHtcbiAgICAgICAgICAgIHZhbHVlRm91bmQgPSB0aGlzLmdldFZhcmlhYmxlVmFsdWUoZm9ybSwgdmlzaWJpbGl0eU9iai5yaWdodFZhbHVlLCB0aGlzLnByb2Nlc3NWYXJMaXN0KTtcbiAgICAgICAgfSBlbHNlIGlmICh2aXNpYmlsaXR5T2JqLnJpZ2h0VHlwZSA9PT0gV2lkZ2V0VHlwZUVudW0uZmllbGQpIHtcbiAgICAgICAgICAgIHZhbHVlRm91bmQgPSB0aGlzLmdldEZvcm1WYWx1ZShmb3JtLCB2aXNpYmlsaXR5T2JqLnJpZ2h0VmFsdWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKG1vbWVudCh2aXNpYmlsaXR5T2JqLnJpZ2h0VmFsdWUsICdZWVlZLU1NLUREJywgdHJ1ZSkuaXNWYWxpZCgpKSB7XG4gICAgICAgICAgICAgICAgdmFsdWVGb3VuZCA9IHZpc2liaWxpdHlPYmoucmlnaHRWYWx1ZSArICdUMDA6MDA6MDAuMDAwWic7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2aXNpYmlsaXR5T2JqLnJpZ2h0VmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlRm91bmQ7XG4gICAgfVxuXG4gICAgZ2V0Rm9ybVZhbHVlKGZvcm06IEZvcm1Nb2RlbCwgZmllbGRJZDogc3RyaW5nKTogYW55IHtcbiAgICAgICAgY29uc3QgZm9ybUZpZWxkID0gdGhpcy5nZXRGb3JtRmllbGRCeUlkKGZvcm0sIGZpZWxkSWQpO1xuICAgICAgICBsZXQgdmFsdWUgPSB1bmRlZmluZWQ7XG5cbiAgICAgICAgaWYgKHRoaXMuaXNGb3JtRmllbGRWYWxpZChmb3JtRmllbGQpKSB7XG4gICAgICAgICAgICB2YWx1ZSA9IHRoaXMuZ2V0RmllbGRWYWx1ZShmb3JtLnZhbHVlcywgZmllbGRJZCk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmlzSW52YWxpZFZhbHVlKHZhbHVlKSkge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gdGhpcy5zZWFyY2hWYWx1ZUluRm9ybShmb3JtRmllbGQsIGZpZWxkSWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBpc0Zvcm1GaWVsZFZhbGlkKGZvcm1GaWVsZDogRm9ybUZpZWxkTW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGZvcm1GaWVsZCAmJiBmb3JtRmllbGQuaXNWYWxpZDtcbiAgICB9XG5cbiAgICBnZXRGaWVsZFZhbHVlKHZhbHVlTGlzdDogYW55LCBmaWVsZElkOiBzdHJpbmcpOiBhbnkge1xuICAgICAgICBsZXQgbGFiZWxGaWx0ZXJCeU5hbWUsIHZhbHVlRm91bmQ7XG4gICAgICAgIGlmIChmaWVsZElkICYmIGZpZWxkSWQuaW5kZXhPZignX0xBQkVMJykgPiAwKSB7XG4gICAgICAgICAgICBsYWJlbEZpbHRlckJ5TmFtZSA9IGZpZWxkSWQuc3Vic3RyaW5nKDAsIGZpZWxkSWQubGVuZ3RoIC0gNik7XG4gICAgICAgICAgICBpZiAodmFsdWVMaXN0W2xhYmVsRmlsdGVyQnlOYW1lXSkge1xuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlTGlzdFtsYWJlbEZpbHRlckJ5TmFtZV0pKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2YWx1ZUxpc3RbbGFiZWxGaWx0ZXJCeU5hbWVdLm1hcCgoe25hbWV9KSA9PiBuYW1lKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZUZvdW5kID0gdmFsdWVMaXN0W2xhYmVsRmlsdGVyQnlOYW1lXS5uYW1lO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZUxpc3RbZmllbGRJZF0gJiYgdmFsdWVMaXN0W2ZpZWxkSWRdLmlkKSB7XG4gICAgICAgICAgICB2YWx1ZUZvdW5kID0gdmFsdWVMaXN0W2ZpZWxkSWRdLmlkO1xuICAgICAgICB9IGVsc2UgaWYgKHZhbHVlTGlzdFtmaWVsZElkXSAmJiBBcnJheS5pc0FycmF5KHZhbHVlTGlzdFtmaWVsZElkXSkpIHtcbiAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2YWx1ZUxpc3RbZmllbGRJZF0ubWFwKCh7aWR9KSA9PiBpZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YWx1ZUZvdW5kID0gdmFsdWVMaXN0W2ZpZWxkSWRdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZUZvdW5kO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNJbnZhbGlkVmFsdWUodmFsdWU6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbDtcbiAgICB9XG5cbiAgICBnZXRGb3JtRmllbGRCeUlkKGZvcm06IEZvcm1Nb2RlbCwgZmllbGRJZDogc3RyaW5nKTogRm9ybUZpZWxkTW9kZWwge1xuICAgICAgICByZXR1cm4gZm9ybS5nZXRGb3JtRmllbGRzKCkuZmluZCgoZm9ybUZpZWxkOiBGb3JtRmllbGRNb2RlbCkgPT4gdGhpcy5pc1NlYXJjaGVkRmllbGQoZm9ybUZpZWxkLCBmaWVsZElkKSk7XG4gICAgfVxuXG4gICAgc2VhcmNoVmFsdWVJbkZvcm0oZm9ybUZpZWxkOiBGb3JtRmllbGRNb2RlbCwgZmllbGRJZDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IGZpZWxkVmFsdWUgPSAnJztcblxuICAgICAgICBpZiAoZm9ybUZpZWxkKSB7XG4gICAgICAgICAgICBmaWVsZFZhbHVlID0gdGhpcy5nZXRPYmplY3RWYWx1ZShmb3JtRmllbGQsIGZpZWxkSWQpO1xuXG4gICAgICAgICAgICBpZiAoIWZpZWxkVmFsdWUpIHtcbiAgICAgICAgICAgICAgICBpZiAoZm9ybUZpZWxkLnZhbHVlICYmIGZvcm1GaWVsZC52YWx1ZS5pZCkge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZFZhbHVlID0gZm9ybUZpZWxkLnZhbHVlLmlkO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuaXNJbnZhbGlkVmFsdWUoZm9ybUZpZWxkLnZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZFZhbHVlID0gZm9ybUZpZWxkLnZhbHVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmllbGRWYWx1ZTtcbiAgICB9XG5cbiAgICBpc1BhcmVudFRhYlZpc2libGUoZm9ybTogRm9ybU1vZGVsLCBjdXJyZW50Rm9ybUZpZWxkOiBGb3JtRmllbGRNb2RlbCB8IFRhYk1vZGVsKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lcnMgPSB0aGlzLmdldEZvcm1UYWJDb250YWluZXJzKGZvcm0pO1xuICAgICAgICBsZXQgaXNWaXNpYmxlOiBib29sZWFuID0gdHJ1ZTtcbiAgICAgICAgY29udGFpbmVycy5tYXAoKGNvbnRhaW5lcjogQ29udGFpbmVyTW9kZWwpID0+IHtcbiAgICAgICAgICAgIGlmICghIXRoaXMuZ2V0Q3VycmVudEZpZWxkRnJvbVRhYkJ5SWQoY29udGFpbmVyLCBjdXJyZW50Rm9ybUZpZWxkLmlkKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRUYWIgPSBmb3JtLnRhYnMuZmluZCgodGFiOiBUYWJNb2RlbCkgPT4gdGFiLmlkID09PSBjb250YWluZXIudGFiKTtcbiAgICAgICAgICAgICAgICBpZiAoISFjdXJyZW50VGFiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzVmlzaWJsZSA9IGN1cnJlbnRUYWIuaXNWaXNpYmxlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBpc1Zpc2libGU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDdXJyZW50RmllbGRGcm9tVGFiQnlJZChjb250YWluZXI6IENvbnRhaW5lck1vZGVsLCBmaWVsZElkOiBzdHJpbmcpOiBGb3JtRmllbGRNb2RlbCB7XG4gICAgICAgIGNvbnN0IHRhYkZpZWxkczogRm9ybUZpZWxkTW9kZWxbXVtdID0gT2JqZWN0LmtleXMoY29udGFpbmVyLmZpZWxkLmZpZWxkcykubWFwKGtleSA9PiBjb250YWluZXIuZmllbGQuZmllbGRzW2tleV0pO1xuICAgICAgICBsZXQgY3VycmVudEZpZWxkOiBGb3JtRmllbGRNb2RlbDtcblxuICAgICAgICBmb3IgKGNvbnN0IHRhYkZpZWxkIG9mIHRhYkZpZWxkcykge1xuICAgICAgICAgICAgY3VycmVudEZpZWxkID0gdGFiRmllbGQuZmluZCgodGFiOiBGb3JtRmllbGRNb2RlbCkgPT4gdGFiLmlkID09PSBmaWVsZElkKTtcbiAgICAgICAgICAgIGlmIChjdXJyZW50RmllbGQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudEZpZWxkO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Rm9ybVRhYkNvbnRhaW5lcnMoZm9ybTogRm9ybU1vZGVsKTogQ29udGFpbmVyTW9kZWxbXSB7XG4gICAgICAgIGlmICghIWZvcm0pIHtcbiAgICAgICAgICAgIHJldHVybiA8Q29udGFpbmVyTW9kZWxbXT4gZm9ybS5maWVsZHMuZmlsdGVyKGZpZWxkID0+IGZpZWxkLnR5cGUgPT09ICdjb250YWluZXInICYmIGZpZWxkLnRhYik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0T2JqZWN0VmFsdWUoZmllbGQ6IEZvcm1GaWVsZE1vZGVsLCBmaWVsZElkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBsZXQgdmFsdWUgPSAnJztcbiAgICAgICAgaWYgKGZpZWxkLnZhbHVlICYmIGZpZWxkLnZhbHVlLm5hbWUpIHtcbiAgICAgICAgICAgIHZhbHVlID0gZmllbGQudmFsdWUubmFtZTtcbiAgICAgICAgfSBlbHNlIGlmIChmaWVsZC5vcHRpb25zKSB7XG4gICAgICAgICAgICBjb25zdCBvcHRpb24gPSBmaWVsZC5vcHRpb25zLmZpbmQoKG9wdCkgPT4gb3B0LmlkID09PSBmaWVsZC52YWx1ZSk7XG4gICAgICAgICAgICBpZiAob3B0aW9uKSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmdldFZhbHVlRnJvbU9wdGlvbihmaWVsZElkLCBvcHRpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFZhbHVlRnJvbU9wdGlvbihmaWVsZElkOiBzdHJpbmcsIG9wdGlvbik6IHN0cmluZyB7XG4gICAgICAgIGxldCBvcHRpb25WYWx1ZSA9ICcnO1xuICAgICAgICBpZiAoZmllbGRJZCAmJiBmaWVsZElkLmluZGV4T2YoJ19MQUJFTCcpID4gMCkge1xuICAgICAgICAgICAgb3B0aW9uVmFsdWUgPSBvcHRpb24ubmFtZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9wdGlvblZhbHVlID0gb3B0aW9uLmlkO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvcHRpb25WYWx1ZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzU2VhcmNoZWRGaWVsZChmaWVsZDogRm9ybUZpZWxkTW9kZWwsIGZpZWxkSWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBmaWVsZFRvRmluZCA9IGZpZWxkSWQ/LmluZGV4T2YoJ19MQUJFTCcpID4gMCA/IGZpZWxkSWQucmVwbGFjZSgnX0xBQkVMJywgJycpIDogZmllbGRJZDtcbiAgICAgICAgcmV0dXJuIChmaWVsZC5pZCAmJiBmaWVsZFRvRmluZCkgPyBmaWVsZC5pZC50b1VwcGVyQ2FzZSgpID09PSBmaWVsZFRvRmluZC50b1VwcGVyQ2FzZSgpIDogZmFsc2U7XG4gICAgfVxuXG4gICAgZ2V0VmFyaWFibGVWYWx1ZShmb3JtOiBGb3JtTW9kZWwsIG5hbWU6IHN0cmluZywgcHJvY2Vzc1Zhckxpc3Q6IFRhc2tQcm9jZXNzVmFyaWFibGVNb2RlbFtdKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgcHJvY2Vzc1ZhcmlhYmxlVmFsdWUgPSB0aGlzLmdldFByb2Nlc3NWYXJpYWJsZVZhbHVlKG5hbWUsIHByb2Nlc3NWYXJMaXN0KTtcbiAgICAgICAgY29uc3QgdmFyaWFibGVEZWZhdWx0VmFsdWUgPSBmb3JtLmdldEZvcm1WYXJpYWJsZVZhbHVlKG5hbWUpO1xuXG4gICAgICAgIHJldHVybiAocHJvY2Vzc1ZhcmlhYmxlVmFsdWUgPT09IHVuZGVmaW5lZCkgPyB2YXJpYWJsZURlZmF1bHRWYWx1ZSA6IHByb2Nlc3NWYXJpYWJsZVZhbHVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0UHJvY2Vzc1ZhcmlhYmxlVmFsdWUobmFtZTogc3RyaW5nLCBwcm9jZXNzVmFyTGlzdDogVGFza1Byb2Nlc3NWYXJpYWJsZU1vZGVsW10pOiBzdHJpbmcge1xuICAgICAgICBpZiAocHJvY2Vzc1Zhckxpc3QpIHtcbiAgICAgICAgICAgIGNvbnN0IHByb2Nlc3NWYXJpYWJsZSA9IHByb2Nlc3NWYXJMaXN0LmZpbmQoXG4gICAgICAgICAgICAgICAgdmFyaWFibGUgPT5cbiAgICAgICAgICAgICAgICAgICAgdmFyaWFibGUuaWQgPT09IG5hbWUgfHxcbiAgICAgICAgICAgICAgICAgICAgdmFyaWFibGUuaWQgPT09IGB2YXJpYWJsZXMuJHtuYW1lfWBcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmIChwcm9jZXNzVmFyaWFibGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJvY2Vzc1ZhcmlhYmxlLnZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgZXZhbHVhdGVDb25kaXRpb24obGVmdFZhbHVlOiBhbnksIHJpZ2h0VmFsdWU6IGFueSwgb3BlcmF0b3I6IHN0cmluZyk6IGJvb2xlYW4gfCB1bmRlZmluZWQge1xuICAgICAgICBzd2l0Y2ggKG9wZXJhdG9yKSB7XG4gICAgICAgICAgICBjYXNlICc9PSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRWYWx1ZSArICcnID09PSByaWdodFZhbHVlICsgJyc7XG4gICAgICAgICAgICBjYXNlICc8JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFZhbHVlIDwgcmlnaHRWYWx1ZTtcbiAgICAgICAgICAgIGNhc2UgJyE9JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFZhbHVlICsgJycgIT09IHJpZ2h0VmFsdWUgKyAnJztcbiAgICAgICAgICAgIGNhc2UgJz4nOlxuICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0VmFsdWUgPiByaWdodFZhbHVlO1xuICAgICAgICAgICAgY2FzZSAnPj0nOlxuICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0VmFsdWUgPj0gcmlnaHRWYWx1ZTtcbiAgICAgICAgICAgIGNhc2UgJzw9JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFZhbHVlIDw9IHJpZ2h0VmFsdWU7XG4gICAgICAgICAgICBjYXNlICdlbXB0eSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRWYWx1ZSA/IGxlZnRWYWx1ZSA9PT0gJycgOiB0cnVlO1xuICAgICAgICAgICAgY2FzZSAnIWVtcHR5JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFZhbHVlID8gbGVmdFZhbHVlICE9PSAnJyA6IGZhbHNlO1xuICAgICAgICAgICAgY2FzZSAnY29udGFpbnMnOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnRhaW5zKGxlZnRWYWx1ZSwgcmlnaHRWYWx1ZSk7XG4gICAgICAgICAgICBjYXNlICchY29udGFpbnMnOlxuICAgICAgICAgICAgICAgIHJldHVybiAhdGhpcy5jb250YWlucyhsZWZ0VmFsdWUsIHJpZ2h0VmFsdWUpO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoYEludmFsaWQgb3BlcmF0b3I6ICR7b3BlcmF0b3J9YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgY29udGFpbnMobGVmdFZhbHVlOiBhbnksIHJpZ2h0VmFsdWU6IGFueSkge1xuICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShsZWZ0VmFsdWUpICYmIEFycmF5LmlzQXJyYXkocmlnaHRWYWx1ZSkgJiYgcmlnaHRWYWx1ZS5ldmVyeSgoZWxlbWVudCkgPT4gbGVmdFZhbHVlLmluY2x1ZGVzKGVsZW1lbnQpKTtcbiAgICB9XG5cbiAgICBjbGVhblByb2Nlc3NWYXJpYWJsZSgpIHtcbiAgICAgICAgdGhpcy5wcm9jZXNzVmFyTGlzdCA9IFtdO1xuICAgIH1cblxuICAgIGdldFRhc2tQcm9jZXNzVmFyaWFibGUodGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tQcm9jZXNzVmFyaWFibGVNb2RlbFtdPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMudGFza0Zvcm1zQXBpLmdldFRhc2tGb3JtVmFyaWFibGVzKHRhc2tJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBqc29uUmVzID0gdGhpcy50b0pzb24ocmVzKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzVmFyTGlzdCA9IDxUYXNrUHJvY2Vzc1ZhcmlhYmxlTW9kZWxbXT4ganNvblJlcztcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpzb25SZXM7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiB0aGlzLmhhbmRsZUVycm9yKCkpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHRvSnNvbihyZXM6IGFueSk6IGFueSB7XG4gICAgICAgIHJldHVybiByZXMgfHwge307XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc1ZhbGlkQ29uZGl0aW9uKGNvbmRpdGlvbjogV2lkZ2V0VmlzaWJpbGl0eU1vZGVsKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAhIShjb25kaXRpb24gJiYgY29uZGl0aW9uLm9wZXJhdG9yKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZUVycm9yKCkge1xuICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoJ0Vycm9yIHdoaWxlIHBlcmZvcm1pbmcgYSBjYWxsJyk7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdFcnJvciB3aGlsZSBwZXJmb3JtaW5nIGEgY2FsbCAtIFNlcnZlciBlcnJvcicpO1xuICAgIH1cbn1cbiJdfQ==