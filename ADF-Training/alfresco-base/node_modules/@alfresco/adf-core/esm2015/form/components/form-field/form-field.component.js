/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Compiler, Component, ComponentFactoryResolver, Input, NgModule, ViewChild, ViewContainerRef, ViewEncapsulation } from '@angular/core';
import { FormRenderingService } from './../../services/form-rendering.service';
import { WidgetVisibilityService } from './../../services/widget-visibility.service';
import { FormFieldModel } from './../widgets/core/form-field.model';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './../../services/form-rendering.service';
import * as ɵngcc2 from './../../services/widget-visibility.service';

const _c0 = ["container"];
export class FormFieldComponent {
    constructor(formRenderingService, componentFactoryResolver, visibilityService, compiler) {
        this.formRenderingService = formRenderingService;
        this.componentFactoryResolver = componentFactoryResolver;
        this.visibilityService = visibilityService;
        this.compiler = compiler;
        this.field = null;
        this.focus = false;
    }
    ngOnInit() {
        const w = window;
        if (w.adf === undefined) {
            w.adf = {};
        }
        const originalField = this.getField();
        if (originalField) {
            const customTemplate = this.field.form.customFieldTemplates[originalField.type];
            if (customTemplate && this.hasController(originalField.type)) {
                const factory = this.getComponentFactorySync(originalField.type, customTemplate);
                this.componentRef = this.container.createComponent(factory);
                const instance = this.componentRef.instance;
                if (instance) {
                    instance.field = originalField;
                }
            }
            else {
                const componentType = this.formRenderingService.resolveComponentType(originalField);
                if (componentType) {
                    const factory = this.componentFactoryResolver.resolveComponentFactory(componentType);
                    this.componentRef = this.container.createComponent(factory);
                    const instance = this.componentRef.instance;
                    instance.field = this.field;
                    instance.fieldChanged.subscribe((field) => {
                        if (field && this.field.form) {
                            this.visibilityService.refreshVisibility(field.form);
                            field.form.onFormFieldChanged(field);
                        }
                    });
                }
            }
        }
    }
    ngOnDestroy() {
        if (this.componentRef) {
            this.componentRef.destroy();
            this.componentRef = null;
        }
    }
    getField() {
        if (this.field && this.field.params) {
            const wrappedField = this.field.params.field;
            if (wrappedField && wrappedField.type) {
                return wrappedField;
            }
        }
        return this.field;
    }
    hasController(type) {
        return (adf && adf.components && adf.components[type]);
    }
    getComponentFactorySync(type, template) {
        const componentInfo = adf.components[type];
        if (componentInfo.factory) {
            return componentInfo.factory;
        }
        const metadata = {
            selector: `runtime-component-${type}`,
            template: template
        };
        const factory = this.createComponentFactorySync(this.compiler, metadata, componentInfo.class);
        componentInfo.factory = factory;
        return factory;
    }
    createComponentFactorySync(compiler, metadata, componentClass) {
        const cmpClass = componentClass || class RuntimeComponent {
        };
        const decoratedCmp = Component(metadata)(cmpClass);
        const moduleClass = class RuntimeComponentModule {
        };
        const decoratedNgModule = NgModule({ imports: [], declarations: [decoratedCmp] })(moduleClass);
        const module = compiler.compileModuleAndAllComponentsSync(decoratedNgModule);
        return module.componentFactories.find((x) => x.componentType === decoratedCmp);
    }
    focusToggle() {
        setTimeout(() => {
            this.focus = !this.focus;
        });
    }
}
FormFieldComponent.ɵfac = function FormFieldComponent_Factory(t) { return new (t || FormFieldComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.FormRenderingService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ComponentFactoryResolver), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.WidgetVisibilityService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.Compiler)); };
FormFieldComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: FormFieldComponent, selectors: [["adf-form-field"]], viewQuery: function FormFieldComponent_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵstaticViewQuery(_c0, true, ViewContainerRef);
    } if (rf & 2) {
        var _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.container = _t.first);
    } }, inputs: { field: "field" }, decls: 3, vars: 4, consts: [[3, "id", "hidden", "focusin", "focusout"], ["container", ""]], template: function FormFieldComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "div", 0);
        ɵngcc0.ɵɵlistener("focusin", function FormFieldComponent_Template_div_focusin_0_listener() { return ctx.focusToggle(); })("focusout", function FormFieldComponent_Template_div_focusout_0_listener() { return ctx.focusToggle(); });
        ɵngcc0.ɵɵelement(1, "div", null, 1);
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵclassProp("adf-focus", ctx.focus);
        ɵngcc0.ɵɵproperty("id", "field-" + (ctx.field == null ? null : ctx.field.id) + "-container")("hidden", !(ctx.field == null ? null : ctx.field.isVisible));
    } }, encapsulation: 2 });
FormFieldComponent.ctorParameters = () => [
    { type: FormRenderingService },
    { type: ComponentFactoryResolver },
    { type: WidgetVisibilityService },
    { type: Compiler }
];
FormFieldComponent.propDecorators = {
    container: [{ type: ViewChild, args: ['container', { read: ViewContainerRef, static: true },] }],
    field: [{ type: Input }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(FormFieldComponent, [{
        type: Component,
        args: [{
                selector: 'adf-form-field',
                template: `
        <div [id]="'field-'+field?.id+'-container'"
            [hidden]="!field?.isVisible"
            [class.adf-focus]="focus"
            (focusin)="focusToggle()"
            (focusout)="focusToggle()">
            <div #container></div>
        </div>
    `,
                encapsulation: ViewEncapsulation.None
            }]
    }], function () { return [{ type: ɵngcc1.FormRenderingService }, { type: ɵngcc0.ComponentFactoryResolver }, { type: ɵngcc2.WidgetVisibilityService }, { type: ɵngcc0.Compiler }]; }, { field: [{
            type: Input
        }], container: [{
            type: ViewChild,
            args: ['container', { read: ViewContainerRef, static: true }]
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1maWVsZC5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb3JlL2Zvcm0vY29tcG9uZW50cy9mb3JtLWZpZWxkL2Zvcm0tZmllbGQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFFSCxPQUFPLEVBQ0gsUUFBUSxFQUNSLFNBQVMsRUFDVCx3QkFBd0IsRUFFeEIsS0FBSyxFQUVMLFFBQVEsRUFHUixTQUFTLEVBQ1QsZ0JBQWdCLEVBQ2hCLGlCQUFpQixFQUNwQixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQUMvRSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSw0Q0FBNEMsQ0FBQztBQUNyRixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0NBQW9DLENBQUM7Ozs7OztBQWtCcEUsTUFBTSxPQUFPLGtCQUFrQjtBQUFHLElBaUI5QixZQUFvQixvQkFBMEMsRUFDMUMsd0JBQWtELEVBQ2xELGlCQUEwQyxFQUMxQyxRQUFrQjtBQUMxQyxRQUp3Qix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO0FBQUMsUUFDM0MsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtBQUFDLFFBQ25ELHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBeUI7QUFBQyxRQUMzQyxhQUFRLEdBQVIsUUFBUSxDQUFVO0FBQUMsUUFUdkMsVUFBSyxHQUFtQixJQUFJLENBQUM7QUFDakMsUUFHSSxVQUFLLEdBQVksS0FBSyxDQUFDO0FBQzNCLElBS0ksQ0FBQztBQUNMLElBQ0ksUUFBUTtB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QSxDQUFDO0FBQzVELFFBQVEsTUFBTSxpQkFBaUIsR0FBRyxRQUFRLENBQUMsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLFlBQVksRUFBRSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUN2RyxRQUFRLE1BQU0sTUFBTSxHQUFzQyxRQUFRLENBQUMsaUNBQWlDLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUN4SCxRQUNRLE9BQU8sTUFBTSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLGFBQWEsS0FBSyxZQUFZLENBQUMsQ0FBQztBQUN2RixJQUFJLENBQUM7QUFDTCxJQUNJLFdBQVc7QUFDZixRQUFRLFVBQVUsQ0FBQyxHQUFHLEVBQUU7QUFDeEIsWUFBWSxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztBQUNyQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0FBQ1gsSUFBSSxDQUFDO0FBQ0w7OENBMUhDLFNBQVMsU0FBQyxrQkFDUCxRQUFRLEVBQUUsZ0JBQWdCLGtCQUMxQixRQUFRLEVBQUU7K0VBUVQsa0JBQ0QsYUFBYSxFQUFFLGlCQUFpQixDQUFDLElBQUksY0FDeEM7Ozs7Ozs7Ozs7Ozs7NkJBQ0k7QUFBQztBQUE0QyxZQXBCekMsb0JBQW9CO0FBQUksWUFaN0Isd0JBQXdCO0FBQzFCLFlBWU8sdUJBQXVCO0FBQUksWUFmaEMsUUFBUTtBQUNYO0FBQUc7QUFDSyx3QkFrQ0osU0FBUyxTQUFDLFdBQVcsRUFBRSxFQUFFLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO0FBQy9ELG9CQU9BLEtBQUs7QUFDVDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O29CQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1xuICAgIENvbXBpbGVyLFxuICAgIENvbXBvbmVudCwgQ29tcG9uZW50RmFjdG9yeSxcbiAgICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgQ29tcG9uZW50UmVmLFxuICAgIElucHV0LFxuICAgIE1vZHVsZVdpdGhDb21wb25lbnRGYWN0b3JpZXMsXG4gICAgTmdNb2R1bGUsXG4gICAgT25EZXN0cm95LFxuICAgIE9uSW5pdCxcbiAgICBWaWV3Q2hpbGQsXG4gICAgVmlld0NvbnRhaW5lclJlZixcbiAgICBWaWV3RW5jYXBzdWxhdGlvblxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgRm9ybVJlbmRlcmluZ1NlcnZpY2UgfSBmcm9tICcuLy4uLy4uL3NlcnZpY2VzL2Zvcm0tcmVuZGVyaW5nLnNlcnZpY2UnO1xuaW1wb3J0IHsgV2lkZ2V0VmlzaWJpbGl0eVNlcnZpY2UgfSBmcm9tICcuLy4uLy4uL3NlcnZpY2VzL3dpZGdldC12aXNpYmlsaXR5LnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9ybUZpZWxkTW9kZWwgfSBmcm9tICcuLy4uL3dpZGdldHMvY29yZS9mb3JtLWZpZWxkLm1vZGVsJztcbmltcG9ydCB7IFdpZGdldENvbXBvbmVudCB9IGZyb20gJy4vLi4vd2lkZ2V0cy93aWRnZXQuY29tcG9uZW50JztcblxuZGVjbGFyZSB2YXIgYWRmOiBhbnk7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAnYWRmLWZvcm0tZmllbGQnLFxuICAgIHRlbXBsYXRlOiBgXG4gICAgICAgIDxkaXYgW2lkXT1cIidmaWVsZC0nK2ZpZWxkPy5pZCsnLWNvbnRhaW5lcidcIlxuICAgICAgICAgICAgW2hpZGRlbl09XCIhZmllbGQ/LmlzVmlzaWJsZVwiXG4gICAgICAgICAgICBbY2xhc3MuYWRmLWZvY3VzXT1cImZvY3VzXCJcbiAgICAgICAgICAgIChmb2N1c2luKT1cImZvY3VzVG9nZ2xlKClcIlxuICAgICAgICAgICAgKGZvY3Vzb3V0KT1cImZvY3VzVG9nZ2xlKClcIj5cbiAgICAgICAgICAgIDxkaXYgI2NvbnRhaW5lcj48L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgYCxcbiAgICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lXG59KVxuZXhwb3J0IGNsYXNzIEZvcm1GaWVsZENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcblxuICAgIEBWaWV3Q2hpbGQoJ2NvbnRhaW5lcicsIHsgcmVhZDogVmlld0NvbnRhaW5lclJlZiwgc3RhdGljOiB0cnVlIH0pXG4gICAgY29udGFpbmVyOiBWaWV3Q29udGFpbmVyUmVmO1xuXG4gICAgLyoqIENvbnRhaW5zIGFsbCB0aGUgbmVjZXNzYXJ5IGRhdGEgbmVlZGVkIHRvIGRldGVybWluZSB3aGF0IFVJIFdpZGdldFxuICAgICAqIHRvIHVzZSB3aGVuIHJlbmRlcmluZyB0aGUgZmllbGQgaW4gdGhlIGZvcm0uIFlvdSB3b3VsZCB0eXBpY2FsbHkgbm90XG4gICAgICogY3JlYXRlIHRoaXMgZGF0YSBtYW51YWxseSBidXQgaW5zdGVhZCBjcmVhdGUgdGhlIGZvcm0gaW4gQVBTIGFuZCBleHBvcnRcbiAgICAgKiBpdCB0byBnZXQgdG8gYWxsIHRoZSBgRm9ybUZpZWxkTW9kZWxgIGRlZmluaXRpb25zLlxuICAgICAqL1xuICAgIEBJbnB1dCgpXG4gICAgZmllbGQ6IEZvcm1GaWVsZE1vZGVsID0gbnVsbDtcblxuICAgIGNvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPHt9PjtcblxuICAgIGZvY3VzOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZvcm1SZW5kZXJpbmdTZXJ2aWNlOiBGb3JtUmVuZGVyaW5nU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdmlzaWJpbGl0eVNlcnZpY2U6IFdpZGdldFZpc2liaWxpdHlTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgY29tcGlsZXI6IENvbXBpbGVyKSB7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIGNvbnN0IHc6IGFueSA9IHdpbmRvdztcbiAgICAgICAgaWYgKHcuYWRmID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHcuYWRmID0ge307XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgb3JpZ2luYWxGaWVsZCA9IHRoaXMuZ2V0RmllbGQoKTtcbiAgICAgICAgaWYgKG9yaWdpbmFsRmllbGQpIHtcbiAgICAgICAgICAgIGNvbnN0IGN1c3RvbVRlbXBsYXRlID0gdGhpcy5maWVsZC5mb3JtLmN1c3RvbUZpZWxkVGVtcGxhdGVzW29yaWdpbmFsRmllbGQudHlwZV07XG4gICAgICAgICAgICBpZiAoY3VzdG9tVGVtcGxhdGUgJiYgdGhpcy5oYXNDb250cm9sbGVyKG9yaWdpbmFsRmllbGQudHlwZSkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmYWN0b3J5ID0gdGhpcy5nZXRDb21wb25lbnRGYWN0b3J5U3luYyhvcmlnaW5hbEZpZWxkLnR5cGUsIGN1c3RvbVRlbXBsYXRlKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbXBvbmVudFJlZiA9IHRoaXMuY29udGFpbmVyLmNyZWF0ZUNvbXBvbmVudChmYWN0b3J5KTtcbiAgICAgICAgICAgICAgICBjb25zdCBpbnN0YW5jZTogYW55ID0gdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2U7XG4gICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlKSB7XG4gICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmZpZWxkID0gb3JpZ2luYWxGaWVsZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbXBvbmVudFR5cGUgPSB0aGlzLmZvcm1SZW5kZXJpbmdTZXJ2aWNlLnJlc29sdmVDb21wb25lbnRUeXBlKG9yaWdpbmFsRmllbGQpO1xuICAgICAgICAgICAgICAgIGlmIChjb21wb25lbnRUeXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZhY3RvcnkgPSB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShjb21wb25lbnRUeXBlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wb25lbnRSZWYgPSB0aGlzLmNvbnRhaW5lci5jcmVhdGVDb21wb25lbnQoZmFjdG9yeSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gPFdpZGdldENvbXBvbmVudD4gdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2U7XG4gICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmZpZWxkID0gdGhpcy5maWVsZDtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuZmllbGRDaGFuZ2VkLnN1YnNjcmliZSgoZmllbGQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaWVsZCAmJiB0aGlzLmZpZWxkLmZvcm0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZpc2liaWxpdHlTZXJ2aWNlLnJlZnJlc2hWaXNpYmlsaXR5KGZpZWxkLmZvcm0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkLmZvcm0ub25Gb3JtRmllbGRDaGFuZ2VkKGZpZWxkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKSB7XG4gICAgICAgIGlmICh0aGlzLmNvbXBvbmVudFJlZikge1xuICAgICAgICAgICAgdGhpcy5jb21wb25lbnRSZWYuZGVzdHJveSgpO1xuICAgICAgICAgICAgdGhpcy5jb21wb25lbnRSZWYgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRGaWVsZCgpOiBGb3JtRmllbGRNb2RlbCB7XG4gICAgICAgIGlmICh0aGlzLmZpZWxkICYmIHRoaXMuZmllbGQucGFyYW1zKSB7XG4gICAgICAgICAgICBjb25zdCB3cmFwcGVkRmllbGQgPSB0aGlzLmZpZWxkLnBhcmFtcy5maWVsZDtcbiAgICAgICAgICAgIGlmICh3cmFwcGVkRmllbGQgJiYgd3JhcHBlZEZpZWxkLnR5cGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gd3JhcHBlZEZpZWxkIGFzIEZvcm1GaWVsZE1vZGVsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmZpZWxkO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFzQ29udHJvbGxlcih0eXBlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIChhZGYgJiYgYWRmLmNvbXBvbmVudHMgJiYgYWRmLmNvbXBvbmVudHNbdHlwZV0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Q29tcG9uZW50RmFjdG9yeVN5bmModHlwZTogc3RyaW5nLCB0ZW1wbGF0ZTogc3RyaW5nKTogQ29tcG9uZW50RmFjdG9yeTxhbnk+IHtcbiAgICAgICAgY29uc3QgY29tcG9uZW50SW5mbyA9IGFkZi5jb21wb25lbnRzW3R5cGVdO1xuXG4gICAgICAgIGlmIChjb21wb25lbnRJbmZvLmZhY3RvcnkpIHtcbiAgICAgICAgICAgIHJldHVybiBjb21wb25lbnRJbmZvLmZhY3Rvcnk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBtZXRhZGF0YSA9IHtcbiAgICAgICAgICAgIHNlbGVjdG9yOiBgcnVudGltZS1jb21wb25lbnQtJHt0eXBlfWAsXG4gICAgICAgICAgICB0ZW1wbGF0ZTogdGVtcGxhdGVcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBmYWN0b3J5ID0gdGhpcy5jcmVhdGVDb21wb25lbnRGYWN0b3J5U3luYyh0aGlzLmNvbXBpbGVyLCBtZXRhZGF0YSwgY29tcG9uZW50SW5mby5jbGFzcyk7XG4gICAgICAgIGNvbXBvbmVudEluZm8uZmFjdG9yeSA9IGZhY3Rvcnk7XG4gICAgICAgIHJldHVybiBmYWN0b3J5O1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlQ29tcG9uZW50RmFjdG9yeVN5bmMoY29tcGlsZXI6IENvbXBpbGVyLCBtZXRhZGF0YTogQ29tcG9uZW50LCBjb21wb25lbnRDbGFzczogYW55KTogQ29tcG9uZW50RmFjdG9yeTxhbnk+IHtcbiAgICAgICAgY29uc3QgY21wQ2xhc3MgPSBjb21wb25lbnRDbGFzcyB8fCBjbGFzcyBSdW50aW1lQ29tcG9uZW50IHt9O1xuICAgICAgICBjb25zdCBkZWNvcmF0ZWRDbXAgPSBDb21wb25lbnQobWV0YWRhdGEpKGNtcENsYXNzKTtcbiAgICAgICAgY29uc3QgbW9kdWxlQ2xhc3MgPSBjbGFzcyBSdW50aW1lQ29tcG9uZW50TW9kdWxlIHt9O1xuICAgICAgICBjb25zdCBkZWNvcmF0ZWROZ01vZHVsZSA9IE5nTW9kdWxlKHsgaW1wb3J0czogW10sIGRlY2xhcmF0aW9uczogW2RlY29yYXRlZENtcF0gfSkobW9kdWxlQ2xhc3MpO1xuICAgICAgICBjb25zdCBtb2R1bGU6IE1vZHVsZVdpdGhDb21wb25lbnRGYWN0b3JpZXM8YW55PiA9IGNvbXBpbGVyLmNvbXBpbGVNb2R1bGVBbmRBbGxDb21wb25lbnRzU3luYyhkZWNvcmF0ZWROZ01vZHVsZSk7XG5cbiAgICAgICAgcmV0dXJuIG1vZHVsZS5jb21wb25lbnRGYWN0b3JpZXMuZmluZCgoeCkgPT4geC5jb21wb25lbnRUeXBlID09PSBkZWNvcmF0ZWRDbXApO1xuICAgIH1cblxuICAgIGZvY3VzVG9nZ2xlKCkge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZm9jdXMgPSAhdGhpcy5mb2N1cztcbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19