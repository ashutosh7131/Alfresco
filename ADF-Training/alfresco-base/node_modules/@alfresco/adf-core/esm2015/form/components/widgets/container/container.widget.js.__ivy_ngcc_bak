/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Component, ViewEncapsulation } from '@angular/core';
import { FormService } from './../../../services/form.service';
import { WidgetComponent } from './../widget.component';
import { ContainerWidgetComponentModel } from './container.widget.model';
export class ContainerWidgetComponent extends WidgetComponent {
    constructor(formService) {
        super(formService);
        this.formService = formService;
    }
    onExpanderClicked() {
        if (this.content && this.content.isCollapsible()) {
            this.content.isExpanded = !this.content.isExpanded;
        }
    }
    ngOnInit() {
        if (this.field) {
            this.content = new ContainerWidgetComponentModel(this.field);
            this.getNumberOfColumnsFromTheBiggestBetweenJsonAndColumnsLengthOrOne();
            this.fields = this.getFields();
        }
    }
    getNumberOfColumnsFromTheBiggestBetweenJsonAndColumnsLengthOrOne() {
        var _a, _b, _c, _d;
        this.numberOfColumns = (((_a = this.content.json) === null || _a === void 0 ? void 0 : _a.numberOfColumns) || 1) > (((_b = this.content.columns) === null || _b === void 0 ? void 0 : _b.length) || 1) ?
            (((_c = this.content.json) === null || _c === void 0 ? void 0 : _c.numberOfColumns) || 1) :
            (((_d = this.content.columns) === null || _d === void 0 ? void 0 : _d.length) || 1);
    }
    getFields() {
        var _a;
        const serialisedFormFields = [];
        const maxColumnFieldsSize = this.getMaxColumnFieldSize();
        for (let rowIndex = 0; rowIndex < maxColumnFieldsSize; rowIndex++) {
            (_a = this.content) === null || _a === void 0 ? void 0 : _a.columns.flatMap((currentColumn) => {
                var _a;
                if (!!(currentColumn === null || currentColumn === void 0 ? void 0 : currentColumn.fields[rowIndex])) {
                    serialisedFormFields.push(currentColumn === null || currentColumn === void 0 ? void 0 : currentColumn.fields[rowIndex]);
                }
                else {
                    const firstRowElementColSpan = (_a = currentColumn === null || currentColumn === void 0 ? void 0 : currentColumn.fields[0]) === null || _a === void 0 ? void 0 : _a.colspan;
                    if (!!firstRowElementColSpan && rowIndex > 0) {
                        for (let i = 0; i < firstRowElementColSpan; i++) {
                            serialisedFormFields.push(null);
                        }
                    }
                }
            });
        }
        return serialisedFormFields;
    }
    getMaxColumnFieldSize() {
        var _a, _b, _c, _d, _e, _f;
        let maxFieldSize = 0;
        if (((_b = (_a = this.content) === null || _a === void 0 ? void 0 : _a.columns) === null || _b === void 0 ? void 0 : _b.length) > 0) {
            maxFieldSize = (_f = (_e = (_d = (_c = this.content) === null || _c === void 0 ? void 0 : _c.columns) === null || _d === void 0 ? void 0 : _d.reduce((prevColumn, currentColumn) => {
                var _a;
                return currentColumn.fields.length > ((_a = prevColumn === null || prevColumn === void 0 ? void 0 : prevColumn.fields) === null || _a === void 0 ? void 0 : _a.length) ? currentColumn : prevColumn;
            })) === null || _e === void 0 ? void 0 : _e.fields) === null || _f === void 0 ? void 0 : _f.length;
        }
        return maxFieldSize;
    }
    getColumnWith(field) {
        const colspan = field ? field.colspan : 1;
        return (100 / this.content.json.numberOfColumns) * colspan + '';
    }
}
ContainerWidgetComponent.decorators = [
    { type: Component, args: [{
                selector: 'container-widget',
                template: "<div [hidden]=\"!content?.isGroup()\" class=\"adf-container-widget__header\">\n    <h4 class=\"adf-container-widget__header-text\" id=\"container-header\"\n        [class.adf-collapsible]=\"content?.isCollapsible()\">\n        <button *ngIf=\"content?.isCollapsible()\"\n                mat-icon-button\n                class=\"mdl-button--icon\"\n                (click)=\"onExpanderClicked()\">\n            <mat-icon>{{ content?.isExpanded ? 'expand_more' : 'expand_less' }}</mat-icon>\n        </button>\n        <span (click)=\"onExpanderClicked()\" id=\"container-header-label\">{{content.name | translate }}</span>\n    </h4>\n</div>\n\n<div *ngIf=\"field?.form?.enableFixedSpace else fixingTemplate\">\n    <div class=\"adf-grid-list\" [ngStyle]=\"{ 'grid-template-columns': 'repeat('+numberOfColumns+', 1fr)'}\"\n        *ngIf=\"content?.isExpanded\">\n        <div class=\"adf-grid-list-item\" *ngFor=\"let field of fields\"\n            [ngStyle]=\"{'grid-area': 'auto / auto / span '+(field?.rowspan || 1)+' / span '+(field?.colspan || 1)}\">\n            <adf-form-field *ngIf=\"field\" [field]=\"field\"></adf-form-field>\n        </div>\n    </div>\n</div>\n\n<ng-template #fixingTemplate>\n    <section class=\"adf-grid-list-column-view\" *ngIf=\"content?.isExpanded\">\n        <div class=\"adf-grid-list-single-column\" *ngFor=\"let column of content?.columns\" [style.width.%]=\"getColumnWith(field)\">\n            <div class=\"adf-grid-list-column-view-item\" *ngFor=\"let field of column?.fields\">\n                <adf-form-field *ngIf=\"field\" [field]=\"field\"></adf-form-field>\n            </div>\n        </div>\n    </section>\n</ng-template>\n",
                host: {
                    '(click)': 'event($event)',
                    '(blur)': 'event($event)',
                    '(change)': 'event($event)',
                    '(focus)': 'event($event)',
                    '(focusin)': 'event($event)',
                    '(focusout)': 'event($event)',
                    '(input)': 'event($event)',
                    '(invalid)': 'event($event)',
                    '(select)': 'event($event)'
                },
                encapsulation: ViewEncapsulation.None,
                styles: [".adf-hidden{display:none}.adf-container-widget__header-text{-moz-user-select:none;-ms-user-select:none;-webkit-touch-callout:none;-webkit-user-select:none;border-bottom:1px solid rgba(0,0,0,.87);cursor:default;padding-bottom:10px;user-select:none}.adf-container-widget__header-text.adf-collapsible{cursor:pointer}.adf-field-list{height:100%;list-style-type:none;padding:0;width:100%}container-widget .adf-grid-list-column-view{align-items:flex-start;display:flex;margin-right:-1%}container-widget .adf-grid-list-single-column{align-items:flex-start;display:flex;flex:1 1 auto;flex-direction:column}container-widget .adf-grid-list-column-view-item{box-sizing:border-box;flex-grow:1;padding-left:1%;padding-right:1%;width:100%}container-widget .adf-grid-list{display:grid}container-widget .adf-grid-list-item{box-sizing:border-box;padding-left:3px;padding-right:3px}@media screen and (max-width:959px){container-widget .adf-grid-list-item{flex:1 0 100%}container-widget .adf-grid-list--column-view{flex-direction:column}container-widget .adf-grid-list-single-column{width:90%!important}container-widget .adf-grid-list-column-view-item{flex:1 0 auto}}container-widget .mat-form-field,container-widget mat-form-field{width:100%}container-widget .mat-input-placeholder{top:1.8em!important}container-widget .mat-focused label{background-color:.3s cubic-bezier(.55,0,.55,.2);color:var(--theme-primary-color);transform:scaleX(1);transition:transform .15s linear}container-widget .mat-focused .mat-form-field-prefix{color:var(--theme-primary-color)}container-widget .mat-grid-tile{overflow:visible;width:80%}container-widget adf-form-field{width:100%}"]
            },] }
];
ContainerWidgetComponent.ctorParameters = () => [
    { type: FormService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGFpbmVyLndpZGdldC5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvcmUvIiwic291cmNlcyI6WyJmb3JtL2NvbXBvbmVudHMvd2lkZ2V0cy9jb250YWluZXIvY29udGFpbmVyLndpZGdldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFJSCxPQUFPLEVBQWlCLFNBQVMsRUFBVSxpQkFBaUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNwRixPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFFL0QsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3hELE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBbUJ6RSxNQUFNLE9BQU8sd0JBQXlCLFNBQVEsZUFBZTtJQU16RCxZQUFtQixXQUF3QjtRQUN2QyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7UUFESixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtJQUUzQyxDQUFDO0lBRUQsaUJBQWlCO1FBQ2IsSUFBSSxJQUFJLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxFQUFFLEVBQUU7WUFDOUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQztTQUN0RDtJQUNMLENBQUM7SUFFRCxRQUFRO1FBQ0osSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ1osSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLDZCQUE2QixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUM3RCxJQUFJLENBQUMsZ0VBQWdFLEVBQUUsQ0FBQztZQUN4RSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztTQUNsQztJ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QUFlO29CQUMxQixRQUFRLEVBQUUsZUFBZTtvQkFDekIsVUFBVSxFQUFFLGVBQWU7b0JBQzNCLFNBQVMsRUFBRSxlQUFlO29CQUMxQixXQUFXLEVBQUUsZUFBZTtvQkFDNUIsWUFBWSxFQUFFLGVBQWU7b0JBQzdCLFNBQVMsRUFBRSxlQUFlO29CQUMxQixXQUFXLEVBQUUsZUFBZTtvQkFDNUIsVUFBVSxFQUFFLGVBQWU7aUJBQzlCO2dCQUNELGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJOzthQUN4Qzs7O1lBckJRLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vKiB0c2xpbnQ6ZGlzYWJsZTpjb21wb25lbnQtc2VsZWN0b3IgICovXG5cbmltcG9ydCB7IEFmdGVyVmlld0luaXQsIENvbXBvbmVudCwgT25Jbml0LCBWaWV3RW5jYXBzdWxhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybVNlcnZpY2UgfSBmcm9tICcuLy4uLy4uLy4uL3NlcnZpY2VzL2Zvcm0uc2VydmljZSc7XG5pbXBvcnQgeyBGb3JtRmllbGRNb2RlbCB9IGZyb20gJy4vLi4vY29yZS9mb3JtLWZpZWxkLm1vZGVsJztcbmltcG9ydCB7IFdpZGdldENvbXBvbmVudCB9IGZyb20gJy4vLi4vd2lkZ2V0LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBDb250YWluZXJXaWRnZXRDb21wb25lbnRNb2RlbCB9IGZyb20gJy4vY29udGFpbmVyLndpZGdldC5tb2RlbCc7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAnY29udGFpbmVyLXdpZGdldCcsXG4gICAgdGVtcGxhdGVVcmw6ICcuL2NvbnRhaW5lci53aWRnZXQuaHRtbCcsXG4gICAgc3R5bGVVcmxzOiBbJy4vY29udGFpbmVyLndpZGdldC5zY3NzJ10sXG4gICAgaG9zdDoge1xuICAgICAgICAnKGNsaWNrKSc6ICdldmVudCgkZXZlbnQpJyxcbiAgICAgICAgJyhibHVyKSc6ICdldmVudCgkZXZlbnQpJyxcbiAgICAgICAgJyhjaGFuZ2UpJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKGZvY3VzKSc6ICdldmVudCgkZXZlbnQpJyxcbiAgICAgICAgJyhmb2N1c2luKSc6ICdldmVudCgkZXZlbnQpJyxcbiAgICAgICAgJyhmb2N1c291dCknOiAnZXZlbnQoJGV2ZW50KScsXG4gICAgICAgICcoaW5wdXQpJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKGludmFsaWQpJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKHNlbGVjdCknOiAnZXZlbnQoJGV2ZW50KSdcbiAgICB9LFxuICAgIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmVcbn0pXG5leHBvcnQgY2xhc3MgQ29udGFpbmVyV2lkZ2V0Q29tcG9uZW50IGV4dGVuZHMgV2lkZ2V0Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcblxuICAgIGNvbnRlbnQ6IENvbnRhaW5lcldpZGdldENvbXBvbmVudE1vZGVsO1xuICAgIG51bWJlck9mQ29sdW1uczogbnVtYmVyO1xuICAgIGZpZWxkczogRm9ybUZpZWxkTW9kZWxbXTtcblxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBmb3JtU2VydmljZTogRm9ybVNlcnZpY2UpIHtcbiAgICAgICAgc3VwZXIoZm9ybVNlcnZpY2UpO1xuICAgIH1cblxuICAgIG9uRXhwYW5kZXJDbGlja2VkKCkge1xuICAgICAgICBpZiAodGhpcy5jb250ZW50ICYmIHRoaXMuY29udGVudC5pc0NvbGxhcHNpYmxlKCkpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGVudC5pc0V4cGFuZGVkID0gIXRoaXMuY29udGVudC5pc0V4cGFuZGVkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIGlmICh0aGlzLmZpZWxkKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnQgPSBuZXcgQ29udGFpbmVyV2lkZ2V0Q29tcG9uZW50TW9kZWwodGhpcy5maWVsZCk7XG4gICAgICAgICAgICB0aGlzLmdldE51bWJlck9mQ29sdW1uc0Zyb21UaGVCaWdnZXN0QmV0d2Vlbkpzb25BbmRDb2x1bW5zTGVuZ3RoT3JPbmUoKTtcbiAgICAgICAgICAgIHRoaXMuZmllbGRzID0gdGhpcy5nZXRGaWVsZHMoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TnVtYmVyT2ZDb2x1bW5zRnJvbVRoZUJpZ2dlc3RCZXR3ZWVuSnNvbkFuZENvbHVtbnNMZW5ndGhPck9uZSgpIHtcbiAgICAgICAgdGhpcy5udW1iZXJPZkNvbHVtbnMgPSAodGhpcy5jb250ZW50Lmpzb24/Lm51bWJlck9mQ29sdW1ucyB8fCAxKSA+ICh0aGlzLmNvbnRlbnQuY29sdW1ucz8ubGVuZ3RoIHx8IDEpID9cbiAgICAgICAgICAgICh0aGlzLmNvbnRlbnQuanNvbj8ubnVtYmVyT2ZDb2x1bW5zIHx8IDEpIDpcbiAgICAgICAgICAgICh0aGlzLmNvbnRlbnQuY29sdW1ucz8ubGVuZ3RoIHx8IDEpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNlcmlhbGl6ZXMgY29sdW1uIGZpZWxkc1xuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0RmllbGRzKCk6IEZvcm1GaWVsZE1vZGVsW10ge1xuICAgICAgICBjb25zdCBzZXJpYWxpc2VkRm9ybUZpZWxkczogRm9ybUZpZWxkTW9kZWxbXSA9IFtdO1xuICAgICAgICBjb25zdCBtYXhDb2x1bW5GaWVsZHNTaXplID0gdGhpcy5nZXRNYXhDb2x1bW5GaWVsZFNpemUoKTtcbiAgICAgICAgZm9yIChsZXQgcm93SW5kZXggPSAwOyByb3dJbmRleCA8IG1heENvbHVtbkZpZWxkc1NpemU7IHJvd0luZGV4KyspIHtcbiAgICAgICAgICAgIHRoaXMuY29udGVudD8uY29sdW1ucy5mbGF0TWFwKChjdXJyZW50Q29sdW1uKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCEhY3VycmVudENvbHVtbj8uZmllbGRzW3Jvd0luZGV4XSkge1xuICAgICAgICAgICAgICAgICAgICBzZXJpYWxpc2VkRm9ybUZpZWxkcy5wdXNoKGN1cnJlbnRDb2x1bW4/LmZpZWxkc1tyb3dJbmRleF0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpcnN0Um93RWxlbWVudENvbFNwYW4gPSBjdXJyZW50Q29sdW1uPy5maWVsZHNbMF0/LmNvbHNwYW47XG4gICAgICAgICAgICAgICAgICAgIGlmICghIWZpcnN0Um93RWxlbWVudENvbFNwYW4gJiYgcm93SW5kZXggPiAwICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaXJzdFJvd0VsZW1lbnRDb2xTcGFuOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJpYWxpc2VkRm9ybUZpZWxkcy5wdXNoKG51bGwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc2VyaWFsaXNlZEZvcm1GaWVsZHM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRNYXhDb2x1bW5GaWVsZFNpemUoKTogbnVtYmVyIHtcbiAgICAgICAgbGV0IG1heEZpZWxkU2l6ZSA9IDA7XG4gICAgICAgIGlmICh0aGlzLmNvbnRlbnQ/LmNvbHVtbnM/Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIG1heEZpZWxkU2l6ZSA9IHRoaXMuY29udGVudD8uY29sdW1ucz8ucmVkdWNlKChwcmV2Q29sdW1uLCBjdXJyZW50Q29sdW1uKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRDb2x1bW4uZmllbGRzLmxlbmd0aCA+IHByZXZDb2x1bW4/LmZpZWxkcz8ubGVuZ3RoID8gY3VycmVudENvbHVtbiA6IHByZXZDb2x1bW47XG4gICAgICAgICAgICB9KT8uZmllbGRzPy5sZW5ndGg7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG1heEZpZWxkU2l6ZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxjdWxhdGUgdGhlIGNvbHVtbiB3aWR0aCBiYXNlZCBvbiB0aGUgbnVtYmVyT2ZDb2x1bW5zIGFuZCBjdXJyZW50IGZpZWxkJ3MgY29sc3BhbiBwcm9wZXJ0eVxuICAgICAqXG4gICAgICogQHBhcmFtIGZpZWxkXG4gICAgICovXG4gICAgZ2V0Q29sdW1uV2l0aChmaWVsZDogRm9ybUZpZWxkTW9kZWwpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBjb2xzcGFuID0gZmllbGQgPyBmaWVsZC5jb2xzcGFuIDogMTtcbiAgICAgICAgcmV0dXJuICgxMDAgLyB0aGlzLmNvbnRlbnQuanNvbi5udW1iZXJPZkNvbHVtbnMpICogY29sc3BhbiArICcnO1xuICAgIH1cbn1cbiJdfQ==