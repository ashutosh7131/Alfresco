import { __awaiter } from "tslib";
import { HttpClient } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { ObjectUtils } from '../utils/object-utils';
import { Subject } from 'rxjs';
import { map, distinctUntilChanged, take } from 'rxjs/operators';
import { ExtensionService, mergeObjects } from '@alfresco/adf-extensions';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "@alfresco/adf-extensions";
export var AppConfigValues;
(function (AppConfigValues) {
    AppConfigValues["APP_CONFIG_LANGUAGES_KEY"] = "languages";
    AppConfigValues["PROVIDERS"] = "providers";
    AppConfigValues["OAUTHCONFIG"] = "oauth2";
    AppConfigValues["ECMHOST"] = "ecmHost";
    AppConfigValues["BASESHAREURL"] = "baseShareUrl";
    AppConfigValues["BPMHOST"] = "bpmHost";
    AppConfigValues["IDENTITY_HOST"] = "identityHost";
    AppConfigValues["AUTHTYPE"] = "authType";
    AppConfigValues["CONTEXTROOTECM"] = "contextRootEcm";
    AppConfigValues["CONTEXTROOTBPM"] = "contextRootBpm";
    AppConfigValues["ALFRESCO_REPOSITORY_NAME"] = "alfrescoRepositoryName";
    AppConfigValues["LOG_LEVEL"] = "logLevel";
    AppConfigValues["LOGIN_ROUTE"] = "loginRoute";
    AppConfigValues["DISABLECSRF"] = "disableCSRF";
    AppConfigValues["AUTH_WITH_CREDENTIALS"] = "auth.withCredentials";
    AppConfigValues["APPLICATION"] = "application";
    AppConfigValues["STORAGE_PREFIX"] = "application.storagePrefix";
    AppConfigValues["NOTIFY_DURATION"] = "notificationDefaultDuration";
})(AppConfigValues || (AppConfigValues = {}));
export var Status;
(function (Status) {
    Status["INIT"] = "init";
    Status["LOADING"] = "loading";
    Status["LOADED"] = "loaded";
})(Status || (Status = {}));
export class AppConfigService {
    constructor(http, extensionService) {
        this.http = http;
        this.extensionService = extensionService;
        this.config = {
            application: {
                name: 'Alfresco ADF Application'
            },
            ecmHost: 'http://{hostname}{:port}/ecm',
            bpmHost: 'http://{hostname}{:port}/bpm',
            logLevel: 'silent'
        };
        this.status = Status.INIT;
        this.onLoadSubject = new Subject();
        this.onLoad = this.onLoadSubject.asObservable();
        extensionService.setup$.subscribe((config) => {
            this.onExtensionsLoaded(config);
        });
    }
    select(property) {
        return this.onLoadSubject
            .pipe(map((config) => config[property]), distinctUntilChanged());
    }
    get(key, defaultValue) {
        let result = ObjectUtils.getValue(this.config, key);
        if (typeof result === 'string') {
            const keywords = new Map();
            keywords.set('hostname', this.getLocationHostname());
            keywords.set(':port', this.getLocationPort(':'));
            keywords.set('port', this.getLocationPort());
            keywords.set('protocol', this.getLocationProtocol());
            result = this.formatString(result, keywords);
        }
        if (typeof result === 'object') {
            result = JSON.parse(JSON.stringify(result).replace('{hostname}', this.getLocationHostname()));
            result = JSON.parse(JSON.stringify(result).replace('{:port}', this.getLocationPort(':')));
            result = JSON.parse(JSON.stringify(result).replace('{protocol}', this.getLocationProtocol()));
        }
        if (result === undefined) {
            return defaultValue;
        }
        return result;
    }
    getLocationProtocol() {
        return location.protocol;
    }
    getLocationHostname() {
        return location.hostname;
    }
    getLocationPort(prefix = '') {
        return location.port ? prefix + location.port : '';
    }
    onLoaded() {
        this.onLoadSubject.next(this.config);
    }
    onDataLoaded(data) {
        this.config = Object.assign({}, this.config, data || {});
        this.onLoadSubject.next(this.config);
        this.extensionService.setup$
            .pipe(take(1))
            .subscribe((config) => this.onExtensionsLoaded(config));
    }
    onExtensionsLoaded(config) {
        if (config) {
            const customConfig = config.appConfig;
            if (customConfig) {
                this.config = mergeObjects(this.config, customConfig);
            }
        }
    }
    load() {
        return new Promise((resolve) => __awaiter(this, void 0, void 0, function* () {
            const configUrl = `app.config.json?v=${Date.now()}`;
            if (this.status === Status.INIT) {
                this.status = Status.LOADING;
                this.http.get(configUrl).subscribe((data) => {
                    this.status = Status.LOADED;
                    this.onDataLoaded(data);
                    resolve(this.config);
                }, () => {
                    resolve(this.config);
                });
            }
            else if (this.status === Status.LOADED) {
                resolve(this.config);
            }
            else if (this.status === Status.LOADING) {
                this.onLoad.subscribe(() => {
                    resolve(this.config);
                });
            }
        }));
    }
    formatString(str, keywords) {
        let result = str;
        keywords.forEach((value, key) => {
            const expr = new RegExp('{' + key + '}', 'gm');
            result = result.replace(expr, value);
        });
        return result;
    }
}
AppConfigService.ɵprov = i0.ɵɵdefineInjectable({ factory: function AppConfigService_Factory() { return new AppConfigService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.ExtensionService)); }, token: AppConfigService, providedIn: "root" });
AppConfigService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
AppConfigService.ctorParameters = () => [
    { type: HttpClient },
    { type: ExtensionService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLWNvbmZpZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvY29yZS8iLCJzb3VyY2VzIjpbImFwcC1jb25maWcvYXBwLWNvbmZpZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFpQkEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3BELE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUFFLEdBQUcsRUFBRSxvQkFBb0IsRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqRSxPQUFPLEVBQW1CLGdCQUFnQixFQUFFLFlBQVksRUFBRSxNQUFNLDBCQUEwQixDQUFDOzs7O0FBRzNGLE1BQU0sQ0FBTixJQUFZLGVBbUJYO0FBbkJELFdBQVksZUFBZTtJQUN2Qix5REFBc0MsQ0FBQTtJQUN0QywwQ0FBdUIsQ0FBQTtJQUN2Qix5Q0FBc0IsQ0FBQTtJQUN0QixzQ0FBbUIsQ0FBQTtJQUNuQixnREFBNkIsQ0FBQTtJQUM3QixzQ0FBbUIsQ0FBQTtJQUNuQixpREFBOEIsQ0FBQTtJQUM5Qix3Q0FBcUIsQ0FBQTtJQUNyQixvREFBaUMsQ0FBQTtJQUNqQyxvREFBaUMsQ0FBQTtJQUNqQyxzRUFBbUQsQ0FBQTtJQUNuRCx5Q0FBc0IsQ0FBQTtJQUN0Qiw2Q0FBMEIsQ0FBQTtJQUMxQiw4Q0FBMkIsQ0FBQTtJQUMzQixpRUFBOEMsQ0FBQTtJQUM5Qyw4Q0FBMkIsQ0FBQTtJQUMzQiwrREFBNEMsQ0FBQTtJQUM1QyxrRUFBK0MsQ0FBQTtBQUNuRCxDQUFDLEVBbkJXLGVBQWUsS0FBZixlQUFlLFFBbUIxQjtBQUVELE1BQU0s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UUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUM1QixNQUFNLElBQUksR0FBRyxJQUFJLE1BQU0sQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUMvQyxNQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDekMsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDOzs7O1lBN0pKLFVBQVUsU0FBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQjs7O1lBdkNRLFVBQVU7WUFLTyxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JqZWN0VXRpbHMgfSBmcm9tICcuLi91dGlscy9vYmplY3QtdXRpbHMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEV4dGVuc2lvbkNvbmZpZywgRXh0ZW5zaW9uU2VydmljZSwgbWVyZ2VPYmplY3RzIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1leHRlbnNpb25zJztcblxuLyogc3BlbGxjaGVja2VyOiBkaXNhYmxlICovXG5leHBvcnQgZW51bSBBcHBDb25maWdWYWx1ZXMge1xuICAgIEFQUF9DT05GSUdfTEFOR1VBR0VTX0tFWSA9ICdsYW5ndWFnZXMnLFxuICAgIFBST1ZJREVSUyA9ICdwcm92aWRlcnMnLFxuICAgIE9BVVRIQ09ORklHID0gJ29hdXRoMicsXG4gICAgRUNNSE9TVCA9ICdlY21Ib3N0JyxcbiAgICBCQVNFU0hBUkVVUkwgPSAnYmFzZVNoYXJlVXJsJyxcbiAgICBCUE1IT1NUID0gJ2JwbUhvc3QnLFxuICAgIElERU5USVRZX0hPU1QgPSAnaWRlbnRpdHlIb3N0JyxcbiAgICBBVVRIVFlQRSA9ICdhdXRoVHlwZScsXG4gICAgQ09OVEVYVFJPT1RFQ00gPSAnY29udGV4dFJvb3RFY20nLFxuICAgIENPTlRFWFRST09UQlBNID0gJ2NvbnRleHRSb290QnBtJyxcbiAgICBBTEZSRVNDT19SRVBPU0lUT1JZX05BTUUgPSAnYWxmcmVzY29SZXBvc2l0b3J5TmFtZScsXG4gICAgTE9HX0xFVkVMID0gJ2xvZ0xldmVsJyxcbiAgICBMT0dJTl9ST1VURSA9ICdsb2dpblJvdXRlJyxcbiAgICBESVNBQkxFQ1NSRiA9ICdkaXNhYmxlQ1NSRicsXG4gICAgQVVUSF9XSVRIX0NSRURFTlRJQUxTID0gJ2F1dGgud2l0aENyZWRlbnRpYWxzJyxcbiAgICBBUFBMSUNBVElPTiA9ICdhcHBsaWNhdGlvbicsXG4gICAgU1RPUkFHRV9QUkVGSVggPSAnYXBwbGljYXRpb24uc3RvcmFnZVByZWZpeCcsXG4gICAgTk9USUZZX0RVUkFUSU9OID0gJ25vdGlmaWNhdGlvbkRlZmF1bHREdXJhdGlvbidcbn1cblxuZXhwb3J0IGVudW0gU3RhdHVzIHtcbiAgICBJTklUID0gJ2luaXQnLFxuICAgIExPQURJTkcgPSAnbG9hZGluZycsXG4gICAgTE9BREVEID0gJ2xvYWRlZCdcbn1cblxuLyogc3BlbGxjaGVja2VyOiBlbmFibGUgKi9cblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBBcHBDb25maWdTZXJ2aWNlIHtcblxuICAgIGNvbmZpZzogYW55ID0ge1xuICAgICAgICBhcHBsaWNhdGlvbjoge1xuICAgICAgICAgICAgbmFtZTogJ0FsZnJlc2NvIEFERiBBcHBsaWNhdGlvbidcbiAgICAgICAgfSxcbiAgICAgICAgZWNtSG9zdDogJ2h0dHA6Ly97aG9zdG5hbWV9ezpwb3J0fS9lY20nLFxuICAgICAgICBicG1Ib3N0OiAnaHR0cDovL3tob3N0bmFtZX17OnBvcnR9L2JwbScsXG4gICAgICAgIGxvZ0xldmVsOiAnc2lsZW50J1xuICAgIH07XG5cbiAgICBzdGF0dXM6IFN0YXR1cyA9IFN0YXR1cy5JTklUO1xuICAgIHByb3RlY3RlZCBvbkxvYWRTdWJqZWN0OiBTdWJqZWN0PGFueT47XG4gICAgb25Mb2FkOiBPYnNlcnZhYmxlPGFueT47XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgaHR0cDogSHR0cENsaWVudCwgcHJvdGVjdGVkIGV4dGVuc2lvblNlcnZpY2U6IEV4dGVuc2lvblNlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5vbkxvYWRTdWJqZWN0ID0gbmV3IFN1YmplY3QoKTtcbiAgICAgICAgdGhpcy5vbkxvYWQgPSB0aGlzLm9uTG9hZFN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG5cbiAgICAgICAgZXh0ZW5zaW9uU2VydmljZS5zZXR1cCQuc3Vic2NyaWJlKChjb25maWcpID0+IHtcbiAgICAgICAgICAgIHRoaXMub25FeHRlbnNpb25zTG9hZGVkKGNvbmZpZyk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcXVlc3RzIG5vdGlmaWNhdGlvbiBvZiBhIHByb3BlcnR5IHZhbHVlIHdoZW4gaXQgaXMgbG9hZGVkLlxuICAgICAqIEBwYXJhbSBwcm9wZXJ0eSBUaGUgZGVzaXJlZCBwcm9wZXJ0eSB2YWx1ZVxuICAgICAqIEByZXR1cm5zIFByb3BlcnR5IHZhbHVlLCB3aGVuIGxvYWRlZFxuICAgICAqL1xuICAgIHNlbGVjdChwcm9wZXJ0eTogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Mb2FkU3ViamVjdFxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChjb25maWcpID0+IGNvbmZpZ1twcm9wZXJ0eV0pLFxuICAgICAgICAgICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKClcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgdmFsdWUgb2YgYSBuYW1lZCBwcm9wZXJ0eS5cbiAgICAgKiBAcGFyYW0ga2V5IE5hbWUgb2YgdGhlIHByb3BlcnR5XG4gICAgICogQHBhcmFtIGRlZmF1bHRWYWx1ZSBWYWx1ZSB0byByZXR1cm4gaWYgdGhlIGtleSBpcyBub3QgZm91bmRcbiAgICAgKiBAcmV0dXJucyBWYWx1ZSBvZiB0aGUgcHJvcGVydHlcbiAgICAgKi9cbiAgICBnZXQ8VD4oa2V5OiBzdHJpbmcsIGRlZmF1bHRWYWx1ZT86IFQpOiBUIHtcbiAgICAgICAgbGV0IHJlc3VsdDogYW55ID0gT2JqZWN0VXRpbHMuZ2V0VmFsdWUodGhpcy5jb25maWcsIGtleSk7XG4gICAgICAgIGlmICh0eXBlb2YgcmVzdWx0ID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgY29uc3Qga2V5d29yZHMgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuICAgICAgICAgICAga2V5d29yZHMuc2V0KCdob3N0bmFtZScsIHRoaXMuZ2V0TG9jYXRpb25Ib3N0bmFtZSgpKTtcbiAgICAgICAgICAgIGtleXdvcmRzLnNldCgnOnBvcnQnLCB0aGlzLmdldExvY2F0aW9uUG9ydCgnOicpKTtcbiAgICAgICAgICAgIGtleXdvcmRzLnNldCgncG9ydCcsIHRoaXMuZ2V0TG9jYXRpb25Qb3J0KCkpO1xuICAgICAgICAgICAga2V5d29yZHMuc2V0KCdwcm90b2NvbCcsIHRoaXMuZ2V0TG9jYXRpb25Qcm90b2NvbCgpKTtcbiAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMuZm9ybWF0U3RyaW5nKHJlc3VsdCwga2V5d29yZHMpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICByZXN1bHQgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJlc3VsdCkucmVwbGFjZSgne2hvc3RuYW1lfScsIHRoaXMuZ2V0TG9jYXRpb25Ib3N0bmFtZSgpKSk7XG4gICAgICAgICAgICByZXN1bHQgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJlc3VsdCkucmVwbGFjZSgnezpwb3J0fScsIHRoaXMuZ2V0TG9jYXRpb25Qb3J0KCc6JykpKTtcbiAgICAgICAgICAgIHJlc3VsdCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocmVzdWx0KS5yZXBsYWNlKCd7cHJvdG9jb2x9JywgdGhpcy5nZXRMb2NhdGlvblByb3RvY29sKCkpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiA8VD4gcmVzdWx0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIGxvY2F0aW9uLnByb3RvY29sIHZhbHVlLlxuICAgICAqIEByZXR1cm5zIFRoZSBsb2NhdGlvbi5wcm90b2NvbCBzdHJpbmdcbiAgICAgKi9cbiAgICBnZXRMb2NhdGlvblByb3RvY29sKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBsb2NhdGlvbi5wcm90b2NvbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBsb2NhdGlvbi5ob3N0bmFtZSBwcm9wZXJ0eS5cbiAgICAgKiBAcmV0dXJucyBWYWx1ZSBvZiB0aGUgcHJvcGVydHlcbiAgICAgKi9cbiAgICBnZXRMb2NhdGlvbkhvc3RuYW1lKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBsb2NhdGlvbi5ob3N0bmFtZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBsb2NhdGlvbi5wb3J0IHByb3BlcnR5LlxuICAgICAqIEBwYXJhbSBwcmVmaXggVGV4dCBhZGRlZCBiZWZvcmUgcG9ydCB2YWx1ZVxuICAgICAqIEByZXR1cm5zIFBvcnQgd2l0aCBwcmVmaXhcbiAgICAgKi9cbiAgICBnZXRMb2NhdGlvblBvcnQocHJlZml4OiBzdHJpbmcgPSAnJyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBsb2NhdGlvbi5wb3J0ID8gcHJlZml4ICsgbG9jYXRpb24ucG9ydCA6ICcnO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBvbkxvYWRlZCgpIHtcbiAgICAgICAgdGhpcy5vbkxvYWRTdWJqZWN0Lm5leHQodGhpcy5jb25maWcpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBvbkRhdGFMb2FkZWQoZGF0YTogYW55KSB7XG4gICAgICAgIHRoaXMuY29uZmlnID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5jb25maWcsIGRhdGEgfHwge30pO1xuICAgICAgICB0aGlzLm9uTG9hZFN1YmplY3QubmV4dCh0aGlzLmNvbmZpZyk7XG5cbiAgICAgICAgdGhpcy5leHRlbnNpb25TZXJ2aWNlLnNldHVwJFxuICAgICAgICAgICAgLnBpcGUodGFrZSgxKSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKGNvbmZpZykgPT4gdGhpcy5vbkV4dGVuc2lvbnNMb2FkZWQoY29uZmlnKSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIG9uRXh0ZW5zaW9uc0xvYWRlZChjb25maWc6IEV4dGVuc2lvbkNvbmZpZykge1xuICAgICAgICBpZiAoY29uZmlnKSB7XG4gICAgICAgICAgICBjb25zdCBjdXN0b21Db25maWcgPSBjb25maWcuYXBwQ29uZmlnO1xuXG4gICAgICAgICAgICBpZiAoY3VzdG9tQ29uZmlnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb25maWcgPSBtZXJnZU9iamVjdHModGhpcy5jb25maWcsIGN1c3RvbUNvbmZpZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMb2FkcyB0aGUgY29uZmlnIGZpbGUuXG4gICAgICogQHJldHVybnMgTm90aWZpY2F0aW9uIHdoZW4gbG9hZGluZyBpcyBjb21wbGV0ZVxuICAgICAqL1xuICAgIGxvYWQoKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb25maWdVcmwgPSBgYXBwLmNvbmZpZy5qc29uP3Y9JHtEYXRlLm5vdygpfWA7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLnN0YXR1cyA9PT0gU3RhdHVzLklOSVQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cyA9IFN0YXR1cy5MT0FESU5HO1xuICAgICAgICAgICAgICAgIHRoaXMuaHR0cC5nZXQoY29uZmlnVXJsKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgICAgIChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gU3RhdHVzLkxPQURFRDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25EYXRhTG9hZGVkKGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0aGlzLmNvbmZpZyk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcy5jb25maWcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0dXMgPT09IFN0YXR1cy5MT0FERUQpIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHRoaXMuY29uZmlnKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0dXMgPT09IFN0YXR1cy5MT0FESU5HKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkxvYWQuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0aGlzLmNvbmZpZyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZm9ybWF0U3RyaW5nKHN0cjogc3RyaW5nLCBrZXl3b3JkczogTWFwPHN0cmluZywgc3RyaW5nPik6IHN0cmluZyB7XG4gICAgICAgIGxldCByZXN1bHQgPSBzdHI7XG5cbiAgICAgICAga2V5d29yZHMuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZXhwciA9IG5ldyBSZWdFeHAoJ3snICsga2V5ICsgJ30nLCAnZ20nKTtcbiAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdC5yZXBsYWNlKGV4cHIsIHZhbHVlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG59XG4iXX0=