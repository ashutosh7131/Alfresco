/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Component, Input, ContentChild, TemplateRef, HostListener, ElementRef, ViewEncapsulation, EventEmitter, Output, Inject, ViewChildren, QueryList } from '@angular/core';
import { ESCAPE, UP_ARROW, DOWN_ARROW } from '@angular/cdk/keycodes';
import { DOCUMENT } from '@angular/common';
import { FocusKeyManager } from '@angular/cdk/a11y';
import { PdfThumbComponent } from './pdf-viewer-thumb.component';
import { delay } from 'rxjs/operators';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/common';
import * as ɵngcc2 from './pdf-viewer-thumb.component';
import * as ɵngcc3 from '@angular/flex-layout/extended';

const _c0 = function (a0) { return { "adf-pdf-thumbnails__thumb--selected": a0 }; };
function PdfThumbListComponent_adf_pdf_thumb_1_Template(rf, ctx) { if (rf & 1) {
    const _r3 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "adf-pdf-thumb", 2);
    ɵngcc0.ɵɵlistener("click", function PdfThumbListComponent_adf_pdf_thumb_1_Template_adf_pdf_thumb_click_0_listener() { ɵngcc0.ɵɵrestoreView(_r3); const page_r1 = ctx.$implicit; const ctx_r2 = ɵngcc0.ɵɵnextContext(); return ctx_r2.goTo(page_r1.id); });
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const page_r1 = ctx.$implicit;
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵproperty("id", page_r1.id)("ngClass", ɵngcc0.ɵɵpureFunction1(3, _c0, ctx_r0.isSelected(page_r1.id)))("page", page_r1);
} }
export class PdfThumbListComponent {
    constructor(element, document) {
        this.element = element;
        this.document = document;
        this.close = new EventEmitter();
        this.virtualHeight = 0;
        this.translateY = 0;
        this.renderItems = [];
        this.width = 91;
        this.currentHeight = 0;
        this.items = [];
        this.margin = 15;
        this.itemHeight = 114 + this.margin;
        this.previouslyFocusedElement = null;
        this.calculateItems = this.calculateItems.bind(this);
        this.onPageChange = this.onPageChange.bind(this);
    }
    onKeydown(event) {
        const keyCode = event.keyCode;
        if (keyCode === UP_ARROW && this.canSelectPreviousItem()) {
            this.pdfViewer.currentPageNumber -= 1;
        }
        if (keyCode === DOWN_ARROW && this.canSelectNextItem()) {
            this.pdfViewer.currentPageNumber += 1;
        }
        if (keyCode === ESCAPE) {
            this.close.emit();
        }
        this.keyManager.setFocusOrigin('keyboard');
        event.preventDefault();
    }
    onResize() {
        this.calculateItems();
    }
    ngOnInit() {
        this.pdfViewer.eventBus.on('pagechanging', this.onPageChange);
        this.element.nativeElement.addEventListener('scroll', this.calculateItems, true);
        this.setHeight(this.pdfViewer.currentPageNumber);
        this.items = this.getPages();
        this.calculateItems();
        this.previouslyFocusedElement = this.document.activeElement;
    }
    ngAfterViewInit() {
        this.keyManager = new FocusKeyManager(this.thumbsList);
        this.thumbsList.changes
            .pipe(delay(0))
            .subscribe(() => this.keyManager.setActiveItem(this.getPageIndex(this.pdfViewer.currentPageNumber)));
        setTimeout(() => {
            this.scrollInto(this.pdfViewer.currentPageNumber);
            this.keyManager.setActiveItem(this.getPageIndex(this.pdfViewer.currentPageNumber));
        }, 0);
    }
    ngOnDestroy() {
        this.element.nativeElement.removeEventListener('scroll', this.calculateItems, true);
        this.pdfViewer.eventBus.on('pagechanging', this.onPageChange);
        if (this.previouslyFocusedElement) {
            this.previouslyFocusedElement.focus();
            this.previouslyFocusedElement = null;
        }
    }
    trackByFn(_, item) {
        return item.id;
    }
    isSelected(pageNumber) {
        return this.pdfViewer.currentPageNumber === pageNumber;
    }
    goTo(pageNumber) {
        this.pdfViewer.currentPageNumber = pageNumber;
    }
    scrollInto(pageNumber) {
        if (this.items.length) {
            const index = this.items.findIndex((element) => element.id === pageNumber);
            if (index < 0 || index >= this.items.length) {
                return;
            }
            this.element.nativeElement.scrollTop = index * this.itemHeight;
            this.calculateItems();
        }
    }
    getPages() {
        return this.pdfViewer._pages.map((page) => ({
            id: page.id,
            getWidth: () => {
                return this.width;
            },
            getHeight: () => {
                return this.currentHeight;
            },
            getPage: () => this.pdfViewer.pdfDocument.getPage(page.id)
        }));
    }
    setHeight(id) {
        const height = this.pdfViewer.pdfDocument.getPage(id).then((page) => this.calculateHeight(page));
        return height;
    }
    calculateHeight(page) {
        const viewport = page.getViewport({ scale: 1 });
        const pageRatio = viewport.width / viewport.height;
        const height = Math.floor(this.width / pageRatio);
        this.currentHeight = height;
        this.itemHeight = height + this.margin;
    }
    calculateItems() {
        const { element, viewPort, itemsInView } = this.getContainerSetup();
        const indexByScrollTop = element.scrollTop / viewPort * this.items.length / itemsInView;
        const start = Math.floor(indexByScrollTop);
        const end = Math.ceil(indexByScrollTop) + (itemsInView);
        this.translateY = this.itemHeight * Math.ceil(start);
        this.virtualHeight = this.itemHeight * this.items.length - this.translateY;
        this.renderItems = this.items.slice(start, end);
    }
    getContainerSetup() {
        const element = this.element.nativeElement;
        const elementRec = element.getBoundingClientRect();
        const itemsInView = Math.ceil(elementRec.height / this.itemHeight);
        const viewPort = (this.itemHeight * this.items.length) / itemsInView;
        return {
            element,
            viewPort,
            itemsInView
        };
    }
    onPageChange(event) {
        const index = this.renderItems.findIndex((element) => element.id === event.pageNumber);
        if (index < 0) {
            this.scrollInto(event.pageNumber);
        }
        if (index >= this.renderItems.length - 1) {
            this.element.nativeElement.scrollTop += this.itemHeight;
        }
        this.keyManager.setActiveItem(this.getPageIndex(event.pageNumber));
    }
    getPageIndex(pageNumber) {
        const thumbsListArray = this.thumbsList.toArray();
        return thumbsListArray.findIndex(el => el.page.id === pageNumber);
    }
    canSelectNextItem() {
        return this.pdfViewer.currentPageNumber !== this.pdfViewer.pagesCount;
    }
    canSelectPreviousItem() {
        return this.pdfViewer.currentPageNumber !== 1;
    }
}
PdfThumbListComponent.ɵfac = function PdfThumbListComponent_Factory(t) { return new (t || PdfThumbListComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(DOCUMENT)); };
PdfThumbListComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: PdfThumbListComponent, selectors: [["adf-pdf-thumbnails"]], contentQueries: function PdfThumbListComponent_ContentQueries(rf, ctx, dirIndex) { if (rf & 1) {
        ɵngcc0.ɵɵcontentQuery(dirIndex, TemplateRef, true);
    } if (rf & 2) {
        var _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.template = _t.first);
    } }, viewQuery: function PdfThumbListComponent_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵviewQuery(PdfThumbComponent, true);
    } if (rf & 2) {
        var _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.thumbsList = _t);
    } }, hostAttrs: [1, "adf-pdf-thumbnails"], hostBindings: function PdfThumbListComponent_HostBindings(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵlistener("keydown", function PdfThumbListComponent_keydown_HostBindingHandler($event) { return ctx.onKeydown($event); })("resize", function PdfThumbListComponent_resize_HostBindingHandler() { return ctx.onResize(); }, false, ɵngcc0.ɵɵresolveWindow);
    } }, inputs: { pdfViewer: "pdfViewer" }, outputs: { close: "close" }, decls: 2, vars: 6, consts: [["data-automation-id", "adf-thumbnails-content", 1, "adf-pdf-thumbnails__content"], ["class", "adf-pdf-thumbnails__thumb", 3, "id", "ngClass", "page", "click", 4, "ngFor", "ngForOf", "ngForTrackBy"], [1, "adf-pdf-thumbnails__thumb", 3, "id", "ngClass", "page", "click"]], template: function PdfThumbListComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "div", 0);
        ɵngcc0.ɵɵtemplate(1, PdfThumbListComponent_adf_pdf_thumb_1_Template, 1, 5, "adf-pdf-thumb", 1);
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵstyleProp("height", ctx.virtualHeight, "px")("transform", "translate(-50%, " + ctx.translateY + "px)");
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngForOf", ctx.renderItems)("ngForTrackBy", ctx.trackByFn);
    } }, directives: [ɵngcc1.NgForOf, ɵngcc2.PdfThumbComponent, ɵngcc1.NgClass, ɵngcc3.DefaultClassDirective], styles: [".adf-pdf-thumbnails{display:block;height:100%;overflow:hidden;overflow-y:auto;position:relative}.adf-pdf-thumbnails__content{height:0;left:50%;position:absolute;top:5px}.adf-pdf-thumbnails__thumb{background:var(--theme-background-color);cursor:pointer;display:block;margin-bottom:15px;width:91px}.adf-pdf-thumbnails__thumb:hover{box-shadow:0 0 5px 0 var(--theme-text-bold-color)}.adf-pdf-thumbnails__thumb--selected{border:2px solid var(--theme-accent-color-a200)}"], encapsulation: 2 });
PdfThumbListComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
PdfThumbListComponent.propDecorators = {
    pdfViewer: [{ type: Input }],
    close: [{ type: Output }],
    template: [{ type: ContentChild, args: [TemplateRef,] }],
    thumbsList: [{ type: ViewChildren, args: [PdfThumbComponent,] }],
    onKeydown: [{ type: HostListener, args: ['keydown', ['$event'],] }],
    onResize: [{ type: HostListener, args: ['window:resize',] }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(PdfThumbListComponent, [{
        type: Component,
        args: [{
                selector: 'adf-pdf-thumbnails',
                template: "<div class=\"adf-pdf-thumbnails__content\"\n    data-automation-id='adf-thumbnails-content'\n    [style.height.px]=\"virtualHeight\"\n    [style.transform]=\"'translate(-50%, ' + translateY + 'px)'\">\n    <adf-pdf-thumb *ngFor=\"let page of renderItems; trackBy: trackByFn\"\n        class=\"adf-pdf-thumbnails__thumb\"\n        [id]=\"page.id\"\n        [ngClass]=\"{'adf-pdf-thumbnails__thumb--selected' : isSelected(page.id)}\"\n        [page]=\"page\"\n        (click)=\"goTo(page.id)\">\n    </adf-pdf-thumb>\n</div>\n",
                host: { class: 'adf-pdf-thumbnails' },
                encapsulation: ViewEncapsulation.None,
                styles: [".adf-pdf-thumbnails{display:block;height:100%;overflow:hidden;overflow-y:auto;position:relative}.adf-pdf-thumbnails__content{height:0;left:50%;position:absolute;top:5px}.adf-pdf-thumbnails__thumb{background:var(--theme-background-color);cursor:pointer;display:block;margin-bottom:15px;width:91px}.adf-pdf-thumbnails__thumb:hover{box-shadow:0 0 5px 0 var(--theme-text-bold-color)}.adf-pdf-thumbnails__thumb--selected{border:2px solid var(--theme-accent-color-a200)}"]
            }]
    }], function () { return [{ type: ɵngcc0.ElementRef }, { type: undefined, decorators: [{
                type: Inject,
                args: [DOCUMENT]
            }] }]; }, { close: [{
            type: Output
        }], onKeydown: [{
            type: HostListener,
            args: ['keydown', ['$event']]
        }], onResize: [{
            type: HostListener,
            args: ['window:resize']
        }], pdfViewer: [{
            type: Input
        }], template: [{
            type: ContentChild,
            args: [TemplateRef]
        }], thumbsList: [{
            type: ViewChildren,
            args: [PdfThumbComponent]
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGRmLXZpZXdlci10aHVtYm5haWxzLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvcmUvdmlld2VyL2NvbXBvbmVudHMvcGRmLXZpZXdlci10aHVtYm5haWxzLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBRUgsT0FBTyxFQUNILFNBQVMsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQzFDLFVBQVUsRUFBYSxpQkFBaUIsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUNqSCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNyRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFTdkMsTUFBTSxPQUFPLHFCQUFxQjtBQUFHLElBaURqQyxZQUFvQixPQUFtQixFQUE0QixRQUFhO0FBQ3BGLFFBRHdCLFlBQU8sR0FBUCxPQUFPLENBQVk7QUFBQyxRQUEyQixhQUFRLEdBQVIsUUFBUSxDQUFLO0FBQUMsUUE3Q2pGLFVBQUssR0FBc0IsSUFBSSxZQUFZLEVBQVEsQ0FBQztB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LDRDQWdFYSxNQUFNLFNBQUMsUUFBUTtBQUFRO0FBQUc7QUFDL0Msd0JBakRwQixLQUFLO0FBQUssb0JBRVYsTUFBTTtBQUNULHVCQWNHLFlBQVksU0FBQyxXQUFXO0FBQ3hCLHlCQUVBLFlBQVksU0FBQyxpQkFBaUI7QUFDOUIsd0JBRUEsWUFBWSxTQUFDLFNBQVMsRUFBRSxDQUFDLFFBQVEsQ0FBQztBQUNsQyx1QkFtQkEsWUFBWSxTQUFDLGVBQWU7QUFDN0I7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O29CQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1xuICAgIENvbXBvbmVudCwgSW5wdXQsIENvbnRlbnRDaGlsZCwgVGVtcGxhdGVSZWYsIEhvc3RMaXN0ZW5lciwgT25Jbml0LFxuICAgIEFmdGVyVmlld0luaXQsIEVsZW1lbnRSZWYsIE9uRGVzdHJveSwgVmlld0VuY2Fwc3VsYXRpb24sIEV2ZW50RW1pdHRlciwgT3V0cHV0LCBJbmplY3QsIFZpZXdDaGlsZHJlbiwgUXVlcnlMaXN0XG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRVNDQVBFLCBVUF9BUlJPVywgRE9XTl9BUlJPVyB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9rZXljb2Rlcyc7XG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBGb2N1c0tleU1hbmFnZXIgfSBmcm9tICdAYW5ndWxhci9jZGsvYTExeSc7XG5pbXBvcnQgeyBQZGZUaHVtYkNvbXBvbmVudCB9IGZyb20gJy4vcGRmLXZpZXdlci10aHVtYi5jb21wb25lbnQnO1xuaW1wb3J0IHsgZGVsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAnYWRmLXBkZi10aHVtYm5haWxzJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vcGRmLXZpZXdlci10aHVtYm5haWxzLmNvbXBvbmVudC5odG1sJyxcbiAgICBzdHlsZVVybHM6IFsnLi9wZGYtdmlld2VyLXRodW1ibmFpbHMuY29tcG9uZW50LnNjc3MnXSxcbiAgICBob3N0OiB7IGNsYXNzOiAnYWRmLXBkZi10aHVtYm5haWxzJyB9LFxuICAgIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmVcbn0pXG5leHBvcnQgY2xhc3MgUGRmVGh1bWJMaXN0Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xuICAgIEBJbnB1dCgpIHBkZlZpZXdlcjogYW55O1xuXG4gICAgQE91dHB1dCgpXG4gICAgY2xvc2U6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuXG4gICAgdmlydHVhbEhlaWdodDogbnVtYmVyID0gMDtcbiAgICB0cmFuc2xhdGVZOiBudW1iZXIgPSAwO1xuICAgIHJlbmRlckl0ZW1zID0gW107XG4gICAgd2lkdGg6IG51bWJlciA9IDkxO1xuICAgIGN1cnJlbnRIZWlnaHQ6IG51bWJlciA9IDA7XG5cbiAgICBwcml2YXRlIGl0ZW1zID0gW107XG4gICAgcHJpdmF0ZSBtYXJnaW46IG51bWJlciA9IDE1O1xuICAgIHByaXZhdGUgaXRlbUhlaWdodDogbnVtYmVyID0gMTE0ICsgdGhpcy5tYXJnaW47XG4gICAgcHJpdmF0ZSBwcmV2aW91c2x5Rm9jdXNlZEVsZW1lbnQ6IEhUTUxFbGVtZW50IHwgbnVsbCA9IG51bGw7XG4gICAgcHJpdmF0ZSBrZXlNYW5hZ2VyOiBGb2N1c0tleU1hbmFnZXI8UGRmVGh1bWJDb21wb25lbnQ+O1xuXG4gICAgQENvbnRlbnRDaGlsZChUZW1wbGF0ZVJlZilcbiAgICB0ZW1wbGF0ZTogYW55O1xuXG4gICAgQFZpZXdDaGlsZHJlbihQZGZUaHVtYkNvbXBvbmVudClcbiAgICB0aHVtYnNMaXN0OiBRdWVyeUxpc3Q8UGRmVGh1bWJDb21wb25lbnQ+O1xuXG4gICAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bicsIFsnJGV2ZW50J10pXG4gICAgb25LZXlkb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGtleUNvZGUgPSBldmVudC5rZXlDb2RlO1xuXG4gICAgICAgIGlmIChrZXlDb2RlID09PSBVUF9BUlJPVyAmJiB0aGlzLmNhblNlbGVjdFByZXZpb3VzSXRlbSgpKSB7XG4gICAgICAgICAgICB0aGlzLnBkZlZpZXdlci5jdXJyZW50UGFnZU51bWJlciAtPSAxO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGtleUNvZGUgPT09IERPV05fQVJST1cgJiYgdGhpcy5jYW5TZWxlY3ROZXh0SXRlbSgpKSB7XG4gICAgICAgICAgICB0aGlzLnBkZlZpZXdlci5jdXJyZW50UGFnZU51bWJlciArPSAxO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGtleUNvZGUgPT09IEVTQ0FQRSkge1xuICAgICAgICAgICAgdGhpcy5jbG9zZS5lbWl0KCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmtleU1hbmFnZXIuc2V0Rm9jdXNPcmlnaW4oJ2tleWJvYXJkJyk7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgfVxuXG4gICAgQEhvc3RMaXN0ZW5lcignd2luZG93OnJlc2l6ZScpXG4gICAgb25SZXNpemUoKSB7XG4gICAgICAgIHRoaXMuY2FsY3VsYXRlSXRlbXMoKTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsZW1lbnQ6IEVsZW1lbnRSZWYsIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgZG9jdW1lbnQ6IGFueSkge1xuICAgICAgICB0aGlzLmNhbGN1bGF0ZUl0ZW1zID0gdGhpcy5jYWxjdWxhdGVJdGVtcy5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLm9uUGFnZUNoYW5nZSA9IHRoaXMub25QYWdlQ2hhbmdlLmJpbmQodGhpcyk7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIC8qIGNzcGVsbDpkaXNhYmxlLW5leHQtbGluZSAqL1xuICAgICAgICB0aGlzLnBkZlZpZXdlci5ldmVudEJ1cy5vbigncGFnZWNoYW5naW5nJywgdGhpcy5vblBhZ2VDaGFuZ2UpO1xuICAgICAgICB0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLmNhbGN1bGF0ZUl0ZW1zLCB0cnVlKTtcblxuICAgICAgICB0aGlzLnNldEhlaWdodCh0aGlzLnBkZlZpZXdlci5jdXJyZW50UGFnZU51bWJlcik7XG4gICAgICAgIHRoaXMuaXRlbXMgPSB0aGlzLmdldFBhZ2VzKCk7XG4gICAgICAgIHRoaXMuY2FsY3VsYXRlSXRlbXMoKTtcblxuICAgICAgICB0aGlzLnByZXZpb3VzbHlGb2N1c2VkRWxlbWVudCA9IHRoaXMuZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBhcyBIVE1MRWxlbWVudDtcbiAgICB9XG5cbiAgICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgICAgIHRoaXMua2V5TWFuYWdlciA9IG5ldyBGb2N1c0tleU1hbmFnZXIodGhpcy50aHVtYnNMaXN0KTtcblxuICAgICAgICB0aGlzLnRodW1ic0xpc3QuY2hhbmdlc1xuICAgICAgICAgICAgLnBpcGUoZGVsYXkoMCkpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHRoaXMua2V5TWFuYWdlci5zZXRBY3RpdmVJdGVtKHRoaXMuZ2V0UGFnZUluZGV4KHRoaXMucGRmVmlld2VyLmN1cnJlbnRQYWdlTnVtYmVyKSkpO1xuXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zY3JvbGxJbnRvKHRoaXMucGRmVmlld2VyLmN1cnJlbnRQYWdlTnVtYmVyKTtcbiAgICAgICAgICAgIHRoaXMua2V5TWFuYWdlci5zZXRBY3RpdmVJdGVtKHRoaXMuZ2V0UGFnZUluZGV4KHRoaXMucGRmVmlld2VyLmN1cnJlbnRQYWdlTnVtYmVyKSk7XG4gICAgICAgIH0sIDApO1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCkge1xuICAgICAgICB0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLmNhbGN1bGF0ZUl0ZW1zLCB0cnVlKTtcbiAgICAgICAgLyogY3NwZWxsOmRpc2FibGUtbmV4dC1saW5lICovXG4gICAgICAgIHRoaXMucGRmVmlld2VyLmV2ZW50QnVzLm9uKCdwYWdlY2hhbmdpbmcnLCB0aGlzLm9uUGFnZUNoYW5nZSk7XG5cbiAgICAgICAgaWYgKHRoaXMucHJldmlvdXNseUZvY3VzZWRFbGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLnByZXZpb3VzbHlGb2N1c2VkRWxlbWVudC5mb2N1cygpO1xuICAgICAgICAgICAgdGhpcy5wcmV2aW91c2x5Rm9jdXNlZEVsZW1lbnQgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdHJhY2tCeUZuKF86IG51bWJlciwgaXRlbTogYW55KTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIGl0ZW0uaWQ7XG4gICAgfVxuXG4gICAgaXNTZWxlY3RlZChwYWdlTnVtYmVyOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGRmVmlld2VyLmN1cnJlbnRQYWdlTnVtYmVyID09PSBwYWdlTnVtYmVyO1xuICAgIH1cblxuICAgIGdvVG8ocGFnZU51bWJlcjogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMucGRmVmlld2VyLmN1cnJlbnRQYWdlTnVtYmVyID0gcGFnZU51bWJlcjtcbiAgICB9XG5cbiAgICBzY3JvbGxJbnRvKHBhZ2VOdW1iZXI6IG51bWJlcikge1xuICAgICAgICBpZiAodGhpcy5pdGVtcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNvbnN0IGluZGV4OiBudW1iZXIgPSB0aGlzLml0ZW1zLmZpbmRJbmRleCgoZWxlbWVudCkgPT4gZWxlbWVudC5pZCA9PT0gcGFnZU51bWJlcik7XG5cbiAgICAgICAgICAgIGlmIChpbmRleCA8IDAgfHwgaW5kZXggPj0gdGhpcy5pdGVtcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50LnNjcm9sbFRvcCA9IGluZGV4ICogdGhpcy5pdGVtSGVpZ2h0O1xuXG4gICAgICAgICAgICB0aGlzLmNhbGN1bGF0ZUl0ZW1zKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRQYWdlcygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGRmVmlld2VyLl9wYWdlcy5tYXAoKHBhZ2UpID0+ICh7XG4gICAgICAgICAgICBpZDogcGFnZS5pZCxcbiAgICAgICAgICAgIGdldFdpZHRoOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMud2lkdGg7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZ2V0SGVpZ2h0OiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEhlaWdodDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBnZXRQYWdlOiAoKSA9PiB0aGlzLnBkZlZpZXdlci5wZGZEb2N1bWVudC5nZXRQYWdlKHBhZ2UuaWQpXG4gICAgICAgIH0pKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNldEhlaWdodChpZCk6IG51bWJlciB7XG4gICAgICAgIGNvbnN0IGhlaWdodCA9IHRoaXMucGRmVmlld2VyLnBkZkRvY3VtZW50LmdldFBhZ2UoaWQpLnRoZW4oKHBhZ2UpID0+IHRoaXMuY2FsY3VsYXRlSGVpZ2h0KHBhZ2UpKTtcbiAgICAgICAgcmV0dXJuIGhlaWdodDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbGN1bGF0ZUhlaWdodChwYWdlKSB7XG4gICAgICAgIGNvbnN0IHZpZXdwb3J0ID0gcGFnZS5nZXRWaWV3cG9ydCh7IHNjYWxlOiAxIH0pO1xuICAgICAgICBjb25zdCBwYWdlUmF0aW8gPSB2aWV3cG9ydC53aWR0aCAvIHZpZXdwb3J0LmhlaWdodDtcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gTWF0aC5mbG9vcih0aGlzLndpZHRoIC8gcGFnZVJhdGlvKTtcblxuICAgICAgICB0aGlzLmN1cnJlbnRIZWlnaHQgPSBoZWlnaHQ7XG4gICAgICAgIHRoaXMuaXRlbUhlaWdodCA9IGhlaWdodCArIHRoaXMubWFyZ2luO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsY3VsYXRlSXRlbXMoKSB7XG4gICAgICAgIGNvbnN0IHsgZWxlbWVudCwgdmlld1BvcnQsIGl0ZW1zSW5WaWV3IH0gPSB0aGlzLmdldENvbnRhaW5lclNldHVwKCk7XG5cbiAgICAgICAgY29uc3QgaW5kZXhCeVNjcm9sbFRvcCA9IGVsZW1lbnQuc2Nyb2xsVG9wIC8gdmlld1BvcnQgKiB0aGlzLml0ZW1zLmxlbmd0aCAvIGl0ZW1zSW5WaWV3O1xuXG4gICAgICAgIGNvbnN0IHN0YXJ0ID0gTWF0aC5mbG9vcihpbmRleEJ5U2Nyb2xsVG9wKTtcblxuICAgICAgICBjb25zdCBlbmQgPSBNYXRoLmNlaWwoaW5kZXhCeVNjcm9sbFRvcCkgKyAoaXRlbXNJblZpZXcpO1xuXG4gICAgICAgIHRoaXMudHJhbnNsYXRlWSA9IHRoaXMuaXRlbUhlaWdodCAqIE1hdGguY2VpbChzdGFydCk7XG4gICAgICAgIHRoaXMudmlydHVhbEhlaWdodCA9IHRoaXMuaXRlbUhlaWdodCAqIHRoaXMuaXRlbXMubGVuZ3RoIC0gdGhpcy50cmFuc2xhdGVZO1xuICAgICAgICB0aGlzLnJlbmRlckl0ZW1zID0gdGhpcy5pdGVtcy5zbGljZShzdGFydCwgZW5kKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldENvbnRhaW5lclNldHVwKCkge1xuICAgICAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQ7XG4gICAgICAgIGNvbnN0IGVsZW1lbnRSZWMgPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgICBjb25zdCBpdGVtc0luVmlldyA9IE1hdGguY2VpbChlbGVtZW50UmVjLmhlaWdodCAvIHRoaXMuaXRlbUhlaWdodCk7XG4gICAgICAgIGNvbnN0IHZpZXdQb3J0ID0gKHRoaXMuaXRlbUhlaWdodCAqIHRoaXMuaXRlbXMubGVuZ3RoKSAvIGl0ZW1zSW5WaWV3O1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBlbGVtZW50LFxuICAgICAgICAgICAgdmlld1BvcnQsXG4gICAgICAgICAgICBpdGVtc0luVmlld1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgb25QYWdlQ2hhbmdlKGV2ZW50KSB7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5yZW5kZXJJdGVtcy5maW5kSW5kZXgoKGVsZW1lbnQpID0+IGVsZW1lbnQuaWQgPT09IGV2ZW50LnBhZ2VOdW1iZXIpO1xuXG4gICAgICAgIGlmIChpbmRleCA8IDApIHtcbiAgICAgICAgICAgIHRoaXMuc2Nyb2xsSW50byhldmVudC5wYWdlTnVtYmVyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpbmRleCA+PSB0aGlzLnJlbmRlckl0ZW1zLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50LnNjcm9sbFRvcCArPSB0aGlzLml0ZW1IZWlnaHQ7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmtleU1hbmFnZXIuc2V0QWN0aXZlSXRlbSh0aGlzLmdldFBhZ2VJbmRleChldmVudC5wYWdlTnVtYmVyKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRQYWdlSW5kZXgocGFnZU51bWJlcjogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgY29uc3QgdGh1bWJzTGlzdEFycmF5ID0gdGhpcy50aHVtYnNMaXN0LnRvQXJyYXkoKTtcbiAgICAgICAgcmV0dXJuIHRodW1ic0xpc3RBcnJheS5maW5kSW5kZXgoZWwgPT4gZWwucGFnZS5pZCA9PT0gcGFnZU51bWJlcik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYW5TZWxlY3ROZXh0SXRlbSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGRmVmlld2VyLmN1cnJlbnRQYWdlTnVtYmVyICE9PSB0aGlzLnBkZlZpZXdlci5wYWdlc0NvdW50O1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FuU2VsZWN0UHJldmlvdXNJdGVtKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wZGZWaWV3ZXIuY3VycmVudFBhZ2VOdW1iZXIgIT09IDE7XG4gICAgfVxufVxuIl19