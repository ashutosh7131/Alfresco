import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { ContentApi, RenditionsApi, VersionsApi } from '@alfresco/js-api';
import { AlfrescoApiService } from '../../services/alfresco-api.service';
import { LogService } from '../../services/log.service';
import { Subject } from 'rxjs';
import { TranslationService } from '../../services/translation.service';
import * as i0 from "@angular/core";
import * as i1 from "../../services/alfresco-api.service";
import * as i2 from "../../services/log.service";
import * as i3 from "../../services/translation.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../../services/alfresco-api.service';
import * as ɵngcc2 from '../../services/log.service';
import * as ɵngcc3 from '../../services/translation.service';
export class ViewUtilService {
    constructor(apiService, logService, translateService) {
        this.apiService = apiService;
        this.logService = logService;
        this.translateService = translateService;
        this.maxRetries = 5;
        this.mimeTypes = {
            text: ['text/plain', 'text/csv', 'text/xml', 'text/html', 'application/x-javascript'],
            pdf: ['application/pdf'],
            image: ['image/png', 'image/jpeg', 'image/gif', 'image/bmp', 'image/svg+xml'],
            media: ['video/mp4', 'video/webm', 'video/ogg', 'audio/mpeg', 'audio/ogg', 'audio/wav']
        };
        this.TRY_TIMEOUT = 10000;
        this.viewerTypeChange = new Subject();
        this.urlFileContentChange = new Subject();
    }
    get renditionsApi() {
        var _a;
        this._renditionsApi = (_a = this._renditionsApi) !== null && _a !== void 0 ? _a : new RenditionsApi(this.apiService.getInstance());
        return this._renditionsApi;
    }
    get contentApi() {
        var _a;
        this._contentApi = (_a = this._contentApi) !== null && _a !== void 0 ? _a : new ContentApi(this.apiService.getInstance());
        return this._contentApi;
    }
    get versionsApi() {
        var _a;
        this._versionsApi = (_a = this._versionsApi) !== null && _a !== void 0 ? _a : new VersionsApi(this.apiService.getInstance());
        return this._versionsApi;
    }
    printFile(url, type) {
        const pwa = window.open(url, ViewUtilService.TARGET);
        if (pwa) {
            if (type === ViewUtilService.ContentGroup.IMAGE) {
                pwa.onfocus = () => {
                    setTimeout(() => {
                        pwa.close();
                    }, 500);
                };
            }
            pwa.onload = () => {
                pwa.print();
            };
        }
    }
    printFileGeneric(objectId, mimeType) {
        const nodeId = objectId;
        const type = this.getViewerTypeByMimeType(mimeType);
        this.getRendition(nodeId, ViewUtilService.ContentGroup.PDF)
            .then((value) => {
            const url = this.getRenditionUrl(nodeId, type, (!!value));
            const printType = (type === ViewUtilService.ContentGroup.PDF
                || type === ViewUtilService.ContentGroup.TEXT)
                ? ViewUtilService.ContentGroup.PDF : type;
            this.printFile(url, printType);
        })
            .catch((err) => {
            this.logService.error('Error with Printing');
            this.logService.error(err);
        });
    }
    getRenditionUrl(nodeId, type, renditionExists) {
        return (renditionExists && type !== ViewUtilService.ContentGroup.IMAGE) ?
            this.contentApi.getRenditionUrl(nodeId, ViewUtilService.ContentGroup.PDF) :
            this.contentApi.getContentUrl(nodeId, false);
    }
    waitRendition(nodeId, renditionId, retries) {
        return __awaiter(this, void 0, void 0, function* () {
            const rendition = yield this.renditionsApi.getRendition(nodeId, renditionId);
            if (this.maxRetries < retries) {
                const status = rendition.entry.status.toString();
                if (status === 'CREATED') {
                    return rendition;
                }
                else {
                    retries += 1;
                    yield this.wait(1000);
                    return this.waitRendition(nodeId, renditionId, retries);
                }
            }
            return Promise.resolve(null);
        });
    }
    getViewerTypeByMimeType(mimeType) {
        if (mimeType) {
            mimeType = mimeType.toLowerCase();
            const editorTypes = Object.keys(this.mimeTypes);
            for (const type of editorTypes) {
                if (this.mimeTypes[type].indexOf(mimeType) >= 0) {
                    return type;
                }
            }
        }
        return 'unknown';
    }
    wait(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
    }
    getRendition(nodeId, renditionId) {
        return __awaiter(this, void 0, void 0, function* () {
            const renditionPaging = yield this.renditionsApi.listRenditions(nodeId);
            let rendition = renditionPaging.list.entries.find((renditionEntry) => renditionEntry.entry.id.toLowerCase() === renditionId);
            if (rendition) {
                const status = rendition.entry.status.toString();
                if (status === 'NOT_CREATED') {
                    try {
                        yield this.renditionsApi.createRendition(nodeId, { id: renditionId });
                        rendition = yield this.waitRendition(nodeId, renditionId, 0);
                    }
                    catch (err) {
                        this.logService.error(err);
                    }
                }
            }
            return new Promise((resolve) => resolve(rendition));
        });
    }
    displayNodeRendition(nodeId, versionId) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const rendition = versionId ? yield this.resolveNodeRendition(nodeId, 'pdf', versionId) :
                    yield this.resolveNodeRendition(nodeId, 'pdf');
                if (rendition) {
                    const renditionId = rendition.entry.id;
                    if (renditionId === 'pdf') {
                        this.viewerTypeChange.next('pdf');
                    }
                    else if (renditionId === 'imgpreview') {
                        this.viewerTypeChange.next('image');
                    }
                    const urlFileContent = versionId ? this.contentApi.getVersionRenditionUrl(nodeId, versionId, renditionId) :
                        this.contentApi.getRenditionUrl(nodeId, renditionId);
                    this.urlFileContentChange.next(urlFileContent);
                }
            }
            catch (err) {
                this.logService.error(err);
            }
        });
    }
    resolveNodeRendition(nodeId, renditionId, versionId) {
        return __awaiter(this, void 0, void 0, function* () {
            renditionId = renditionId.toLowerCase();
            const supportedRendition = versionId ? yield this.versionsApi.listVersionRenditions(nodeId, versionId) :
                yield this.renditionsApi.listRenditions(nodeId);
            let rendition = supportedRendition.list.entries.find((renditionEntry) => renditionEntry.entry.id.toLowerCase() === renditionId);
            if (!rendition) {
                renditionId = 'imgpreview';
                rendition = supportedRendition.list.entries.find((renditionEntry) => renditionEntry.entry.id.toLowerCase() === renditionId);
            }
            if (rendition) {
                const status = rendition.entry.status.toString();
                if (status === 'NOT_CREATED') {
                    try {
                        if (versionId) {
                            yield this.versionsApi.createVersionRendition(nodeId, versionId, { id: renditionId }).then(() => {
                                this.viewerTypeChange.next('in_creation');
                            });
                        }
                        else {
                            yield this.renditionsApi.createRendition(nodeId, { id: renditionId }).then(() => {
                                this.viewerTypeChange.next('in_creation');
                            });
                        }
                        try {
                            rendition = versionId ? yield this.waitNodeRendition(nodeId, renditionId, versionId) : yield this.waitNodeRendition(nodeId, renditionId);
                        }
                        catch (e) {
                            this.viewerTypeChange.next('error_in_creation');
                            rendition = null;
                        }
                    }
                    catch (err) {
                        this.logService.error(err);
                    }
                }
            }
            return rendition;
        });
    }
    waitNodeRendition(nodeId, renditionId, versionId) {
        return __awaiter(this, void 0, void 0, function* () {
            let currentRetry = 0;
            return new Promise((resolve, reject) => {
                const intervalId = setInterval(() => {
                    currentRetry++;
                    if (this.maxRetries >= currentRetry) {
                        if (versionId) {
                            this.versionsApi.getVersionRendition(nodeId, versionId, renditionId).then((rendition) => {
                                const status = rendition.entry.status.toString();
                                if (status === 'CREATED') {
                                    this.handleNodeRendition(nodeId, renditionId, versionId);
                                    clearInterval(intervalId);
                                    return resolve(rendition);
                                }
                            }, () => {
                                return reject();
                            });
                        }
                        else {
                            this.renditionsApi.getRendition(nodeId, renditionId).then((rendition) => {
                                const status = rendition.entry.status.toString();
                                if (status === 'CREATED') {
                                    this.handleNodeRendition(nodeId, renditionId);
                                    clearInterval(intervalId);
                                    return resolve(rendition);
                                }
                            }, () => {
                                return reject();
                            });
                        }
                    }
                    else {
                        clearInterval(intervalId);
                        return reject();
                    }
                }, this.TRY_TIMEOUT);
            });
        });
    }
    handleNodeRendition(nodeId, renditionId, versionId) {
        return __awaiter(this, void 0, void 0, function* () {
            if (renditionId === 'pdf') {
                this.viewerTypeChange.next('pdf');
            }
            else if (renditionId === 'imgpreview') {
                this.viewerTypeChange.next('image');
            }
            const urlFileContent = versionId ? this.contentApi.getVersionRenditionUrl(nodeId, versionId, renditionId) :
                this.contentApi.getRenditionUrl(nodeId, renditionId);
            this.urlFileContentChange.next(urlFileContent);
        });
    }
    generateMediaTracks(nodeId) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.isRenditionAvailable(nodeId, ViewUtilService.SUBTITLES_RENDITION_NAME)
                .then((value) => {
                const tracks = [];
                if (value) {
                    tracks.push({
                        kind: 'subtitles',
                        src: this.contentApi.getRenditionUrl(nodeId, ViewUtilService.SUBTITLES_RENDITION_NAME),
                        label: this.translateService.instant('ADF_VIEWER.SUBTITLES')
                    });
                }
                return tracks;
            })
                .catch((err) => {
                this.logService.error('Error while retrieving ' + ViewUtilService.SUBTITLES_RENDITION_NAME + ' rendition');
                this.logService.error(err);
                return [];
            });
        });
    }
    isRenditionAvailable(nodeId, renditionId) {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function* () {
            const renditionPaging = yield this.renditionsApi.listRenditions(nodeId);
            const rendition = renditionPaging.list.entries.find((renditionEntry) => renditionEntry.entry.id.toLowerCase() === renditionId);
            return ((_b = (_a = rendition === null || rendition === void 0 ? void 0 : rendition.entry) === null || _a === void 0 ? void 0 : _a.status) === null || _b === void 0 ? void 0 : _b.toString()) === 'CREATED' || false;
        });
    }
}
ViewUtilService.ɵfac = function ViewUtilService_Factory(t) { return new (t || ViewUtilService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc2.LogService), ɵngcc0.ɵɵinject(ɵngcc3.TranslationService)); };
ViewUtilService.TARGET = '_new';
ViewUtilService.ContentGroup = {
    IMAGE: 'image',
    MEDIA: 'media',
    PDF: 'pdf',
    TEXT: 'text'
};
ViewUtilService.SUBTITLES_RENDITION_NAME = 'webvtt';
ViewUtilService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ViewUtilService_Factory() { return new ViewUtilService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i2.LogService), i0.ɵɵinject(i3.TranslationService)); }, token: ViewUtilService, providedIn: "root" });
ViewUtilService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: LogService },
    { type: TranslationService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ViewUtilService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc2.LogService }, { type: ɵngcc3.TranslationService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlldy11dGlsLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb3JlL3ZpZXdlci9zZXJ2aWNlcy92aWV3LXV0aWwuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBbUMsYUFBYSxFQUFFLFdBQVcsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzNHLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRS9CLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQ3hFO0FBRXNCO0FBR0U7QUFHYTs7Ozs7QUFKckMsTUFBTSxPQUFPLGVBQWU7QUFDNUIsSUFpRUksWUFBb0IsVUFBOEIsRUFDOUIsVUFBc0IsRUFDdEIsZ0JBQW9DO0FBQzVELFFBSHdCLGVBQVUsR0FBVixVQUFVLENBQW9CO0FBQUMsUUFDL0IsZUFBVSxHQUFWLFVBQVUsQ0FBWTtBQUFDLFFBQ3ZCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBb0I7QUFBQyxRQTNDekQsZUFBVSxHQUFHLENBQUMsQ0FBQztBQUNuQixRQUlZLGNBQVMsR0FBRztBQUN4QixZQUFRLElBQUksRUFBRSxDQUFDLFlBQVksRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSwwQkFBMEIsQ0FBQztBQUM3RixZQUFRLEdBQUcsRUFBRSxDQUFDLGlCQUFpQixDQUFDO0FBQ2hDLFlBQVEsS0FBSyxFQUFFLENBQUMsV0FBVyxFQUFFLFlBQVks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QUMzQyxnQkFBZ0IsT0FBTyxFQUFFLENBQUM7QUFDMUIsWUFBWSxDQUFDLENBQUMsQ0FBQztBQUNmLFFBQUksQ0FBQztBQUVKLEtBRkk7QUFDTCxJQUNrQixvQkFBb0IsQ0FBQyxNQUFjLEVBQUUsV0FBbUI7QUFBSTtBQUM1RTtBQUE4RCxZQUF4RCxNQUFNLGVBQWUsR0FBb0IsTUFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNqRyxZQUFRLE1BQU0sU0FBUyxHQUFtQixlQUFlLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxjQUE4QixFQUFFLEVBQUUsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxXQUFXLEVBQUUsS0FBSyxXQUFXLENBQUMsQ0FBQztBQUN2SyxZQUNRLE9BQU8sYUFBQSxTQUFTLGFBQVQsU0FBUyx1QkFBVCxTQUFTLENBQUUsS0FBSywwQ0FBRSxNQUFNLDBDQUFFLFFBQVEsUUFBTyxTQUFTLElBQUksS0FBSyxDQUFDO0FBQzNFO0FBRUksS0FGQztBQUNMOzhOQUFDO0FBaFVVLHNCQUFNLEdBQUcsTUFBTSxDQUFDO0FBT2hCLDRCQUFZLEdBQUc7QUFDMUIsSUFBUSxLQUFLLEVBQUUsT0FBTztBQUN0QixJQUFRLEtBQUssRUFBRSxPQUFPO0FBQ3RCLElBQVEsR0FBRyxFQUFFLEtBQUs7QUFDbEIsSUFBUSxJQUFJLEVBQUUsTUFBTTtBQUNwQixDQUFLLENBQUM7QUFNSyx3Q0FBd0IsR0FBRyxRQUFRLENBQUM7QUFDL0MsK1FBcEJLO0FBQUM7RUFITCxVQUFVLFNBQUMsckJBSUksWUFWUCxrQkFBa0I7S0FPdkIsVUFBVSxFQUFFLE1BQU0sdkJBUFMsWUFDdEIsVUFBVTtXQU9sQixYQVBzQixZQUdkLGtCQUFrQjtBQUFHOzs7Ozs7cUpBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbnRlbnRBcGksIFJlbmRpdGlvbkVudHJ5LCBSZW5kaXRpb25QYWdpbmcsIFJlbmRpdGlvbnNBcGksIFZlcnNpb25zQXBpIH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9hbGZyZXNjby1hcGkuc2VydmljZSc7XG5pbXBvcnQgeyBMb2dTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvbG9nLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgVHJhY2sgfSBmcm9tICcuLi9tb2RlbHMvdmlld2VyLm1vZGVsJztcbmltcG9ydCB7IFRyYW5zbGF0aW9uU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3RyYW5zbGF0aW9uLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFZpZXdVdGlsU2VydmljZSB7XG4gICAgc3RhdGljIFRBUkdFVCA9ICdfbmV3JztcblxuICAgIC8qKlxuICAgICAqIENvbnRlbnQgZ3JvdXBzIGJhc2VkIG9uIGNhdGVnb3JpemF0aW9uIG9mIGZpbGVzIHRoYXQgY2FuIGJlIHZpZXdlZCBpbiB0aGUgd2ViIGJyb3dzZXIuIFRoaXNcbiAgICAgKiBpbXBsZW1lbnRhdGlvbiBvciBncm91cGluZyBpcyB0aWVkIHRvIHRoZSBkZWZpbml0aW9uIHRoZSBuZyBjb21wb25lbnQ6IFZpZXdlckNvbXBvbmVudFxuICAgICAqL1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dmFyaWFibGUtbmFtZVxuICAgIHN0YXRpYyBDb250ZW50R3JvdXAgPSB7XG4gICAgICAgIElNQUdFOiAnaW1hZ2UnLFxuICAgICAgICBNRURJQTogJ21lZGlhJyxcbiAgICAgICAgUERGOiAncGRmJyxcbiAgICAgICAgVEVYVDogJ3RleHQnXG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIFRoZSBuYW1lIG9mIHRoZSByZW5kaXRpb24gd2l0aCB0aGUgbWVkaWEgc3VidGl0bGVzIGluIHRoZSBzdXBwb3J0ZWQgZm9ybWF0XG4gICAgICovXG4gICAgLyogdHNsaW50OmRpc2FibGUtbmV4dC1saW5lICovXG4gICAgc3RhdGljIFNVQlRJVExFU19SRU5ESVRJT05fTkFNRSA9ICd3ZWJ2dHQnO1xuXG4gICAgLyoqXG4gICAgICogQmFzZWQgb24gVmlld2VyQ29tcG9uZW50IEltcGxlbWVudGF0aW9uLCB0aGlzIHZhbHVlIGlzIHVzZWQgdG8gZGV0ZXJtaW5lIGhvdyBtYW55IHRpbWVzIHdlIHRyeVxuICAgICAqIHRvIGdldCB0aGUgcmVuZGl0aW9uIG9mIGEgZmlsZSBmb3IgcHJldmlldywgb3IgcHJpbnRpbmcuXG4gICAgICovXG4gICAgbWF4UmV0cmllcyA9IDU7XG5cbiAgICAvKipcbiAgICAgKiBNaW1lLXR5cGUgZ3JvdXBpbmcgYmFzZWQgb24gdGhlIFZpZXdlckNvbXBvbmVudC5cbiAgICAgKi9cbiAgICBwcml2YXRlIG1pbWVUeXBlcyA9IHtcbiAgICAgICAgdGV4dDogWyd0ZXh0L3BsYWluJywgJ3RleHQvY3N2JywgJ3RleHQveG1sJywgJ3RleHQvaHRtbCcsICdhcHBsaWNhdGlvbi94LWphdmFzY3JpcHQnXSxcbiAgICAgICAgcGRmOiBbJ2FwcGxpY2F0aW9uL3BkZiddLFxuICAgICAgICBpbWFnZTogWydpbWFnZS9wbmcnLCAnaW1hZ2UvanBlZycsICdpbWFnZS9naWYnLCAnaW1hZ2UvYm1wJywgJ2ltYWdlL3N2Zyt4bWwnXSxcbiAgICAgICAgbWVkaWE6IFsndmlkZW8vbXA0JywgJ3ZpZGVvL3dlYm0nLCAndmlkZW8vb2dnJywgJ2F1ZGlvL21wZWcnLCAnYXVkaW8vb2dnJywgJ2F1ZGlvL3dhdiddXG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIFRpbWVvdXQgdXNlZCBmb3Igc2V0SW50ZXJ2YWwuXG4gICAgICovXG4gICAgVFJZX1RJTUVPVVQ6IG51bWJlciA9IDEwMDAwO1xuXG4gICAgLyoqXG4gICAgICogU3Vic2NyaWJlcnMgbmVlZGVkIGZvciBWaWV3ZXJDb21wb25lbnQgdG8gdXBkYXRlIHRoZSB2aWV3ZXJUeXBlIGFuZCB1cmxGaWxlQ29udGVudC5cbiAgICAgKi9cbiAgICB2aWV3ZXJUeXBlQ2hhbmdlOiBTdWJqZWN0PHN0cmluZz4gPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XG4gICAgdXJsRmlsZUNvbnRlbnRDaGFuZ2U6IFN1YmplY3Q8c3RyaW5nPiA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKTtcblxuICAgIF9yZW5kaXRpb25zQXBpOiBSZW5kaXRpb25zQXBpO1xuICAgIGdldCByZW5kaXRpb25zQXBpKCk6IFJlbmRpdGlvbnNBcGkge1xuICAgICAgICB0aGlzLl9yZW5kaXRpb25zQXBpID0gdGhpcy5fcmVuZGl0aW9uc0FwaSA/PyBuZXcgUmVuZGl0aW9uc0FwaSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl9yZW5kaXRpb25zQXBpO1xuICAgIH1cblxuICAgIF9jb250ZW50QXBpOiBDb250ZW50QXBpO1xuICAgIGdldCBjb250ZW50QXBpKCk6IENvbnRlbnRBcGkge1xuICAgICAgICB0aGlzLl9jb250ZW50QXBpID0gdGhpcy5fY29udGVudEFwaSA/PyBuZXcgQ29udGVudEFwaSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl9jb250ZW50QXBpO1xuICAgIH1cblxuICAgIF92ZXJzaW9uc0FwaTogVmVyc2lvbnNBcGk7XG4gICAgZ2V0IHZlcnNpb25zQXBpKCk6IFZlcnNpb25zQXBpIHtcbiAgICAgICAgdGhpcy5fdmVyc2lvbnNBcGkgPSB0aGlzLl92ZXJzaW9uc0FwaSA/PyBuZXcgVmVyc2lvbnNBcGkodGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy5fdmVyc2lvbnNBcGk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRpb25TZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhpcyBtZXRob2QgdGFrZXMgYSB1cmwgdG8gdHJpZ2dlciB0aGUgcHJpbnQgZGlhbG9nIGFnYWluc3QsIGFuZCB0aGUgdHlwZSBvZiBhcnRpZmFjdCB0aGF0IGl0XG4gICAgICogaXMuXG4gICAgICogVGhpcyBVUkwgc2hvdWxkIGJlIG9uZSB0aGF0IGNhbiBiZSByZW5kZXJlZCBpbiB0aGUgYnJvd3NlciwgZm9yIGV4YW1wbGUgUERGLCBJbWFnZSwgb3IgVGV4dFxuICAgICAqL1xuICAgIHByaW50RmlsZSh1cmw6IHN0cmluZywgdHlwZTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHB3YSA9IHdpbmRvdy5vcGVuKHVybCwgVmlld1V0aWxTZXJ2aWNlLlRBUkdFVCk7XG4gICAgICAgIGlmIChwd2EpIHtcbiAgICAgICAgICAgIC8vIEJlY2F1c2Ugb2YgdGhlIHdheSBjaHJvbWUgZm9jdXMgYW5kIGNsb3NlIGltYWdlIHdpbmRvdyB2cy4gcGRmIHByZXZpZXcgd2luZG93XG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gVmlld1V0aWxTZXJ2aWNlLkNvbnRlbnRHcm91cC5JTUFHRSkge1xuICAgICAgICAgICAgICAgIHB3YS5vbmZvY3VzID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHB3YS5jbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICB9LCA1MDApO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHB3YS5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgcHdhLnByaW50KCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTGF1bmNoIHRoZSBGaWxlIFByaW50IGRpYWxvZyBmcm9tIGFueXdoZXJlIG90aGVyIHRoYW4gdGhlIHByZXZpZXcgc2VydmljZSwgd2hpY2ggcmVzb2x2ZXMgdGhlXG4gICAgICogcmVuZGl0aW9uIG9mIHRoZSBvYmplY3QgdGhhdCBjYW4gYmUgcHJpbnRlZCBmcm9tIGEgd2ViIGJyb3dzZXIuXG4gICAgICogVGhlc2UgYXJlOiBpbWFnZXMsIFBERiBmaWxlcywgb3IgUERGIHJlbmRpdGlvbiBvZiBmaWxlcy5cbiAgICAgKiBXZSBhbHNvIGZvcmNlIFBERiByZW5kaXRpb24gZm9yIFRFWFQgdHlwZSBvYmplY3RzLCBvdGhlcndpc2UgdGhlIGRlZmF1bHQgVVJMIGlzIHRvIGRvd25sb2FkLlxuICAgICAqIFRPRE8gdGhlcmUgYXJlIGRpZmZlcmVudCBURVhUIHR5cGUgb2JqZWN0cywgKEhUTUwsIHBsYWludGV4dCwgeG1sLCBldGMuIHdlIHNob3VsZCBkZXRlcm1pbmUgaG93IHRoZXNlIGFyZSBoYW5kbGVkKVxuICAgICAqL1xuICAgIHByaW50RmlsZUdlbmVyaWMob2JqZWN0SWQ6IHN0cmluZywgbWltZVR5cGU6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBjb25zdCBub2RlSWQgPSBvYmplY3RJZDtcbiAgICAgICAgY29uc3QgdHlwZTogc3RyaW5nID0gdGhpcy5nZXRWaWV3ZXJUeXBlQnlNaW1lVHlwZShtaW1lVHlwZSk7XG5cbiAgICAgICAgdGhpcy5nZXRSZW5kaXRpb24obm9kZUlkLCBWaWV3VXRpbFNlcnZpY2UuQ29udGVudEdyb3VwLlBERilcbiAgICAgICAgICAgIC50aGVuKCh2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHVybDogc3RyaW5nID0gdGhpcy5nZXRSZW5kaXRpb25Vcmwobm9kZUlkLCB0eXBlLCAoISF2YWx1ZSkpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHByaW50VHlwZSA9ICh0eXBlID09PSBWaWV3VXRpbFNlcnZpY2UuQ29udGVudEdyb3VwLlBERlxuICAgICAgICAgICAgICAgICAgICB8fCB0eXBlID09PSBWaWV3VXRpbFNlcnZpY2UuQ29udGVudEdyb3VwLlRFWFQpXG4gICAgICAgICAgICAgICAgICAgID8gVmlld1V0aWxTZXJ2aWNlLkNvbnRlbnRHcm91cC5QREYgOiB0eXBlO1xuICAgICAgICAgICAgICAgIHRoaXMucHJpbnRGaWxlKHVybCwgcHJpbnRUeXBlKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcignRXJyb3Igd2l0aCBQcmludGluZycpO1xuICAgICAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0UmVuZGl0aW9uVXJsKG5vZGVJZDogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIHJlbmRpdGlvbkV4aXN0czogYm9vbGVhbik6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiAocmVuZGl0aW9uRXhpc3RzICYmIHR5cGUgIT09IFZpZXdVdGlsU2VydmljZS5Db250ZW50R3JvdXAuSU1BR0UpID9cbiAgICAgICAgICAgIHRoaXMuY29udGVudEFwaS5nZXRSZW5kaXRpb25Vcmwobm9kZUlkLCBWaWV3VXRpbFNlcnZpY2UuQ29udGVudEdyb3VwLlBERikgOlxuICAgICAgICAgICAgdGhpcy5jb250ZW50QXBpLmdldENvbnRlbnRVcmwobm9kZUlkLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyB3YWl0UmVuZGl0aW9uKG5vZGVJZDogc3RyaW5nLCByZW5kaXRpb25JZDogc3RyaW5nLCByZXRyaWVzOiBudW1iZXIpOiBQcm9taXNlPFJlbmRpdGlvbkVudHJ5PiB7XG4gICAgICAgIGNvbnN0IHJlbmRpdGlvbiA9IGF3YWl0IHRoaXMucmVuZGl0aW9uc0FwaS5nZXRSZW5kaXRpb24obm9kZUlkLCByZW5kaXRpb25JZCk7XG5cbiAgICAgICAgaWYgKHRoaXMubWF4UmV0cmllcyA8IHJldHJpZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IHJlbmRpdGlvbi5lbnRyeS5zdGF0dXMudG9TdHJpbmcoKTtcblxuICAgICAgICAgICAgaWYgKHN0YXR1cyA9PT0gJ0NSRUFURUQnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlbmRpdGlvbjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0cmllcyArPSAxO1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMud2FpdCgxMDAwKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy53YWl0UmVuZGl0aW9uKG5vZGVJZCwgcmVuZGl0aW9uSWQsIHJldHJpZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcbiAgICB9XG5cbiAgICBnZXRWaWV3ZXJUeXBlQnlNaW1lVHlwZShtaW1lVHlwZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKG1pbWVUeXBlKSB7XG4gICAgICAgICAgICBtaW1lVHlwZSA9IG1pbWVUeXBlLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGVkaXRvclR5cGVzID0gT2JqZWN0LmtleXModGhpcy5taW1lVHlwZXMpO1xuICAgICAgICAgICAgZm9yIChjb25zdCB0eXBlIG9mIGVkaXRvclR5cGVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubWltZVR5cGVzW3R5cGVdLmluZGV4T2YobWltZVR5cGUpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiAndW5rbm93bic7XG4gICAgfVxuXG4gICAgd2FpdChtczogbnVtYmVyKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0UmVuZGl0aW9uKG5vZGVJZDogc3RyaW5nLCByZW5kaXRpb25JZDogc3RyaW5nKTogUHJvbWlzZTxSZW5kaXRpb25FbnRyeT4ge1xuICAgICAgICBjb25zdCByZW5kaXRpb25QYWdpbmc6IFJlbmRpdGlvblBhZ2luZyA9IGF3YWl0IHRoaXMucmVuZGl0aW9uc0FwaS5saXN0UmVuZGl0aW9ucyhub2RlSWQpO1xuICAgICAgICBsZXQgcmVuZGl0aW9uOiBSZW5kaXRpb25FbnRyeSA9IHJlbmRpdGlvblBhZ2luZy5saXN0LmVudHJpZXMuZmluZCgocmVuZGl0aW9uRW50cnk6IFJlbmRpdGlvbkVudHJ5KSA9PiByZW5kaXRpb25FbnRyeS5lbnRyeS5pZC50b0xvd2VyQ2FzZSgpID09PSByZW5kaXRpb25JZCk7XG5cbiAgICAgICAgaWYgKHJlbmRpdGlvbikge1xuICAgICAgICAgICAgY29uc3Qgc3RhdHVzID0gcmVuZGl0aW9uLmVudHJ5LnN0YXR1cy50b1N0cmluZygpO1xuXG4gICAgICAgICAgICBpZiAoc3RhdHVzID09PSAnTk9UX0NSRUFURUQnKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5yZW5kaXRpb25zQXBpLmNyZWF0ZVJlbmRpdGlvbihub2RlSWQsIHsgaWQ6IHJlbmRpdGlvbklkIH0pO1xuICAgICAgICAgICAgICAgICAgICByZW5kaXRpb24gPSBhd2FpdCB0aGlzLndhaXRSZW5kaXRpb24obm9kZUlkLCByZW5kaXRpb25JZCwgMCk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8UmVuZGl0aW9uRW50cnk+KChyZXNvbHZlKSA9PiByZXNvbHZlKHJlbmRpdGlvbikpO1xuICAgIH1cblxuICAgIGFzeW5jIGRpc3BsYXlOb2RlUmVuZGl0aW9uKG5vZGVJZDogc3RyaW5nLCB2ZXJzaW9uSWQ/OiBzdHJpbmcpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlbmRpdGlvbiA9IHZlcnNpb25JZCA/IGF3YWl0IHRoaXMucmVzb2x2ZU5vZGVSZW5kaXRpb24obm9kZUlkLCAncGRmJywgdmVyc2lvbklkKSA6XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5yZXNvbHZlTm9kZVJlbmRpdGlvbihub2RlSWQsICdwZGYnKTtcbiAgICAgICAgICAgIGlmIChyZW5kaXRpb24pIHtcbiAgICAgICAgICAgICAgICBjb25zdCByZW5kaXRpb25JZCA9IHJlbmRpdGlvbi5lbnRyeS5pZDtcblxuICAgICAgICAgICAgICAgIGlmIChyZW5kaXRpb25JZCA9PT0gJ3BkZicpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52aWV3ZXJUeXBlQ2hhbmdlLm5leHQoJ3BkZicpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVuZGl0aW9uSWQgPT09ICdpbWdwcmV2aWV3Jykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnZpZXdlclR5cGVDaGFuZ2UubmV4dCgnaW1hZ2UnKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCB1cmxGaWxlQ29udGVudCA9IHZlcnNpb25JZCA/IHRoaXMuY29udGVudEFwaS5nZXRWZXJzaW9uUmVuZGl0aW9uVXJsKG5vZGVJZCwgdmVyc2lvbklkLCByZW5kaXRpb25JZCkgOlxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRlbnRBcGkuZ2V0UmVuZGl0aW9uVXJsKG5vZGVJZCwgcmVuZGl0aW9uSWQpO1xuICAgICAgICAgICAgICAgIHRoaXMudXJsRmlsZUNvbnRlbnRDaGFuZ2UubmV4dCh1cmxGaWxlQ29udGVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGVycik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIHJlc29sdmVOb2RlUmVuZGl0aW9uKG5vZGVJZDogc3RyaW5nLCByZW5kaXRpb25JZDogc3RyaW5nLCB2ZXJzaW9uSWQ/OiBzdHJpbmcpOiBQcm9taXNlPFJlbmRpdGlvbkVudHJ5PiB7XG4gICAgICAgIHJlbmRpdGlvbklkID0gcmVuZGl0aW9uSWQudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICBjb25zdCBzdXBwb3J0ZWRSZW5kaXRpb246IFJlbmRpdGlvblBhZ2luZyA9IHZlcnNpb25JZCA/IGF3YWl0IHRoaXMudmVyc2lvbnNBcGkubGlzdFZlcnNpb25SZW5kaXRpb25zKG5vZGVJZCwgdmVyc2lvbklkKSA6XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnJlbmRpdGlvbnNBcGkubGlzdFJlbmRpdGlvbnMobm9kZUlkKTtcblxuICAgICAgICBsZXQgcmVuZGl0aW9uOiBSZW5kaXRpb25FbnRyeSA9IHN1cHBvcnRlZFJlbmRpdGlvbi5saXN0LmVudHJpZXMuZmluZCgocmVuZGl0aW9uRW50cnk6IFJlbmRpdGlvbkVudHJ5KSA9PiByZW5kaXRpb25FbnRyeS5lbnRyeS5pZC50b0xvd2VyQ2FzZSgpID09PSByZW5kaXRpb25JZCk7XG4gICAgICAgIGlmICghcmVuZGl0aW9uKSB7XG4gICAgICAgICAgICByZW5kaXRpb25JZCA9ICdpbWdwcmV2aWV3JztcbiAgICAgICAgICAgIHJlbmRpdGlvbiA9IHN1cHBvcnRlZFJlbmRpdGlvbi5saXN0LmVudHJpZXMuZmluZCgocmVuZGl0aW9uRW50cnk6IFJlbmRpdGlvbkVudHJ5KSA9PiByZW5kaXRpb25FbnRyeS5lbnRyeS5pZC50b0xvd2VyQ2FzZSgpID09PSByZW5kaXRpb25JZCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmVuZGl0aW9uKSB7XG4gICAgICAgICAgICBjb25zdCBzdGF0dXM6IHN0cmluZyA9IHJlbmRpdGlvbi5lbnRyeS5zdGF0dXMudG9TdHJpbmcoKTtcblxuICAgICAgICAgICAgaWYgKHN0YXR1cyA9PT0gJ05PVF9DUkVBVEVEJykge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2ZXJzaW9uSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMudmVyc2lvbnNBcGkuY3JlYXRlVmVyc2lvblJlbmRpdGlvbihub2RlSWQsIHZlcnNpb25JZCwgeyBpZDogcmVuZGl0aW9uSWQgfSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52aWV3ZXJUeXBlQ2hhbmdlLm5leHQoJ2luX2NyZWF0aW9uJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucmVuZGl0aW9uc0FwaS5jcmVhdGVSZW5kaXRpb24obm9kZUlkLCB7IGlkOiByZW5kaXRpb25JZCB9KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZpZXdlclR5cGVDaGFuZ2UubmV4dCgnaW5fY3JlYXRpb24nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZW5kaXRpb24gPSB2ZXJzaW9uSWQgPyBhd2FpdCB0aGlzLndhaXROb2RlUmVuZGl0aW9uKG5vZGVJZCwgcmVuZGl0aW9uSWQsIHZlcnNpb25JZCkgOiBhd2FpdCB0aGlzLndhaXROb2RlUmVuZGl0aW9uKG5vZGVJZCwgcmVuZGl0aW9uSWQpO1xuICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZpZXdlclR5cGVDaGFuZ2UubmV4dCgnZXJyb3JfaW5fY3JlYXRpb24nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRpdGlvbiA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVuZGl0aW9uO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgd2FpdE5vZGVSZW5kaXRpb24obm9kZUlkOiBzdHJpbmcsIHJlbmRpdGlvbklkOiBzdHJpbmcsIHZlcnNpb25JZD86IHN0cmluZyk6IFByb21pc2U8UmVuZGl0aW9uRW50cnk+IHtcbiAgICAgICAgbGV0IGN1cnJlbnRSZXRyeTogbnVtYmVyID0gMDtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPFJlbmRpdGlvbkVudHJ5PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRSZXRyeSsrO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLm1heFJldHJpZXMgPj0gY3VycmVudFJldHJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2ZXJzaW9uSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmVyc2lvbnNBcGkuZ2V0VmVyc2lvblJlbmRpdGlvbihub2RlSWQsIHZlcnNpb25JZCwgcmVuZGl0aW9uSWQpLnRoZW4oKHJlbmRpdGlvbjogUmVuZGl0aW9uRW50cnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0dXM6IHN0cmluZyA9IHJlbmRpdGlvbi5lbnRyeS5zdGF0dXMudG9TdHJpbmcoKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0dXMgPT09ICdDUkVBVEVEJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZU5vZGVSZW5kaXRpb24obm9kZUlkLCByZW5kaXRpb25JZCwgdmVyc2lvbklkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbElkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUocmVuZGl0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9LCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRpdGlvbnNBcGkuZ2V0UmVuZGl0aW9uKG5vZGVJZCwgcmVuZGl0aW9uSWQpLnRoZW4oKHJlbmRpdGlvbjogUmVuZGl0aW9uRW50cnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0dXM6IHN0cmluZyA9IHJlbmRpdGlvbi5lbnRyeS5zdGF0dXMudG9TdHJpbmcoKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0dXMgPT09ICdDUkVBVEVEJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZU5vZGVSZW5kaXRpb24obm9kZUlkLCByZW5kaXRpb25JZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWxJZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKHJlbmRpdGlvbik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbElkKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIHRoaXMuVFJZX1RJTUVPVVQpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGhhbmRsZU5vZGVSZW5kaXRpb24obm9kZUlkOiBzdHJpbmcsIHJlbmRpdGlvbklkOiBzdHJpbmcsIHZlcnNpb25JZD86IHN0cmluZykge1xuICAgICAgICBpZiAocmVuZGl0aW9uSWQgPT09ICdwZGYnKSB7XG4gICAgICAgICAgICB0aGlzLnZpZXdlclR5cGVDaGFuZ2UubmV4dCgncGRmJyk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVuZGl0aW9uSWQgPT09ICdpbWdwcmV2aWV3Jykge1xuICAgICAgICAgICAgdGhpcy52aWV3ZXJUeXBlQ2hhbmdlLm5leHQoJ2ltYWdlJyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB1cmxGaWxlQ29udGVudCA9IHZlcnNpb25JZCA/IHRoaXMuY29udGVudEFwaS5nZXRWZXJzaW9uUmVuZGl0aW9uVXJsKG5vZGVJZCwgdmVyc2lvbklkLCByZW5kaXRpb25JZCkgOlxuICAgICAgICAgICAgdGhpcy5jb250ZW50QXBpLmdldFJlbmRpdGlvblVybChub2RlSWQsIHJlbmRpdGlvbklkKTtcbiAgICAgICAgdGhpcy51cmxGaWxlQ29udGVudENoYW5nZS5uZXh0KHVybEZpbGVDb250ZW50KTtcbiAgICB9XG5cbiAgICBhc3luYyBnZW5lcmF0ZU1lZGlhVHJhY2tzKG5vZGVJZDogc3RyaW5nKTogUHJvbWlzZTxUcmFja1tdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmlzUmVuZGl0aW9uQXZhaWxhYmxlKG5vZGVJZCwgVmlld1V0aWxTZXJ2aWNlLlNVQlRJVExFU19SRU5ESVRJT05fTkFNRSlcbiAgICAgICAgICAgIC50aGVuKCh2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRyYWNrcyA9IFtdO1xuICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICB0cmFja3MucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBraW5kOiAnc3VidGl0bGVzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNyYzogdGhpcy5jb250ZW50QXBpLmdldFJlbmRpdGlvblVybChub2RlSWQsIFZpZXdVdGlsU2VydmljZS5TVUJUSVRMRVNfUkVORElUSU9OX05BTUUpLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KCdBREZfVklFV0VSLlNVQlRJVExFUycpXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdHJhY2tzO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKCdFcnJvciB3aGlsZSByZXRyaWV2aW5nICcgKyBWaWV3VXRpbFNlcnZpY2UuU1VCVElUTEVTX1JFTkRJVElPTl9OQU1FICsgJyByZW5kaXRpb24nKTtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGlzUmVuZGl0aW9uQXZhaWxhYmxlKG5vZGVJZDogc3RyaW5nLCByZW5kaXRpb25JZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGNvbnN0IHJlbmRpdGlvblBhZ2luZzogUmVuZGl0aW9uUGFnaW5nID0gYXdhaXQgdGhpcy5yZW5kaXRpb25zQXBpLmxpc3RSZW5kaXRpb25zKG5vZGVJZCk7XG4gICAgICAgIGNvbnN0IHJlbmRpdGlvbjogUmVuZGl0aW9uRW50cnkgPSByZW5kaXRpb25QYWdpbmcubGlzdC5lbnRyaWVzLmZpbmQoKHJlbmRpdGlvbkVudHJ5OiBSZW5kaXRpb25FbnRyeSkgPT4gcmVuZGl0aW9uRW50cnkuZW50cnkuaWQudG9Mb3dlckNhc2UoKSA9PT0gcmVuZGl0aW9uSWQpO1xuXG4gICAgICAgIHJldHVybiByZW5kaXRpb24/LmVudHJ5Py5zdGF0dXM/LnRvU3RyaW5nKCkgPT09ICdDUkVBVEVEJyB8fCBmYWxzZTtcbiAgICB9XG59XG4iXX0=